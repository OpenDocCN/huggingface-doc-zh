# è‡ªå®šä¹‰æ‰©æ•£

> åŸå§‹æ–‡æœ¬ï¼š[`huggingface.co/docs/diffusers/training/custom_diffusion`](https://huggingface.co/docs/diffusers/training/custom_diffusion)

[Custom Diffusion](https://huggingface.co/papers/2212.04488)æ˜¯ä¸€ç§ç”¨äºä¸ªæ€§åŒ–å›¾åƒç”Ÿæˆæ¨¡å‹çš„è®­ç»ƒæŠ€æœ¯ã€‚ä¸æ–‡æœ¬åè½¬ã€DreamBooth å’Œ LoRA ä¸€æ ·ï¼Œè‡ªå®šä¹‰æ‰©æ•£åªéœ€è¦å‡ ä¸ªï¼ˆ~4-5ï¼‰ç¤ºä¾‹å›¾åƒã€‚è¿™ç§æŠ€æœ¯é€šè¿‡ä»…è®­ç»ƒäº¤å‰æ³¨æ„åŠ›å±‚ä¸­çš„æƒé‡æ¥å·¥ä½œï¼Œå¹¶ä½¿ç”¨ç‰¹æ®Šè¯æ¥è¡¨ç¤ºæ–°å­¦ä¹ çš„æ¦‚å¿µã€‚è‡ªå®šä¹‰æ‰©æ•£æ˜¯ç‹¬ç‰¹çš„ï¼Œå› ä¸ºå®ƒè¿˜å¯ä»¥åŒæ—¶å­¦ä¹ å¤šä¸ªæ¦‚å¿µã€‚

å¦‚æœæ‚¨åœ¨å…·æœ‰æœ‰é™ vRAM çš„ GPU ä¸Šè¿›è¡Œè®­ç»ƒï¼Œæ‚¨åº”è¯¥å°è¯•ä½¿ç”¨`--enable_xformers_memory_efficient_attention`å¯ç”¨ xFormersï¼Œä»¥å®ç°æ›´å¿«çš„è®­ç»ƒå’Œæ›´ä½çš„ vRAM è¦æ±‚ï¼ˆ16GBï¼‰ã€‚ä¸ºäº†èŠ‚çœæ›´å¤šå†…å­˜ï¼Œå¯ä»¥åœ¨è®­ç»ƒå‚æ•°ä¸­æ·»åŠ `--set_grads_to_none`ï¼Œå°†æ¢¯åº¦è®¾ç½®ä¸º`None`è€Œä¸æ˜¯é›¶ï¼ˆæ­¤é€‰é¡¹å¯èƒ½ä¼šå¯¼è‡´ä¸€äº›é—®é¢˜ï¼Œå¦‚æœæ‚¨é‡åˆ°ä»»ä½•é—®é¢˜ï¼Œè¯·å°è¯•åˆ é™¤æ­¤å‚æ•°ï¼‰ã€‚

æœ¬æŒ‡å—å°†æ¢è®¨[train_custom_diffusion.py](https://github.com/huggingface/diffusers/blob/main/examples/custom_diffusion/train_custom_diffusion.py)è„šæœ¬ï¼Œå¸®åŠ©æ‚¨æ›´ç†Ÿæ‚‰å®ƒï¼Œä»¥åŠå¦‚ä½•ä¸ºè‡ªå·±çš„ç”¨ä¾‹è¿›è¡Œè°ƒæ•´ã€‚

åœ¨è¿è¡Œè„šæœ¬ä¹‹å‰ï¼Œè¯·ç¡®ä¿æ‚¨ä»æºä»£ç å®‰è£…åº“ï¼š

```py
git clone https://github.com/huggingface/diffusers
cd diffusers
pip install .
```

å¯¼èˆªåˆ°åŒ…å«è®­ç»ƒè„šæœ¬çš„ç¤ºä¾‹æ–‡ä»¶å¤¹å¹¶å®‰è£…æ‰€éœ€çš„ä¾èµ–é¡¹ï¼š

```py
cd examples/custom_diffusion
pip install -r requirements.txt
pip install clip-retrieval
```

ğŸ¤— Accelerate æ˜¯ä¸€ä¸ªå¸®åŠ©æ‚¨åœ¨å¤šä¸ª GPU/TPU ä¸Šè®­ç»ƒæˆ–ä½¿ç”¨æ··åˆç²¾åº¦çš„åº“ã€‚å®ƒå°†æ ¹æ®æ‚¨çš„ç¡¬ä»¶å’Œç¯å¢ƒè‡ªåŠ¨é…ç½®æ‚¨çš„è®­ç»ƒè®¾ç½®ã€‚æŸ¥çœ‹ğŸ¤— Accelerate [å¿«é€Ÿå…¥é—¨](https://huggingface.co/docs/accelerate/quicktour)ä»¥äº†è§£æ›´å¤šã€‚

åˆå§‹åŒ–ğŸ¤— Accelerate ç¯å¢ƒï¼š

```py
accelerate config
```

è¦è®¾ç½®é»˜è®¤çš„ğŸ¤— Accelerate ç¯å¢ƒè€Œä¸é€‰æ‹©ä»»ä½•é…ç½®ï¼š

```py
accelerate config default
```

æˆ–è€…å¦‚æœæ‚¨çš„ç¯å¢ƒä¸æ”¯æŒäº¤äº’å¼ shellï¼Œæ¯”å¦‚ç¬”è®°æœ¬ï¼Œæ‚¨å¯ä»¥ä½¿ç”¨ï¼š

```py
from accelerate.utils import write_basic_config

write_basic_config()
```

æœ€åï¼Œå¦‚æœæ‚¨æƒ³åœ¨è‡ªå·±çš„æ•°æ®é›†ä¸Šè®­ç»ƒæ¨¡å‹ï¼Œè¯·æŸ¥çœ‹åˆ›å»ºç”¨äºè®­ç»ƒçš„æ•°æ®é›†æŒ‡å—ï¼Œäº†è§£å¦‚ä½•åˆ›å»ºé€‚ç”¨äºè®­ç»ƒè„šæœ¬çš„æ•°æ®é›†ã€‚

ä»¥ä¸‹éƒ¨åˆ†çªå‡ºæ˜¾ç¤ºäº†è®­ç»ƒè„šæœ¬çš„é‡è¦éƒ¨åˆ†ï¼Œæœ‰åŠ©äºäº†è§£å¦‚ä½•ä¿®æ”¹å®ƒï¼Œä½†å¹¶æœªè¯¦ç»†æ¶µç›–è„šæœ¬çš„æ¯ä¸ªæ–¹é¢ã€‚å¦‚æœæ‚¨æœ‰å…´è¶£äº†è§£æ›´å¤šï¼Œè¯·éšæ—¶é˜…è¯»[è„šæœ¬](https://github.com/huggingface/diffusers/blob/main/examples/custom_diffusion/train_custom_diffusion.py)ï¼Œå¹¶å‘Šè¯‰æˆ‘ä»¬æ‚¨æ˜¯å¦æœ‰ä»»ä½•é—®é¢˜æˆ–ç–‘è™‘ã€‚

## è„šæœ¬å‚æ•°

è®­ç»ƒè„šæœ¬åŒ…å«æ‰€æœ‰å‚æ•°ï¼Œå¸®åŠ©æ‚¨å®šåˆ¶è®­ç»ƒè¿è¡Œã€‚è¿™äº›å‚æ•°åœ¨[`parse_args()`](https://github.com/huggingface/diffusers/blob/64603389da01082055a901f2883c4810d1144edb/examples/custom_diffusion/train_custom_diffusion.py#L319)å‡½æ•°ä¸­æ‰¾åˆ°ã€‚è¯¥å‡½æ•°å¸¦æœ‰é»˜è®¤å€¼ï¼Œä½†å¦‚æœæ‚¨æ„¿æ„ï¼Œä¹Ÿå¯ä»¥åœ¨è®­ç»ƒå‘½ä»¤ä¸­è®¾ç½®è‡ªå·±çš„å€¼ã€‚

ä¾‹å¦‚ï¼Œè¦æ›´æ”¹è¾“å…¥å›¾åƒçš„åˆ†è¾¨ç‡ï¼š

```py
accelerate launch train_custom_diffusion.py \
  --resolution=256
```

è®¸å¤šåŸºæœ¬å‚æ•°åœ¨ DreamBooth è®­ç»ƒæŒ‡å—ä¸­æœ‰æè¿°ï¼Œå› æ­¤æœ¬æŒ‡å—é‡ç‚¹ä»‹ç»äº†è‡ªå®šä¹‰æ‰©æ•£çš„ç‹¬ç‰¹å‚æ•°ï¼š

+   `--freeze_model`ï¼šå†»ç»“äº¤å‰æ³¨æ„åŠ›å±‚ä¸­çš„é”®å’Œå€¼å‚æ•°ï¼›é»˜è®¤å€¼ä¸º`crossattn_kv`ï¼Œä½†æ‚¨ä¹Ÿå¯ä»¥å°†å…¶è®¾ç½®ä¸º`crossattn`ä»¥è®­ç»ƒäº¤å‰æ³¨æ„åŠ›å±‚ä¸­çš„æ‰€æœ‰å‚æ•°

+   `--concepts_list`ï¼šè¦å­¦ä¹ å¤šä¸ªæ¦‚å¿µï¼Œè¯·æä¾›åŒ…å«æ¦‚å¿µçš„ JSON æ–‡ä»¶çš„è·¯å¾„

+   `--modifier_token`ï¼šç”¨äºè¡¨ç¤ºå­¦ä¹ æ¦‚å¿µçš„ç‰¹æ®Šè¯

+   `--initializer_token`ï¼š

### å…ˆå‰çš„ä¿ç•™æŸå¤±

å…ˆå‰ä¿å­˜æŸå¤±æ˜¯ä¸€ç§æ–¹æ³•ï¼Œå®ƒåˆ©ç”¨æ¨¡å‹ç”Ÿæˆçš„æ ·æœ¬æ¥å¸®åŠ©æ¨¡å‹å­¦ä¹ å¦‚ä½•ç”Ÿæˆæ›´å¤šæ ·åŒ–çš„å›¾åƒã€‚ç”±äºè¿™äº›ç”Ÿæˆçš„æ ·æœ¬å›¾åƒå±äºæ‚¨æä¾›çš„å›¾åƒç›¸åŒçš„ç±»åˆ«ï¼Œå®ƒä»¬æœ‰åŠ©äºæ¨¡å‹ä¿ç•™å…¶å¯¹ç±»åˆ«çš„å­¦ä¹ ä»¥åŠå¦‚ä½•åˆ©ç”¨å…¶å·²çŸ¥çš„ç±»åˆ«çŸ¥è¯†æ¥ç”Ÿæˆæ–°æ„å›¾çš„å†…å®¹ã€‚

è®¸å¤šæœ‰å…³å…ˆå‰ä¿å­˜æŸå¤±çš„å‚æ•°åœ¨ DreamBooth åŸ¹è®­æŒ‡å—ä¸­æœ‰æè¿°ã€‚

### æ­£åˆ™åŒ–

è‡ªå®šä¹‰æ‰©æ•£åŒ…æ‹¬ä½¿ç”¨å°‘é‡çœŸå®å›¾åƒè®­ç»ƒç›®æ ‡å›¾åƒï¼Œä»¥é˜²æ­¢è¿‡æ‹Ÿåˆã€‚å¯ä»¥æƒ³è±¡ï¼Œå½“æ‚¨åªå¯¹å°‘é‡å›¾åƒè¿›è¡Œè®­ç»ƒæ—¶ï¼Œè¿™å¯èƒ½å¾ˆå®¹æ˜“åšåˆ°ï¼ä½¿ç”¨`clip_retrieval`ä¸‹è½½ 200 å¼ çœŸå®å›¾åƒã€‚`class_prompt`åº”è¯¥æ˜¯ä¸ç›®æ ‡å›¾åƒç›¸åŒç±»åˆ«ã€‚è¿™äº›å›¾åƒå­˜å‚¨åœ¨`class_data_dir`ä¸­ã€‚

```py
python retrieve.py --class_prompt cat --class_data_dir real_reg/samples_cat --num_class_images 200
```

è¦å¯ç”¨æ­£åˆ™åŒ–ï¼Œè¯·æ·»åŠ ä»¥ä¸‹å‚æ•°ï¼š

+   `--with_prior_preservation`ï¼šæ˜¯å¦ä½¿ç”¨å…ˆå‰ä¿å­˜æŸå¤±

+   `--prior_loss_weight`ï¼šæ§åˆ¶å…ˆå‰ä¿å­˜æŸå¤±å¯¹æ¨¡å‹çš„å½±å“

+   `--real_prior`ï¼šæ˜¯å¦ä½¿ç”¨å°‘é‡çœŸå®å›¾åƒä»¥é˜²æ­¢è¿‡æ‹Ÿåˆ

```py
accelerate launch train_custom_diffusion.py \
  --with_prior_preservation \
  --prior_loss_weight=1.0 \
  --class_data_dir="./real_reg/samples_cat" \
  --class_prompt="cat" \
  --real_prior=True \
```

## è®­ç»ƒè„šæœ¬

è‡ªå®šä¹‰æ‰©æ•£è®­ç»ƒè„šæœ¬ä¸­çš„è®¸å¤šä»£ç ä¸ DreamBooth è„šæœ¬ç›¸ä¼¼ã€‚æœ¬æŒ‡å—é‡ç‚¹ä»‹ç»ä¸è‡ªå®šä¹‰æ‰©æ•£ç›¸å…³çš„ä»£ç ã€‚

è‡ªå®šä¹‰æ‰©æ•£è®­ç»ƒè„šæœ¬æœ‰ä¸¤ä¸ªæ•°æ®é›†ç±»ï¼š

+   [`CustomDiffusionDataset`](https://github.com/huggingface/diffusers/blob/64603389da01082055a901f2883c4810d1144edb/examples/custom_diffusion/train_custom_diffusion.py#L165)ï¼šå¯¹å›¾åƒã€ç±»å›¾åƒå’Œæç¤ºè¿›è¡Œé¢„å¤„ç†ä»¥è¿›è¡Œè®­ç»ƒ

+   [`PromptDataset`](https://github.com/huggingface/diffusers/blob/64603389da01082055a901f2883c4810d1144edb/examples/custom_diffusion/train_custom_diffusion.py#L148)ï¼šå‡†å¤‡ç”¨äºç”Ÿæˆç±»å›¾åƒçš„æç¤º

æ¥ä¸‹æ¥ï¼Œ`modifier_token`è¢«æ·»åŠ åˆ°åˆ†è¯å™¨ä¸­ï¼Œè½¬æ¢ä¸ºæ ‡è®° idï¼Œå¹¶ä¸”æ ‡è®°åµŒå…¥è¢«è°ƒæ•´å¤§å°ä»¥é€‚åº”æ–°çš„`modifier_token`ã€‚ç„¶åï¼Œ`modifier_token`çš„åµŒå…¥è¢«åˆå§‹åŒ–ä¸º`initializer_token`çš„åµŒå…¥ã€‚æ–‡æœ¬ç¼–ç å™¨ä¸­çš„æ‰€æœ‰å‚æ•°éƒ½è¢«å†»ç»“ï¼Œé™¤äº†æ ‡è®°åµŒå…¥ï¼Œå› ä¸ºè¿™æ˜¯æ¨¡å‹è¯•å›¾å­¦ä¹ ä¸æ¦‚å¿µç›¸å…³è”çš„å†…å®¹ã€‚

```py
params_to_freeze = itertools.chain(
    text_encoder.text_model.encoder.parameters(),
    text_encoder.text_model.final_layer_norm.parameters(),
    text_encoder.text_model.embeddings.position_embedding.parameters(),
)
freeze_params(params_to_freeze)
```

ç°åœ¨ï¼Œæ‚¨éœ€è¦å°†[è‡ªå®šä¹‰æ‰©æ•£æƒé‡](https://github.com/huggingface/diffusers/blob/64603389da01082055a901f2883c4810d1144edb/examples/custom_diffusion/train_custom_diffusion.py#L911C3-L911C3)æ·»åŠ åˆ°æ³¨æ„åŠ›å±‚ä¸­ã€‚è¿™æ˜¯ç¡®ä¿æ³¨æ„åŠ›æƒé‡çš„å½¢çŠ¶å’Œå¤§å°æ­£ç¡®çš„ä¸€ä¸ªéå¸¸é‡è¦çš„æ­¥éª¤ï¼Œä¹Ÿæ˜¯ä¸ºæ¯ä¸ª UNet å—è®¾ç½®é€‚å½“æ•°é‡çš„æ³¨æ„åŠ›å¤„ç†å™¨çš„å…³é”®ã€‚

```py
st = unet.state_dict()
for name, _ in unet.attn_processors.items():
    cross_attention_dim = None if name.endswith("attn1.processor") else unet.config.cross_attention_dim
    if name.startswith("mid_block"):
        hidden_size = unet.config.block_out_channels[-1]
    elif name.startswith("up_blocks"):
        block_id = int(name[len("up_blocks.")])
        hidden_size = list(reversed(unet.config.block_out_channels))[block_id]
    elif name.startswith("down_blocks"):
        block_id = int(name[len("down_blocks.")])
        hidden_size = unet.config.block_out_channels[block_id]
    layer_name = name.split(".processor")[0]
    weights = {
        "to_k_custom_diffusion.weight": st[layer_name + ".to_k.weight"],
        "to_v_custom_diffusion.weight": st[layer_name + ".to_v.weight"],
    }
    if train_q_out:
        weights["to_q_custom_diffusion.weight"] = st[layer_name + ".to_q.weight"]
        weights["to_out_custom_diffusion.0.weight"] = st[layer_name + ".to_out.0.weight"]
        weights["to_out_custom_diffusion.0.bias"] = st[layer_name + ".to_out.0.bias"]
    if cross_attention_dim is not None:
        custom_diffusion_attn_procs[name] = attention_class(
            train_kv=train_kv,
            train_q_out=train_q_out,
            hidden_size=hidden_size,
            cross_attention_dim=cross_attention_dim,
        ).to(unet.device)
        custom_diffusion_attn_procs[name].load_state_dict(weights)
    else:
        custom_diffusion_attn_procs[name] = attention_class(
            train_kv=False,
            train_q_out=False,
            hidden_size=hidden_size,
            cross_attention_dim=cross_attention_dim,
        )
del st
unet.set_attn_processor(custom_diffusion_attn_procs)
custom_diffusion_layers = AttnProcsLayers(unet.attn_processors)
```

ä¼˜åŒ–å™¨è¢«åˆå§‹åŒ–ä»¥æ›´æ–°äº¤å‰æ³¨æ„åŠ›å±‚å‚æ•°ï¼š

```py
optimizer = optimizer_class(
    itertools.chain(text_encoder.get_input_embeddings().parameters(), custom_diffusion_layers.parameters())
    if args.modifier_token is not None
    else custom_diffusion_layers.parameters(),
    lr=args.learning_rate,
    betas=(args.adam_beta1, args.adam_beta2),
    weight_decay=args.adam_weight_decay,
    eps=args.adam_epsilon,
)
```

åœ¨[è®­ç»ƒå¾ªç¯](https://github.com/huggingface/diffusers/blob/84cd9e8d01adb47f046b1ee449fc76a0c32dc4e2/examples/custom_diffusion/train_custom_diffusion.py#L1048)ä¸­ï¼Œåªæ›´æ–°æ‚¨è¦å­¦ä¹ çš„æ¦‚å¿µçš„åµŒå…¥æ˜¯å¾ˆé‡è¦çš„ã€‚è¿™æ„å‘³ç€å°†æ‰€æœ‰å…¶ä»–æ ‡è®°åµŒå…¥çš„æ¢¯åº¦è®¾ç½®ä¸ºé›¶ï¼š

```py
if args.modifier_token is not None:
    if accelerator.num_processes > 1:
        grads_text_encoder = text_encoder.module.get_input_embeddings().weight.grad
    else:
        grads_text_encoder = text_encoder.get_input_embeddings().weight.grad
    index_grads_to_zero = torch.arange(len(tokenizer)) != modifier_token_id[0]
    for i in range(len(modifier_token_id[1:])):
        index_grads_to_zero = index_grads_to_zero & (
            torch.arange(len(tokenizer)) != modifier_token_id[i]
        )
    grads_text_encoder.data[index_grads_to_zero, :] = grads_text_encoder.data[
        index_grads_to_zero, :
    ].fill_(0)
```

## å¯åŠ¨è„šæœ¬

ä¸€æ—¦æ‚¨å®Œæˆäº†æ‰€æœ‰æ›´æ”¹æˆ–å¯¹é»˜è®¤é…ç½®æ„Ÿåˆ°æ»¡æ„ï¼Œæ‚¨å°±å¯ä»¥å¯åŠ¨è®­ç»ƒè„šæœ¬äº†ï¼ğŸš€

åœ¨æœ¬æŒ‡å—ä¸­ï¼Œæ‚¨å°†ä¸‹è½½å¹¶ä½¿ç”¨è¿™äº›ç¤ºä¾‹[çŒ«å›¾åƒ](https://www.cs.cmu.edu/~custom-diffusion/assets/data.zip)ã€‚å¦‚æœæ‚¨æ„¿æ„ï¼Œä¹Ÿå¯ä»¥åˆ›å»ºå¹¶ä½¿ç”¨è‡ªå·±çš„æ•°æ®é›†ï¼ˆè¯·å‚é˜…åˆ›å»ºç”¨äºè®­ç»ƒçš„æ•°æ®é›†æŒ‡å—ï¼‰ã€‚

å°†ç¯å¢ƒå˜é‡`MODEL_NAME`è®¾ç½®ä¸º Hub ä¸Šçš„æ¨¡å‹ ID æˆ–æœ¬åœ°æ¨¡å‹çš„è·¯å¾„ï¼Œå°†`INSTANCE_DIR`è®¾ç½®ä¸ºæ‚¨åˆšä¸‹è½½çŒ«å›¾ç‰‡çš„è·¯å¾„ï¼Œå°†`OUTPUT_DIR`è®¾ç½®ä¸ºæ‚¨æƒ³è¦ä¿å­˜æ¨¡å‹çš„è·¯å¾„ã€‚æ‚¨å°†ä½¿ç”¨`<new1>`ä½œä¸ºå°†æ–°å­¦ä¹ çš„åµŒå…¥ä¸ä¹‹å…³è”çš„ç‰¹æ®Šè¯ã€‚è¯¥è„šæœ¬å°†åˆ›å»ºå¹¶ä¿å­˜æ¨¡å‹æ£€æŸ¥ç‚¹å’Œä¸€ä¸ª pytorch_custom_diffusion_weights.bin æ–‡ä»¶åˆ°æ‚¨çš„å­˜å‚¨åº“ä¸­ã€‚

è¦ä½¿ç”¨ Weights and Biases ç›‘è§†è®­ç»ƒè¿›åº¦ï¼Œè¯·åœ¨è®­ç»ƒå‘½ä»¤ä¸­æ·»åŠ `--report_to=wandb`å‚æ•°ï¼Œå¹¶ä½¿ç”¨`--validation_prompt`æŒ‡å®šéªŒè¯æç¤ºã€‚è¿™å¯¹äºè°ƒè¯•å’Œä¿å­˜ä¸­é—´ç»“æœå¾ˆæœ‰ç”¨ã€‚

å¦‚æœæ‚¨æ­£åœ¨è®­ç»ƒäººè„¸ï¼ŒCustom Diffusion å›¢é˜Ÿå‘ç°ä»¥ä¸‹å‚æ•°æ•ˆæœå¾ˆå¥½ï¼š

+   `--learning_rate=5e-6`

+   `--max_train_steps`å¯ä»¥åœ¨ 1000 å’Œ 2000 ä¹‹é—´ä»»æ„é€‰æ‹©

+   `--freeze_model=crossattn`

+   è‡³å°‘ä½¿ç”¨ 15-20 å¼ å›¾ç‰‡è¿›è¡Œè®­ç»ƒ

å•ä¸€æ¦‚å¿µå¤šä¸ªæ¦‚å¿µ

```py
export MODEL_NAME="CompVis/stable-diffusion-v1-4"
export OUTPUT_DIR="path-to-save-model"
export INSTANCE_DIR="./data/cat"

accelerate launch train_custom_diffusion.py \
  --pretrained_model_name_or_path=$MODEL_NAME  \
  --instance_data_dir=$INSTANCE_DIR \
  --output_dir=$OUTPUT_DIR \
  --class_data_dir=./real_reg/samples_cat/ \
  --with_prior_preservation \
  --real_prior \
  --prior_loss_weight=1.0 \
  --class_prompt="cat" \
  --num_class_images=200 \
  --instance_prompt="photo of a <new1> cat"  \
  --resolution=512  \
  --train_batch_size=2  \
  --learning_rate=1e-5  \
  --lr_warmup_steps=0 \
  --max_train_steps=250 \
  --scale_lr \
  --hflip  \
  --modifier_token "<new1>" \
  --validation_prompt="<new1> cat sitting in a bucket" \
  --report_to="wandb" \
  --push_to_hub
```

è®­ç»ƒå®Œæˆåï¼Œæ‚¨å¯ä»¥ä½¿ç”¨æ‚¨çš„æ–° Custom Diffusion æ¨¡å‹è¿›è¡Œæ¨æ–­ã€‚

å•ä¸€æ¦‚å¿µå¤šä¸ªæ¦‚å¿µ

```py
import torch
from diffusers import DiffusionPipeline

pipeline = DiffusionPipeline.from_pretrained(
    "CompVis/stable-diffusion-v1-4", torch_dtype=torch.float16,
).to("cuda")
pipeline.unet.load_attn_procs("path-to-save-model", weight_name="pytorch_custom_diffusion_weights.bin")
pipeline.load_textual_inversion("path-to-save-model", weight_name="<new1>.bin")

image = pipeline(
    "<new1> cat sitting in a bucket",
    num_inference_steps=100,
    guidance_scale=6.0,
    eta=1.0,
).images[0]
image.save("cat.png")
```

## ä¸‹ä¸€æ­¥

æ­å–œæ‚¨è®­ç»ƒäº†ä¸€ä¸ª Custom Diffusion æ¨¡å‹ï¼ğŸ‰ è¦äº†è§£æ›´å¤šï¼š

+   é˜…è¯»[æ–‡æœ¬åˆ°å›¾åƒæ‰©æ•£çš„å¤šæ¦‚å¿µå®šåˆ¶](https://www.cs.cmu.edu/~custom-diffusion/)åšæ–‡ï¼Œäº†è§£æœ‰å…³ Custom Diffusion å›¢é˜Ÿå®éªŒç»“æœçš„æ›´å¤šè¯¦ç»†ä¿¡æ¯ã€‚
