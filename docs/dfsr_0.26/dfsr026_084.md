# JAX/Flax

> åŸå§‹æ–‡æœ¬ï¼š[`huggingface.co/docs/diffusers/using-diffusers/stable_diffusion_jax_how_to`](https://huggingface.co/docs/diffusers/using-diffusers/stable_diffusion_jax_how_to)

ğŸ¤— Diffusers æ”¯æŒ Flax åœ¨ Google TPU ä¸Šè¿›è¡Œè¶…å¿«æ¨ç†ï¼Œä¾‹å¦‚åœ¨ Colabã€Kaggle æˆ– Google Cloud Platform ä¸Šå¯ç”¨çš„ TPUã€‚æœ¬æŒ‡å—å‘æ‚¨å±•ç¤ºå¦‚ä½•ä½¿ç”¨ JAX/Flax è¿è¡Œç¨³å®šæ‰©æ•£çš„æ¨ç†ã€‚

åœ¨å¼€å§‹ä¹‹å‰ï¼Œè¯·ç¡®ä¿å·²å®‰è£…å¿…è¦çš„åº“ï¼š

```py
# uncomment to install the necessary libraries in Colab
#!pip install -q jax==0.3.25 jaxlib==0.3.25 flax transformers ftfy
#!pip install -q diffusers
```

æ‚¨è¿˜åº”ç¡®ä¿æ‚¨æ­£åœ¨ä½¿ç”¨ TPU åç«¯ã€‚è™½ç„¶ JAX å¹¶ä¸ä¸“é—¨åœ¨ TPU ä¸Šè¿è¡Œï¼Œä½†åœ¨ TPU ä¸Šä¼šè·å¾—æœ€ä½³æ€§èƒ½ï¼Œå› ä¸ºæ¯å°æœåŠ¡å™¨éƒ½æœ‰ 8 ä¸ª TPU åŠ é€Ÿå™¨å¹¶è¡Œå·¥ä½œã€‚

å¦‚æœæ‚¨åœ¨ Colab ä¸­è¿è¡Œæ­¤æŒ‡å—ï¼Œè¯·åœ¨ä¸Šé¢çš„èœå•ä¸­é€‰æ‹©*è¿è¡Œæ—¶*ï¼Œé€‰æ‹©*æ›´æ”¹è¿è¡Œæ—¶ç±»å‹*é€‰é¡¹ï¼Œç„¶ååœ¨*ç¡¬ä»¶åŠ é€Ÿå™¨*è®¾ç½®ä¸‹é€‰æ‹©*TPU*ã€‚å¯¼å…¥ JAX å¹¶å¿«é€Ÿæ£€æŸ¥æ˜¯å¦æ­£åœ¨ä½¿ç”¨ TPUï¼š

```py
import jax
import jax.tools.colab_tpu
jax.tools.colab_tpu.setup_tpu()

num_devices = jax.device_count()
device_type = jax.devices()[0].device_kind

print(f"Found {num_devices} JAX devices of type {device_type}.")
assert (
    "TPU" in device_type,
    "Available device is not a TPU, please select TPU from Runtime > Change runtime type > Hardware accelerator"
)
# Found 8 JAX devices of type Cloud TPU.
```

ç°åœ¨ï¼Œæ‚¨å¯ä»¥å¯¼å…¥æ‰€éœ€çš„å…¶ä½™ä¾èµ–é¡¹ï¼š

```py
import jax.numpy as jnp
from jax import pmap
from flax.jax_utils import replicate
from flax.training.common_utils import shard

from diffusers import FlaxStableDiffusionPipeline
```

## åŠ è½½æ¨¡å‹

Flax æ˜¯ä¸€ä¸ªåŠŸèƒ½æ€§æ¡†æ¶ï¼Œå› æ­¤æ¨¡å‹æ˜¯æ— çŠ¶æ€çš„ï¼Œå‚æ•°å­˜å‚¨åœ¨æ¨¡å‹ä¹‹å¤–ã€‚åŠ è½½é¢„è®­ç»ƒçš„ Flax ç®¡é“ä¼šè¿”å›*ç®¡é“å’Œæ¨¡å‹æƒé‡ï¼ˆæˆ–å‚æ•°ï¼‰*ã€‚åœ¨æœ¬æŒ‡å—ä¸­ï¼Œæ‚¨å°†ä½¿ç”¨`bfloat16`ï¼Œè¿™æ˜¯ä¸€ç§æ›´é«˜æ•ˆçš„åŠæµ®ç‚¹ç±»å‹ï¼Œå—åˆ° TPU æ”¯æŒï¼ˆå¦‚æœéœ€è¦ï¼Œä¹Ÿå¯ä»¥ä½¿ç”¨`float32`è¿›è¡Œå®Œæ•´ç²¾åº¦ï¼‰ã€‚

```py
dtype = jnp.bfloat16
pipeline, params = FlaxStableDiffusionPipeline.from_pretrained(
    "CompVis/stable-diffusion-v1-4",
    revision="bf16",
    dtype=dtype,
)
```

## æ¨ç†

é€šå¸¸ TPU æœ‰ 8 ä¸ªè®¾å¤‡å¹¶è¡Œå·¥ä½œï¼Œå› æ­¤è®©æˆ‘ä»¬ä¸ºæ¯ä¸ªè®¾å¤‡ä½¿ç”¨ç›¸åŒçš„æç¤ºã€‚è¿™æ„å‘³ç€æ‚¨å¯ä»¥åŒæ—¶åœ¨ 8 ä¸ªè®¾å¤‡ä¸Šæ‰§è¡Œæ¨ç†ï¼Œæ¯ä¸ªè®¾å¤‡ç”Ÿæˆä¸€ä¸ªå›¾åƒã€‚å› æ­¤ï¼Œæ‚¨å°†åœ¨ç›¸åŒçš„æ—¶é—´å†…è·å¾— 8 å¼ å›¾åƒï¼Œå°±åƒä¸€å—èŠ¯ç‰‡ç”Ÿæˆä¸€å¼ å•ä¸ªå›¾åƒæ‰€éœ€çš„æ—¶é—´ä¸€æ ·ï¼

åœ¨å¹¶è¡ŒåŒ–å·¥ä½œåŸç†æ˜¯ä»€ä¹ˆï¼Ÿéƒ¨åˆ†äº†è§£æ›´å¤šç»†èŠ‚ã€‚

åœ¨å¤åˆ¶æç¤ºåï¼Œé€šè¿‡åœ¨ç®¡é“ä¸Šè°ƒç”¨`prepare_inputs`å‡½æ•°æ¥è·å–æ ‡è®°åŒ–æ–‡æœ¬ idã€‚æ ‡è®°åŒ–æ–‡æœ¬çš„é•¿åº¦è®¾ç½®ä¸º 77 ä¸ªæ ‡è®°ï¼Œè¿™æ˜¯åŸºç¡€ CLIP æ–‡æœ¬æ¨¡å‹é…ç½®æ‰€è¦æ±‚çš„ã€‚

```py
prompt = "A cinematic film still of Morgan Freeman starring as Jimi Hendrix, portrait, 40mm lens, shallow depth of field, close up, split lighting, cinematic"
prompt = [prompt] * jax.device_count()
prompt_ids = pipeline.prepare_inputs(prompt)
prompt_ids.shape
# (8, 77)
```

æ¨¡å‹å‚æ•°å’Œè¾“å…¥å¿…é¡»åœ¨ 8 ä¸ªå¹¶è¡Œè®¾å¤‡ä¸Šå¤åˆ¶ã€‚å‚æ•°å­—å…¸ä½¿ç”¨[`flax.jax_utils.replicate`](https://flax.readthedocs.io/en/latest/api_reference/flax.jax_utils.html#flax.jax_utils.replicate)è¿›è¡Œå¤åˆ¶ï¼Œè¯¥å‡½æ•°éå†å­—å…¸å¹¶æ›´æ”¹æƒé‡çš„å½¢çŠ¶ï¼Œä½¿å…¶é‡å¤ 8 æ¬¡ã€‚æ•°ç»„ä½¿ç”¨`shard`è¿›è¡Œå¤åˆ¶ã€‚

```py
# parameters
p_params = replicate(params)

# arrays
prompt_ids = shard(prompt_ids)
prompt_ids.shape
# (8, 1, 77)
```

è¿™ä¸ªå½¢çŠ¶æ„å‘³ç€æ¯ä¸ª 8 ä¸ªè®¾å¤‡éƒ½æ¥æ”¶ä¸€ä¸ªå½¢çŠ¶ä¸º`(1, 77)`çš„`jnp`æ•°ç»„ä½œä¸ºè¾“å…¥ï¼Œå…¶ä¸­`1`æ˜¯æ¯ä¸ªè®¾å¤‡çš„æ‰¹é‡å¤§å°ã€‚åœ¨å…·æœ‰è¶³å¤Ÿå†…å­˜çš„ TPU ä¸Šï¼Œå¦‚æœè¦ä¸€æ¬¡ç”Ÿæˆå¤šä¸ªå›¾åƒï¼ˆæ¯ä¸ªèŠ¯ç‰‡ï¼‰ï¼Œå¯ä»¥ä½¿ç”¨å¤§äº`1`çš„æ‰¹é‡å¤§å°ã€‚

æ¥ä¸‹æ¥ï¼Œåˆ›å»ºä¸€ä¸ªéšæœºæ•°ç”Ÿæˆå™¨ä¼ é€’ç»™ç”Ÿæˆå‡½æ•°ã€‚è¿™æ˜¯ Flax ä¸­çš„æ ‡å‡†ç¨‹åºï¼ŒFlax å¯¹éšæœºæ•°éå¸¸ä¸¥è‚ƒå’Œæœ‰è§åœ°ã€‚æ‰€æœ‰å¤„ç†éšæœºæ•°çš„å‡½æ•°éƒ½åº”è¯¥æ¥æ”¶ä¸€ä¸ªç”Ÿæˆå™¨ï¼Œä»¥ç¡®ä¿å¯é‡ç°æ€§ï¼Œå³ä½¿åœ¨è·¨å¤šä¸ªåˆ†å¸ƒå¼è®¾å¤‡è¿›è¡Œè®­ç»ƒæ—¶ä¹Ÿæ˜¯å¦‚æ­¤ã€‚

ä¸‹é¢çš„è¾…åŠ©å‡½æ•°ä½¿ç”¨ç§å­æ¥åˆå§‹åŒ–éšæœºæ•°ç”Ÿæˆå™¨ã€‚åªè¦ä½¿ç”¨ç›¸åŒçš„ç§å­ï¼Œæ‚¨å°†è·å¾—å®Œå…¨ç›¸åŒçš„ç»“æœã€‚åœ¨åç»­æŒ‡å—ä¸­æ¢ç´¢ç»“æœæ—¶ï¼Œå¯ä»¥éšæ„ä½¿ç”¨ä¸åŒçš„ç§å­ã€‚

```py
def create_key(seed=0):
    return jax.random.PRNGKey(seed)
```

è¾…åŠ©å‡½æ•°ï¼Œæˆ–`rng`ï¼Œè¢«åˆ†æˆ 8 æ¬¡ï¼Œå› æ­¤æ¯ä¸ªè®¾å¤‡æ¥æ”¶ä¸åŒçš„ç”Ÿæˆå™¨å¹¶ç”Ÿæˆä¸åŒçš„å›¾åƒã€‚

```py
rng = create_key(0)
rng = jax.random.split(rng, jax.device_count())
```

ä¸ºäº†åˆ©ç”¨ JAX åœ¨ TPU ä¸Šçš„ä¼˜åŒ–é€Ÿåº¦ï¼Œå°†`jit=True`ä¼ é€’ç»™ç®¡é“ï¼Œå°† JAX ä»£ç ç¼–è¯‘æˆé«˜æ•ˆçš„è¡¨ç¤ºï¼Œå¹¶ç¡®ä¿æ¨¡å‹åœ¨ 8 ä¸ªè®¾å¤‡ä¸Šå¹¶è¡Œè¿è¡Œã€‚

æ‚¨éœ€è¦ç¡®ä¿æ‰€æœ‰è¾“å…¥åœ¨åç»­è°ƒç”¨ä¸­å…·æœ‰ç›¸åŒçš„å½¢çŠ¶ï¼Œå¦åˆ™ JAX å°†éœ€è¦é‡æ–°ç¼–è¯‘ä»£ç ï¼Œè¿™ä¼šæ›´æ…¢ã€‚

ç¬¬ä¸€æ¬¡æ¨ç†è¿è¡Œéœ€è¦æ›´å¤šæ—¶é—´ï¼Œå› ä¸ºéœ€è¦ç¼–è¯‘ä»£ç ï¼Œä½†åç»­è°ƒç”¨ï¼ˆå³ä½¿ä½¿ç”¨ä¸åŒçš„è¾“å…¥ï¼‰ä¼šå¿«å¾—å¤šã€‚ä¾‹å¦‚ï¼Œåœ¨ TPU v2-8 ä¸Šç¼–è¯‘éœ€è¦è¶…è¿‡ä¸€åˆ†é’Ÿï¼Œä½†åœ¨æœªæ¥çš„æ¨ç†è¿è¡Œä¸­å¤§çº¦éœ€è¦**7 ç§’**ï¼

```py
%%time
images = pipeline(prompt_ids, p_params, rng, jit=True)[0]

# CPU times: user 56.2 s, sys: 42.5 s, total: 1min 38s
# Wall time: 1min 29s
```

è¿”å›çš„æ•°ç»„å½¢çŠ¶ä¸º`(8, 1, 512, 512, 3)`ï¼Œåº”è¯¥é‡æ–°æ•´å½¢ä»¥å»é™¤ç¬¬äºŒç»´ï¼Œå¹¶è·å¾—`512 Ã— 512 Ã— 3`çš„ 8 ä¸ªå›¾åƒã€‚ç„¶åï¼Œæ‚¨å¯ä»¥ä½¿ç”¨ numpy_to_pil()å‡½æ•°å°†æ•°ç»„è½¬æ¢ä¸ºå›¾åƒã€‚

```py
from diffusers.utils import make_image_grid

images = images.reshape((images.shape[0] * images.shape[1],) + images.shape[-3:])
images = pipeline.numpy_to_pil(images)
make_image_grid(images, rows=2, cols=4)
```

![img](img/ae26c49256edf5470277710762edc407.png)

## ä½¿ç”¨ä¸åŒçš„æç¤ºç¬¦

æ‚¨ä¸ä¸€å®šéœ€è¦åœ¨æ‰€æœ‰è®¾å¤‡ä¸Šä½¿ç”¨ç›¸åŒçš„æç¤ºã€‚ä¾‹å¦‚ï¼Œè¦ç”Ÿæˆ 8 ä¸ªä¸åŒçš„æç¤ºï¼š

```py
prompts = [
    "Labrador in the style of Hokusai",
    "Painting of a squirrel skating in New York",
    "HAL-9000 in the style of Van Gogh",
    "Times Square under water, with fish and a dolphin swimming around",
    "Ancient Roman fresco showing a man working on his laptop",
    "Close-up photograph of young black woman against urban background, high quality, bokeh",
    "Armchair in the shape of an avocado",
    "Clown astronaut in space, with Earth in the background",
]

prompt_ids = pipeline.prepare_inputs(prompts)
prompt_ids = shard(prompt_ids)

images = pipeline(prompt_ids, p_params, rng, jit=True).images
images = images.reshape((images.shape[0] * images.shape[1],) + images.shape[-3:])
images = pipeline.numpy_to_pil(images)

make_image_grid(images, 2, 4)
```

![img](img/aca4bd3a07a58b9a81031e0734d47ed3.png)

## å¹¶è¡ŒåŒ–æ˜¯å¦‚ä½•å·¥ä½œçš„ï¼Ÿ

ğŸ¤— Diffusers ä¸­çš„ Flax ç®¡é“ä¼šè‡ªåŠ¨ç¼–è¯‘æ¨¡å‹å¹¶åœ¨æ‰€æœ‰å¯ç”¨è®¾å¤‡ä¸Šå¹¶è¡Œè¿è¡Œã€‚è®©æˆ‘ä»¬æ›´ä»”ç»†åœ°çœ‹çœ‹è¿™ä¸ªè¿‡ç¨‹æ˜¯å¦‚ä½•å·¥ä½œçš„ã€‚

JAX å¹¶è¡ŒåŒ–å¯ä»¥é€šè¿‡å¤šç§æ–¹å¼å®ç°ã€‚æœ€ç®€å•çš„æ–¹æ³•æ˜¯ä½¿ç”¨[`jax.pmap`](https://jax.readthedocs.io/en/latest/_autosummary/jax.pmap.html)å‡½æ•°æ¥å®ç°å•ç¨‹åºå¤šæ•°æ®ï¼ˆSPMDï¼‰å¹¶è¡ŒåŒ–ã€‚è¿™æ„å‘³ç€åœ¨ä¸åŒæ•°æ®è¾“å…¥ä¸Šè¿è¡Œç›¸åŒä»£ç çš„å¤šä¸ªå‰¯æœ¬ã€‚è¿˜æœ‰æ›´å¤æ‚çš„æ–¹æ³•ï¼Œå¦‚æœæ‚¨æ„Ÿå…´è¶£ï¼Œå¯ä»¥æŸ¥çœ‹ JAX çš„[æ–‡æ¡£](https://jax.readthedocs.io/en/latest/index.html)ä»¥æ›´è¯¦ç»†åœ°æ¢è®¨è¿™ä¸ªä¸»é¢˜ï¼

`jax.pmap`åšäº†ä¸¤ä»¶äº‹ï¼š

1.  ç¼–è¯‘ï¼ˆæˆ–â€œ`jit`sâ€ï¼‰ç±»ä¼¼äº`jax.jit()`çš„ä»£ç ã€‚å½“æ‚¨è°ƒç”¨`pmap`æ—¶ï¼Œä¸ä¼šå‘ç”Ÿè¿™ç§æƒ…å†µï¼Œåªæœ‰ç¬¬ä¸€æ¬¡è°ƒç”¨`pmap`å‡½æ•°æ—¶æ‰ä¼šå‘ç”Ÿã€‚

1.  ç¡®ä¿ç¼–è¯‘çš„ä»£ç åœ¨æ‰€æœ‰å¯ç”¨è®¾å¤‡ä¸Šå¹¶è¡Œè¿è¡Œã€‚

ä¸ºäº†æ¼”ç¤ºï¼Œåœ¨ç®¡é“çš„`_generate`æ–¹æ³•ä¸Šè°ƒç”¨`pmap`ï¼ˆè¿™æ˜¯ä¸€ä¸ªç”Ÿæˆå›¾åƒçš„ç§æœ‰æ–¹æ³•ï¼Œåœ¨æœªæ¥çš„ğŸ¤— Diffusers ç‰ˆæœ¬ä¸­å¯èƒ½ä¼šè¢«é‡å‘½åæˆ–åˆ é™¤ï¼‰ï¼š

```py
p_generate = pmap(pipeline._generate)
```

è°ƒç”¨`pmap`åï¼Œå‡†å¤‡å¥½çš„å‡½æ•°`p_generate`å°†ï¼š

1.  åœ¨æ¯ä¸ªè®¾å¤‡ä¸Šå¤åˆ¶åŸºç¡€å‡½æ•°`pipeline._generate`ã€‚

1.  å‘æ¯ä¸ªè®¾å¤‡å‘é€ä¸åŒéƒ¨åˆ†çš„è¾“å…¥å‚æ•°ï¼ˆè¿™å°±æ˜¯ä¸ºä»€ä¹ˆéœ€è¦è°ƒç”¨*shard*å‡½æ•°ï¼‰ã€‚åœ¨è¿™ç§æƒ…å†µä¸‹ï¼Œ`prompt_ids`çš„å½¢çŠ¶ä¸º`(8, 1, 77, 768)`ï¼Œå› æ­¤æ•°ç»„è¢«åˆ†æˆ 8 éƒ¨åˆ†ï¼Œæ¯ä¸ª`_generate`çš„å‰¯æœ¬æ¥æ”¶å½¢çŠ¶ä¸º`(1, 77, 768)`çš„è¾“å…¥ã€‚

åœ¨è¿™é‡Œè¦æ³¨æ„çš„æœ€é‡è¦çš„äº‹æƒ…æ˜¯æ‰¹é‡å¤§å°ï¼ˆåœ¨æœ¬ä¾‹ä¸­ä¸º 1ï¼‰å’Œé€‚åˆæ‚¨ä»£ç çš„è¾“å…¥ç»´åº¦ã€‚æ‚¨ä¸å¿…æ›´æ”¹å…¶ä»–ä»»ä½•å†…å®¹å³å¯ä½¿ä»£ç å¹¶è¡Œå·¥ä½œã€‚

ç¬¬ä¸€æ¬¡è°ƒç”¨ç®¡é“éœ€è¦æ›´å¤šæ—¶é—´ï¼Œä½†ä¹‹åçš„è°ƒç”¨é€Ÿåº¦è¦å¿«å¾—å¤šã€‚ä½¿ç”¨`block_until_ready`å‡½æ•°æ¥æ­£ç¡®æµ‹é‡æ¨ç†æ—¶é—´ï¼Œå› ä¸º JAX ä½¿ç”¨å¼‚æ­¥è°ƒåº¦ï¼Œå¹¶å°½å¿«å°†æ§åˆ¶è¿”å›ç»™ Python å¾ªç¯ã€‚æ‚¨ä¸éœ€è¦åœ¨ä»£ç ä¸­ä½¿ç”¨å®ƒï¼›å½“æ‚¨æƒ³è¦ä½¿ç”¨å°šæœªå®ç°çš„è®¡ç®—ç»“æœæ—¶ï¼Œé˜»å¡ä¼šè‡ªåŠ¨å‘ç”Ÿã€‚

```py
%%time
images = p_generate(prompt_ids, p_params, rng)
images = images.block_until_ready()

# CPU times: user 1min 15s, sys: 18.2 s, total: 1min 34s
# Wall time: 1min 15s
```

æ£€æŸ¥æ‚¨çš„å›¾åƒç»´åº¦æ˜¯å¦æ­£ç¡®ï¼š

```py
images.shape
# (8, 1, 512, 512, 3)
```
