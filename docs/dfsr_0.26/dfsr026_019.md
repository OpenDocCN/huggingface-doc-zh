# åŠ è½½ safetensors

> æ›´å¤šåŸæ–‡ï¼š[`huggingface.co/docs/diffusers/using-diffusers/using_safetensors`](https://huggingface.co/docs/diffusers/using-diffusers/using_safetensors)

[safetensors](https://github.com/huggingface/safetensors)æ˜¯ä¸€ç§å®‰å…¨ä¸”å¿«é€Ÿçš„æ–‡ä»¶æ ¼å¼ï¼Œç”¨äºå­˜å‚¨å’ŒåŠ è½½å¼ é‡ã€‚é€šå¸¸ï¼ŒPyTorch æ¨¡å‹æƒé‡ä¼šä½¿ç”¨ Python çš„[`pickle`](https://docs.python.org/3/library/pickle.html)å®ç”¨ç¨‹åºä¿å­˜æˆ–*pickled*ä¸º`.bin`æ–‡ä»¶ã€‚ä½†æ˜¯ï¼Œ`pickle`ä¸å®‰å…¨ï¼Œpickled æ–‡ä»¶å¯èƒ½åŒ…å«å¯ä»¥æ‰§è¡Œçš„æ¶æ„ä»£ç ã€‚safetensors æ˜¯`pickle`çš„å®‰å…¨æ›¿ä»£å“ï¼Œéå¸¸é€‚åˆå…±äº«æ¨¡å‹æƒé‡ã€‚

æœ¬æŒ‡å—å°†å‘æ‚¨å±•ç¤ºå¦‚ä½•åŠ è½½`.safetensor`æ–‡ä»¶ï¼Œä»¥åŠå¦‚ä½•å°†å­˜å‚¨åœ¨å…¶ä»–æ ¼å¼ä¸­çš„ç¨³å®šæ‰©æ•£æ¨¡å‹æƒé‡è½¬æ¢ä¸º`.safetensor`ã€‚åœ¨å¼€å§‹ä¹‹å‰ï¼Œè¯·ç¡®ä¿æ‚¨å·²å®‰è£… safetensorsï¼š

```py
# uncomment to install the necessary libraries in Colab
#!pip install safetensors
```

å¦‚æœæ‚¨æŸ¥çœ‹[`runwayml/stable-diffusion-v1-5`](https://huggingface.co/runwayml/stable-diffusion-v1-5/tree/main)å­˜å‚¨åº“ï¼Œæ‚¨ä¼šçœ‹åˆ°`text_encoder`ã€`unet`å’Œ`vae`å­æ–‡ä»¶å¤¹ä¸­å­˜å‚¨çš„æƒé‡ä»¥`.safetensors`æ ¼å¼å­˜å‚¨ã€‚é»˜è®¤æƒ…å†µä¸‹ï¼ŒğŸ¤— Diffusers ä¼šè‡ªåŠ¨ä»æ¨¡å‹å­˜å‚¨åº“ä¸­çš„å­æ–‡ä»¶å¤¹åŠ è½½è¿™äº›`.safetensors`æ–‡ä»¶ï¼Œå¦‚æœå¯ç”¨ã€‚

ä¸ºäº†æ›´æ˜ç¡®åœ°æ§åˆ¶ï¼Œæ‚¨å¯ä»¥é€‰æ‹©è®¾ç½®`use_safetensors=True`ï¼ˆå¦‚æœæœªå®‰è£…`safetensors`ï¼Œæ‚¨å°†æ”¶åˆ°ä¸€æ¡é”™è¯¯æ¶ˆæ¯ï¼Œè¦æ±‚æ‚¨å®‰è£…å®ƒï¼‰ï¼š

```py
from diffusers import DiffusionPipeline

pipeline = DiffusionPipeline.from_pretrained("runwayml/stable-diffusion-v1-5", use_safetensors=True)
```

ä½†æ˜¯ï¼Œæ¨¡å‹æƒé‡ä¸ä¸€å®šåƒä¸Šé¢çš„ç¤ºä¾‹é‚£æ ·å­˜å‚¨åœ¨å•ç‹¬çš„å­æ–‡ä»¶å¤¹ä¸­ã€‚æœ‰æ—¶ï¼Œæ‰€æœ‰æƒé‡éƒ½å­˜å‚¨åœ¨å•ä¸ª`.safetensors`æ–‡ä»¶ä¸­ã€‚åœ¨è¿™ç§æƒ…å†µä¸‹ï¼Œå¦‚æœæƒé‡æ˜¯ç¨³å®šæ‰©æ•£æƒé‡ï¼Œæ‚¨å¯ä»¥ä½¿ç”¨ from_single_file()æ–¹æ³•ç›´æ¥åŠ è½½æ–‡ä»¶ï¼š

```py
from diffusers import StableDiffusionPipeline

pipeline = StableDiffusionPipeline.from_single_file(
    "https://huggingface.co/WarriorMama777/OrangeMixs/blob/main/Models/AbyssOrangeMix/AbyssOrangeMix.safetensors"
)
```

## è½¬æ¢ä¸º safetensors

Hub ä¸Šå¹¶éæ‰€æœ‰æƒé‡éƒ½ä»¥`.safetensors`æ ¼å¼å¯ç”¨ï¼Œæ‚¨å¯èƒ½ä¼šé‡åˆ°å­˜å‚¨ä¸º`.bin`çš„æƒé‡ã€‚åœ¨è¿™ç§æƒ…å†µä¸‹ï¼Œè¯·ä½¿ç”¨[Convert Space](https://huggingface.co/spaces/diffusers/convert)å°†æƒé‡è½¬æ¢ä¸º`.safetensors`ã€‚Convert Space ä¼šä¸‹è½½ pickled æƒé‡ï¼Œè½¬æ¢å®ƒä»¬ï¼Œå¹¶æ‰“å¼€ä¸€ä¸ªæ‹‰å–è¯·æ±‚ï¼Œä»¥ä¸Šä¼ æ–°è½¬æ¢çš„`.safetensors`æ–‡ä»¶åˆ° Hub ä¸Šã€‚è¿™æ ·ï¼Œå¦‚æœ pickled æ–‡ä»¶ä¸­åŒ…å«ä»»ä½•æ¶æ„ä»£ç ï¼Œå®ƒä»¬å°†è¢«ä¸Šä¼ åˆ° Hub ä¸Š - Hub ä¸Šæœ‰ä¸€ä¸ª[å®‰å…¨æ‰«æå™¨](https://huggingface.co/docs/hub/security-pickle#hubs-security-scanner)æ¥æ£€æµ‹ä¸å®‰å…¨çš„æ–‡ä»¶å’Œå¯ç–‘çš„ pickle å¯¼å…¥ - è€Œä¸æ˜¯ä¸Šä¼ åˆ°æ‚¨çš„è®¡ç®—æœºä¸Šã€‚

æ‚¨å¯ä»¥é€šè¿‡åœ¨`revision`å‚æ•°ä¸­æŒ‡å®šå¯¹æ‹‰å–è¯·æ±‚çš„å¼•ç”¨ï¼ˆæ‚¨è¿˜å¯ä»¥åœ¨ Hub ä¸Šçš„æ­¤[Check PR](https://huggingface.co/spaces/diffusers/check_pr) Space ä¸­æµ‹è¯•å®ƒï¼‰ï¼Œä¾‹å¦‚`refs/pr/22`ï¼Œä½¿ç”¨æ–°çš„`.safetensors`æƒé‡çš„æ¨¡å‹ã€‚

```py
from diffusers import DiffusionPipeline

pipeline = DiffusionPipeline.from_pretrained(
    "stabilityai/stable-diffusion-2-1", revision="refs/pr/22", use_safetensors=True
)
```

## ä¸ºä»€ä¹ˆä½¿ç”¨ safetensorsï¼Ÿ

ä½¿ç”¨ safetensors æœ‰å‡ ä¸ªåŸå› ï¼š

+   å®‰å…¨æ€§æ˜¯ä½¿ç”¨ safetensors çš„é¦–è¦åŸå› ã€‚éšç€å¼€æºå’Œæ¨¡å‹åˆ†å‘çš„å¢é•¿ï¼Œèƒ½å¤Ÿä¿¡ä»»æ‚¨ä¸‹è½½çš„æ¨¡å‹æƒé‡ä¸åŒ…å«ä»»ä½•æ¶æ„ä»£ç å˜å¾—è‡³å…³é‡è¦ã€‚safetensors ä¸­æ ‡å¤´çš„å½“å‰å¤§å°é˜²æ­¢è§£ææå¤§çš„ JSON æ–‡ä»¶ã€‚

+   åœ¨åˆ‡æ¢æ¨¡å‹ä¹‹é—´çš„åŠ è½½é€Ÿåº¦æ˜¯ä½¿ç”¨ safetensors çš„å¦ä¸€ä¸ªåŸå› ï¼Œå®ƒæ‰§è¡Œå¼ é‡çš„é›¶æ‹·è´ã€‚ä¸`pickle`ç›¸æ¯”ï¼Œå¦‚æœæ‚¨å°†æƒé‡åŠ è½½åˆ° CPUï¼ˆé»˜è®¤æƒ…å†µï¼‰ï¼ŒåŠ è½½é€Ÿåº¦ç‰¹åˆ«å¿«ï¼Œå¦‚æœç›´æ¥å°†æƒé‡åŠ è½½åˆ° GPUï¼Œåˆ™ä¸`pickle`ä¸€æ ·å¿«ç”šè‡³æ›´å¿«ã€‚åªæœ‰åœ¨æ¨¡å‹å·²åŠ è½½æ—¶æ‰ä¼šæ³¨æ„åˆ°æ€§èƒ½å·®å¼‚ï¼Œå¦‚æœæ‚¨æ­£åœ¨ä¸‹è½½æƒé‡æˆ–é¦–æ¬¡åŠ è½½æ¨¡å‹ï¼Œåˆ™ä¸ä¼šæ³¨æ„åˆ°ã€‚

    åŠ è½½æ•´ä¸ªç®¡é“æ‰€éœ€çš„æ—¶é—´ï¼š

    ```py
    from diffusers import StableDiffusionPipeline

    pipeline = StableDiffusionPipeline.from_pretrained("stabilityai/stable-diffusion-2-1", use_safetensors=True)
    "Loaded in safetensors 0:00:02.033658"
    "Loaded in PyTorch 0:00:02.663379"
    ```

    ä½†åŠ è½½ 500MB æ¨¡å‹æƒé‡å®é™…æ‰€éœ€çš„æ—¶é—´ä»…ä¸ºï¼š

    ```py
    safetensors: 3.4873ms
    PyTorch: 172.7537ms
    ```

+   åœ¨ safetensors ä¸­ä¹Ÿæ”¯æŒå»¶è¿ŸåŠ è½½ï¼Œè¿™åœ¨åˆ†å¸ƒå¼ç¯å¢ƒä¸­éå¸¸æœ‰ç”¨ï¼Œå¯ä»¥åªåŠ è½½éƒ¨åˆ†å¼ é‡ã€‚è¿™ç§æ ¼å¼ä½¿å¾—[BLOOM](https://huggingface.co/bigscience/bloom)æ¨¡å‹åœ¨ 8 ä¸ª GPU ä¸Šä»…ç”¨ 45 ç§’åŠ è½½å®Œæˆï¼Œè€Œä½¿ç”¨å¸¸è§„çš„ PyTorch æƒé‡åˆ™éœ€è¦ 10 åˆ†é’Ÿã€‚
