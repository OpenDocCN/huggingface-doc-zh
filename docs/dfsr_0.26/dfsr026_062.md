# ControlNet

> åŸæ–‡é“¾æ¥ï¼š[`huggingface.co/docs/diffusers/training/controlnet`](https://huggingface.co/docs/diffusers/training/controlnet)

[ControlNet](https://hf.co/papers/2302.05543)æ¨¡å‹æ˜¯åœ¨å¦ä¸€ä¸ªé¢„è®­ç»ƒæ¨¡å‹ä¹‹ä¸Šè®­ç»ƒçš„é€‚é…å™¨ã€‚å®ƒé€šè¿‡ä½¿ç”¨é¢å¤–çš„è¾“å…¥å›¾åƒå¯¹æ¨¡å‹è¿›è¡Œæ¡ä»¶åŒ–ï¼Œä»è€Œå…è®¸æ›´å¤§ç¨‹åº¦ä¸Šæ§åˆ¶å›¾åƒç”Ÿæˆã€‚è¾“å…¥å›¾åƒå¯ä»¥æ˜¯ canny è¾¹ç¼˜ã€æ·±åº¦å›¾ã€äººä½“å§¿åŠ¿ç­‰ã€‚

å¦‚æœæ‚¨åœ¨å…·æœ‰æœ‰é™ vRAM çš„ GPU ä¸Šè¿›è¡Œè®­ç»ƒï¼Œæ‚¨åº”è¯¥å°è¯•åœ¨è®­ç»ƒå‘½ä»¤ä¸­å¯ç”¨`gradient_checkpointing`ã€`gradient_accumulation_steps`å’Œ`mixed_precision`å‚æ•°ã€‚æ‚¨è¿˜å¯ä»¥é€šè¿‡ä½¿ç”¨ xFormers ä¸­çš„å†…å­˜é«˜æ•ˆæ³¨æ„åŠ›æ¥å‡å°‘å†…å­˜å ç”¨ã€‚JAX/Flax è®­ç»ƒä¹Ÿæ”¯æŒåœ¨ TPU å’Œ GPU ä¸Šè¿›è¡Œé«˜æ•ˆè®­ç»ƒï¼Œä½†ä¸æ”¯æŒæ¢¯åº¦æ£€æŸ¥ç‚¹æˆ– xFormersã€‚å¦‚æœæ‚¨æƒ³è¦ä½¿ç”¨ Flax æ›´å¿«åœ°è¿›è¡Œè®­ç»ƒï¼Œæ‚¨åº”è¯¥æ‹¥æœ‰å¤§äº 30GB å†…å­˜çš„ GPUã€‚

æœ¬æŒ‡å—å°†æ¢è®¨[train_controlnet.py](https://github.com/huggingface/diffusers/blob/main/examples/controlnet/train_controlnet.py)è®­ç»ƒè„šæœ¬ï¼Œä»¥å¸®åŠ©æ‚¨ç†Ÿæ‚‰å®ƒï¼Œä»¥åŠå¦‚ä½•ä¸ºæ‚¨è‡ªå·±çš„ç”¨ä¾‹è¿›è¡Œè°ƒæ•´ã€‚

åœ¨è¿è¡Œè„šæœ¬ä¹‹å‰ï¼Œè¯·ç¡®ä¿æ‚¨ä»æºä»£ç å®‰è£…åº“ï¼š

```py
git clone https://github.com/huggingface/diffusers
cd diffusers
pip install .
```

ç„¶åè½¬åˆ°åŒ…å«è®­ç»ƒè„šæœ¬çš„ç¤ºä¾‹æ–‡ä»¶å¤¹ï¼Œå¹¶å®‰è£…æ‚¨æ­£åœ¨ä½¿ç”¨çš„è„šæœ¬æ‰€éœ€çš„ä¾èµ–é¡¹ï¼š

PyTorchFlax

```py
cd examples/controlnet
pip install -r requirements.txt
```

ğŸ¤— Accelerate æ˜¯ä¸€ä¸ªå¸®åŠ©æ‚¨åœ¨å¤šä¸ª GPU/TPU ä¸Šè®­ç»ƒæˆ–ä½¿ç”¨æ··åˆç²¾åº¦çš„åº“ã€‚å®ƒå°†æ ¹æ®æ‚¨çš„ç¡¬ä»¶å’Œç¯å¢ƒè‡ªåŠ¨é…ç½®æ‚¨çš„è®­ç»ƒè®¾ç½®ã€‚æŸ¥çœ‹ğŸ¤— Accelerate [å¿«é€Ÿå…¥é—¨](https://huggingface.co/docs/accelerate/quicktour)ä»¥äº†è§£æ›´å¤šä¿¡æ¯ã€‚

åˆå§‹åŒ–ğŸ¤— Accelerate ç¯å¢ƒï¼š

```py
accelerate config
```

åœ¨ä¸é€‰æ‹©ä»»ä½•é…ç½®çš„æƒ…å†µä¸‹è®¾ç½®é»˜è®¤çš„ğŸ¤— Accelerate ç¯å¢ƒï¼š

```py
accelerate config default
```

æˆ–è€…ï¼Œå¦‚æœæ‚¨çš„ç¯å¢ƒä¸æ”¯æŒäº¤äº’å¼ shellï¼Œæ¯”å¦‚ç¬”è®°æœ¬ï¼Œæ‚¨å¯ä»¥ä½¿ç”¨ï¼š

```py
from accelerate.utils import write_basic_config

write_basic_config()
```

æœ€åï¼Œå¦‚æœæ‚¨æƒ³åœ¨è‡ªå·±çš„æ•°æ®é›†ä¸Šè®­ç»ƒæ¨¡å‹ï¼Œè¯·æŸ¥çœ‹åˆ›å»ºç”¨äºè®­ç»ƒçš„æ•°æ®é›†æŒ‡å—ï¼Œäº†è§£å¦‚ä½•åˆ›å»ºé€‚ç”¨äºè®­ç»ƒè„šæœ¬çš„æ•°æ®é›†ã€‚

ä»¥ä¸‹éƒ¨åˆ†çªå‡ºäº†è®­ç»ƒè„šæœ¬çš„é‡è¦éƒ¨åˆ†ï¼Œä»¥ä¾¿äº†è§£å¦‚ä½•ä¿®æ”¹å®ƒï¼Œä½†å¹¶æœªè¯¦ç»†æ¶µç›–è„šæœ¬çš„æ¯ä¸ªæ–¹é¢ã€‚å¦‚æœæ‚¨æœ‰å…´è¶£äº†è§£æ›´å¤šï¼Œè¯·éšæ—¶é˜…è¯»[è„šæœ¬](https://github.com/huggingface/diffusers/blob/main/examples/controlnet/train_controlnet.py)ï¼Œå¦‚æœæ‚¨æœ‰ä»»ä½•é—®é¢˜æˆ–ç–‘è™‘ï¼Œè¯·å‘Šè¯‰æˆ‘ä»¬ã€‚

## è„šæœ¬å‚æ•°

è®­ç»ƒè„šæœ¬æä¾›äº†è®¸å¤šå‚æ•°ï¼Œå¸®åŠ©æ‚¨è‡ªå®šä¹‰è®­ç»ƒè¿è¡Œã€‚æ‰€æœ‰å‚æ•°åŠå…¶æè¿°éƒ½å¯ä»¥åœ¨[`parse_args()`](https://github.com/huggingface/diffusers/blob/64603389da01082055a901f2883c4810d1144edb/examples/controlnet/train_controlnet.py#L231)å‡½æ•°ä¸­æ‰¾åˆ°ã€‚è¯¥å‡½æ•°ä¸ºæ¯ä¸ªå‚æ•°æä¾›äº†é»˜è®¤å€¼ï¼Œå¦‚è®­ç»ƒæ‰¹é‡å¤§å°å’Œå­¦ä¹ ç‡ï¼Œä½†å¦‚æœæ‚¨æ„¿æ„ï¼Œä¹Ÿå¯ä»¥åœ¨è®­ç»ƒå‘½ä»¤ä¸­è®¾ç½®è‡ªå·±çš„å€¼ã€‚

ä¾‹å¦‚ï¼Œä¸ºäº†åŠ å¿«ä½¿ç”¨ fp16 æ ¼å¼çš„æ··åˆç²¾åº¦è¿›è¡Œè®­ç»ƒï¼Œè¯·åœ¨è®­ç»ƒå‘½ä»¤ä¸­æ·»åŠ `--mixed_precision`å‚æ•°ï¼š

```py
accelerate launch train_controlnet.py \
  --mixed_precision="fp16"
```

è®¸å¤šåŸºæœ¬å’Œé‡è¦å‚æ•°åœ¨æ–‡æœ¬åˆ°å›¾åƒè®­ç»ƒæŒ‡å—ä¸­æœ‰æè¿°ï¼Œå› æ­¤æœ¬æŒ‡å—åªå…³æ³¨ ControlNet çš„ç›¸å…³å‚æ•°ï¼š

+   `--max_train_samples`ï¼šè®­ç»ƒæ ·æœ¬çš„æ•°é‡ï¼›è¿™å¯ä»¥é™ä½ä»¥åŠ å¿«è®­ç»ƒé€Ÿåº¦ï¼Œä½†å¦‚æœæ‚¨æƒ³è¦æµå¼ä¼ è¾“éå¸¸å¤§çš„æ•°æ®é›†ï¼Œæ‚¨éœ€è¦åœ¨è®­ç»ƒå‘½ä»¤ä¸­åŒ…å«æ­¤å‚æ•°å’Œ`--streaming`å‚æ•°

+   `--gradient_accumulation_steps`ï¼šåœ¨å‘åä¼ é€’ä¹‹å‰ç´¯ç§¯çš„æ›´æ–°æ­¥éª¤æ•°ï¼›è¿™ä½¿æ‚¨å¯ä»¥ä½¿ç”¨æ¯” GPU å†…å­˜é€šå¸¸å¤„ç†çš„æ›´å¤§æ‰¹é‡å¤§å°è¿›è¡Œè®­ç»ƒ

### Min-SNR åŠ æƒ

[Min-SNR](https://huggingface.co/papers/2303.09556)åŠ æƒç­–ç•¥å¯ä»¥é€šè¿‡é‡æ–°å¹³è¡¡æŸå¤±æ¥å¸®åŠ©è®­ç»ƒï¼Œä»¥å®ç°æ›´å¿«çš„æ”¶æ•›ã€‚è®­ç»ƒè„šæœ¬æ”¯æŒé¢„æµ‹`epsilon`ï¼ˆå™ªéŸ³ï¼‰æˆ–`v_prediction`ï¼Œä½† Min-SNR ä¸ä¸¤ç§é¢„æµ‹ç±»å‹å…¼å®¹ã€‚æ­¤åŠ æƒç­–ç•¥ä»…å— PyTorch æ”¯æŒï¼Œåœ¨ Flax è®­ç»ƒè„šæœ¬ä¸­ä¸å¯ç”¨ã€‚

æ·»åŠ `--snr_gamma`å‚æ•°ï¼Œå¹¶å°†å…¶è®¾ç½®ä¸ºæ¨èå€¼ 5.0ï¼š

```py
accelerate launch train_controlnet.py \
  --snr_gamma=5.0
```

## è®­ç»ƒè„šæœ¬

ä¸è„šæœ¬å‚æ•°ä¸€æ ·ï¼Œæ–‡æœ¬åˆ°å›¾åƒè®­ç»ƒæŒ‡å—ä¸­æä¾›äº†å¯¹è®­ç»ƒè„šæœ¬çš„æ•´ä½“ä»‹ç»ã€‚è€Œæœ¬æŒ‡å—åˆ™ç€çœ¼äº ControlNet è„šæœ¬çš„ç›¸å…³éƒ¨åˆ†ã€‚

è®­ç»ƒè„šæœ¬æœ‰ä¸€ä¸ª[`make_train_dataset`](https://github.com/huggingface/diffusers/blob/64603389da01082055a901f2883c4810d1144edb/examples/controlnet/train_controlnet.py#L582)å‡½æ•°ï¼Œç”¨äºå¯¹æ•°æ®é›†è¿›è¡Œé¢„å¤„ç†ï¼ŒåŒ…æ‹¬å›¾åƒè½¬æ¢å’Œæ ‡é¢˜æ ‡è®°åŒ–ã€‚æ‚¨å°†çœ‹åˆ°ï¼Œé™¤äº†é€šå¸¸çš„æ ‡é¢˜æ ‡è®°åŒ–å’Œå›¾åƒè½¬æ¢ä¹‹å¤–ï¼Œè„šæœ¬è¿˜åŒ…æ‹¬ç”¨äºæ¡ä»¶å›¾åƒçš„è½¬æ¢ã€‚

å¦‚æœæ‚¨åœ¨ TPU ä¸Šæµå¼ä¼ è¾“æ•°æ®é›†ï¼Œæ€§èƒ½å¯èƒ½ä¼šå—åˆ°ğŸ¤—æ•°æ®é›†åº“çš„é™åˆ¶ï¼Œè¯¥åº“æœªé’ˆå¯¹å›¾åƒè¿›è¡Œä¼˜åŒ–ã€‚ä¸ºäº†ç¡®ä¿æœ€å¤§ååé‡ï¼Œå»ºè®®æ‚¨æ¢ç´¢å…¶ä»–æ•°æ®é›†æ ¼å¼ï¼Œå¦‚[WebDataset](https://webdataset.github.io/webdataset/)ã€[TorchData](https://github.com/pytorch/data)å’Œ[TensorFlow æ•°æ®é›†](https://www.tensorflow.org/datasets/tfless_tfds)ã€‚

```py
conditioning_image_transforms = transforms.Compose(
    [
        transforms.Resize(args.resolution, interpolation=transforms.InterpolationMode.BILINEAR),
        transforms.CenterCrop(args.resolution),
        transforms.ToTensor(),
    ]
)
```

åœ¨[`main()`](https://github.com/huggingface/diffusers/blob/64603389da01082055a901f2883c4810d1144edb/examples/controlnet/train_controlnet.py#L713)å‡½æ•°ä¸­ï¼Œæ‚¨å°†æ‰¾åˆ°ç”¨äºåŠ è½½åˆ†è¯å™¨ã€æ–‡æœ¬ç¼–ç å™¨ã€è°ƒåº¦å™¨å’Œæ¨¡å‹çš„ä»£ç ã€‚è¿™ä¹Ÿæ˜¯ ControlNet æ¨¡å‹åŠ è½½çš„åœ°æ–¹ï¼Œå¯ä»¥ä»ç°æœ‰æƒé‡åŠ è½½ï¼Œä¹Ÿå¯ä»¥ä» UNet éšæœºåˆå§‹åŒ–ï¼š

```py
if args.controlnet_model_name_or_path:
    logger.info("Loading existing controlnet weights")
    controlnet = ControlNetModel.from_pretrained(args.controlnet_model_name_or_path)
else:
    logger.info("Initializing controlnet weights from unet")
    controlnet = ControlNetModel.from_unet(unet)
```

[ä¼˜åŒ–å™¨](https://github.com/huggingface/diffusers/blob/64603389da01082055a901f2883c4810d1144edb/examples/controlnet/train_controlnet.py#L871)å·²è®¾ç½®ä¸ºæ›´æ–° ControlNet å‚æ•°ï¼š

```py
params_to_optimize = controlnet.parameters()
optimizer = optimizer_class(
    params_to_optimize,
    lr=args.learning_rate,
    betas=(args.adam_beta1, args.adam_beta2),
    weight_decay=args.adam_weight_decay,
    eps=args.adam_epsilon,
)
```

æœ€åï¼Œåœ¨[è®­ç»ƒå¾ªç¯](https://github.com/huggingface/diffusers/blob/64603389da01082055a901f2883c4810d1144edb/examples/controlnet/train_controlnet.py#L943)ä¸­ï¼Œå°†æ¡ä»¶æ–‡æœ¬åµŒå…¥å’Œå›¾åƒä¼ é€’ç»™ ControlNet æ¨¡å‹çš„ä¸‹æ¸¸å’Œä¸­é—´å—ï¼š

```py
encoder_hidden_states = text_encoder(batch["input_ids"])[0]
controlnet_image = batch["conditioning_pixel_values"].to(dtype=weight_dtype)

down_block_res_samples, mid_block_res_sample = controlnet(
    noisy_latents,
    timesteps,
    encoder_hidden_states=encoder_hidden_states,
    controlnet_cond=controlnet_image,
    return_dict=False,
)
```

å¦‚æœæ‚¨æƒ³äº†è§£è®­ç»ƒå¾ªç¯çš„å·¥ä½œåŸç†ï¼Œè¯·æŸ¥çœ‹ç†è§£ç®¡é“ã€æ¨¡å‹å’Œè°ƒåº¦å™¨æ•™ç¨‹ï¼Œè¯¥æ•™ç¨‹è§£é‡Šäº†å»å™ªè¿‡ç¨‹çš„åŸºæœ¬æ¨¡å¼ã€‚

## å¯åŠ¨è„šæœ¬

ç°åœ¨æ‚¨å·²ç»å‡†å¤‡å¥½å¯åŠ¨è®­ç»ƒè„šæœ¬äº†ï¼ğŸš€

æœ¬æŒ‡å—ä½¿ç”¨[fusing/fill50k](https://huggingface.co/datasets/fusing/fill50k)æ•°æ®é›†ï¼Œä½†è¯·è®°ä½ï¼Œå¦‚æœéœ€è¦ï¼Œæ‚¨å¯ä»¥åˆ›å»ºå¹¶ä½¿ç”¨è‡ªå·±çš„æ•°æ®é›†ï¼ˆè¯·å‚é˜…åˆ›å»ºç”¨äºè®­ç»ƒçš„æ•°æ®é›†æŒ‡å—ï¼‰ã€‚

å°†ç¯å¢ƒå˜é‡`MODEL_NAME`è®¾ç½®ä¸º Hub ä¸Šçš„æ¨¡å‹ ID æˆ–æœ¬åœ°æ¨¡å‹çš„è·¯å¾„ï¼Œå°†`OUTPUT_DIR`è®¾ç½®ä¸ºè¦ä¿å­˜æ¨¡å‹çš„ä½ç½®ã€‚

ä¸‹è½½ä»¥ä¸‹å›¾åƒä»¥è¿›è¡Œè®­ç»ƒæ¡ä»¶ï¼š

```py
wget https://huggingface.co/datasets/huggingface/documentation-images/resolve/main/diffusers/controlnet_training/conditioning_image_1.png
wget https://huggingface.co/datasets/huggingface/documentation-images/resolve/main/diffusers/controlnet_training/conditioning_image_2.png
```

åœ¨å¯åŠ¨è„šæœ¬ä¹‹å‰è¿˜æœ‰ä¸€ä»¶äº‹ï¼æ ¹æ®æ‚¨æ‹¥æœ‰çš„ GPUï¼Œæ‚¨å¯èƒ½éœ€è¦å¯ç”¨æŸäº›ä¼˜åŒ–æ¥è®­ç»ƒ ControlNetã€‚æ­¤è„šæœ¬ä¸­çš„é»˜è®¤é…ç½®éœ€è¦çº¦ 38GB çš„ vRAMã€‚å¦‚æœæ‚¨è¦åœ¨å¤šä¸ª GPU ä¸Šè¿›è¡Œè®­ç»ƒï¼Œè¯·åœ¨`accelerate launch`å‘½ä»¤ä¸­æ·»åŠ `--multi_gpu`å‚æ•°ã€‚

16GB12GB8GB

åœ¨ 16GB GPU ä¸Šï¼Œæ‚¨å¯ä»¥ä½¿ç”¨ bitsandbytes 8 ä½ä¼˜åŒ–å™¨å’Œæ¢¯åº¦æ£€æŸ¥ç‚¹æ¥ä¼˜åŒ–æ‚¨çš„è®­ç»ƒè¿è¡Œã€‚å®‰è£… bitsandbytesï¼š

```py
pip install bitsandbytes
```

ç„¶åï¼Œåœ¨è®­ç»ƒå‘½ä»¤ä¸­æ·»åŠ ä»¥ä¸‹å‚æ•°ï¼š

```py
accelerate launch train_controlnet.py \
  --gradient_checkpointing \
  --use_8bit_adam \
```

PyTorchFlax

```py
export MODEL_DIR="runwayml/stable-diffusion-v1-5"
export OUTPUT_DIR="path/to/save/model"

accelerate launch train_controlnet.py \
 --pretrained_model_name_or_path=$MODEL_DIR \
 --output_dir=$OUTPUT_DIR \
 --dataset_name=fusing/fill50k \
 --resolution=512 \
 --learning_rate=1e-5 \
 --validation_image "./conditioning_image_1.png" "./conditioning_image_2.png" \
 --validation_prompt "red circle with blue background" "cyan circle with brown floral background" \
 --train_batch_size=1 \
 --gradient_accumulation_steps=4 \
 --push_to_hub
```

è®­ç»ƒå®Œæˆåï¼Œæ‚¨å¯ä»¥ä½¿ç”¨æ–°è®­ç»ƒçš„æ¨¡å‹è¿›è¡Œæ¨æ–­ï¼

```py
from diffusers import StableDiffusionControlNetPipeline, ControlNetModel
from diffusers.utils import load_image
import torch

controlnet = ControlNetModel.from_pretrained("path/to/controlnet", torch_dtype=torch.float16)
pipeline = StableDiffusionControlNetPipeline.from_pretrained(
    "path/to/base/model", controlnet=controlnet, torch_dtype=torch.float16
).to("cuda")

control_image = load_image("./conditioning_image_1.png")
prompt = "pale golden rod circle with old lace background"

generator = torch.manual_seed(0)
image = pipe(prompt, num_inference_steps=20, generator=generator, image=control_image).images[0]
image.save("./output.png")
```

## ç¨³å®šæ‰©æ•£ XL

ç¨³å®šæ‰©æ•£ XLï¼ˆSDXLï¼‰æ˜¯ä¸€ä¸ªå¼ºå¤§çš„æ–‡æœ¬åˆ°å›¾åƒæ¨¡å‹ï¼Œå¯ä»¥ç”Ÿæˆé«˜åˆ†è¾¨ç‡å›¾åƒï¼Œå¹¶åœ¨å…¶æ¶æ„ä¸­æ·»åŠ äº†ç¬¬äºŒä¸ªæ–‡æœ¬ç¼–ç å™¨ã€‚ä½¿ç”¨[`train_controlnet_sdxl.py`](https://github.com/huggingface/diffusers/blob/main/examples/controlnet/train_controlnet_sdxl.py)è„šæœ¬æ¥è®­ç»ƒ SDXL æ¨¡å‹çš„ ControlNet é€‚é…å™¨ã€‚

æœ‰å…³ SDXL è®­ç»ƒè„šæœ¬çš„è¯¦ç»†è®¨è®ºï¼Œè¯·å‚é˜… SDXL è®­ç»ƒæŒ‡å—ã€‚

## ä¸‹ä¸€æ­¥

æ­å–œæ‚¨æˆåŠŸè®­ç»ƒäº†è‡ªå·±çš„ ControlNetï¼è¦äº†è§£å¦‚ä½•ä½¿ç”¨æ‚¨çš„æ–°æ¨¡å‹ï¼Œä»¥ä¸‹æŒ‡å—å¯èƒ½ä¼šæœ‰æ‰€å¸®åŠ©ï¼š

+   å­¦ä¹ å¦‚ä½•åœ¨å„ç§ä»»åŠ¡ä¸­ä½¿ç”¨ ControlNet è¿›è¡Œæ¨æ–­ã€‚
