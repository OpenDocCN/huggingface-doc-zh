# è´¡çŒ®ä¸€ä¸ªç¤¾åŒºæµæ°´çº¿

> åŸæ–‡é“¾æ¥ï¼š[`huggingface.co/docs/diffusers/using-diffusers/contribute_pipeline`](https://huggingface.co/docs/diffusers/using-diffusers/contribute_pipeline)

ğŸ’¡ æŸ¥çœ‹ GitHub Issue [#841](https://github.com/huggingface/diffusers/issues/841) ä»¥è·å–æœ‰å…³ä¸ºä»€ä¹ˆæˆ‘ä»¬æ­£åœ¨æ·»åŠ ç¤¾åŒºæµæ°´çº¿ä»¥å¸®åŠ©æ¯ä¸ªäººè½»æ¾å…±äº«å·¥ä½œè€Œä¸å—é˜»ç¢çš„æ›´å¤šèƒŒæ™¯ä¿¡æ¯ã€‚

ç¤¾åŒºæµæ°´çº¿å…è®¸æ‚¨åœ¨ DiffusionPipeline ä¹‹ä¸Šæ·»åŠ ä»»ä½•æ‚¨æƒ³è¦çš„é™„åŠ åŠŸèƒ½ã€‚åœ¨ `DiffusionPipeline` çš„åŸºç¡€ä¸Šæ„å»ºçš„ä¸»è¦å¥½å¤„æ˜¯ä»»ä½•äººéƒ½å¯ä»¥é€šè¿‡æ·»åŠ ä¸€ä¸ªå‚æ•°æ¥åŠ è½½å’Œä½¿ç”¨æ‚¨çš„æµæ°´çº¿ï¼Œä½¿ç¤¾åŒºè½»æ¾è®¿é—®ã€‚

æœ¬æŒ‡å—å°†å‘æ‚¨å±•ç¤ºå¦‚ä½•åˆ›å»ºä¸€ä¸ªç¤¾åŒºæµæ°´çº¿å¹¶è§£é‡Šå®ƒä»¬çš„å·¥ä½œåŸç†ã€‚ä¸ºäº†ä¿æŒç®€å•ï¼Œæ‚¨å°†åˆ›å»ºä¸€ä¸ªâ€œä¸€æ­¥â€æµæ°´çº¿ï¼Œå…¶ä¸­ `UNet` è¿›è¡Œä¸€æ¬¡å‰å‘ä¼ é€’å¹¶è°ƒç”¨è°ƒåº¦ç¨‹åºä¸€æ¬¡ã€‚

## åˆå§‹åŒ–æµæ°´çº¿

æ‚¨åº”è¯¥é¦–å…ˆä¸ºæ‚¨çš„ç¤¾åŒºæµæ°´çº¿åˆ›å»ºä¸€ä¸ª `one_step_unet.py` æ–‡ä»¶ã€‚åœ¨æ­¤æ–‡ä»¶ä¸­ï¼Œåˆ›å»ºä¸€ä¸ªç»§æ‰¿è‡ª DiffusionPipeline çš„æµæ°´çº¿ç±»ï¼Œä»¥ä¾¿èƒ½å¤Ÿä» Hub åŠ è½½æ¨¡å‹æƒé‡å’Œè°ƒåº¦ç¨‹åºé…ç½®ã€‚ä¸€æ­¥æµæ°´çº¿éœ€è¦ä¸€ä¸ª `UNet` å’Œä¸€ä¸ªè°ƒåº¦ç¨‹åºï¼Œå› æ­¤æ‚¨éœ€è¦å°†å®ƒä»¬ä½œä¸ºå‚æ•°æ·»åŠ åˆ° `__init__` å‡½æ•°ä¸­ï¼š

```py
from diffusers import DiffusionPipeline
import torch

class UnetSchedulerOneForwardPipeline(DiffusionPipeline):
    def __init__(self, unet, scheduler):
        super().__init__()
```

ä¸ºäº†ç¡®ä¿æ‚¨çš„æµæ°´çº¿åŠå…¶ç»„ä»¶ï¼ˆ`unet` å’Œ `scheduler`ï¼‰å¯ä»¥é€šè¿‡ save_pretrained() è¿›è¡Œä¿å­˜ï¼Œå°†å®ƒä»¬æ·»åŠ åˆ° `register_modules` å‡½æ•°ä¸­ï¼š

```py
  from diffusers import DiffusionPipeline
  import torch

  class UnetSchedulerOneForwardPipeline(DiffusionPipeline):
      def __init__(self, unet, scheduler):
          super().__init__()

+         self.register_modules(unet=unet, scheduler=scheduler)
```

é…·ï¼Œ`__init__` æ­¥éª¤å·²å®Œæˆï¼Œç°åœ¨å¯ä»¥è½¬åˆ°å‰å‘ä¼ é€’äº†ï¼ğŸ”¥

## å®šä¹‰å‰å‘ä¼ é€’

åœ¨å‰å‘ä¼ é€’ä¸­ï¼Œæˆ‘ä»¬å»ºè®®å°†å…¶å®šä¹‰ä¸º `__call__`ï¼Œæ‚¨å¯ä»¥å®Œå…¨è‡ªç”±åœ°æ·»åŠ ä»»ä½•æ‚¨æƒ³è¦çš„åŠŸèƒ½ã€‚å¯¹äºæˆ‘ä»¬æƒŠäººçš„ä¸€æ­¥æµæ°´çº¿ï¼Œé€šè¿‡è®¾ç½® `timestep=1` åˆ›å»ºä¸€ä¸ªéšæœºå›¾åƒï¼Œå¹¶ä»…è°ƒç”¨ä¸€æ¬¡ `unet` å’Œ `scheduler`ï¼š

```py
  from diffusers import DiffusionPipeline
  import torch

  class UnetSchedulerOneForwardPipeline(DiffusionPipeline):
      def __init__(self, unet, scheduler):
          super().__init__()

          self.register_modules(unet=unet, scheduler=scheduler)

+     def __call__(self):
+         image = torch.randn(
+             (1, self.unet.config.in_channels, self.unet.config.sample_size, self.unet.config.sample_size),
+         )
+         timestep = 1

+         model_output = self.unet(image, timestep).sample
+         scheduler_output = self.scheduler.step(model_output, timestep, image).prev_sample

+         return scheduler_output
```

å°±æ˜¯è¿™æ ·ï¼ğŸš€ ç°åœ¨æ‚¨å¯ä»¥é€šè¿‡ä¼ é€’ `unet` å’Œ `scheduler` æ¥è¿è¡Œæ­¤æµæ°´çº¿ï¼š

```py
from diffusers import DDPMScheduler, UNet2DModel

scheduler = DDPMScheduler()
unet = UNet2DModel()

pipeline = UnetSchedulerOneForwardPipeline(unet=unet, scheduler=scheduler)

output = pipeline()
```

ä½†æ›´å¥½çš„æ˜¯ï¼Œå¦‚æœæµæ°´çº¿ç»“æ„ç›¸åŒï¼Œæ‚¨å¯ä»¥å°†é¢„å…ˆå­˜åœ¨çš„æƒé‡åŠ è½½åˆ°æµæ°´çº¿ä¸­ã€‚ä¾‹å¦‚ï¼Œæ‚¨å¯ä»¥å°† [`google/ddpm-cifar10-32`](https://huggingface.co/google/ddpm-cifar10-32) çš„æƒé‡åŠ è½½åˆ°ä¸€æ­¥æµæ°´çº¿ä¸­ï¼š

```py
pipeline = UnetSchedulerOneForwardPipeline.from_pretrained("google/ddpm-cifar10-32", use_safetensors=True)

output = pipeline()
```

## åˆ†äº«æ‚¨çš„æµæ°´çº¿

åœ¨ ğŸ§¨ Diffusers [repository](https://github.com/huggingface/diffusers) ä¸Šæ‰“å¼€ä¸€ä¸ª Pull Requestï¼Œå°†æ‚¨çš„å‡ºè‰²æµæ°´çº¿æ·»åŠ åˆ° [examples/community](https://github.com/huggingface/diffusers/tree/main/examples/community) å­æ–‡ä»¶å¤¹ä¸­ã€‚

ä¸€æ—¦åˆå¹¶ï¼Œä»»ä½•å®‰è£…äº† `diffusers >= 0.4.0` çš„äººéƒ½å¯ä»¥é€šè¿‡åœ¨ `custom_pipeline` å‚æ•°ä¸­æŒ‡å®šå®ƒæ¥ç¥å¥‡åœ°ä½¿ç”¨è¿™ä¸ªæµæ°´çº¿ ğŸª„ï¼š

```py
from diffusers import DiffusionPipeline

pipe = DiffusionPipeline.from_pretrained(
    "google/ddpm-cifar10-32", custom_pipeline="one_step_unet", use_safetensors=True
)
pipe()
```

åˆ†äº«æ‚¨çš„ç¤¾åŒºæµæ°´çº¿çš„å¦ä¸€ç§æ–¹æ³•æ˜¯å°† `one_step_unet.py` æ–‡ä»¶ç›´æ¥ä¸Šä¼ åˆ°æ‚¨é¦–é€‰çš„ [æ¨¡å‹å­˜å‚¨åº“](https://huggingface.co/docs/hub/models-uploading) ä¸Šçš„ Hubã€‚è€Œä¸æ˜¯æŒ‡å®š `one_step_unet.py` æ–‡ä»¶ï¼Œå°†æ¨¡å‹å­˜å‚¨åº“ id ä¼ é€’ç»™ `custom_pipeline` å‚æ•°ï¼š

```py
from diffusers import DiffusionPipeline

pipeline = DiffusionPipeline.from_pretrained(
    "google/ddpm-cifar10-32", custom_pipeline="stevhliu/one_step_unet", use_safetensors=True
)
```

æŸ¥çœ‹ä»¥ä¸‹è¡¨æ ¼ï¼Œæ¯”è¾ƒä¸¤ç§å…±äº«å·¥ä½œæµç¨‹ï¼Œä»¥å¸®åŠ©æ‚¨å†³å®šæœ€é€‚åˆæ‚¨çš„é€‰é¡¹ï¼š

|  | GitHub ç¤¾åŒºæµæ°´çº¿ | HF Hub ç¤¾åŒºæµæ°´çº¿ |
| --- | --- | --- |
| ç”¨æ³• | ç›¸åŒ | ç›¸åŒ |
| å®¡æŸ¥æµç¨‹ | åœ¨ GitHub ä¸Šæ‰“å¼€ä¸€ä¸ª Pull Request å¹¶åœ¨åˆå¹¶ä¹‹å‰æ¥å— Diffusers å›¢é˜Ÿçš„å®¡æŸ¥æµç¨‹ï¼›å¯èƒ½ä¼šè¾ƒæ…¢ | ç›´æ¥ä¸Šä¼ åˆ° Hub å­˜å‚¨åº“ï¼Œæ— éœ€ä»»ä½•å®¡æŸ¥ï¼›è¿™æ˜¯æœ€å¿«çš„å·¥ä½œæµç¨‹ |
| å¯è§æ€§ | åŒ…å«åœ¨å®˜æ–¹ Diffusers å­˜å‚¨åº“å’Œæ–‡æ¡£ä¸­ | åŒ…å«åœ¨æ‚¨çš„ HF Hub ä¸ªäººèµ„æ–™ä¸­ï¼Œå¹¶ä¾èµ–äºæ‚¨è‡ªå·±çš„ä½¿ç”¨/æ¨å¹¿æ¥è·å¾—å¯è§æ€§ |

ğŸ’¡ æ— è®ºæ‚¨åœ¨ç¤¾åŒºç®¡é“æ–‡ä»¶ä¸­ä½¿ç”¨ä»€ä¹ˆåŒ… - åªè¦ç”¨æˆ·å·²å®‰è£…ï¼Œä¸€åˆ‡éƒ½ä¼šæ­£å¸¸å·¥ä½œã€‚ç¡®ä¿æ‚¨æœ‰ä¸€ä¸ªä¸”ä»…æœ‰ä¸€ä¸ªä»`DiffusionPipeline`ç»§æ‰¿çš„ç®¡é“ç±»ï¼Œå› ä¸ºè¿™ä¼šè‡ªåŠ¨æ£€æµ‹ã€‚

## ç¤¾åŒºç®¡é“å¦‚ä½•å·¥ä½œï¼Ÿ

ç¤¾åŒºç®¡é“æ˜¯ä» DiffusionPipeline ç»§æ‰¿çš„ç±»ï¼Œè¿™æ„å‘³ç€ï¼š

+   å®ƒå¯ä»¥é€šè¿‡`custom_pipeline`å‚æ•°åŠ è½½ã€‚

+   æ¨¡å‹æƒé‡å’Œè°ƒåº¦å™¨é…ç½®ä»`pretrained_model_name_or_path`åŠ è½½ã€‚

+   åœ¨ç¤¾åŒºç®¡é“ä¸­å®ç°åŠŸèƒ½çš„ä»£ç åœ¨`pipeline.py`æ–‡ä»¶ä¸­å®šä¹‰ã€‚

æœ‰æ—¶æ‚¨æ— æ³•ä»å®˜æ–¹å­˜å‚¨åº“åŠ è½½æ‰€æœ‰ç®¡é“ç»„ä»¶çš„æƒé‡ã€‚åœ¨è¿™ç§æƒ…å†µä¸‹ï¼Œå…¶ä»–ç»„ä»¶åº”ç›´æ¥ä¼ é€’ç»™ç®¡é“ï¼š

```py
from diffusers import DiffusionPipeline
from transformers import CLIPImageProcessor, CLIPModel

model_id = "CompVis/stable-diffusion-v1-4"
clip_model_id = "laion/CLIP-ViT-B-32-laion2B-s34B-b79K"

feature_extractor = CLIPImageProcessor.from_pretrained(clip_model_id)
clip_model = CLIPModel.from_pretrained(clip_model_id, torch_dtype=torch.float16)

pipeline = DiffusionPipeline.from_pretrained(
    model_id,
    custom_pipeline="clip_guided_stable_diffusion",
    clip_model=clip_model,
    feature_extractor=feature_extractor,
    scheduler=scheduler,
    torch_dtype=torch.float16,
    use_safetensors=True,
)
```

ç¤¾åŒºç®¡é“èƒŒåçš„é­”åŠ›åŒ…å«åœ¨ä»¥ä¸‹ä»£ç ä¸­ã€‚å®ƒå…è®¸ä» GitHub æˆ– Hub åŠ è½½ç¤¾åŒºç®¡é“ï¼Œå¹¶ä¸”å°†å¯¹æ‰€æœ‰ğŸ§¨ Diffusers åŒ…å¯ç”¨ã€‚

```py
# 2\. Load the pipeline class, if using custom module then load it from the Hub
# if we load from explicit class, let's use it
if custom_pipeline is not None:
    pipeline_class = get_class_from_dynamic_module(
        custom_pipeline, module_file=CUSTOM_PIPELINE_FILE_NAME, cache_dir=custom_pipeline
    )
elif cls != DiffusionPipeline:
    pipeline_class = cls
else:
    diffusers_module = importlib.import_module(cls.__module__.split(".")[0])
    pipeline_class = getattr(diffusers_module, config_dict["_class_name"])
```
