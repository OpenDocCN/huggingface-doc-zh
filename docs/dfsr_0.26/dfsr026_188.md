# DDIMScheduler

> åŸå§‹æ–‡æœ¬ï¼š[`huggingface.co/docs/diffusers/api/schedulers/ddim`](https://huggingface.co/docs/diffusers/api/schedulers/ddim)

[Jiaming Songã€Chenlin Meng å’Œ Stefano Ermon æ’°å†™çš„ [å»å™ªæ‰©æ•£éšå¼æ¨¡å‹](https://huggingface.co/papers/2010.02502)ï¼ˆDDIMï¼‰ã€‚

è®ºæ–‡æ‘˜è¦å¦‚ä¸‹ï¼š

*å»å™ªæ‰©æ•£æ¦‚ç‡æ¨¡å‹ï¼ˆDDPMsï¼‰åœ¨æ²¡æœ‰å¯¹æŠ—è®­ç»ƒçš„æƒ…å†µä¸‹å®ç°äº†é«˜è´¨é‡çš„å›¾åƒç”Ÿæˆï¼Œä½†å®ƒä»¬éœ€è¦æ¨¡æ‹Ÿè®¸å¤šæ­¥éª¤çš„é©¬å°”å¯å¤«é“¾æ‰èƒ½ç”Ÿæˆæ ·æœ¬ã€‚ä¸ºäº†åŠ é€Ÿé‡‡æ ·ï¼Œæˆ‘ä»¬æå‡ºäº†å»å™ªæ‰©æ•£éšå¼æ¨¡å‹ï¼ˆDDIMsï¼‰ï¼Œè¿™æ˜¯ä¸€ç§æ›´é«˜æ•ˆçš„è¿­ä»£éšå¼æ¦‚ç‡æ¨¡å‹ç±»ï¼Œå…·æœ‰ä¸ DDPMs ç›¸åŒçš„è®­ç»ƒè¿‡ç¨‹ã€‚åœ¨ DDPMs ä¸­ï¼Œç”Ÿæˆè¿‡ç¨‹è¢«å®šä¹‰ä¸ºé©¬å°”å¯å¤«æ‰©æ•£è¿‡ç¨‹çš„åå‘ã€‚æˆ‘ä»¬æ„å»ºäº†ä¸€ç±»éé©¬å°”å¯å¤«æ‰©æ•£è¿‡ç¨‹ï¼Œè¿™äº›è¿‡ç¨‹å¯¼è‡´ç›¸åŒçš„è®­ç»ƒç›®æ ‡ï¼Œä½†å…¶åå‘è¿‡ç¨‹å¯ä»¥æ›´å¿«åœ°ä»ä¸­é‡‡æ ·ã€‚æˆ‘ä»¬åœ¨å®è¯ä¸­è¯æ˜ï¼Œä¸ DDPMs ç›¸æ¯”ï¼ŒDDIMs å¯ä»¥åœ¨å¢™é’Ÿæ—¶é—´æ–¹é¢ä»¥ 10Ã— åˆ° 50Ã— çš„é€Ÿåº¦äº§ç”Ÿé«˜è´¨é‡æ ·æœ¬ï¼Œä½¿æˆ‘ä»¬èƒ½å¤Ÿåœ¨è®¡ç®—å’Œæ ·æœ¬è´¨é‡ä¹‹é—´è¿›è¡Œæƒè¡¡ï¼Œå¹¶ä¸”å¯ä»¥ç›´æ¥åœ¨æ½œåœ¨ç©ºé—´ä¸­æ‰§è¡Œè¯­ä¹‰ä¸Šæœ‰æ„ä¹‰çš„å›¾åƒæ’å€¼ã€‚*

æœ¬æ–‡çš„åŸå§‹ä»£ç å¯ä»¥åœ¨ [ermongroup/ddim](https://github.com/ermongroup/ddim) æ‰¾åˆ°ï¼Œæ‚¨å¯ä»¥åœ¨ [tsong.me](https://tsong.me/) ä¸Šè”ç³»ä½œè€…ã€‚

## æç¤º

è®ºæ–‡ [Common Diffusion Noise Schedules and Sample Steps are Flawed](https://huggingface.co/papers/2305.08891) å£°ç§°è®­ç»ƒå’Œæ¨æ–­è®¾ç½®ä¹‹é—´çš„ä¸åŒ¹é…å¯¼è‡´äº†ç¨³å®šæ‰©æ•£çš„æ¨æ–­ç”Ÿæˆç»“æœä¸ä½³ã€‚ä¸ºäº†è§£å†³è¿™ä¸ªé—®é¢˜ï¼Œä½œè€…æå‡ºï¼š

ğŸ§ª è¿™æ˜¯ä¸€ä¸ªå®éªŒæ€§åŠŸèƒ½ï¼

1.  é‡æ–°è°ƒæ•´å™ªå£°è®¡åˆ’ä»¥å¼ºåˆ¶é›¶ç»ˆç«¯ä¿¡å™ªæ¯”ï¼ˆSNRï¼‰

```py
pipe.scheduler = DDIMScheduler.from_config(pipe.scheduler.config, rescale_betas_zero_snr=True)
```

1.  ä½¿ç”¨ `v_prediction` è®­ç»ƒæ¨¡å‹ï¼ˆå°†ä»¥ä¸‹å‚æ•°æ·»åŠ åˆ° [train_text_to_image.py](https://github.com/huggingface/diffusers/blob/main/examples/text_to_image/train_text_to_image.py) æˆ– [train_text_to_image_lora.py](https://github.com/huggingface/diffusers/blob/main/examples/text_to_image/train_text_to_image_lora.py) è„šæœ¬ä¸­ï¼‰

```py
--prediction_type="v_prediction"
```

1.  æ›´æ”¹é‡‡æ ·å™¨ä»¥å§‹ç»ˆä»æœ€åä¸€ä¸ªæ—¶é—´æ­¥å¼€å§‹

```py
pipe.scheduler = DDIMScheduler.from_config(pipe.scheduler.config, timestep_spacing="trailing")
```

1.  é‡æ–°è°ƒæ•´æ— åˆ†ç±»å™¨æŒ‡å¯¼ä»¥é˜²æ­¢è¿‡åº¦æ›å…‰

```py
image = pipe(prompt, guidance_rescale=0.7).images[0]
```

ä¾‹å¦‚ï¼š

```py
from diffusers import DiffusionPipeline, DDIMScheduler
import torch

pipe = DiffusionPipeline.from_pretrained("ptx0/pseudo-journey-v2", torch_dtype=torch.float16)
pipe.scheduler = DDIMScheduler.from_config(
    pipe.scheduler.config, rescale_betas_zero_snr=True, timestep_spacing="trailing"
)
pipe.to("cuda")

prompt = "A lion in galaxies, spirals, nebulae, stars, smoke, iridescent, intricate detail, octane render, 8k"
image = pipe(prompt, guidance_rescale=0.7).images[0]
image
```

## DDIMScheduler

### `class diffusers.DDIMScheduler`

[< source >](https://github.com/huggingface/diffusers/blob/v0.26.3/src/diffusers/schedulers/scheduling_ddim.py#L131)

```py
( num_train_timesteps: int = 1000 beta_start: float = 0.0001 beta_end: float = 0.02 beta_schedule: str = 'linear' trained_betas: Union = None clip_sample: bool = True set_alpha_to_one: bool = True steps_offset: int = 0 prediction_type: str = 'epsilon' thresholding: bool = False dynamic_thresholding_ratio: float = 0.995 clip_sample_range: float = 1.0 sample_max_value: float = 1.0 timestep_spacing: str = 'leading' rescale_betas_zero_snr: bool = False )
```

å‚æ•°

+   `num_train_timesteps` (`int`, é»˜è®¤ä¸º 1000) â€” è®­ç»ƒæ¨¡å‹çš„æ‰©æ•£æ­¥éª¤æ•°ã€‚

+   `beta_start` (`float`, é»˜è®¤ä¸º 0.0001) â€” æ¨æ–­çš„èµ·å§‹ `beta` å€¼ã€‚

+   `beta_end` (`float`, é»˜è®¤ä¸º 0.02) â€” æœ€ç»ˆçš„ `beta` å€¼ã€‚

+   `beta_schedule` (`str`, é»˜è®¤ä¸º `"linear"`) â€” beta è®¡åˆ’ï¼Œä» beta èŒƒå›´åˆ°ç”¨äºæ¨¡å‹æ­¥è¿›çš„ beta åºåˆ—çš„æ˜ å°„ã€‚å¯é€‰æ‹© `linear`ã€`scaled_linear` æˆ– `squaredcos_cap_v2`ã€‚

+   `trained_betas` (`np.ndarray`, *å¯é€‰*) â€” ç›´æ¥ä¼ é€’ä¸€ä¸ª beta æ•°ç»„ç»™æ„é€ å‡½æ•°ï¼Œä»¥ç»•è¿‡ `beta_start` å’Œ `beta_end`ã€‚

+   `clip_sample` (`bool`, é»˜è®¤ä¸º `True`) â€” ä¸ºäº†æ•°å€¼ç¨³å®šæ€§è€Œè£å‰ªé¢„æµ‹æ ·æœ¬ã€‚

+   `clip_sample_range` (`float`, é»˜è®¤ä¸º 1.0) â€” é‡‡æ ·è£å‰ªçš„æœ€å¤§å¹…åº¦ã€‚ä»…å½“ `clip_sample=True` æ—¶æœ‰æ•ˆã€‚

+   `set_alpha_to_one` (`bool`, é»˜è®¤ä¸º `True`) â€” æ¯ä¸ªæ‰©æ•£æ­¥éª¤ä½¿ç”¨è¯¥æ­¥éª¤å’Œä¸Šä¸€ä¸ªæ­¥éª¤çš„ alphas ä¹˜ç§¯å€¼ã€‚å¯¹äºæœ€åä¸€æ­¥ï¼Œæ²¡æœ‰ä¸Šä¸€ä¸ª alphaã€‚å½“æ­¤é€‰é¡¹ä¸º `True` æ—¶ï¼Œå‰ä¸€ä¸ª alpha ä¹˜ç§¯è¢«å›ºå®šä¸º `1`ï¼Œå¦åˆ™ä½¿ç”¨æ­¥éª¤ 0 çš„ alpha å€¼ã€‚

+   `steps_offset` (`int`, é»˜è®¤ä¸º 0) â€” æ·»åŠ åˆ°æ¨æ–­æ­¥éª¤çš„åç§»é‡ã€‚æ‚¨å¯ä»¥ä½¿ç”¨ `offset=1` å’Œ `set_alpha_to_one=False` çš„ç»„åˆï¼Œä½¿æœ€åä¸€æ­¥ä½¿ç”¨æ­¥éª¤ 0 ä½œä¸ºä¸Šä¸€ä¸ª alpha ä¹˜ç§¯ï¼Œå°±åƒåœ¨ Stable Diffusion ä¸­ä¸€æ ·ã€‚

+   `prediction_type`ï¼ˆ`str`ï¼Œé»˜è®¤ä¸º`epsilon`ï¼Œ*å¯é€‰*ï¼‰â€” è°ƒåº¦å‡½æ•°çš„é¢„æµ‹ç±»å‹ï¼›å¯ä»¥æ˜¯`epsilon`ï¼ˆé¢„æµ‹æ‰©æ•£è¿‡ç¨‹çš„å™ªå£°ï¼‰ï¼Œ`sample`ï¼ˆç›´æ¥é¢„æµ‹æœ‰å™ªå£°çš„æ ·æœ¬ï¼‰æˆ–`v_prediction`ï¼ˆå‚è§[Imagen Video](https://imagen.research.google/video/paper.pdf)è®ºæ–‡çš„ç¬¬ 2.4 èŠ‚ï¼‰ã€‚

+   `thresholding`ï¼ˆ`bool`ï¼Œé»˜è®¤ä¸º`False`ï¼‰â€” æ˜¯å¦ä½¿ç”¨â€œåŠ¨æ€é˜ˆå€¼â€æ–¹æ³•ã€‚è¿™å¯¹äºç¨³å®šæ‰©æ•£ç­‰æ½œåœ¨ç©ºé—´æ‰©æ•£æ¨¡å‹ä¸é€‚ç”¨ã€‚

+   `dynamic_thresholding_ratio`ï¼ˆ`float`ï¼Œé»˜è®¤ä¸º 0.995ï¼‰â€” åŠ¨æ€é˜ˆå€¼æ–¹æ³•çš„æ¯”ç‡ã€‚ä»…åœ¨`thresholding=True`æ—¶æœ‰æ•ˆã€‚

+   `sample_max_value`ï¼ˆ`float`ï¼Œé»˜è®¤ä¸º 1.0ï¼‰â€” åŠ¨æ€é˜ˆå€¼çš„é˜ˆå€¼å€¼ã€‚ä»…åœ¨`thresholding=True`æ—¶æœ‰æ•ˆã€‚

+   `timestep_spacing`ï¼ˆ`str`ï¼Œé»˜è®¤ä¸º`"leading"`ï¼‰â€” æ—¶é—´æ­¥åº”è¯¥å¦‚ä½•ç¼©æ”¾ã€‚æœ‰å…³æ›´å¤šä¿¡æ¯ï¼Œè¯·å‚é˜…[Common Diffusion Noise Schedules and Sample Steps are Flawed](https://huggingface.co/papers/2305.08891)çš„è¡¨ 2ã€‚

+   `rescale_betas_zero_snr`ï¼ˆ`bool`ï¼Œé»˜è®¤ä¸º`False`ï¼‰â€” æ˜¯å¦é‡æ–°ç¼©æ”¾ beta ä»¥ä½¿ç»ˆç«¯ SNR ä¸ºé›¶ã€‚è¿™ä½¿æ¨¡å‹èƒ½å¤Ÿç”Ÿæˆéå¸¸æ˜äº®å’Œæš—çš„æ ·æœ¬ï¼Œè€Œä¸æ˜¯å°†å…¶é™åˆ¶ä¸ºå…·æœ‰ä¸­ç­‰äº®åº¦çš„æ ·æœ¬ã€‚ä¸[`--offset_noise`](https://github.com/huggingface/diffusers/blob/74fd735eb073eb1d774b1ab4154a0876eb82f055/examples/dreambooth/train_dreambooth.py#L506) loosely ç›¸å…³ã€‚

`DDIMScheduler`æ‰©å±•äº†å¼•å…¥éé©¬å°”å¯å¤«å¼•å¯¼çš„å»å™ªæ‰©æ•£æ¦‚ç‡æ¨¡å‹ï¼ˆDDPMsï¼‰çš„è¿‡ç¨‹ã€‚

è¯¥æ¨¡å‹ç»§æ‰¿è‡ª SchedulerMixin å’Œ ConfigMixinã€‚æ£€æŸ¥è¶…ç±»æ–‡æ¡£ï¼Œäº†è§£åº“ä¸ºæ‰€æœ‰è°ƒåº¦ç¨‹åºå®ç°çš„é€šç”¨æ–¹æ³•ï¼Œå¦‚åŠ è½½å’Œä¿å­˜ã€‚

#### `scale_model_input`

[<æ¥æº>](https://github.com/huggingface/diffusers/blob/v0.26.3/src/diffusers/schedulers/scheduling_ddim.py#L238)

```py
( sample: FloatTensor timestep: Optional = None ) â†’ export const metadata = 'undefined';torch.FloatTensor
```

å‚æ•°

+   `sample`ï¼ˆ`torch.FloatTensor`ï¼‰â€” è¾“å…¥æ ·æœ¬ã€‚

+   `timestep`ï¼ˆ`int`ï¼Œ*å¯é€‰*ï¼‰â€” æ‰©æ•£é“¾ä¸­çš„å½“å‰æ—¶é—´æ­¥ã€‚

è¿”å›

`torch.FloatTensor`

ä¸€ä¸ªç»è¿‡ç¼©æ”¾çš„è¾“å…¥æ ·æœ¬ã€‚

ç¡®ä¿ä¸éœ€è¦æ ¹æ®å½“å‰æ—¶é—´æ­¥é•¿ç¼©æ”¾å»å™ªæ¨¡å‹è¾“å…¥çš„è°ƒåº¦ç¨‹åºå¯ä»¥äº’æ¢ã€‚

#### `set_timesteps`

[<æ¥æº>](https://github.com/huggingface/diffusers/blob/v0.26.3/src/diffusers/schedulers/scheduling_ddim.py#L299)

```py
( num_inference_steps: int device: Union = None )
```

å‚æ•°

+   `num_inference_steps`ï¼ˆ`int`ï¼‰â€” ä½¿ç”¨é¢„è®­ç»ƒæ¨¡å‹ç”Ÿæˆæ ·æœ¬æ—¶ä½¿ç”¨çš„æ‰©æ•£æ­¥æ•°ã€‚

è®¾ç½®ç”¨äºæ‰©æ•£é“¾çš„ç¦»æ•£æ—¶é—´æ­¥ï¼ˆåœ¨æ¨æ–­ä¹‹å‰è¿è¡Œï¼‰ã€‚

#### `æ­¥éª¤`

[<æ¥æº>](https://github.com/huggingface/diffusers/blob/v0.26.3/src/diffusers/schedulers/scheduling_ddim.py#L344)

```py
( model_output: FloatTensor timestep: int sample: FloatTensor eta: float = 0.0 use_clipped_model_output: bool = False generator = None variance_noise: Optional = None return_dict: bool = True ) â†’ export const metadata = 'undefined';~schedulers.scheduling_utils.DDIMSchedulerOutput or tuple
```

å‚æ•°

+   `model_output`ï¼ˆ`torch.FloatTensor`ï¼‰â€” ä»å­¦ä¹ çš„æ‰©æ•£æ¨¡å‹ç›´æ¥è¾“å‡ºã€‚

+   `timestep`ï¼ˆ`float`ï¼‰â€” æ‰©æ•£é“¾ä¸­çš„å½“å‰ç¦»æ•£æ—¶é—´æ­¥ã€‚

+   `sample`ï¼ˆ`torch.FloatTensor`ï¼‰â€” æ‰©æ•£è¿‡ç¨‹ä¸­åˆ›å»ºçš„æ ·æœ¬çš„å½“å‰å®ä¾‹ã€‚

+   `eta`ï¼ˆ`float`ï¼‰â€” æ‰©æ•£æ­¥éª¤ä¸­æ·»åŠ å™ªå£°çš„å™ªå£°æƒé‡ã€‚

+   `use_clipped_model_output`ï¼ˆ`bool`ï¼Œé»˜è®¤ä¸º`False`ï¼‰â€” å¦‚æœä¸º`True`ï¼Œåˆ™ä»å‰ªåˆ‡é¢„æµ‹çš„åŸå§‹æ ·æœ¬è®¡ç®—â€œæ ¡æ­£â€çš„`model_output`ã€‚å½“`self.config.clip_sample`ä¸º`True`æ—¶ï¼Œå¿…è¦ï¼Œå› ä¸ºé¢„æµ‹çš„åŸå§‹æ ·æœ¬è¢«å‰ªåˆ‡ä¸º[-1, 1]ã€‚å¦‚æœæ²¡æœ‰å‘ç”Ÿå‰ªåˆ‡ï¼Œâ€œæ ¡æ­£â€çš„`model_output`å°†ä¸æä¾›çš„è¾“å…¥ä¸€è‡´ï¼Œ`use_clipped_model_output`ä¸èµ·ä½œç”¨ã€‚

+   `generator`ï¼ˆ`torch.Generator`ï¼Œ*å¯é€‰*ï¼‰â€” éšæœºæ•°ç”Ÿæˆå™¨ã€‚

+   `variance_noise`ï¼ˆ`torch.FloatTensor`ï¼‰â€” é€šè¿‡ç›´æ¥æä¾›æ–¹å·®æœ¬èº«çš„å™ªå£°æ¥æ›¿ä»£ä½¿ç”¨`generator`ç”Ÿæˆå™ªå£°ã€‚å¯¹äº`CycleDiffusion`ç­‰æ–¹æ³•éå¸¸æœ‰ç”¨ã€‚

+   `return_dict` (`bool`ï¼Œ*å¯é€‰*ï¼Œé»˜è®¤ä¸º`True`) â€” æ˜¯å¦è¿”å› DDIMSchedulerOutput æˆ–`tuple`ã€‚

è¿”å›å€¼

`~schedulers.scheduling_utils.DDIMSchedulerOutput`æˆ–`tuple`

å¦‚æœ`return_dict`ä¸º`True`ï¼Œåˆ™è¿”å› DDIMSchedulerOutputï¼Œå¦åˆ™è¿”å›ä¸€ä¸ªå…ƒç»„ï¼Œå…¶ä¸­ç¬¬ä¸€ä¸ªå…ƒç´ æ˜¯æ ·æœ¬å¼ é‡ã€‚

é€šè¿‡åè½¬ SDE æ¥é¢„æµ‹ä¸Šä¸€ä¸ªæ—¶é—´æ­¥çš„æ ·æœ¬ã€‚æ­¤å‡½æ•°ä»å­¦ä¹ æ¨¡å‹è¾“å‡ºï¼ˆé€šå¸¸æ˜¯é¢„æµ‹çš„å™ªå£°ï¼‰ä¸­ä¼ æ’­æ‰©æ•£è¿‡ç¨‹ã€‚

## DDIMSchedulerOutput

### `class diffusers.schedulers.scheduling_ddim.DDIMSchedulerOutput`

[<æ¥æº>](https://github.com/huggingface/diffusers/blob/v0.26.3/src/diffusers/schedulers/scheduling_ddim.py#L31)

```py
( prev_sample: FloatTensor pred_original_sample: Optional = None )
```

å‚æ•°

+   `prev_sample`ï¼ˆå¯¹äºå›¾åƒå½¢çŠ¶ä¸º`(batch_size, num_channels, height, width)`çš„`torch.FloatTensor`ï¼‰ â€” ä¸Šä¸€ä¸ªæ—¶é—´æ­¥çš„è®¡ç®—æ ·æœ¬`(x_{t-1})`ã€‚`prev_sample`åº”è¯¥åœ¨å»å™ªå¾ªç¯ä¸­ä½œä¸ºä¸‹ä¸€ä¸ªæ¨¡å‹è¾“å…¥ä½¿ç”¨ã€‚

+   `pred_original_sample`ï¼ˆå¯¹äºå›¾åƒå½¢çŠ¶ä¸º`(batch_size, num_channels, height, width)`çš„`torch.FloatTensor`ï¼‰ â€” åŸºäºå½“å‰æ—¶é—´æ­¥çš„æ¨¡å‹è¾“å‡ºé¢„æµ‹çš„å»å™ªæ ·æœ¬`(x_{0})`ã€‚`pred_original_sample`å¯ç”¨äºé¢„è§ˆè¿›å±•æˆ–æŒ‡å¯¼ã€‚

è°ƒåº¦ç¨‹åºçš„`step`å‡½æ•°è¾“å‡ºçš„è¾“å‡ºç±»ã€‚
