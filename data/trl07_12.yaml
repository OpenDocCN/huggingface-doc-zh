- en: Reward Modeling
  id: totrans-0
  prefs:
  - PREF_H1
  type: TYPE_NORMAL
  zh: å¥–åŠ±å»ºæ¨¡
- en: 'Original text: [https://huggingface.co/docs/trl/reward_trainer](https://huggingface.co/docs/trl/reward_trainer)'
  id: totrans-1
  prefs:
  - PREF_BQ
  type: TYPE_NORMAL
  zh: åŸå§‹æ–‡æœ¬ï¼š[https://huggingface.co/docs/trl/reward_trainer](https://huggingface.co/docs/trl/reward_trainer)
- en: null
  id: totrans-2
  prefs: []
  type: TYPE_NORMAL
- en: TRL supports custom reward modeling for anyone to perform reward modeling on
    their dataset and model.
  id: totrans-3
  prefs: []
  type: TYPE_NORMAL
  zh: TRLæ”¯æŒä»»ä½•äººå¯¹å…¶æ•°æ®é›†å’Œæ¨¡å‹æ‰§è¡Œè‡ªå®šä¹‰å¥–åŠ±å»ºæ¨¡ã€‚
- en: Check out a complete flexible example at [`examples/scripts/reward_modeling.py`](https://github.com/huggingface/trl/tree/main/examples/scripts/reward_modeling.py).
  id: totrans-4
  prefs: []
  type: TYPE_NORMAL
  zh: åœ¨[`examples/scripts/reward_modeling.py`](https://github.com/huggingface/trl/tree/main/examples/scripts/reward_modeling.py)ä¸­æŸ¥çœ‹ä¸€ä¸ªå®Œæ•´çµæ´»çš„ç¤ºä¾‹ã€‚
- en: Expected dataset format
  id: totrans-5
  prefs:
  - PREF_H2
  type: TYPE_NORMAL
  zh: æœŸæœ›çš„æ•°æ®é›†æ ¼å¼
- en: 'The [RewardTrainer](/docs/trl/v0.7.10/en/reward_trainer#trl.RewardTrainer)
    expects a very specific format for the dataset since the model will be trained
    on pairs of examples to predict which of the two is preferred. We provide an example
    from the [`Anthropic/hh-rlhf`](https://huggingface.co/datasets/Anthropic/hh-rlhf)
    dataset below:'
  id: totrans-6
  prefs: []
  type: TYPE_NORMAL
  zh: '[RewardTrainer](/docs/trl/v0.7.10/en/reward_trainer#trl.RewardTrainer)æœŸæœ›æ•°æ®é›†å…·æœ‰éå¸¸ç‰¹å®šçš„æ ¼å¼ï¼Œå› ä¸ºæ¨¡å‹å°†åœ¨ç¤ºä¾‹å¯¹ä¸Šè¿›è¡Œè®­ç»ƒï¼Œä»¥é¢„æµ‹å“ªä¸ªæ›´å—åçˆ±ã€‚æˆ‘ä»¬åœ¨ä¸‹é¢æä¾›äº†ä¸€ä¸ªæ¥è‡ª[`Anthropic/hh-rlhf`](https://huggingface.co/datasets/Anthropic/hh-rlhf)æ•°æ®é›†çš„ç¤ºä¾‹ï¼š'
- en: '![](../Images/108b7079a2ffc651b11289080d0cdc7d.png)'
  id: totrans-7
  prefs: []
  type: TYPE_IMG
  zh: '![](../Images/108b7079a2ffc651b11289080d0cdc7d.png)'
- en: 'Therefore the final dataset object should contain two 4 entries at least if
    you use the default `RewardDataCollatorWithPadding` data collator. The entries
    should be named:'
  id: totrans-8
  prefs: []
  type: TYPE_NORMAL
  zh: å› æ­¤ï¼Œå¦‚æœæ‚¨ä½¿ç”¨é»˜è®¤çš„`RewardDataCollatorWithPadding`æ•°æ®æ•´ç†å™¨ï¼Œåˆ™æœ€ç»ˆæ•°æ®é›†å¯¹è±¡åº”è¯¥è‡³å°‘åŒ…å«ä¸¤ä¸ª4ä¸ªæ¡ç›®ã€‚è¿™äº›æ¡ç›®åº”è¯¥å‘½åä¸ºï¼š
- en: '`input_ids_chosen`'
  id: totrans-9
  prefs:
  - PREF_UL
  type: TYPE_NORMAL
  zh: '`input_ids_chosen`'
- en: '`attention_mask_chosen`'
  id: totrans-10
  prefs:
  - PREF_UL
  type: TYPE_NORMAL
  zh: '`attention_mask_chosen`'
- en: '`input_ids_rejected`'
  id: totrans-11
  prefs:
  - PREF_UL
  type: TYPE_NORMAL
  zh: '`input_ids_rejected`'
- en: '`attention_mask_rejected`'
  id: totrans-12
  prefs:
  - PREF_UL
  type: TYPE_NORMAL
  zh: '`attention_mask_rejected`'
- en: Using the RewardTrainer
  id: totrans-13
  prefs:
  - PREF_H2
  type: TYPE_NORMAL
  zh: ä½¿ç”¨RewardTrainer
- en: After preparing your dataset, you can use the [RewardTrainer](/docs/trl/v0.7.10/en/reward_trainer#trl.RewardTrainer)
    in the same way as the `Trainer` class from ğŸ¤— Transformers. You should pass an
    `AutoModelForSequenceClassification` model to the [RewardTrainer](/docs/trl/v0.7.10/en/reward_trainer#trl.RewardTrainer),
    along with a [RewardConfig](/docs/trl/v0.7.10/en/reward_trainer#trl.RewardConfig)
    which configures the hyperparameters of the training.
  id: totrans-14
  prefs: []
  type: TYPE_NORMAL
  zh: å‡†å¤‡å¥½æ•°æ®é›†åï¼Œæ‚¨å¯ä»¥åƒä½¿ç”¨ğŸ¤— Transformersä¸­çš„`Trainer`ç±»ä¸€æ ·ä½¿ç”¨[RewardTrainer](/docs/trl/v0.7.10/en/reward_trainer#trl.RewardTrainer)ã€‚æ‚¨åº”è¯¥å°†ä¸€ä¸ª`AutoModelForSequenceClassification`æ¨¡å‹ä¼ é€’ç»™[RewardTrainer](/docs/trl/v0.7.10/en/reward_trainer#trl.RewardTrainer)ï¼Œä»¥åŠä¸€ä¸ª[RewardConfig](/docs/trl/v0.7.10/en/reward_trainer#trl.RewardConfig)æ¥é…ç½®è®­ç»ƒçš„è¶…å‚æ•°ã€‚
- en: Leveraging ğŸ¤— PEFT to train a reward model
  id: totrans-15
  prefs:
  - PREF_H3
  type: TYPE_NORMAL
  zh: åˆ©ç”¨ğŸ¤— PEFTæ¥è®­ç»ƒå¥–åŠ±æ¨¡å‹
- en: Just pass a `peft_config` in the keyword arguments of [RewardTrainer](/docs/trl/v0.7.10/en/reward_trainer#trl.RewardTrainer),
    and the trainer should automatically take care of converting the model into a
    PEFT model!
  id: totrans-16
  prefs: []
  type: TYPE_NORMAL
  zh: åªéœ€åœ¨[RewardTrainer](/docs/trl/v0.7.10/en/reward_trainer#trl.RewardTrainer)çš„å…³é”®å­—å‚æ•°ä¸­ä¼ é€’ä¸€ä¸ª`peft_config`ï¼Œè®­ç»ƒå™¨åº”è¯¥ä¼šè‡ªåŠ¨å°†æ¨¡å‹è½¬æ¢ä¸ºPEFTæ¨¡å‹ï¼
- en: '[PRE0]'
  id: totrans-17
  prefs: []
  type: TYPE_PRE
  zh: '[PRE0]'
- en: Adding a margin to the loss
  id: totrans-18
  prefs:
  - PREF_H3
  type: TYPE_NORMAL
  zh: å‘æŸå¤±æ·»åŠ è¾¹é™…
- en: As in the [Llama 2 paper](https://huggingface.co/papers/2307.09288), you can
    add a margin to the loss by adding a `margin` column to the dataset. The reward
    collator will automatically pass it through and the loss will be computed accordingly.
  id: totrans-19
  prefs: []
  type: TYPE_NORMAL
  zh: å¦‚[Llama 2 è®ºæ–‡](https://huggingface.co/papers/2307.09288)ä¸­æ‰€è¿°ï¼Œæ‚¨å¯ä»¥é€šè¿‡å‘æ•°æ®é›†æ·»åŠ ä¸€ä¸ª`margin`åˆ—æ¥å‘æŸå¤±æ·»åŠ è¾¹é™…ã€‚å¥–åŠ±æ•´ç†å™¨å°†è‡ªåŠ¨ä¼ é€’å®ƒï¼Œå¹¶ç›¸åº”åœ°è®¡ç®—æŸå¤±ã€‚
- en: '[PRE1]'
  id: totrans-20
  prefs: []
  type: TYPE_PRE
  zh: '[PRE1]'
- en: RewardConfig
  id: totrans-21
  prefs:
  - PREF_H2
  type: TYPE_NORMAL
  zh: RewardConfig
- en: '### `class trl.RewardConfig`'
  id: totrans-22
  prefs: []
  type: TYPE_NORMAL
  zh: '### `class trl.RewardConfig`'
- en: '[< source >](https://github.com/huggingface/trl/blob/v0.7.10/trl/trainer/reward_config.py#L21)'
  id: totrans-23
  prefs: []
  type: TYPE_NORMAL
  zh: '[< source >](https://github.com/huggingface/trl/blob/v0.7.10/trl/trainer/reward_config.py#L21)'
- en: '[PRE2]'
  id: totrans-24
  prefs: []
  type: TYPE_PRE
  zh: '[PRE2]'
- en: Parameters
  id: totrans-25
  prefs: []
  type: TYPE_NORMAL
  zh: å‚æ•°
- en: '`max_length` (`int`, *optional*, defaults to `None`) â€” The maximum length of
    the sequences in the batch. This argument is required if you want to use the default
    data collator.'
  id: totrans-26
  prefs:
  - PREF_UL
  type: TYPE_NORMAL
  zh: '`max_length` (`int`, *å¯é€‰*, é»˜è®¤ä¸º`None`) â€” æ‰¹æ¬¡ä¸­åºåˆ—çš„æœ€å¤§é•¿åº¦ã€‚å¦‚æœè¦ä½¿ç”¨é»˜è®¤æ•°æ®æ•´ç†å™¨ï¼Œåˆ™éœ€è¦æ­¤å‚æ•°ã€‚'
- en: '`gradient_checkpointing` (`bool`, *optional*, defaults to `True`) â€” If True,
    use gradient checkpointing to save memory at the expense of slower backward pass.'
  id: totrans-27
  prefs:
  - PREF_UL
  type: TYPE_NORMAL
  zh: '`gradient_checkpointing` (`bool`, *å¯é€‰*, é»˜è®¤ä¸º`True`) â€” å¦‚æœä¸ºTrueï¼Œåˆ™ä½¿ç”¨æ¢¯åº¦æ£€æŸ¥ç‚¹æ¥èŠ‚çœå†…å­˜ï¼Œä½†ä¼šå‡æ…¢å‘åä¼ é€’çš„é€Ÿåº¦ã€‚'
- en: RewardConfig collects all training arguments related to the [RewardTrainer](/docs/trl/v0.7.10/en/reward_trainer#trl.RewardTrainer)
    class.
  id: totrans-28
  prefs: []
  type: TYPE_NORMAL
  zh: RewardConfigæ”¶é›†ä¸[RewardTrainer](/docs/trl/v0.7.10/en/reward_trainer#trl.RewardTrainer)ç±»ç›¸å…³çš„æ‰€æœ‰è®­ç»ƒå‚æ•°ã€‚
- en: Using `HfArgumentParser` we can turn this class into [argparse](https://docs.python.org/3/library/argparse#module-argparse)
    arguments that can be specified on the command line.
  id: totrans-29
  prefs: []
  type: TYPE_NORMAL
  zh: ä½¿ç”¨`HfArgumentParser`ï¼Œæˆ‘ä»¬å¯ä»¥å°†è¿™ä¸ªç±»è½¬æ¢ä¸ºå¯ä»¥åœ¨å‘½ä»¤è¡Œä¸ŠæŒ‡å®šçš„[argparse](https://docs.python.org/3/library/argparse#module-argparse)å‚æ•°ã€‚
- en: RewardTrainer
  id: totrans-30
  prefs:
  - PREF_H2
  type: TYPE_NORMAL
  zh: RewardTrainer
- en: '### `class trl.RewardTrainer`'
  id: totrans-31
  prefs: []
  type: TYPE_NORMAL
  zh: '### `class trl.RewardTrainer`'
- en: '[< source >](https://github.com/huggingface/trl/blob/v0.7.10/trl/trainer/reward_trainer.py#L36)'
  id: totrans-32
  prefs: []
  type: TYPE_NORMAL
  zh: '[< source >](https://github.com/huggingface/trl/blob/v0.7.10/trl/trainer/reward_trainer.py#L36)'
- en: '[PRE3]'
  id: totrans-33
  prefs: []
  type: TYPE_PRE
  zh: '[PRE3]'
- en: The RewardTrainer can be used to train your custom Reward Model. It is a subclass
    of the `transformers.Trainer` class and inherits all of its attributes and methods.
    It is recommended to use an `AutoModelForSequenceClassification` as the reward
    model. The reward model should be trained on a dataset of paired examples, where
    each example is a tuple of two sequences. The reward model should be trained to
    predict which example in the pair is more relevant to the task at hand.
  id: totrans-34
  prefs: []
  type: TYPE_NORMAL
  zh: RewardTrainerå¯ç”¨äºè®­ç»ƒæ‚¨çš„è‡ªå®šä¹‰å¥–åŠ±æ¨¡å‹ã€‚å®ƒæ˜¯`transformers.Trainer`ç±»çš„å­ç±»ï¼Œç»§æ‰¿äº†æ‰€æœ‰å±æ€§å’Œæ–¹æ³•ã€‚å»ºè®®ä½¿ç”¨`AutoModelForSequenceClassification`ä½œä¸ºå¥–åŠ±æ¨¡å‹ã€‚å¥–åŠ±æ¨¡å‹åº”è¯¥åœ¨æˆå¯¹ç¤ºä¾‹çš„æ•°æ®é›†ä¸Šè¿›è¡Œè®­ç»ƒï¼Œå…¶ä¸­æ¯ä¸ªç¤ºä¾‹éƒ½æ˜¯ä¸¤ä¸ªåºåˆ—çš„å…ƒç»„ã€‚å¥–åŠ±æ¨¡å‹åº”è¯¥è¢«è®­ç»ƒä»¥é¢„æµ‹å“ªä¸ªç¤ºä¾‹å¯¹äºå½“å‰ä»»åŠ¡æ›´ç›¸å…³ã€‚
- en: The reward trainer expects a very specific format for the dataset. The dataset
    should contain two 4 entries at least if you donâ€™t use the default `RewardDataCollatorWithPadding`
    data collator. The entries should be named
  id: totrans-35
  prefs: []
  type: TYPE_NORMAL
  zh: å¥–åŠ±è®­ç»ƒå™¨æœŸæœ›æ•°æ®é›†å…·æœ‰éå¸¸ç‰¹å®šçš„æ ¼å¼ã€‚å¦‚æœä¸ä½¿ç”¨é»˜è®¤çš„`RewardDataCollatorWithPadding`æ•°æ®æ•´ç†å™¨ï¼Œåˆ™æ•°æ®é›†åº”è¯¥è‡³å°‘åŒ…å«ä¸¤ä¸ª4ä¸ªæ¡ç›®ã€‚è¿™äº›æ¡ç›®åº”è¯¥å‘½åä¸º
- en: '`input_ids_chosen`'
  id: totrans-36
  prefs:
  - PREF_UL
  type: TYPE_NORMAL
  zh: '`input_ids_chosen`'
- en: '`attention_mask_chosen`'
  id: totrans-37
  prefs:
  - PREF_UL
  type: TYPE_NORMAL
  zh: '`attention_mask_chosen`'
- en: '`input_ids_rejected`'
  id: totrans-38
  prefs:
  - PREF_UL
  type: TYPE_NORMAL
  zh: '`input_ids_rejected`'
- en: '`attention_mask_rejected`'
  id: totrans-39
  prefs:
  - PREF_UL
  type: TYPE_NORMAL
  zh: '`attention_mask_rejected`'
- en: Optionally, you can also pass a `margin` entry to the dataset. This entry should
    contain the margin used to modulate the loss of the reward model as outlined in
    [https://ai.meta.com/research/publications/llama-2-open-foundation-and-fine-tuned-chat-models/](https://ai.meta.com/research/publications/llama-2-open-foundation-and-fine-tuned-chat-models/).
    If you donâ€™t pass a margin, no margin will be used.
  id: totrans-40
  prefs: []
  type: TYPE_NORMAL
  zh: æ‚¨è¿˜å¯ä»¥å‘æ•°æ®é›†ä¼ é€’ä¸€ä¸ª`margin`æ¡ç›®ã€‚è¯¥æ¡ç›®åº”åŒ…å«ç”¨äºè°ƒèŠ‚å¥–åŠ±æ¨¡å‹æŸå¤±çš„è¾¹è·ï¼Œå¦‚[https://ai.meta.com/research/publications/llama-2-open-foundation-and-fine-tuned-chat-models/](https://ai.meta.com/research/publications/llama-2-open-foundation-and-fine-tuned-chat-models/)ä¸­æ‰€è¿°ã€‚å¦‚æœæ‚¨ä¸ä¼ é€’è¾¹è·ï¼Œåˆ™ä¸ä¼šä½¿ç”¨è¾¹è·ã€‚
