- en: Deferring Executions
  id: totrans-0
  prefs:
  - PREF_H1
  type: TYPE_NORMAL
  zh: æ¨è¿Ÿæ‰§è¡Œ
- en: 'Original text: [https://huggingface.co/docs/accelerate/concept_guides/deferring_execution](https://huggingface.co/docs/accelerate/concept_guides/deferring_execution)'
  id: totrans-1
  prefs:
  - PREF_BQ
  type: TYPE_NORMAL
  zh: åŸå§‹æ–‡æœ¬ï¼š[https://huggingface.co/docs/accelerate/concept_guides/deferring_execution](https://huggingface.co/docs/accelerate/concept_guides/deferring_execution)
- en: null
  id: totrans-2
  prefs: []
  type: TYPE_NORMAL
- en: 'When you run your usual script, instructions are executed in order. Using ğŸ¤—
    Accelerate to deploy your script on several GPUs at the same time introduces a
    complication: while each process executes all instructions in order, some may
    be faster than others.'
  id: totrans-3
  prefs: []
  type: TYPE_NORMAL
  zh: å½“è¿è¡Œæ‚¨çš„å¸¸è§„è„šæœ¬æ—¶ï¼ŒæŒ‡ä»¤æŒ‰é¡ºåºæ‰§è¡Œã€‚ä½¿ç”¨ğŸ¤— Accelerateåœ¨å¤šä¸ªGPUä¸ŠåŒæ—¶éƒ¨ç½²è„šæœ¬ä¼šå¼•å…¥ä¸€ä¸ªå¤æ‚æ€§ï¼šè™½ç„¶æ¯ä¸ªè¿›ç¨‹æŒ‰é¡ºåºæ‰§è¡Œæ‰€æœ‰æŒ‡ä»¤ï¼Œä½†æœ‰äº›å¯èƒ½æ¯”å…¶ä»–è¿›ç¨‹å¿«ã€‚
- en: 'You might need to wait for all processes to have reached a certain point before
    executing a given instruction. For instance, you shouldnâ€™t save a model before
    being sure every process is done with training, and you wouldnâ€™t want to continue
    training before all the model weights have been loaded in. To do this, just write
    the following line in your code:'
  id: totrans-4
  prefs: []
  type: TYPE_NORMAL
  zh: æ‚¨å¯èƒ½éœ€è¦ç­‰å¾…æ‰€æœ‰è¿›ç¨‹è¾¾åˆ°æŸä¸€ç‚¹åæ‰æ‰§è¡Œç»™å®šæŒ‡ä»¤ã€‚ä¾‹å¦‚ï¼Œåœ¨ç¡®ä¿æ¯ä¸ªè¿›ç¨‹éƒ½å®Œæˆè®­ç»ƒä¹‹å‰ï¼Œä¸åº”è¯¥ä¿å­˜æ¨¡å‹ï¼Œå¹¶ä¸”åœ¨åŠ è½½æ‰€æœ‰æ¨¡å‹æƒé‡ä¹‹å‰ä¸åº”è¯¥ç»§ç»­è®­ç»ƒã€‚è¦åšåˆ°è¿™ä¸€ç‚¹ï¼Œåªéœ€åœ¨æ‚¨çš„ä»£ç ä¸­ç¼–å†™ä»¥ä¸‹è¡Œï¼š
- en: '[PRE0]'
  id: totrans-5
  prefs: []
  type: TYPE_PRE
  zh: '[PRE0]'
- en: This instruction will block all the processes that arrive first until all the
    other processes have reached that point (if you run your script on just one GPU
    or CPU, this wonâ€™t do anything).
  id: totrans-6
  prefs: []
  type: TYPE_NORMAL
  zh: æ­¤æŒ‡ä»¤å°†é˜»æ­¢æ‰€æœ‰æœ€å…ˆåˆ°è¾¾çš„è¿›ç¨‹ï¼Œç›´åˆ°æ‰€æœ‰å…¶ä»–è¿›ç¨‹éƒ½è¾¾åˆ°è¯¥ç‚¹ï¼ˆå¦‚æœæ‚¨åªåœ¨ä¸€ä¸ªGPUæˆ–CPUä¸Šè¿è¡Œè„šæœ¬ï¼Œåˆ™ä¸ä¼šæ‰§è¡Œä»»ä½•æ“ä½œï¼‰ã€‚
- en: 'A few example cases of when to use this utility are listed below:'
  id: totrans-7
  prefs: []
  type: TYPE_NORMAL
  zh: ä»¥ä¸‹åˆ—å‡ºäº†ä½¿ç”¨æ­¤å®ç”¨ç¨‹åºçš„å‡ ä¸ªç¤ºä¾‹æƒ…å†µï¼š
- en: Some of these are utilized with the [main_process_first()](/docs/accelerate/v0.27.2/en/package_reference/accelerator#accelerate.Accelerator.main_process_first)
    context manager, which utilizes [wait_for_everyone()](/docs/accelerate/v0.27.2/en/package_reference/accelerator#accelerate.Accelerator.wait_for_everyone)
    to run a particular set of code on the main process beforehand before triggering
    and launching the other processes
  id: totrans-8
  prefs: []
  type: TYPE_NORMAL
  zh: å…¶ä¸­ä¸€äº›ä¸[main_process_first()](/docs/accelerate/v0.27.2/en/package_reference/accelerator#accelerate.Accelerator.main_process_first)ä¸Šä¸‹æ–‡ç®¡ç†å™¨ä¸€èµ·ä½¿ç”¨ï¼Œè¯¥ç®¡ç†å™¨åˆ©ç”¨[wait_for_everyone()](/docs/accelerate/v0.27.2/en/package_reference/accelerator#accelerate.Accelerator.wait_for_everyone)åœ¨è§¦å‘å’Œå¯åŠ¨å…¶ä»–è¿›ç¨‹ä¹‹å‰åœ¨ä¸»è¿›ç¨‹ä¸Šè¿è¡Œä¸€ç»„ç‰¹å®šä»£ç 
- en: Downloading a Dataset
  id: totrans-9
  prefs:
  - PREF_H2
  type: TYPE_NORMAL
  zh: ä¸‹è½½æ•°æ®é›†
- en: When downloading a dataset, you should download it first on the main process
    and then load the cached dataset afterward
  id: totrans-10
  prefs: []
  type: TYPE_NORMAL
  zh: åœ¨ä¸‹è½½æ•°æ®é›†æ—¶ï¼Œåº”é¦–å…ˆåœ¨ä¸»è¿›ç¨‹ä¸Šä¸‹è½½æ•°æ®é›†ï¼Œç„¶ååŠ è½½ç¼“å­˜çš„æ•°æ®é›†
- en: '`load_dataset` will perform a lock under the hood to stop multiple downloads
    from happening at once, but if you are downloading something not using this library
    you should use this method.'
  id: totrans-11
  prefs: []
  type: TYPE_NORMAL
  zh: '`load_dataset`å°†åœ¨å†…éƒ¨æ‰§è¡Œé”å®šï¼Œä»¥é˜»æ­¢åŒæ—¶å‘ç”Ÿå¤šæ¬¡ä¸‹è½½ï¼Œä½†å¦‚æœæ‚¨ä¸‹è½½çš„å†…å®¹ä¸ä½¿ç”¨æ­¤åº“ï¼Œåˆ™åº”ä½¿ç”¨æ­¤æ–¹æ³•ã€‚'
- en: '[PRE1]'
  id: totrans-12
  prefs: []
  type: TYPE_PRE
  zh: '[PRE1]'
- en: 'Under the hood this is the same as calling:'
  id: totrans-13
  prefs: []
  type: TYPE_NORMAL
  zh: åœ¨å¹•åï¼Œè¿™ä¸è°ƒç”¨ç›¸åŒï¼š
- en: '[PRE2]'
  id: totrans-14
  prefs: []
  type: TYPE_PRE
  zh: '[PRE2]'
- en: Saving the state_dict
  id: totrans-15
  prefs:
  - PREF_H2
  type: TYPE_NORMAL
  zh: ä¿å­˜state_dict
- en: 'When saving the `state_dict` of the model, since you would normally save one
    file on just the main process you should specify that:'
  id: totrans-16
  prefs: []
  type: TYPE_NORMAL
  zh: ä¿å­˜æ¨¡å‹çš„`state_dict`æ—¶ï¼Œç”±äºé€šå¸¸åªåœ¨ä¸»è¿›ç¨‹ä¸Šä¿å­˜ä¸€ä¸ªæ–‡ä»¶ï¼Œå› æ­¤åº”æŒ‡å®šï¼š
- en: '[PRE3]'
  id: totrans-17
  prefs: []
  type: TYPE_PRE
  zh: '[PRE3]'
- en: Loading in the state_dict
  id: totrans-18
  prefs:
  - PREF_H2
  type: TYPE_NORMAL
  zh: åŠ è½½state_dict
- en: When loading in the `state_dict` to a model, optimizer, or scheduler, you should
    wait for all workers to have the weights loaded in before moving on to training
  id: totrans-19
  prefs: []
  type: TYPE_NORMAL
  zh: åœ¨å°†`state_dict`åŠ è½½åˆ°æ¨¡å‹ã€ä¼˜åŒ–å™¨æˆ–è°ƒåº¦å™¨ä¸­æ—¶ï¼Œåº”ç­‰å¾…æ‰€æœ‰å·¥ä½œè¿›ç¨‹åŠ è½½æƒé‡åå†ç»§ç»­è®­ç»ƒ
- en: '[PRE4]'
  id: totrans-20
  prefs: []
  type: TYPE_PRE
  zh: '[PRE4]'
- en: Applying a multi-worker CPU operation
  id: totrans-21
  prefs:
  - PREF_H2
  type: TYPE_NORMAL
  zh: åº”ç”¨å¤šå·¥ä½œè¿›ç¨‹CPUæ“ä½œ
- en: Applying a `map()` operation on multiple workers, such as tokenizing should
    be done on the main process first, and then propagated to each one.
  id: totrans-22
  prefs: []
  type: TYPE_NORMAL
  zh: åœ¨å¤šä¸ªå·¥ä½œè¿›ç¨‹ä¸Šåº”ç”¨`map()`æ“ä½œï¼Œä¾‹å¦‚å¯¹ä»¤ç‰Œè¿›è¡Œæ ‡è®°åŒ–åº”è¯¥é¦–å…ˆåœ¨ä¸»è¿›ç¨‹ä¸Šæ‰§è¡Œï¼Œç„¶åä¼ æ’­åˆ°æ¯ä¸ªè¿›ç¨‹ã€‚
- en: '[PRE5]'
  id: totrans-23
  prefs: []
  type: TYPE_PRE
  zh: '[PRE5]'
- en: Applying checks such as Early Stopping
  id: totrans-24
  prefs:
  - PREF_H2
  type: TYPE_NORMAL
  zh: åº”ç”¨æ£€æŸ¥ï¼Œå¦‚æå‰åœæ­¢
- en: To have a check that works with a flag set by a particular process, the `set_trigger`
    and `check_trigger` API should be used. Useful examples for doing so can include
    situations such as using early stopping and monitoring the loss (as each loss
    slightly differs on each process).
  id: totrans-25
  prefs: []
  type: TYPE_NORMAL
  zh: è¦ä½¿ç”¨ç”±ç‰¹å®šè¿›ç¨‹è®¾ç½®çš„æ ‡å¿—è¿›è¡Œæ£€æŸ¥ï¼Œåº”ä½¿ç”¨`set_trigger`å’Œ`check_trigger`APIã€‚è¿™æ ·åšçš„æœ‰ç”¨ç¤ºä¾‹å¯ä»¥åŒ…æ‹¬ä½¿ç”¨æå‰åœæ­¢å¹¶ç›‘è§†æŸå¤±ï¼ˆå› ä¸ºæ¯ä¸ªè¿›ç¨‹ä¸Šçš„æŸå¤±ç•¥æœ‰ä¸åŒï¼‰ç­‰æƒ…å†µã€‚
- en: 'Call [Accelerator.set_trigger()](/docs/accelerate/v0.27.2/en/package_reference/accelerator#accelerate.Accelerator.set_trigger)
    when your condition has been met, and [Accelerator.check_trigger()](/docs/accelerate/v0.27.2/en/package_reference/accelerator#accelerate.Accelerator.check_trigger)
    when checking if that condition has been met in any process:'
  id: totrans-26
  prefs: []
  type: TYPE_NORMAL
  zh: å½“æ‚¨çš„æ¡ä»¶æ»¡è¶³æ—¶ï¼Œè¯·è°ƒç”¨[Accelerator.set_trigger()](/docs/accelerate/v0.27.2/en/package_reference/accelerator#accelerate.Accelerator.set_trigger)ï¼Œå¹¶åœ¨ä»»ä½•è¿›ç¨‹ä¸­æ£€æŸ¥è¯¥æ¡ä»¶æ˜¯å¦æ»¡è¶³æ—¶ä½¿ç”¨[Accelerator.check_trigger()](/docs/accelerate/v0.27.2/en/package_reference/accelerator#accelerate.Accelerator.check_trigger)ï¼š
- en: '[PRE6]'
  id: totrans-27
  prefs: []
  type: TYPE_PRE
  zh: '[PRE6]'
