- en: Speed up inference
  id: totrans-0
  prefs:
  - PREF_H1
  type: TYPE_NORMAL
  zh: åŠ é€Ÿæ¨ç†
- en: 'Original text: [https://huggingface.co/docs/diffusers/optimization/fp16](https://huggingface.co/docs/diffusers/optimization/fp16)'
  id: totrans-1
  prefs:
  - PREF_BQ
  type: TYPE_NORMAL
  zh: åŸå§‹æ–‡æœ¬ï¼š[https://huggingface.co/docs/diffusers/optimization/fp16](https://huggingface.co/docs/diffusers/optimization/fp16)
- en: null
  id: totrans-2
  prefs: []
  type: TYPE_NORMAL
- en: There are several ways to optimize ğŸ¤— Diffusers for inference speed. As a general
    rule of thumb, we recommend using either [xFormers](xformers) or `torch.nn.functional.scaled_dot_product_attention`
    in PyTorch 2.0 for their memory-efficient attention.
  id: totrans-3
  prefs: []
  type: TYPE_NORMAL
  zh: æœ‰å‡ ç§æ–¹æ³•å¯ä»¥ä¼˜åŒ–ğŸ¤— Diffusersä»¥æé«˜æ¨ç†é€Ÿåº¦ã€‚ä½œä¸ºä¸€ä¸ªç»éªŒæ³•åˆ™ï¼Œæˆ‘ä»¬å»ºè®®åœ¨PyTorch 2.0ä¸­ä½¿ç”¨[xFormers](xformers)æˆ–`torch.nn.functional.scaled_dot_product_attention`è¿›è¡Œå†…å­˜é«˜æ•ˆçš„æ³¨æ„åŠ›ã€‚
- en: In many cases, optimizing for speed or memory leads to improved performance
    in the other, so you should try to optimize for both whenever you can. This guide
    focuses on inference speed, but you can learn more about preserving memory in
    the [Reduce memory usage](memory) guide.
  id: totrans-4
  prefs: []
  type: TYPE_NORMAL
  zh: åœ¨è®¸å¤šæƒ…å†µä¸‹ï¼Œä¸ºäº†æé«˜é€Ÿåº¦æˆ–å†…å­˜è€Œè¿›è¡Œä¼˜åŒ–ä¼šå¯¼è‡´å¦ä¸€æ–¹é¢çš„æ€§èƒ½æå‡ï¼Œå› æ­¤æ‚¨åº”è¯¥å°½å¯èƒ½åœ¨ä¸¤è€…ä¸Šè¿›è¡Œä¼˜åŒ–ã€‚æœ¬æŒ‡å—ä¾§é‡äºæ¨ç†é€Ÿåº¦ï¼Œä½†æ‚¨å¯ä»¥åœ¨[å‡å°‘å†…å­˜ä½¿ç”¨](memory)æŒ‡å—ä¸­äº†è§£æ›´å¤šå…³äºä¿ç•™å†…å­˜çš„ä¿¡æ¯ã€‚
- en: The results below are obtained from generating a single 512x512 image from the
    prompt `a photo of an astronaut riding a horse on mars` with 50 DDIM steps on
    a Nvidia Titan RTX, demonstrating the speed-up you can expect.
  id: totrans-5
  prefs: []
  type: TYPE_NORMAL
  zh: ä¸‹é¢çš„ç»“æœæ˜¯åœ¨Nvidia Titan RTXä¸Šä½¿ç”¨50ä¸ªDDIMæ­¥éª¤ä»æç¤º`a photo of an astronaut riding a horse
    on mars`ç”Ÿæˆå•ä¸ª512x512å›¾åƒè·å¾—çš„ï¼Œå±•ç¤ºäº†æ‚¨å¯ä»¥æœŸæœ›çš„åŠ é€Ÿã€‚
- en: '|  | latency | speed-up |'
  id: totrans-6
  prefs: []
  type: TYPE_TB
  zh: '|  | å»¶è¿Ÿ | åŠ é€Ÿ |'
- en: '| --- | --- | --- |'
  id: totrans-7
  prefs: []
  type: TYPE_TB
  zh: '| --- | --- | --- |'
- en: '| original | 9.50s | x1 |'
  id: totrans-8
  prefs: []
  type: TYPE_TB
  zh: '| åŸå§‹ | 9.50ç§’ | x1 |'
- en: '| fp16 | 3.61s | x2.63 |'
  id: totrans-9
  prefs: []
  type: TYPE_TB
  zh: '| fp16 | 3.61ç§’ | x2.63 |'
- en: '| channels last | 3.30s | x2.88 |'
  id: totrans-10
  prefs: []
  type: TYPE_TB
  zh: '| é€šé“æœ€å | 3.30ç§’ | x2.88 |'
- en: '| traced UNet | 3.21s | x2.96 |'
  id: totrans-11
  prefs: []
  type: TYPE_TB
  zh: '| è¿½è¸ªçš„UNet | 3.21ç§’ | x2.96 |'
- en: '| memory efficient attention | 2.63s | x3.61 |'
  id: totrans-12
  prefs: []
  type: TYPE_TB
  zh: '| å†…å­˜é«˜æ•ˆçš„æ³¨æ„åŠ› | 2.63ç§’ | x3.61 |'
- en: Use TensorFloat-32
  id: totrans-13
  prefs:
  - PREF_H2
  type: TYPE_NORMAL
  zh: ä½¿ç”¨TensorFloat-32
- en: On Ampere and later CUDA devices, matrix multiplications and convolutions can
    use the [TensorFloat-32 (TF32)](https://blogs.nvidia.com/blog/2020/05/14/tensorfloat-32-precision-format/)
    mode for faster, but slightly less accurate computations. By default, PyTorch
    enables TF32 mode for convolutions but not matrix multiplications. Unless your
    network requires full float32 precision, we recommend enabling TF32 for matrix
    multiplications. It can significantly speeds up computations with typically negligible
    loss in numerical accuracy.
  id: totrans-14
  prefs: []
  type: TYPE_NORMAL
  zh: åœ¨å®‰åŸ¹åŠæ›´é«˜ç‰ˆæœ¬çš„CUDAè®¾å¤‡ä¸Šï¼ŒçŸ©é˜µä¹˜æ³•å’Œå·ç§¯å¯ä»¥ä½¿ç”¨[å¼ é‡æµ®ç‚¹32ï¼ˆTF32ï¼‰](https://blogs.nvidia.com/blog/2020/05/14/tensorfloat-32-precision-format/)æ¨¡å¼è¿›è¡Œæ›´å¿«ä½†ç•¥å¾®ä¸å‡†ç¡®çš„è®¡ç®—ã€‚é»˜è®¤æƒ…å†µä¸‹ï¼ŒPyTorchä¸ºå·ç§¯å¯ç”¨TF32æ¨¡å¼ï¼Œä½†ä¸ä¸ºçŸ©é˜µä¹˜æ³•å¯ç”¨ã€‚é™¤éæ‚¨çš„ç½‘ç»œéœ€è¦å®Œæ•´çš„float32ç²¾åº¦ï¼Œå¦åˆ™æˆ‘ä»¬å»ºè®®ä¸ºçŸ©é˜µä¹˜æ³•å¯ç”¨TF32ã€‚å®ƒå¯ä»¥æ˜¾ç€åŠ å¿«è®¡ç®—é€Ÿåº¦ï¼Œé€šå¸¸å‡ ä¹ä¸ä¼šæŸå¤±æ•°å€¼ç²¾åº¦ã€‚
- en: '[PRE0]'
  id: totrans-15
  prefs: []
  type: TYPE_PRE
  zh: '[PRE0]'
- en: You can learn more about TF32 in the [Mixed precision training](https://huggingface.co/docs/transformers/en/perf_train_gpu_one#tf32)
    guide.
  id: totrans-16
  prefs: []
  type: TYPE_NORMAL
  zh: æ‚¨å¯ä»¥åœ¨[æ··åˆç²¾åº¦è®­ç»ƒ](https://huggingface.co/docs/transformers/en/perf_train_gpu_one#tf32)æŒ‡å—ä¸­äº†è§£æœ‰å…³TF32çš„æ›´å¤šä¿¡æ¯ã€‚
- en: Half-precision weights
  id: totrans-17
  prefs:
  - PREF_H2
  type: TYPE_NORMAL
  zh: åŠç²¾åº¦æƒé‡
- en: 'To save GPU memory and get more speed, try loading and running the model weights
    directly in half-precision or float16:'
  id: totrans-18
  prefs: []
  type: TYPE_NORMAL
  zh: ä¸ºäº†èŠ‚çœGPUå†…å­˜å¹¶è·å¾—æ›´å¿«é€Ÿåº¦ï¼Œè¯·å°è¯•ç›´æ¥åœ¨åŠç²¾åº¦æˆ–float16ä¸­åŠ è½½å’Œè¿è¡Œæ¨¡å‹æƒé‡ï¼š
- en: '[PRE1]'
  id: totrans-19
  prefs: []
  type: TYPE_PRE
  zh: '[PRE1]'
- en: Donâ€™t use [`torch.autocast`](https://pytorch.org/docs/stable/amp.html#torch.autocast)
    in any of the pipelines as it can lead to black images and is always slower than
    pure float16 precision.
  id: totrans-20
  prefs: []
  type: TYPE_NORMAL
  zh: åœ¨ä»»ä½•æµæ°´çº¿ä¸­ä¸è¦ä½¿ç”¨[`torch.autocast`](https://pytorch.org/docs/stable/amp.html#torch.autocast)ï¼Œå› ä¸ºå®ƒå¯èƒ½å¯¼è‡´é»‘è‰²å›¾åƒï¼Œå¹¶ä¸”å§‹ç»ˆæ¯”çº¯float16ç²¾åº¦æ…¢ã€‚
