- en: InstructPix2Pix
  prefs:
  - PREF_H1
  type: TYPE_NORMAL
- en: ÂéüÊñáÔºö[https://huggingface.co/docs/diffusers/training/instructpix2pix](https://huggingface.co/docs/diffusers/training/instructpix2pix)
  prefs:
  - PREF_BQ
  type: TYPE_NORMAL
- en: <link href="/docs/diffusers/v0.26.3/en/_app/immutable/assets/0.e3b0c442.css"
    rel="modulepreload"> <link rel="modulepreload" href="/docs/diffusers/v0.26.3/en/_app/immutable/entry/start.99629b4a.js">
    <link rel="modulepreload" href="/docs/diffusers/v0.26.3/en/_app/immutable/chunks/scheduler.182ea377.js">
    <link rel="modulepreload" href="/docs/diffusers/v0.26.3/en/_app/immutable/chunks/singletons.fade7992.js">
    <link rel="modulepreload" href="/docs/diffusers/v0.26.3/en/_app/immutable/chunks/index.1f6d62f6.js">
    <link rel="modulepreload" href="/docs/diffusers/v0.26.3/en/_app/immutable/chunks/paths.108a236d.js">
    <link rel="modulepreload" href="/docs/diffusers/v0.26.3/en/_app/immutable/entry/app.2b3eaeb0.js">
    <link rel="modulepreload" href="/docs/diffusers/v0.26.3/en/_app/immutable/chunks/index.abf12888.js">
    <link rel="modulepreload" href="/docs/diffusers/v0.26.3/en/_app/immutable/nodes/0.3862a335.js">
    <link rel="modulepreload" href="/docs/diffusers/v0.26.3/en/_app/immutable/chunks/each.e59479a4.js">
    <link rel="modulepreload" href="/docs/diffusers/v0.26.3/en/_app/immutable/nodes/141.2a8f703e.js">
    <link rel="modulepreload" href="/docs/diffusers/v0.26.3/en/_app/immutable/chunks/Tip.230e2334.js">
    <link rel="modulepreload" href="/docs/diffusers/v0.26.3/en/_app/immutable/chunks/CodeBlock.57fe6e13.js">
    <link rel="modulepreload" href="/docs/diffusers/v0.26.3/en/_app/immutable/chunks/Heading.16916d63.js">
  prefs: []
  type: TYPE_NORMAL
- en: '[InstructPix2Pix](https://hf.co/papers/2211.09800) is a Stable Diffusion model
    trained to edit images from human-provided instructions. For example, your prompt
    can be ‚Äúturn the clouds rainy‚Äù and the model will edit the input image accordingly.
    This model is conditioned on the text prompt (or editing instruction) and the
    input image.'
  prefs: []
  type: TYPE_NORMAL
- en: This guide will explore the [train_instruct_pix2pix.py](https://github.com/huggingface/diffusers/blob/main/examples/instruct_pix2pix/train_instruct_pix2pix.py)
    training script to help you become familiar with it, and how you can adapt it
    for your own use-case.
  prefs: []
  type: TYPE_NORMAL
- en: 'Before running the script, make sure you install the library from source:'
  prefs: []
  type: TYPE_NORMAL
- en: '[PRE0]'
  prefs: []
  type: TYPE_PRE
- en: 'Then navigate to the example folder containing the training script and install
    the required dependencies for the script you‚Äôre using:'
  prefs: []
  type: TYPE_NORMAL
- en: '[PRE1]'
  prefs: []
  type: TYPE_PRE
- en: ü§ó Accelerate is a library for helping you train on multiple GPUs/TPUs or with
    mixed-precision. It‚Äôll automatically configure your training setup based on your
    hardware and environment. Take a look at the ü§ó Accelerate [Quick tour](https://huggingface.co/docs/accelerate/quicktour)
    to learn more.
  prefs: []
  type: TYPE_NORMAL
- en: 'Initialize an ü§ó Accelerate environment:'
  prefs: []
  type: TYPE_NORMAL
- en: '[PRE2]'
  prefs: []
  type: TYPE_PRE
- en: 'To setup a default ü§ó Accelerate environment without choosing any configurations:'
  prefs: []
  type: TYPE_NORMAL
- en: '[PRE3]'
  prefs: []
  type: TYPE_PRE
- en: 'Or if your environment doesn‚Äôt support an interactive shell, like a notebook,
    you can use:'
  prefs: []
  type: TYPE_NORMAL
- en: '[PRE4]'
  prefs: []
  type: TYPE_PRE
- en: Lastly, if you want to train a model on your own dataset, take a look at the
    [Create a dataset for training](create_dataset) guide to learn how to create a
    dataset that works with the training script.
  prefs: []
  type: TYPE_NORMAL
- en: The following sections highlight parts of the training script that are important
    for understanding how to modify it, but it doesn‚Äôt cover every aspect of the script
    in detail. If you‚Äôre interested in learning more, feel free to read through the
    [script](https://github.com/huggingface/diffusers/blob/main/examples/instruct_pix2pix/train_instruct_pix2pix.py)
    and let us know if you have any questions or concerns.
  prefs: []
  type: TYPE_NORMAL
- en: Script parameters
  prefs:
  - PREF_H2
  type: TYPE_NORMAL
- en: The training script has many parameters to help you customize your training
    run. All of the parameters and their descriptions are found in the [`parse_args()`](https://github.com/huggingface/diffusers/blob/64603389da01082055a901f2883c4810d1144edb/examples/instruct_pix2pix/train_instruct_pix2pix.py#L65)
    function. Default values are provided for most parameters that work pretty well,
    but you can also set your own values in the training command if you‚Äôd like.
  prefs: []
  type: TYPE_NORMAL
- en: 'For example, to increase the resolution of the input image:'
  prefs: []
  type: TYPE_NORMAL
- en: '[PRE5]'
  prefs: []
  type: TYPE_PRE
- en: 'Many of the basic and important parameters are described in the [Text-to-image](text2image#script-parameters)
    training guide, so this guide just focuses on the relevant parameters for InstructPix2Pix:'
  prefs: []
  type: TYPE_NORMAL
- en: '`--original_image_column`: the original image before the edits are made'
  prefs:
  - PREF_UL
  type: TYPE_NORMAL
- en: '`--edited_image_column`: the image after the edits are made'
  prefs:
  - PREF_UL
  type: TYPE_NORMAL
- en: '`--edit_prompt_column`: the instructions to edit the image'
  prefs:
  - PREF_UL
  type: TYPE_NORMAL
- en: '`--conditioning_dropout_prob`: the dropout probability for the edited image
    and edit prompts during training which enables classifier-free guidance (CFG)
    for one or both conditioning inputs'
  prefs:
  - PREF_UL
  type: TYPE_NORMAL
- en: Training script
  prefs:
  - PREF_H2
  type: TYPE_NORMAL
- en: The dataset preprocessing code and training loop are found in the [`main()`](https://github.com/huggingface/diffusers/blob/64603389da01082055a901f2883c4810d1144edb/examples/instruct_pix2pix/train_instruct_pix2pix.py#L374)
    function. This is where you‚Äôll make your changes to the training script to adapt
    it for your own use-case.
  prefs: []
  type: TYPE_NORMAL
- en: As with the script parameters, a walkthrough of the training script is provided
    in the [Text-to-image](text2image#training-script) training guide. Instead, this
    guide takes a look at the InstructPix2Pix relevant parts of the script.
  prefs: []
  type: TYPE_NORMAL
- en: 'The script begins by modifing the [number of input channels](https://github.com/huggingface/diffusers/blob/64603389da01082055a901f2883c4810d1144edb/examples/instruct_pix2pix/train_instruct_pix2pix.py#L445)
    in the first convolutional layer of the UNet to account for InstructPix2Pix‚Äôs
    additional conditioning image:'
  prefs: []
  type: TYPE_NORMAL
- en: '[PRE6]'
  prefs: []
  type: TYPE_PRE
- en: 'These UNet parameters are [updated](https://github.com/huggingface/diffusers/blob/64603389da01082055a901f2883c4810d1144edb/examples/instruct_pix2pix/train_instruct_pix2pix.py#L545C1-L551C6)
    by the optimizer:'
  prefs: []
  type: TYPE_NORMAL
- en: '[PRE7]'
  prefs: []
  type: TYPE_PRE
- en: Next, the edited images and and edit instructions are [preprocessed](https://github.com/huggingface/diffusers/blob/64603389da01082055a901f2883c4810d1144edb/examples/instruct_pix2pix/train_instruct_pix2pix.py#L624)
    and [tokenized](https://github.com/huggingface/diffusers/blob/64603389da01082055a901f2883c4810d1144edb/examples/instruct_pix2pix/train_instruct_pix2pix.py#L610C24-L610C24).
    It is important the same image transformations are applied to the original and
    edited images.
  prefs: []
  type: TYPE_NORMAL
- en: '[PRE8]'
  prefs: []
  type: TYPE_PRE
- en: 'Finally, in the [training loop](https://github.com/huggingface/diffusers/blob/64603389da01082055a901f2883c4810d1144edb/examples/instruct_pix2pix/train_instruct_pix2pix.py#L730),
    it starts by encoding the edited images into latent space:'
  prefs: []
  type: TYPE_NORMAL
- en: '[PRE9]'
  prefs: []
  type: TYPE_PRE
- en: Then, the script applies dropout to the original image and edit instruction
    embeddings to support CFG. This is what enables the model to modulate the influence
    of the edit instruction and original image on the edited image.
  prefs: []
  type: TYPE_NORMAL
- en: '[PRE10]'
  prefs: []
  type: TYPE_PRE
- en: That‚Äôs pretty much it! Aside from the differences described here, the rest of
    the script is very similar to the [Text-to-image](text2image#training-script)
    training script, so feel free to check it out for more details. If you want to
    learn more about how the training loop works, check out the [Understanding pipelines,
    models and schedulers](../using-diffusers/write_own_pipeline) tutorial which breaks
    down the basic pattern of the denoising process.
  prefs: []
  type: TYPE_NORMAL
- en: Launch the script
  prefs:
  - PREF_H2
  type: TYPE_NORMAL
- en: Once you‚Äôre happy with the changes to your script or if you‚Äôre okay with the
    default configuration, you‚Äôre ready to launch the training script! üöÄ
  prefs: []
  type: TYPE_NORMAL
- en: This guide uses the [fusing/instructpix2pix-1000-samples](https://huggingface.co/datasets/fusing/instructpix2pix-1000-samples)
    dataset, which is a smaller version of the [original dataset](https://huggingface.co/datasets/timbrooks/instructpix2pix-clip-filtered).
    You can also create and use your own dataset if you‚Äôd like (see the [Create a
    dataset for training](create_dataset) guide).
  prefs: []
  type: TYPE_NORMAL
- en: Set the `MODEL_NAME` environment variable to the name of the model (can be a
    model id on the Hub or a path to a local model), and the `DATASET_ID` to the name
    of the dataset on the Hub. The script creates and saves all the components (feature
    extractor, scheduler, text encoder, UNet, etc.) to a subfolder in your repository.
  prefs: []
  type: TYPE_NORMAL
- en: For better results, try longer training runs with a larger dataset. We‚Äôve only
    tested this training script on a smaller-scale dataset.
  prefs: []
  type: TYPE_NORMAL
- en: To monitor training progress with Weights and Biases, add the `--report_to=wandb`
    parameter to the training command and specify a validation image with `--val_image_url`
    and a validation prompt with `--validation_prompt`. This can be really useful
    for debugging the model.
  prefs: []
  type: TYPE_NORMAL
- en: If you‚Äôre training on more than one GPU, add the `--multi_gpu` parameter to
    the `accelerate launch` command.
  prefs: []
  type: TYPE_NORMAL
- en: '[PRE11]'
  prefs: []
  type: TYPE_PRE
- en: 'After training is finished, you can use your new InstructPix2Pix for inference:'
  prefs: []
  type: TYPE_NORMAL
- en: '[PRE12]'
  prefs: []
  type: TYPE_PRE
- en: You should experiment with different `num_inference_steps`, `image_guidance_scale`,
    and `guidance_scale` values to see how they affect inference speed and quality.
    The guidance scale parameters are especially impactful because they control how
    much the original image and edit instructions affect the edited image.
  prefs: []
  type: TYPE_NORMAL
- en: Stable Diffusion XL
  prefs:
  - PREF_H2
  type: TYPE_NORMAL
- en: Stable Diffusion XL (SDXL) is a powerful text-to-image model that generates
    high-resolution images, and it adds a second text-encoder to its architecture.
    Use the [`train_instruct_pix2pix_sdxl.py`](https://github.com/huggingface/diffusers/blob/main/examples/instruct_pix2pix/train_instruct_pix2pix_sdxl.py)
    script to train a SDXL model to follow image editing instructions.
  prefs: []
  type: TYPE_NORMAL
- en: The SDXL training script is discussed in more detail in the [SDXL training](sdxl)
    guide.
  prefs: []
  type: TYPE_NORMAL
- en: Next steps
  prefs:
  - PREF_H2
  type: TYPE_NORMAL
- en: 'Congratulations on training your own InstructPix2Pix model! ü•≥ To learn more
    about the model, it may be helpful to:'
  prefs: []
  type: TYPE_NORMAL
- en: Read the [Instruction-tuning Stable Diffusion with InstructPix2Pix](https://huggingface.co/blog/instruction-tuning-sd)
    blog post to learn more about some experiments we‚Äôve done with InstructPix2Pix,
    dataset preparation, and results for different instructions.
  prefs:
  - PREF_UL
  type: TYPE_NORMAL
