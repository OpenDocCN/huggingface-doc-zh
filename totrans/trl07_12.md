# å¥–åŠ±å»ºæ¨¡

> åŸå§‹æ–‡æœ¬ï¼š[`huggingface.co/docs/trl/reward_trainer`](https://huggingface.co/docs/trl/reward_trainer)

TRL æ”¯æŒä»»ä½•äººå¯¹å…¶æ•°æ®é›†å’Œæ¨¡å‹æ‰§è¡Œè‡ªå®šä¹‰å¥–åŠ±å»ºæ¨¡ã€‚

åœ¨[`examples/scripts/reward_modeling.py`](https://github.com/huggingface/trl/tree/main/examples/scripts/reward_modeling.py)ä¸­æŸ¥çœ‹ä¸€ä¸ªå®Œæ•´çµæ´»çš„ç¤ºä¾‹ã€‚

## æœŸæœ›çš„æ•°æ®é›†æ ¼å¼

RewardTrainer æœŸæœ›æ•°æ®é›†å…·æœ‰éå¸¸ç‰¹å®šçš„æ ¼å¼ï¼Œå› ä¸ºæ¨¡å‹å°†åœ¨ç¤ºä¾‹å¯¹ä¸Šè¿›è¡Œè®­ç»ƒï¼Œä»¥é¢„æµ‹å“ªä¸ªæ›´å—åçˆ±ã€‚æˆ‘ä»¬åœ¨ä¸‹é¢æä¾›äº†ä¸€ä¸ªæ¥è‡ª[`Anthropic/hh-rlhf`](https://huggingface.co/datasets/Anthropic/hh-rlhf)æ•°æ®é›†çš„ç¤ºä¾‹ï¼š

![](img/108b7079a2ffc651b11289080d0cdc7d.png)

å› æ­¤ï¼Œå¦‚æœæ‚¨ä½¿ç”¨é»˜è®¤çš„`RewardDataCollatorWithPadding`æ•°æ®æ•´ç†å™¨ï¼Œåˆ™æœ€ç»ˆæ•°æ®é›†å¯¹è±¡åº”è¯¥è‡³å°‘åŒ…å«ä¸¤ä¸ª 4 ä¸ªæ¡ç›®ã€‚è¿™äº›æ¡ç›®åº”è¯¥å‘½åä¸ºï¼š

+   `input_ids_chosen`

+   `attention_mask_chosen`

+   `input_ids_rejected`

+   `attention_mask_rejected`

## ä½¿ç”¨ RewardTrainer

å‡†å¤‡å¥½æ•°æ®é›†åï¼Œæ‚¨å¯ä»¥åƒä½¿ç”¨ğŸ¤— Transformers ä¸­çš„`Trainer`ç±»ä¸€æ ·ä½¿ç”¨ RewardTrainerã€‚æ‚¨åº”è¯¥å°†ä¸€ä¸ª`AutoModelForSequenceClassification`æ¨¡å‹ä¼ é€’ç»™ RewardTrainerï¼Œä»¥åŠä¸€ä¸ª RewardConfig æ¥é…ç½®è®­ç»ƒçš„è¶…å‚æ•°ã€‚

### åˆ©ç”¨ğŸ¤— PEFT æ¥è®­ç»ƒå¥–åŠ±æ¨¡å‹

åªéœ€åœ¨ RewardTrainer çš„å…³é”®å­—å‚æ•°ä¸­ä¼ é€’ä¸€ä¸ª`peft_config`ï¼Œè®­ç»ƒå™¨åº”è¯¥ä¼šè‡ªåŠ¨å°†æ¨¡å‹è½¬æ¢ä¸º PEFT æ¨¡å‹ï¼

```py
from peft import LoraConfig, TaskType
from transformers import AutoModelForSequenceClassification, AutoTokenizer
from trl import RewardTrainer, RewardConfig

model = AutoModelForSequenceClassification.from_pretrained("gpt2")
peft_config = LoraConfig(
    task_type=TaskType.SEQ_CLS,
    inference_mode=False,
    r=8,
    lora_alpha=32,
    lora_dropout=0.1,
)

...

trainer = RewardTrainer(
    model=model,
    args=training_args,
    tokenizer=tokenizer,
    train_dataset=dataset,
    peft_config=peft_config,
)

trainer.train()

```

### å‘æŸå¤±æ·»åŠ è¾¹é™…

å¦‚[Llama 2 è®ºæ–‡](https://huggingface.co/papers/2307.09288)ä¸­æ‰€è¿°ï¼Œæ‚¨å¯ä»¥é€šè¿‡å‘æ•°æ®é›†æ·»åŠ ä¸€ä¸ª`margin`åˆ—æ¥å‘æŸå¤±æ·»åŠ è¾¹é™…ã€‚å¥–åŠ±æ•´ç†å™¨å°†è‡ªåŠ¨ä¼ é€’å®ƒï¼Œå¹¶ç›¸åº”åœ°è®¡ç®—æŸå¤±ã€‚

```py
def add_margin(row):
    # Assume you have a score_chosen and score_rejected columns that you want to use to compute the margin
    return {'margin': row['score_chosen'] - row['score_rejected']}

dataset = dataset.map(add_margin)
```

## RewardConfig

### `class trl.RewardConfig`

[< source >](https://github.com/huggingface/trl/blob/v0.7.10/trl/trainer/reward_config.py#L21)

```py
( output_dir: str overwrite_output_dir: bool = False do_train: bool = False do_eval: bool = False do_predict: bool = False evaluation_strategy: Union = 'no' prediction_loss_only: bool = False per_device_train_batch_size: int = 8 per_device_eval_batch_size: int = 8 per_gpu_train_batch_size: Optional = None per_gpu_eval_batch_size: Optional = None gradient_accumulation_steps: int = 1 eval_accumulation_steps: Optional = None eval_delay: Optional = 0 learning_rate: float = 5e-05 weight_decay: float = 0.0 adam_beta1: float = 0.9 adam_beta2: float = 0.999 adam_epsilon: float = 1e-08 max_grad_norm: float = 1.0 num_train_epochs: float = 3.0 max_steps: int = -1 lr_scheduler_type: Union = 'linear' lr_scheduler_kwargs: Optional = <factory> warmup_ratio: float = 0.0 warmup_steps: int = 0 log_level: Optional = 'passive' log_level_replica: Optional = 'warning' log_on_each_node: bool = True logging_dir: Optional = None logging_strategy: Union = 'steps' logging_first_step: bool = False logging_steps: float = 500 logging_nan_inf_filter: bool = True save_strategy: Union = 'steps' save_steps: float = 500 save_total_limit: Optional = None save_safetensors: Optional = True save_on_each_node: bool = False save_only_model: bool = False no_cuda: bool = False use_cpu: bool = False use_mps_device: bool = False seed: int = 42 data_seed: Optional = None jit_mode_eval: bool = False use_ipex: bool = False bf16: bool = False fp16: bool = False fp16_opt_level: str = 'O1' half_precision_backend: str = 'auto' bf16_full_eval: bool = False fp16_full_eval: bool = False tf32: Optional = None local_rank: int = -1 ddp_backend: Optional = None tpu_num_cores: Optional = None tpu_metrics_debug: bool = False debug: Union = '' dataloader_drop_last: bool = False eval_steps: Optional = None dataloader_num_workers: int = 0 past_index: int = -1 run_name: Optional = None disable_tqdm: Optional = None remove_unused_columns: Optional = True label_names: Optional = None load_best_model_at_end: Optional = False metric_for_best_model: Optional = None greater_is_better: Optional = None ignore_data_skip: bool = False fsdp: Union = '' fsdp_min_num_params: int = 0 fsdp_config: Optional = None fsdp_transformer_layer_cls_to_wrap: Optional = None deepspeed: Optional = None label_smoothing_factor: float = 0.0 optim: Union = 'adamw_torch' optim_args: Optional = None adafactor: bool = False group_by_length: bool = False length_column_name: Optional = 'length' report_to: Optional = None ddp_find_unused_parameters: Optional = None ddp_bucket_cap_mb: Optional = None ddp_broadcast_buffers: Optional = None dataloader_pin_memory: bool = True dataloader_persistent_workers: bool = False skip_memory_metrics: bool = True use_legacy_prediction_loop: bool = False push_to_hub: bool = False resume_from_checkpoint: Optional = None hub_model_id: Optional = None hub_strategy: Union = 'every_save' hub_token: Optional = None hub_private_repo: bool = False hub_always_push: bool = False gradient_checkpointing: Optional = True gradient_checkpointing_kwargs: Optional = None include_inputs_for_metrics: bool = False fp16_backend: str = 'auto' push_to_hub_model_id: Optional = None push_to_hub_organization: Optional = None push_to_hub_token: Optional = None mp_parameters: str = '' auto_find_batch_size: bool = False full_determinism: bool = False torchdynamo: Optional = None ray_scope: Optional = 'last' ddp_timeout: Optional = 1800 torch_compile: bool = False torch_compile_backend: Optional = None torch_compile_mode: Optional = None dispatch_batches: Optional = None split_batches: Optional = False include_tokens_per_second: Optional = False include_num_input_tokens_seen: Optional = False neftune_noise_alpha: float = None max_length: Optional = None )
```

å‚æ•°

+   `max_length` (`int`, *å¯é€‰*, é»˜è®¤ä¸º`None`) â€” æ‰¹æ¬¡ä¸­åºåˆ—çš„æœ€å¤§é•¿åº¦ã€‚å¦‚æœè¦ä½¿ç”¨é»˜è®¤æ•°æ®æ•´ç†å™¨ï¼Œåˆ™éœ€è¦æ­¤å‚æ•°ã€‚

+   `gradient_checkpointing` (`bool`, *å¯é€‰*, é»˜è®¤ä¸º`True`) â€” å¦‚æœä¸º Trueï¼Œåˆ™ä½¿ç”¨æ¢¯åº¦æ£€æŸ¥ç‚¹æ¥èŠ‚çœå†…å­˜ï¼Œä½†ä¼šå‡æ…¢å‘åä¼ é€’çš„é€Ÿåº¦ã€‚

RewardConfig æ”¶é›†ä¸ RewardTrainer ç±»ç›¸å…³çš„æ‰€æœ‰è®­ç»ƒå‚æ•°ã€‚

ä½¿ç”¨`HfArgumentParser`ï¼Œæˆ‘ä»¬å¯ä»¥å°†è¿™ä¸ªç±»è½¬æ¢ä¸ºå¯ä»¥åœ¨å‘½ä»¤è¡Œä¸ŠæŒ‡å®šçš„[argparse](https://docs.python.org/3/library/argparse#module-argparse)å‚æ•°ã€‚

## RewardTrainer

### `class trl.RewardTrainer`

[< source >](https://github.com/huggingface/trl/blob/v0.7.10/trl/trainer/reward_trainer.py#L36)

```py
( model: Union = None args: Optional = None data_collator: Optional = None train_dataset: Optional = None eval_dataset: Union = None tokenizer: Optional = None model_init: Optional = None compute_metrics: Optional = None callbacks: Optional = None optimizers: Tuple = (None, None) preprocess_logits_for_metrics: Optional = None max_length: Optional = None peft_config: Optional = None )
```

RewardTrainer å¯ç”¨äºè®­ç»ƒæ‚¨çš„è‡ªå®šä¹‰å¥–åŠ±æ¨¡å‹ã€‚å®ƒæ˜¯`transformers.Trainer`ç±»çš„å­ç±»ï¼Œç»§æ‰¿äº†æ‰€æœ‰å±æ€§å’Œæ–¹æ³•ã€‚å»ºè®®ä½¿ç”¨`AutoModelForSequenceClassification`ä½œä¸ºå¥–åŠ±æ¨¡å‹ã€‚å¥–åŠ±æ¨¡å‹åº”è¯¥åœ¨æˆå¯¹ç¤ºä¾‹çš„æ•°æ®é›†ä¸Šè¿›è¡Œè®­ç»ƒï¼Œå…¶ä¸­æ¯ä¸ªç¤ºä¾‹éƒ½æ˜¯ä¸¤ä¸ªåºåˆ—çš„å…ƒç»„ã€‚å¥–åŠ±æ¨¡å‹åº”è¯¥è¢«è®­ç»ƒä»¥é¢„æµ‹å“ªä¸ªç¤ºä¾‹å¯¹äºå½“å‰ä»»åŠ¡æ›´ç›¸å…³ã€‚

å¥–åŠ±è®­ç»ƒå™¨æœŸæœ›æ•°æ®é›†å…·æœ‰éå¸¸ç‰¹å®šçš„æ ¼å¼ã€‚å¦‚æœä¸ä½¿ç”¨é»˜è®¤çš„`RewardDataCollatorWithPadding`æ•°æ®æ•´ç†å™¨ï¼Œåˆ™æ•°æ®é›†åº”è¯¥è‡³å°‘åŒ…å«ä¸¤ä¸ª 4 ä¸ªæ¡ç›®ã€‚è¿™äº›æ¡ç›®åº”è¯¥å‘½åä¸º

+   `input_ids_chosen`

+   `attention_mask_chosen`

+   `input_ids_rejected`

+   `attention_mask_rejected`

æ‚¨è¿˜å¯ä»¥å‘æ•°æ®é›†ä¼ é€’ä¸€ä¸ª`margin`æ¡ç›®ã€‚è¯¥æ¡ç›®åº”åŒ…å«ç”¨äºè°ƒèŠ‚å¥–åŠ±æ¨¡å‹æŸå¤±çš„è¾¹è·ï¼Œå¦‚[`ai.meta.com/research/publications/llama-2-open-foundation-and-fine-tuned-chat-models/`](https://ai.meta.com/research/publications/llama-2-open-foundation-and-fine-tuned-chat-models/)ä¸­æ‰€è¿°ã€‚å¦‚æœæ‚¨ä¸ä¼ é€’è¾¹è·ï¼Œåˆ™ä¸ä¼šä½¿ç”¨è¾¹è·ã€‚
