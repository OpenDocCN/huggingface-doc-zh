- en: Testing
  id: totrans-0
  prefs:
  - PREF_H1
  type: TYPE_NORMAL
  zh: æµ‹è¯•
- en: 'Original text: [https://huggingface.co/docs/transformers/v4.37.2/en/testing](https://huggingface.co/docs/transformers/v4.37.2/en/testing)'
  id: totrans-1
  prefs:
  - PREF_BQ
  type: TYPE_NORMAL
  zh: åŽŸå§‹æ–‡æœ¬ï¼š[https://huggingface.co/docs/transformers/v4.37.2/en/testing](https://huggingface.co/docs/transformers/v4.37.2/en/testing)
- en: null
  id: totrans-2
  prefs: []
  type: TYPE_NORMAL
- en: Letâ€™s take a look at how ðŸ¤— Transformers models are tested and how you can write
    new tests and improve the existing ones.
  id: totrans-3
  prefs: []
  type: TYPE_NORMAL
  zh: è®©æˆ‘ä»¬çœ‹çœ‹ðŸ¤— Transformersæ¨¡åž‹æ˜¯å¦‚ä½•æµ‹è¯•çš„ï¼Œä»¥åŠæ‚¨å¦‚ä½•ç¼–å†™æ–°æµ‹è¯•å¹¶æ”¹è¿›çŽ°æœ‰æµ‹è¯•ã€‚
- en: 'There are 2 test suites in the repository:'
  id: totrans-4
  prefs: []
  type: TYPE_NORMAL
  zh: å­˜å‚¨åº“ä¸­æœ‰2ä¸ªæµ‹è¯•å¥—ä»¶ï¼š
- en: '`tests` â€” tests for the general API'
  id: totrans-5
  prefs:
  - PREF_OL
  type: TYPE_NORMAL
  zh: '`tests` â€” ç”¨äºŽä¸€èˆ¬APIçš„æµ‹è¯•'
- en: '`examples` â€” tests primarily for various applications that arenâ€™t part of the
    API'
  id: totrans-6
  prefs:
  - PREF_OL
  type: TYPE_NORMAL
  zh: '`examples` â€” ä¸»è¦ç”¨äºŽä¸å±žäºŽAPIçš„å„ç§åº”ç”¨çš„æµ‹è¯•'
- en: How transformers are tested
  id: totrans-7
  prefs:
  - PREF_H2
  type: TYPE_NORMAL
  zh: å¦‚ä½•æµ‹è¯•transformers
- en: Once a PR is submitted it gets tested with 9 CircleCi jobs. Every new commit
    to that PR gets retested. These jobs are defined in this [config file](https://github.com/huggingface/transformers/tree/main/.circleci/config.yml),
    so that if needed you can reproduce the same environment on your machine.
  id: totrans-8
  prefs:
  - PREF_OL
  type: TYPE_NORMAL
  zh: ä¸€æ—¦æäº¤äº†PRï¼Œå®ƒå°†é€šè¿‡9ä¸ªCircleCiä½œä¸šè¿›è¡Œæµ‹è¯•ã€‚å¯¹è¯¥PRçš„æ¯ä¸ªæ–°æäº¤éƒ½ä¼šé‡æ–°æµ‹è¯•ã€‚è¿™äº›ä½œä¸šåœ¨æ­¤[é…ç½®æ–‡ä»¶](https://github.com/huggingface/transformers/tree/main/.circleci/config.yml)ä¸­å®šä¹‰ï¼Œå› æ­¤å¦‚æžœéœ€è¦ï¼Œæ‚¨å¯ä»¥åœ¨æ‚¨çš„æœºå™¨ä¸Šé‡çŽ°ç›¸åŒçš„çŽ¯å¢ƒã€‚
- en: These CI jobs donâ€™t run `@slow` tests.
  id: totrans-9
  prefs:
  - PREF_IND
  type: TYPE_NORMAL
  zh: è¿™äº›CIä½œä¸šä¸è¿è¡Œ`@slow`æµ‹è¯•ã€‚
- en: 'There are 3 jobs run by [github actions](https://github.com/huggingface/transformers/actions):'
  id: totrans-10
  prefs:
  - PREF_OL
  type: TYPE_NORMAL
  zh: ç”±[github actions](https://github.com/huggingface/transformers/actions)è¿è¡Œ3ä¸ªä½œä¸šï¼š
- en: '[torch hub integration](https://github.com/huggingface/transformers/tree/main/.github/workflows/github-torch-hub.yml):
    checks whether torch hub integration works.'
  id: totrans-11
  prefs:
  - PREF_IND
  - PREF_UL
  type: TYPE_NORMAL
  zh: '[torch hubé›†æˆ](https://github.com/huggingface/transformers/tree/main/.github/workflows/github-torch-hub.yml)ï¼šæ£€æŸ¥torch
    hubé›†æˆæ˜¯å¦æ­£å¸¸å·¥ä½œã€‚'
- en: '[self-hosted (push)](https://github.com/huggingface/transformers/tree/main/.github/workflows/self-push.yml):
    runs fast tests on GPU only on commits on `main`. It only runs if a commit on
    `main` has updated the code in one of the following folders: `src`, `tests`, `.github`
    (to prevent running on added model cards, notebooks, etc.)'
  id: totrans-12
  prefs:
  - PREF_IND
  - PREF_UL
  type: TYPE_NORMAL
  zh: '[è‡ªæ‰˜ç®¡ï¼ˆæŽ¨é€ï¼‰](https://github.com/huggingface/transformers/tree/main/.github/workflows/self-push.yml)ï¼šä»…åœ¨`main`ä¸Šçš„æäº¤ä¸Šåœ¨GPUä¸Šè¿è¡Œå¿«é€Ÿæµ‹è¯•ã€‚ä»…åœ¨`main`ä¸Šçš„æäº¤æ›´æ–°äº†ä»¥ä¸‹æ–‡ä»¶å¤¹ä¸­çš„ä»£ç æ—¶æ‰è¿è¡Œï¼š`src`ï¼Œ`tests`ï¼Œ`.github`ï¼ˆä»¥é˜²æ­¢åœ¨æ·»åŠ æ¨¡åž‹å¡ã€ç¬”è®°æœ¬ç­‰æ—¶è¿è¡Œï¼‰ã€‚'
- en: '[self-hosted runner](https://github.com/huggingface/transformers/tree/main/.github/workflows/self-scheduled.yml):
    runs normal and slow tests on GPU in `tests` and `examples`:'
  id: totrans-13
  prefs:
  - PREF_IND
  - PREF_UL
  type: TYPE_NORMAL
  zh: '[è‡ªæ‰˜ç®¡çš„è¿è¡Œå™¨](https://github.com/huggingface/transformers/tree/main/.github/workflows/self-scheduled.yml)ï¼šåœ¨`tests`å’Œ`examples`ä¸­çš„GPUä¸Šè¿è¡Œæ­£å¸¸å’Œæ…¢é€Ÿæµ‹è¯•ï¼š'
- en: '[PRE0]'
  id: totrans-14
  prefs: []
  type: TYPE_PRE
  zh: '[PRE0]'
- en: The results can be observed [here](https://github.com/huggingface/transformers/actions).
  id: totrans-15
  prefs: []
  type: TYPE_NORMAL
  zh: ç»“æžœå¯ä»¥åœ¨[æ­¤å¤„](https://github.com/huggingface/transformers/actions)è§‚å¯Ÿã€‚
- en: Running tests
  id: totrans-16
  prefs:
  - PREF_H2
  type: TYPE_NORMAL
  zh: è¿è¡Œæµ‹è¯•
- en: Choosing which tests to run
  id: totrans-17
  prefs:
  - PREF_H3
  type: TYPE_NORMAL
  zh: é€‰æ‹©è¦è¿è¡Œçš„æµ‹è¯•
- en: This document goes into many details of how tests can be run. If after reading
    everything, you need even more details you will find them [here](https://docs.pytest.org/en/latest/usage.html).
  id: totrans-18
  prefs: []
  type: TYPE_NORMAL
  zh: æœ¬æ–‡è¯¦ç»†ä»‹ç»äº†å¦‚ä½•è¿è¡Œæµ‹è¯•ã€‚å¦‚æžœé˜…è¯»å®Œæ‰€æœ‰å†…å®¹åŽï¼Œæ‚¨éœ€è¦æ›´å¤šç»†èŠ‚ï¼Œæ‚¨å¯ä»¥åœ¨[æ­¤å¤„](https://docs.pytest.org/en/latest/usage.html)æ‰¾åˆ°å®ƒä»¬ã€‚
- en: Here are some most useful ways of running tests.
  id: totrans-19
  prefs: []
  type: TYPE_NORMAL
  zh: ä»¥ä¸‹æ˜¯è¿è¡Œæµ‹è¯•çš„ä¸€äº›æœ€æœ‰ç”¨çš„æ–¹æ³•ã€‚
- en: 'Run all:'
  id: totrans-20
  prefs: []
  type: TYPE_NORMAL
  zh: è¿è¡Œæ‰€æœ‰ï¼š
- en: '[PRE1]'
  id: totrans-21
  prefs: []
  type: TYPE_PRE
  zh: '[PRE1]'
- en: 'or:'
  id: totrans-22
  prefs: []
  type: TYPE_NORMAL
  zh: æˆ–ï¼š
- en: '[PRE2]'
  id: totrans-23
  prefs: []
  type: TYPE_PRE
  zh: '[PRE2]'
- en: 'Note that the latter is defined as:'
  id: totrans-24
  prefs: []
  type: TYPE_NORMAL
  zh: è¯·æ³¨æ„ï¼ŒåŽè€…è¢«å®šä¹‰ä¸ºï¼š
- en: '[PRE3]'
  id: totrans-25
  prefs: []
  type: TYPE_PRE
  zh: '[PRE3]'
- en: 'which tells pytest to:'
  id: totrans-26
  prefs: []
  type: TYPE_NORMAL
  zh: å‘Šè¯‰pytestï¼š
- en: run as many test processes as they are CPU cores (which could be too many if
    you donâ€™t have a ton of RAM!)
  id: totrans-27
  prefs:
  - PREF_UL
  type: TYPE_NORMAL
  zh: è¿è¡Œä¸ŽCPUæ ¸å¿ƒæ•°é‡ç›¸åŒçš„æµ‹è¯•è¿›ç¨‹ï¼ˆå¦‚æžœRAMä¸è¶³å¯èƒ½ä¼šå¤ªå¤šï¼ï¼‰
- en: ensure that all tests from the same file will be run by the same test process
  id: totrans-28
  prefs:
  - PREF_UL
  type: TYPE_NORMAL
  zh: ç¡®ä¿åŒä¸€æ–‡ä»¶ä¸­çš„æ‰€æœ‰æµ‹è¯•å°†ç”±åŒä¸€ä¸ªæµ‹è¯•è¿›ç¨‹è¿è¡Œ
- en: do not capture output
  id: totrans-29
  prefs:
  - PREF_UL
  type: TYPE_NORMAL
  zh: ä¸æ•èŽ·è¾“å‡º
- en: run in verbose mode
  id: totrans-30
  prefs:
  - PREF_UL
  type: TYPE_NORMAL
  zh: ä»¥è¯¦ç»†æ¨¡å¼è¿è¡Œ
- en: Getting the list of all tests
  id: totrans-31
  prefs:
  - PREF_H3
  type: TYPE_NORMAL
  zh: èŽ·å–æ‰€æœ‰æµ‹è¯•çš„åˆ—è¡¨
- en: 'All tests of the test suite:'
  id: totrans-32
  prefs: []
  type: TYPE_NORMAL
  zh: æµ‹è¯•å¥—ä»¶çš„æ‰€æœ‰æµ‹è¯•ï¼š
- en: '[PRE4]'
  id: totrans-33
  prefs: []
  type: TYPE_PRE
  zh: '[PRE4]'
- en: 'All tests of a given test file:'
  id: totrans-34
  prefs: []
  type: TYPE_NORMAL
  zh: ç»™å®šæµ‹è¯•æ–‡ä»¶çš„æ‰€æœ‰æµ‹è¯•ï¼š
- en: '[PRE5]'
  id: totrans-35
  prefs: []
  type: TYPE_PRE
  zh: '[PRE5]'
- en: Run a specific test module
  id: totrans-36
  prefs:
  - PREF_H3
  type: TYPE_NORMAL
  zh: è¿è¡Œç‰¹å®šæµ‹è¯•æ¨¡å—
- en: 'To run an individual test module:'
  id: totrans-37
  prefs: []
  type: TYPE_NORMAL
  zh: è¦è¿è¡Œå•ä¸ªæµ‹è¯•æ¨¡å—ï¼š
- en: '[PRE6]'
  id: totrans-38
  prefs: []
  type: TYPE_PRE
  zh: '[PRE6]'
- en: Run specific tests
  id: totrans-39
  prefs:
  - PREF_H3
  type: TYPE_NORMAL
  zh: è¿è¡Œç‰¹å®šæµ‹è¯•
- en: 'Since unittest is used inside most of the tests, to run specific subtests you
    need to know the name of the unittest class containing those tests. For example,
    it could be:'
  id: totrans-40
  prefs: []
  type: TYPE_NORMAL
  zh: ç”±äºŽå¤§å¤šæ•°æµ‹è¯•ä¸­ä½¿ç”¨äº†unittestï¼Œè¦è¿è¡Œç‰¹å®šçš„å­æµ‹è¯•ï¼Œæ‚¨éœ€è¦çŸ¥é“åŒ…å«è¿™äº›æµ‹è¯•çš„unittestç±»çš„åç§°ã€‚ä¾‹å¦‚ï¼Œå¯èƒ½æ˜¯ï¼š
- en: '[PRE7]'
  id: totrans-41
  prefs: []
  type: TYPE_PRE
  zh: '[PRE7]'
- en: 'Here:'
  id: totrans-42
  prefs: []
  type: TYPE_NORMAL
  zh: è¿™é‡Œï¼š
- en: '`tests/test_optimization.py` - the file with tests'
  id: totrans-43
  prefs:
  - PREF_UL
  type: TYPE_NORMAL
  zh: '`tests/test_optimization.py` - å…·æœ‰æµ‹è¯•çš„æ–‡ä»¶'
- en: '`OptimizationTest` - the name of the class'
  id: totrans-44
  prefs:
  - PREF_UL
  type: TYPE_NORMAL
  zh: '`OptimizationTest` - ç±»çš„åç§°'
- en: '`test_adam_w` - the name of the specific test function'
  id: totrans-45
  prefs:
  - PREF_UL
  type: TYPE_NORMAL
  zh: '`test_adam_w` - ç‰¹å®šæµ‹è¯•å‡½æ•°çš„åç§°'
- en: 'If the file contains multiple classes, you can choose to run only tests of
    a given class. For example:'
  id: totrans-46
  prefs: []
  type: TYPE_NORMAL
  zh: å¦‚æžœæ–‡ä»¶åŒ…å«å¤šä¸ªç±»ï¼Œæ‚¨å¯ä»¥é€‰æ‹©ä»…è¿è¡Œç»™å®šç±»çš„æµ‹è¯•ã€‚ä¾‹å¦‚ï¼š
- en: '[PRE8]'
  id: totrans-47
  prefs: []
  type: TYPE_PRE
  zh: '[PRE8]'
- en: will run all the tests inside that class.
  id: totrans-48
  prefs: []
  type: TYPE_NORMAL
  zh: å°†è¿è¡Œè¯¥ç±»ä¸­çš„æ‰€æœ‰æµ‹è¯•ã€‚
- en: 'As mentioned earlier you can see what tests are contained inside the `OptimizationTest`
    class by running:'
  id: totrans-49
  prefs: []
  type: TYPE_NORMAL
  zh: å¦‚å‰æ‰€è¿°ï¼Œæ‚¨å¯ä»¥é€šè¿‡è¿è¡Œä»¥ä¸‹å†…å®¹æŸ¥çœ‹`OptimizationTest`ç±»ä¸­åŒ…å«çš„æ‰€æœ‰æµ‹è¯•ï¼š
- en: '[PRE9]'
  id: totrans-50
  prefs: []
  type: TYPE_PRE
  zh: '[PRE9]'
- en: You can run tests by keyword expressions.
  id: totrans-51
  prefs: []
  type: TYPE_NORMAL
  zh: æ‚¨å¯ä»¥é€šè¿‡å…³é”®å­—è¡¨è¾¾å¼è¿è¡Œæµ‹è¯•ã€‚
- en: 'To run only tests whose name contains `adam`:'
  id: totrans-52
  prefs: []
  type: TYPE_NORMAL
  zh: ä»…è¿è¡ŒåŒ…å«`adam`åç§°çš„æµ‹è¯•ï¼š
- en: '[PRE10]'
  id: totrans-53
  prefs: []
  type: TYPE_PRE
  zh: '[PRE10]'
- en: Logical `and` and `or` can be used to indicate whether all keywords should match
    or either. `not` can be used to negate.
  id: totrans-54
  prefs: []
  type: TYPE_NORMAL
  zh: é€»è¾‘`and`å’Œ`or`å¯ç”¨äºŽæŒ‡ç¤ºæ˜¯å¦åº”åŒ¹é…æ‰€æœ‰å…³é”®å­—æˆ–ä»»ä¸€å…³é”®å­—ã€‚`not`å¯ç”¨äºŽå¦å®šã€‚
- en: 'To run all tests except those whose name contains `adam`:'
  id: totrans-55
  prefs: []
  type: TYPE_NORMAL
  zh: è¦è¿è¡Œé™¤åŒ…å«`adam`çš„åç§°çš„æµ‹è¯•ä¹‹å¤–çš„æ‰€æœ‰æµ‹è¯•ï¼š
- en: '[PRE11]'
  id: totrans-56
  prefs: []
  type: TYPE_PRE
  zh: '[PRE11]'
- en: 'And you can combine the two patterns in one:'
  id: totrans-57
  prefs: []
  type: TYPE_NORMAL
  zh: æ‚¨å¯ä»¥å°†è¿™ä¸¤ç§æ¨¡å¼ç»“åˆåœ¨ä¸€èµ·ï¼š
- en: '[PRE12]'
  id: totrans-58
  prefs: []
  type: TYPE_PRE
  zh: '[PRE12]'
- en: 'For example to run both `test_adafactor` and `test_adam_w` you can use:'
  id: totrans-59
  prefs: []
  type: TYPE_NORMAL
  zh: ä¾‹å¦‚ï¼Œè¦åŒæ—¶è¿è¡Œ`test_adafactor`å’Œ`test_adam_w`ï¼Œæ‚¨å¯ä»¥ä½¿ç”¨ï¼š
- en: '[PRE13]'
  id: totrans-60
  prefs: []
  type: TYPE_PRE
  zh: '[PRE13]'
- en: Note that we use `or` here, since we want either of the keywords to match to
    include both.
  id: totrans-61
  prefs: []
  type: TYPE_NORMAL
  zh: è¯·æ³¨æ„ï¼Œæˆ‘ä»¬åœ¨è¿™é‡Œä½¿ç”¨`or`ï¼Œå› ä¸ºæˆ‘ä»¬å¸Œæœ›å…³é”®å­—ä¸­çš„ä»»ä½•ä¸€ä¸ªåŒ¹é…ä»¥åŒ…æ‹¬ä¸¤è€…ã€‚
- en: 'If you want to include only tests that include both patterns, `and` is to be
    used:'
  id: totrans-62
  prefs: []
  type: TYPE_NORMAL
  zh: å¦‚æžœè¦ä»…åŒ…å«åŒ…å«ä¸¤ç§æ¨¡å¼çš„æµ‹è¯•ï¼Œåº”ä½¿ç”¨`and`ï¼š
- en: '[PRE14]'
  id: totrans-63
  prefs: []
  type: TYPE_PRE
  zh: '[PRE14]'
- en: Run accelerate tests
  id: totrans-64
  prefs:
  - PREF_H3
  type: TYPE_NORMAL
  zh: è¿è¡ŒåŠ é€Ÿæµ‹è¯•
- en: 'Sometimes you need to run `accelerate` tests on your models. For that you can
    just add `-m accelerate_tests` to your command, if letâ€™s say you want to run these
    tests on `OPT` run:'
  id: totrans-65
  prefs: []
  type: TYPE_NORMAL
  zh: æœ‰æ—¶æ‚¨éœ€è¦åœ¨æ¨¡åž‹ä¸Šè¿è¡Œ`accelerate`æµ‹è¯•ã€‚ä¸ºæ­¤ï¼Œæ‚¨åªéœ€å°†`-m accelerate_tests`æ·»åŠ åˆ°æ‚¨çš„å‘½ä»¤ä¸­ï¼Œä¾‹å¦‚ï¼Œå¦‚æžœæ‚¨æƒ³åœ¨`OPT`ä¸Šè¿è¡Œè¿™äº›æµ‹è¯•ï¼š
- en: '[PRE15]'
  id: totrans-66
  prefs: []
  type: TYPE_PRE
  zh: '[PRE15]'
- en: Run documentation tests
  id: totrans-67
  prefs:
  - PREF_H3
  type: TYPE_NORMAL
  zh: è¿è¡Œæ–‡æ¡£æµ‹è¯•
- en: 'In order to test whether the documentation examples are correct, you should
    check that the `doctests` are passing. As an example, letâ€™s use [`WhisperModel.forward`â€™s
    docstring](https://github.com/huggingface/transformers/blob/main/src/transformers/models/whisper/modeling_whisper.py#L1017-L1035):'
  id: totrans-68
  prefs: []
  type: TYPE_NORMAL
  zh: ä¸ºäº†æµ‹è¯•æ–‡æ¡£ç¤ºä¾‹æ˜¯å¦æ­£ç¡®ï¼Œæ‚¨åº”è¯¥æ£€æŸ¥`doctests`æ˜¯å¦é€šè¿‡ã€‚ä¾‹å¦‚ï¼Œè®©æˆ‘ä»¬ä½¿ç”¨[`WhisperModel.forward`çš„æ–‡æ¡£å­—ç¬¦ä¸²](https://github.com/huggingface/transformers/blob/main/src/transformers/models/whisper/modeling_whisper.py#L1017-L1035)ï¼š
- en: '[PRE16]python'
  id: totrans-69
  prefs: []
  type: TYPE_NORMAL
  zh: '[PRE16]python'
- en: '>>> import torch'
  id: totrans-70
  prefs:
  - PREF_IND
  type: TYPE_NORMAL
  zh: '>>> import torch'
- en: '>>> from transformers import WhisperModel, WhisperFeatureExtractor'
  id: totrans-71
  prefs:
  - PREF_IND
  type: TYPE_NORMAL
  zh: '>>> from transformers import WhisperModel, WhisperFeatureExtractor'
- en: '>>> from datasets import load_dataset'
  id: totrans-72
  prefs:
  - PREF_IND
  type: TYPE_NORMAL
  zh: ä»Žæ•°æ®é›†å¯¼å…¥æ•°æ®é›†
- en: '>>> model = WhisperModel.from_pretrained("openai/whisper-base")'
  id: totrans-73
  prefs:
  - PREF_IND
  type: TYPE_NORMAL
  zh: '>>> model = WhisperModel.from_pretrained("openai/whisper-base")'
- en: '>>> feature_extractor = WhisperFeatureExtractor.from_pretrained("openai/whisper-base")'
  id: totrans-74
  prefs:
  - PREF_IND
  type: TYPE_NORMAL
  zh: '>>> feature_extractor = WhisperFeatureExtractor.from_pretrained("openai/whisper-base")'
- en: '>>> ds = load_dataset("hf-internal-testing/librispeech_asr_dummy", "clean",
    split="validation")'
  id: totrans-75
  prefs:
  - PREF_IND
  type: TYPE_NORMAL
  zh: '>>> ds = load_dataset("hf-internal-testing/librispeech_asr_dummy", "clean",
    split="validation")'
- en: '>>> inputs = feature_extractor(ds[0]["audio"]["array"], return_tensors="pt")'
  id: totrans-76
  prefs:
  - PREF_IND
  type: TYPE_NORMAL
  zh: '>>> inputs = feature_extractor(ds[0]["audio"]["array"], return_tensors="pt")'
- en: '>>> input_features = inputs.input_features'
  id: totrans-77
  prefs:
  - PREF_IND
  type: TYPE_NORMAL
  zh: '>>> input_features = inputs.input_features'
- en: '>>> decoder_input_ids = torch.tensor([[1, 1]]) * model.config.decoder_start_token_id'
  id: totrans-78
  prefs:
  - PREF_IND
  type: TYPE_NORMAL
  zh: '>>> decoder_input_ids = torch.tensor([[1, 1]]) * model.config.decoder_start_token_id'
- en: '>>> last_hidden_state = model(input_features, decoder_input_ids=decoder_input_ids).last_hidden_state'
  id: totrans-79
  prefs:
  - PREF_IND
  type: TYPE_NORMAL
  zh: '>>> last_hidden_state = model(input_features, decoder_input_ids=decoder_input_ids).last_hidden_state'
- en: '>>> list(last_hidden_state.shape)'
  id: totrans-80
  prefs:
  - PREF_IND
  type: TYPE_NORMAL
  zh: '>>> list(last_hidden_state.shape)'
- en: '[1, 2, 512]'
  id: totrans-81
  prefs:
  - PREF_IND
  type: TYPE_NORMAL
  zh: '[1, 2, 512]'
- en: '[PRE17]'
  id: totrans-82
  prefs:
  - PREF_IND
  type: TYPE_PRE
  zh: '[PRE17]'
- en: 'Just run the following line to automatically test every docstring example in
    the desired file:'
  id: totrans-83
  prefs: []
  type: TYPE_NORMAL
  zh: åªéœ€è¿è¡Œä»¥ä¸‹è¡Œï¼Œè‡ªåŠ¨æµ‹è¯•æ‰€éœ€æ–‡ä»¶ä¸­çš„æ¯ä¸ªæ–‡æ¡£å­—ç¬¦ä¸²ç¤ºä¾‹ï¼š
- en: '[PRE18]'
  id: totrans-84
  prefs: []
  type: TYPE_PRE
  zh: '[PRE18]'
- en: If the file has a markdown extention, you should add the `--doctest-glob="*.md"`
    argument.
  id: totrans-85
  prefs: []
  type: TYPE_NORMAL
  zh: å¦‚æžœæ–‡ä»¶å…·æœ‰markdownæ‰©å±•åï¼Œåº”æ·»åŠ `--doctest-glob="*.md"`å‚æ•°ã€‚
- en: Run only modified tests
  id: totrans-86
  prefs:
  - PREF_H3
  type: TYPE_NORMAL
  zh: ä»…è¿è¡Œä¿®æ”¹åŽçš„æµ‹è¯•
- en: You can run the tests related to the unstaged files or the current branch (according
    to Git) by using [pytest-picked](https://github.com/anapaulagomes/pytest-picked).
    This is a great way of quickly testing your changes didnâ€™t break anything, since
    it wonâ€™t run the tests related to files you didnâ€™t touch.
  id: totrans-87
  prefs: []
  type: TYPE_NORMAL
  zh: æ‚¨å¯ä»¥é€šè¿‡ä½¿ç”¨[pytest-picked](https://github.com/anapaulagomes/pytest-picked)æ¥è¿è¡Œä¸Žæœªæš‚å­˜æ–‡ä»¶æˆ–å½“å‰åˆ†æ”¯ï¼ˆæ ¹æ®Gitï¼‰ç›¸å…³çš„æµ‹è¯•ã€‚è¿™æ˜¯ä¸€ä¸ªå¿«é€Ÿæµ‹è¯•æ‚¨çš„æ›´æ”¹æ˜¯å¦ç ´åäº†ä»»ä½•å†…å®¹çš„å¥½æ–¹æ³•ï¼Œå› ä¸ºå®ƒä¸ä¼šè¿è¡Œä¸Žæ‚¨æœªè§¦åŠçš„æ–‡ä»¶ç›¸å…³çš„æµ‹è¯•ã€‚
- en: '[PRE19]'
  id: totrans-88
  prefs: []
  type: TYPE_PRE
  zh: '[PRE19]'
- en: '[PRE20]'
  id: totrans-89
  prefs: []
  type: TYPE_PRE
  zh: '[PRE20]'
- en: All tests will be run from files and folders which are modified, but not yet
    committed.
  id: totrans-90
  prefs: []
  type: TYPE_NORMAL
  zh: å°†ä»Žå·²ä¿®æ”¹ä½†å°šæœªæäº¤çš„æ–‡ä»¶å’Œæ–‡ä»¶å¤¹ä¸­è¿è¡Œæ‰€æœ‰æµ‹è¯•ã€‚
- en: Automatically rerun failed tests on source modification
  id: totrans-91
  prefs:
  - PREF_H3
  type: TYPE_NORMAL
  zh: åœ¨æºä»£ç ä¿®æ”¹æ—¶è‡ªåŠ¨é‡æ–°è¿è¡Œå¤±è´¥çš„æµ‹è¯•
- en: '[pytest-xdist](https://github.com/pytest-dev/pytest-xdist) provides a very
    useful feature of detecting all failed tests, and then waiting for you to modify
    files and continuously re-rerun those failing tests until they pass while you
    fix them. So that you donâ€™t need to re start pytest after you made the fix. This
    is repeated until all tests pass after which again a full run is performed.'
  id: totrans-92
  prefs: []
  type: TYPE_NORMAL
  zh: '[pytest-xdist](https://github.com/pytest-dev/pytest-xdist)æä¾›äº†ä¸€ä¸ªéžå¸¸æœ‰ç”¨çš„åŠŸèƒ½ï¼Œå¯ä»¥æ£€æµ‹æ‰€æœ‰å¤±è´¥çš„æµ‹è¯•ï¼Œç„¶åŽç­‰å¾…æ‚¨ä¿®æ”¹æ–‡ä»¶å¹¶æŒç»­é‡æ–°è¿è¡Œè¿™äº›å¤±è´¥çš„æµ‹è¯•ï¼Œç›´åˆ°å®ƒä»¬é€šè¿‡ï¼ŒåŒæ—¶æ‚¨ä¿®å¤å®ƒä»¬ã€‚è¿™å°†é‡å¤è¿›è¡Œï¼Œç›´åˆ°æ‰€æœ‰æµ‹è¯•é€šè¿‡ï¼Œä¹‹åŽå†æ¬¡æ‰§è¡Œå®Œæ•´è¿è¡Œã€‚'
- en: '[PRE21]'
  id: totrans-93
  prefs: []
  type: TYPE_PRE
  zh: '[PRE21]'
- en: 'To enter the mode: `pytest -f` or `pytest --looponfail`'
  id: totrans-94
  prefs: []
  type: TYPE_NORMAL
  zh: è¦è¿›å…¥æ¨¡å¼ï¼š`pytest -f`æˆ–`pytest --looponfail`
- en: 'File changes are detected by looking at `looponfailroots` root directories
    and all of their contents (recursively). If the default for this value does not
    work for you, you can change it in your project by setting a configuration option
    in `setup.cfg`:'
  id: totrans-95
  prefs: []
  type: TYPE_NORMAL
  zh: é€šè¿‡æŸ¥çœ‹`looponfailroots`æ ¹ç›®å½•åŠå…¶æ‰€æœ‰å†…å®¹ï¼ˆé€’å½’ï¼‰æ¥æ£€æµ‹æ–‡ä»¶æ›´æ”¹ã€‚å¦‚æžœæ­¤å€¼çš„é»˜è®¤å€¼å¯¹æ‚¨ä¸èµ·ä½œç”¨ï¼Œæ‚¨å¯ä»¥é€šè¿‡åœ¨`setup.cfg`ä¸­è®¾ç½®é…ç½®é€‰é¡¹æ¥æ›´æ”¹é¡¹ç›®ä¸­çš„å€¼ï¼š
- en: '[PRE22]'
  id: totrans-96
  prefs: []
  type: TYPE_PRE
  zh: '[PRE22]'
- en: 'or `pytest.ini`/`tox.ini` files:'
  id: totrans-97
  prefs: []
  type: TYPE_NORMAL
  zh: æˆ–`pytest.ini`/`tox.ini`æ–‡ä»¶ï¼š
- en: '[PRE23]'
  id: totrans-98
  prefs: []
  type: TYPE_PRE
  zh: '[PRE23]'
- en: This would lead to only looking for file changes in the respective directories,
    specified relatively to the ini-fileâ€™s directory.
  id: totrans-99
  prefs: []
  type: TYPE_NORMAL
  zh: è¿™å°†å¯¼è‡´ä»…æŸ¥æ‰¾ç›¸å¯¹äºŽiniæ–‡ä»¶ç›®å½•æŒ‡å®šçš„ç›¸åº”ç›®å½•ä¸­çš„æ–‡ä»¶æ›´æ”¹ã€‚
- en: '[pytest-watch](https://github.com/joeyespo/pytest-watch) is an alternative
    implementation of this functionality.'
  id: totrans-100
  prefs: []
  type: TYPE_NORMAL
  zh: '[pytest-watch](https://github.com/joeyespo/pytest-watch)æ˜¯æ­¤åŠŸèƒ½çš„å¦ä¸€ç§å®žçŽ°ã€‚'
- en: Skip a test module
  id: totrans-101
  prefs:
  - PREF_H3
  type: TYPE_NORMAL
  zh: è·³è¿‡ä¸€ä¸ªæµ‹è¯•æ¨¡å—
- en: 'If you want to run all test modules, except a few you can exclude them by giving
    an explicit list of tests to run. For example, to run all except `test_modeling_*.py`
    tests:'
  id: totrans-102
  prefs: []
  type: TYPE_NORMAL
  zh: å¦‚æžœæ‚¨æƒ³è¿è¡Œæ‰€æœ‰æµ‹è¯•æ¨¡å—ï¼Œé™¤äº†ä¸€äº›ï¼Œæ‚¨å¯ä»¥é€šè¿‡æä¾›ä¸€ä¸ªæ˜Žç¡®çš„æµ‹è¯•è¿è¡Œåˆ—è¡¨æ¥æŽ’é™¤å®ƒä»¬ã€‚ä¾‹å¦‚ï¼Œè¦è¿è¡Œé™¤äº†`test_modeling_*.py`æµ‹è¯•ä¹‹å¤–çš„æ‰€æœ‰æµ‹è¯•ï¼š
- en: '[PRE24]'
  id: totrans-103
  prefs: []
  type: TYPE_PRE
  zh: '[PRE24]'
- en: Clearing state
  id: totrans-104
  prefs:
  - PREF_H3
  type: TYPE_NORMAL
  zh: æ¸…é™¤çŠ¶æ€
- en: 'CI builds and when isolation is important (against speed), cache should be
    cleared:'
  id: totrans-105
  prefs: []
  type: TYPE_NORMAL
  zh: CIæž„å»ºå’Œéš”ç¦»é‡è¦æ—¶ï¼ˆé’ˆå¯¹é€Ÿåº¦ï¼‰ï¼Œåº”æ¸…é™¤ç¼“å­˜ï¼š
- en: '[PRE25]'
  id: totrans-106
  prefs: []
  type: TYPE_PRE
  zh: '[PRE25]'
- en: Running tests in parallel
  id: totrans-107
  prefs:
  - PREF_H3
  type: TYPE_NORMAL
  zh: å¹¶è¡Œè¿è¡Œæµ‹è¯•
- en: As mentioned earlier `make test` runs tests in parallel via `pytest-xdist` plugin
    (`-n X` argument, e.g. `-n 2` to run 2 parallel jobs).
  id: totrans-108
  prefs: []
  type: TYPE_NORMAL
  zh: å¦‚å‰æ‰€è¿°ï¼Œ`make test`é€šè¿‡`pytest-xdist`æ’ä»¶ï¼ˆ`-n X`å‚æ•°ï¼Œä¾‹å¦‚`-n 2`ä»¥è¿è¡Œ2ä¸ªå¹¶è¡Œä½œä¸šï¼‰å¹¶è¡Œè¿è¡Œæµ‹è¯•ã€‚
- en: '`pytest-xdist`â€™s `--dist=` option allows one to control how the tests are grouped.
    `--dist=loadfile` puts the tests located in one file onto the same process.'
  id: totrans-109
  prefs: []
  type: TYPE_NORMAL
  zh: '`pytest-xdist`çš„`--dist=`é€‰é¡¹å…è®¸æŽ§åˆ¶å¦‚ä½•å¯¹æµ‹è¯•è¿›è¡Œåˆ†ç»„ã€‚`--dist=loadfile`å°†ä½äºŽä¸€ä¸ªæ–‡ä»¶ä¸­çš„æµ‹è¯•æ”¾åœ¨åŒä¸€ä¸ªè¿›ç¨‹ä¸­ã€‚'
- en: Since the order of executed tests is different and unpredictable, if running
    the test suite with `pytest-xdist` produces failures (meaning we have some undetected
    coupled tests), use [pytest-replay](https://github.com/ESSS/pytest-replay) to
    replay the tests in the same order, which should help with then somehow reducing
    that failing sequence to a minimum.
  id: totrans-110
  prefs: []
  type: TYPE_NORMAL
  zh: ç”±äºŽæ‰§è¡Œæµ‹è¯•çš„é¡ºåºä¸åŒä¸”ä¸å¯é¢„æµ‹ï¼Œå¦‚æžœä½¿ç”¨`pytest-xdist`è¿è¡Œæµ‹è¯•å¥—ä»¶ä¼šäº§ç”Ÿå¤±è´¥ï¼ˆæ„å‘³ç€æˆ‘ä»¬æœ‰ä¸€äº›æœªæ£€æµ‹åˆ°çš„è€¦åˆæµ‹è¯•ï¼‰ï¼Œè¯·ä½¿ç”¨[pytest-replay](https://github.com/ESSS/pytest-replay)ä»¥ç›¸åŒé¡ºåºé‡æ”¾æµ‹è¯•ï¼Œè¿™åº”è¯¥æœ‰åŠ©äºŽä»¥æŸç§æ–¹å¼å°†å¤±è´¥åºåˆ—å‡å°‘åˆ°æœ€å°ã€‚
- en: Test order and repetition
  id: totrans-111
  prefs:
  - PREF_H3
  type: TYPE_NORMAL
  zh: æµ‹è¯•é¡ºåºå’Œé‡å¤
- en: Itâ€™s good to repeat the tests several times, in sequence, randomly, or in sets,
    to detect any potential inter-dependency and state-related bugs (tear down). And
    the straightforward multiple repetition is just good to detect some problems that
    get uncovered by randomness of DL.
  id: totrans-112
  prefs: []
  type: TYPE_NORMAL
  zh: æœ€å¥½å¤šæ¬¡é‡å¤æµ‹è¯•ï¼ŒæŒ‰é¡ºåºã€éšæœºæˆ–æˆç»„è¿›è¡Œï¼Œä»¥æ£€æµ‹ä»»ä½•æ½œåœ¨çš„ç›¸äº’ä¾èµ–å’Œä¸ŽçŠ¶æ€ç›¸å…³çš„é”™è¯¯ï¼ˆæ‹†é™¤ï¼‰ã€‚ç›´æŽ¥çš„å¤šæ¬¡é‡å¤åªæ˜¯ç”¨æ¥æ£€æµ‹ç”±äºŽDLçš„éšæœºæ€§è€Œæš´éœ²å‡ºçš„ä¸€äº›é—®é¢˜ã€‚
- en: Repeat tests
  id: totrans-113
  prefs:
  - PREF_H4
  type: TYPE_NORMAL
  zh: é‡å¤æµ‹è¯•
- en: '[pytest-flakefinder](https://github.com/dropbox/pytest-flakefinder):'
  id: totrans-114
  prefs:
  - PREF_UL
  type: TYPE_NORMAL
  zh: '[pytest-flakefinder](https://github.com/dropbox/pytest-flakefinder)ï¼š'
- en: '[PRE26]'
  id: totrans-115
  prefs: []
  type: TYPE_PRE
  zh: '[PRE26]'
- en: 'And then run every test multiple times (50 by default):'
  id: totrans-116
  prefs: []
  type: TYPE_NORMAL
  zh: ç„¶åŽå¤šæ¬¡è¿è¡Œæ¯ä¸ªæµ‹è¯•ï¼ˆé»˜è®¤ä¸º50æ¬¡ï¼‰ï¼š
- en: '[PRE27]'
  id: totrans-117
  prefs: []
  type: TYPE_PRE
  zh: '[PRE27]'
- en: This plugin doesnâ€™t work with `-n` flag from `pytest-xdist`.
  id: totrans-118
  prefs: []
  type: TYPE_NORMAL
  zh: æ­¤æ’ä»¶ä¸ä¸Ž`pytest-xdist`çš„`-n`æ ‡å¿—ä¸€èµ·ä½¿ç”¨ã€‚
- en: There is another plugin `pytest-repeat`, but it doesnâ€™t work with `unittest`.
  id: totrans-119
  prefs: []
  type: TYPE_NORMAL
  zh: è¿˜æœ‰å¦ä¸€ä¸ªæ’ä»¶`pytest-repeat`ï¼Œä½†å®ƒä¸Ž`unittest`ä¸å…¼å®¹ã€‚
- en: Run tests in a random order
  id: totrans-120
  prefs:
  - PREF_H4
  type: TYPE_NORMAL
  zh: ä»¥éšæœºé¡ºåºè¿è¡Œæµ‹è¯•
- en: '[PRE28]'
  id: totrans-121
  prefs: []
  type: TYPE_PRE
  zh: '[PRE28]'
- en: 'Important: the presence of `pytest-random-order` will automatically randomize
    tests, no configuration change or command line options is required.'
  id: totrans-122
  prefs: []
  type: TYPE_NORMAL
  zh: é‡è¦æç¤ºï¼šå­˜åœ¨`pytest-random-order`å°†è‡ªåŠ¨éšæœºåŒ–æµ‹è¯•ï¼Œæ— éœ€æ›´æ”¹é…ç½®æˆ–å‘½ä»¤è¡Œé€‰é¡¹ã€‚
- en: 'As explained earlier this allows detection of coupled tests - where one testâ€™s
    state affects the state of another. When `pytest-random-order` is installed it
    will print the random seed it used for that session, e.g:'
  id: totrans-123
  prefs: []
  type: TYPE_NORMAL
  zh: æ­£å¦‚å‰é¢æ‰€è§£é‡Šçš„ï¼Œè¿™å…è®¸æ£€æµ‹è€¦åˆæµ‹è¯• - ä¸€ä¸ªæµ‹è¯•çš„çŠ¶æ€å½±å“å¦ä¸€ä¸ªæµ‹è¯•çš„çŠ¶æ€ã€‚å½“å®‰è£…äº†`pytest-random-order`æ—¶ï¼Œå®ƒå°†æ‰“å°ç”¨äºŽè¯¥ä¼šè¯çš„éšæœºç§å­ï¼Œä¾‹å¦‚ï¼š
- en: '[PRE29]'
  id: totrans-124
  prefs: []
  type: TYPE_PRE
  zh: '[PRE29]'
- en: 'So that if the given particular sequence fails, you can reproduce it by adding
    that exact seed, e.g.:'
  id: totrans-125
  prefs: []
  type: TYPE_NORMAL
  zh: å› æ­¤ï¼Œå¦‚æžœç»™å®šçš„ç‰¹å®šé¡ºåºå¤±è´¥ï¼Œæ‚¨å¯ä»¥é€šè¿‡æ·»åŠ ç¡®åˆ‡çš„ç§å­æ¥é‡çŽ°å®ƒï¼Œä¾‹å¦‚ï¼š
- en: '[PRE30]'
  id: totrans-126
  prefs: []
  type: TYPE_PRE
  zh: '[PRE30]'
- en: 'It will only reproduce the exact order if you use the exact same list of tests
    (or no list at all). Once you start to manually narrowing down the list you can
    no longer rely on the seed, but have to list them manually in the exact order
    they failed and tell pytest to not randomize them instead using `--random-order-bucket=none`,
    e.g.:'
  id: totrans-127
  prefs: []
  type: TYPE_NORMAL
  zh: åªæœ‰åœ¨ä½¿ç”¨å®Œå…¨ç›¸åŒçš„æµ‹è¯•åˆ—è¡¨ï¼ˆæˆ–æ ¹æœ¬æ²¡æœ‰åˆ—è¡¨ï¼‰æ—¶ï¼Œå®ƒæ‰ä¼šé‡çŽ°ç¡®åˆ‡çš„é¡ºåºã€‚ä¸€æ—¦å¼€å§‹æ‰‹åŠ¨ç¼©å°åˆ—è¡¨ï¼Œå°±ä¸èƒ½å†ä¾èµ–ç§å­ï¼Œè€Œå¿…é¡»æŒ‰ç…§å®ƒä»¬å¤±è´¥çš„ç¡®åˆ‡é¡ºåºæ‰‹åŠ¨åˆ—å‡ºå®ƒä»¬ï¼Œå¹¶å‘Šè¯‰pytestä¸è¦éšæœºåŒ–å®ƒä»¬ï¼Œè€Œæ˜¯ä½¿ç”¨`--random-order-bucket=none`ï¼Œä¾‹å¦‚ï¼š
- en: '[PRE31]'
  id: totrans-128
  prefs: []
  type: TYPE_PRE
  zh: '[PRE31]'
- en: 'To disable the shuffling for all tests:'
  id: totrans-129
  prefs: []
  type: TYPE_NORMAL
  zh: è¦ç¦ç”¨æ‰€æœ‰æµ‹è¯•çš„æ´—ç‰Œï¼š
- en: '[PRE32]'
  id: totrans-130
  prefs: []
  type: TYPE_PRE
  zh: '[PRE32]'
- en: By default `--random-order-bucket=module` is implied, which will shuffle the
    files on the module levels. It can also shuffle on `class`, `package`, `global`
    and `none` levels. For the complete details please see its [documentation](https://github.com/jbasko/pytest-random-order).
  id: totrans-131
  prefs: []
  type: TYPE_NORMAL
  zh: é»˜è®¤æƒ…å†µä¸‹ï¼Œéšå«`--random-order-bucket=module`ï¼Œè¿™å°†åœ¨æ¨¡å—çº§åˆ«å¯¹æ–‡ä»¶è¿›è¡Œæ´—ç‰Œã€‚å®ƒè¿˜å¯ä»¥åœ¨`class`ã€`package`ã€`global`å’Œ`none`çº§åˆ«è¿›è¡Œæ´—ç‰Œã€‚æœ‰å…³å®Œæ•´è¯¦æƒ…ï¼Œè¯·å‚é˜…å…¶[æ–‡æ¡£](https://github.com/jbasko/pytest-random-order)ã€‚
- en: 'Another randomization alternative is: [`pytest-randomly`](https://github.com/pytest-dev/pytest-randomly).
    This module has a very similar functionality/interface, but it doesnâ€™t have the
    bucket modes available in `pytest-random-order`. It has the same problem of imposing
    itself once installed.'
  id: totrans-132
  prefs: []
  type: TYPE_NORMAL
  zh: å¦ä¸€ä¸ªéšæœºåŒ–çš„æ›¿ä»£æ–¹æ¡ˆæ˜¯ï¼š[`pytest-randomly`](https://github.com/pytest-dev/pytest-randomly)ã€‚è¿™ä¸ªæ¨¡å—å…·æœ‰éžå¸¸ç›¸ä¼¼çš„åŠŸèƒ½/æŽ¥å£ï¼Œä½†å®ƒæ²¡æœ‰`pytest-random-order`ä¸­å¯ç”¨çš„æ¡¶æ¨¡å¼ã€‚ä¸€æ—¦å®‰è£…ï¼Œå®ƒä¹Ÿä¼šå¼ºåˆ¶è‡ªèº«ã€‚
- en: Look and feel variations
  id: totrans-133
  prefs:
  - PREF_H3
  type: TYPE_NORMAL
  zh: å¤–è§‚å’Œæ„Ÿè§‰å˜åŒ–
- en: pytest-sugar
  id: totrans-134
  prefs:
  - PREF_H4
  type: TYPE_NORMAL
  zh: pytest-sugar
- en: '[pytest-sugar](https://github.com/Frozenball/pytest-sugar) is a plugin that
    improves the look-n-feel, adds a progressbar, and show tests that fail and the
    assert instantly. It gets activated automatically upon installation.'
  id: totrans-135
  prefs: []
  type: TYPE_NORMAL
  zh: '[pytest-sugar](https://github.com/Frozenball/pytest-sugar) æ˜¯ä¸€ä¸ªæ’ä»¶ï¼Œå¯ä»¥æ”¹å–„å¤–è§‚å’Œæ„Ÿè§‰ï¼Œæ·»åŠ è¿›åº¦æ¡ï¼Œå¹¶ç«‹å³æ˜¾ç¤ºå¤±è´¥çš„æµ‹è¯•å’Œæ–­è¨€ã€‚å®‰è£…åŽä¼šè‡ªåŠ¨æ¿€æ´»ã€‚'
- en: '[PRE33]'
  id: totrans-136
  prefs: []
  type: TYPE_PRE
  zh: '[PRE33]'
- en: 'To run tests without it, run:'
  id: totrans-137
  prefs: []
  type: TYPE_NORMAL
  zh: è¦åœ¨æ²¡æœ‰å®ƒçš„æƒ…å†µä¸‹è¿è¡Œæµ‹è¯•ï¼Œè¯·è¿è¡Œï¼š
- en: '[PRE34]'
  id: totrans-138
  prefs: []
  type: TYPE_PRE
  zh: '[PRE34]'
- en: or uninstall it.
  id: totrans-139
  prefs: []
  type: TYPE_NORMAL
  zh: æˆ–è€…å¸è½½å®ƒã€‚
- en: Report each sub-test name and its progress
  id: totrans-140
  prefs:
  - PREF_H4
  type: TYPE_NORMAL
  zh: æŠ¥å‘Šæ¯ä¸ªå­æµ‹è¯•çš„åç§°åŠå…¶è¿›åº¦
- en: 'For a single or a group of tests via `pytest` (after `pip install pytest-pspec`):'
  id: totrans-141
  prefs: []
  type: TYPE_NORMAL
  zh: é€šè¿‡`pytest`è¿è¡Œå•ä¸ªæˆ–ä¸€ç»„æµ‹è¯•ï¼ˆåœ¨`pip install pytest-pspec`ä¹‹åŽï¼‰ï¼š
- en: '[PRE35]'
  id: totrans-142
  prefs: []
  type: TYPE_PRE
  zh: '[PRE35]'
- en: Instantly shows failed tests
  id: totrans-143
  prefs:
  - PREF_H4
  type: TYPE_NORMAL
  zh: ç«‹å³æ˜¾ç¤ºå¤±è´¥çš„æµ‹è¯•
- en: '[pytest-instafail](https://github.com/pytest-dev/pytest-instafail) shows failures
    and errors instantly instead of waiting until the end of test session.'
  id: totrans-144
  prefs: []
  type: TYPE_NORMAL
  zh: '[pytest-instafail](https://github.com/pytest-dev/pytest-instafail) ç«‹å³æ˜¾ç¤ºå¤±è´¥å’Œé”™è¯¯ï¼Œè€Œä¸æ˜¯ç­‰åˆ°æµ‹è¯•ä¼šè¯ç»“æŸã€‚'
- en: '[PRE36]'
  id: totrans-145
  prefs: []
  type: TYPE_PRE
  zh: '[PRE36]'
- en: '[PRE37]'
  id: totrans-146
  prefs: []
  type: TYPE_PRE
  zh: '[PRE37]'
- en: To GPU or not to GPU
  id: totrans-147
  prefs:
  - PREF_H3
  type: TYPE_NORMAL
  zh: è¦GPUè¿˜æ˜¯ä¸è¦GPU
- en: 'On a GPU-enabled setup, to test in CPU-only mode add `CUDA_VISIBLE_DEVICES=""`:'
  id: totrans-148
  prefs: []
  type: TYPE_NORMAL
  zh: åœ¨å¯ç”¨GPUçš„è®¾ç½®ä¸­ï¼Œè¦åœ¨ä»…CPUæ¨¡å¼ä¸‹æµ‹è¯•ï¼Œè¯·æ·»åŠ `CUDA_VISIBLE_DEVICES=""`ï¼š
- en: '[PRE38]'
  id: totrans-149
  prefs: []
  type: TYPE_PRE
  zh: '[PRE38]'
- en: 'or if you have multiple gpus, you can specify which one is to be used by `pytest`.
    For example, to use only the second gpu if you have gpus `0` and `1`, you can
    run:'
  id: totrans-150
  prefs: []
  type: TYPE_NORMAL
  zh: æˆ–è€…å¦‚æžœæ‚¨æœ‰å¤šä¸ªGPUï¼Œå¯ä»¥æŒ‡å®š`pytest`è¦ä½¿ç”¨çš„GPUã€‚ä¾‹å¦‚ï¼Œå¦‚æžœæ‚¨æœ‰GPU `0` å’Œ `1`ï¼Œåˆ™å¯ä»¥ä»…ä½¿ç”¨ç¬¬äºŒä¸ªGPUè¿è¡Œï¼š
- en: '[PRE39]'
  id: totrans-151
  prefs: []
  type: TYPE_PRE
  zh: '[PRE39]'
- en: This is handy when you want to run different tasks on different GPUs.
  id: totrans-152
  prefs: []
  type: TYPE_NORMAL
  zh: è¿™åœ¨æ‚¨æƒ³è¦åœ¨ä¸åŒçš„GPUä¸Šè¿è¡Œä¸åŒä»»åŠ¡æ—¶éžå¸¸æ–¹ä¾¿ã€‚
- en: 'Some tests must be run on CPU-only, others on either CPU or GPU or TPU, yet
    others on multiple-GPUs. The following skip decorators are used to set the requirements
    of tests CPU/GPU/TPU-wise:'
  id: totrans-153
  prefs: []
  type: TYPE_NORMAL
  zh: ä¸€äº›æµ‹è¯•å¿…é¡»åœ¨ä»…CPUä¸Šè¿è¡Œï¼Œå…¶ä»–æµ‹è¯•å¯ä»¥åœ¨CPUæˆ–GPUæˆ–TPUä¸Šè¿è¡Œï¼Œå¦ä¸€äº›æµ‹è¯•å¯ä»¥åœ¨å¤šä¸ªGPUä¸Šè¿è¡Œã€‚ä»¥ä¸‹è·³è¿‡è£…é¥°å™¨ç”¨äºŽè®¾ç½®æµ‹è¯•çš„CPU/GPU/TPUè¦æ±‚ï¼š
- en: '`require_torch` - this test will run only under torch'
  id: totrans-154
  prefs:
  - PREF_UL
  type: TYPE_NORMAL
  zh: '`require_torch` - æ­¤æµ‹è¯•ä»…åœ¨torchä¸‹è¿è¡Œ'
- en: '`require_torch_gpu` - as `require_torch` plus requires at least 1 GPU'
  id: totrans-155
  prefs:
  - PREF_UL
  type: TYPE_NORMAL
  zh: '`require_torch_gpu` - ä¸Ž`require_torch`ç›¸åŒï¼Œè‡³å°‘éœ€è¦1ä¸ªGPU'
- en: '`require_torch_multi_gpu` - as `require_torch` plus requires at least 2 GPUs'
  id: totrans-156
  prefs:
  - PREF_UL
  type: TYPE_NORMAL
  zh: '`require_torch_multi_gpu` - ä¸Ž`require_torch`ç›¸åŒï¼Œè‡³å°‘éœ€è¦2ä¸ªGPU'
- en: '`require_torch_non_multi_gpu` - as `require_torch` plus requires 0 or 1 GPUs'
  id: totrans-157
  prefs:
  - PREF_UL
  type: TYPE_NORMAL
  zh: '`require_torch_non_multi_gpu` - ä¸Ž`require_torch`ç›¸åŒï¼Œéœ€è¦0ä¸ªæˆ–1ä¸ªGPU'
- en: '`require_torch_up_to_2_gpus` - as `require_torch` plus requires 0 or 1 or 2
    GPUs'
  id: totrans-158
  prefs:
  - PREF_UL
  type: TYPE_NORMAL
  zh: '`require_torch_up_to_2_gpus` - ä¸Ž`require_torch`ç›¸åŒï¼Œéœ€è¦0ä¸ªæˆ–1ä¸ªæˆ–2ä¸ªGPU'
- en: '`require_torch_tpu` - as `require_torch` plus requires at least 1 TPU'
  id: totrans-159
  prefs:
  - PREF_UL
  type: TYPE_NORMAL
  zh: '`require_torch_tpu` - ä¸Ž`require_torch`ç›¸åŒï¼Œè‡³å°‘éœ€è¦1ä¸ªTPU'
- en: 'Letâ€™s depict the GPU requirements in the following table:'
  id: totrans-160
  prefs: []
  type: TYPE_NORMAL
  zh: è®©æˆ‘ä»¬åœ¨ä¸‹è¡¨ä¸­æè¿°GPUè¦æ±‚ï¼š
- en: '| n gpus | decorator | |--------+--------------------------------| | `>= 0`
    | `@require_torch` | | `>= 1` | `@require_torch_gpu` | | `>= 2` | `@require_torch_multi_gpu`
    | | `< 2` | `@require_torch_non_multi_gpu` | | `< 3` | `@require_torch_up_to_2_gpus`
    |'
  id: totrans-161
  prefs: []
  type: TYPE_TB
  zh: '| nä¸ªGPU | è£…é¥°å™¨ | |--------+--------------------------------| | `>= 0` | `@require_torch`
    | | `>= 1` | `@require_torch_gpu` | | `>= 2` | `@require_torch_multi_gpu` | |
    `< 2` | `@require_torch_non_multi_gpu` | | `< 3` | `@require_torch_up_to_2_gpus`
    |'
- en: 'For example, here is a test that must be run only when there are 2 or more
    GPUs available and pytorch is installed:'
  id: totrans-162
  prefs: []
  type: TYPE_NORMAL
  zh: ä¾‹å¦‚ï¼Œè¿™æ˜¯ä¸€ä¸ªå¿…é¡»åœ¨æœ‰2ä¸ªæˆ–æ›´å¤šä¸ªGPUå¯ç”¨ä¸”å·²å®‰è£…pytorchæ—¶è¿è¡Œçš„æµ‹è¯•ï¼š
- en: '[PRE40]'
  id: totrans-163
  prefs: []
  type: TYPE_PRE
  zh: '[PRE40]'
- en: 'If a test requires `tensorflow` use the `require_tf` decorator. For example:'
  id: totrans-164
  prefs: []
  type: TYPE_NORMAL
  zh: å¦‚æžœä¸€ä¸ªæµ‹è¯•éœ€è¦`tensorflow`ï¼Œè¯·ä½¿ç”¨`require_tf`è£…é¥°å™¨ã€‚ä¾‹å¦‚ï¼š
- en: '[PRE41]'
  id: totrans-165
  prefs: []
  type: TYPE_PRE
  zh: '[PRE41]'
- en: 'These decorators can be stacked. For example, if a test is slow and requires
    at least one GPU under pytorch, here is how to set it up:'
  id: totrans-166
  prefs: []
  type: TYPE_NORMAL
  zh: è¿™äº›è£…é¥°å™¨å¯ä»¥å åŠ ã€‚ä¾‹å¦‚ï¼Œå¦‚æžœä¸€ä¸ªæµ‹è¯•å¾ˆæ…¢å¹¶ä¸”åœ¨pytorchä¸‹è‡³å°‘éœ€è¦ä¸€ä¸ªGPUï¼Œè¿™æ˜¯å¦‚ä½•è®¾ç½®çš„ï¼š
- en: '[PRE42]'
  id: totrans-167
  prefs: []
  type: TYPE_PRE
  zh: '[PRE42]'
- en: 'Some decorators like `@parametrized` rewrite test names, therefore `@require_*`
    skip decorators have to be listed last for them to work correctly. Here is an
    example of the correct usage:'
  id: totrans-168
  prefs: []
  type: TYPE_NORMAL
  zh: ä¸€äº›è£…é¥°å™¨å¦‚`@parametrized`ä¼šé‡å†™æµ‹è¯•åç§°ï¼Œå› æ­¤`@require_*`è·³è¿‡è£…é¥°å™¨å¿…é¡»åœ¨æœ€åŽåˆ—å‡ºæ‰èƒ½æ­£å¸¸å·¥ä½œã€‚ä»¥ä¸‹æ˜¯æ­£ç¡®ä½¿ç”¨çš„ç¤ºä¾‹ï¼š
- en: '[PRE43]'
  id: totrans-169
  prefs: []
  type: TYPE_PRE
  zh: '[PRE43]'
- en: This order problem doesnâ€™t exist with `@pytest.mark.parametrize`, you can put
    it first or last and it will still work. But it only works with non-unittests.
  id: totrans-170
  prefs: []
  type: TYPE_NORMAL
  zh: è¿™ä¸ªé¡ºåºé—®é¢˜åœ¨`@pytest.mark.parametrize`ä¸­ä¸å­˜åœ¨ï¼Œæ‚¨å¯ä»¥å°†å…¶æ”¾åœ¨æœ€å‰é¢æˆ–æœ€åŽé¢ï¼Œå®ƒä»ç„¶æœ‰æ•ˆã€‚ä½†å®ƒåªé€‚ç”¨äºŽéžå•å…ƒæµ‹è¯•ã€‚
- en: 'Inside tests:'
  id: totrans-171
  prefs: []
  type: TYPE_NORMAL
  zh: åœ¨æµ‹è¯•ä¸­ï¼š
- en: 'How many GPUs are available:'
  id: totrans-172
  prefs:
  - PREF_UL
  type: TYPE_NORMAL
  zh: æœ‰å¤šå°‘ä¸ªGPUå¯ç”¨ï¼š
- en: '[PRE44]'
  id: totrans-173
  prefs: []
  type: TYPE_PRE
  zh: '[PRE44]'
- en: Testing with a specific PyTorch backend or device
  id: totrans-174
  prefs:
  - PREF_H3
  type: TYPE_NORMAL
  zh: ä½¿ç”¨ç‰¹å®šçš„PyTorchåŽç«¯æˆ–è®¾å¤‡è¿›è¡Œæµ‹è¯•
- en: 'To run the test suite on a specific torch device add `TRANSFORMERS_TEST_DEVICE="$device"`
    where `$device` is the target backend. For example, to test on CPU only:'
  id: totrans-175
  prefs: []
  type: TYPE_NORMAL
  zh: è¦åœ¨ç‰¹å®šçš„torchè®¾å¤‡ä¸Šè¿è¡Œæµ‹è¯•å¥—ä»¶ï¼Œè¯·æ·»åŠ `TRANSFORMERS_TEST_DEVICE="$device"`ï¼Œå…¶ä¸­`$device`æ˜¯ç›®æ ‡åŽç«¯ã€‚ä¾‹å¦‚ï¼Œè¦ä»…åœ¨CPUä¸Šæµ‹è¯•ï¼š
- en: '[PRE45]'
  id: totrans-176
  prefs: []
  type: TYPE_PRE
  zh: '[PRE45]'
- en: This variable is useful for testing custom or less common PyTorch backends such
    as `mps`. It can also be used to achieve the same effect as `CUDA_VISIBLE_DEVICES`
    by targeting specific GPUs or testing in CPU-only mode.
  id: totrans-177
  prefs: []
  type: TYPE_NORMAL
  zh: æ­¤å˜é‡å¯¹äºŽæµ‹è¯•è‡ªå®šä¹‰æˆ–ä¸å¤ªå¸¸è§çš„PyTorchåŽç«¯ï¼ˆå¦‚`mps`ï¼‰å¾ˆæœ‰ç”¨ã€‚å®ƒè¿˜å¯ä»¥ç”¨äºŽé€šè¿‡å®šä½ç‰¹å®šGPUæˆ–åœ¨ä»…CPUæ¨¡å¼ä¸‹è¿›è¡Œæµ‹è¯•æ¥å®žçŽ°ä¸Ž`CUDA_VISIBLE_DEVICES`ç›¸åŒçš„æ•ˆæžœã€‚
- en: 'Certain devices will require an additional import after importing `torch` for
    the first time. This can be specified using the environment variable `TRANSFORMERS_TEST_BACKEND`:'
  id: totrans-178
  prefs: []
  type: TYPE_NORMAL
  zh: åœ¨ç¬¬ä¸€æ¬¡å¯¼å…¥`torch`åŽï¼ŒæŸäº›è®¾å¤‡å°†éœ€è¦é¢å¤–çš„å¯¼å…¥ã€‚è¿™å¯ä»¥ä½¿ç”¨çŽ¯å¢ƒå˜é‡`TRANSFORMERS_TEST_BACKEND`æŒ‡å®šï¼š
- en: '[PRE46]'
  id: totrans-179
  prefs: []
  type: TYPE_PRE
  zh: '[PRE46]'
- en: 'Alternative backends may also require the replacement of device-specific functions.
    For example `torch.cuda.manual_seed` may need to be replaced with a device-specific
    seed setter like `torch.npu.manual_seed` to correctly set a random seed on the
    device. To specify a new backend with backend-specific device functions when running
    the test suite, create a Python device specification file in the format:'
  id: totrans-180
  prefs: []
  type: TYPE_NORMAL
  zh: æ›¿ä»£åŽç«¯å¯èƒ½è¿˜éœ€è¦æ›¿æ¢ç‰¹å®šäºŽè®¾å¤‡çš„å‡½æ•°ã€‚ä¾‹å¦‚ï¼Œ`torch.cuda.manual_seed`å¯èƒ½éœ€è¦æ›¿æ¢ä¸ºç‰¹å®šäºŽè®¾å¤‡çš„ç§å­è®¾ç½®å™¨ï¼Œå¦‚`torch.npu.manual_seed`ï¼Œä»¥æ­£ç¡®è®¾ç½®è®¾å¤‡ä¸Šçš„éšæœºç§å­ã€‚åœ¨è¿è¡Œæµ‹è¯•å¥—ä»¶æ—¶æŒ‡å®šæ–°çš„åŽç«¯å’ŒåŽç«¯ç‰¹å®šè®¾å¤‡å‡½æ•°æ—¶ï¼Œåˆ›å»ºä¸€ä¸ªPythonè®¾å¤‡è§„èŒƒæ–‡ä»¶ï¼Œæ ¼å¼å¦‚ä¸‹ï¼š
- en: '[PRE47]'
  id: totrans-181
  prefs: []
  type: TYPE_PRE
  zh: '[PRE47]'
- en: This format also allows for specification of any additional imports required.
    To use this file to replace equivalent methods in the test suite, set the environment
    variable `TRANSFORMERS_TEST_DEVICE_SPEC` to the path of the spec file.
  id: totrans-182
  prefs: []
  type: TYPE_NORMAL
  zh: æ­¤æ ¼å¼è¿˜å…è®¸æŒ‡å®šæ‰€éœ€çš„ä»»ä½•å…¶ä»–å¯¼å…¥ã€‚è¦ä½¿ç”¨æ­¤æ–‡ä»¶æ›¿æ¢æµ‹è¯•å¥—ä»¶ä¸­çš„ç­‰æ•ˆæ–¹æ³•ï¼Œè¯·å°†çŽ¯å¢ƒå˜é‡`TRANSFORMERS_TEST_DEVICE_SPEC`è®¾ç½®ä¸ºè§„èŒƒæ–‡ä»¶çš„è·¯å¾„ã€‚
- en: Currently, only `MANUAL_SEED_FN`, `EMPTY_CACHE_FN` and `DEVICE_COUNT_FN` are
    supported for device-specific dispatch.
  id: totrans-183
  prefs: []
  type: TYPE_NORMAL
  zh: ç›®å‰ï¼Œåªæ”¯æŒ`MANUAL_SEED_FN`ã€`EMPTY_CACHE_FN`å’Œ`DEVICE_COUNT_FN`ç”¨äºŽç‰¹å®šè®¾å¤‡çš„åˆ†å‘ã€‚
- en: Distributed training
  id: totrans-184
  prefs:
  - PREF_H3
  type: TYPE_NORMAL
  zh: åˆ†å¸ƒå¼è®­ç»ƒ
- en: '`pytest` canâ€™t deal with distributed training directly. If this is attempted
    - the sub-processes donâ€™t do the right thing and end up thinking they are `pytest`
    and start running the test suite in loops. It works, however, if one spawns a
    normal process that then spawns off multiple workers and manages the IO pipes.'
  id: totrans-185
  prefs: []
  type: TYPE_NORMAL
  zh: '`pytest`ä¸èƒ½ç›´æŽ¥å¤„ç†åˆ†å¸ƒå¼è®­ç»ƒã€‚å¦‚æžœå°è¯•è¿™æ ·åš-å­è¿›ç¨‹ä¸ä¼šåšæ­£ç¡®çš„äº‹æƒ…ï¼Œæœ€ç»ˆä¼šè®¤ä¸ºå®ƒä»¬æ˜¯`pytest`å¹¶å¼€å§‹å¾ªçŽ¯è¿è¡Œæµ‹è¯•å¥—ä»¶ã€‚ä½†æ˜¯ï¼Œå¦‚æžœç”Ÿæˆä¸€ä¸ªæ­£å¸¸è¿›ç¨‹ï¼Œç„¶åŽç”Ÿæˆå¤šä¸ªå·¥ä½œè¿›ç¨‹å¹¶ç®¡ç†IOç®¡é“ï¼Œåˆ™å¯ä»¥æ­£å¸¸å·¥ä½œã€‚'
- en: 'Here are some tests that use it:'
  id: totrans-186
  prefs: []
  type: TYPE_NORMAL
  zh: ä»¥ä¸‹æ˜¯ä¸€äº›ä½¿ç”¨å®ƒçš„æµ‹è¯•ï¼š
- en: '[test_trainer_distributed.py](https://github.com/huggingface/transformers/tree/main/tests/trainer/test_trainer_distributed.py)'
  id: totrans-187
  prefs:
  - PREF_UL
  type: TYPE_NORMAL
  zh: '[test_trainer_distributed.py](https://github.com/huggingface/transformers/tree/main/tests/trainer/test_trainer_distributed.py)'
- en: '[test_deepspeed.py](https://github.com/huggingface/transformers/tree/main/tests/deepspeed/test_deepspeed.py)'
  id: totrans-188
  prefs:
  - PREF_UL
  type: TYPE_NORMAL
  zh: '[test_deepspeed.py](https://github.com/huggingface/transformers/tree/main/tests/deepspeed/test_deepspeed.py)'
- en: To jump right into the execution point, search for the `execute_subprocess_async`
    call in those tests.
  id: totrans-189
  prefs: []
  type: TYPE_NORMAL
  zh: è¦ç›´æŽ¥è·³è½¬åˆ°æ‰§è¡Œç‚¹ï¼Œè¯·åœ¨è¿™äº›æµ‹è¯•ä¸­æœç´¢`execute_subprocess_async`è°ƒç”¨ã€‚
- en: 'You will need at least 2 GPUs to see these tests in action:'
  id: totrans-190
  prefs: []
  type: TYPE_NORMAL
  zh: æ‚¨è‡³å°‘éœ€è¦2ä¸ªGPUæ‰èƒ½çœ‹åˆ°è¿™äº›æµ‹è¯•çš„è¿è¡Œæƒ…å†µï¼š
- en: '[PRE48]'
  id: totrans-191
  prefs: []
  type: TYPE_PRE
  zh: '[PRE48]'
- en: Output capture
  id: totrans-192
  prefs:
  - PREF_H3
  type: TYPE_NORMAL
  zh: è¾“å‡ºæ•èŽ·
- en: During test execution any output sent to `stdout` and `stderr` is captured.
    If a test or a setup method fails, its according captured output will usually
    be shown along with the failure traceback.
  id: totrans-193
  prefs: []
  type: TYPE_NORMAL
  zh: åœ¨æµ‹è¯•æ‰§è¡ŒæœŸé—´ï¼Œå‘é€åˆ°`stdout`å’Œ`stderr`çš„ä»»ä½•è¾“å‡ºéƒ½å°†è¢«æ•èŽ·ã€‚å¦‚æžœæµ‹è¯•æˆ–è®¾ç½®æ–¹æ³•å¤±è´¥ï¼Œåˆ™é€šå¸¸ä¼šæ˜¾ç¤ºå…¶ç›¸åº”çš„æ•èŽ·è¾“å‡ºä»¥åŠå¤±è´¥çš„å›žæº¯ã€‚
- en: 'To disable output capturing and to get the `stdout` and `stderr` normally,
    use `-s` or `--capture=no`:'
  id: totrans-194
  prefs: []
  type: TYPE_NORMAL
  zh: è¦ç¦ç”¨è¾“å‡ºæ•èŽ·å¹¶æ­£å¸¸èŽ·å–`stdout`å’Œ`stderr`ï¼Œè¯·ä½¿ç”¨`-s`æˆ–`--capture=no`ï¼š
- en: '[PRE49]'
  id: totrans-195
  prefs: []
  type: TYPE_PRE
  zh: '[PRE49]'
- en: 'To send test results to JUnit format output:'
  id: totrans-196
  prefs: []
  type: TYPE_NORMAL
  zh: å°†æµ‹è¯•ç»“æžœå‘é€åˆ°JUnitæ ¼å¼çš„è¾“å‡ºï¼š
- en: '[PRE50]'
  id: totrans-197
  prefs: []
  type: TYPE_PRE
  zh: '[PRE50]'
- en: Color control
  id: totrans-198
  prefs:
  - PREF_H3
  type: TYPE_NORMAL
  zh: é¢œè‰²æŽ§åˆ¶
- en: 'To have no color (e.g., yellow on white background is not readable):'
  id: totrans-199
  prefs: []
  type: TYPE_NORMAL
  zh: è¦æ²¡æœ‰é¢œè‰²ï¼ˆä¾‹å¦‚ï¼Œç™½è‰²èƒŒæ™¯ä¸Šçš„é»„è‰²ä¸å¯è¯»ï¼‰ï¼š
- en: '[PRE51]'
  id: totrans-200
  prefs: []
  type: TYPE_PRE
  zh: '[PRE51]'
- en: Sending test report to online pastebin service
  id: totrans-201
  prefs:
  - PREF_H3
  type: TYPE_NORMAL
  zh: å°†æµ‹è¯•æŠ¥å‘Šå‘é€åˆ°åœ¨çº¿ç²˜è´´æœåŠ¡
- en: 'Creating a URL for each test failure:'
  id: totrans-202
  prefs: []
  type: TYPE_NORMAL
  zh: ä¸ºæ¯ä¸ªæµ‹è¯•å¤±è´¥åˆ›å»ºä¸€ä¸ªURLï¼š
- en: '[PRE52]'
  id: totrans-203
  prefs: []
  type: TYPE_PRE
  zh: '[PRE52]'
- en: This will submit test run information to a remote Paste service and provide
    a URL for each failure. You may select tests as usual or add for example -x if
    you only want to send one particular failure.
  id: totrans-204
  prefs: []
  type: TYPE_NORMAL
  zh: è¿™å°†å‘è¿œç¨‹ç²˜è´´æœåŠ¡æäº¤æµ‹è¯•è¿è¡Œä¿¡æ¯ï¼Œå¹¶ä¸ºæ¯ä¸ªå¤±è´¥æä¾›ä¸€ä¸ªURLã€‚æ‚¨å¯ä»¥åƒå¾€å¸¸ä¸€æ ·é€‰æ‹©æµ‹è¯•ï¼Œæˆ–è€…ä¾‹å¦‚æ·»åŠ `-x`ï¼Œå¦‚æžœæ‚¨åªæƒ³å‘é€ä¸€ä¸ªç‰¹å®šçš„å¤±è´¥ã€‚
- en: 'Creating a URL for a whole test session log:'
  id: totrans-205
  prefs: []
  type: TYPE_NORMAL
  zh: ä¸ºæ•´ä¸ªæµ‹è¯•ä¼šè¯æ—¥å¿—åˆ›å»ºä¸€ä¸ªURLï¼š
- en: '[PRE53]'
  id: totrans-206
  prefs: []
  type: TYPE_PRE
  zh: '[PRE53]'
- en: Writing tests
  id: totrans-207
  prefs:
  - PREF_H2
  type: TYPE_NORMAL
  zh: ç¼–å†™æµ‹è¯•
- en: ðŸ¤— transformers tests are based on `unittest`, but run by `pytest`, so most of
    the time features from both systems can be used.
  id: totrans-208
  prefs: []
  type: TYPE_NORMAL
  zh: ðŸ¤— transformersæµ‹è¯•åŸºäºŽ`unittest`ï¼Œä½†ç”±`pytest`è¿è¡Œï¼Œå› æ­¤å¤§å¤šæ•°æƒ…å†µä¸‹å¯ä»¥ä½¿ç”¨ä¸¤ä¸ªç³»ç»Ÿçš„åŠŸèƒ½ã€‚
- en: You can read [here](https://docs.pytest.org/en/stable/unittest.html) which features
    are supported, but the important thing to remember is that most `pytest` fixtures
    donâ€™t work. Neither parametrization, but we use the module `parameterized` that
    works in a similar way.
  id: totrans-209
  prefs: []
  type: TYPE_NORMAL
  zh: æ‚¨å¯ä»¥åœ¨[è¿™é‡Œ](https://docs.pytest.org/en/stable/unittest.html)é˜…è¯»æ”¯æŒçš„åŠŸèƒ½ï¼Œä½†è¦è®°ä½çš„é‡è¦äº‹æƒ…æ˜¯å¤§å¤šæ•°`pytest`å›ºå®šè£…ç½®ä¸èµ·ä½œç”¨ã€‚ä¹Ÿä¸æ˜¯å‚æ•°åŒ–ï¼Œä½†æˆ‘ä»¬ä½¿ç”¨æ¨¡å—`parameterized`ä»¥ç±»ä¼¼çš„æ–¹å¼å·¥ä½œã€‚
- en: Parametrization
  id: totrans-210
  prefs:
  - PREF_H3
  type: TYPE_NORMAL
  zh: å‚æ•°åŒ–
- en: Often, there is a need to run the same test multiple times, but with different
    arguments. It could be done from within the test, but then there is no way of
    running that test for just one set of arguments.
  id: totrans-211
  prefs: []
  type: TYPE_NORMAL
  zh: ç»å¸¸éœ€è¦å¤šæ¬¡è¿è¡Œç›¸åŒçš„æµ‹è¯•ï¼Œä½†ä½¿ç”¨ä¸åŒçš„å‚æ•°ã€‚å¯ä»¥ä»Žæµ‹è¯•å†…éƒ¨å®Œæˆï¼Œä½†æ˜¯é‚£æ ·å°±æ— æ³•ä»…ä¸ºä¸€ä¸ªå‚æ•°é›†è¿è¡Œè¯¥æµ‹è¯•ã€‚
- en: '[PRE54]'
  id: totrans-212
  prefs: []
  type: TYPE_PRE
  zh: '[PRE54]'
- en: Now, by default this test will be run 3 times, each time with the last 3 arguments
    of `test_floor` being assigned the corresponding arguments in the parameter list.
  id: totrans-213
  prefs: []
  type: TYPE_NORMAL
  zh: çŽ°åœ¨ï¼Œé»˜è®¤æƒ…å†µä¸‹ï¼Œæ­¤æµ‹è¯•å°†è¿è¡Œ3æ¬¡ï¼Œæ¯æ¬¡å°†`test_floor`çš„æœ€åŽ3ä¸ªå‚æ•°åˆ†é…ç»™å‚æ•°åˆ—è¡¨ä¸­çš„ç›¸åº”å‚æ•°ã€‚
- en: 'and you could run just the `negative` and `integer` sets of params with:'
  id: totrans-214
  prefs: []
  type: TYPE_NORMAL
  zh: æ‚¨å¯ä»¥ä»…è¿è¡Œ`negative`å’Œ`integer`å‚æ•°é›†ï¼š
- en: '[PRE55]'
  id: totrans-215
  prefs: []
  type: TYPE_PRE
  zh: '[PRE55]'
- en: 'or all but `negative` sub-tests, with:'
  id: totrans-216
  prefs: []
  type: TYPE_NORMAL
  zh: æˆ–é™¤äº†`negative`å­æµ‹è¯•å¤–çš„æ‰€æœ‰å­æµ‹è¯•ï¼Œä½¿ç”¨ï¼š
- en: '[PRE56]'
  id: totrans-217
  prefs: []
  type: TYPE_PRE
  zh: '[PRE56]'
- en: Besides using the `-k` filter that was just mentioned, you can find out the
    exact name of each sub-test and run any or all of them using their exact names.
  id: totrans-218
  prefs: []
  type: TYPE_NORMAL
  zh: é™¤äº†ä½¿ç”¨åˆšæåˆ°çš„`-k`è¿‡æ»¤å™¨ï¼Œæ‚¨å¯ä»¥æ‰¾å‡ºæ¯ä¸ªå­æµ‹è¯•çš„ç¡®åˆ‡åç§°ï¼Œå¹¶ä½¿ç”¨å…¶ç¡®åˆ‡åç§°è¿è¡Œä»»ä½•æˆ–æ‰€æœ‰å­æµ‹è¯•ã€‚
- en: '[PRE57]'
  id: totrans-219
  prefs: []
  type: TYPE_PRE
  zh: '[PRE57]'
- en: 'and it will list:'
  id: totrans-220
  prefs: []
  type: TYPE_NORMAL
  zh: å®ƒå°†åˆ—å‡ºï¼š
- en: '[PRE58]'
  id: totrans-221
  prefs: []
  type: TYPE_PRE
  zh: '[PRE58]'
- en: 'So now you can run just 2 specific sub-tests:'
  id: totrans-222
  prefs: []
  type: TYPE_NORMAL
  zh: çŽ°åœ¨æ‚¨å¯ä»¥ä»…è¿è¡Œ2ä¸ªç‰¹å®šçš„å­æµ‹è¯•ï¼š
- en: '[PRE59]'
  id: totrans-223
  prefs: []
  type: TYPE_PRE
  zh: '[PRE59]'
- en: 'The module [parameterized](https://pypi.org/project/parameterized/) which is
    already in the developer dependencies of `transformers` works for both: `unittests`
    and `pytest` tests.'
  id: totrans-224
  prefs: []
  type: TYPE_NORMAL
  zh: æ¨¡å—[parameterized](https://pypi.org/project/parameterized/)å·²ç»æ˜¯`transformers`çš„å¼€å‘ä¾èµ–é¡¹ï¼Œé€‚ç”¨äºŽ`unittests`å’Œ`pytest`æµ‹è¯•ã€‚
- en: If, however, the test is not a `unittest`, you may use `pytest.mark.parametrize`
    (or you may see it being used in some existing tests, mostly under `examples`).
  id: totrans-225
  prefs: []
  type: TYPE_NORMAL
  zh: ä½†æ˜¯ï¼Œå¦‚æžœæµ‹è¯•ä¸æ˜¯`unittest`ï¼Œåˆ™å¯ä»¥ä½¿ç”¨`pytest.mark.parametrize`ï¼ˆæˆ–è€…æ‚¨å¯èƒ½ä¼šçœ‹åˆ°å®ƒåœ¨ä¸€äº›çŽ°æœ‰æµ‹è¯•ä¸­ä½¿ç”¨ï¼Œä¸»è¦åœ¨`examples`ä¸‹ï¼‰ã€‚
- en: 'Here is the same example, this time using `pytest`â€™s `parametrize` marker:'
  id: totrans-226
  prefs: []
  type: TYPE_NORMAL
  zh: ä»¥ä¸‹æ˜¯ç›¸åŒçš„ç¤ºä¾‹ï¼Œè¿™æ¬¡ä½¿ç”¨`pytest`çš„`parametrize`æ ‡è®°ï¼š
- en: '[PRE60]'
  id: totrans-227
  prefs: []
  type: TYPE_PRE
  zh: '[PRE60]'
- en: 'Same as with `parameterized`, with `pytest.mark.parametrize` you can have a
    fine control over which sub-tests are run, if the `-k` filter doesnâ€™t do the job.
    Except, this parametrization function creates a slightly different set of names
    for the sub-tests. Here is what they look like:'
  id: totrans-228
  prefs: []
  type: TYPE_NORMAL
  zh: ä¸Ž`parameterized`ä¸€æ ·ï¼Œä½¿ç”¨`pytest.mark.parametrize`å¯ä»¥å¯¹è¦è¿è¡Œçš„å­æµ‹è¯•è¿›è¡Œç²¾ç»†æŽ§åˆ¶ï¼Œå¦‚æžœ`-k`è¿‡æ»¤å™¨æ— æ³•å®Œæˆä»»åŠ¡ã€‚é™¤æ­¤ä¹‹å¤–ï¼Œæ­¤å‚æ•°åŒ–å‡½æ•°ä¸ºå­æµ‹è¯•åˆ›å»ºäº†ä¸€ç»„ç•¥æœ‰ä¸åŒçš„åç§°ã€‚ä»¥ä¸‹æ˜¯å®ƒä»¬çš„æ ·å­ï¼š
- en: '[PRE61]'
  id: totrans-229
  prefs: []
  type: TYPE_PRE
  zh: '[PRE61]'
- en: 'and it will list:'
  id: totrans-230
  prefs: []
  type: TYPE_NORMAL
  zh: å®ƒå°†åˆ—å‡ºï¼š
- en: '[PRE62]'
  id: totrans-231
  prefs: []
  type: TYPE_PRE
  zh: '[PRE62]'
- en: 'So now you can run just the specific test:'
  id: totrans-232
  prefs: []
  type: TYPE_NORMAL
  zh: çŽ°åœ¨æ‚¨å¯ä»¥ä»…è¿è¡Œç‰¹å®šçš„æµ‹è¯•ï¼š
- en: '[PRE63]'
  id: totrans-233
  prefs: []
  type: TYPE_PRE
  zh: '[PRE63]'
- en: as in the previous example.
  id: totrans-234
  prefs: []
  type: TYPE_NORMAL
  zh: ä¸Žå‰é¢çš„ç¤ºä¾‹ç›¸åŒã€‚
- en: Files and directories
  id: totrans-235
  prefs:
  - PREF_H3
  type: TYPE_NORMAL
  zh: æ–‡ä»¶å’Œç›®å½•
- en: 'In tests often we need to know where things are relative to the current test
    file, and itâ€™s not trivial since the test could be invoked from more than one
    directory or could reside in sub-directories with different depths. A helper class
    `transformers.test_utils.TestCasePlus` solves this problem by sorting out all
    the basic paths and provides easy accessors to them:'
  id: totrans-236
  prefs: []
  type: TYPE_NORMAL
  zh: åœ¨æµ‹è¯•ä¸­ï¼Œæˆ‘ä»¬ç»å¸¸éœ€è¦çŸ¥é“äº‹ç‰©ç›¸å¯¹äºŽå½“å‰æµ‹è¯•æ–‡ä»¶çš„ä½ç½®ï¼Œè¿™å¹¶ä¸æ˜¯å¾®ä¸è¶³é“çš„ï¼Œå› ä¸ºæµ‹è¯•å¯èƒ½ä¼šä»Žå¤šä¸ªç›®å½•è°ƒç”¨ï¼Œæˆ–è€…å¯èƒ½ä½äºŽå…·æœ‰ä¸åŒæ·±åº¦çš„å­ç›®å½•ä¸­ã€‚ä¸€ä¸ªè¾…åŠ©ç±»`transformers.test_utils.TestCasePlus`é€šè¿‡æ•´ç†æ‰€æœ‰åŸºæœ¬è·¯å¾„å¹¶æä¾›æ˜“äºŽè®¿é—®çš„è®¿é—®å™¨æ¥è§£å†³è¿™ä¸ªé—®é¢˜ï¼š
- en: '`pathlib` objects (all fully resolved):'
  id: totrans-237
  prefs:
  - PREF_UL
  type: TYPE_NORMAL
  zh: '`pathlib`å¯¹è±¡ï¼ˆå…¨éƒ¨å®Œå…¨è§£æžï¼‰ï¼š'
- en: '`test_file_path` - the current test file path, i.e. `__file__`'
  id: totrans-238
  prefs:
  - PREF_IND
  - PREF_UL
  type: TYPE_NORMAL
  zh: '`test_file_path` - å½“å‰æµ‹è¯•æ–‡ä»¶è·¯å¾„ï¼Œå³`__file__`'
- en: '`test_file_dir` - the directory containing the current test file'
  id: totrans-239
  prefs:
  - PREF_IND
  - PREF_UL
  type: TYPE_NORMAL
  zh: '`test_file_dir` - åŒ…å«å½“å‰æµ‹è¯•æ–‡ä»¶çš„ç›®å½•'
- en: '`tests_dir` - the directory of the `tests` test suite'
  id: totrans-240
  prefs:
  - PREF_IND
  - PREF_UL
  type: TYPE_NORMAL
  zh: '`tests_dir` - `tests`æµ‹è¯•å¥—ä»¶çš„ç›®å½•'
- en: '`examples_dir` - the directory of the `examples` test suite'
  id: totrans-241
  prefs:
  - PREF_IND
  - PREF_UL
  type: TYPE_NORMAL
  zh: '`examples_dir` - `examples`æµ‹è¯•å¥—ä»¶çš„ç›®å½•'
- en: '`repo_root_dir` - the directory of the repository'
  id: totrans-242
  prefs:
  - PREF_IND
  - PREF_UL
  type: TYPE_NORMAL
  zh: '`repo_root_dir` - ä»“åº“çš„ç›®å½•'
- en: '`src_dir` - the directory of `src` (i.e. where the `transformers` sub-dir resides)'
  id: totrans-243
  prefs:
  - PREF_IND
  - PREF_UL
  type: TYPE_NORMAL
  zh: '`src_dir` - `src`çš„ç›®å½•ï¼ˆå³`transformers`å­ç›®å½•æ‰€åœ¨çš„åœ°æ–¹ï¼‰'
- en: 'stringified paths---same as above but these return paths as strings, rather
    than `pathlib` objects:'
  id: totrans-244
  prefs:
  - PREF_UL
  type: TYPE_NORMAL
  zh: å­—ç¬¦ä¸²åŒ–è·¯å¾„---ä¸Žä¸Šè¿°ç›¸åŒï¼Œä½†è¿™äº›è¿”å›žè·¯å¾„ä½œä¸ºå­—ç¬¦ä¸²ï¼Œè€Œä¸æ˜¯`pathlib`å¯¹è±¡ï¼š
- en: '`test_file_path_str`'
  id: totrans-245
  prefs:
  - PREF_IND
  - PREF_UL
  type: TYPE_NORMAL
  zh: '`test_file_path_str`'
- en: '`test_file_dir_str`'
  id: totrans-246
  prefs:
  - PREF_IND
  - PREF_UL
  type: TYPE_NORMAL
  zh: '`test_file_dir_str`'
- en: '`tests_dir_str`'
  id: totrans-247
  prefs:
  - PREF_IND
  - PREF_UL
  type: TYPE_NORMAL
  zh: '`tests_dir_str`'
- en: '`examples_dir_str`'
  id: totrans-248
  prefs:
  - PREF_IND
  - PREF_UL
  type: TYPE_NORMAL
  zh: '`examples_dir_str`'
- en: '`repo_root_dir_str`'
  id: totrans-249
  prefs:
  - PREF_IND
  - PREF_UL
  type: TYPE_NORMAL
  zh: '`repo_root_dir_str`'
- en: '`src_dir_str`'
  id: totrans-250
  prefs:
  - PREF_IND
  - PREF_UL
  type: TYPE_NORMAL
  zh: '`src_dir_str`'
- en: 'To start using those all you need is to make sure that the test resides in
    a subclass of `transformers.test_utils.TestCasePlus`. For example:'
  id: totrans-251
  prefs: []
  type: TYPE_NORMAL
  zh: è¦å¼€å§‹ä½¿ç”¨è¿™äº›ï¼Œæ‚¨åªéœ€è¦ç¡®ä¿æµ‹è¯•ä½äºŽ`transformers.test_utils.TestCasePlus`çš„å­ç±»ä¸­ã€‚ä¾‹å¦‚ï¼š
- en: '[PRE64]'
  id: totrans-252
  prefs: []
  type: TYPE_PRE
  zh: '[PRE64]'
- en: 'If you donâ€™t need to manipulate paths via `pathlib` or you just need a path
    as a string, you can always invoked `str()` on the `pathlib` object or use the
    accessors ending with `_str`. For example:'
  id: totrans-253
  prefs: []
  type: TYPE_NORMAL
  zh: å¦‚æžœæ‚¨ä¸éœ€è¦é€šè¿‡`pathlib`æ“çºµè·¯å¾„ï¼Œæˆ–è€…åªéœ€è¦è·¯å¾„ä½œä¸ºå­—ç¬¦ä¸²ï¼Œæ‚¨å¯ä»¥å§‹ç»ˆåœ¨`pathlib`å¯¹è±¡ä¸Šè°ƒç”¨`str()`æˆ–ä½¿ç”¨ä»¥`_str`ç»“å°¾çš„è®¿é—®å™¨ã€‚ä¾‹å¦‚ï¼š
- en: '[PRE65]'
  id: totrans-254
  prefs: []
  type: TYPE_PRE
  zh: '[PRE65]'
- en: Temporary files and directories
  id: totrans-255
  prefs:
  - PREF_H3
  type: TYPE_NORMAL
  zh: ä¸´æ—¶æ–‡ä»¶å’Œç›®å½•
- en: Using unique temporary files and directories are essential for parallel test
    running, so that the tests wonâ€™t overwrite each otherâ€™s data. Also we want to
    get the temporary files and directories removed at the end of each test that created
    them. Therefore, using packages like `tempfile`, which address these needs is
    essential.
  id: totrans-256
  prefs: []
  type: TYPE_NORMAL
  zh: ä½¿ç”¨å”¯ä¸€çš„ä¸´æ—¶æ–‡ä»¶å’Œç›®å½•å¯¹äºŽå¹¶è¡Œæµ‹è¯•è¿è¡Œè‡³å…³é‡è¦ï¼Œä»¥ä¾¿æµ‹è¯•ä¸ä¼šè¦†ç›–å½¼æ­¤çš„æ•°æ®ã€‚æ­¤å¤–ï¼Œæˆ‘ä»¬å¸Œæœ›åœ¨æ¯ä¸ªåˆ›å»ºå®ƒä»¬çš„æµ‹è¯•ç»“æŸæ—¶åˆ é™¤ä¸´æ—¶æ–‡ä»¶å’Œç›®å½•ã€‚å› æ­¤ï¼Œä½¿ç”¨åƒ`tempfile`è¿™æ ·æ»¡è¶³è¿™äº›éœ€æ±‚çš„è½¯ä»¶åŒ…æ˜¯è‡³å…³é‡è¦çš„ã€‚
- en: However, when debugging tests, you need to be able to see what goes into the
    temporary file or directory and you want to know itâ€™s exact path and not having
    it randomized on every test re-run.
  id: totrans-257
  prefs: []
  type: TYPE_NORMAL
  zh: ç„¶è€Œï¼Œåœ¨è°ƒè¯•æµ‹è¯•æ—¶ï¼Œæ‚¨éœ€è¦èƒ½å¤Ÿçœ‹åˆ°ä¸´æ—¶æ–‡ä»¶æˆ–ç›®å½•ä¸­çš„å†…å®¹ï¼Œå¹¶ä¸”å¸Œæœ›çŸ¥é“å…¶ç¡®åˆ‡è·¯å¾„ï¼Œè€Œä¸æ˜¯åœ¨æ¯æ¬¡æµ‹è¯•é‡æ–°è¿è¡Œæ—¶éšæœºåŒ–ã€‚
- en: A helper class `transformers.test_utils.TestCasePlus` is best used for such
    purposes. Itâ€™s a sub-class of `unittest.TestCase`, so we can easily inherit from
    it in the test modules.
  id: totrans-258
  prefs: []
  type: TYPE_NORMAL
  zh: è¾…åŠ©ç±»`transformers.test_utils.TestCasePlus`æœ€é€‚åˆç”¨äºŽè¿™äº›ç›®çš„ã€‚å®ƒæ˜¯`unittest.TestCase`çš„å­ç±»ï¼Œå› æ­¤æˆ‘ä»¬å¯ä»¥åœ¨æµ‹è¯•æ¨¡å—ä¸­è½»æ¾ç»§æ‰¿å®ƒã€‚
- en: 'Here is an example of its usage:'
  id: totrans-259
  prefs: []
  type: TYPE_NORMAL
  zh: ä»¥ä¸‹æ˜¯å…¶ç”¨æ³•ç¤ºä¾‹ï¼š
- en: '[PRE66]'
  id: totrans-260
  prefs: []
  type: TYPE_PRE
  zh: '[PRE66]'
- en: This code creates a unique temporary directory, and sets `tmp_dir` to its location.
  id: totrans-261
  prefs: []
  type: TYPE_NORMAL
  zh: æ­¤ä»£ç åˆ›å»ºä¸€ä¸ªå”¯ä¸€çš„ä¸´æ—¶ç›®å½•ï¼Œå¹¶å°†`tmp_dir`è®¾ç½®ä¸ºå…¶ä½ç½®ã€‚
- en: 'Create a unique temporary dir:'
  id: totrans-262
  prefs:
  - PREF_UL
  type: TYPE_NORMAL
  zh: åˆ›å»ºä¸€ä¸ªå”¯ä¸€çš„ä¸´æ—¶ç›®å½•ï¼š
- en: '[PRE67]'
  id: totrans-263
  prefs: []
  type: TYPE_PRE
  zh: '[PRE67]'
- en: '`tmp_dir` will contain the path to the created temporary dir. It will be automatically
    removed at the end of the test.'
  id: totrans-264
  prefs: []
  type: TYPE_NORMAL
  zh: '`tmp_dir`å°†åŒ…å«åˆ›å»ºçš„ä¸´æ—¶ç›®å½•çš„è·¯å¾„ã€‚å®ƒå°†åœ¨æµ‹è¯•ç»“æŸæ—¶è‡ªåŠ¨åˆ é™¤ã€‚'
- en: Create a temporary dir of my choice, ensure itâ€™s empty before the test starts
    and donâ€™t empty it after the test.
  id: totrans-265
  prefs:
  - PREF_UL
  type: TYPE_NORMAL
  zh: åˆ›å»ºæˆ‘é€‰æ‹©çš„ä¸´æ—¶ç›®å½•ï¼Œåœ¨æµ‹è¯•å¼€å§‹ä¹‹å‰ç¡®ä¿å®ƒä¸ºç©ºï¼Œå¹¶åœ¨æµ‹è¯•ç»“æŸåŽä¸æ¸…ç©ºå®ƒã€‚
- en: '[PRE68]'
  id: totrans-266
  prefs: []
  type: TYPE_PRE
  zh: '[PRE68]'
- en: This is useful for debug when you want to monitor a specific directory and want
    to make sure the previous tests didnâ€™t leave any data in there.
  id: totrans-267
  prefs: []
  type: TYPE_NORMAL
  zh: å½“æ‚¨æƒ³è¦ç›‘è§†ç‰¹å®šç›®å½•å¹¶ç¡®ä¿ä¹‹å‰çš„æµ‹è¯•æ²¡æœ‰åœ¨å…¶ä¸­ç•™ä¸‹ä»»ä½•æ•°æ®æ—¶ï¼Œè¿™å¾ˆæœ‰ç”¨ã€‚
- en: 'You can override the default behavior by directly overriding the `before` and
    `after` args, leading to one of the following behaviors:'
  id: totrans-268
  prefs:
  - PREF_UL
  type: TYPE_NORMAL
- en: '`before=True`: the temporary dir will always be cleared at the beginning of
    the test.'
  id: totrans-269
  prefs:
  - PREF_IND
  - PREF_UL
  type: TYPE_NORMAL
- en: '`before=False`: if the temporary dir already existed, any existing files will
    remain there.'
  id: totrans-270
  prefs:
  - PREF_IND
  - PREF_UL
  type: TYPE_NORMAL
- en: '`after=True`: the temporary dir will always be deleted at the end of the test.'
  id: totrans-271
  prefs:
  - PREF_IND
  - PREF_UL
  type: TYPE_NORMAL
- en: '`after=False`: the temporary dir will always be left intact at the end of the
    test.'
  id: totrans-272
  prefs:
  - PREF_IND
  - PREF_UL
  type: TYPE_NORMAL
- en: In order to run the equivalent of `rm -r` safely, only subdirs of the project
    repository checkout are allowed if an explicit `tmp_dir` is used, so that by mistake
    no `/tmp` or similar important part of the filesystem will get nuked. i.e. please
    always pass paths that start with `./`.
  id: totrans-273
  prefs: []
  type: TYPE_NORMAL
- en: Each test can register multiple temporary directories and they all will get
    auto-removed, unless requested otherwise.
  id: totrans-274
  prefs: []
  type: TYPE_NORMAL
- en: Temporary sys.path override
  id: totrans-275
  prefs:
  - PREF_H3
  type: TYPE_NORMAL
- en: 'If you need to temporary override `sys.path` to import from another test for
    example, you can use the `ExtendSysPath` context manager. Example:'
  id: totrans-276
  prefs: []
  type: TYPE_NORMAL
- en: '[PRE69]'
  id: totrans-277
  prefs: []
  type: TYPE_PRE
  zh: '[PRE69]'
- en: Skipping tests
  id: totrans-278
  prefs:
  - PREF_H3
  type: TYPE_NORMAL
- en: This is useful when a bug is found and a new test is written, yet the bug is
    not fixed yet. In order to be able to commit it to the main repository we need
    make sure itâ€™s skipped during `make test`.
  id: totrans-279
  prefs: []
  type: TYPE_NORMAL
- en: 'Methods:'
  id: totrans-280
  prefs: []
  type: TYPE_NORMAL
- en: A **skip** means that you expect your test to pass only if some conditions are
    met, otherwise pytest should skip running the test altogether. Common examples
    are skipping windows-only tests on non-windows platforms, or skipping tests that
    depend on an external resource which is not available at the moment (for example
    a database).
  id: totrans-281
  prefs:
  - PREF_UL
  type: TYPE_NORMAL
- en: A **xfail** means that you expect a test to fail for some reason. A common example
    is a test for a feature not yet implemented, or a bug not yet fixed. When a test
    passes despite being expected to fail (marked with pytest.mark.xfail), itâ€™s an
    xpass and will be reported in the test summary.
  id: totrans-282
  prefs:
  - PREF_UL
  type: TYPE_NORMAL
- en: One of the important differences between the two is that `skip` doesnâ€™t run
    the test, and `xfail` does. So if the code thatâ€™s buggy causes some bad state
    that will affect other tests, do not use `xfail`.
  id: totrans-283
  prefs: []
  type: TYPE_NORMAL
- en: Implementation
  id: totrans-284
  prefs:
  - PREF_H4
  type: TYPE_NORMAL
- en: 'Here is how to skip whole test unconditionally:'
  id: totrans-285
  prefs:
  - PREF_UL
  type: TYPE_NORMAL
- en: '[PRE70]'
  id: totrans-286
  prefs: []
  type: TYPE_PRE
  zh: '[PRE70]'
- en: 'or via pytest:'
  id: totrans-287
  prefs: []
  type: TYPE_NORMAL
- en: '[PRE71]'
  id: totrans-288
  prefs: []
  type: TYPE_PRE
  zh: '[PRE71]'
- en: 'or the `xfail` way:'
  id: totrans-289
  prefs: []
  type: TYPE_NORMAL
- en: '[PRE72]'
  id: totrans-290
  prefs: []
  type: TYPE_PRE
  zh: '[PRE72]'
- en: 'Hereâ€™s how to skip a test based on internal checks within the test:'
  id: totrans-291
  prefs: []
  type: TYPE_NORMAL
- en: '[PRE73]'
  id: totrans-292
  prefs: []
  type: TYPE_PRE
  zh: '[PRE73]'
- en: 'or the whole module:'
  id: totrans-293
  prefs: []
  type: TYPE_NORMAL
- en: '[PRE74]'
  id: totrans-294
  prefs: []
  type: TYPE_PRE
  zh: '[PRE74]'
- en: 'or the `xfail` way:'
  id: totrans-295
  prefs: []
  type: TYPE_NORMAL
- en: '[PRE75]'
  id: totrans-296
  prefs: []
  type: TYPE_PRE
  zh: '[PRE75]'
- en: 'Here is how to skip all tests in a module if some import is missing:'
  id: totrans-297
  prefs:
  - PREF_UL
  type: TYPE_NORMAL
- en: '[PRE76]'
  id: totrans-298
  prefs: []
  type: TYPE_PRE
  zh: '[PRE76]'
- en: 'Skip a test based on a condition:'
  id: totrans-299
  prefs:
  - PREF_UL
  type: TYPE_NORMAL
- en: '[PRE77]'
  id: totrans-300
  prefs: []
  type: TYPE_PRE
  zh: '[PRE77]'
- en: 'or:'
  id: totrans-301
  prefs: []
  type: TYPE_NORMAL
- en: '[PRE78]'
  id: totrans-302
  prefs: []
  type: TYPE_PRE
  zh: '[PRE78]'
- en: 'or skip the whole module:'
  id: totrans-303
  prefs: []
  type: TYPE_NORMAL
- en: '[PRE79]'
  id: totrans-304
  prefs: []
  type: TYPE_PRE
  zh: '[PRE79]'
- en: More details, example and ways are [here](https://docs.pytest.org/en/latest/skipping.html).
  id: totrans-305
  prefs: []
  type: TYPE_NORMAL
- en: Slow tests
  id: totrans-306
  prefs:
  - PREF_H3
  type: TYPE_NORMAL
- en: 'The library of tests is ever-growing, and some of the tests take minutes to
    run, therefore we canâ€™t afford waiting for an hour for the test suite to complete
    on CI. Therefore, with some exceptions for essential tests, slow tests should
    be marked as in the example below:'
  id: totrans-307
  prefs: []
  type: TYPE_NORMAL
- en: '[PRE80]'
  id: totrans-308
  prefs: []
  type: TYPE_PRE
  zh: '[PRE80]'
- en: 'Once a test is marked as `@slow`, to run such tests set `RUN_SLOW=1` env var,
    e.g.:'
  id: totrans-309
  prefs: []
  type: TYPE_NORMAL
- en: '[PRE81]'
  id: totrans-310
  prefs: []
  type: TYPE_PRE
  zh: '[PRE81]'
- en: 'Some decorators like `@parameterized` rewrite test names, therefore `@slow`
    and the rest of the skip decorators `@require_*` have to be listed last for them
    to work correctly. Here is an example of the correct usage:'
  id: totrans-311
  prefs: []
  type: TYPE_NORMAL
- en: '[PRE82]'
  id: totrans-312
  prefs: []
  type: TYPE_PRE
  zh: '[PRE82]'
- en: As explained at the beginning of this document, slow tests get to run on a scheduled
    basis, rather than in PRs CI checks. So itâ€™s possible that some problems will
    be missed during a PR submission and get merged. Such problems will get caught
    during the next scheduled CI job. But it also means that itâ€™s important to run
    the slow tests on your machine before submitting the PR.
  id: totrans-313
  prefs: []
  type: TYPE_NORMAL
- en: 'Here is a rough decision making mechanism for choosing which tests should be
    marked as slow:'
  id: totrans-314
  prefs: []
  type: TYPE_NORMAL
- en: 'If the test is focused on one of the libraryâ€™s internal components (e.g., modeling
    files, tokenization files, pipelines), then we should run that test in the non-slow
    test suite. If itâ€™s focused on an other aspect of the library, such as the documentation
    or the examples, then we should run these tests in the slow test suite. And then,
    to refine this approach we should have exceptions:'
  id: totrans-315
  prefs: []
  type: TYPE_NORMAL
- en: All tests that need to download a heavy set of weights or a dataset that is
    larger than ~50MB (e.g., model or tokenizer integration tests, pipeline integration
    tests) should be set to slow. If youâ€™re adding a new model, you should create
    and upload to the hub a tiny version of it (with random weights) for integration
    tests. This is discussed in the following paragraphs.
  id: totrans-316
  prefs:
  - PREF_UL
  type: TYPE_NORMAL
- en: All tests that need to do a training not specifically optimized to be fast should
    be set to slow.
  id: totrans-317
  prefs:
  - PREF_UL
  type: TYPE_NORMAL
- en: We can introduce exceptions if some of these should-be-non-slow tests are excruciatingly
    slow, and set them to `@slow`. Auto-modeling tests, which save and load large
    files to disk, are a good example of tests that are marked as `@slow`.
  id: totrans-318
  prefs:
  - PREF_UL
  type: TYPE_NORMAL
- en: If a test completes under 1 second on CI (including downloads if any) then it
    should be a normal test regardless.
  id: totrans-319
  prefs:
  - PREF_UL
  type: TYPE_NORMAL
- en: 'Collectively, all the non-slow tests need to cover entirely the different internals,
    while remaining fast. For example, a significant coverage can be achieved by testing
    with specially created tiny models with random weights. Such models have the very
    minimal number of layers (e.g., 2), vocab size (e.g., 1000), etc. Then the `@slow`
    tests can use large slow models to do qualitative testing. To see the use of these
    simply look for *tiny* models with:'
  id: totrans-320
  prefs: []
  type: TYPE_NORMAL
- en: '[PRE83]'
  id: totrans-321
  prefs: []
  type: TYPE_PRE
  zh: '[PRE83]'
- en: Here is a an example of a [script](https://github.com/huggingface/transformers/tree/main/scripts/fsmt/fsmt-make-tiny-model.py)
    that created the tiny model [stas/tiny-wmt19-en-de](https://huggingface.co/stas/tiny-wmt19-en-de).
    You can easily adjust it to your specific modelâ€™s architecture.
  id: totrans-322
  prefs: []
  type: TYPE_NORMAL
- en: Itâ€™s easy to measure the run-time incorrectly if for example there is an overheard
    of downloading a huge model, but if you test it locally the downloaded files would
    be cached and thus the download time not measured. Hence check the execution speed
    report in CI logs instead (the output of `pytest --durations=0 tests`).
  id: totrans-323
  prefs: []
  type: TYPE_NORMAL
- en: That report is also useful to find slow outliers that arenâ€™t marked as such,
    or which need to be re-written to be fast. If you notice that the test suite starts
    getting slow on CI, the top listing of this report will show the slowest tests.
  id: totrans-324
  prefs: []
  type: TYPE_NORMAL
- en: Testing the stdout/stderr output
  id: totrans-325
  prefs:
  - PREF_H3
  type: TYPE_NORMAL
- en: 'In order to test functions that write to `stdout` and/or `stderr`, the test
    can access those streams using the `pytest`â€™s [capsys system](https://docs.pytest.org/en/latest/capture.html).
    Here is how this is accomplished:'
  id: totrans-326
  prefs: []
  type: TYPE_NORMAL
- en: '[PRE84]'
  id: totrans-327
  prefs: []
  type: TYPE_PRE
  zh: '[PRE84]'
- en: 'And, of course, most of the time, `stderr` will come as a part of an exception,
    so try/except has to be used in such a case:'
  id: totrans-328
  prefs: []
  type: TYPE_NORMAL
- en: '[PRE85]'
  id: totrans-329
  prefs: []
  type: TYPE_PRE
  zh: '[PRE85]'
- en: 'Another approach to capturing stdout is via `contextlib.redirect_stdout`:'
  id: totrans-330
  prefs: []
  type: TYPE_NORMAL
- en: '[PRE86]'
  id: totrans-331
  prefs: []
  type: TYPE_PRE
  zh: '[PRE86]'
- en: An important potential issue with capturing stdout is that it may contain `\r`
    characters that in normal `print` reset everything that has been printed so far.
    There is no problem with `pytest`, but with `pytest -s` these characters get included
    in the buffer, so to be able to have the test run with and without `-s`, you have
    to make an extra cleanup to the captured output, using `re.sub(r'~.*\r', '', buf,
    0, re.M)`.
  id: totrans-332
  prefs: []
  type: TYPE_NORMAL
- en: 'But, then we have a helper context manager wrapper to automatically take care
    of it all, regardless of whether it has some `\r`â€™s in it or not, so itâ€™s a simple:'
  id: totrans-333
  prefs: []
  type: TYPE_NORMAL
- en: '[PRE87]'
  id: totrans-334
  prefs: []
  type: TYPE_PRE
  zh: '[PRE87]'
- en: 'Here is a full test example:'
  id: totrans-335
  prefs: []
  type: TYPE_NORMAL
- en: '[PRE88]'
  id: totrans-336
  prefs: []
  type: TYPE_PRE
  zh: '[PRE88]'
- en: 'If youâ€™d like to capture `stderr` use the `CaptureStderr` class instead:'
  id: totrans-337
  prefs: []
  type: TYPE_NORMAL
- en: '[PRE89]'
  id: totrans-338
  prefs: []
  type: TYPE_PRE
  zh: '[PRE89]'
- en: 'If you need to capture both streams at once, use the parent `CaptureStd` class:'
  id: totrans-339
  prefs: []
  type: TYPE_NORMAL
- en: '[PRE90]'
  id: totrans-340
  prefs: []
  type: TYPE_PRE
  zh: '[PRE90]'
- en: Also, to aid debugging test issues, by default these context managers automatically
    replay the captured streams on exit from the context.
  id: totrans-341
  prefs: []
  type: TYPE_NORMAL
- en: Capturing logger stream
  id: totrans-342
  prefs:
  - PREF_H3
  type: TYPE_NORMAL
- en: 'If you need to validate the output of a logger, you can use `CaptureLogger`:'
  id: totrans-343
  prefs: []
  type: TYPE_NORMAL
- en: '[PRE91]'
  id: totrans-344
  prefs: []
  type: TYPE_PRE
  zh: '[PRE91]'
- en: Testing with environment variables
  id: totrans-345
  prefs:
  - PREF_H3
  type: TYPE_NORMAL
- en: If you want to test the impact of environment variables for a specific test
    you can use a helper decorator `transformers.testing_utils.mockenv`
  id: totrans-346
  prefs: []
  type: TYPE_NORMAL
- en: '[PRE92]'
  id: totrans-347
  prefs: []
  type: TYPE_PRE
  zh: '[PRE92]'
- en: 'At times an external program needs to be called, which requires setting `PYTHONPATH`
    in `os.environ` to include multiple local paths. A helper class `transformers.test_utils.TestCasePlus`
    comes to help:'
  id: totrans-348
  prefs: []
  type: TYPE_NORMAL
- en: '[PRE93]'
  id: totrans-349
  prefs: []
  type: TYPE_PRE
  zh: '[PRE93]'
- en: Depending on whether the test file was under the `tests` test suite or `examples`
    itâ€™ll correctly set up `env[PYTHONPATH]` to include one of these two directories,
    and also the `src` directory to ensure the testing is done against the current
    repo, and finally with whatever `env[PYTHONPATH]` was already set to before the
    test was called if anything.
  id: totrans-350
  prefs: []
  type: TYPE_NORMAL
  zh: æ ¹æ®æµ‹è¯•æ–‡ä»¶æ˜¯åœ¨`tests`æµ‹è¯•å¥—ä»¶è¿˜æ˜¯`examples`ä¸‹ï¼Œå®ƒå°†æ­£ç¡®è®¾ç½®`env[PYTHONPATH]`ä»¥åŒ…æ‹¬è¿™ä¸¤ä¸ªç›®å½•ä¹‹ä¸€ï¼Œå¹¶ä¸”è¿˜å°†`src`ç›®å½•è®¾ç½®ä¸ºç¡®ä¿é’ˆå¯¹å½“å‰å­˜å‚¨åº“è¿›è¡Œæµ‹è¯•ï¼Œæœ€åŽè¿˜å°†è®¾ç½®`env[PYTHONPATH]`åœ¨è°ƒç”¨æµ‹è¯•ä¹‹å‰å·²ç»è®¾ç½®çš„ä»»ä½•å†…å®¹ã€‚
- en: This helper method creates a copy of the `os.environ` object, so the original
    remains intact.
  id: totrans-351
  prefs: []
  type: TYPE_NORMAL
  zh: è¿™ä¸ªè¾…åŠ©æ–¹æ³•åˆ›å»ºäº†`os.environ`å¯¹è±¡çš„å‰¯æœ¬ï¼Œå› æ­¤åŽŸå§‹å¯¹è±¡ä¿æŒä¸å˜ã€‚
- en: Getting reproducible results
  id: totrans-352
  prefs:
  - PREF_H3
  type: TYPE_NORMAL
  zh: èŽ·å¾—å¯é‡çŽ°çš„ç»“æžœ
- en: 'In some situations you may want to remove randomness for your tests. To get
    identical reproducible results set, you will need to fix the seed:'
  id: totrans-353
  prefs: []
  type: TYPE_NORMAL
  zh: åœ¨æŸäº›æƒ…å†µä¸‹ï¼Œæ‚¨å¯èƒ½å¸Œæœ›ä¸ºæµ‹è¯•åŽ»é™¤éšæœºæ€§ã€‚è¦èŽ·å¾—ç›¸åŒçš„å¯é‡çŽ°ç»“æžœé›†ï¼Œæ‚¨éœ€è¦ä¿®å¤ç§å­ï¼š
- en: '[PRE94]'
  id: totrans-354
  prefs: []
  type: TYPE_PRE
  zh: '[PRE94]'
- en: Debugging tests
  id: totrans-355
  prefs:
  - PREF_H3
  type: TYPE_NORMAL
  zh: è°ƒè¯•æµ‹è¯•
- en: 'To start a debugger at the point of the warning, do this:'
  id: totrans-356
  prefs: []
  type: TYPE_NORMAL
  zh: è¦åœ¨è­¦å‘Šç‚¹å¯åŠ¨è°ƒè¯•å™¨ï¼Œè¯·æ‰§è¡Œä»¥ä¸‹æ“ä½œï¼š
- en: '[PRE95]'
  id: totrans-357
  prefs: []
  type: TYPE_PRE
  zh: '[PRE95]'
- en: Working with github actions workflows
  id: totrans-358
  prefs:
  - PREF_H2
  type: TYPE_NORMAL
  zh: ä½¿ç”¨github actionså·¥ä½œæµ
- en: 'To trigger a self-push workflow CI job, you must:'
  id: totrans-359
  prefs: []
  type: TYPE_NORMAL
  zh: è¦è§¦å‘è‡ªåŠ¨æŽ¨é€å·¥ä½œæµCIä½œä¸šï¼Œå¿…é¡»ï¼š
- en: Create a new branch on `transformers` origin (not a fork!).
  id: totrans-360
  prefs:
  - PREF_OL
  type: TYPE_NORMAL
  zh: åœ¨`transformers`æºä¸Šåˆ›å»ºä¸€ä¸ªæ–°åˆ†æ”¯ï¼ˆä¸æ˜¯åˆ†å‰ï¼ï¼‰ã€‚
- en: The branch name has to start with either `ci_` or `ci-` (`main` triggers it
    too, but we canâ€™t do PRs on `main`). It also gets triggered only for specific
    paths - you can find the up-to-date definition in case it changed since this document
    has been written [here](https://github.com/huggingface/transformers/blob/main/.github/workflows/self-push.yml)
    under *push:*
  id: totrans-361
  prefs:
  - PREF_OL
  type: TYPE_NORMAL
  zh: åˆ†æ”¯åç§°å¿…é¡»ä»¥`ci_`æˆ–`ci-`å¼€å¤´ï¼ˆ`main`ä¹Ÿä¼šè§¦å‘å®ƒï¼Œä½†æˆ‘ä»¬ä¸èƒ½åœ¨`main`ä¸Šåˆ›å»ºPRï¼‰ã€‚å®ƒè¿˜ä»…é’ˆå¯¹ç‰¹å®šè·¯å¾„è§¦å‘ - å¦‚æžœè‡ªä»Žç¼–å†™æœ¬æ–‡ä»¥æ¥å‘ç”Ÿäº†æ›´æ”¹ï¼Œæ‚¨å¯ä»¥åœ¨[æ­¤å¤„](https://github.com/huggingface/transformers/blob/main/.github/workflows/self-push.yml)æ‰¾åˆ°æœ€æ–°çš„å®šä¹‰ï¼Œä½äºŽ*push:*ä¸‹ã€‚
- en: Create a PR from this branch.
  id: totrans-362
  prefs:
  - PREF_OL
  type: TYPE_NORMAL
  zh: ä»Žæ­¤åˆ†æ”¯åˆ›å»ºä¸€ä¸ªPRã€‚
- en: Then you can see the job appear [here](https://github.com/huggingface/transformers/actions/workflows/self-push.yml).
    It may not run right away if there is a backlog.
  id: totrans-363
  prefs:
  - PREF_OL
  type: TYPE_NORMAL
  zh: ç„¶åŽæ‚¨å¯ä»¥åœ¨[è¿™é‡Œ](https://github.com/huggingface/transformers/actions/workflows/self-push.yml)çœ‹åˆ°è¯¥ä½œä¸šã€‚å¦‚æžœæœ‰ç§¯åŽ‹ï¼Œå®ƒå¯èƒ½ä¸ä¼šç«‹å³è¿è¡Œã€‚
- en: Testing Experimental CI Features
  id: totrans-364
  prefs:
  - PREF_H2
  type: TYPE_NORMAL
  zh: æµ‹è¯•å®žéªŒæ€§CIåŠŸèƒ½
- en: Testing CI features can be potentially problematic as it can interfere with
    the normal CI functioning. Therefore if a new CI feature is to be added, it should
    be done as following.
  id: totrans-365
  prefs: []
  type: TYPE_NORMAL
  zh: æµ‹è¯•CIåŠŸèƒ½å¯èƒ½ä¼šæœ‰æ½œåœ¨é—®é¢˜ï¼Œå› ä¸ºå®ƒå¯èƒ½ä¼šå¹²æ‰°æ­£å¸¸çš„CIåŠŸèƒ½ã€‚å› æ­¤ï¼Œå¦‚æžœè¦æ·»åŠ æ–°çš„CIåŠŸèƒ½ï¼Œåº”æŒ‰ä»¥ä¸‹æ­¥éª¤è¿›è¡Œã€‚
- en: Create a new dedicated job that tests what needs to be tested
  id: totrans-366
  prefs:
  - PREF_OL
  type: TYPE_NORMAL
  zh: åˆ›å»ºä¸€ä¸ªæ–°çš„ä¸“ç”¨ä½œä¸šï¼Œæµ‹è¯•éœ€è¦æµ‹è¯•çš„å†…å®¹
- en: The new job must always succeed so that it gives us a green âœ“ (details below).
  id: totrans-367
  prefs:
  - PREF_OL
  type: TYPE_NORMAL
  zh: æ–°ä½œä¸šå¿…é¡»å§‹ç»ˆæˆåŠŸï¼Œä»¥ä¾¿ä¸ºæˆ‘ä»¬æä¾›ç»¿è‰²çš„ âœ“ï¼ˆä¸‹é¢æœ‰è¯¦ç»†ä¿¡æ¯ï¼‰ã€‚
- en: Let it run for some days to see that a variety of different PR types get to
    run on it (user fork branches, non-forked branches, branches originating from
    github.com UI direct file edit, various forced pushes, etc. - there are so many)
    while monitoring the experimental jobâ€™s logs (not the overall job green as itâ€™s
    purposefully always green)
  id: totrans-368
  prefs:
  - PREF_OL
  type: TYPE_NORMAL
  zh: è®©å®ƒè¿è¡Œå‡ å¤©ï¼Œçœ‹çœ‹å„ç§ä¸åŒç±»åž‹çš„PRæ˜¯å¦å¯ä»¥è¿è¡Œåœ¨ä¸Šé¢ï¼ˆç”¨æˆ·åˆ†æ”¯ï¼Œéžåˆ†å‰åˆ†æ”¯ï¼Œæºè‡ªgithub.com UIç›´æŽ¥æ–‡ä»¶ç¼–è¾‘çš„åˆ†æ”¯ï¼Œå„ç§å¼ºåˆ¶æŽ¨é€ç­‰ç­‰ - æœ‰å¾ˆå¤šï¼‰ï¼ŒåŒæ—¶ç›‘è§†å®žéªŒæ€§ä½œä¸šçš„æ—¥å¿—ï¼ˆè€Œä¸æ˜¯æ•´ä½“ä½œä¸šç»¿è‰²ï¼Œå› ä¸ºå®ƒæ•…æ„æ€»æ˜¯ç»¿è‰²ï¼‰
- en: When itâ€™s clear that everything is solid, then merge the new changes into existing
    jobs.
  id: totrans-369
  prefs:
  - PREF_OL
  type: TYPE_NORMAL
  zh: å½“ä¸€åˆ‡éƒ½å¾ˆç¨³å®šæ—¶ï¼Œç„¶åŽå°†æ–°æ›´æ”¹åˆå¹¶åˆ°çŽ°æœ‰ä½œä¸šä¸­ã€‚
- en: That way experiments on CI functionality itself wonâ€™t interfere with the normal
    workflow.
  id: totrans-370
  prefs: []
  type: TYPE_NORMAL
  zh: è¿™æ ·ï¼Œå¯¹CIåŠŸèƒ½æœ¬èº«çš„å®žéªŒå°±ä¸ä¼šå¹²æ‰°æ­£å¸¸çš„å·¥ä½œæµç¨‹ã€‚
- en: Now how can we make the job always succeed while the new CI feature is being
    developed?
  id: totrans-371
  prefs: []
  type: TYPE_NORMAL
  zh: çŽ°åœ¨æˆ‘ä»¬å¦‚ä½•ç¡®ä¿å·¥ä½œå§‹ç»ˆæˆåŠŸï¼ŒåŒæ—¶æ–°çš„CIåŠŸèƒ½æ­£åœ¨å¼€å‘ä¸­ï¼Ÿ
- en: Some CIs, like TravisCI support ignore-step-failure and will report the overall
    job as successful, but CircleCI and Github Actions as of this writing donâ€™t support
    that.
  id: totrans-372
  prefs: []
  type: TYPE_NORMAL
  zh: ä¸€äº›CIï¼Œå¦‚TravisCIæ”¯æŒignore-step-failureï¼Œå¹¶å°†æ•´ä½“ä½œä¸šæŠ¥å‘Šä¸ºæˆåŠŸï¼Œä½†æˆªè‡³ç›®å‰ï¼ŒCircleCIå’ŒGithub Actionsä¸æ”¯æŒè¯¥åŠŸèƒ½ã€‚
- en: 'So the following workaround can be used:'
  id: totrans-373
  prefs: []
  type: TYPE_NORMAL
  zh: å› æ­¤ï¼Œå¯ä»¥ä½¿ç”¨ä»¥ä¸‹è§£å†³æ–¹æ³•ï¼š
- en: '`set +euo pipefail` at the beginning of the run command to suppress most potential
    failures in the bash script.'
  id: totrans-374
  prefs:
  - PREF_OL
  type: TYPE_NORMAL
  zh: åœ¨è¿è¡Œå‘½ä»¤çš„å¼€å¤´ä½¿ç”¨`set +euo pipefail`æ¥æŠ‘åˆ¶bashè„šæœ¬ä¸­çš„å¤§å¤šæ•°æ½œåœ¨æ•…éšœã€‚
- en: 'the last command must be a success: `echo "done"` or just `true` will do'
  id: totrans-375
  prefs:
  - PREF_OL
  type: TYPE_NORMAL
  zh: æœ€åŽä¸€ä¸ªå‘½ä»¤å¿…é¡»æˆåŠŸï¼š`echo "done"`æˆ–åªéœ€`true`å³å¯
- en: 'Here is an example:'
  id: totrans-376
  prefs: []
  type: TYPE_NORMAL
  zh: è¿™æ˜¯ä¸€ä¸ªä¾‹å­ï¼š
- en: '[PRE96]'
  id: totrans-377
  prefs: []
  type: TYPE_PRE
  zh: '[PRE96]'
- en: 'For simple commands you could also do:'
  id: totrans-378
  prefs: []
  type: TYPE_NORMAL
  zh: å¯¹äºŽç®€å•çš„å‘½ä»¤ï¼Œæ‚¨ä¹Ÿå¯ä»¥è¿™æ ·åšï¼š
- en: '[PRE97]'
  id: totrans-379
  prefs: []
  type: TYPE_PRE
  zh: '[PRE97]'
- en: Of course, once satisfied with the results, integrate the experimental step
    or job with the rest of the normal jobs, while removing `set +euo pipefail` or
    any other things you may have added to ensure that the experimental job doesnâ€™t
    interfere with the normal CI functioning.
  id: totrans-380
  prefs: []
  type: TYPE_NORMAL
  zh: å½“ç»“æžœä»¤äººæ»¡æ„æ—¶ï¼Œå°†å®žéªŒæ­¥éª¤æˆ–ä½œä¸šä¸Žå…¶ä½™æ­£å¸¸ä½œä¸šé›†æˆåœ¨ä¸€èµ·ï¼ŒåŒæ—¶åˆ é™¤`set +euo pipefail`æˆ–æ‚¨å¯èƒ½æ·»åŠ çš„ä»»ä½•å…¶ä»–å†…å®¹ï¼Œä»¥ç¡®ä¿å®žéªŒæ€§ä½œä¸šä¸ä¼šå¹²æ‰°æ­£å¸¸çš„CIåŠŸèƒ½ã€‚
- en: This whole process would have been much easier if we only could set something
    like `allow-failure` for the experimental step, and let it fail without impacting
    the overall status of PRs. But as mentioned earlier CircleCI and Github Actions
    donâ€™t support it at the moment.
  id: totrans-381
  prefs: []
  type: TYPE_NORMAL
  zh: å¦‚æžœåªèƒ½ä¸ºå®žéªŒæ­¥éª¤è®¾ç½®ç±»ä¼¼äºŽ`allow-failure`çš„å†…å®¹ï¼Œå¹¶ä¸”è®©å®ƒå¤±è´¥è€Œä¸å½±å“PRçš„æ•´ä½“çŠ¶æ€ï¼Œé‚£ä¹ˆæ•´ä¸ªè¿‡ç¨‹å°†å˜å¾—æ›´åŠ å®¹æ˜“ã€‚ä½†æ­£å¦‚å‰é¢æåˆ°çš„ï¼ŒCircleCIå’ŒGithub
    Actionsç›®å‰ä¸æ”¯æŒè¿™ä¸€ç‚¹ã€‚
- en: 'You can vote for this feature and see where it is at these CI-specific threads:'
  id: totrans-382
  prefs: []
  type: TYPE_NORMAL
  zh: æ‚¨å¯ä»¥ä¸ºæ­¤åŠŸèƒ½æŠ•ç¥¨ï¼Œå¹¶æŸ¥çœ‹CIç‰¹å®šçº¿ç¨‹çš„è¿›å±•ï¼š
- en: '[Github Actions:](https://github.com/actions/toolkit/issues/399)'
  id: totrans-383
  prefs:
  - PREF_UL
  type: TYPE_NORMAL
  zh: '[Github Actionsï¼š](https://github.com/actions/toolkit/issues/399)'
- en: '[CircleCI:](https://ideas.circleci.com/ideas/CCI-I-344)'
  id: totrans-384
  prefs:
  - PREF_UL
  type: TYPE_NORMAL
  zh: '[CircleCIï¼š](https://ideas.circleci.com/ideas/CCI-I-344)'
