# Amazon SageMaker

> åŸå§‹æ–‡æœ¬ï¼š[https://huggingface.co/docs/accelerate/usage_guides/sagemaker](https://huggingface.co/docs/accelerate/usage_guides/sagemaker)

Hugging Face å’Œäºšé©¬é€Šæ¨å‡ºäº†æ–°çš„ [Hugging Face Deep Learning Containers (DLCs)](https://github.com/aws/deep-learning-containers/blob/master/available_images.md#huggingface-training-containers)ï¼Œä½¿åœ¨ [Amazon SageMaker](https://aws.amazon.com/sagemaker/) ä¸­è®­ç»ƒ Hugging Face Transformer æ¨¡å‹å˜å¾—æ¯”ä»¥å¾€æ›´å®¹æ˜“ã€‚

## å¼€å§‹

### è®¾ç½®å’Œå®‰è£…

åœ¨ Amazon SageMaker ä¸Šè¿è¡Œæ‚¨çš„ ğŸ¤— Accelerate è„šæœ¬ä¹‹å‰ï¼Œæ‚¨éœ€è¦æ³¨å†Œä¸€ä¸ª AWS å¸æˆ·ã€‚å¦‚æœæ‚¨è¿˜æ²¡æœ‰ AWS å¸æˆ·ï¼Œè¯·åœ¨æ­¤å¤„äº†è§£æ›´å¤šä¿¡æ¯ã€‚

åœ¨æ‹¥æœ‰ AWS å¸æˆ·åï¼Œæ‚¨éœ€è¦å®‰è£… `sagemaker` sdk ä»¥ä½¿ç”¨ ğŸ¤— Accelerateï¼š

```py
pip install "accelerate[sagemaker]" --upgrade
```

ğŸ¤— Accelerate ç›®å‰ä½¿ç”¨ ğŸ¤— DLCsï¼Œé¢„å®‰è£…äº† `transformers`ã€`datasets` å’Œ `tokenizers`ã€‚ğŸ¤— Accelerate å°šæœªåŒ…å«åœ¨ DLC ä¸­ï¼ˆå³å°†æ·»åŠ ï¼ï¼‰ï¼Œå› æ­¤è¦åœ¨ Amazon SageMaker ä¸­ä½¿ç”¨å®ƒï¼Œæ‚¨éœ€è¦åœ¨ä¸æ‚¨çš„è®­ç»ƒè„šæœ¬ä½äºåŒä¸€ç›®å½•ä¸­åˆ›å»ºä¸€ä¸ª `requirements.txt` å¹¶å°†å…¶æ·»åŠ ä¸ºä¾èµ–é¡¹ï¼š

```py
accelerate
```

æ‚¨è¿˜åº”è¯¥å°†æ‚¨çš„å…¶ä»–ä¾èµ–é¡¹æ·»åŠ åˆ°æ­¤ `requirements.txt` ä¸­ã€‚

### é…ç½® ğŸ¤— Accelerate

æ‚¨å¯ä»¥ä½¿ç”¨ ğŸ¤— Accelerate CLI ä¸º Amazon SageMaker é…ç½®å¯åŠ¨é…ç½®ï¼Œä¸ä¸ºé SageMaker è®­ç»ƒä½œä¸šé…ç½®ç›¸åŒï¼š

```py
accelerate config
# In which compute environment are you running? ([0] This machine, [1] AWS (Amazon SageMaker)): 1
```

ğŸ¤— Accelerate å°†é€šè¿‡é—®å·è°ƒæŸ¥äº†è§£æ‚¨çš„ Amazon SageMaker è®¾ç½®ï¼Œå¹¶åˆ›å»ºä¸€ä¸ªæ‚¨å¯ä»¥ç¼–è¾‘çš„é…ç½®æ–‡ä»¶ã€‚

ğŸ¤— Accelerate ä¸ä¼šä¿å­˜æ‚¨çš„ä»»ä½•å‡­æ®ã€‚

### å‡†å¤‡ä¸€ä¸ª ğŸ¤— Accelerate å¾®è°ƒè„šæœ¬

è®­ç»ƒè„šæœ¬ä¸æ‚¨å¯èƒ½åœ¨ SageMaker ä¹‹å¤–è¿è¡Œçš„è®­ç»ƒè„šæœ¬éå¸¸ç›¸ä¼¼ï¼Œä½†æ˜¯è¦åœ¨è®­ç»ƒåä¿å­˜æ¨¡å‹ï¼Œæ‚¨éœ€è¦æŒ‡å®š `/opt/ml/model` æˆ–ä½¿ç”¨ `os.environ["SM_MODEL_DIR"]` ä½œä¸ºä¿å­˜ç›®å½•ã€‚è®­ç»ƒåï¼Œæ­¤ç›®å½•ä¸­çš„å·¥ä»¶å°†ä¸Šä¼ åˆ° S3ï¼š

```py
- torch.save('/opt/ml/model`)
+ accelerator.save('/opt/ml/model')
```

SageMaker ä¸æ”¯æŒ argparse æ“ä½œã€‚å¦‚æœæ‚¨æƒ³ä½¿ç”¨å¸ƒå°”è¶…å‚æ•°ï¼Œä¾‹å¦‚ï¼Œæ‚¨éœ€è¦åœ¨è„šæœ¬ä¸­å°†ç±»å‹æŒ‡å®šä¸º boolï¼Œå¹¶ä¸ºæ­¤è¶…å‚æ•°æä¾›æ˜¾å¼çš„ True æˆ– False å€¼ã€‚[[REF]](https://sagemaker.readthedocs.io/en/stable/frameworks/pytorch/using_pytorch.html#prepare-a-pytorch-training-script)ã€‚

### å¯åŠ¨è®­ç»ƒ

æ‚¨å¯ä»¥ä½¿ç”¨ ğŸ¤— Accelerate CLI å¯åŠ¨è®­ç»ƒï¼š

```py
accelerate launch path_to_script.py --args_to_the_script
```

è¿™å°†ä½¿ç”¨æ‚¨çš„é…ç½®å¯åŠ¨è®­ç»ƒè„šæœ¬ã€‚æ‚¨å”¯ä¸€éœ€è¦åšçš„å°±æ˜¯æä¾›è®­ç»ƒè„šæœ¬æ‰€éœ€çš„æ‰€æœ‰å‚æ•°ä½œä¸ºå‘½åå‚æ•°ã€‚

**ç¤ºä¾‹**

å¦‚æœæ‚¨è¿è¡Œå…¶ä¸­ä¸€ä¸ªç¤ºä¾‹è„šæœ¬ï¼Œè¯·ä¸è¦å¿˜è®°åœ¨å…¶ä¸­æ·»åŠ  `accelerator.save('/opt/ml/model')`ã€‚

```py
accelerate launch ./examples/sagemaker_example.py
```

è¾“å‡ºï¼š

```py
Configuring Amazon SageMaker environment
Converting Arguments to Hyperparameters
Creating Estimator
2021-04-08 11:56:50 Starting - Starting the training job...
2021-04-08 11:57:13 Starting - Launching requested ML instancesProfilerReport-1617883008: InProgress
.........
2021-04-08 11:58:54 Starting - Preparing the instances for training.........
2021-04-08 12:00:24 Downloading - Downloading input data
2021-04-08 12:00:24 Training - Downloading the training image..................
2021-04-08 12:03:39 Training - Training image download completed. Training in progress..
........
epoch 0: {'accuracy': 0.7598039215686274, 'f1': 0.8178438661710037}
epoch 1: {'accuracy': 0.8357843137254902, 'f1': 0.882249560632689}
epoch 2: {'accuracy': 0.8406862745098039, 'f1': 0.8869565217391304}
........
2021-04-08 12:05:40 Uploading - Uploading generated training model
2021-04-08 12:05:40 Completed - Training job completed
Training seconds: 331
Billable seconds: 331
You can find your model data at: s3://your-bucket/accelerate-sagemaker-1-2021-04-08-11-56-47-108/output/model.tar.gz
```

## é«˜çº§åŠŸèƒ½

### åˆ†å¸ƒå¼è®­ç»ƒï¼šæ•°æ®å¹¶è¡Œ

é€šè¿‡è¿è¡Œ `accelerate config` æ¥è®¾ç½®åŠ é€Ÿé…ç½®ï¼Œå¹¶å›ç­” SageMaker çš„é—®é¢˜å¹¶è®¾ç½®å®ƒã€‚è¦ä½¿ç”¨ SageMaker DDPï¼Œè¯·åœ¨è¯¢é—®æ—¶é€‰æ‹© `What is the distributed mode? ([0] No distributed training, [1] data parallelism):`ã€‚ä»¥ä¸‹æ˜¯ç¤ºä¾‹é…ç½®ï¼š

```py
base_job_name: accelerate-sagemaker-1
compute_environment: AMAZON_SAGEMAKER
distributed_type: DATA_PARALLEL
ec2_instance_type: ml.p3.16xlarge
iam_role_name: xxxxx
image_uri: null
mixed_precision: fp16
num_machines: 1
profile: xxxxx
py_version: py38
pytorch_version: 1.10.2
region: us-east-1
transformers_version: 4.17.0
use_cpu: false
```

### åˆ†å¸ƒå¼è®­ç»ƒï¼šæ¨¡å‹å¹¶è¡Œ

*ç›®å‰æ­£åœ¨å¼€å‘ä¸­ï¼Œå³å°†æ”¯æŒã€‚*

### Python åŒ…å’Œä¾èµ–é¡¹

ğŸ¤— Accelerate ç›®å‰ä½¿ç”¨ ğŸ¤— DLCsï¼Œé¢„å®‰è£…äº† `transformers`ã€`datasets` å’Œ `tokenizers`ã€‚å¦‚æœæ‚¨æƒ³ä½¿ç”¨ä¸åŒ/å…¶ä»– Python åŒ…ï¼Œå¯ä»¥é€šè¿‡å°†å®ƒä»¬æ·»åŠ åˆ° `requirements.txt` æ¥å®ç°ã€‚è¿™äº›åŒ…å°†åœ¨å¯åŠ¨è®­ç»ƒè„šæœ¬ä¹‹å‰å®‰è£…ã€‚

### æœ¬åœ°è®­ç»ƒï¼šSageMaker æœ¬åœ°æ¨¡å¼

SageMaker SDK ä¸­çš„æœ¬åœ°æ¨¡å¼å…è®¸æ‚¨åœ¨ HuggingFace DLCï¼ˆæ·±åº¦å­¦ä¹ å®¹å™¨ï¼‰å†…éƒ¨æˆ–ä½¿ç”¨è‡ªå®šä¹‰å®¹å™¨æ˜ åƒåœ¨æœ¬åœ°è¿è¡Œè®­ç»ƒè„šæœ¬ã€‚è¿™å¯¹äºåœ¨æœ€ç»ˆå®¹å™¨ç¯å¢ƒå†…è°ƒè¯•å’Œæµ‹è¯•æ‚¨çš„è®­ç»ƒè„šæœ¬éå¸¸æœ‰ç”¨ã€‚æœ¬åœ°æ¨¡å¼ä½¿ç”¨ Docker composeï¼ˆ*æ³¨æ„ï¼šå°šä¸æ”¯æŒ Docker Compose V2*ï¼‰ã€‚SDK å°†å¤„ç†å¯¹ ECR çš„èº«ä»½éªŒè¯ï¼Œä»¥å°† DLC æ‹‰åˆ°æ‚¨çš„æœ¬åœ°ç¯å¢ƒã€‚æ‚¨å¯ä»¥æ¨¡æ‹Ÿ CPUï¼ˆå•å®ä¾‹å’Œå¤šå®ä¾‹ï¼‰å’Œ GPUï¼ˆå•å®ä¾‹ï¼‰SageMaker è®­ç»ƒä½œä¸šã€‚

è¦ä½¿ç”¨æœ¬åœ°æ¨¡å¼ï¼Œæ‚¨éœ€è¦å°†`ec2_instance_type`è®¾ç½®ä¸º`local`ã€‚

```py
ec2_instance_type: local
```

### é«˜çº§é…ç½®

é…ç½®å…è®¸æ‚¨è¦†ç›–[Estimator](https://sagemaker.readthedocs.io/en/stable/api/training/estimators.html)çš„å‚æ•°ã€‚è¿™äº›è®¾ç½®å¿…é¡»åœ¨é…ç½®æ–‡ä»¶ä¸­åº”ç”¨ï¼Œä¸æ˜¯`accelerate config`çš„ä¸€éƒ¨åˆ†ã€‚æ‚¨å¯ä»¥æ§åˆ¶è®­ç»ƒä½œä¸šçš„è®¸å¤šå…¶ä»–æ–¹é¢ï¼Œä¾‹å¦‚ä½¿ç”¨Spotå®ä¾‹ï¼Œå¯ç”¨ç½‘ç»œéš”ç¦»ç­‰ç­‰ã€‚

```py
additional_args:
  # enable network isolation to restrict internet access for containers
  enable_network_isolation: True
```

æ‚¨å¯ä»¥åœ¨[è¿™é‡Œ](https://sagemaker.readthedocs.io/en/stable/api/training/estimators.html)æ‰¾åˆ°æ‰€æœ‰å¯ç”¨çš„é…ç½®ã€‚

### ä½¿ç”¨Spotå®ä¾‹

æ‚¨å¯ä»¥ä½¿ç”¨Spotå®ä¾‹ï¼Œä¾‹å¦‚ï¼ˆè¯·å‚é˜…[é«˜çº§é…ç½®](#advanced-configuration)ï¼‰ï¼š

```py
additional_args:
  use_spot_instances: True
  max_wait: 86400
```

*æ³¨æ„ï¼šSpotå®ä¾‹å¯èƒ½ä¼šè¢«ç»ˆæ­¢ï¼Œè®­ç»ƒå°†ä»æ£€æŸ¥ç‚¹ç»§ç»­ã€‚è¿™åœ¨ğŸ¤— Accelerateä¸­æ²¡æœ‰é»˜è®¤å¤„ç†ã€‚å¦‚æœæ‚¨éœ€è¦æ­¤åŠŸèƒ½ï¼Œè¯·è”ç³»æˆ‘ä»¬ã€‚*

### è¿œç¨‹è„šæœ¬ï¼šä½¿ç”¨ä½äºGithubä¸Šçš„è„šæœ¬

*å°šæœªç¡®å®šæ˜¯å¦éœ€è¦æ­¤åŠŸèƒ½ã€‚å¦‚æœæ‚¨éœ€è¦æ­¤åŠŸèƒ½ï¼Œè¯·è”ç³»æˆ‘ä»¬ã€‚*
