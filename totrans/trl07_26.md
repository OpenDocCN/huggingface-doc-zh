# å­¦ä¹ å·¥å…·ï¼ˆå®éªŒæ€§ ğŸ§ªï¼‰

> åŸå§‹æ–‡æœ¬ï¼š[`huggingface.co/docs/trl/learning_tools`](https://huggingface.co/docs/trl/learning_tools)

æœ€è¿‘ï¼Œä½¿ç”¨å¤§å‹è¯­è¨€æ¨¡å‹ï¼ˆLLMsï¼‰ä¸å·¥å…·çš„è¯é¢˜å¤‡å—å…³æ³¨ï¼Œå¦‚[ToolFormer](https://arxiv.org/abs/2302.04761)å’Œ[ToolBench](https://arxiv.org/pdf/2305.16504.pdf)ç­‰å‡ºè‰²çš„ä½œå“ã€‚åœ¨ TRL ä¸­ï¼Œæˆ‘ä»¬æä¾›äº†ä¸€ä¸ªç®€å•çš„ç¤ºä¾‹ï¼Œå±•ç¤ºå¦‚ä½•ä½¿ç”¨å¼ºåŒ–å­¦ä¹ æ•™æˆ LLM ä½¿ç”¨å·¥å…·ã€‚

ä»¥ä¸‹æ˜¯[trl å­˜å‚¨åº“](https://github.com/lvwerra/trl/tree/main/examples/research_projects/tools)ä¸­è„šæœ¬çš„æ¦‚è¿°ï¼š

| æ–‡ä»¶ | æè¿° |
| --- | --- |
| [`calculator.py`](https://github.com/lvwerra/trl/blob/main/examples/research_projects/tools/calculator.py) | ç”¨äºè®­ç»ƒ LLM ä½¿ç”¨å¼ºåŒ–å­¦ä¹ ä½¿ç”¨è®¡ç®—å™¨çš„è„šæœ¬ã€‚ |
| [`triviaqa.py`](https://github.com/lvwerra/trl/blob/main/examples/research_projects/tools/triviaqa.py) | ç”¨äºè®­ç»ƒ LLM ä½¿ç”¨ç»´åŸºå·¥å…·å›ç­”é—®é¢˜çš„è„šæœ¬ã€‚ |
| [`python_interpreter.py`](https://github.com/lvwerra/trl/blob/main/examples/research_projects/tools/python_interpreter.py) | ç”¨äºè®­ç»ƒ LLM ä½¿ç”¨ Python è§£é‡Šå™¨è§£å†³æ•°å­¦éš¾é¢˜çš„è„šæœ¬ã€‚ |

è¯·æ³¨æ„ï¼Œä¸Šè¿°è„šæœ¬ä¸¥é‡ä¾èµ–äºä»åœ¨ç§¯æå¼€å‘ä¸­çš„`TextEnvironment` APIã€‚API å¯èƒ½ä¼šåœ¨æœªæ¥å‘ç”Ÿå˜åŒ–ã€‚è¯·å‚é˜…`TextEnvironment`ä»¥è·å–ç›¸å…³æ–‡æ¡£ã€‚

## å­¦ä¹ ä½¿ç”¨è®¡ç®—å™¨

å¤§è‡´æƒ³æ³•å¦‚ä¸‹ï¼š

1.  åŠ è½½ä¸€ä¸ªå·¥å…·ï¼Œæ¯”å¦‚[ybelkada/simple-calculator](https://huggingface.co/spaces/ybelkada/simple-calculator)ï¼Œè§£ææ–‡æœ¬è®¡ç®—å¦‚`"14 + 34"`å¹¶è¿”å›è®¡ç®—åçš„æ•°å­—ï¼š

    ```py
    from transformers import AutoTokenizer, load_tool
    tool = load_tool("ybelkada/simple-calculator")
    tool_fn = lambda text: str(round(float(tool(text)), 2))  # rounding to 2 decimal places
    ```

1.  å®šä¹‰ä¸€ä¸ªå¥–åŠ±å‡½æ•°ï¼Œå¦‚æœå·¥å…·è¿”å›æ­£ç¡®ç­”æ¡ˆåˆ™è¿”å›æ­£å¥–åŠ±ã€‚åœ¨è„šæœ¬ä¸­ï¼Œæˆ‘ä»¬åˆ›å»ºäº†ä¸€ä¸ªè™šæ‹Ÿçš„å¥–åŠ±å‡½æ•°ï¼Œå¦‚`reward_fn = lambda x: 1`ï¼Œä½†æˆ‘ä»¬ç¨åç›´æ¥è¦†ç›–äº†å¥–åŠ±ã€‚

1.  åˆ›å»ºå¦‚ä½•ä½¿ç”¨å·¥å…·çš„æç¤º

    ```py
    # system prompt
    prompt = """\
    What is 13.1-3?

    <request><SimpleCalculatorTool>13.1-3<call>10.1<response>

    Result=10.1<submit>

    What is 4*3?

    <request><SimpleCalculatorTool>4*3<call>12<response>

    Result=12<submit>

    What is 12.1+1?

    <request><SimpleCalculatorTool>12.1+1<call>13.1<response>

    Result=13.1<submit>

    What is 12.1-20?

    <request><SimpleCalculatorTool>12.1-20<call>-7.9<response>

    Result=-7.9<submit>"""
    ```

1.  ä½¿ç”¨æ¨¡å‹åˆ›å»ºä¸€ä¸ª`trl.TextEnvironment`

    ```py
    env = TextEnvironment(
        model,
        tokenizer,
        {"SimpleCalculatorTool": tool_fn},
        reward_fn,
        prompt,
        generation_kwargs=generation_kwargs,
    )
    ```

1.  ç„¶åç”Ÿæˆä¸€äº›æ•°æ®ï¼Œå¦‚`tasks = ["\n\nWhat is 13.1-3?", "\n\nWhat is 4*3?"]`ï¼Œå¹¶ä½¿ç”¨`queries, responses, masks, rewards, histories = env.run(tasks)`è¿è¡Œç¯å¢ƒã€‚ç¯å¢ƒå°†æŸ¥æ‰¾æç¤ºä¸­çš„`<call>`æ ‡è®°ï¼Œå¹¶å°†å·¥å…·è¾“å‡ºé™„åŠ åˆ°å“åº”ä¸­ï¼›å®ƒè¿˜å°†è¿”å›ä¸å“åº”ç›¸å…³çš„æ©ç ã€‚æ‚¨å¯ä»¥è¿›ä¸€æ­¥ä½¿ç”¨`histories`æ¥å¯è§†åŒ–æ¨¡å‹å’Œå·¥å…·ä¹‹é—´çš„äº¤äº’ï¼›`histories[0].show_text()`å°†æ˜¾ç¤ºå¸¦æœ‰é¢œè‰²ç¼–ç å·¥å…·è¾“å‡ºçš„æ–‡æœ¬ï¼Œ`histories[0].show_tokens(tokenizer)`å°†æ˜¾ç¤ºå¯è§†åŒ–çš„æ ‡è®°ã€‚![](img/e9b6e7b4e250b332fcbd9626573e3f25.png)

1.  æœ€åï¼Œæˆ‘ä»¬å¯ä»¥ä½¿ç”¨`train_stats = ppo_trainer.step(queries, responses, rewards, masks)`æ¥è®­ç»ƒæ¨¡å‹ã€‚è®­ç»ƒå™¨å°†ä½¿ç”¨æ©ç åœ¨è®¡ç®—æŸå¤±æ—¶å¿½ç•¥å·¥å…·è¾“å‡ºï¼Œè¯·ç¡®ä¿å°†è¯¥å‚æ•°ä¼ é€’ç»™`step`ã€‚

## å®éªŒç»“æœ

æˆ‘ä»¬ä½¿ç”¨ä¸Šè¿°è„šæœ¬å¯¹æ¨¡å‹è¿›è¡Œäº† 10 ä¸ªéšæœºç§å­çš„è®­ç»ƒã€‚æ‚¨å¯ä»¥ä½¿ç”¨ä»¥ä¸‹å‘½ä»¤é‡ç°è¿è¡Œã€‚å¦‚æœæ‚¨æ— æ³•è®¿é—® slurm é›†ç¾¤ï¼Œè¯·éšæ—¶åˆ é™¤`--slurm-*`å‚æ•°ã€‚

```py
WANDB_TAGS="calculator_final" python benchmark/benchmark.py \
    --command "python examples/research_projects/tools/calculator.py" \
    --num-seeds 10 \
    --start-seed 1 \
    --workers 10 \
    --slurm-gpus-per-task 1 \
    --slurm-ntasks 1 \
    --slurm-total-cpus 8 \
    --slurm-template-path benchmark/trl.slurm_template
```

ç„¶åæˆ‘ä»¬å¯ä»¥ä½¿ç”¨[`openrlbenchmark`](https://github.com/openrlbenchmark/openrlbenchmark)ç”Ÿæˆä»¥ä¸‹å›¾è¡¨ã€‚

```py
python -m openrlbenchmark.rlops_multi_metrics \
    --filters '?we=openrlbenchmark&wpn=trl&xaxis=_step&ceik=trl_ppo_trainer_config.value.tracker_project_name&cen=trl_ppo_trainer_config.value.log_with&metrics=env/reward_mean&metrics=objective/kl' \
        'wandb?tag=calculator_final&cl=calculator_mask' \
    --env-ids trl \
    --check-empty-runs \
    --pc.ncols 2 \
    --pc.ncols-legend 1 \
    --output-filename static/0compare \
    --scan-history
```

![](img/6cbe96fa603fe61845da0a4c0fbf4641.png)

æ­£å¦‚æˆ‘ä»¬æ‰€çœ‹åˆ°çš„ï¼Œè™½ç„¶æœ‰ 1-2 æ¬¡å®éªŒç”±äºæŸç§åŸå› å´©æºƒï¼Œä½†å¤§å¤šæ•°è¿è¡Œåœ¨è®¡ç®—å™¨ä»»åŠ¡ä¸­è·å¾—äº†æ¥è¿‘å®Œç¾çš„ç†Ÿç»ƒåº¦ã€‚

## ï¼ˆæ—©æœŸå®éªŒ ğŸ§ªï¼‰ï¼šå­¦ä¹ ä½¿ç”¨ç»´åŸºå·¥å…·å›ç­”é—®é¢˜

åœ¨[ToolFormer](https://arxiv.org/abs/2302.04761)è®ºæ–‡ä¸­ï¼Œå±•ç¤ºäº†ä¸€ä¸ªæœ‰è¶£çš„ç”¨ä¾‹ï¼Œåˆ©ç”¨ç»´åŸºç™¾ç§‘æœç´¢å·¥å…·æ¥å¸®åŠ©å›ç­”é—®é¢˜ã€‚åœ¨è¿™ä¸€éƒ¨åˆ†ï¼Œæˆ‘ä»¬å°è¯•è¿›è¡Œç±»ä¼¼çš„å®éªŒï¼Œä½†æ˜¯ä½¿ç”¨ RL æ¥æ•™æˆæ¨¡å‹å¦‚ä½•åœ¨[TriviaQA](https://nlp.cs.washington.edu/triviaqa/)æ•°æ®é›†ä¸Šä½¿ç”¨ç»´åŸºå·¥å…·ã€‚

**è¯·æ³¨æ„ï¼Œè®¸å¤šè®¾ç½®ä¸åŒï¼Œå› æ­¤ç»“æœä¸èƒ½ç›´æ¥è¿›è¡Œæ¯”è¾ƒã€‚**

### æ„å»ºæœç´¢ç´¢å¼•

ç”±äº[ToolFormer](https://arxiv.org/abs/2302.04761)æ²¡æœ‰å¼€æºï¼Œæˆ‘ä»¬éœ€è¦é¦–å…ˆå¤åˆ¶æœç´¢ç´¢å¼•ã€‚åœ¨ä»–ä»¬çš„è®ºæ–‡ä¸­æåˆ°ï¼Œä½œè€…ä½¿ç”¨ BM25 æ£€ç´¢å™¨æ„å»ºäº†æœç´¢ç´¢å¼•ï¼Œè¯¥æ£€ç´¢å™¨ä»[KILT](https://github.com/facebookresearch/KILT)çš„ç»´åŸºç™¾ç§‘è½¬å‚¨ä¸­æ£€ç´¢

å¹¸è¿çš„æ˜¯ï¼Œ[`pyserini`](https://github.com/castorini/pyserini)å·²ç»å®ç°äº† BM25 æ£€ç´¢å™¨ï¼Œå¹¶ä¸º KILT ç»´åŸºç™¾ç§‘è½¬å‚¨æä¾›äº†é¢„æ„å»ºçš„ç´¢å¼•ã€‚æˆ‘ä»¬å¯ä»¥ä½¿ç”¨ä»¥ä¸‹ä»£ç æœç´¢ç´¢å¼•ã€‚

```py
from pyserini.search.lucene import LuceneSearcher
import json
searcher = LuceneSearcher.from_prebuilt_index('wikipedia-kilt-doc')
def search(query):
    hits = searcher.search(query, k=1)
    hit = hits[0]
    contents = json.loads(hit.raw)['contents']
    return contents
print(search("tennis racket"))
```

```py
Racket (sports equipment)
A racket or racquet is a sports implement consisting of a handled frame with an open hoop across which a network of strings or catgut is stretched tightly. It is used for striking a ball or shuttlecock in games such as squash, tennis, racquetball, and badminton. Collectively, these games are known as racket sports. Racket design and manufacturing has changed considerably over the centuries.

The frame of rackets for all sports was traditionally made of solid wood (later laminated wood) and the strings of animal intestine known as catgut. The traditional racket size was limited by the strength and weight of the wooden frame which had to be strong enough to hold the strings and stiff enough to hit the ball or shuttle. Manufacturers started adding non-wood laminates to wood rackets to improve stiffness. Non-wood rackets were made first of steel, then of aluminum, and then carbon fiber composites. Wood is still used for real tennis, rackets, and xare. Most rackets are now made of composite materials including carbon fiber or fiberglass, metals such as titanium alloys, or ceramics.
...
```

ç„¶åï¼Œæˆ‘ä»¬åŸºæœ¬ä¸Šå°†è¿™ä¸ªç‰‡æ®µéƒ¨ç½²ä¸º Hugging Face ç©ºé—´[è¿™é‡Œ](https://huggingface.co/spaces/vwxyzjn/pyserini-wikipedia-kilt-doc)ï¼Œä»¥ä¾¿ç¨åå¯ä»¥å°†ç©ºé—´ç”¨ä½œ`transformers.Tool`ã€‚

![](img/99bd431ca68ab971be553352b4f02e67.png)

### å®éªŒè®¾ç½®

æˆ‘ä»¬ä½¿ç”¨ä»¥ä¸‹è®¾ç½®ï¼š

+   ä½¿ç”¨`bigcode/starcoderbase`æ¨¡å‹ä½œä¸ºåŸºç¡€æ¨¡å‹

+   ä½¿ç”¨`pyserini-wikipedia-kilt-doc`ç©ºé—´ä½œä¸ºç»´åŸºå·¥å…·ï¼Œå¹¶ä»…ä½¿ç”¨æœç´¢ç»“æœçš„ç¬¬ä¸€æ®µï¼Œå…è®¸`TextEnvironment`ä»å·¥å…·ä¸­æœ€å¤šè·å¾—`max_tool_reponse=400`ä¸ªå“åº”æ ‡è®°ã€‚

+   æµ‹è¯•å›å¤æ˜¯å¦åŒ…å«ç­”æ¡ˆå­—ç¬¦ä¸²ï¼Œå¦‚æœæ˜¯ï¼Œåˆ™å¥–åŠ± 1ï¼Œå¦åˆ™ï¼Œå¥–åŠ± 0ã€‚

    +   è¯·æ³¨æ„ï¼Œè¿™æ˜¯ä¸€ä¸ªç®€åŒ–çš„è¯„ä¼°æ ‡å‡†ã€‚åœ¨[ToolFormer](https://arxiv.org/abs/2302.04761)ä¸­ï¼Œä½œè€…æ£€æŸ¥å›å¤çš„å‰ 20 ä¸ªå•è¯æ˜¯å¦åŒ…å«æ­£ç¡®ç­”æ¡ˆã€‚

+   ä½¿ç”¨ä»¥ä¸‹æ¼”ç¤ºäº†ç»´åŸºå·¥å…·çš„ç”¨æ³•çš„æç¤ºã€‚

```py
prompt = """\
Answer the following question:

Q: In which branch of the arts is Patricia Neary famous?
A: Ballets
A2: <request><Wiki>Patricia Neary<call>Patricia Neary (born October 27, 1942) is an American ballerina, choreographer and ballet director, who has been particularly active in Switzerland. She has also been a highly successful ambassador for the Balanchine Trust, bringing George Balanchine's ballets to 60 cities around the globe.<response>
Result=Ballets<submit>

Q: Who won Super Bowl XX?
A: Chicago Bears
A2: <request><Wiki>Super Bowl XX<call>Super Bowl XX was an American football game between the National Football Conference (NFC) champion Chicago Bears and the American Football Conference (AFC) champion New England Patriots to decide the National Football League (NFL) champion for the 1985 season. The Bears defeated the Patriots by the score of 46â€“10, capturing their first NFL championship (and Chicago's first overall sports victory) since 1963, three years prior to the birth of the Super Bowl. Super Bowl XX was played on January 26, 1986 at the Louisiana Superdome in New Orleans.<response>
Result=Chicago Bears<submit>

Q: """
```

### ç»“æœå’Œè®¨è®º

æˆ‘ä»¬çš„å®éªŒè¡¨æ˜ï¼Œä»£ç†å¯ä»¥å­¦ä¼šä½¿ç”¨ç»´åŸºå·¥å…·æ¥å›ç­”é—®é¢˜ã€‚å­¦ä¹ æ›²çº¿å¤§å¤šä¼šä¸Šå‡ï¼Œä½†å…¶ä¸­ä¸€ä¸ªå®éªŒå´©æºƒäº†ã€‚

![](img/a85eaae9f29d7074402801be154c2d57.png)

Wandb æŠ¥å‘Šåœ¨[è¿™é‡Œ](https://wandb.ai/costa-huang/cleanRL/reports/TriviaQA-Final-Experiments--Vmlldzo1MjY0ODk5)è¿›è¡Œè¿›ä¸€æ­¥æ£€æŸ¥ã€‚

è¯·æ³¨æ„ï¼Œè®­ç»ƒæ¨¡å‹çš„æ­£ç¡®ç‡è¾ƒä½ï¼Œå¯èƒ½æ˜¯ç”±äºä»¥ä¸‹åŸå› ï¼š

+   **é”™è¯¯çš„æœç´¢:** å½“ç»™å‡ºé—®é¢˜`â€œå¸ƒé²æ–¯Â·å¨åˆ©æ–¯çš„çœŸå®åå­—æ˜¯ä»€ä¹ˆï¼Ÿâ€`æ—¶ï¼Œå¦‚æœæ¨¡å‹æœç´¢`å¸ƒé²æ–¯Â·å¨åˆ©æ–¯`ï¼Œæˆ‘ä»¬çš„ç»´åŸºå·¥å…·è¿”å›â€œå¸•ç‰¹é‡Œå…‹Â·æ™®ç“¦ï¼ˆå‡ºç”Ÿäº 1948 å¹´ 2 æœˆ 18 æ—¥ï¼‰æ˜¯ä¸€ä½æ³•å›½æ¼”å‘˜ã€‚ä»–ä»¥ä»–çš„å£°éŸ³è€Œé—»åï¼šè‡ª 1988 å¹´ä»¥æ¥ï¼Œä»–ä¸€ç›´æ˜¯å¸ƒé²æ–¯Â·å¨åˆ©æ–¯çš„æ³•è¯­é…éŸ³ã€‚â€ä½†æ­£ç¡®çš„æœç´¢åº”è¯¥æ˜¯`æ²ƒå°”ç‰¹Â·å¸ƒé²æ–¯Â·å¨åˆ©æ–¯ï¼ˆå‡ºç”Ÿäº 1955 å¹´ 3 æœˆ 19 æ—¥ï¼‰æ˜¯ä¸€ä½ç¾å›½å‰æ¼”å‘˜ã€‚ä»–å› åœ¨å–œå‰§å‰§é›†ã€Šæœˆå…‰å…‰ã€‹ï¼ˆ1985-1989ï¼‰ä¸­æ‹…ä»»ä¸»è§’è€Œæˆåï¼Œå¹¶åœ¨ä¸€ç™¾å¤šéƒ¨ç”µå½±ä¸­å‡ºæ¼”ï¼Œå› åœ¨ã€Šè™èƒ†é¾™å¨ã€‹ç³»åˆ—ï¼ˆ1988-2013ï¼‰ä¸­æ‰®æ¼”çº¦ç¿°Â·éº¦å…‹è±æ©è€Œè¢«è®¤å¯ä¸ºåŠ¨ä½œè‹±é›„ä»¥åŠå…¶ä»–è§’è‰²è€Œè·å¾—è®¤å¯ã€‚`

![](img/36b96862e37367132a174f261df0cb60.png)

+   **ä¸å¿…è¦çš„é•¿å›å¤:** é»˜è®¤æƒ…å†µä¸‹ï¼Œç»´åŸºå·¥å…·æœ‰æ—¶ä¼šè¾“å‡ºéå¸¸é•¿çš„åºåˆ—ã€‚ä¾‹å¦‚ï¼Œå½“ç»´åŸºå·¥å…·æœç´¢â€œå¸ƒæœ—æ³•æ¡ˆâ€æ—¶

    +   æˆ‘ä»¬çš„ç»´åŸºå·¥å…·è¿”å›â€œæ‹‰å°”å¤«Â·MÂ·å¸ƒæœ—æ³•æ¡ˆï¼Œä½äºåŠ åˆ©ç¦å°¼äºšæ”¿åºœæ³•å…¸ 54950â€œç­‰ç­‰â€ï¼Œæ˜¯åŠ åˆ©ç¦å°¼äºšå·è®®ä¼šçš„ä¸€é¡¹æ³•æ¡ˆï¼Œç”±è®®å‘˜æ‹‰å°”å¤«Â·MÂ·å¸ƒæœ—æ’°å†™å¹¶äº 1953 å¹´é€šè¿‡ï¼Œä¿è¯äº†å…¬ä¼—æœ‰æƒå‚åŠ å’Œå‚ä¸åœ°æ–¹ç«‹æ³•æœºæ„çš„ä¼šè®®ã€‚â€

    +   [ToolFormer](https://arxiv.org/abs/2302.04761)çš„ç»´åŸºå·¥å…·è¿”å›â€œæ‹‰å°”å¤«Â·MÂ·å¸ƒæœ—æ³•æ¡ˆæ˜¯åŠ åˆ©ç¦å°¼äºšå·è®®ä¼šçš„ä¸€é¡¹æ³•æ¡ˆï¼Œä¿è¯äº†å…¬ä¼—æœ‰æƒå‚åŠ å’Œå‚ä¸åœ°æ–¹ç«‹æ³•æœºæ„çš„ä¼šè®®ã€‚â€æ›´ä¸ºç®€æ´ã€‚

        ![](img/03829057729a612fe5243cc49785765b.png)

## ï¼ˆæ—©æœŸå®éªŒğŸ§ªï¼‰ï¼šä½¿ç”¨ Python è§£é‡Šå™¨è§£å†³æ•°å­¦éš¾é¢˜

åœ¨è¿™ä¸€éƒ¨åˆ†ï¼Œæˆ‘ä»¬å°è¯•æ•™å¯¼æ¨¡å‹ä½¿ç”¨ Python è§£é‡Šå™¨æ¥è§£å†³æ•°å­¦éš¾é¢˜ã€‚å¤§è‡´çš„æƒ³æ³•æ˜¯ç»™äºˆä»£ç†ä¸€ä¸ªç±»ä¼¼ä»¥ä¸‹çš„æç¤ºï¼š

```py
prompt = """\
Example of using a Python API to solve math questions.

Q: Olivia has $23\. She bought five bagels for $3 each. How much money does she have left?

<request><PythonInterpreter>
def solution():
    money_initial = 23
    bagels = 5
    bagel_cost = 3
    money_spent = bagels * bagel_cost
    money_left = money_initial - money_spent
    result = money_left
    return result
print(solution())
<call>72<response>

Result = 72 <submit>

Q: """
```

è®­ç»ƒå®éªŒå¯ä»¥åœ¨[`wandb.ai/lvwerra/trl-gsm8k/runs/a5odv01y`](https://wandb.ai/lvwerra/trl-gsm8k/runs/a5odv01y)æ‰¾åˆ°

![](img/07e24d84156093ad57f614545aaa5ab2.png)
