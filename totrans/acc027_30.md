# ğŸ¤— Accelerateçš„å†…éƒ¨æœºåˆ¶

> åŸæ–‡é“¾æ¥ï¼š[https://huggingface.co/docs/accelerate/concept_guides/internal_mechanism](https://huggingface.co/docs/accelerate/concept_guides/internal_mechanism)

åœ¨å†…éƒ¨ï¼ŒğŸ¤— Accelerateé¦–å…ˆåˆ†æå¯åŠ¨è„šæœ¬çš„ç¯å¢ƒï¼Œä»¥ç¡®å®šä½¿ç”¨äº†å“ªç§ç±»å‹çš„åˆ†å¸ƒå¼è®¾ç½®ï¼Œæœ‰å¤šå°‘ä¸ªä¸åŒçš„è¿›ç¨‹ä»¥åŠå½“å‰è„šæœ¬åœ¨å“ªä¸ªè¿›ç¨‹ä¸­ã€‚æ‰€æœ‰è¿™äº›ä¿¡æ¯éƒ½å­˜å‚¨åœ¨`~AcceleratorState`ä¸­ã€‚

è¿™ä¸ªç±»åœ¨æ‚¨ç¬¬ä¸€æ¬¡å®ä¾‹åŒ–[~Accelerator](/docs/accelerate/v0.27.2/en/package_reference/accelerator#accelerate.Accelerator)æ—¶åˆå§‹åŒ–ï¼Œä»¥åŠæ‰§è¡Œä»»ä½•ç‰¹å®šäºæ‚¨çš„åˆ†å¸ƒå¼è®¾ç½®éœ€è¦çš„åˆå§‹åŒ–ã€‚ç„¶åï¼Œå®ƒçš„çŠ¶æ€é€šè¿‡æ‰€æœ‰[AcceleratorState](/docs/accelerate/v0.27.2/en/package_reference/state#accelerate.state.AcceleratorState)å®ä¾‹å”¯ä¸€å…±äº«ã€‚ï¼ˆä¹Ÿå¯ä»¥ä½¿ç”¨[PartialState](/docs/accelerate/v0.27.2/en/package_reference/state#accelerate.PartialState)æ¥å®Œæˆç›¸åŒçš„æ“ä½œï¼Œå®ƒæ˜¯ä¸€ä¸ªæ›´ç®€åŒ–çš„ç‰ˆæœ¬ï¼‰

ç„¶åï¼Œåœ¨è°ƒç”¨[prepare()](/docs/accelerate/v0.27.2/en/package_reference/accelerator#accelerate.Accelerator.prepare)æ—¶ï¼Œåº“ï¼š

+   å°†æ‚¨çš„æ¨¡å‹åŒ…è£…åœ¨é€‚ç”¨äºåˆ†å¸ƒå¼è®¾ç½®çš„å®¹å™¨ä¸­ï¼Œ

+   å°†æ‚¨çš„ä¼˜åŒ–å™¨åŒ…è£…åœ¨[AcceleratedOptimizer](/docs/accelerate/v0.27.2/en/package_reference/torch_wrappers#accelerate.optimizer.AcceleratedOptimizer)ä¸­ï¼Œ

+   å°†æ‚¨çš„è°ƒåº¦ç¨‹åºåŒ…è£…åœ¨[AcceleratedScheduler](/docs/accelerate/v0.27.2/en/package_reference/torch_wrappers#accelerate.scheduler.AcceleratedScheduler)ä¸­

+   åœ¨[DataLoaderShard](/docs/accelerate/v0.27.2/en/package_reference/torch_wrappers#accelerate.data_loader.DataLoaderShard)æˆ–[DataLoaderDispatcher](/docs/accelerate/v0.27.2/en/package_reference/torch_wrappers#accelerate.data_loader.DataLoaderDispatcher)ä¸­åˆ›å»ºæ‚¨çš„æ•°æ®åŠ è½½å™¨çš„æ–°ç‰ˆæœ¬

è™½ç„¶æ¨¡å‹ã€ä¼˜åŒ–å™¨å’Œè°ƒåº¦ç¨‹åºåªæ˜¯ç®€å•çš„åŒ…è£…å™¨ï¼Œä½†æ•°æ®åŠ è½½å™¨æ˜¯é‡æ–°åˆ›å»ºçš„ã€‚è¿™ä¸»è¦æ˜¯å› ä¸ºPyTorchä¸å…è®¸ç”¨æˆ·åœ¨åˆ›å»ºåæ›´æ”¹æ•°æ®åŠ è½½å™¨çš„`batch_sampler`ï¼Œè€Œåº“é€šè¿‡å°†`batch_sampler`æ›´æ”¹ä¸ºæ¯éš”å…¶ä»–`num_processes`æ‰¹æ¬¡ï¼ˆå¦‚æœå¯ç”¨ï¼‰æ¥å¤„ç†æ•°æ®åœ¨è¿›ç¨‹ä¹‹é—´çš„åˆ†ç‰‡ã€‚

[DataLoaderShard](/docs/accelerate/v0.27.2/en/package_reference/torch_wrappers#accelerate.data_loader.DataLoaderShard)å­ç±»`DataLoader`ä»¥æ·»åŠ ä»¥ä¸‹åŠŸèƒ½ï¼š

+   å®ƒåœ¨æ¯æ¬¡æ–°è¿­ä»£æ—¶åŒæ­¥æ‰€æœ‰è¿›ç¨‹çš„é€‚å½“éšæœºæ•°ç”Ÿæˆå™¨ï¼Œä»¥ç¡®ä¿ä»»ä½•éšæœºåŒ–ï¼ˆå¦‚æ´—ç‰Œï¼‰åœ¨æ‰€æœ‰è¿›ç¨‹ä¸­éƒ½ä»¥å®Œå…¨ç›¸åŒçš„æ–¹å¼è¿›è¡Œã€‚

+   åœ¨äº§ç”Ÿæ‰¹æ¬¡ä¹‹å‰å°†æ‰¹æ¬¡æ”¾åœ¨æ­£ç¡®çš„è®¾å¤‡ä¸Šï¼ˆé™¤éæ‚¨é€‰æ‹©äº†`device_placement=True`ï¼‰ã€‚

[DataLoaderDispatcher](/docs/accelerate/v0.27.2/en/package_reference/torch_wrappers#accelerate.data_loader.DataLoaderDispatcher)å­ç±»ä¸[DataLoaderShard](/docs/accelerate/v0.27.2/en/package_reference/torch_wrappers#accelerate.data_loader.DataLoaderShard)ä¸åŒä¹‹å¤„åœ¨äºï¼Œå½“é€šè¿‡`DataLoader`è¿­ä»£æ—¶ï¼Œæ•°æ®éƒ½æ˜¯ä»è¿›ç¨‹0å¼€å§‹ï¼Œç„¶åå†åˆ†å‰²å¹¶å‘é€åˆ°æ¯ä¸ªè¿›ç¨‹ï¼Œè€Œä¸æ˜¯åœ¨æ•°æ®é›†çº§åˆ«å‘ç”Ÿã€‚

é»˜è®¤æƒ…å†µä¸‹ï¼Œéšæœºæ•°ç”Ÿæˆå™¨åŒæ­¥å°†åŒæ­¥ï¼š

+   ç»™å®šé‡‡æ ·å™¨ï¼ˆå¦‚PyTorchçš„`RandomSampler`ï¼‰çš„`generator`å±æ€§ï¼Œé€‚ç”¨äºPyTorch >= 1.6

+   PyTorch <=1.5.1ä¸­çš„ä¸»éšæœºæ•°ç”Ÿæˆå™¨

æ‚¨å¯ä»¥é€šè¿‡ä¸»[Accelerator](/docs/accelerate/v0.27.2/en/package_reference/accelerator#accelerate.Accelerator)çš„`rng_types`å‚æ•°é€‰æ‹©è¦ä¸ä¹‹åŒæ­¥çš„éšæœºæ•°ç”Ÿæˆå™¨ã€‚åœ¨PyTorch >= 1.6ä¸­ï¼Œå»ºè®®ä¾èµ–äºæœ¬åœ°`generator`ï¼Œä»¥é¿å…åœ¨æ‰€æœ‰è¿›ç¨‹ä¸­è®¾ç½®ç›¸åŒçš„ç§å­ã€‚

ä¸»è¦torchï¼ˆæˆ–CUDAæˆ–XLAï¼‰éšæœºæ•°ç”Ÿæˆå™¨çš„åŒæ­¥å°†å½±å“æ•°æ®é›†ä¸­å¯èƒ½å­˜åœ¨çš„ä»»ä½•å…¶ä»–éšæœºç°è±¡ï¼ˆå¦‚éšæœºæ•°æ®å¢å¼ºï¼‰ï¼Œå› ä¸ºæ‰€æœ‰è¿›ç¨‹å°†ä»torchéšæœºæ¨¡å—ä¸­è·å¾—ç›¸åŒçš„éšæœºæ•°ï¼ˆå› æ­¤å¦‚æœç”±torchæ§åˆ¶ï¼Œåˆ™å°†åº”ç”¨ç›¸åŒçš„éšæœºæ•°æ®å¢å¼ºï¼‰ã€‚

æ‚¨è‡ªå®šä¹‰é‡‡æ ·å™¨ã€æ‰¹é‡é‡‡æ ·å™¨æˆ–å¯è¿­ä»£æ•°æ®é›†çš„éšæœºåŒ–éƒ¨åˆ†åº”è¯¥ä½¿ç”¨æœ¬åœ°çš„`torch.Generator`å¯¹è±¡æ¥å®Œæˆï¼ˆåœ¨PyTorch >= 1.6ä¸­ï¼‰ï¼Œå¯ä»¥å‚è€ƒä¼ ç»Ÿçš„`RandomSampler`ä½œä¸ºç¤ºä¾‹ã€‚

æœ‰å…³å†…éƒ¨è¯¦ç»†ä¿¡æ¯ï¼Œè¯·å‚é˜…[å†…éƒ¨é¡µé¢](package_reference/torch_wrappers)ã€‚
