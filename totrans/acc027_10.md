# æ•…éšœæ’é™¤æŒ‡å—

> åŸæ–‡é“¾æ¥ï¼š[https://huggingface.co/docs/accelerate/basic_tutorials/troubleshooting](https://huggingface.co/docs/accelerate/basic_tutorials/troubleshooting)

æœ¬æŒ‡å—æ—¨åœ¨ä¸ºæ‚¨æä¾›å¯¼èˆªä¸€äº›å¸¸è§é—®é¢˜æ‰€éœ€çš„å·¥å…·å’ŒçŸ¥è¯†ã€‚ç„¶è€Œï¼Œç”±äºğŸ¤— Accelerateä¸æ–­å‘å±•ï¼Œç”¨ä¾‹å’Œè®¾ç½®å¤šç§å¤šæ ·ï¼Œæ‚¨å¯èƒ½ä¼šé‡åˆ°æœ¬æŒ‡å—æœªæ¶µç›–çš„é—®é¢˜ã€‚å¦‚æœæœ¬æŒ‡å—ä¸­åˆ—å‡ºçš„å»ºè®®æœªæ¶µç›–æ‚¨çš„æƒ…å†µï¼Œè¯·å‚è€ƒæŒ‡å—çš„æœ€åä¸€éƒ¨åˆ†[å¯»æ±‚å¸®åŠ©](#ask-for-help)ï¼Œäº†è§£å¦‚ä½•åœ¨ç‰¹å®šé—®é¢˜ä¸Šå¯»æ±‚å¸®åŠ©ã€‚

## æ—¥å¿—è®°å½•

é¢å¯¹é”™è¯¯æ—¶ï¼Œæ—¥å¿—è®°å½•å¯ä»¥å¸®åŠ©ç¼©å°é”™è¯¯æ¥æºã€‚åœ¨å…·æœ‰å¤šä¸ªè¿›ç¨‹çš„åˆ†å¸ƒå¼è®¾ç½®ä¸­ï¼Œæ—¥å¿—è®°å½•å¯èƒ½æ˜¯ä¸€ä¸ªæŒ‘æˆ˜ï¼Œä½†ğŸ¤— Accelerateæä¾›äº†ä¸€ä¸ªå·¥å…·ï¼Œç®€åŒ–äº†æ—¥å¿—è®°å½•è¿‡ç¨‹ï¼Œå¹¶ç¡®ä¿æ—¥å¿—åœ¨åˆ†å¸ƒå¼è®¾ç½®ä¸­åŒæ­¥å’Œæœ‰æ•ˆç®¡ç†ã€‚

è¦è§£å†³é—®é¢˜ï¼Œè¯·ä½¿ç”¨`accelerate.logging`è€Œä¸æ˜¯æ ‡å‡†çš„Python `logging`æ¨¡å—ï¼š

```py
- import logging
+ from accelerate.logging import get_logger
- logger = logging.getLogger(__name__)
+ logger = get_logger(__name__)
```

è¦è®¾ç½®æ—¥å¿—çº§åˆ«ï¼ˆ`INFO`ï¼Œ`DEBUG`ï¼Œ`WARNING`ï¼Œ`ERROR`ï¼Œ`CRITICAL`ï¼‰ï¼Œè¯·å°†å…¶å¯¼å‡ºä¸º`ACCELERATE_LOG_LEVEL`ç¯å¢ƒï¼Œæˆ–å°†å…¶ä½œä¸º`log_level`ä¼ é€’ç»™`get_logger`ï¼š

```py
from accelerate.logging import get_logger

logger = get_logger(__name__, log_level="INFO")
```

é»˜è®¤æƒ…å†µä¸‹ï¼Œæ—¥å¿—ä»…åœ¨ä¸»è¿›ç¨‹ä¸Šè°ƒç”¨ã€‚è¦åœ¨æ‰€æœ‰è¿›ç¨‹ä¸Šè°ƒç”¨å®ƒï¼Œè¯·ä¼ é€’`main_process_only=False`ã€‚å¦‚æœæ—¥å¿—åº”åœ¨æ‰€æœ‰è¿›ç¨‹ä¸ŠæŒ‰é¡ºåºè°ƒç”¨ï¼Œè¿˜è¦ä¼ é€’`in_order=True`ã€‚

## æŒ‚èµ·ä»£ç å’Œè¶…æ—¶é”™è¯¯

### ä¸åŒ¹é…çš„å¼ é‡å½¢çŠ¶

å¦‚æœæ‚¨çš„ä»£ç åœ¨åˆ†å¸ƒå¼è®¾ç½®ä¸ŠæŒ‚èµ·äº†å¾ˆé•¿æ—¶é—´ï¼Œä¸€ä¸ªå¸¸è§åŸå› æ˜¯ä¸åŒè®¾å¤‡ä¸Šå¼ é‡çš„å½¢çŠ¶ä¸åŒ¹é…ã€‚

åœ¨ä»¥åˆ†å¸ƒå¼æ–¹å¼è¿è¡Œè„šæœ¬æ—¶ï¼Œè¯¸å¦‚[Accelerator.gather()](/docs/accelerate/v0.27.2/en/package_reference/accelerator#accelerate.Accelerator.gather)å’Œ[Accelerator.reduce()](/docs/accelerate/v0.27.2/en/package_reference/accelerator#accelerate.Accelerator.reduce)ç­‰å‡½æ•°æ˜¯å¿…è¦çš„ï¼Œä»¥è·¨è®¾å¤‡è·å–å¼ é‡ä»¥é›†ä½“æ‰§è¡Œæ“ä½œã€‚è¿™äº›ï¼ˆä»¥åŠå…¶ä»–ï¼‰å‡½æ•°ä¾èµ–äº`torch.distributed`æ‰§è¡Œ`gather`æ“ä½œï¼Œè¿™è¦æ±‚å¼ é‡åœ¨æ‰€æœ‰è¿›ç¨‹ä¸­å…·æœ‰**å®Œå…¨ç›¸åŒçš„å½¢çŠ¶**ã€‚å½“å¼ é‡å½¢çŠ¶ä¸åŒ¹é…æ—¶ï¼Œæ‚¨å°†é‡åˆ°æŒ‚èµ·ä»£ç ï¼Œå¹¶æœ€ç»ˆè§¦å‘è¶…æ—¶å¼‚å¸¸ã€‚

å¦‚æœæ‚¨æ€€ç–‘è¿™ç§æƒ…å†µï¼Œè¯·ä½¿ç”¨Accelerateçš„æ“ä½œè°ƒè¯•æ¨¡å¼ç«‹å³æ•æ‰é—®é¢˜ã€‚

å¯ç”¨Accelerateçš„æ“ä½œè°ƒè¯•æ¨¡å¼çš„æ¨èæ–¹æ³•æ˜¯åœ¨`accelerate config`è®¾ç½®æœŸé—´ã€‚å¯ç”¨è°ƒè¯•æ¨¡å¼çš„æ›¿ä»£æ–¹æ³•åŒ…æ‹¬ï¼š

+   ä»CLIï¼š

```py
accelerate launch --debug {my_script.py} --arg1 --arg2
```

+   ä½œä¸ºç¯å¢ƒå˜é‡ï¼ˆé¿å…éœ€è¦`accelerate launch`ï¼‰ï¼š

```py
ACCELERATE_DEBUG_MODE="1" torchrun {my_script.py} --arg1 --arg2
```

+   æ‰‹åŠ¨æ›´æ”¹`config.yaml`æ–‡ä»¶ï¼š

```py
 compute_environment: LOCAL_MACHINE
+debug: true
```

ä¸€æ—¦å¯ç”¨è°ƒè¯•æ¨¡å¼ï¼Œæ‚¨åº”è¯¥è·å¾—ç±»ä¼¼çš„å›æº¯ï¼ŒæŒ‡å‘å¼ é‡å½¢çŠ¶ä¸åŒ¹é…é—®é¢˜ï¼š

```py
Traceback (most recent call last):
  File "/home/zach_mueller_huggingface_co/test.py", line 18, in <module>
    main()
  File "/home/zach_mueller_huggingface_co/test.py", line 15, in main
    broadcast_tensor = broadcast(tensor)
  File "/home/zach_mueller_huggingface_co/accelerate/src/accelerate/utils/operations.py", line 303, in wrapper
accelerate.utils.operations.DistributedOperationException:

Cannot apply desired operation due to shape mismatches. All shapes across devices must be valid.

Operation: `accelerate.utils.operations.broadcast`
Input shapes:
  - Process 0: [1, 5]
  - Process 1: [1, 2, 5]
```

### æ—©åœæ­¢å¯¼è‡´æŒ‚èµ·

åœ¨åˆ†å¸ƒå¼è®­ç»ƒä¸­è¿›è¡Œæ—©åœæ­¢æ—¶ï¼Œå¦‚æœæ¯ä¸ªè¿›ç¨‹éƒ½æœ‰ç‰¹å®šçš„åœæ­¢æ¡ä»¶ï¼ˆä¾‹å¦‚éªŒè¯æŸå¤±ï¼‰ï¼Œå¯èƒ½ä¸ä¼šåœ¨æ‰€æœ‰è¿›ç¨‹ä¹‹é—´åŒæ­¥ã€‚ç»“æœï¼Œè¿›ç¨‹0ä¸Šå¯èƒ½å‘ç”Ÿä¸­æ–­ï¼Œä½†è¿›ç¨‹1ä¸Šå¯èƒ½æ²¡æœ‰ã€‚è¿™å°†å¯¼è‡´ä»£ç æ— é™æœŸæŒ‚èµ·ï¼Œç›´åˆ°è¶…æ—¶å‘ç”Ÿã€‚

å¦‚æœæ‚¨æœ‰æ—©åœæ­¢æ¡ä»¶ï¼Œè¯·ä½¿ç”¨`set_breakpoint`å’Œ`check_breakpoint`æ–¹æ³•ç¡®ä¿æ‰€æœ‰è¿›ç¨‹æ­£ç¡®ç»“æŸï¼š

```py
# Assume `should_do_breakpoint` is a custom defined function that returns a conditional, 
# and that conditional might be true only on process 1
if should_do_breakpoint(loss):
    accelerator.set_breakpoint()

# Later in the training script when we need to check for the breakpoint
if accelerator.check_breakpoint():
    break
```

### åœ¨Linuxä½å†…æ ¸ç‰ˆæœ¬ä¸ŠæŒ‚èµ·

è¿™æ˜¯ä¸€ä¸ªå·²çŸ¥é—®é¢˜ã€‚åœ¨Linuxä¸Šï¼Œå†…æ ¸ç‰ˆæœ¬<5.5ï¼Œå·²ç»æŠ¥å‘Šäº†æŒ‚èµ·è¿›ç¨‹ã€‚ä¸ºäº†é¿å…é‡åˆ°è¿™ä¸ªé—®é¢˜ï¼Œæˆ‘ä»¬å»ºè®®å°†ç³»ç»Ÿå‡çº§åˆ°æ›´é«˜ç‰ˆæœ¬çš„å†…æ ¸ã€‚

## CUDAå†…å­˜ä¸è¶³

åœ¨è¿è¡Œè®­ç»ƒè„šæœ¬æ—¶ï¼Œæœ€ä»¤äººæ²®ä¸§çš„é”™è¯¯ä¹‹ä¸€æ˜¯é‡åˆ°â€œCUDAå†…å­˜ä¸è¶³â€ï¼Œå› ä¸ºæ•´ä¸ªè„šæœ¬éœ€è¦é‡æ–°å¯åŠ¨ï¼Œè¿›åº¦ä¸¢å¤±ï¼Œé€šå¸¸å¼€å‘äººå‘˜å¸Œæœ›ç®€å•åœ°å¯åŠ¨ä»–ä»¬çš„è„šæœ¬å¹¶è®©å…¶è¿è¡Œã€‚

ä¸ºè§£å†³æ­¤é—®é¢˜ï¼Œ`Accelerate`æä¾›äº†ä¸€ä¸ªå®ç”¨ç¨‹åº`find_executable_batch_size`ï¼Œå®ƒåœ¨å¾ˆå¤§ç¨‹åº¦ä¸ŠåŸºäº[toma](https://github.com/BlackHC/toma)ã€‚è¯¥å®ç”¨ç¨‹åºä¼šé‡è¯•ç”±äºOOMï¼ˆå†…å­˜ä¸è¶³ï¼‰æ¡ä»¶è€Œå¤±è´¥çš„ä»£ç ï¼Œå¹¶è‡ªåŠ¨é™ä½æ‰¹é‡å¤§å°ã€‚

### find_executable_batch_size

è¯¥ç®—æ³•ä½¿ç”¨æŒ‡æ•°è¡°å‡ï¼Œåœ¨æŸäº›è®­ç»ƒè„šæœ¬çš„æ¯æ¬¡å¤±è´¥è¿è¡Œåå°†æ‰¹é‡å¤§å°å‡åŠã€‚è¦ä½¿ç”¨å®ƒï¼Œé‡æ„æ‚¨çš„è®­ç»ƒå‡½æ•°ä»¥åŒ…å«ä¸€ä¸ªåŒ…å«æ­¤åŒ…è£…å™¨çš„å†…éƒ¨å‡½æ•°ï¼Œå¹¶åœ¨å…¶ä¸­æ„å»ºæ‚¨çš„æ•°æ®åŠ è½½å™¨ã€‚è‡³å°‘ï¼Œè¿™å¯èƒ½çœ‹èµ·æ¥åƒ4è¡Œæ–°ä»£ç ã€‚

å†…éƒ¨å‡½æ•°*å¿…é¡»*å°†æ‰¹é‡å¤§å°ä½œä¸ºç¬¬ä¸€ä¸ªå‚æ•°ä¼ å…¥ï¼Œä½†åœ¨è°ƒç”¨æ—¶æˆ‘ä»¬ä¸ä¼šä¼ é€’ä¸€ä¸ªã€‚åŒ…è£…å™¨ä¼šä¸ºæˆ‘ä»¬å¤„ç†è¿™ä¸ªã€‚

è¿˜åº”æ³¨æ„ï¼Œä»»ä½•å°†æ¶ˆè€—CUDAå†…å­˜å¹¶ä¼ é€’ç»™`accelerator`çš„å†…å®¹**å¿…é¡»**åœ¨å†…éƒ¨å‡½æ•°ä¸­å£°æ˜ï¼Œä¾‹å¦‚æ¨¡å‹å’Œä¼˜åŒ–å™¨ã€‚

```py
def training_function(args):
    accelerator = Accelerator()

+   @find_executable_batch_size(starting_batch_size=args.batch_size)
+   def inner_training_loop(batch_size):
+       nonlocal accelerator # Ensure they can be used in our context
+       accelerator.free_memory() # Free all lingering references
        model = get_model()
        model.to(accelerator.device)
        optimizer = get_optimizer()
        train_dataloader, eval_dataloader = get_dataloaders(accelerator, batch_size)
        lr_scheduler = get_scheduler(
            optimizer, 
            num_training_steps=len(train_dataloader)*num_epochs
        )
        model, optimizer, train_dataloader, eval_dataloader, lr_scheduler = accelerator.prepare(
            model, optimizer, train_dataloader, eval_dataloader, lr_scheduler
        )
        train(model, optimizer, train_dataloader, lr_scheduler)
        validate(model, eval_dataloader)
+   inner_training_loop()
```

è¦äº†è§£æ›´å¤šï¼Œè¯·æŸ¥çœ‹æ­¤å¤„çš„æ–‡æ¡£[here](../package_reference/utilities#accelerate.find_executable_batch_size)ã€‚

## è®¾å¤‡è®¾ç½®ä¹‹é—´çš„ä¸å¯é‡ç°ç»“æœ

å¦‚æœæ‚¨å·²æ›´æ”¹è®¾å¤‡è®¾ç½®å¹¶è§‚å¯Ÿåˆ°ä¸åŒçš„æ¨¡å‹æ€§èƒ½ï¼Œè¿™å¾ˆå¯èƒ½æ˜¯å› ä¸ºåœ¨ä»ä¸€ä¸ªè®¾ç½®è½¬ç§»åˆ°å¦ä¸€ä¸ªè®¾ç½®æ—¶ï¼Œæ‚¨æ²¡æœ‰æ›´æ–°è„šæœ¬ã€‚åœ¨TPUã€å¤šGPUå’Œå•GPUä¸Accelerateä¸‹ï¼Œç›¸åŒæ‰¹é‡å¤§å°çš„ç›¸åŒè„šæœ¬å°†äº§ç”Ÿä¸åŒçš„ç»“æœã€‚

ä¾‹å¦‚ï¼Œå¦‚æœæ‚¨ä»¥å‰åœ¨å•GPUä¸Šè®­ç»ƒï¼Œæ‰¹é‡å¤§å°ä¸º16ï¼Œå½“è½¬ç§»åˆ°ä¸¤ä¸ªGPUè®¾ç½®æ—¶ï¼Œæ‚¨éœ€è¦å°†æ‰¹é‡å¤§å°æ›´æ”¹ä¸º8ï¼Œä»¥è·å¾—ç›¸åŒçš„æœ‰æ•ˆæ‰¹é‡å¤§å°ã€‚è¿™æ˜¯å› ä¸ºåœ¨ä½¿ç”¨Accelerateè¿›è¡Œè®­ç»ƒæ—¶ï¼Œä¼ é€’ç»™æ•°æ®åŠ è½½å™¨çš„æ‰¹é‡å¤§å°æ˜¯**æ¯ä¸ªGPUçš„æ‰¹é‡å¤§å°**ã€‚

ä¸ºç¡®ä¿æ‚¨å¯ä»¥åœ¨ä¸åŒè®¾ç½®ä¹‹é—´é‡ç°ç»“æœï¼Œè¯·ç¡®ä¿ä½¿ç”¨ç›¸åŒçš„ç§å­ï¼Œæ ¹æ®æƒ…å†µè°ƒæ•´æ‰¹é‡å¤§å°ï¼Œè€ƒè™‘è°ƒæ•´å­¦ä¹ ç‡ã€‚

æœ‰å…³æ‰¹é‡å¤§å°çš„æ›´å¤šè¯¦ç»†ä¿¡æ¯å’Œå¿«é€Ÿå‚è€ƒï¼Œè¯·æŸ¥çœ‹[æ¯”è¾ƒä¸åŒè®¾å¤‡è®¾ç½®ä¹‹é—´æ€§èƒ½](../concept_guides/performance)æŒ‡å—ã€‚

## ä¸åŒGPUä¸Šçš„æ€§èƒ½é—®é¢˜

å¦‚æœæ‚¨çš„å¤šGPUè®¾ç½®åŒ…å«ä¸åŒçš„GPUï¼Œå¯èƒ½ä¼šé‡åˆ°ä¸€äº›é™åˆ¶ï¼š

+   GPUä¹‹é—´çš„æ˜¾å­˜å¯èƒ½å­˜åœ¨ä¸å¹³è¡¡ã€‚åœ¨è¿™ç§æƒ…å†µä¸‹ï¼Œæ˜¾å­˜è¾ƒå°çš„GPUå°†é™åˆ¶æ‰¹é‡å¤§å°æˆ–å¯ä»¥åŠ è½½åˆ°GPUä¸Šçš„æ¨¡å‹å¤§å°ã€‚

+   å¦‚æœæ‚¨ä½¿ç”¨å…·æœ‰ä¸åŒæ€§èƒ½é…ç½®æ–‡ä»¶çš„GPUï¼Œæ€§èƒ½å°†ç”±æ‚¨ä½¿ç”¨çš„æœ€æ…¢çš„GPUé©±åŠ¨ï¼Œå› ä¸ºå…¶ä»–GPUå°†ä¸å¾—ä¸ç­‰å¾…å…¶å®Œæˆå·¥ä½œè´Ÿè½½ã€‚

åŒä¸€è®¾ç½®ä¸­æä¸åŒçš„GPUå¯èƒ½å¯¼è‡´æ€§èƒ½ç“¶é¢ˆã€‚

## å¯»æ±‚å¸®åŠ©

å¦‚æœä¸Šè¿°æ•…éšœæ’é™¤å·¥å…·å’Œå»ºè®®æ— æ³•å¸®åŠ©æ‚¨è§£å†³é—®é¢˜ï¼Œè¯·å‘ç¤¾åŒºå’Œå›¢é˜Ÿå¯»æ±‚å¸®åŠ©ã€‚

### è®ºå›

åœ¨Hugging Faceè®ºå›ä¸Šå¯»æ±‚å¸®åŠ©-åœ¨[ğŸ¤—Accelerateç±»åˆ«](https://discuss.huggingface.co/c/accelerate/18)ä¸­å‘å¸ƒæ‚¨çš„é—®é¢˜ã€‚ç¡®ä¿å†™ä¸€ä¸ªæè¿°æ€§çš„å¸–å­ï¼Œæä¾›æœ‰å…³æ‚¨çš„è®¾ç½®å’Œå¯é‡ç°ä»£ç çš„ç›¸å…³ä¸Šä¸‹æ–‡ï¼Œä»¥æœ€å¤§ç¨‹åº¦åœ°æé«˜è§£å†³é—®é¢˜çš„å¯èƒ½æ€§ï¼

### Discord

åœ¨[Discord](http://hf.co/join/discord)ä¸Šæé—®ï¼Œè®©å›¢é˜Ÿå’Œç¤¾åŒºå¸®åŠ©æ‚¨ã€‚

### GitHubé—®é¢˜

å¦‚æœæ‚¨æ€€ç–‘å‘ç°ä¸åº“ç›¸å…³çš„é”™è¯¯ï¼Œè¯·åœ¨ğŸ¤— Accelerate [GitHubå­˜å‚¨åº“](https://github.com/huggingface/accelerate/issues)ä¸Šåˆ›å»ºä¸€ä¸ªé—®é¢˜ã€‚åŒ…æ‹¬æœ‰å…³é”™è¯¯çš„ä¸Šä¸‹æ–‡å’Œæœ‰å…³æ‚¨çš„åˆ†å¸ƒå¼è®¾ç½®çš„è¯¦ç»†ä¿¡æ¯ï¼Œä»¥å¸®åŠ©æˆ‘ä»¬æ›´å¥½åœ°æ‰¾å‡ºé—®é¢˜æ‰€åœ¨ä»¥åŠå¦‚ä½•è§£å†³å®ƒã€‚
