# UNet2DConditionModel

> åŸæ–‡é“¾æ¥ï¼š[`huggingface.co/docs/diffusers/api/models/unet2d-cond`](https://huggingface.co/docs/diffusers/api/models/unet2d-cond)

[UNet](https://huggingface.co/papers/1505.04597)æ¨¡å‹æœ€åˆç”± Ronneberger ç­‰äººæå‡ºï¼Œç”¨äºç”Ÿç‰©åŒ»å­¦å›¾åƒåˆ†å‰²ï¼Œä½†å®ƒä¹Ÿå¸¸ç”¨äºğŸ¤—æ‰©æ•£å™¨ï¼Œå› ä¸ºå®ƒè¾“å‡ºä¸è¾“å…¥ç›¸åŒå¤§å°çš„å›¾åƒã€‚å®ƒæ˜¯æ‰©æ•£ç³»ç»Ÿä¸­æœ€é‡è¦çš„ç»„ä»¶ä¹‹ä¸€ï¼Œå› ä¸ºå®ƒä¿ƒè¿›äº†å®é™…çš„æ‰©æ•£è¿‡ç¨‹ã€‚åœ¨ğŸ¤—æ‰©æ•£å™¨ä¸­æœ‰å‡ ä¸ª UNet æ¨¡å‹çš„å˜ä½“ï¼Œå–å†³äºå®ƒçš„ç»´åº¦æ•°é‡ä»¥åŠå®ƒæ˜¯å¦æ˜¯æ¡ä»¶æ¨¡å‹ã€‚è¿™æ˜¯ä¸€ä¸ª 2D UNet æ¡ä»¶æ¨¡å‹ã€‚

è®ºæ–‡æ‘˜è¦å¦‚ä¸‹ï¼š

æˆåŠŸè®­ç»ƒæ·±åº¦ç½‘ç»œéœ€è¦æˆåƒä¸Šä¸‡ä¸ªå¸¦æ³¨é‡Šçš„è®­ç»ƒæ ·æœ¬çš„å¤§é‡ä¸€è‡´æ€§ã€‚åœ¨æœ¬æ–‡ä¸­ï¼Œæˆ‘ä»¬æå‡ºäº†ä¸€ç§ä¾èµ–äºæ•°æ®å¢å¼ºçš„ç½‘ç»œå’Œè®­ç»ƒç­–ç•¥ï¼Œä»¥æ›´æœ‰æ•ˆåœ°åˆ©ç”¨å¯ç”¨çš„å¸¦æ³¨é‡Šæ ·æœ¬ã€‚è¯¥æ¶æ„åŒ…æ‹¬ä¸€ä¸ªæ”¶ç¼©è·¯å¾„æ¥æ•è·ä¸Šä¸‹æ–‡å’Œä¸€ä¸ªå¯¹ç§°æ‰©å±•è·¯å¾„ï¼Œå®ç°ç²¾ç¡®çš„å®šä½ã€‚æˆ‘ä»¬å±•ç¤ºäº†è¿™æ ·ä¸€ä¸ªç½‘ç»œå¯ä»¥ä»éå¸¸å°‘çš„å›¾åƒç«¯åˆ°ç«¯è®­ç»ƒï¼Œå¹¶ä¸”åœ¨ ISBI æŒ‘æˆ˜ä¸­è¡¨ç°ä¼˜äºå…ˆå‰æœ€ä½³æ–¹æ³•ï¼ˆæ»‘åŠ¨çª—å£å·ç§¯ç½‘ç»œï¼‰ç”¨äºç”µå­æ˜¾å¾®é•œå †å ä¸­ç¥ç»ç»“æ„çš„åˆ†å‰²ã€‚ä½¿ç”¨ç›¸åŒçš„ç½‘ç»œåœ¨é€å°„å…‰æ˜¾å¾®é•œå›¾åƒï¼ˆç›¸å·®å’Œ DICï¼‰ä¸Šè®­ç»ƒï¼Œæˆ‘ä»¬åœ¨ 2015 å¹´ ISBI ç»†èƒè·Ÿè¸ªæŒ‘æˆ˜ä¸­åœ¨è¿™äº›ç±»åˆ«ä¸­å¤§å¹…é¢†å…ˆã€‚æ­¤å¤–ï¼Œè¯¥ç½‘ç»œé€Ÿåº¦å¾ˆå¿«ã€‚åœ¨æœ€æ–°çš„ GPU ä¸Šï¼Œå¯¹ 512x512 å›¾åƒçš„åˆ†å‰²ä¸åˆ°ä¸€ç§’ã€‚å®Œæ•´çš„å®ç°ï¼ˆåŸºäº Caffeï¼‰å’Œè®­ç»ƒçš„ç½‘ç»œå¯åœ¨[`lmb.informatik.uni-freiburg.de/people/ronneber/u-net`](http://lmb.informatik.uni-freiburg.de/people/ronneber/u-net)ä¸Šæ‰¾åˆ°ã€‚

## UNet2DConditionModel

### `class diffusers.UNet2DConditionModel`

[<æ¥æº>](https://github.com/huggingface/diffusers/blob/v0.26.3/src/diffusers/models/unets/unet_2d_condition.py#L71)

```py
( sample_size: Optional = None in_channels: int = 4 out_channels: int = 4 center_input_sample: bool = False flip_sin_to_cos: bool = True freq_shift: int = 0 down_block_types: Tuple = ('CrossAttnDownBlock2D', 'CrossAttnDownBlock2D', 'CrossAttnDownBlock2D', 'DownBlock2D') mid_block_type: Optional = 'UNetMidBlock2DCrossAttn' up_block_types: Tuple = ('UpBlock2D', 'CrossAttnUpBlock2D', 'CrossAttnUpBlock2D', 'CrossAttnUpBlock2D') only_cross_attention: Union = False block_out_channels: Tuple = (320, 640, 1280, 1280) layers_per_block: Union = 2 downsample_padding: int = 1 mid_block_scale_factor: float = 1 dropout: float = 0.0 act_fn: str = 'silu' norm_num_groups: Optional = 32 norm_eps: float = 1e-05 cross_attention_dim: Union = 1280 transformer_layers_per_block: Union = 1 reverse_transformer_layers_per_block: Optional = None encoder_hid_dim: Optional = None encoder_hid_dim_type: Optional = None attention_head_dim: Union = 8 num_attention_heads: Union = None dual_cross_attention: bool = False use_linear_projection: bool = False class_embed_type: Optional = None addition_embed_type: Optional = None addition_time_embed_dim: Optional = None num_class_embeds: Optional = None upcast_attention: bool = False resnet_time_scale_shift: str = 'default' resnet_skip_time_act: bool = False resnet_out_scale_factor: int = 1.0 time_embedding_type: str = 'positional' time_embedding_dim: Optional = None time_embedding_act_fn: Optional = None timestep_post_act: Optional = None time_cond_proj_dim: Optional = None conv_in_kernel: int = 3 conv_out_kernel: int = 3 projection_class_embeddings_input_dim: Optional = None attention_type: str = 'default' class_embeddings_concat: bool = False mid_block_only_cross_attention: Optional = None cross_attention_norm: Optional = None addition_embed_type_num_heads = 64 )
```

å‚æ•°

+   `sample_size`ï¼ˆ`int`æˆ–`Tuple[int, int]`ï¼Œ*å¯é€‰*ï¼Œé»˜è®¤ä¸º`None`ï¼‰â€” è¾“å…¥/è¾“å‡ºæ ·æœ¬çš„é«˜åº¦å’Œå®½åº¦ã€‚

+   `in_channels`ï¼ˆ`int`ï¼Œ*å¯é€‰*ï¼Œé»˜è®¤ä¸º 4ï¼‰â€” è¾“å…¥æ ·æœ¬ä¸­çš„é€šé“æ•°ã€‚

+   `out_channels`ï¼ˆ`int`ï¼Œ*å¯é€‰*ï¼Œé»˜è®¤ä¸º 4ï¼‰â€” è¾“å‡ºä¸­çš„é€šé“æ•°ã€‚

+   `center_input_sample`ï¼ˆ`bool`ï¼Œ*å¯é€‰*ï¼Œé»˜è®¤ä¸º`False`ï¼‰â€” æ˜¯å¦å°†è¾“å…¥æ ·æœ¬å±…ä¸­ã€‚

+   `flip_sin_to_cos`ï¼ˆ`bool`ï¼Œ*å¯é€‰*ï¼Œé»˜è®¤ä¸º`False`ï¼‰â€” æ˜¯å¦åœ¨æ—¶é—´åµŒå…¥ä¸­å°† sin ç¿»è½¬ä¸º cosã€‚

+   `freq_shift`ï¼ˆ`int`ï¼Œ*å¯é€‰*ï¼Œé»˜è®¤ä¸º 0ï¼‰â€” åº”ç”¨äºæ—¶é—´åµŒå…¥çš„é¢‘ç§»ã€‚

+   `down_block_types`ï¼ˆ`Tuple[str]`ï¼Œ*å¯é€‰*ï¼Œé»˜è®¤ä¸º`("CrossAttnDownBlock2D", "CrossAttnDownBlock2D", "CrossAttnDownBlock2D", "DownBlock2D")`ï¼‰â€” è¦ä½¿ç”¨çš„ä¸‹é‡‡æ ·å—çš„å…ƒç»„ã€‚

+   `mid_block_type`ï¼ˆ`str`ï¼Œ*å¯é€‰*ï¼Œé»˜è®¤ä¸º`"UNetMidBlock2DCrossAttn"`ï¼‰â€” UNet ä¸­é—´çš„å—ç±»å‹ï¼Œå¯ä»¥æ˜¯`UNetMidBlock2DCrossAttn`ã€`UNetMidBlock2D`æˆ–`UNetMidBlock2DSimpleCrossAttn`ä¹‹ä¸€ã€‚å¦‚æœä¸º`None`ï¼Œåˆ™è·³è¿‡ä¸­é—´å—å±‚ã€‚

+   `up_block_types`ï¼ˆ`Tuple[str]`ï¼Œ*å¯é€‰*ï¼Œé»˜è®¤ä¸º`("UpBlock2D", "CrossAttnUpBlock2D", "CrossAttnUpBlock2D", "CrossAttnUpBlock2D")`ï¼‰â€” è¦ä½¿ç”¨çš„ä¸Šé‡‡æ ·å—çš„å…ƒç»„ã€‚

+   `only_cross_attention(bool`æˆ–`Tuple[bool]`ï¼Œ*å¯é€‰*ï¼Œé»˜è®¤ä¸º`False`ï¼‰â€” æ˜¯å¦åœ¨åŸºæœ¬å˜æ¢å™¨å—ä¸­åŒ…å«è‡ªæ³¨æ„åŠ›ï¼Œå‚è§`BasicTransformerBlock`ã€‚

+   `block_out_channels`ï¼ˆ`Tuple[int]`ï¼Œ*å¯é€‰*ï¼Œé»˜è®¤ä¸º`(320, 640, 1280, 1280)`ï¼‰â€” æ¯ä¸ªå—çš„è¾“å‡ºé€šé“çš„å…ƒç»„ã€‚

+   `layers_per_block`ï¼ˆ`int`ï¼Œ*å¯é€‰*ï¼Œé»˜è®¤ä¸º 2ï¼‰â€” æ¯ä¸ªå—çš„å±‚æ•°ã€‚

+   `downsample_padding`ï¼ˆ`int`ï¼Œ*å¯é€‰*ï¼Œé»˜è®¤ä¸º 1ï¼‰â€” ç”¨äºä¸‹é‡‡æ ·å·ç§¯çš„å¡«å……ã€‚

+   `mid_block_scale_factor`ï¼ˆ`float`ï¼Œ*å¯é€‰*ï¼Œé»˜è®¤ä¸º 1.0ï¼‰â€” ç”¨äºä¸­é—´å—çš„æ¯”ä¾‹å› å­ã€‚

+   `dropout` (`float`, *å¯é€‰*, é»˜è®¤ä¸º 0.0) â€” è¦ä½¿ç”¨çš„ dropout æ¦‚ç‡ã€‚

+   `act_fn` (`str`, *å¯é€‰*, é»˜è®¤ä¸º`"silu"`) â€” è¦ä½¿ç”¨çš„æ¿€æ´»å‡½æ•°ã€‚

+   `norm_num_groups` (`int`, *å¯é€‰*, é»˜è®¤ä¸º 32) â€” ç”¨äºè§„èŒƒåŒ–çš„ç»„æ•°ã€‚å¦‚æœä¸º`None`ï¼Œåˆ™åœ¨åå¤„ç†ä¸­è·³è¿‡è§„èŒƒåŒ–å’Œæ¿€æ´»å±‚ã€‚

+   `norm_eps` (`float`, *å¯é€‰*, é»˜è®¤ä¸º 1e-5) â€” ç”¨äºè§„èŒƒåŒ–çš„ epsilon å€¼ã€‚

+   `cross_attention_dim` (`int` æˆ– `Tuple[int]`, *å¯é€‰*, é»˜è®¤ä¸º 1280) â€” äº¤å‰æ³¨æ„åŠ›ç‰¹å¾çš„ç»´åº¦ã€‚

+   `transformer_layers_per_block` (`int`, `Tuple[int]`, æˆ– `Tuple[Tuple]`, *å¯é€‰*, é»˜è®¤ä¸º 1) â€” `BasicTransformerBlock` ç±»å‹çš„ transformer å—çš„æ•°é‡ã€‚ä»…é€‚ç”¨äº `~models.unet_2d_blocks.CrossAttnDownBlock2D`, `~models.unet_2d_blocks.CrossAttnUpBlock2D`, `~models.unet_2d_blocks.UNetMidBlock2DCrossAttn`ã€‚

ä¸€ä¸ªæœ‰æ¡ä»¶çš„ 2D UNet æ¨¡å‹ï¼Œæ¥å—ä¸€ä¸ªå¸¦å™ªå£°çš„æ ·æœ¬ã€æ¡ä»¶çŠ¶æ€å’Œä¸€ä¸ªæ—¶é—´æ­¥ï¼Œå¹¶è¿”å›ä¸€ä¸ªå½¢çŠ¶è¾“å‡ºçš„æ ·æœ¬ã€‚

è¯¥æ¨¡å‹ç»§æ‰¿è‡ª ModelMixinã€‚æŸ¥çœ‹è¶…ç±»æ–‡æ¡£ä»¥äº†è§£ä¸ºæ‰€æœ‰æ¨¡å‹å®ç°çš„é€šç”¨æ–¹æ³•ï¼ˆå¦‚ä¸‹è½½æˆ–ä¿å­˜ï¼‰ã€‚

reverse_transformer_layers_per_blockï¼šï¼ˆ`Tuple[Tuple]`ï¼Œ*å¯é€‰*ï¼Œé»˜è®¤ä¸º Noneï¼‰ï¼šåœ¨ U-Net çš„ä¸Šé‡‡æ ·å—ä¸­ï¼Œ`BasicTransformerBlock`ç±»å‹çš„ transformer å—çš„æ•°é‡ã€‚ä»…åœ¨`transformer_layers_per_block`ä¸º`Tuple[Tuple]`ç±»å‹ä¸”å¯¹äº`~models.unet_2d_blocks.CrossAttnDownBlock2D`ï¼Œ`~models.unet_2d_blocks.CrossAttnUpBlock2D`ï¼Œ`~models.unet_2d_blocks.UNetMidBlock2DCrossAttn`æ—¶ç›¸å…³ã€‚encoder_hid_dimï¼ˆ`int`ï¼Œ*å¯é€‰*ï¼Œé»˜è®¤ä¸º Noneï¼‰ï¼šå¦‚æœå®šä¹‰äº†`encoder_hid_dim_type`ï¼Œåˆ™å°†ä»`encoder_hid_dim`ç»´åº¦æŠ•å½±åˆ°`cross_attention_dim`çš„`encoder_hidden_states`ã€‚encoder_hid_dim_typeï¼ˆ`str`ï¼Œ*å¯é€‰*ï¼Œé»˜è®¤ä¸º`None`ï¼‰ï¼šå¦‚æœç»™å®šï¼Œå°†æ ¹æ®`encoder_hid_dim_type`å°†`encoder_hidden_states`å’Œå¯èƒ½çš„å…¶ä»–åµŒå…¥å‘ä¸‹æŠ•å½±åˆ°ç»´åº¦ä¸º`cross_attention`çš„æ–‡æœ¬åµŒå…¥ã€‚attention_head_dimï¼ˆ`int`ï¼Œ*å¯é€‰*ï¼Œé»˜è®¤ä¸º 8ï¼‰ï¼šæ³¨æ„åŠ›å¤´çš„ç»´åº¦ã€‚num_attention_headsï¼ˆ`int`ï¼Œ*å¯é€‰*ï¼‰ï¼šæ³¨æ„åŠ›å¤´çš„æ•°é‡ã€‚å¦‚æœæœªå®šä¹‰ï¼Œåˆ™é»˜è®¤ä¸º`attention_head_dim`ã€‚resnet_time_scale_shiftï¼ˆ`str`ï¼Œ*å¯é€‰*ï¼Œé»˜è®¤ä¸º`"default"`ï¼‰ï¼šResNet å—çš„æ—¶é—´å°ºåº¦åç§»é…ç½®ï¼ˆå‚è§`ResnetBlock2D`ï¼‰ã€‚é€‰æ‹©`default`æˆ–`scale_shift`ã€‚class_embed_typeï¼ˆ`str`ï¼Œ*å¯é€‰*ï¼Œé»˜è®¤ä¸º`None`ï¼‰ï¼šè¦ä½¿ç”¨çš„ç±»åµŒå…¥ç±»å‹ï¼Œæœ€ç»ˆå°†ä¸æ—¶é—´åµŒå…¥ç›¸åŠ ã€‚é€‰æ‹©`None`ã€`"timestep"`ã€`"identity"`ã€`"projection"`æˆ–`"simple_projection"`ã€‚addition_embed_typeï¼ˆ`str`ï¼Œ*å¯é€‰*ï¼Œé»˜è®¤ä¸º`None`ï¼‰ï¼šé…ç½®ä¸€ä¸ªå¯é€‰çš„åµŒå…¥ï¼Œå°†ä¸æ—¶é—´åµŒå…¥ç›¸åŠ ã€‚é€‰æ‹©`None`æˆ–â€œtextâ€ã€‚â€œtextâ€å°†ä½¿ç”¨`TextTimeEmbedding`å±‚ã€‚addition_time_embed_dimï¼šï¼ˆ`int`ï¼Œ*å¯é€‰*ï¼Œé»˜è®¤ä¸º`None`ï¼‰ï¼šæ—¶é—´æ­¥åµŒå…¥çš„ç»´åº¦ã€‚num_class_embedsï¼ˆ`int`ï¼Œ*å¯é€‰*ï¼Œé»˜è®¤ä¸º`None`ï¼‰ï¼šè¦æŠ•å½±åˆ°`time_embed_dim`çš„å¯å­¦ä¹ åµŒå…¥çŸ©é˜µçš„è¾“å…¥ç»´åº¦ï¼Œå½“ä½¿ç”¨`class_embed_type`ç­‰äº`None`è¿›è¡Œç±»åˆ«è°ƒèŠ‚æ—¶ã€‚time_embedding_typeï¼ˆ`str`ï¼Œ*å¯é€‰*ï¼Œé»˜è®¤ä¸º`positional`ï¼‰ï¼šç”¨äºæ—¶é—´æ­¥çš„ä½ç½®åµŒå…¥ç±»å‹ã€‚é€‰æ‹©`positional`æˆ–`fourier`ã€‚time_embedding_dimï¼ˆ`int`ï¼Œ*å¯é€‰*ï¼Œé»˜è®¤ä¸º`None`ï¼‰ï¼šæŠ•å½±æ—¶é—´åµŒå…¥çš„ç»´åº¦çš„å¯é€‰è¦†ç›–ã€‚time_embedding_act_fnï¼ˆ`str`ï¼Œ*å¯é€‰*ï¼Œé»˜è®¤ä¸º`None`ï¼‰ï¼šä»…åœ¨æ—¶é—´åµŒå…¥ä¼ é€’åˆ° UNet çš„å…¶ä½™éƒ¨åˆ†ä¹‹å‰ä½¿ç”¨çš„å¯é€‰æ¿€æ´»å‡½æ•°ã€‚é€‰æ‹©`silu`ã€`mish`ã€`gelu`å’Œ`swish`ã€‚timestep_post_actï¼ˆ`str`ï¼Œ*å¯é€‰*ï¼Œé»˜è®¤ä¸º`None`ï¼‰ï¼šåœ¨æ—¶é—´æ­¥åµŒå…¥ä¸­ä½¿ç”¨çš„ç¬¬äºŒä¸ªæ¿€æ´»å‡½æ•°ã€‚é€‰æ‹©`silu`ã€`mish`å’Œ`gelu`ã€‚time_cond_proj_dimï¼ˆ`int`ï¼Œ*å¯é€‰*ï¼Œé»˜è®¤ä¸º`None`ï¼‰ï¼šæ—¶é—´æ­¥åµŒå…¥ä¸­`cond_proj`å±‚çš„ç»´åº¦ã€‚conv_in_kernelï¼ˆ`int`ï¼Œ*å¯é€‰*ï¼Œé»˜è®¤ä¸º`3`ï¼‰ï¼š`conv_in`å±‚çš„å†…æ ¸å¤§å°ã€‚conv_out_kernelï¼ˆ`int`ï¼Œ*å¯é€‰*ï¼Œé»˜è®¤ä¸º`3`ï¼‰ï¼š`conv_out`å±‚çš„å†…æ ¸å¤§å°ã€‚projection_class_embeddings_input_dimï¼ˆ`int`ï¼Œ*å¯é€‰*ï¼‰ï¼šå½“`class_embed_type="projection"`æ—¶ï¼Œ`class_labels`è¾“å…¥çš„ç»´åº¦ã€‚åœ¨`class_embed_type="projection"`æ—¶éœ€è¦ã€‚class_embeddings_concatï¼ˆ`bool`ï¼Œ*å¯é€‰*ï¼Œé»˜è®¤ä¸º`False`ï¼‰ï¼šæ˜¯å¦å°†æ—¶é—´åµŒå…¥ä¸ç±»åµŒå…¥è¿æ¥èµ·æ¥ã€‚mid_block_only_cross_attentionï¼ˆ`bool`ï¼Œ*å¯é€‰*ï¼Œé»˜è®¤ä¸º`None`ï¼‰ï¼šåœ¨ä½¿ç”¨`UNetMidBlock2DSimpleCrossAttn`æ—¶æ˜¯å¦åœ¨ä¸­é—´å—ä¸­ä½¿ç”¨äº¤å‰æ³¨æ„åŠ›ã€‚å¦‚æœ`only_cross_attention`ä½œä¸ºå•ä¸ªå¸ƒå°”å€¼ç»™å‡ºä¸”`mid_block_only_cross_attention`ä¸º`None`ï¼Œåˆ™`only_cross_attention`å€¼å°†ç”¨ä½œ`mid_block_only_cross_attention`çš„å€¼ã€‚å¦åˆ™é»˜è®¤ä¸º`False`ã€‚

#### `disable_freeu`

[<æ¥æº>](https://github.com/huggingface/diffusers/blob/v0.26.3/src/diffusers/models/unets/unet_2d_condition.py#L788)

```py
( )
```

ç¦ç”¨ FreeU æœºåˆ¶ã€‚

#### `enable_freeu`

[<æ¥æº>](https://github.com/huggingface/diffusers/blob/v0.26.3/src/diffusers/models/unets/unet_2d_condition.py#L764)

```py
( s1 s2 b1 b2 )
```

å‚æ•°

+   `s1` (`float`) â€” é˜¶æ®µ 1 çš„ç¼©æ”¾å› å­ï¼Œç”¨äºå‡å¼±è·³è·ƒç‰¹å¾çš„è´¡çŒ®ã€‚è¿™æ ·åšæ˜¯ä¸ºäº†å‡è½»å¢å¼ºå»å™ªè¿‡ç¨‹ä¸­çš„â€œè¿‡åº¦å¹³æ»‘æ•ˆåº”â€ã€‚

+   `s2` (`float`) â€” é˜¶æ®µ 2 çš„ç¼©æ”¾å› å­ï¼Œç”¨äºå‡å¼±è·³è·ƒç‰¹å¾çš„è´¡çŒ®ã€‚è¿™æ ·åšæ˜¯ä¸ºäº†å‡è½»å¢å¼ºå»å™ªè¿‡ç¨‹ä¸­çš„â€œè¿‡åº¦å¹³æ»‘æ•ˆåº”â€ã€‚

+   `b1` (`float`) â€” é˜¶æ®µ 1 çš„ç¼©æ”¾å› å­ï¼Œç”¨äºæ”¾å¤§ä¸»å¹²ç‰¹å¾çš„è´¡çŒ®ã€‚

+   `b2` (`float`) â€” é˜¶æ®µ 2 çš„ç¼©æ”¾å› å­ï¼Œç”¨äºæ”¾å¤§ä¸»å¹²ç‰¹å¾çš„è´¡çŒ®ã€‚

å¯ç”¨æ¥è‡ª[`arxiv.org/abs/2309.11497`](https://arxiv.org/abs/2309.11497)çš„ FreeU æœºåˆ¶ã€‚

ç¼©æ”¾å› å­åç¼€è¡¨ç¤ºå®ƒä»¬è¢«åº”ç”¨çš„é˜¶æ®µå—ã€‚

è¯·å‚è€ƒ[å®˜æ–¹å­˜å‚¨åº“](https://github.com/ChenyangSi/FreeU)ä»¥è·å–å·²çŸ¥é€‚ç”¨äºä¸åŒæµæ°´çº¿ï¼ˆå¦‚ Stable Diffusion v1ã€v2 å’Œ Stable Diffusion XLï¼‰çš„å€¼ç»„åˆã€‚

#### `forward`

[<æ¥æº>](https://github.com/huggingface/diffusers/blob/v0.26.3/src/diffusers/models/unets/unet_2d_condition.py#L843)

```py
( sample: FloatTensor timestep: Union encoder_hidden_states: Tensor class_labels: Optional = None timestep_cond: Optional = None attention_mask: Optional = None cross_attention_kwargs: Optional = None added_cond_kwargs: Optional = None down_block_additional_residuals: Optional = None mid_block_additional_residual: Optional = None down_intrablock_additional_residuals: Optional = None encoder_attention_mask: Optional = None return_dict: bool = True ) â†’ export const metadata = 'undefined';UNet2DConditionOutput or tuple
```

å‚æ•°

+   `sample` (`torch.FloatTensor`) â€” å…·æœ‰ä»¥ä¸‹å½¢çŠ¶çš„å˜ˆæ‚è¾“å…¥å¼ é‡`(batch, channel, height, width)`ã€‚

+   `timestep` (`torch.FloatTensor`æˆ–`float`æˆ–`int`) â€” å¯¹è¾“å…¥è¿›è¡Œå»å™ªçš„æ—¶é—´æ­¥æ•°ã€‚

+   `encoder_hidden_states` (`torch.FloatTensor`) â€” å…·æœ‰å½¢çŠ¶`(batch, sequence_length, feature_dim)`çš„ç¼–ç å™¨éšè—çŠ¶æ€ã€‚

+   `class_labels` (`torch.Tensor`, *å¯é€‰*, é»˜è®¤ä¸º `None`) â€” ç”¨äºæ¡ä»¶åŒ–çš„å¯é€‰ç±»æ ‡ç­¾ã€‚å®ƒä»¬çš„åµŒå…¥å°†ä¸æ—¶é—´æ­¥åµŒå…¥ç›¸åŠ ã€‚timestep_cond â€” (`torch.Tensor`, *å¯é€‰*, é»˜è®¤ä¸º `None`): æ—¶é—´æ­¥çš„æ¡ä»¶åµŒå…¥ã€‚å¦‚æœæä¾›ï¼Œè¿™äº›åµŒå…¥å°†ä¸é€šè¿‡`self.time_embedding`å±‚ä¼ é€’çš„æ ·æœ¬ç›¸åŠ ï¼Œä»¥è·å¾—æ—¶é—´æ­¥åµŒå…¥ã€‚

+   `attention_mask` (`torch.Tensor`, *å¯é€‰*, é»˜è®¤ä¸º `None`) â€” å½¢çŠ¶ä¸º`(batch, key_tokens)`çš„æ³¨æ„åŠ›æ©ç è¢«åº”ç”¨äº`encoder_hidden_states`ã€‚å¦‚æœä¸º`1`ï¼Œåˆ™ä¿ç•™æ©ç ï¼Œå¦åˆ™å¦‚æœä¸º`0`ï¼Œåˆ™ä¸¢å¼ƒæ©ç ã€‚æ©ç å°†è¢«è½¬æ¢ä¸ºåç½®ï¼Œè¯¥åç½®ä¼šå‘â€œä¸¢å¼ƒâ€æ ‡è®°å¯¹åº”çš„æ³¨æ„åŠ›åˆ†æ•°æ·»åŠ å¤§çš„è´Ÿå€¼ã€‚

+   `cross_attention_kwargs` (`dict`, *å¯é€‰*) â€” ä¸€ä¸ª kwargs å­—å…¸ï¼Œå¦‚æœæŒ‡å®šï¼Œåˆ™å°†ä¼ é€’ç»™`AttentionProcessor`ï¼Œå¦‚[diffusers.models.attention_processor](https://github.com/huggingface/diffusers/blob/main/src/diffusers/models/attention_processor.py)ä¸­çš„`self.processor`ä¸­å®šä¹‰çš„é‚£æ ·ã€‚added_cond_kwargs â€” (`dict`, *å¯é€‰*): ä¸€ä¸ª kwargs å­—å…¸ï¼ŒåŒ…å«é¢å¤–çš„åµŒå…¥ï¼Œå¦‚æœæŒ‡å®šï¼Œåˆ™å°†æ·»åŠ åˆ°ä¼ é€’ç»™ UNet å—çš„åµŒå…¥ä¸­ã€‚down_block_additional_residuals â€” (`torch.Tensor`çš„å…ƒç»„ï¼Œ*å¯é€‰*): ä¸€ä¸ªå¼ é‡çš„å…ƒç»„ï¼Œå¦‚æœæŒ‡å®šï¼Œåˆ™å°†æ·»åŠ åˆ° down unet å—çš„æ®‹å·®ä¸­ã€‚mid_block_additional_residual â€” (`torch.Tensor`, *å¯é€‰*): ä¸€ä¸ªå¼ é‡ï¼Œå¦‚æœæŒ‡å®šï¼Œåˆ™å°†æ·»åŠ åˆ°ä¸­é—´ unet å—çš„æ®‹å·®ä¸­ã€‚

+   `encoder_attention_mask` (`torch.Tensor`) â€” å½¢çŠ¶ä¸º`(batch, sequence_length)`çš„äº¤å‰æ³¨æ„åŠ›æ©ç è¢«åº”ç”¨äº`encoder_hidden_states`ã€‚å¦‚æœä¸º`True`ï¼Œåˆ™ä¿ç•™æ©ç ï¼Œå¦åˆ™å¦‚æœä¸º`False`ï¼Œåˆ™ä¸¢å¼ƒæ©ç ã€‚æ©ç å°†è¢«è½¬æ¢ä¸ºåç½®ï¼Œè¯¥åç½®ä¼šå‘â€œä¸¢å¼ƒâ€æ ‡è®°å¯¹åº”çš„æ³¨æ„åŠ›åˆ†æ•°æ·»åŠ å¤§çš„è´Ÿå€¼ã€‚

+   `return_dict` (`bool`, *å¯é€‰*, é»˜è®¤ä¸º `True`) â€” æ˜¯å¦è¿”å›ä¸€ä¸ª UNet2DConditionOutput è€Œä¸æ˜¯ä¸€ä¸ªæ™®é€šçš„å…ƒç»„ã€‚

+   `cross_attention_kwargs`ï¼ˆ`dict`ï¼Œ*å¯é€‰*ï¼‰â€”å¦‚æœæŒ‡å®šï¼Œå°†ä¼ é€’ç»™`AttnProcessor`çš„ kwargs å­—å…¸ã€‚added_cond_kwargs â€”ï¼ˆ`dict`ï¼Œ*å¯é€‰*ï¼‰ï¼šåŒ…å«é¢å¤–åµŒå…¥çš„ kwargs å­—å…¸ï¼Œå¦‚æœæŒ‡å®šï¼Œåˆ™å°†æ·»åŠ åˆ°ä¼ é€’ç»™ UNet å—çš„åµŒå…¥ä¸­ã€‚

+   `down_block_additional_residuals`ï¼ˆ`torch.Tensor`çš„`tuple`ï¼Œ*å¯é€‰*ï¼‰â€”è¦æ·»åŠ åˆ° UNet é•¿è·³è¿æ¥çš„é¢å¤–æ®‹å·®ï¼Œä¾‹å¦‚æ¥è‡ª ControlNet ä¾§æ¨¡å‹

+   `mid_block_additional_residual`ï¼ˆ`torch.Tensor`ï¼Œ*å¯é€‰*ï¼‰â€”è¦æ·»åŠ åˆ° UNet ä¸­é—´å—è¾“å‡ºçš„é¢å¤–æ®‹å·®ï¼Œä¾‹å¦‚æ¥è‡ª ControlNet ä¾§æ¨¡å‹

+   `down_intrablock_additional_residuals`ï¼ˆ`torch.Tensor`çš„`tuple`ï¼Œ*å¯é€‰*ï¼‰â€”è¦åœ¨ UNet ä¸‹å—å†…æ·»åŠ çš„é¢å¤–æ®‹å·®ï¼Œä¾‹å¦‚æ¥è‡ª T2I-Adapter ä¾§æ¨¡å‹

è¿”å›

UNet2DConditionOutput æˆ–`tuple`

å¦‚æœ`return_dict`ä¸º Trueï¼Œåˆ™è¿”å›ä¸€ä¸ª UNet2DConditionOutputï¼Œå¦åˆ™è¿”å›ä¸€ä¸ª`tuple`ï¼Œå…¶ä¸­ç¬¬ä¸€ä¸ªå…ƒç´ æ˜¯æ ·æœ¬å¼ é‡ã€‚

UNet2DConditionModel çš„å‰å‘æ–¹æ³•ã€‚

#### `fuse_qkv_projections`

[<æ¥æº>](https://github.com/huggingface/diffusers/blob/v0.26.3/src/diffusers/models/unets/unet_2d_condition.py#L796)

```py
( )
```

å¯ç”¨èåˆçš„ QKV æŠ•å½±ã€‚å¯¹äºè‡ªæ³¨æ„åŠ›æ¨¡å—ï¼Œæ‰€æœ‰æŠ•å½±çŸ©é˜µï¼ˆå³æŸ¥è¯¢ã€é”®ã€å€¼ï¼‰éƒ½è¢«èåˆã€‚å¯¹äºäº¤å‰æ³¨æ„åŠ›æ¨¡å—ï¼Œé”®å’Œå€¼æŠ•å½±çŸ©é˜µè¢«èåˆã€‚

æ­¤ API ä¸ºğŸ§ªå®éªŒæ€§è´¨ã€‚

#### `set_attention_slice`

[<æ¥æº>](https://github.com/huggingface/diffusers/blob/v0.26.3/src/diffusers/models/unets/unet_2d_condition.py#L695)

```py
( slice_size )
```

å‚æ•°

+   `slice_size`ï¼ˆ`str`æˆ–`int`æˆ–`list(int)`ï¼Œ*å¯é€‰*ï¼Œé»˜è®¤ä¸º`"auto"`ï¼‰â€”å½“ä¸º`"auto"`æ—¶ï¼Œæ³¨æ„åŠ›å¤´çš„è¾“å…¥å‡åŠï¼Œå› æ­¤æ³¨æ„åŠ›åœ¨ä¸¤ä¸ªæ­¥éª¤ä¸­è®¡ç®—ã€‚å¦‚æœä¸º`"max"`ï¼Œé€šè¿‡ä¸€æ¬¡åªè¿è¡Œä¸€ä¸ªåˆ‡ç‰‡æ¥èŠ‚çœæœ€å¤§å†…å­˜ã€‚å¦‚æœæä¾›äº†ä¸€ä¸ªæ•°å­—ï¼Œåˆ™ä½¿ç”¨`attention_head_dim // slice_size`ä¸ªåˆ‡ç‰‡ã€‚åœ¨è¿™ç§æƒ…å†µä¸‹ï¼Œ`attention_head_dim`å¿…é¡»æ˜¯`slice_size`çš„å€æ•°ã€‚

å¯ç”¨åˆ‡ç‰‡æ³¨æ„åŠ›è®¡ç®—ã€‚

å¯ç”¨æ­¤é€‰é¡¹æ—¶ï¼Œæ³¨æ„åŠ›æ¨¡å—å°†è¾“å…¥å¼ é‡åˆ†ç‰‡ä»¥åœ¨å¤šä¸ªæ­¥éª¤ä¸­è®¡ç®—æ³¨æ„åŠ›ã€‚è¿™å¯¹äºåœ¨èŠ‚çœä¸€äº›å†…å­˜çš„åŒæ—¶æ¢å–ä¸€ç‚¹é€Ÿåº¦ä¸‹é™å¾ˆæœ‰ç”¨ã€‚

#### `set_attn_processor`

[<æ¥æº>](https://github.com/huggingface/diffusers/blob/v0.26.3/src/diffusers/models/unets/unet_2d_condition.py#L646)

```py
( processor: Union )
```

å‚æ•°

+   `processor`ï¼ˆ`AttentionProcessor`çš„`dict`æˆ–ä»…`AttentionProcessor`ï¼‰â€”å·²å®ä¾‹åŒ–çš„å¤„ç†å™¨ç±»æˆ–å¤„ç†å™¨ç±»çš„å­—å…¸ï¼Œå°†è¢«è®¾ç½®ä¸º**æ‰€æœ‰**`Attention`å±‚çš„å¤„ç†å™¨ã€‚

    å¦‚æœ`processor`æ˜¯ä¸€ä¸ªå­—å…¸ï¼Œåˆ™é”®éœ€è¦å®šä¹‰ç›¸åº”äº¤å‰æ³¨æ„åŠ›å¤„ç†å™¨çš„è·¯å¾„ã€‚åœ¨è®¾ç½®å¯è®­ç»ƒçš„æ³¨æ„åŠ›å¤„ç†å™¨æ—¶ï¼Œå¼ºçƒˆå»ºè®®è¿™æ ·åšã€‚

è®¾ç½®ç”¨äºè®¡ç®—æ³¨æ„åŠ›çš„æ³¨æ„åŠ›å¤„ç†å™¨ã€‚

#### `set_default_attn_processor`

[<æ¥æº>](https://github.com/huggingface/diffusers/blob/v0.26.3/src/diffusers/models/unets/unet_2d_condition.py#L680)

```py
( )
```

ç¦ç”¨è‡ªå®šä¹‰æ³¨æ„åŠ›å¤„ç†å™¨å¹¶è®¾ç½®é»˜è®¤çš„æ³¨æ„åŠ›å®ç°ã€‚

#### `unfuse_qkv_projections`

[<æ¥æº>](https://github.com/huggingface/diffusers/blob/v0.26.3/src/diffusers/models/unets/unet_2d_condition.py#L819)

```py
( )
```

ç¦ç”¨äº†èåˆçš„ QKV æŠ•å½±ï¼ˆå¦‚æœå·²å¯ç”¨ï¼‰ã€‚

æ­¤ API ä¸ºğŸ§ªå®éªŒæ€§è´¨ã€‚

#### `unload_lora`

[<æ¥æº>](https://github.com/huggingface/diffusers/blob/v0.26.3/src/diffusers/models/unets/unet_2d_condition.py#L832)

```py
( )
```

å¸è½½ LoRA æƒé‡ã€‚

## UNet2DConditionOutput

### `class diffusers.models.unets.unet_2d_condition.UNet2DConditionOutput`

[<æ¥æº>](https://github.com/huggingface/diffusers/blob/v0.26.3/src/diffusers/models/unets/unet_2d_condition.py#L58)

```py
( sample: FloatTensor = None )
```

å‚æ•°

+   `sample` (`torch.FloatTensor`ï¼Œå½¢çŠ¶ä¸º`(batch_size, num_channels, height, width)`) â€” åœ¨`encoder_hidden_states`è¾“å…¥ä¸Šæ¡ä»¶åŒ–çš„éšè—çŠ¶æ€è¾“å‡ºã€‚æ¨¡å‹çš„æœ€åä¸€å±‚çš„è¾“å‡ºã€‚

UNet2DConditionModel çš„è¾“å‡ºã€‚

## FlaxUNet2DConditionModel

### `class diffusers.FlaxUNet2DConditionModel`

[<æ¥æº>](https://github.com/huggingface/diffusers/blob/v0.26.3/src/diffusers/models/unets/unet_2d_condition_flax.py#L48)

```py
( sample_size: int = 32 in_channels: int = 4 out_channels: int = 4 down_block_types: Tuple = ('CrossAttnDownBlock2D', 'CrossAttnDownBlock2D', 'CrossAttnDownBlock2D', 'DownBlock2D') up_block_types: Tuple = ('UpBlock2D', 'CrossAttnUpBlock2D', 'CrossAttnUpBlock2D', 'CrossAttnUpBlock2D') only_cross_attention: Union = False block_out_channels: Tuple = (320, 640, 1280, 1280) layers_per_block: int = 2 attention_head_dim: Union = 8 num_attention_heads: Union = None cross_attention_dim: int = 1280 dropout: float = 0.0 use_linear_projection: bool = False dtype: dtype = <class 'jax.numpy.float32'> flip_sin_to_cos: bool = True freq_shift: int = 0 use_memory_efficient_attention: bool = False split_head_dim: bool = False transformer_layers_per_block: Union = 1 addition_embed_type: Optional = None addition_time_embed_dim: Optional = None addition_embed_type_num_heads: int = 64 projection_class_embeddings_input_dim: Optional = None parent: Union = <flax.linen.module._Sentinel object at 0x7fbd557629e0> name: Optional = None )
```

å‚æ•°

+   `sample_size` (`int`, *å¯é€‰*) â€” è¾“å…¥æ ·æœ¬çš„å¤§å°ã€‚

+   `in_channels` (`int`, *å¯é€‰*, é»˜è®¤ä¸º 4) â€” è¾“å…¥æ ·æœ¬ä¸­çš„é€šé“æ•°ã€‚

+   `out_channels` (`int`, *å¯é€‰*, é»˜è®¤ä¸º 4) â€” è¾“å‡ºä¸­çš„é€šé“æ•°ã€‚

+   `down_block_types` (`Tuple[str]`, *å¯é€‰*, é»˜è®¤ä¸º`("FlaxCrossAttnDownBlock2D", "FlaxCrossAttnDownBlock2D", "FlaxCrossAttnDownBlock2D", "FlaxDownBlock2D")`) â€” è¦ä½¿ç”¨çš„ä¸‹é‡‡æ ·å—çš„å…ƒç»„ã€‚

+   `up_block_types` (`Tuple[str]`, *å¯é€‰*, é»˜è®¤ä¸º`("FlaxUpBlock2D", "FlaxCrossAttnUpBlock2D", "FlaxCrossAttnUpBlock2D", "FlaxCrossAttnUpBlock2D")`) â€” è¦ä½¿ç”¨çš„ä¸Šé‡‡æ ·å—çš„å…ƒç»„ã€‚

+   `block_out_channels` (`Tuple[int]`, *å¯é€‰*, é»˜è®¤ä¸º`(320, 640, 1280, 1280)`) â€” æ¯ä¸ªå—çš„è¾“å‡ºé€šé“çš„å…ƒç»„ã€‚

+   `layers_per_block` (`int`, *å¯é€‰*, é»˜è®¤ä¸º 2) â€” æ¯ä¸ªå—çš„å±‚æ•°ã€‚

+   `attention_head_dim` (`int`æˆ–`Tuple[int]`, *å¯é€‰*, é»˜è®¤ä¸º 8) â€” æ³¨æ„åŠ›å¤´çš„ç»´åº¦ã€‚

+   `num_attention_heads` (`int`æˆ–`Tuple[int]`, *å¯é€‰*) â€” æ³¨æ„åŠ›å¤´çš„æ•°é‡ã€‚

+   `cross_attention_dim` (`int`, *å¯é€‰*, é»˜è®¤ä¸º 768) â€” äº¤å‰æ³¨æ„åŠ›ç‰¹å¾çš„ç»´åº¦ã€‚

+   `dropout` (`float`, *å¯é€‰*, é»˜è®¤ä¸º 0) â€” ä¸‹é‡‡æ ·ã€ä¸Šé‡‡æ ·å’Œç“¶é¢ˆå—çš„ä¸¢å¼ƒæ¦‚ç‡ã€‚

+   `flip_sin_to_cos` (`bool`, *å¯é€‰*, é»˜è®¤ä¸º`True`) â€” æ˜¯å¦åœ¨æ—¶é—´åµŒå…¥ä¸­å°† sin ç¿»è½¬ä¸º cosã€‚

+   `freq_shift` (`int`, *å¯é€‰*, é»˜è®¤ä¸º 0) â€” åº”ç”¨äºæ—¶é—´åµŒå…¥çš„é¢‘ç‡åç§»ã€‚

+   `use_memory_efficient_attention` (`bool`, *å¯é€‰*, é»˜è®¤ä¸º`False`) â€” å¯ç”¨å†…å­˜é«˜æ•ˆçš„æ³¨æ„åŠ›ï¼Œå¦‚[æ­¤å¤„](https://arxiv.org/abs/2112.05682)æ‰€è¿°ã€‚

+   `split_head_dim` (`bool`, *å¯é€‰*, é»˜è®¤ä¸º`False`) â€” æ˜¯å¦å°†å¤´ç»´åº¦æ‹†åˆ†ä¸ºæ–°è½´ä»¥è¿›è¡Œè‡ªæ³¨æ„åŠ›è®¡ç®—ã€‚åœ¨å¤§å¤šæ•°æƒ…å†µä¸‹ï¼Œå¯ç”¨æ­¤æ ‡å¿—åº”è¯¥åŠ é€Ÿ Stable Diffusion 2.x å’Œ Stable Diffusion XL çš„è®¡ç®—ã€‚

ä¸€ä¸ªæœ‰æ¡ä»¶çš„ 2D UNet æ¨¡å‹ï¼Œæ¥å—ä¸€ä¸ªå˜ˆæ‚çš„æ ·æœ¬ã€æ¡ä»¶çŠ¶æ€å’Œä¸€ä¸ªæ—¶é—´æ­¥ï¼Œå¹¶è¿”å›ä¸€ä¸ªå½¢çŠ¶ä¸ºæ ·æœ¬çš„è¾“å‡ºã€‚

æ­¤æ¨¡å‹ç»§æ‰¿è‡ª FlaxModelMixinã€‚æŸ¥çœ‹è¶…ç±»æ–‡æ¡£ä»¥äº†è§£ä¸ºæ‰€æœ‰æ¨¡å‹å®ç°çš„é€šç”¨æ–¹æ³•ï¼ˆå¦‚ä¸‹è½½æˆ–ä¿å­˜ï¼‰ã€‚

æ­¤æ¨¡å‹ä¹Ÿæ˜¯ Flax Linen [flax.linen.Module](https://flax.readthedocs.io/en/latest/flax.linen.html#module)çš„å­ç±»ã€‚å°†å…¶ç”¨ä½œå¸¸è§„çš„ Flax Linen æ¨¡å—ï¼Œå¹¶å‚è€ƒ Flax æ–‡æ¡£ä»¥äº†è§£ä¸å…¶ä¸€èˆ¬ä½¿ç”¨å’Œè¡Œä¸ºç›¸å…³çš„æ‰€æœ‰äº‹é¡¹ã€‚

æ”¯æŒè¯¸å¦‚ä»¥ä¸‹çš„å†…åœ¨ JAX ç‰¹æ€§ï¼š

+   [å³æ—¶ï¼ˆJITï¼‰ç¼–è¯‘](https://jax.readthedocs.io/en/latest/jax.html#just-in-time-compilation-jit)

+   [è‡ªåŠ¨å¾®åˆ†](https://jax.readthedocs.io/en/latest/jax.html#automatic-differentiation)

+   [å‘é‡åŒ–](https://jax.readthedocs.io/en/latest/jax.html#vectorization-vmap)

+   [å¹¶è¡ŒåŒ–](https://jax.readthedocs.io/en/latest/jax.html#parallelization-pmap)

## FlaxUNet2DConditionOutput

### `class diffusers.models.unets.unet_2d_condition_flax.FlaxUNet2DConditionOutput`

[<æ¥æº>](https://github.com/huggingface/diffusers/blob/v0.26.3/src/diffusers/models/unets/unet_2d_condition_flax.py#L35)

```py
( sample: Array )
```

å‚æ•°

+   `sample`ï¼ˆå½¢çŠ¶ä¸º`(batch_size, num_channels, height, width)`çš„`jnp.ndarray`ï¼‰- åœ¨`encoder_hidden_states`è¾“å…¥æ¡ä»¶ä¸‹è¾“å‡ºçš„éšè—çŠ¶æ€ã€‚æ¨¡å‹çš„æœ€åä¸€å±‚çš„è¾“å‡ºã€‚

FlaxUNet2DConditionModel çš„è¾“å‡ºã€‚

#### `replace`

[<æ¥æº>](https://github.com/huggingface/diffusers/blob/v0.26.3/src/flax/struct.py#L111)

```py
( **updates )
```

â€œè¿”å›ä¸€ä¸ªç”¨æ–°å€¼æ›¿æ¢æŒ‡å®šå­—æ®µçš„æ–°å¯¹è±¡ã€‚
