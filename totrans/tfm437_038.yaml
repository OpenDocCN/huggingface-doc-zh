- en: Knowledge Distillation for Computer Vision
  id: totrans-0
  prefs:
  - PREF_H1
  type: TYPE_NORMAL
  zh: è®¡ç®—æœºè§†è§‰çŸ¥è¯†è’¸é¦
- en: 'Original text: [https://huggingface.co/docs/transformers/v4.37.2/en/tasks/knowledge_distillation_for_image_classification](https://huggingface.co/docs/transformers/v4.37.2/en/tasks/knowledge_distillation_for_image_classification)'
  id: totrans-1
  prefs:
  - PREF_BQ
  type: TYPE_NORMAL
  zh: åŸå§‹æ–‡æœ¬ï¼š[https://huggingface.co/docs/transformers/v4.37.2/en/tasks/knowledge_distillation_for_image_classification](https://huggingface.co/docs/transformers/v4.37.2/en/tasks/knowledge_distillation_for_image_classification)
- en: null
  id: totrans-2
  prefs: []
  type: TYPE_NORMAL
- en: Knowledge distillation is a technique used to transfer knowledge from a larger,
    more complex model (teacher) to a smaller, simpler model (student). To distill
    knowledge from one model to another, we take a pre-trained teacher model trained
    on a certain task (image classification for this case) and randomly initialize
    a student model to be trained on image classification. Next, we train the student
    model to minimize the difference between itâ€™s outputs and the teacherâ€™s outputs,
    thus making it mimic the behavior. It was first introduced in [Distilling the
    Knowledge in a Neural Network by Hinton et al](https://arxiv.org/abs/1503.02531).
    In this guide, we will do task-specific knowledge distillation. We will use the
    [beans dataset](https://huggingface.co/datasets/beans) for this.
  id: totrans-3
  prefs: []
  type: TYPE_NORMAL
  zh: çŸ¥è¯†è’¸é¦æ˜¯ä¸€ç§æŠ€æœ¯ï¼Œç”¨äºå°†çŸ¥è¯†ä»ä¸€ä¸ªæ›´å¤§ã€æ›´å¤æ‚çš„æ¨¡å‹ï¼ˆæ•™å¸ˆï¼‰è½¬ç§»åˆ°ä¸€ä¸ªæ›´å°ã€æ›´ç®€å•çš„æ¨¡å‹ï¼ˆå­¦ç”Ÿï¼‰ã€‚ä¸ºäº†ä»ä¸€ä¸ªæ¨¡å‹ä¸­æå–çŸ¥è¯†åˆ°å¦ä¸€ä¸ªæ¨¡å‹ï¼Œæˆ‘ä»¬é‡‡ç”¨ä¸€ä¸ªåœ¨ç‰¹å®šä»»åŠ¡ä¸Šï¼ˆæœ¬ä¾‹ä¸­ä¸ºå›¾åƒåˆ†ç±»ï¼‰è®­ç»ƒè¿‡çš„é¢„è®­ç»ƒæ•™å¸ˆæ¨¡å‹ï¼Œå¹¶éšæœºåˆå§‹åŒ–ä¸€ä¸ªå­¦ç”Ÿæ¨¡å‹ç”¨äºå›¾åƒåˆ†ç±»è®­ç»ƒã€‚æ¥ä¸‹æ¥ï¼Œæˆ‘ä»¬è®­ç»ƒå­¦ç”Ÿæ¨¡å‹ä»¥æœ€å°åŒ–å…¶è¾“å‡ºä¸æ•™å¸ˆè¾“å‡ºä¹‹é—´çš„å·®å¼‚ï¼Œä»è€Œä½¿å…¶æ¨¡ä»¿è¡Œä¸ºã€‚è¿™æœ€åˆæ˜¯ç”±
    [Hinton ç­‰äººåœ¨ç¥ç»ç½‘ç»œä¸­æå–çŸ¥è¯†](https://arxiv.org/abs/1503.02531) ä¸­é¦–æ¬¡å¼•å…¥çš„ã€‚åœ¨è¿™ä¸ªæŒ‡å—ä¸­ï¼Œæˆ‘ä»¬å°†è¿›è¡Œç‰¹å®šä»»åŠ¡çš„çŸ¥è¯†è’¸é¦ã€‚æˆ‘ä»¬å°†ä½¿ç”¨
    [beans æ•°æ®é›†](https://huggingface.co/datasets/beans)ã€‚
- en: This guide demonstrates how you can distill a [fine-tuned ViT model](https://huggingface.co/merve/vit-mobilenet-beans-224)
    (teacher model) to a [MobileNet](https://huggingface.co/google/mobilenet_v2_1.4_224)
    (student model) using the [TrainerÂ API](https://huggingface.co/docs/transformers/en/main_classes/trainer#trainer)
    of ğŸ¤— Transformers.
  id: totrans-4
  prefs: []
  type: TYPE_NORMAL
  zh: è¿™ä¸ªæŒ‡å—æ¼”ç¤ºäº†å¦‚ä½•ä½¿ç”¨ ğŸ¤— Transformers çš„ [Trainer API](https://huggingface.co/docs/transformers/en/main_classes/trainer#trainer)
    å°†ä¸€ä¸ª [fine-tuned ViT æ¨¡å‹](https://huggingface.co/merve/vit-mobilenet-beans-224)ï¼ˆæ•™å¸ˆæ¨¡å‹ï¼‰è’¸é¦åˆ°ä¸€ä¸ª
    [MobileNet](https://huggingface.co/google/mobilenet_v2_1.4_224)ï¼ˆå­¦ç”Ÿæ¨¡å‹ï¼‰ã€‚
- en: Letâ€™s install the libraries needed for distillation and evaluating the process.
  id: totrans-5
  prefs: []
  type: TYPE_NORMAL
  zh: è®©æˆ‘ä»¬å®‰è£…è¿›è¡Œè’¸é¦å’Œè¯„ä¼°è¿‡ç¨‹æ‰€éœ€çš„åº“ã€‚
- en: '[PRE0]'
  id: totrans-6
  prefs: []
  type: TYPE_PRE
  zh: '[PRE0]'
- en: In this example, we are using the `merve/beans-vit-224` model as teacher model.
    Itâ€™s an image classification model, based on `google/vit-base-patch16-224-in21k`
    fine-tuned on beans dataset. We will distill this model to a randomly initialized
    MobileNetV2.
  id: totrans-7
  prefs: []
  type: TYPE_NORMAL
  zh: åœ¨è¿™ä¸ªä¾‹å­ä¸­ï¼Œæˆ‘ä»¬ä½¿ç”¨ `merve/beans-vit-224` æ¨¡å‹ä½œä¸ºæ•™å¸ˆæ¨¡å‹ã€‚è¿™æ˜¯ä¸€ä¸ªåŸºäº `google/vit-base-patch16-224-in21k`
    åœ¨ beans æ•°æ®é›†ä¸Šå¾®è°ƒçš„å›¾åƒåˆ†ç±»æ¨¡å‹ã€‚æˆ‘ä»¬å°†å°†è¿™ä¸ªæ¨¡å‹è’¸é¦åˆ°ä¸€ä¸ªéšæœºåˆå§‹åŒ–çš„ MobileNetV2ã€‚
- en: We will now load the dataset.
  id: totrans-8
  prefs: []
  type: TYPE_NORMAL
  zh: æˆ‘ä»¬ç°åœ¨å°†åŠ è½½æ•°æ®é›†ã€‚
- en: '[PRE1]'
  id: totrans-9
  prefs: []
  type: TYPE_PRE
  zh: '[PRE1]'
- en: We can use an image processor from either of the models, as in this case they
    return the same output with same resolution. We will use the `map()` method of
    `dataset` to apply the preprocessing to every split of the dataset.
  id: totrans-10
  prefs: []
  type: TYPE_NORMAL
  zh: æˆ‘ä»¬å¯ä»¥ä»ä»»ä¸€æ¨¡å‹ä¸­ä½¿ç”¨å›¾åƒå¤„ç†å™¨ï¼Œå› ä¸ºåœ¨è¿™ç§æƒ…å†µä¸‹å®ƒä»¬è¿”å›ç›¸åŒåˆ†è¾¨ç‡çš„ç›¸åŒè¾“å‡ºã€‚æˆ‘ä»¬å°†ä½¿ç”¨ `dataset` çš„ `map()` æ–¹æ³•å°†é¢„å¤„ç†åº”ç”¨äºæ•°æ®é›†çš„æ¯ä¸ªæ‹†åˆ†ã€‚
- en: '[PRE2]'
  id: totrans-11
  prefs: []
  type: TYPE_PRE
  zh: '[PRE2]'
- en: Essentially, we want the student model (a randomly initialized MobileNet) to
    mimic the teacher model (fine-tuned vision transformer). To achieve this, we first
    get the logits output from the teacher and the student. Then, we divide each of
    them by the parameter `temperature` which controls the importance of each soft
    target. A parameter called `lambda` weighs the importance of the distillation
    loss. In this example, we will use `temperature=5` and `lambda=0.5`. We will use
    the Kullback-Leibler Divergence loss to compute the divergence between the student
    and teacher. Given two data P and Q, KL Divergence explains how much extra information
    we need to represent P using Q. If two are identical, their KL divergence is zero,
    as thereâ€™s no other information needed to explain P from Q. Thus, in the context
    of knowledge distillation, KL divergence is useful.
  id: totrans-12
  prefs: []
  type: TYPE_NORMAL
  zh: åŸºæœ¬ä¸Šï¼Œæˆ‘ä»¬å¸Œæœ›å­¦ç”Ÿæ¨¡å‹ï¼ˆéšæœºåˆå§‹åŒ–çš„ MobileNetï¼‰æ¨¡ä»¿æ•™å¸ˆæ¨¡å‹ï¼ˆå¾®è°ƒçš„è§†è§‰å˜æ¢å™¨ï¼‰ã€‚ä¸ºäº†å®ç°è¿™ä¸€ç‚¹ï¼Œæˆ‘ä»¬é¦–å…ˆä»æ•™å¸ˆå’Œå­¦ç”Ÿä¸­è·å– logits
    è¾“å‡ºã€‚ç„¶åï¼Œæˆ‘ä»¬å°†å®ƒä»¬ä¸­çš„æ¯ä¸€ä¸ªé™¤ä»¥æ§åˆ¶æ¯ä¸ªè½¯ç›®æ ‡é‡è¦æ€§çš„å‚æ•° `temperature`ã€‚ä¸€ä¸ªç§°ä¸º `lambda` çš„å‚æ•°æƒè¡¡äº†è’¸é¦æŸå¤±çš„é‡è¦æ€§ã€‚åœ¨è¿™ä¸ªä¾‹å­ä¸­ï¼Œæˆ‘ä»¬å°†ä½¿ç”¨
    `temperature=5` å’Œ `lambda=0.5`ã€‚æˆ‘ä»¬å°†ä½¿ç”¨ Kullback-Leibler æ•£åº¦æŸå¤±æ¥è®¡ç®—å­¦ç”Ÿå’Œæ•™å¸ˆä¹‹é—´çš„å·®å¼‚ã€‚ç»™å®šä¸¤ä¸ªæ•°æ®
    P å’Œ Qï¼ŒKL æ•£åº¦è§£é‡Šäº†æˆ‘ä»¬éœ€è¦å¤šå°‘é¢å¤–ä¿¡æ¯æ¥ç”¨ Q è¡¨ç¤º Pã€‚å¦‚æœä¸¤è€…ç›¸åŒï¼Œå®ƒä»¬çš„ KL æ•£åº¦ä¸ºé›¶ï¼Œå› ä¸ºä¸éœ€è¦å…¶ä»–ä¿¡æ¯æ¥è§£é‡Š Pã€‚å› æ­¤ï¼Œåœ¨çŸ¥è¯†è’¸é¦çš„èƒŒæ™¯ä¸‹ï¼ŒKL
    æ•£åº¦æ˜¯æœ‰ç”¨çš„ã€‚
- en: '[PRE3]'
  id: totrans-13
  prefs: []
  type: TYPE_PRE
  zh: '[PRE3]'
- en: We will now login to Hugging Face Hub so we can push our model to the Hugging
    Face Hub through the `Trainer`.
  id: totrans-14
  prefs: []
  type: TYPE_NORMAL
  zh: æˆ‘ä»¬ç°åœ¨å°†ç™»å½•åˆ° Hugging Face Hubï¼Œè¿™æ ·æˆ‘ä»¬å°±å¯ä»¥é€šè¿‡ `Trainer` å°†æˆ‘ä»¬çš„æ¨¡å‹æ¨é€åˆ° Hugging Face Hubã€‚
- en: '[PRE4]'
  id: totrans-15
  prefs: []
  type: TYPE_PRE
  zh: '[PRE4]'
- en: Letâ€™s set the `TrainingArguments`, the teacher model and the student model.
  id: totrans-16
  prefs: []
  type: TYPE_NORMAL
  zh: è®©æˆ‘ä»¬è®¾ç½® `TrainingArguments`ã€æ•™å¸ˆæ¨¡å‹å’Œå­¦ç”Ÿæ¨¡å‹ã€‚
- en: '[PRE5]'
  id: totrans-17
  prefs: []
  type: TYPE_PRE
  zh: '[PRE5]'
- en: We can use `compute_metrics` function to evaluate our model on the test set.
    This function will be used during the training process to compute the `accuracy`
    & `f1` of our model.
  id: totrans-18
  prefs: []
  type: TYPE_NORMAL
  zh: æˆ‘ä»¬å¯ä»¥ä½¿ç”¨ `compute_metrics` å‡½æ•°åœ¨æµ‹è¯•é›†ä¸Šè¯„ä¼°æˆ‘ä»¬çš„æ¨¡å‹ã€‚è¿™ä¸ªå‡½æ•°å°†åœ¨è®­ç»ƒè¿‡ç¨‹ä¸­ç”¨äºè®¡ç®—æˆ‘ä»¬æ¨¡å‹çš„ `å‡†ç¡®ç‡` å’Œ `f1`ã€‚
- en: '[PRE6]'
  id: totrans-19
  prefs: []
  type: TYPE_PRE
  zh: '[PRE6]'
- en: Letâ€™s initialize the `Trainer` with the training arguments we defined. We will
    also initialize our data collator.
  id: totrans-20
  prefs: []
  type: TYPE_NORMAL
  zh: è®©æˆ‘ä»¬ä½¿ç”¨æˆ‘ä»¬å®šä¹‰çš„è®­ç»ƒå‚æ•°åˆå§‹åŒ– `Trainer`ã€‚æˆ‘ä»¬è¿˜å°†åˆå§‹åŒ–æˆ‘ä»¬çš„æ•°æ®æ”¶é›†å™¨ã€‚
- en: '[PRE7]'
  id: totrans-21
  prefs: []
  type: TYPE_PRE
  zh: '[PRE7]'
- en: We can now train our model.
  id: totrans-22
  prefs: []
  type: TYPE_NORMAL
  zh: æˆ‘ä»¬ç°åœ¨å¯ä»¥è®­ç»ƒæˆ‘ä»¬çš„æ¨¡å‹ã€‚
- en: '[PRE8]'
  id: totrans-23
  prefs: []
  type: TYPE_PRE
  zh: '[PRE8]'
- en: We can evaluate the model on the test set.
  id: totrans-24
  prefs: []
  type: TYPE_NORMAL
  zh: æˆ‘ä»¬å¯ä»¥åœ¨æµ‹è¯•é›†ä¸Šè¯„ä¼°æ¨¡å‹ã€‚
- en: '[PRE9]'
  id: totrans-25
  prefs: []
  type: TYPE_PRE
  zh: '[PRE9]'
- en: On test set, our model reaches 72 percent accuracy. To have a sanity check over
    efficiency of distillation, we also trained MobileNet on the beans dataset from
    scratch with the same hyperparameters and observed 63 percent accuracy on the
    test set. We invite the readers to try different pre-trained teacher models, student
    architectures, distillation parameters and report their findings. The training
    logs and checkpoints for distilled model can be found in [this repository](https://huggingface.co/merve/vit-mobilenet-beans-224),
    and MobileNetV2 trained from scratch can be found in this [repository](https://huggingface.co/merve/resnet-mobilenet-beans-5).
  id: totrans-26
  prefs: []
  type: TYPE_NORMAL
  zh: åœ¨æµ‹è¯•é›†ä¸Šï¼Œæˆ‘ä»¬çš„æ¨¡å‹è¾¾åˆ°äº†72ï¼…çš„å‡†ç¡®ç‡ã€‚ä¸ºäº†å¯¹è’¸é¦æ•ˆç‡è¿›è¡Œåˆç†æ€§æ£€æŸ¥ï¼Œæˆ‘ä»¬è¿˜ä½¿ç”¨ç›¸åŒçš„è¶…å‚æ•°ä»å¤´å¼€å§‹åœ¨è±†ç±»æ•°æ®é›†ä¸Šè®­ç»ƒMobileNetï¼Œå¹¶è§‚å¯Ÿåˆ°æµ‹è¯•é›†ä¸Šçš„63ï¼…å‡†ç¡®ç‡ã€‚æˆ‘ä»¬é‚€è¯·è¯»è€…å°è¯•ä¸åŒçš„é¢„è®­ç»ƒæ•™å¸ˆæ¨¡å‹ã€å­¦ç”Ÿæ¶æ„ã€è’¸é¦å‚æ•°ï¼Œå¹¶æŠ¥å‘Šä»–ä»¬çš„å‘ç°ã€‚è’¸é¦æ¨¡å‹çš„è®­ç»ƒæ—¥å¿—å’Œæ£€æŸ¥ç‚¹å¯ä»¥åœ¨[æ­¤å­˜å‚¨åº“](https://huggingface.co/merve/vit-mobilenet-beans-224)ä¸­æ‰¾åˆ°ï¼Œä»å¤´å¼€å§‹è®­ç»ƒçš„MobileNetV2å¯ä»¥åœ¨æ­¤[å­˜å‚¨åº“](https://huggingface.co/merve/resnet-mobilenet-beans-5)ä¸­æ‰¾åˆ°ã€‚
