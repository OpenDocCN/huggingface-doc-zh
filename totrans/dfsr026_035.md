# æç¤ºåŠ æƒ

> åŸå§‹æ–‡æœ¬ï¼š[https://huggingface.co/docs/diffusers/using-diffusers/weighted_prompts](https://huggingface.co/docs/diffusers/using-diffusers/weighted_prompts)

æç¤ºåŠ æƒæä¾›äº†ä¸€ç§å¼ºè°ƒæˆ–å‡å¼±æç¤ºä¸­æŸäº›éƒ¨åˆ†çš„æ–¹æ³•ï¼Œä»è€Œæ›´å¥½åœ°æ§åˆ¶ç”Ÿæˆçš„å›¾åƒã€‚æç¤ºå¯ä»¥åŒ…å«å¤šä¸ªæ¦‚å¿µï¼Œè¿™äº›æ¦‚å¿µä¼šè½¬åŒ–ä¸ºä¸Šä¸‹æ–‡åŒ–çš„æ–‡æœ¬åµŒå…¥ã€‚è¿™äº›åµŒå…¥è¢«æ¨¡å‹ç”¨äºè°ƒèŠ‚å…¶äº¤å‰æ³¨æ„åŠ›å±‚ä»¥ç”Ÿæˆå›¾åƒï¼ˆé˜…è¯»Stable Diffusionçš„[åšæ–‡](https://huggingface.co/blog/stable_diffusion)ä»¥äº†è§£æ›´å¤šå·¥ä½œåŸç†ï¼‰ã€‚

æç¤ºåŠ æƒé€šè¿‡å¢åŠ æˆ–å‡å°‘ä¸æç¤ºä¸­æ¦‚å¿µå¯¹åº”çš„æ–‡æœ¬åµŒå…¥å‘é‡çš„æ¯”ä¾‹æ¥å·¥ä½œï¼Œå› ä¸ºæ‚¨å¯èƒ½å¹¶ä¸ä¸€å®šå¸Œæœ›æ¨¡å‹å¹³ç­‰å…³æ³¨æ‰€æœ‰æ¦‚å¿µã€‚å‡†å¤‡æç¤ºåŠ æƒåµŒå…¥çš„æœ€ç®€å•æ–¹æ³•æ˜¯ä½¿ç”¨[Compel](https://github.com/damian0815/compel)ï¼Œä¸€ä¸ªæ–‡æœ¬æç¤ºåŠ æƒå’Œæ··åˆåº“ã€‚ä¸€æ—¦æ‚¨æœ‰äº†æç¤ºåŠ æƒçš„åµŒå…¥ï¼Œæ‚¨å¯ä»¥å°†å®ƒä»¬ä¼ é€’ç»™ä»»ä½•å…·æœ‰[`prompt_embeds`](https://huggingface.co/docs/diffusers/en/api/pipelines/stable_diffusion/text2img#diffusers.StableDiffusionPipeline.__call__.prompt_embeds)ï¼ˆä»¥åŠå¯é€‰çš„[`negative_prompt_embeds`](https://huggingface.co/docs/diffusers/en/api/pipelines/stable_diffusion/text2img#diffusers.StableDiffusionPipeline.__call__.negative_prompt_embeds)ï¼‰å‚æ•°çš„ç®¡é“ï¼Œä¾‹å¦‚[StableDiffusionPipeline](/docs/diffusers/v0.26.3/en/api/pipelines/stable_diffusion/text2img#diffusers.StableDiffusionPipeline)ã€[StableDiffusionControlNetPipeline](/docs/diffusers/v0.26.3/en/api/pipelines/controlnet#diffusers.StableDiffusionControlNetPipeline)å’Œ[StableDiffusionXLPipeline](/docs/diffusers/v0.26.3/en/api/pipelines/stable_diffusion/stable_diffusion_xl#diffusers.StableDiffusionXLPipeline)ã€‚

å¦‚æœæ‚¨å–œæ¬¢çš„ç®¡é“æ²¡æœ‰`prompt_embeds`å‚æ•°ï¼Œè¯·æ‰“å¼€ä¸€ä¸ª[é—®é¢˜](https://github.com/huggingface/diffusers/issues/new/choose)ï¼Œä»¥ä¾¿æˆ‘ä»¬å¯ä»¥æ·»åŠ å®ƒï¼

æœ¬æŒ‡å—å°†å‘æ‚¨å±•ç¤ºå¦‚ä½•åœ¨ğŸ¤— Diffusersä¸­ä½¿ç”¨Compelå¯¹æç¤ºè¿›è¡ŒåŠ æƒå’Œæ··åˆã€‚

åœ¨å¼€å§‹ä¹‹å‰ï¼Œè¯·ç¡®ä¿æ‚¨å·²å®‰è£…äº†æœ€æ–°ç‰ˆæœ¬çš„Compelï¼š

```py
# uncomment to install in Colab
#!pip install compel --upgrade
```

åœ¨æœ¬æŒ‡å—ä¸­ï¼Œè®©æˆ‘ä»¬ä½¿ç”¨[StableDiffusionPipeline](/docs/diffusers/v0.26.3/en/api/pipelines/stable_diffusion/text2img#diffusers.StableDiffusionPipeline)ç”Ÿæˆä¸€ä¸ªå¸¦æœ‰æç¤ºâ€œä¸€åªçº¢è‰²çš„çŒ«æ­£åœ¨ç©çƒâ€çš„å›¾åƒï¼š

```py
from diffusers import StableDiffusionPipeline, UniPCMultistepScheduler
import torch

pipe = StableDiffusionPipeline.from_pretrained("CompVis/stable-diffusion-v1-4", use_safetensors=True)
pipe.scheduler = UniPCMultistepScheduler.from_config(pipe.scheduler.config)
pipe.to("cuda")

prompt = "a red cat playing with a ball"

generator = torch.Generator(device="cpu").manual_seed(33)

image = pipe(prompt, generator=generator, num_inference_steps=20).images[0]
image
```

![](../Images/24306b5413fb415e890bea8d0fc47df3.png)

## åŠ æƒ

æ‚¨ä¼šæ³¨æ„åˆ°å›¾åƒä¸­æ²¡æœ‰â€œçƒâ€ï¼è®©æˆ‘ä»¬ä½¿ç”¨compelæ¥å¢åŠ æç¤ºä¸­â€œçƒâ€çš„æ¦‚å¿µã€‚åˆ›å»ºä¸€ä¸ª[`Compel`](https://github.com/damian0815/compel/blob/main/doc/compel.md#compel-objects)å¯¹è±¡ï¼Œå¹¶ä¼ é€’ä¸€ä¸ªåˆ†è¯å™¨å’Œæ–‡æœ¬ç¼–ç å™¨ï¼š

```py
from compel import Compel

compel_proc = Compel(tokenizer=pipe.tokenizer, text_encoder=pipe.text_encoder)
```

compelä½¿ç”¨`+`æˆ–`-`æ¥å¢åŠ æˆ–å‡å°‘æç¤ºä¸­å•è¯çš„æƒé‡ã€‚è¦å¢åŠ â€œçƒâ€çš„æƒé‡ï¼š

`+` å¯¹åº”å€¼`1.1`ï¼Œ`++` å¯¹åº”`1.1^2`ï¼Œä¾æ­¤ç±»æ¨ã€‚åŒæ ·ï¼Œ`-` å¯¹åº”`0.9`ï¼Œ`--` å¯¹åº”`0.9^2`ã€‚è¯·éšæ„å°è¯•åœ¨æ‚¨çš„æç¤ºä¸­æ·»åŠ æ›´å¤šçš„`+`æˆ–`-`ï¼

```py
prompt = "a red cat playing with a ball++"
```

å°†æç¤ºä¼ é€’ç»™`compel_proc`ä»¥åˆ›å»ºæ–°çš„æç¤ºåµŒå…¥ï¼Œç„¶åä¼ é€’ç»™ç®¡é“ï¼š

```py
prompt_embeds = compel_proc(prompt)
generator = torch.manual_seed(33)

image = pipe(prompt_embeds=prompt_embeds, generator=generator, num_inference_steps=20).images[0]
image
```

![](../Images/a6ea0a8316ec0e299ce79bd94f29d7a8.png)

è¦å‡å°‘æç¤ºçš„æŸäº›éƒ¨åˆ†çš„æƒé‡ï¼Œè¯·ä½¿ç”¨`-`åç¼€ï¼š

```py
prompt = "a red------- cat playing with a ball"
prompt_embeds = compel_proc(prompt)

generator = torch.manual_seed(33)

image = pipe(prompt_embeds=prompt_embeds, generator=generator, num_inference_steps=20).images[0]
image
```

![](../Images/eed909df9ef11a12b97771b8f85ab810.png)

æ‚¨ç”šè‡³å¯ä»¥åœ¨åŒä¸€ä¸ªæç¤ºä¸­å¢åŠ æˆ–å‡å°‘å¤šä¸ªæ¦‚å¿µï¼š

```py
prompt = "a red cat++ playing with a ball----"
prompt_embeds = compel_proc(prompt)

generator = torch.manual_seed(33)

image = pipe(prompt_embeds=prompt_embeds, generator=generator, num_inference_steps=20).images[0]
image
```

![](../Images/b82d3f52e501e13a58f1b034a7a8f0ad.png)

## æ··åˆ

æ‚¨è¿˜å¯ä»¥é€šè¿‡å°†`.blend()`æ·»åŠ åˆ°æç¤ºåˆ—è¡¨å¹¶ä¼ é€’ä¸€äº›æƒé‡æ¥åˆ›å»ºåŠ æƒçš„*æ··åˆ*æç¤ºã€‚æ‚¨çš„æ··åˆå¯èƒ½ä¸æ€»æ˜¯äº§ç”Ÿæ‚¨æœŸæœ›çš„ç»“æœï¼Œå› ä¸ºå®ƒä¼šæ‰“ç ´æœ‰å…³æ–‡æœ¬ç¼–ç å™¨åŠŸèƒ½çš„ä¸€äº›å‡è®¾ï¼Œæ‰€ä»¥åªæ˜¯ç©å¾—å¼€å¿ƒï¼Œå°è¯•ä¸€ä¸‹ï¼

```py
prompt_embeds = compel_proc('("a red cat playing with a ball", "jungle").blend(0.7, 0.8)')
generator = torch.Generator(device="cuda").manual_seed(33)

image = pipe(prompt_embeds=prompt_embeds, generator=generator, num_inference_steps=20).images[0]
image
```

![](../Images/103f3c5f3fa90b6e9ec2d9e26bbb49cc.png)

## è¿æ¥

ä¸€ä¸ªè¿è¯ç‹¬ç«‹åœ°æ‰©æ•£æ¯ä¸ªæç¤ºï¼Œå¹¶é€šè¿‡å®ƒä»¬çš„åŠ æƒå’Œè¿æ¥å®ƒä»¬çš„ç»“æœã€‚åœ¨æç¤ºåˆ—è¡¨çš„æœ«å°¾æ·»åŠ `.and()`ä»¥åˆ›å»ºä¸€ä¸ªè¿è¯ï¼š

```py
prompt_embeds = compel_proc('["a red cat", "playing with a", "ball"].and()')
generator = torch.Generator(device="cuda").manual_seed(55)

image = pipe(prompt_embeds=prompt_embeds, generator=generator, num_inference_steps=20).images[0]
image
```

![](../Images/82df108b16157d244b56b16b408735a0.png)

## æ–‡æœ¬åè½¬

[æ–‡æœ¬åè½¬](../training/text_inversion)æ˜¯ä¸€ç§ä»ä¸€äº›å›¾åƒä¸­å­¦ä¹ ç‰¹å®šæ¦‚å¿µçš„æŠ€æœ¯ï¼Œæ‚¨å¯ä»¥ä½¿ç”¨å®ƒæ¥ç”ŸæˆåŸºäºè¯¥æ¦‚å¿µçš„æ–°å›¾åƒã€‚

åˆ›å»ºä¸€ä¸ªç®¡é“ï¼Œå¹¶ä½¿ç”¨[load_textual_inversion()](/docs/diffusers/v0.26.3/en/api/loaders/textual_inversion#diffusers.loaders.TextualInversionLoaderMixin.load_textual_inversion)å‡½æ•°åŠ è½½æ–‡æœ¬åè½¬åµŒå…¥ï¼ˆéšæ—¶æµè§ˆ[ç¨³å®šæ‰©æ•£æ¦‚å¿µåŒ–å™¨](https://huggingface.co/spaces/sd-concepts-library/stable-diffusion-conceptualizer)ä»¥è·å–100å¤šä¸ªè®­ç»ƒæ¦‚å¿µï¼‰ï¼š

```py
import torch
from diffusers import StableDiffusionPipeline
from compel import Compel, DiffusersTextualInversionManager

pipe = StableDiffusionPipeline.from_pretrained(
  "runwayml/stable-diffusion-v1-5", torch_dtype=torch.float16,
  use_safetensors=True, variant="fp16").to("cuda")
pipe.load_textual_inversion("sd-concepts-library/midjourney-style")
```

Compelæä¾›äº†ä¸€ä¸ª`DiffusersTextualInversionManager`ç±»ï¼Œç”¨äºç®€åŒ–æ–‡æœ¬åè½¬çš„æç¤ºåŠ æƒã€‚å®ä¾‹åŒ–`DiffusersTextualInversionManager`å¹¶å°†å…¶ä¼ é€’ç»™`Compel`ç±»ï¼š

```py
textual_inversion_manager = DiffusersTextualInversionManager(pipe)
compel_proc = Compel(
    tokenizer=pipe.tokenizer,
    text_encoder=pipe.text_encoder,
    textual_inversion_manager=textual_inversion_manager)
```

å°†æ¦‚å¿µåˆå¹¶åˆ°æ¡ä»¶æç¤ºä¸­ï¼Œä½¿ç”¨`<concept>`è¯­æ³•ï¼š

```py
prompt_embeds = compel_proc('("A red cat++ playing with a ball <midjourney-style>")')

image = pipe(prompt_embeds=prompt_embeds).images[0]
image
```

![](../Images/018f9f77083d1e4a4a4c59065acae017.png)

## DreamBooth

[DreamBooth](../training/dreambooth)æ˜¯ä¸€ç§æŠ€æœ¯ï¼Œå¯ä»¥æ ¹æ®å¯¹ä¸»é¢˜çš„å‡ å¼ å›¾åƒç”Ÿæˆä¸»é¢˜åŒ–å›¾åƒï¼Œè€Œæ— éœ€å¯¹ä¸»é¢˜è¿›è¡Œè®­ç»ƒã€‚å®ƒç±»ä¼¼äºæ–‡æœ¬åè½¬ï¼Œä½†DreamBoothè®­ç»ƒå®Œæ•´æ¨¡å‹ï¼Œè€Œæ–‡æœ¬åè½¬åªæ˜¯å¾®è°ƒæ–‡æœ¬åµŒå…¥ã€‚è¿™æ„å‘³ç€æ‚¨åº”è¯¥ä½¿ç”¨[from_pretrained()](/docs/diffusers/v0.26.3/en/api/pipelines/overview#diffusers.DiffusionPipeline.from_pretrained)æ¥åŠ è½½DreamBoothæ¨¡å‹ï¼ˆéšæ—¶æµè§ˆ[ç¨³å®šæ‰©æ•£Dreamboothæ¦‚å¿µåº“](https://huggingface.co/sd-dreambooth-library)ä»¥è·å–100å¤šä¸ªè®­ç»ƒæ¨¡å‹ï¼‰ï¼š

```py
import torch
from diffusers import DiffusionPipeline, UniPCMultistepScheduler
from compel import Compel

pipe = DiffusionPipeline.from_pretrained("sd-dreambooth-library/dndcoverart-v1", torch_dtype=torch.float16).to("cuda")
pipe.scheduler = UniPCMultistepScheduler.from_config(pipe.scheduler.config)
```

åˆ›å»ºä¸€ä¸ªå¸¦æœ‰åˆ†è¯å™¨å’Œæ–‡æœ¬ç¼–ç å™¨çš„`Compel`ç±»ï¼Œå¹¶å°†æ‚¨çš„æç¤ºä¼ é€’ç»™å®ƒã€‚æ ¹æ®æ‚¨ä½¿ç”¨çš„æ¨¡å‹ï¼Œæ‚¨éœ€è¦å°†æ¨¡å‹çš„å”¯ä¸€æ ‡è¯†ç¬¦åˆå¹¶åˆ°æ‚¨çš„æç¤ºä¸­ã€‚ä¾‹å¦‚ï¼Œ`dndcoverart-v1`æ¨¡å‹ä½¿ç”¨æ ‡è¯†ç¬¦`dndcoverart`ï¼š

```py
compel_proc = Compel(tokenizer=pipe.tokenizer, text_encoder=pipe.text_encoder)
prompt_embeds = compel_proc('("magazine cover of a dndcoverart dragon, high quality, intricate details, larry elmore art style").and()')
image = pipe(prompt_embeds=prompt_embeds).images[0]
image
```

![](../Images/5b0fd6647d5253e64ddf3beb46283bde.png)

## ç¨³å®šæ‰©æ•£XL

ç¨³å®šæ‰©æ•£XLï¼ˆSDXLï¼‰æœ‰ä¸¤ä¸ªåˆ†è¯å™¨å’Œæ–‡æœ¬ç¼–ç å™¨ï¼Œå› æ­¤å®ƒçš„ä½¿ç”¨æ–¹å¼æœ‰ç‚¹ä¸åŒã€‚ä¸ºäº†è§£å†³è¿™ä¸ªé—®é¢˜ï¼Œæ‚¨åº”è¯¥å°†ä¸¤ä¸ªåˆ†è¯å™¨å’Œç¼–ç å™¨éƒ½ä¼ é€’ç»™`Compel`ç±»ï¼š

```py
from compel import Compel, ReturnedEmbeddingsType
from diffusers import DiffusionPipeline
from diffusers.utils import make_image_grid
import torch

pipeline = DiffusionPipeline.from_pretrained(
  "stabilityai/stable-diffusion-xl-base-1.0",
  variant="fp16",
  use_safetensors=True,
  torch_dtype=torch.float16
).to("cuda")

compel = Compel(
  tokenizer=[pipeline.tokenizer, pipeline.tokenizer_2] ,
  text_encoder=[pipeline.text_encoder, pipeline.text_encoder_2],
  returned_embeddings_type=ReturnedEmbeddingsType.PENULTIMATE_HIDDEN_STATES_NON_NORMALIZED,
  requires_pooled=[False, True]
)
```

è¿™ä¸€æ¬¡ï¼Œè®©æˆ‘ä»¬å°†ç¬¬ä¸€ä¸ªæç¤ºä¸­çš„â€œçƒâ€æƒé‡æé«˜1.5å€ï¼Œå¹¶å°†ç¬¬äºŒä¸ªæç¤ºä¸­çš„â€œçƒâ€æƒé‡é™ä½0.6å€ã€‚[StableDiffusionXLPipeline](/docs/diffusers/v0.26.3/en/api/pipelines/stable_diffusion/stable_diffusion_xl#diffusers.StableDiffusionXLPipeline)è¿˜éœ€è¦[`pooled_prompt_embeds`](https://huggingface.co/docs/diffusers/en/api/pipelines/stable_diffusion/stable_diffusion_xl#diffusers.StableDiffusionXLInpaintPipeline.__call__.pooled_prompt_embeds)ï¼ˆä»¥åŠå¯é€‰çš„[`negative_pooled_prompt_embeds`](https://huggingface.co/docs/diffusers/en/api/pipelines/stable_diffusion/stable_diffusion_xl#diffusers.StableDiffusionXLInpaintPipeline.__call__.negative_pooled_prompt_embeds)ï¼‰ï¼Œå› æ­¤æ‚¨åº”è¯¥å°†è¿™äº›ä¼ é€’ç»™ç®¡é“ä»¥åŠæ¡ä»¶å¼ é‡ï¼š

```py
# apply weights
prompt = ["a red cat playing with a (ball)1.5", "a red cat playing with a (ball)0.6"]
conditioning, pooled = compel(prompt)

# generate image
generator = [torch.Generator().manual_seed(33) for _ in range(len(prompt))]
images = pipeline(prompt_embeds=conditioning, pooled_prompt_embeds=pooled, generator=generator, num_inference_steps=30).images
make_image_grid(images, rows=1, cols=2)
```

![](../Images/067abbd7c08a8dee4ee6a6f556c86e97.png)

ä¸€åªçº¢è‰²çš„çŒ«æ­£åœ¨ç©ä¸€ä¸ªï¼ˆçƒï¼‰1.5

![](../Images/1c14404c57c40fb1d0c84a7c12d4cb5c.png)

ä¸€åªçº¢è‰²çš„çŒ«æ­£åœ¨ç©ä¸€ä¸ªï¼ˆçƒï¼‰0.6
