# 用于训练的定制硬件

> 原始文本：[https://huggingface.co/docs/transformers/v4.37.2/en/perf_hardware](https://huggingface.co/docs/transformers/v4.37.2/en/perf_hardware)

您用于运行模型训练和推理的硬件可能会对性能产生重大影响。要深入了解GPU，请务必查看Tim Dettmer的优秀[博客文章](https://timdettmers.com/2020/09/07/which-gpu-for-deep-learning/)。

让我们看看一些关于GPU设置的实用建议。

## GPU

当您训练更大的模型时，您基本上有三个选择：

+   更大的GPU

+   更多的GPU

+   更多的CPU和NVMe（由[DeepSpeed-Infinity](main_classes/deepspeed#nvme-support)卸载）

让我们从只有一个GPU的情况开始。

### 电源和冷却

如果您购买了昂贵的高端GPU，请确保为其提供正确的电源和足够的冷却。

**电源**：

一些高端消费级GPU卡有2个甚至3个PCI-E 8针电源插座。确保您有与插座数量相同的独立12V PCI-E 8针电缆插入卡中。不要使用同一电缆末端的2个分裂（也称为猪尾电缆）。也就是说，如果GPU上有2个插座，您希望从PSU到卡的有2个PCI-E 8针电缆，而不是一个末端有2个PCI-E 8针连接器的电缆！否则，您将无法充分发挥卡的性能。

每个PCI-E 8针电源电缆需要插入PSU侧的12V电源线，可以提供高达150W的功率。

一些其他卡可能使用PCI-E 12针连接器，这些连接器可以提供高达500-600W的功率。

低端卡可能使用6针连接器，提供高达75W的功率。

此外，您需要具有稳定电压的高端PSU。一些质量较低的PSU可能无法为卡提供所需的稳定电压以使其在峰值状态下运行。

当然，PSU需要有足够的未使用瓦特数来为卡供电。

**冷却**：

当GPU过热时，它将开始降频，并且不会提供完整的性能，甚至在温度过高时可能会关闭。

很难确定GPU在负载严重时应该追求的确切最佳温度，但可能在+80C以下是好的，但更低更好 - 也许70-75C是一个很好的范围。降频很可能会在84-90C左右开始。但除了降低性能外，长时间处于非常高的温度下可能会缩短GPU的寿命。

接下来让我们看看拥有多个GPU时最重要的一个方面：连接性。

### 多GPU连接

如果您使用多个GPU，卡的互连方式对总训练时间有很大影响。如果GPU在同一物理节点上，您可以运行：

```py
nvidia-smi topo -m
```

它将告诉您GPU是如何互连的。在具有双GPU且通过NVLink连接的机器上，您很可能会看到类似以下的内容：

```py
        GPU0    GPU1    CPU Affinity    NUMA Affinity
GPU0     X      NV2     0-23            N/A
GPU1    NV2      X      0-23            N/A
```

在没有NVLink的不同机器上，我们可能会看到：

```py
        GPU0    GPU1    CPU Affinity    NUMA Affinity
GPU0     X      PHB     0-11            N/A
GPU1    PHB      X      0-11            N/A
```

该报告包括此图例：

```py
  X    = Self
  SYS  = Connection traversing PCIe as well as the SMP interconnect between NUMA nodes (e.g., QPI/UPI)
  NODE = Connection traversing PCIe as well as the interconnect between PCIe Host Bridges within a NUMA node
  PHB  = Connection traversing PCIe as well as a PCIe Host Bridge (typically the CPU)
  PXB  = Connection traversing multiple PCIe bridges (without traversing the PCIe Host Bridge)
  PIX  = Connection traversing at most a single PCIe bridge
  NV#  = Connection traversing a bonded set of # NVLinks
```

因此，第一个报告`NV2`告诉我们GPU是通过2个NVLink互连的，而第二个报告`PHB`则是典型的消费级PCIe+Bridge设置。

检查您的设置上有什么类型的连接性。其中一些将使卡之间的通信更快（例如NVLink），而其他一些则更慢（例如PHB）。

根据所使用的可扩展性解决方案的类型，连接速度可能会产生重大或轻微影响。如果GPU需要很少同步，如DDP，较慢连接的影响将不那么显著。如果GPU需要经常互发消息，如ZeRO-DP，则更快的连接变得非常重要以实现更快的训练。

#### NVlink

[NVLink](https://en.wikipedia.org/wiki/NVLink)是由Nvidia开发的基于线的串行多通道近距离通信链路。

每一代新产品都提供更快的带宽，例如，这里是来自[Nvidia Ampere GA102 GPU Architecture](https://www.nvidia.com/content/dam/en-zz/Solutions/geforce/ampere/pdf/NVIDIA-ampere-GA102-GPU-Architecture-Whitepaper-V1.pdf)的一句话：

> 第三代NVLink® GA102 GPU利用了NVIDIA的第三代NVLink接口，其中包括四个x4链接，每个链接在两个GPU之间的每个方向提供14.0625 GB/sec的带宽。四个链接在每个方向提供56.25 GB/sec的带宽，两个GPU之间总共提供112.5 GB/sec的带宽。两个RTX 3090 GPU可以使用NVLink连接在一起进行SLI。（请注意，不支持3路和4路SLI配置。）

所以在`nvidia-smi topo -m`的输出中，`NVX`报告中的`X`值越高越好。这取决于您的GPU架构。

让我们比较在wikitext的小样本上训练gpt2语言模型的执行。

结果是：

| NVlink | 时间 |
| --- | --: |
| Y | 101秒 |
| N | 131秒 |

您可以看到，NVLink完成训练速度比快约23%。在第二个基准测试中，我们使用`NCCL_P2P_DISABLE=1`告诉GPU不要使用NVLink。

以下是完整的基准测试代码和输出：

```py
# DDP w/ NVLink

rm -r /tmp/test-clm; CUDA_VISIBLE_DEVICES=0,1 torchrun \
--nproc_per_node 2 examples/pytorch/language-modeling/run_clm.py --model_name_or_path gpt2 \
--dataset_name wikitext --dataset_config_name wikitext-2-raw-v1 --do_train \
--output_dir /tmp/test-clm --per_device_train_batch_size 4 --max_steps 200

{'train_runtime': 101.9003, 'train_samples_per_second': 1.963, 'epoch': 0.69}

# DDP w/o NVLink

rm -r /tmp/test-clm; CUDA_VISIBLE_DEVICES=0,1 NCCL_P2P_DISABLE=1 torchrun \
--nproc_per_node 2 examples/pytorch/language-modeling/run_clm.py --model_name_or_path gpt2 \
--dataset_name wikitext --dataset_config_name wikitext-2-raw-v1 --do_train
--output_dir /tmp/test-clm --per_device_train_batch_size 4 --max_steps 200

{'train_runtime': 131.4367, 'train_samples_per_second': 1.522, 'epoch': 0.69}
```

硬件：每个2x TITAN RTX 24GB + 2个NVLink的NVlink（在`nvidia-smi topo -m`中为`NV2`） 软件：`pytorch-1.8-to-be` + `cuda-11.0` / `transformers==4.3.0.dev0`
