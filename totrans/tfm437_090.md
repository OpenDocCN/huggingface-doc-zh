# æµ‹è¯•

> åŸå§‹æ–‡æœ¬ï¼š[https://huggingface.co/docs/transformers/v4.37.2/en/testing](https://huggingface.co/docs/transformers/v4.37.2/en/testing)

è®©æˆ‘ä»¬çœ‹çœ‹ğŸ¤— Transformersæ¨¡å‹æ˜¯å¦‚ä½•æµ‹è¯•çš„ï¼Œä»¥åŠæ‚¨å¦‚ä½•ç¼–å†™æ–°æµ‹è¯•å¹¶æ”¹è¿›ç°æœ‰æµ‹è¯•ã€‚

å­˜å‚¨åº“ä¸­æœ‰2ä¸ªæµ‹è¯•å¥—ä»¶ï¼š

1.  `tests` â€” ç”¨äºä¸€èˆ¬APIçš„æµ‹è¯•

1.  `examples` â€” ä¸»è¦ç”¨äºä¸å±äºAPIçš„å„ç§åº”ç”¨çš„æµ‹è¯•

## å¦‚ä½•æµ‹è¯•transformers

1.  ä¸€æ—¦æäº¤äº†PRï¼Œå®ƒå°†é€šè¿‡9ä¸ªCircleCiä½œä¸šè¿›è¡Œæµ‹è¯•ã€‚å¯¹è¯¥PRçš„æ¯ä¸ªæ–°æäº¤éƒ½ä¼šé‡æ–°æµ‹è¯•ã€‚è¿™äº›ä½œä¸šåœ¨æ­¤[é…ç½®æ–‡ä»¶](https://github.com/huggingface/transformers/tree/main/.circleci/config.yml)ä¸­å®šä¹‰ï¼Œå› æ­¤å¦‚æœéœ€è¦ï¼Œæ‚¨å¯ä»¥åœ¨æ‚¨çš„æœºå™¨ä¸Šé‡ç°ç›¸åŒçš„ç¯å¢ƒã€‚

    è¿™äº›CIä½œä¸šä¸è¿è¡Œ`@slow`æµ‹è¯•ã€‚

1.  ç”±[github actions](https://github.com/huggingface/transformers/actions)è¿è¡Œ3ä¸ªä½œä¸šï¼š

    +   [torch hubé›†æˆ](https://github.com/huggingface/transformers/tree/main/.github/workflows/github-torch-hub.yml)ï¼šæ£€æŸ¥torch hubé›†æˆæ˜¯å¦æ­£å¸¸å·¥ä½œã€‚

    +   [è‡ªæ‰˜ç®¡ï¼ˆæ¨é€ï¼‰](https://github.com/huggingface/transformers/tree/main/.github/workflows/self-push.yml)ï¼šä»…åœ¨`main`ä¸Šçš„æäº¤ä¸Šåœ¨GPUä¸Šè¿è¡Œå¿«é€Ÿæµ‹è¯•ã€‚ä»…åœ¨`main`ä¸Šçš„æäº¤æ›´æ–°äº†ä»¥ä¸‹æ–‡ä»¶å¤¹ä¸­çš„ä»£ç æ—¶æ‰è¿è¡Œï¼š`src`ï¼Œ`tests`ï¼Œ`.github`ï¼ˆä»¥é˜²æ­¢åœ¨æ·»åŠ æ¨¡å‹å¡ã€ç¬”è®°æœ¬ç­‰æ—¶è¿è¡Œï¼‰ã€‚

    +   [è‡ªæ‰˜ç®¡çš„è¿è¡Œå™¨](https://github.com/huggingface/transformers/tree/main/.github/workflows/self-scheduled.yml)ï¼šåœ¨`tests`å’Œ`examples`ä¸­çš„GPUä¸Šè¿è¡Œæ­£å¸¸å’Œæ…¢é€Ÿæµ‹è¯•ï¼š

```py
RUN_SLOW=1 pytest tests/
RUN_SLOW=1 pytest examples/
```

ç»“æœå¯ä»¥åœ¨[æ­¤å¤„](https://github.com/huggingface/transformers/actions)è§‚å¯Ÿã€‚

## è¿è¡Œæµ‹è¯•

### é€‰æ‹©è¦è¿è¡Œçš„æµ‹è¯•

æœ¬æ–‡è¯¦ç»†ä»‹ç»äº†å¦‚ä½•è¿è¡Œæµ‹è¯•ã€‚å¦‚æœé˜…è¯»å®Œæ‰€æœ‰å†…å®¹åï¼Œæ‚¨éœ€è¦æ›´å¤šç»†èŠ‚ï¼Œæ‚¨å¯ä»¥åœ¨[æ­¤å¤„](https://docs.pytest.org/en/latest/usage.html)æ‰¾åˆ°å®ƒä»¬ã€‚

ä»¥ä¸‹æ˜¯è¿è¡Œæµ‹è¯•çš„ä¸€äº›æœ€æœ‰ç”¨çš„æ–¹æ³•ã€‚

è¿è¡Œæ‰€æœ‰ï¼š

```py
pytest
```

æˆ–ï¼š

```py
make test
```

è¯·æ³¨æ„ï¼Œåè€…è¢«å®šä¹‰ä¸ºï¼š

```py
python -m pytest -n auto --dist=loadfile -s -v ./tests/
```

å‘Šè¯‰pytestï¼š

+   è¿è¡Œä¸CPUæ ¸å¿ƒæ•°é‡ç›¸åŒçš„æµ‹è¯•è¿›ç¨‹ï¼ˆå¦‚æœRAMä¸è¶³å¯èƒ½ä¼šå¤ªå¤šï¼ï¼‰

+   ç¡®ä¿åŒä¸€æ–‡ä»¶ä¸­çš„æ‰€æœ‰æµ‹è¯•å°†ç”±åŒä¸€ä¸ªæµ‹è¯•è¿›ç¨‹è¿è¡Œ

+   ä¸æ•è·è¾“å‡º

+   ä»¥è¯¦ç»†æ¨¡å¼è¿è¡Œ

### è·å–æ‰€æœ‰æµ‹è¯•çš„åˆ—è¡¨

æµ‹è¯•å¥—ä»¶çš„æ‰€æœ‰æµ‹è¯•ï¼š

```py
pytest --collect-only -q
```

ç»™å®šæµ‹è¯•æ–‡ä»¶çš„æ‰€æœ‰æµ‹è¯•ï¼š

```py
pytest tests/test_optimization.py --collect-only -q
```

### è¿è¡Œç‰¹å®šæµ‹è¯•æ¨¡å—

è¦è¿è¡Œå•ä¸ªæµ‹è¯•æ¨¡å—ï¼š

```py
pytest tests/utils/test_logging.py
```

### è¿è¡Œç‰¹å®šæµ‹è¯•

ç”±äºå¤§å¤šæ•°æµ‹è¯•ä¸­ä½¿ç”¨äº†unittestï¼Œè¦è¿è¡Œç‰¹å®šçš„å­æµ‹è¯•ï¼Œæ‚¨éœ€è¦çŸ¥é“åŒ…å«è¿™äº›æµ‹è¯•çš„unittestç±»çš„åç§°ã€‚ä¾‹å¦‚ï¼Œå¯èƒ½æ˜¯ï¼š

```py
pytest tests/test_optimization.py::OptimizationTest::test_adam_w
```

è¿™é‡Œï¼š

+   `tests/test_optimization.py` - å…·æœ‰æµ‹è¯•çš„æ–‡ä»¶

+   `OptimizationTest` - ç±»çš„åç§°

+   `test_adam_w` - ç‰¹å®šæµ‹è¯•å‡½æ•°çš„åç§°

å¦‚æœæ–‡ä»¶åŒ…å«å¤šä¸ªç±»ï¼Œæ‚¨å¯ä»¥é€‰æ‹©ä»…è¿è¡Œç»™å®šç±»çš„æµ‹è¯•ã€‚ä¾‹å¦‚ï¼š

```py
pytest tests/test_optimization.py::OptimizationTest
```

å°†è¿è¡Œè¯¥ç±»ä¸­çš„æ‰€æœ‰æµ‹è¯•ã€‚

å¦‚å‰æ‰€è¿°ï¼Œæ‚¨å¯ä»¥é€šè¿‡è¿è¡Œä»¥ä¸‹å†…å®¹æŸ¥çœ‹`OptimizationTest`ç±»ä¸­åŒ…å«çš„æ‰€æœ‰æµ‹è¯•ï¼š

```py
pytest tests/test_optimization.py::OptimizationTest --collect-only -q
```

æ‚¨å¯ä»¥é€šè¿‡å…³é”®å­—è¡¨è¾¾å¼è¿è¡Œæµ‹è¯•ã€‚

ä»…è¿è¡ŒåŒ…å«`adam`åç§°çš„æµ‹è¯•ï¼š

```py
pytest -k adam tests/test_optimization.py
```

é€»è¾‘`and`å’Œ`or`å¯ç”¨äºæŒ‡ç¤ºæ˜¯å¦åº”åŒ¹é…æ‰€æœ‰å…³é”®å­—æˆ–ä»»ä¸€å…³é”®å­—ã€‚`not`å¯ç”¨äºå¦å®šã€‚

è¦è¿è¡Œé™¤åŒ…å«`adam`çš„åç§°çš„æµ‹è¯•ä¹‹å¤–çš„æ‰€æœ‰æµ‹è¯•ï¼š

```py
pytest -k "not adam" tests/test_optimization.py
```

æ‚¨å¯ä»¥å°†è¿™ä¸¤ç§æ¨¡å¼ç»“åˆåœ¨ä¸€èµ·ï¼š

```py
pytest -k "ada and not adam" tests/test_optimization.py
```

ä¾‹å¦‚ï¼Œè¦åŒæ—¶è¿è¡Œ`test_adafactor`å’Œ`test_adam_w`ï¼Œæ‚¨å¯ä»¥ä½¿ç”¨ï¼š

```py
pytest -k "test_adam_w or test_adam_w" tests/test_optimization.py
```

è¯·æ³¨æ„ï¼Œæˆ‘ä»¬åœ¨è¿™é‡Œä½¿ç”¨`or`ï¼Œå› ä¸ºæˆ‘ä»¬å¸Œæœ›å…³é”®å­—ä¸­çš„ä»»ä½•ä¸€ä¸ªåŒ¹é…ä»¥åŒ…æ‹¬ä¸¤è€…ã€‚

å¦‚æœè¦ä»…åŒ…å«åŒ…å«ä¸¤ç§æ¨¡å¼çš„æµ‹è¯•ï¼Œåº”ä½¿ç”¨`and`ï¼š

```py
pytest -k "test and ada" tests/test_optimization.py
```

### è¿è¡ŒåŠ é€Ÿæµ‹è¯•

æœ‰æ—¶æ‚¨éœ€è¦åœ¨æ¨¡å‹ä¸Šè¿è¡Œ`accelerate`æµ‹è¯•ã€‚ä¸ºæ­¤ï¼Œæ‚¨åªéœ€å°†`-m accelerate_tests`æ·»åŠ åˆ°æ‚¨çš„å‘½ä»¤ä¸­ï¼Œä¾‹å¦‚ï¼Œå¦‚æœæ‚¨æƒ³åœ¨`OPT`ä¸Šè¿è¡Œè¿™äº›æµ‹è¯•ï¼š

```py
RUN_SLOW=1 pytest -m accelerate_tests tests/models/opt/test_modeling_opt.py 
```

### è¿è¡Œæ–‡æ¡£æµ‹è¯•

ä¸ºäº†æµ‹è¯•æ–‡æ¡£ç¤ºä¾‹æ˜¯å¦æ­£ç¡®ï¼Œæ‚¨åº”è¯¥æ£€æŸ¥`doctests`æ˜¯å¦é€šè¿‡ã€‚ä¾‹å¦‚ï¼Œè®©æˆ‘ä»¬ä½¿ç”¨[`WhisperModel.forward`çš„æ–‡æ¡£å­—ç¬¦ä¸²](https://github.com/huggingface/transformers/blob/main/src/transformers/models/whisper/modeling_whisper.py#L1017-L1035)ï¼š

```py
r"""
Returns:

Example:
    ```python

    >>> import torch

    >>> from transformers import WhisperModel, WhisperFeatureExtractor

    ä»æ•°æ®é›†å¯¼å…¥æ•°æ®é›†

    >>> model = WhisperModel.from_pretrained("openai/whisper-base")

    >>> feature_extractor = WhisperFeatureExtractor.from_pretrained("openai/whisper-base")

    >>> ds = load_dataset("hf-internal-testing/librispeech_asr_dummy", "clean", split="validation")

    >>> inputs = feature_extractor(ds[0]["audio"]["array"], return_tensors="pt")

    >>> input_features = inputs.input_features

    >>> decoder_input_ids = torch.tensor([[1, 1]]) * model.config.decoder_start_token_id

    >>> last_hidden_state = model(input_features, decoder_input_ids=decoder_input_ids).last_hidden_state

    >>> list(last_hidden_state.shape)

    [1, 2, 512]

    ```py"""

```

åªéœ€è¿è¡Œä»¥ä¸‹è¡Œï¼Œè‡ªåŠ¨æµ‹è¯•æ‰€éœ€æ–‡ä»¶ä¸­çš„æ¯ä¸ªæ–‡æ¡£å­—ç¬¦ä¸²ç¤ºä¾‹ï¼š

```py
pytest --doctest-modules <path_to_file_or_dir>
```

å¦‚æœæ–‡ä»¶å…·æœ‰markdownæ‰©å±•åï¼Œåº”æ·»åŠ `--doctest-glob="*.md"`å‚æ•°ã€‚

### ä»…è¿è¡Œä¿®æ”¹åçš„æµ‹è¯•

æ‚¨å¯ä»¥é€šè¿‡ä½¿ç”¨[pytest-picked](https://github.com/anapaulagomes/pytest-picked)æ¥è¿è¡Œä¸æœªæš‚å­˜æ–‡ä»¶æˆ–å½“å‰åˆ†æ”¯ï¼ˆæ ¹æ®Gitï¼‰ç›¸å…³çš„æµ‹è¯•ã€‚è¿™æ˜¯ä¸€ä¸ªå¿«é€Ÿæµ‹è¯•æ‚¨çš„æ›´æ”¹æ˜¯å¦ç ´åäº†ä»»ä½•å†…å®¹çš„å¥½æ–¹æ³•ï¼Œå› ä¸ºå®ƒä¸ä¼šè¿è¡Œä¸æ‚¨æœªè§¦åŠçš„æ–‡ä»¶ç›¸å…³çš„æµ‹è¯•ã€‚

```py
pip install pytest-picked
```

```py
pytest --picked
```

å°†ä»å·²ä¿®æ”¹ä½†å°šæœªæäº¤çš„æ–‡ä»¶å’Œæ–‡ä»¶å¤¹ä¸­è¿è¡Œæ‰€æœ‰æµ‹è¯•ã€‚

### åœ¨æºä»£ç ä¿®æ”¹æ—¶è‡ªåŠ¨é‡æ–°è¿è¡Œå¤±è´¥çš„æµ‹è¯•

[pytest-xdist](https://github.com/pytest-dev/pytest-xdist)æä¾›äº†ä¸€ä¸ªéå¸¸æœ‰ç”¨çš„åŠŸèƒ½ï¼Œå¯ä»¥æ£€æµ‹æ‰€æœ‰å¤±è´¥çš„æµ‹è¯•ï¼Œç„¶åç­‰å¾…æ‚¨ä¿®æ”¹æ–‡ä»¶å¹¶æŒç»­é‡æ–°è¿è¡Œè¿™äº›å¤±è´¥çš„æµ‹è¯•ï¼Œç›´åˆ°å®ƒä»¬é€šè¿‡ï¼ŒåŒæ—¶æ‚¨ä¿®å¤å®ƒä»¬ã€‚è¿™å°†é‡å¤è¿›è¡Œï¼Œç›´åˆ°æ‰€æœ‰æµ‹è¯•é€šè¿‡ï¼Œä¹‹åå†æ¬¡æ‰§è¡Œå®Œæ•´è¿è¡Œã€‚

```py
pip install pytest-xdist
```

è¦è¿›å…¥æ¨¡å¼ï¼š`pytest -f`æˆ–`pytest --looponfail`

é€šè¿‡æŸ¥çœ‹`looponfailroots`æ ¹ç›®å½•åŠå…¶æ‰€æœ‰å†…å®¹ï¼ˆé€’å½’ï¼‰æ¥æ£€æµ‹æ–‡ä»¶æ›´æ”¹ã€‚å¦‚æœæ­¤å€¼çš„é»˜è®¤å€¼å¯¹æ‚¨ä¸èµ·ä½œç”¨ï¼Œæ‚¨å¯ä»¥é€šè¿‡åœ¨`setup.cfg`ä¸­è®¾ç½®é…ç½®é€‰é¡¹æ¥æ›´æ”¹é¡¹ç›®ä¸­çš„å€¼ï¼š

```py
[tool:pytest]
looponfailroots = transformers tests
```

æˆ–`pytest.ini`/`tox.ini`æ–‡ä»¶ï¼š

```py
[pytest]
looponfailroots = transformers tests
```

è¿™å°†å¯¼è‡´ä»…æŸ¥æ‰¾ç›¸å¯¹äºiniæ–‡ä»¶ç›®å½•æŒ‡å®šçš„ç›¸åº”ç›®å½•ä¸­çš„æ–‡ä»¶æ›´æ”¹ã€‚

[pytest-watch](https://github.com/joeyespo/pytest-watch)æ˜¯æ­¤åŠŸèƒ½çš„å¦ä¸€ç§å®ç°ã€‚

### è·³è¿‡ä¸€ä¸ªæµ‹è¯•æ¨¡å—

å¦‚æœæ‚¨æƒ³è¿è¡Œæ‰€æœ‰æµ‹è¯•æ¨¡å—ï¼Œé™¤äº†ä¸€äº›ï¼Œæ‚¨å¯ä»¥é€šè¿‡æä¾›ä¸€ä¸ªæ˜ç¡®çš„æµ‹è¯•è¿è¡Œåˆ—è¡¨æ¥æ’é™¤å®ƒä»¬ã€‚ä¾‹å¦‚ï¼Œè¦è¿è¡Œé™¤äº†`test_modeling_*.py`æµ‹è¯•ä¹‹å¤–çš„æ‰€æœ‰æµ‹è¯•ï¼š

```py
pytest *ls -1 tests/*py | grep -v test_modeling*
```

### æ¸…é™¤çŠ¶æ€

CIæ„å»ºå’Œéš”ç¦»é‡è¦æ—¶ï¼ˆé’ˆå¯¹é€Ÿåº¦ï¼‰ï¼Œåº”æ¸…é™¤ç¼“å­˜ï¼š

```py
pytest --cache-clear tests
```

### å¹¶è¡Œè¿è¡Œæµ‹è¯•

å¦‚å‰æ‰€è¿°ï¼Œ`make test`é€šè¿‡`pytest-xdist`æ’ä»¶ï¼ˆ`-n X`å‚æ•°ï¼Œä¾‹å¦‚`-n 2`ä»¥è¿è¡Œ2ä¸ªå¹¶è¡Œä½œä¸šï¼‰å¹¶è¡Œè¿è¡Œæµ‹è¯•ã€‚

`pytest-xdist`çš„`--dist=`é€‰é¡¹å…è®¸æ§åˆ¶å¦‚ä½•å¯¹æµ‹è¯•è¿›è¡Œåˆ†ç»„ã€‚`--dist=loadfile`å°†ä½äºä¸€ä¸ªæ–‡ä»¶ä¸­çš„æµ‹è¯•æ”¾åœ¨åŒä¸€ä¸ªè¿›ç¨‹ä¸­ã€‚

ç”±äºæ‰§è¡Œæµ‹è¯•çš„é¡ºåºä¸åŒä¸”ä¸å¯é¢„æµ‹ï¼Œå¦‚æœä½¿ç”¨`pytest-xdist`è¿è¡Œæµ‹è¯•å¥—ä»¶ä¼šäº§ç”Ÿå¤±è´¥ï¼ˆæ„å‘³ç€æˆ‘ä»¬æœ‰ä¸€äº›æœªæ£€æµ‹åˆ°çš„è€¦åˆæµ‹è¯•ï¼‰ï¼Œè¯·ä½¿ç”¨[pytest-replay](https://github.com/ESSS/pytest-replay)ä»¥ç›¸åŒé¡ºåºé‡æ”¾æµ‹è¯•ï¼Œè¿™åº”è¯¥æœ‰åŠ©äºä»¥æŸç§æ–¹å¼å°†å¤±è´¥åºåˆ—å‡å°‘åˆ°æœ€å°ã€‚

### æµ‹è¯•é¡ºåºå’Œé‡å¤

æœ€å¥½å¤šæ¬¡é‡å¤æµ‹è¯•ï¼ŒæŒ‰é¡ºåºã€éšæœºæˆ–æˆç»„è¿›è¡Œï¼Œä»¥æ£€æµ‹ä»»ä½•æ½œåœ¨çš„ç›¸äº’ä¾èµ–å’Œä¸çŠ¶æ€ç›¸å…³çš„é”™è¯¯ï¼ˆæ‹†é™¤ï¼‰ã€‚ç›´æ¥çš„å¤šæ¬¡é‡å¤åªæ˜¯ç”¨æ¥æ£€æµ‹ç”±äºDLçš„éšæœºæ€§è€Œæš´éœ²å‡ºçš„ä¸€äº›é—®é¢˜ã€‚

#### é‡å¤æµ‹è¯•

+   [pytest-flakefinder](https://github.com/dropbox/pytest-flakefinder)ï¼š

```py
pip install pytest-flakefinder
```

ç„¶åå¤šæ¬¡è¿è¡Œæ¯ä¸ªæµ‹è¯•ï¼ˆé»˜è®¤ä¸º50æ¬¡ï¼‰ï¼š

```py
pytest --flake-finder --flake-runs=5 tests/test_failing_test.py
```

æ­¤æ’ä»¶ä¸ä¸`pytest-xdist`çš„`-n`æ ‡å¿—ä¸€èµ·ä½¿ç”¨ã€‚

è¿˜æœ‰å¦ä¸€ä¸ªæ’ä»¶`pytest-repeat`ï¼Œä½†å®ƒä¸`unittest`ä¸å…¼å®¹ã€‚

#### ä»¥éšæœºé¡ºåºè¿è¡Œæµ‹è¯•

```py
pip install pytest-random-order
```

é‡è¦æç¤ºï¼šå­˜åœ¨`pytest-random-order`å°†è‡ªåŠ¨éšæœºåŒ–æµ‹è¯•ï¼Œæ— éœ€æ›´æ”¹é…ç½®æˆ–å‘½ä»¤è¡Œé€‰é¡¹ã€‚

æ­£å¦‚å‰é¢æ‰€è§£é‡Šçš„ï¼Œè¿™å…è®¸æ£€æµ‹è€¦åˆæµ‹è¯• - ä¸€ä¸ªæµ‹è¯•çš„çŠ¶æ€å½±å“å¦ä¸€ä¸ªæµ‹è¯•çš„çŠ¶æ€ã€‚å½“å®‰è£…äº†`pytest-random-order`æ—¶ï¼Œå®ƒå°†æ‰“å°ç”¨äºè¯¥ä¼šè¯çš„éšæœºç§å­ï¼Œä¾‹å¦‚ï¼š

```py
pytest tests
[...]
Using --random-order-bucket=module
Using --random-order-seed=573663
```

å› æ­¤ï¼Œå¦‚æœç»™å®šçš„ç‰¹å®šé¡ºåºå¤±è´¥ï¼Œæ‚¨å¯ä»¥é€šè¿‡æ·»åŠ ç¡®åˆ‡çš„ç§å­æ¥é‡ç°å®ƒï¼Œä¾‹å¦‚ï¼š

```py
pytest --random-order-seed=573663
[...]
Using --random-order-bucket=module
Using --random-order-seed=573663
```

åªæœ‰åœ¨ä½¿ç”¨å®Œå…¨ç›¸åŒçš„æµ‹è¯•åˆ—è¡¨ï¼ˆæˆ–æ ¹æœ¬æ²¡æœ‰åˆ—è¡¨ï¼‰æ—¶ï¼Œå®ƒæ‰ä¼šé‡ç°ç¡®åˆ‡çš„é¡ºåºã€‚ä¸€æ—¦å¼€å§‹æ‰‹åŠ¨ç¼©å°åˆ—è¡¨ï¼Œå°±ä¸èƒ½å†ä¾èµ–ç§å­ï¼Œè€Œå¿…é¡»æŒ‰ç…§å®ƒä»¬å¤±è´¥çš„ç¡®åˆ‡é¡ºåºæ‰‹åŠ¨åˆ—å‡ºå®ƒä»¬ï¼Œå¹¶å‘Šè¯‰pytestä¸è¦éšæœºåŒ–å®ƒä»¬ï¼Œè€Œæ˜¯ä½¿ç”¨`--random-order-bucket=none`ï¼Œä¾‹å¦‚ï¼š

```py
pytest --random-order-bucket=none tests/test_a.py tests/test_c.py tests/test_b.py
```

è¦ç¦ç”¨æ‰€æœ‰æµ‹è¯•çš„æ´—ç‰Œï¼š

```py
pytest --random-order-bucket=none
```

é»˜è®¤æƒ…å†µä¸‹ï¼Œéšå«`--random-order-bucket=module`ï¼Œè¿™å°†åœ¨æ¨¡å—çº§åˆ«å¯¹æ–‡ä»¶è¿›è¡Œæ´—ç‰Œã€‚å®ƒè¿˜å¯ä»¥åœ¨`class`ã€`package`ã€`global`å’Œ`none`çº§åˆ«è¿›è¡Œæ´—ç‰Œã€‚æœ‰å…³å®Œæ•´è¯¦æƒ…ï¼Œè¯·å‚é˜…å…¶[æ–‡æ¡£](https://github.com/jbasko/pytest-random-order)ã€‚

å¦ä¸€ä¸ªéšæœºåŒ–çš„æ›¿ä»£æ–¹æ¡ˆæ˜¯ï¼š[`pytest-randomly`](https://github.com/pytest-dev/pytest-randomly)ã€‚è¿™ä¸ªæ¨¡å—å…·æœ‰éå¸¸ç›¸ä¼¼çš„åŠŸèƒ½/æ¥å£ï¼Œä½†å®ƒæ²¡æœ‰`pytest-random-order`ä¸­å¯ç”¨çš„æ¡¶æ¨¡å¼ã€‚ä¸€æ—¦å®‰è£…ï¼Œå®ƒä¹Ÿä¼šå¼ºåˆ¶è‡ªèº«ã€‚

### å¤–è§‚å’Œæ„Ÿè§‰å˜åŒ–

#### pytest-sugar

[pytest-sugar](https://github.com/Frozenball/pytest-sugar) æ˜¯ä¸€ä¸ªæ’ä»¶ï¼Œå¯ä»¥æ”¹å–„å¤–è§‚å’Œæ„Ÿè§‰ï¼Œæ·»åŠ è¿›åº¦æ¡ï¼Œå¹¶ç«‹å³æ˜¾ç¤ºå¤±è´¥çš„æµ‹è¯•å’Œæ–­è¨€ã€‚å®‰è£…åä¼šè‡ªåŠ¨æ¿€æ´»ã€‚

```py
pip install pytest-sugar
```

è¦åœ¨æ²¡æœ‰å®ƒçš„æƒ…å†µä¸‹è¿è¡Œæµ‹è¯•ï¼Œè¯·è¿è¡Œï¼š

```py
pytest -p no:sugar
```

æˆ–è€…å¸è½½å®ƒã€‚

#### æŠ¥å‘Šæ¯ä¸ªå­æµ‹è¯•çš„åç§°åŠå…¶è¿›åº¦

é€šè¿‡`pytest`è¿è¡Œå•ä¸ªæˆ–ä¸€ç»„æµ‹è¯•ï¼ˆåœ¨`pip install pytest-pspec`ä¹‹åï¼‰ï¼š

```py
pytest --pspec tests/test_optimization.py
```

#### ç«‹å³æ˜¾ç¤ºå¤±è´¥çš„æµ‹è¯•

[pytest-instafail](https://github.com/pytest-dev/pytest-instafail) ç«‹å³æ˜¾ç¤ºå¤±è´¥å’Œé”™è¯¯ï¼Œè€Œä¸æ˜¯ç­‰åˆ°æµ‹è¯•ä¼šè¯ç»“æŸã€‚

```py
pip install pytest-instafail
```

```py
pytest --instafail
```

### è¦GPUè¿˜æ˜¯ä¸è¦GPU

åœ¨å¯ç”¨GPUçš„è®¾ç½®ä¸­ï¼Œè¦åœ¨ä»…CPUæ¨¡å¼ä¸‹æµ‹è¯•ï¼Œè¯·æ·»åŠ `CUDA_VISIBLE_DEVICES=""`ï¼š

```py
CUDA_VISIBLE_DEVICES="" pytest tests/utils/test_logging.py
```

æˆ–è€…å¦‚æœæ‚¨æœ‰å¤šä¸ªGPUï¼Œå¯ä»¥æŒ‡å®š`pytest`è¦ä½¿ç”¨çš„GPUã€‚ä¾‹å¦‚ï¼Œå¦‚æœæ‚¨æœ‰GPU `0` å’Œ `1`ï¼Œåˆ™å¯ä»¥ä»…ä½¿ç”¨ç¬¬äºŒä¸ªGPUè¿è¡Œï¼š

```py
CUDA_VISIBLE_DEVICES="1" pytest tests/utils/test_logging.py
```

è¿™åœ¨æ‚¨æƒ³è¦åœ¨ä¸åŒçš„GPUä¸Šè¿è¡Œä¸åŒä»»åŠ¡æ—¶éå¸¸æ–¹ä¾¿ã€‚

ä¸€äº›æµ‹è¯•å¿…é¡»åœ¨ä»…CPUä¸Šè¿è¡Œï¼Œå…¶ä»–æµ‹è¯•å¯ä»¥åœ¨CPUæˆ–GPUæˆ–TPUä¸Šè¿è¡Œï¼Œå¦ä¸€äº›æµ‹è¯•å¯ä»¥åœ¨å¤šä¸ªGPUä¸Šè¿è¡Œã€‚ä»¥ä¸‹è·³è¿‡è£…é¥°å™¨ç”¨äºè®¾ç½®æµ‹è¯•çš„CPU/GPU/TPUè¦æ±‚ï¼š

+   `require_torch` - æ­¤æµ‹è¯•ä»…åœ¨torchä¸‹è¿è¡Œ

+   `require_torch_gpu` - ä¸`require_torch`ç›¸åŒï¼Œè‡³å°‘éœ€è¦1ä¸ªGPU

+   `require_torch_multi_gpu` - ä¸`require_torch`ç›¸åŒï¼Œè‡³å°‘éœ€è¦2ä¸ªGPU

+   `require_torch_non_multi_gpu` - ä¸`require_torch`ç›¸åŒï¼Œéœ€è¦0ä¸ªæˆ–1ä¸ªGPU

+   `require_torch_up_to_2_gpus` - ä¸`require_torch`ç›¸åŒï¼Œéœ€è¦0ä¸ªæˆ–1ä¸ªæˆ–2ä¸ªGPU

+   `require_torch_tpu` - ä¸`require_torch`ç›¸åŒï¼Œè‡³å°‘éœ€è¦1ä¸ªTPU

è®©æˆ‘ä»¬åœ¨ä¸‹è¡¨ä¸­æè¿°GPUè¦æ±‚ï¼š

| nä¸ªGPU | è£…é¥°å™¨ | | --------+-------------------------------- | | `>= 0` | `@require_torch` | | `>= 1` | `@require_torch_gpu` | | `>= 2` | `@require_torch_multi_gpu` | | `< 2` | `@require_torch_non_multi_gpu` | | `< 3` | `@require_torch_up_to_2_gpus` |
| --- | --- | --- | --- | --- | --- | --- | --- | --- | --- | --- | --- | --- | --- | --- | --- | --- | --- | --- |

ä¾‹å¦‚ï¼Œè¿™æ˜¯ä¸€ä¸ªå¿…é¡»åœ¨æœ‰2ä¸ªæˆ–æ›´å¤šä¸ªGPUå¯ç”¨ä¸”å·²å®‰è£…pytorchæ—¶è¿è¡Œçš„æµ‹è¯•ï¼š

```py
@require_torch_multi_gpu
def test_example_with_multi_gpu():
```

å¦‚æœä¸€ä¸ªæµ‹è¯•éœ€è¦`tensorflow`ï¼Œè¯·ä½¿ç”¨`require_tf`è£…é¥°å™¨ã€‚ä¾‹å¦‚ï¼š

```py
@require_tf
def test_tf_thing_with_tensorflow():
```

è¿™äº›è£…é¥°å™¨å¯ä»¥å åŠ ã€‚ä¾‹å¦‚ï¼Œå¦‚æœä¸€ä¸ªæµ‹è¯•å¾ˆæ…¢å¹¶ä¸”åœ¨pytorchä¸‹è‡³å°‘éœ€è¦ä¸€ä¸ªGPUï¼Œè¿™æ˜¯å¦‚ä½•è®¾ç½®çš„ï¼š

```py
@require_torch_gpu
@slow
def test_example_slow_on_gpu():
```

ä¸€äº›è£…é¥°å™¨å¦‚`@parametrized`ä¼šé‡å†™æµ‹è¯•åç§°ï¼Œå› æ­¤`@require_*`è·³è¿‡è£…é¥°å™¨å¿…é¡»åœ¨æœ€ååˆ—å‡ºæ‰èƒ½æ­£å¸¸å·¥ä½œã€‚ä»¥ä¸‹æ˜¯æ­£ç¡®ä½¿ç”¨çš„ç¤ºä¾‹ï¼š

```py
@parameterized.expand(...)
@require_torch_multi_gpu
def test_integration_foo():
```

è¿™ä¸ªé¡ºåºé—®é¢˜åœ¨`@pytest.mark.parametrize`ä¸­ä¸å­˜åœ¨ï¼Œæ‚¨å¯ä»¥å°†å…¶æ”¾åœ¨æœ€å‰é¢æˆ–æœ€åé¢ï¼Œå®ƒä»ç„¶æœ‰æ•ˆã€‚ä½†å®ƒåªé€‚ç”¨äºéå•å…ƒæµ‹è¯•ã€‚

åœ¨æµ‹è¯•ä¸­ï¼š

+   æœ‰å¤šå°‘ä¸ªGPUå¯ç”¨ï¼š

```py
from transformers.testing_utils import get_gpu_count

n_gpu = get_gpu_count()  # works with torch and tf
```

### ä½¿ç”¨ç‰¹å®šçš„PyTorchåç«¯æˆ–è®¾å¤‡è¿›è¡Œæµ‹è¯•

è¦åœ¨ç‰¹å®šçš„torchè®¾å¤‡ä¸Šè¿è¡Œæµ‹è¯•å¥—ä»¶ï¼Œè¯·æ·»åŠ `TRANSFORMERS_TEST_DEVICE="$device"`ï¼Œå…¶ä¸­`$device`æ˜¯ç›®æ ‡åç«¯ã€‚ä¾‹å¦‚ï¼Œè¦ä»…åœ¨CPUä¸Šæµ‹è¯•ï¼š

```py
TRANSFORMERS_TEST_DEVICE="cpu" pytest tests/utils/test_logging.py
```

æ­¤å˜é‡å¯¹äºæµ‹è¯•è‡ªå®šä¹‰æˆ–ä¸å¤ªå¸¸è§çš„PyTorchåç«¯ï¼ˆå¦‚`mps`ï¼‰å¾ˆæœ‰ç”¨ã€‚å®ƒè¿˜å¯ä»¥ç”¨äºé€šè¿‡å®šä½ç‰¹å®šGPUæˆ–åœ¨ä»…CPUæ¨¡å¼ä¸‹è¿›è¡Œæµ‹è¯•æ¥å®ç°ä¸`CUDA_VISIBLE_DEVICES`ç›¸åŒçš„æ•ˆæœã€‚

åœ¨ç¬¬ä¸€æ¬¡å¯¼å…¥`torch`åï¼ŒæŸäº›è®¾å¤‡å°†éœ€è¦é¢å¤–çš„å¯¼å…¥ã€‚è¿™å¯ä»¥ä½¿ç”¨ç¯å¢ƒå˜é‡`TRANSFORMERS_TEST_BACKEND`æŒ‡å®šï¼š

```py
TRANSFORMERS_TEST_BACKEND="torch_npu" pytest tests/utils/test_logging.py
```

æ›¿ä»£åç«¯å¯èƒ½è¿˜éœ€è¦æ›¿æ¢ç‰¹å®šäºè®¾å¤‡çš„å‡½æ•°ã€‚ä¾‹å¦‚ï¼Œ`torch.cuda.manual_seed`å¯èƒ½éœ€è¦æ›¿æ¢ä¸ºç‰¹å®šäºè®¾å¤‡çš„ç§å­è®¾ç½®å™¨ï¼Œå¦‚`torch.npu.manual_seed`ï¼Œä»¥æ­£ç¡®è®¾ç½®è®¾å¤‡ä¸Šçš„éšæœºç§å­ã€‚åœ¨è¿è¡Œæµ‹è¯•å¥—ä»¶æ—¶æŒ‡å®šæ–°çš„åç«¯å’Œåç«¯ç‰¹å®šè®¾å¤‡å‡½æ•°æ—¶ï¼Œåˆ›å»ºä¸€ä¸ªPythonè®¾å¤‡è§„èŒƒæ–‡ä»¶ï¼Œæ ¼å¼å¦‚ä¸‹ï¼š

```py
import torch
import torch_npu
# !! Further additional imports can be added here !!

# Specify the device name (eg. 'cuda', 'cpu', 'npu')
DEVICE_NAME = 'npu'

# Specify device-specific backends to dispatch to.
# If not specified, will fallback to 'default' in 'testing_utils.py`
MANUAL_SEED_FN = torch.npu.manual_seed
EMPTY_CACHE_FN = torch.npu.empty_cache
DEVICE_COUNT_FN = torch.npu.device_count
```

æ­¤æ ¼å¼è¿˜å…è®¸æŒ‡å®šæ‰€éœ€çš„ä»»ä½•å…¶ä»–å¯¼å…¥ã€‚è¦ä½¿ç”¨æ­¤æ–‡ä»¶æ›¿æ¢æµ‹è¯•å¥—ä»¶ä¸­çš„ç­‰æ•ˆæ–¹æ³•ï¼Œè¯·å°†ç¯å¢ƒå˜é‡`TRANSFORMERS_TEST_DEVICE_SPEC`è®¾ç½®ä¸ºè§„èŒƒæ–‡ä»¶çš„è·¯å¾„ã€‚

ç›®å‰ï¼Œåªæ”¯æŒ`MANUAL_SEED_FN`ã€`EMPTY_CACHE_FN`å’Œ`DEVICE_COUNT_FN`ç”¨äºç‰¹å®šè®¾å¤‡çš„åˆ†å‘ã€‚

### åˆ†å¸ƒå¼è®­ç»ƒ

`pytest`ä¸èƒ½ç›´æ¥å¤„ç†åˆ†å¸ƒå¼è®­ç»ƒã€‚å¦‚æœå°è¯•è¿™æ ·åš-å­è¿›ç¨‹ä¸ä¼šåšæ­£ç¡®çš„äº‹æƒ…ï¼Œæœ€ç»ˆä¼šè®¤ä¸ºå®ƒä»¬æ˜¯`pytest`å¹¶å¼€å§‹å¾ªç¯è¿è¡Œæµ‹è¯•å¥—ä»¶ã€‚ä½†æ˜¯ï¼Œå¦‚æœç”Ÿæˆä¸€ä¸ªæ­£å¸¸è¿›ç¨‹ï¼Œç„¶åç”Ÿæˆå¤šä¸ªå·¥ä½œè¿›ç¨‹å¹¶ç®¡ç†IOç®¡é“ï¼Œåˆ™å¯ä»¥æ­£å¸¸å·¥ä½œã€‚

ä»¥ä¸‹æ˜¯ä¸€äº›ä½¿ç”¨å®ƒçš„æµ‹è¯•ï¼š

+   [test_trainer_distributed.py](https://github.com/huggingface/transformers/tree/main/tests/trainer/test_trainer_distributed.py)

+   [test_deepspeed.py](https://github.com/huggingface/transformers/tree/main/tests/deepspeed/test_deepspeed.py)

è¦ç›´æ¥è·³è½¬åˆ°æ‰§è¡Œç‚¹ï¼Œè¯·åœ¨è¿™äº›æµ‹è¯•ä¸­æœç´¢`execute_subprocess_async`è°ƒç”¨ã€‚

æ‚¨è‡³å°‘éœ€è¦2ä¸ªGPUæ‰èƒ½çœ‹åˆ°è¿™äº›æµ‹è¯•çš„è¿è¡Œæƒ…å†µï¼š

```py
CUDA_VISIBLE_DEVICES=0,1 RUN_SLOW=1 pytest -sv tests/test_trainer_distributed.py
```

### è¾“å‡ºæ•è·

åœ¨æµ‹è¯•æ‰§è¡ŒæœŸé—´ï¼Œå‘é€åˆ°`stdout`å’Œ`stderr`çš„ä»»ä½•è¾“å‡ºéƒ½å°†è¢«æ•è·ã€‚å¦‚æœæµ‹è¯•æˆ–è®¾ç½®æ–¹æ³•å¤±è´¥ï¼Œåˆ™é€šå¸¸ä¼šæ˜¾ç¤ºå…¶ç›¸åº”çš„æ•è·è¾“å‡ºä»¥åŠå¤±è´¥çš„å›æº¯ã€‚

è¦ç¦ç”¨è¾“å‡ºæ•è·å¹¶æ­£å¸¸è·å–`stdout`å’Œ`stderr`ï¼Œè¯·ä½¿ç”¨`-s`æˆ–`--capture=no`ï¼š

```py
pytest -s tests/utils/test_logging.py
```

å°†æµ‹è¯•ç»“æœå‘é€åˆ°JUnitæ ¼å¼çš„è¾“å‡ºï¼š

```py
py.test tests --junitxml=result.xml
```

### é¢œè‰²æ§åˆ¶

è¦æ²¡æœ‰é¢œè‰²ï¼ˆä¾‹å¦‚ï¼Œç™½è‰²èƒŒæ™¯ä¸Šçš„é»„è‰²ä¸å¯è¯»ï¼‰ï¼š

```py
pytest --color=no tests/utils/test_logging.py
```

### å°†æµ‹è¯•æŠ¥å‘Šå‘é€åˆ°åœ¨çº¿ç²˜è´´æœåŠ¡

ä¸ºæ¯ä¸ªæµ‹è¯•å¤±è´¥åˆ›å»ºä¸€ä¸ªURLï¼š

```py
pytest --pastebin=failed tests/utils/test_logging.py
```

è¿™å°†å‘è¿œç¨‹ç²˜è´´æœåŠ¡æäº¤æµ‹è¯•è¿è¡Œä¿¡æ¯ï¼Œå¹¶ä¸ºæ¯ä¸ªå¤±è´¥æä¾›ä¸€ä¸ªURLã€‚æ‚¨å¯ä»¥åƒå¾€å¸¸ä¸€æ ·é€‰æ‹©æµ‹è¯•ï¼Œæˆ–è€…ä¾‹å¦‚æ·»åŠ `-x`ï¼Œå¦‚æœæ‚¨åªæƒ³å‘é€ä¸€ä¸ªç‰¹å®šçš„å¤±è´¥ã€‚

ä¸ºæ•´ä¸ªæµ‹è¯•ä¼šè¯æ—¥å¿—åˆ›å»ºä¸€ä¸ªURLï¼š

```py
pytest --pastebin=all tests/utils/test_logging.py
```

## ç¼–å†™æµ‹è¯•

ğŸ¤— transformersæµ‹è¯•åŸºäº`unittest`ï¼Œä½†ç”±`pytest`è¿è¡Œï¼Œå› æ­¤å¤§å¤šæ•°æƒ…å†µä¸‹å¯ä»¥ä½¿ç”¨ä¸¤ä¸ªç³»ç»Ÿçš„åŠŸèƒ½ã€‚

æ‚¨å¯ä»¥åœ¨[è¿™é‡Œ](https://docs.pytest.org/en/stable/unittest.html)é˜…è¯»æ”¯æŒçš„åŠŸèƒ½ï¼Œä½†è¦è®°ä½çš„é‡è¦äº‹æƒ…æ˜¯å¤§å¤šæ•°`pytest`å›ºå®šè£…ç½®ä¸èµ·ä½œç”¨ã€‚ä¹Ÿä¸æ˜¯å‚æ•°åŒ–ï¼Œä½†æˆ‘ä»¬ä½¿ç”¨æ¨¡å—`parameterized`ä»¥ç±»ä¼¼çš„æ–¹å¼å·¥ä½œã€‚

### å‚æ•°åŒ–

ç»å¸¸éœ€è¦å¤šæ¬¡è¿è¡Œç›¸åŒçš„æµ‹è¯•ï¼Œä½†ä½¿ç”¨ä¸åŒçš„å‚æ•°ã€‚å¯ä»¥ä»æµ‹è¯•å†…éƒ¨å®Œæˆï¼Œä½†æ˜¯é‚£æ ·å°±æ— æ³•ä»…ä¸ºä¸€ä¸ªå‚æ•°é›†è¿è¡Œè¯¥æµ‹è¯•ã€‚

```py
# test_this1.py
import unittest
from parameterized import parameterized

class TestMathUnitTest(unittest.TestCase):
 @parameterized.expand( [
            ("negative", -1.5, -2.0),
            ("integer", 1, 1.0),
            ("large fraction", 1.6, 1),
        ] )
    def test_floor(self, name, input, expected):
        assert_equal(math.floor(input), expected)
```

ç°åœ¨ï¼Œé»˜è®¤æƒ…å†µä¸‹ï¼Œæ­¤æµ‹è¯•å°†è¿è¡Œ3æ¬¡ï¼Œæ¯æ¬¡å°†`test_floor`çš„æœ€å3ä¸ªå‚æ•°åˆ†é…ç»™å‚æ•°åˆ—è¡¨ä¸­çš„ç›¸åº”å‚æ•°ã€‚

æ‚¨å¯ä»¥ä»…è¿è¡Œ`negative`å’Œ`integer`å‚æ•°é›†ï¼š

```py
pytest -k "negative and integer" tests/test_mytest.py
```

æˆ–é™¤äº†`negative`å­æµ‹è¯•å¤–çš„æ‰€æœ‰å­æµ‹è¯•ï¼Œä½¿ç”¨ï¼š

```py
pytest -k "not negative" tests/test_mytest.py
```

é™¤äº†ä½¿ç”¨åˆšæåˆ°çš„`-k`è¿‡æ»¤å™¨ï¼Œæ‚¨å¯ä»¥æ‰¾å‡ºæ¯ä¸ªå­æµ‹è¯•çš„ç¡®åˆ‡åç§°ï¼Œå¹¶ä½¿ç”¨å…¶ç¡®åˆ‡åç§°è¿è¡Œä»»ä½•æˆ–æ‰€æœ‰å­æµ‹è¯•ã€‚

```py
pytest test_this1.py --collect-only -q
```

å®ƒå°†åˆ—å‡ºï¼š

```py
test_this1.py::TestMathUnitTest::test_floor_0_negative
test_this1.py::TestMathUnitTest::test_floor_1_integer
test_this1.py::TestMathUnitTest::test_floor_2_large_fraction
```

ç°åœ¨æ‚¨å¯ä»¥ä»…è¿è¡Œ2ä¸ªç‰¹å®šçš„å­æµ‹è¯•ï¼š

```py
pytest test_this1.py::TestMathUnitTest::test_floor_0_negative  test_this1.py::TestMathUnitTest::test_floor_1_integer
```

æ¨¡å—[parameterized](https://pypi.org/project/parameterized/)å·²ç»æ˜¯`transformers`çš„å¼€å‘ä¾èµ–é¡¹ï¼Œé€‚ç”¨äº`unittests`å’Œ`pytest`æµ‹è¯•ã€‚

ä½†æ˜¯ï¼Œå¦‚æœæµ‹è¯•ä¸æ˜¯`unittest`ï¼Œåˆ™å¯ä»¥ä½¿ç”¨`pytest.mark.parametrize`ï¼ˆæˆ–è€…æ‚¨å¯èƒ½ä¼šçœ‹åˆ°å®ƒåœ¨ä¸€äº›ç°æœ‰æµ‹è¯•ä¸­ä½¿ç”¨ï¼Œä¸»è¦åœ¨`examples`ä¸‹ï¼‰ã€‚

ä»¥ä¸‹æ˜¯ç›¸åŒçš„ç¤ºä¾‹ï¼Œè¿™æ¬¡ä½¿ç”¨`pytest`çš„`parametrize`æ ‡è®°ï¼š

```py
# test_this2.py
import pytest

@pytest.mark.parametrize( "name, input, expected",
    [
        ("negative", -1.5, -2.0),
        ("integer", 1, 1.0),
        ("large fraction", 1.6, 1),
    ], )
def test_floor(name, input, expected):
    assert_equal(math.floor(input), expected)
```

ä¸`parameterized`ä¸€æ ·ï¼Œä½¿ç”¨`pytest.mark.parametrize`å¯ä»¥å¯¹è¦è¿è¡Œçš„å­æµ‹è¯•è¿›è¡Œç²¾ç»†æ§åˆ¶ï¼Œå¦‚æœ`-k`è¿‡æ»¤å™¨æ— æ³•å®Œæˆä»»åŠ¡ã€‚é™¤æ­¤ä¹‹å¤–ï¼Œæ­¤å‚æ•°åŒ–å‡½æ•°ä¸ºå­æµ‹è¯•åˆ›å»ºäº†ä¸€ç»„ç•¥æœ‰ä¸åŒçš„åç§°ã€‚ä»¥ä¸‹æ˜¯å®ƒä»¬çš„æ ·å­ï¼š

```py
pytest test_this2.py --collect-only -q
```

å®ƒå°†åˆ—å‡ºï¼š

```py
test_this2.py::test_floor[integer-1-1.0]
test_this2.py::test_floor[negative--1.5--2.0]
test_this2.py::test_floor[large fraction-1.6-1]
```

ç°åœ¨æ‚¨å¯ä»¥ä»…è¿è¡Œç‰¹å®šçš„æµ‹è¯•ï¼š

```py
pytest test_this2.py::test_floor[negative--1.5--2.0] test_this2.py::test_floor[integer-1-1.0]
```

ä¸å‰é¢çš„ç¤ºä¾‹ç›¸åŒã€‚

### æ–‡ä»¶å’Œç›®å½•

åœ¨æµ‹è¯•ä¸­ï¼Œæˆ‘ä»¬ç»å¸¸éœ€è¦çŸ¥é“äº‹ç‰©ç›¸å¯¹äºå½“å‰æµ‹è¯•æ–‡ä»¶çš„ä½ç½®ï¼Œè¿™å¹¶ä¸æ˜¯å¾®ä¸è¶³é“çš„ï¼Œå› ä¸ºæµ‹è¯•å¯èƒ½ä¼šä»å¤šä¸ªç›®å½•è°ƒç”¨ï¼Œæˆ–è€…å¯èƒ½ä½äºå…·æœ‰ä¸åŒæ·±åº¦çš„å­ç›®å½•ä¸­ã€‚ä¸€ä¸ªè¾…åŠ©ç±»`transformers.test_utils.TestCasePlus`é€šè¿‡æ•´ç†æ‰€æœ‰åŸºæœ¬è·¯å¾„å¹¶æä¾›æ˜“äºè®¿é—®çš„è®¿é—®å™¨æ¥è§£å†³è¿™ä¸ªé—®é¢˜ï¼š

+   `pathlib`å¯¹è±¡ï¼ˆå…¨éƒ¨å®Œå…¨è§£æï¼‰ï¼š

    +   `test_file_path` - å½“å‰æµ‹è¯•æ–‡ä»¶è·¯å¾„ï¼Œå³`__file__`

    +   `test_file_dir` - åŒ…å«å½“å‰æµ‹è¯•æ–‡ä»¶çš„ç›®å½•

    +   `tests_dir` - `tests`æµ‹è¯•å¥—ä»¶çš„ç›®å½•

    +   `examples_dir` - `examples`æµ‹è¯•å¥—ä»¶çš„ç›®å½•

    +   `repo_root_dir` - ä»“åº“çš„ç›®å½•

    +   `src_dir` - `src`çš„ç›®å½•ï¼ˆå³`transformers`å­ç›®å½•æ‰€åœ¨çš„åœ°æ–¹ï¼‰

+   å­—ç¬¦ä¸²åŒ–è·¯å¾„---ä¸ä¸Šè¿°ç›¸åŒï¼Œä½†è¿™äº›è¿”å›è·¯å¾„ä½œä¸ºå­—ç¬¦ä¸²ï¼Œè€Œä¸æ˜¯`pathlib`å¯¹è±¡ï¼š

    +   `test_file_path_str`

    +   `test_file_dir_str`

    +   `tests_dir_str`

    +   `examples_dir_str`

    +   `repo_root_dir_str`

    +   `src_dir_str`

è¦å¼€å§‹ä½¿ç”¨è¿™äº›ï¼Œæ‚¨åªéœ€è¦ç¡®ä¿æµ‹è¯•ä½äº`transformers.test_utils.TestCasePlus`çš„å­ç±»ä¸­ã€‚ä¾‹å¦‚ï¼š

```py
from transformers.testing_utils import TestCasePlus

class PathExampleTest(TestCasePlus):
    def test_something_involving_local_locations(self):
        data_dir = self.tests_dir / "fixtures/tests_samples/wmt_en_ro"
```

å¦‚æœæ‚¨ä¸éœ€è¦é€šè¿‡`pathlib`æ“çºµè·¯å¾„ï¼Œæˆ–è€…åªéœ€è¦è·¯å¾„ä½œä¸ºå­—ç¬¦ä¸²ï¼Œæ‚¨å¯ä»¥å§‹ç»ˆåœ¨`pathlib`å¯¹è±¡ä¸Šè°ƒç”¨`str()`æˆ–ä½¿ç”¨ä»¥`_str`ç»“å°¾çš„è®¿é—®å™¨ã€‚ä¾‹å¦‚ï¼š

```py
from transformers.testing_utils import TestCasePlus

class PathExampleTest(TestCasePlus):
    def test_something_involving_stringified_locations(self):
        examples_dir = self.examples_dir_str
```

### ä¸´æ—¶æ–‡ä»¶å’Œç›®å½•

ä½¿ç”¨å”¯ä¸€çš„ä¸´æ—¶æ–‡ä»¶å’Œç›®å½•å¯¹äºå¹¶è¡Œæµ‹è¯•è¿è¡Œè‡³å…³é‡è¦ï¼Œä»¥ä¾¿æµ‹è¯•ä¸ä¼šè¦†ç›–å½¼æ­¤çš„æ•°æ®ã€‚æ­¤å¤–ï¼Œæˆ‘ä»¬å¸Œæœ›åœ¨æ¯ä¸ªåˆ›å»ºå®ƒä»¬çš„æµ‹è¯•ç»“æŸæ—¶åˆ é™¤ä¸´æ—¶æ–‡ä»¶å’Œç›®å½•ã€‚å› æ­¤ï¼Œä½¿ç”¨åƒ`tempfile`è¿™æ ·æ»¡è¶³è¿™äº›éœ€æ±‚çš„è½¯ä»¶åŒ…æ˜¯è‡³å…³é‡è¦çš„ã€‚

ç„¶è€Œï¼Œåœ¨è°ƒè¯•æµ‹è¯•æ—¶ï¼Œæ‚¨éœ€è¦èƒ½å¤Ÿçœ‹åˆ°ä¸´æ—¶æ–‡ä»¶æˆ–ç›®å½•ä¸­çš„å†…å®¹ï¼Œå¹¶ä¸”å¸Œæœ›çŸ¥é“å…¶ç¡®åˆ‡è·¯å¾„ï¼Œè€Œä¸æ˜¯åœ¨æ¯æ¬¡æµ‹è¯•é‡æ–°è¿è¡Œæ—¶éšæœºåŒ–ã€‚

è¾…åŠ©ç±»`transformers.test_utils.TestCasePlus`æœ€é€‚åˆç”¨äºè¿™äº›ç›®çš„ã€‚å®ƒæ˜¯`unittest.TestCase`çš„å­ç±»ï¼Œå› æ­¤æˆ‘ä»¬å¯ä»¥åœ¨æµ‹è¯•æ¨¡å—ä¸­è½»æ¾ç»§æ‰¿å®ƒã€‚

ä»¥ä¸‹æ˜¯å…¶ç”¨æ³•ç¤ºä¾‹ï¼š

```py
from transformers.testing_utils import TestCasePlus

class ExamplesTests(TestCasePlus):
    def test_whatever(self):
        tmp_dir = self.get_auto_remove_tmp_dir()
```

æ­¤ä»£ç åˆ›å»ºä¸€ä¸ªå”¯ä¸€çš„ä¸´æ—¶ç›®å½•ï¼Œå¹¶å°†`tmp_dir`è®¾ç½®ä¸ºå…¶ä½ç½®ã€‚

+   åˆ›å»ºä¸€ä¸ªå”¯ä¸€çš„ä¸´æ—¶ç›®å½•ï¼š

```py
def test_whatever(self):
    tmp_dir = self.get_auto_remove_tmp_dir()
```

`tmp_dir`å°†åŒ…å«åˆ›å»ºçš„ä¸´æ—¶ç›®å½•çš„è·¯å¾„ã€‚å®ƒå°†åœ¨æµ‹è¯•ç»“æŸæ—¶è‡ªåŠ¨åˆ é™¤ã€‚

+   åˆ›å»ºæˆ‘é€‰æ‹©çš„ä¸´æ—¶ç›®å½•ï¼Œåœ¨æµ‹è¯•å¼€å§‹ä¹‹å‰ç¡®ä¿å®ƒä¸ºç©ºï¼Œå¹¶åœ¨æµ‹è¯•ç»“æŸåä¸æ¸…ç©ºå®ƒã€‚

```py
def test_whatever(self):
    tmp_dir = self.get_auto_remove_tmp_dir("./xxx")
```

å½“æ‚¨æƒ³è¦ç›‘è§†ç‰¹å®šç›®å½•å¹¶ç¡®ä¿ä¹‹å‰çš„æµ‹è¯•æ²¡æœ‰åœ¨å…¶ä¸­ç•™ä¸‹ä»»ä½•æ•°æ®æ—¶ï¼Œè¿™å¾ˆæœ‰ç”¨ã€‚

+   æ‚¨å¯ä»¥é€šè¿‡ç›´æ¥è¦†ç›–`before`å’Œ`after`å‚æ•°æ¥è¦†ç›–é»˜è®¤è¡Œä¸ºï¼Œä»è€Œå¯¼è‡´ä»¥ä¸‹è¡Œä¸ºä¹‹ä¸€ï¼š

    +   `before=True`ï¼šä¸´æ—¶ç›®å½•å°†å§‹ç»ˆåœ¨æµ‹è¯•å¼€å§‹æ—¶æ¸…é™¤ã€‚

    +   `before=False`ï¼šå¦‚æœä¸´æ—¶ç›®å½•å·²ç»å­˜åœ¨ï¼Œåˆ™ä»»ä½•ç°æœ‰æ–‡ä»¶å°†ä¿ç•™åœ¨é‚£é‡Œã€‚

    +   `after=True`ï¼šä¸´æ—¶ç›®å½•å°†å§‹ç»ˆåœ¨æµ‹è¯•ç»“æŸæ—¶è¢«åˆ é™¤ã€‚

    +   `after=False`ï¼šä¸´æ—¶ç›®å½•å°†å§‹ç»ˆåœ¨æµ‹è¯•ç»“æŸæ—¶ä¿æŒä¸å˜ã€‚

ä¸ºäº†å®‰å…¨è¿è¡Œç­‰æ•ˆäº`rm -r`çš„æ“ä½œï¼Œåªå…è®¸é¡¹ç›®å­˜å‚¨åº“æ£€å‡ºçš„å­ç›®å½•ï¼Œå¦‚æœä½¿ç”¨äº†æ˜¾å¼çš„`tmp_dir`ï¼Œåˆ™ä¸ä¼šé”™è¯¯åœ°åˆ é™¤ä»»ä½•`/tmp`æˆ–ç±»ä¼¼çš„æ–‡ä»¶ç³»ç»Ÿé‡è¦éƒ¨åˆ†ã€‚å³è¯·å§‹ç»ˆä¼ é€’ä»¥`./`å¼€å¤´çš„è·¯å¾„ã€‚

æ¯ä¸ªæµ‹è¯•å¯ä»¥æ³¨å†Œå¤šä¸ªä¸´æ—¶ç›®å½•ï¼Œå®ƒä»¬éƒ½å°†è‡ªåŠ¨åˆ é™¤ï¼Œé™¤éå¦æœ‰è¦æ±‚ã€‚

### ä¸´æ—¶sys.pathè¦†ç›–

å¦‚æœéœ€è¦ä¸´æ—¶è¦†ç›–`sys.path`ä»¥ä»å¦ä¸€ä¸ªæµ‹è¯•ä¸­å¯¼å…¥ï¼Œä¾‹å¦‚ï¼Œå¯ä»¥ä½¿ç”¨`ExtendSysPath`ä¸Šä¸‹æ–‡ç®¡ç†å™¨ã€‚ç¤ºä¾‹ï¼š

```py
import os
from transformers.testing_utils import ExtendSysPath

bindir = os.path.abspath(os.path.dirname(__file__))
with ExtendSysPath(f"{bindir}/.."):
    from test_trainer import TrainerIntegrationCommon  # noqa
```

### è·³è¿‡æµ‹è¯•

å½“å‘ç°é”™è¯¯å¹¶ç¼–å†™æ–°æµ‹è¯•ä½†å°šæœªä¿®å¤é”™è¯¯æ—¶ï¼Œè¿™å¾ˆæœ‰ç”¨ã€‚ä¸ºäº†èƒ½å¤Ÿå°†å…¶æäº¤åˆ°ä¸»å­˜å‚¨åº“ï¼Œæˆ‘ä»¬éœ€è¦ç¡®ä¿åœ¨`make test`æœŸé—´è·³è¿‡å®ƒã€‚

æ–¹æ³•ï¼š

+   **skip**è¡¨ç¤ºæ‚¨æœŸæœ›æµ‹è¯•ä»…åœ¨æ»¡è¶³æŸäº›æ¡ä»¶æ—¶æ‰é€šè¿‡ï¼Œå¦åˆ™pyteståº”è¯¥è·³è¿‡è¿è¡Œæµ‹è¯•ã€‚å¸¸è§ç¤ºä¾‹æ˜¯åœ¨éWindowså¹³å°ä¸Šè·³è¿‡ä»…é€‚ç”¨äºWindowsçš„æµ‹è¯•ï¼Œæˆ–è€…è·³è¿‡ä¾èµ–äºå½“å‰ä¸å¯ç”¨çš„å¤–éƒ¨èµ„æºçš„æµ‹è¯•ï¼ˆä¾‹å¦‚æ•°æ®åº“ï¼‰ã€‚

+   **xfail**è¡¨ç¤ºæ‚¨æœŸæœ›ç”±äºæŸç§åŸå› æµ‹è¯•å¤±è´¥ã€‚ä¸€ä¸ªå¸¸è§ç¤ºä¾‹æ˜¯æµ‹è¯•å°šæœªå®ç°çš„åŠŸèƒ½ï¼Œæˆ–è€…å°šæœªä¿®å¤çš„é”™è¯¯ã€‚å½“ä¸€ä¸ªæµ‹è¯•å°½ç®¡é¢„æœŸå¤±è´¥ï¼ˆæ ‡è®°ä¸ºpytest.mark.xfailï¼‰ä»ç„¶é€šè¿‡æ—¶ï¼Œå®ƒæ˜¯ä¸€ä¸ªxpassï¼Œå¹¶å°†åœ¨æµ‹è¯•æ‘˜è¦ä¸­æŠ¥å‘Šã€‚

ä¸¤è€…ä¹‹é—´çš„ä¸€ä¸ªé‡è¦åŒºåˆ«æ˜¯ï¼Œ`skip`ä¸è¿è¡Œæµ‹è¯•ï¼Œè€Œ`xfail`ä¼šè¿è¡Œã€‚å› æ­¤ï¼Œå¦‚æœå¯¼è‡´ä¸€äº›ç³Ÿç³•çŠ¶æ€çš„æœ‰ç¼ºé™·ä»£ç ä¼šå½±å“å…¶ä»–æµ‹è¯•ï¼Œè¯·ä¸è¦ä½¿ç”¨`xfail`ã€‚

#### å®æ–½

+   ä»¥ä¸‹æ˜¯å¦‚ä½•æ— æ¡ä»¶è·³è¿‡æ•´ä¸ªæµ‹è¯•ï¼š

```py
@unittest.skip("this bug needs to be fixed")
def test_feature_x():
```

æˆ–é€šè¿‡pytestï¼š

```py
@pytest.mark.skip(reason="this bug needs to be fixed")
```

æˆ–`xfail`æ–¹å¼ï¼š

```py
@pytest.mark.xfail
def test_feature_x():
```

ä»¥ä¸‹æ˜¯å¦‚ä½•æ ¹æ®æµ‹è¯•å†…éƒ¨æ£€æŸ¥è·³è¿‡æµ‹è¯•çš„æ–¹æ³•ï¼š

```py
def test_feature_x():
    if not has_something():
        pytest.skip("unsupported configuration")
```

æˆ–æ•´ä¸ªæ¨¡å—ï¼š

```py
import pytest

if not pytest.config.getoption("--custom-flag"):
    pytest.skip("--custom-flag is missing, skipping tests", allow_module_level=True)
```

æˆ–`xfail`æ–¹å¼ï¼š

```py
def test_feature_x():
    pytest.xfail("expected to fail until bug XYZ is fixed")
```

+   ä»¥ä¸‹æ˜¯å¦‚ä½•è·³è¿‡æ¨¡å—ä¸­çš„æ‰€æœ‰æµ‹è¯•ï¼Œå¦‚æœæŸä¸ªå¯¼å…¥ä¸¢å¤±ï¼š

```py
docutils = pytest.importorskip("docutils", minversion="0.3")
```

+   æ ¹æ®æ¡ä»¶è·³è¿‡æµ‹è¯•ï¼š

```py
@pytest.mark.skipif(sys.version_info < (3,6), reason="requires python3.6 or higher")
def test_feature_x():
```

æˆ–ï¼š

```py
@unittest.skipIf(torch_device == "cpu", "Can't do half precision")
def test_feature_x():
```

æˆ–è·³è¿‡æ•´ä¸ªæ¨¡å—ï¼š

```py
@pytest.mark.skipif(sys.platform == 'win32', reason="does not run on windows")
class TestClass():
    def test_feature_x(self):
```

æ›´å¤šè¯¦ç»†ä¿¡æ¯ã€ç¤ºä¾‹å’Œæ–¹æ³•è¯·å‚è§[è¿™é‡Œ](https://docs.pytest.org/en/latest/skipping.html)ã€‚

### æ…¢é€Ÿæµ‹è¯•

æµ‹è¯•åº“ä¸æ–­å¢é•¿ï¼Œä¸€äº›æµ‹è¯•éœ€è¦å‡ åˆ†é’Ÿæ‰èƒ½è¿è¡Œï¼Œå› æ­¤æˆ‘ä»¬æ— æ³•ç­‰å¾…ä¸€ä¸ªå°æ—¶æ‰èƒ½å®ŒæˆCIçš„æµ‹è¯•å¥—ä»¶ã€‚å› æ­¤ï¼Œé™¤äº†ä¸€äº›å¿…è¦æµ‹è¯•çš„ä¾‹å¤–ï¼Œæ…¢é€Ÿæµ‹è¯•åº”è¯¥æ ‡è®°ä¸ºä¸‹é¢çš„ç¤ºä¾‹ï¼š

```py
from transformers.testing_utils import slow
@slow
def test_integration_foo():
```

ä¸€æ—¦å°†æµ‹è¯•æ ‡è®°ä¸º`@slow`ï¼Œè¦è¿è¡Œè¿™äº›æµ‹è¯•ï¼Œè¯·è®¾ç½®`RUN_SLOW=1`ç¯å¢ƒå˜é‡ï¼Œä¾‹å¦‚ï¼š

```py
RUN_SLOW=1 pytest tests
```

ä¸€äº›è£…é¥°å™¨å¦‚`@parameterized`ä¼šé‡å†™æµ‹è¯•åç§°ï¼Œå› æ­¤`@slow`å’Œå…¶ä»–è·³è¿‡è£…é¥°å™¨`@require_*`å¿…é¡»åœ¨æœ€ååˆ—å‡ºæ‰èƒ½æ­£å¸¸å·¥ä½œã€‚ä»¥ä¸‹æ˜¯æ­£ç¡®ä½¿ç”¨çš„ç¤ºä¾‹ï¼š

```py
@parameteriz ed.expand(...)
@slow
def test_integration_foo():
```

æ­£å¦‚æœ¬æ–‡æ¡£å¼€å¤´æ‰€è§£é‡Šçš„ï¼Œæ…¢é€Ÿæµ‹è¯•ä¼šå®šæœŸè¿è¡Œï¼Œè€Œä¸æ˜¯åœ¨PRçš„CIæ£€æŸ¥ä¸­è¿è¡Œã€‚å› æ­¤ï¼Œå¯èƒ½ä¼šåœ¨æäº¤PRæ—¶é”™è¿‡ä¸€äº›é—®é¢˜å¹¶åˆå¹¶ã€‚è¿™äº›é—®é¢˜å°†åœ¨ä¸‹ä¸€ä¸ªå®šæœŸCIä½œä¸šä¸­è¢«æ•è·ã€‚ä½†è¿™ä¹Ÿæ„å‘³ç€åœ¨æäº¤PRä¹‹å‰åœ¨æ‚¨çš„è®¡ç®—æœºä¸Šè¿è¡Œæ…¢é€Ÿæµ‹è¯•éå¸¸é‡è¦ã€‚

ä»¥ä¸‹æ˜¯é€‰æ‹©å“ªäº›æµ‹è¯•åº”æ ‡è®°ä¸ºæ…¢é€Ÿçš„å¤§è‡´å†³ç­–æœºåˆ¶ï¼š

å¦‚æœæµ‹è¯•ä¾§é‡äºåº“çš„å†…éƒ¨ç»„ä»¶ï¼ˆä¾‹å¦‚ï¼Œå»ºæ¨¡æ–‡ä»¶ã€æ ‡è®°æ–‡ä»¶ã€æµæ°´çº¿ï¼‰ï¼Œé‚£ä¹ˆæˆ‘ä»¬åº”è¯¥åœ¨éæ…¢é€Ÿæµ‹è¯•å¥—ä»¶ä¸­è¿è¡Œè¯¥æµ‹è¯•ã€‚å¦‚æœä¾§é‡äºåº“çš„å…¶ä»–æ–¹é¢ï¼Œä¾‹å¦‚æ–‡æ¡£æˆ–ç¤ºä¾‹ï¼Œåˆ™åº”åœ¨æ…¢é€Ÿæµ‹è¯•å¥—ä»¶ä¸­è¿è¡Œè¿™äº›æµ‹è¯•ã€‚ç„¶åï¼Œä¸ºäº†å®Œå–„è¿™ç§æ–¹æ³•ï¼Œæˆ‘ä»¬åº”è¯¥æœ‰ä¾‹å¤–æƒ…å†µï¼š

+   æ‰€æœ‰éœ€è¦ä¸‹è½½ä¸€ç»„å¤§é‡æƒé‡æˆ–å¤§äº~50MBçš„æ•°æ®é›†ï¼ˆä¾‹å¦‚ï¼Œæ¨¡å‹æˆ–åˆ†è¯å™¨é›†æˆæµ‹è¯•ï¼Œç®¡é“é›†æˆæµ‹è¯•ï¼‰çš„æµ‹è¯•éƒ½åº”è¯¥è®¾ç½®ä¸ºæ…¢é€Ÿã€‚å¦‚æœè¦æ·»åŠ æ–°æ¨¡å‹ï¼Œåº”è¯¥åˆ›å»ºå¹¶ä¸Šä¼ åˆ°hubä¸€ä¸ªå…¶å¾®å‹ç‰ˆæœ¬ï¼ˆå…·æœ‰éšæœºæƒé‡ï¼‰ç”¨äºé›†æˆæµ‹è¯•ã€‚è¿™å°†åœ¨ä»¥ä¸‹æ®µè½ä¸­è®¨è®ºã€‚

+   æ‰€æœ‰éœ€è¦è¿›è¡Œè®­ç»ƒä½†æ²¡æœ‰ä¸“é—¨ä¼˜åŒ–ä¸ºå¿«é€Ÿçš„æµ‹è¯•éƒ½åº”è¯¥è®¾ç½®ä¸ºæ…¢é€Ÿã€‚

+   å¦‚æœå…¶ä¸­ä¸€äº›åº”è¯¥æ˜¯éæ…¢é€Ÿæµ‹è¯•çš„æµ‹è¯•éå¸¸æ…¢ï¼Œå¯ä»¥å¼•å…¥å¼‚å¸¸ï¼Œå¹¶å°†å®ƒä»¬è®¾ç½®ä¸º`@slow`ã€‚è‡ªåŠ¨å»ºæ¨¡æµ‹è¯•ï¼Œå°†å¤§æ–‡ä»¶ä¿å­˜å’ŒåŠ è½½åˆ°ç£ç›˜ä¸Šï¼Œæ˜¯ä¸€ä¸ªè¢«æ ‡è®°ä¸º`@slow`çš„æµ‹è¯•çš„å¾ˆå¥½çš„ä¾‹å­ã€‚

+   å¦‚æœä¸€ä¸ªæµ‹è¯•åœ¨CIä¸Šå®Œæˆæ—¶é—´ä¸åˆ°1ç§’ï¼ˆåŒ…æ‹¬ä¸‹è½½ï¼‰ï¼Œé‚£ä¹ˆå®ƒåº”è¯¥æ˜¯ä¸€ä¸ªæ­£å¸¸çš„æµ‹è¯•ã€‚

æ€»çš„æ¥è¯´ï¼Œæ‰€æœ‰éæ…¢é€Ÿæµ‹è¯•éƒ½éœ€è¦å®Œå…¨è¦†ç›–ä¸åŒçš„å†…éƒ¨åŠŸèƒ½ï¼ŒåŒæ—¶ä¿æŒå¿«é€Ÿã€‚ä¾‹å¦‚ï¼Œé€šè¿‡ä½¿ç”¨å…·æœ‰éšæœºæƒé‡çš„ç‰¹åˆ«åˆ›å»ºçš„å¾®å‹æ¨¡å‹è¿›è¡Œæµ‹è¯•ï¼Œå¯ä»¥å®ç°æ˜¾è‘—çš„è¦†ç›–èŒƒå›´ã€‚è¿™äº›æ¨¡å‹å…·æœ‰æœ€å°æ•°é‡çš„å±‚ï¼ˆä¾‹å¦‚2ï¼‰ï¼Œè¯æ±‡é‡ï¼ˆä¾‹å¦‚1000ï¼‰ç­‰ã€‚ç„¶å`@slow`æµ‹è¯•å¯ä»¥ä½¿ç”¨å¤§å‹æ…¢é€Ÿæ¨¡å‹è¿›è¡Œå®šæ€§æµ‹è¯•ã€‚è¦æŸ¥çœ‹è¿™äº›çš„ç”¨æ³•ï¼Œåªéœ€æœç´¢å¸¦æœ‰*tiny*çš„æ¨¡å‹ï¼š

```py
grep tiny tests examples
```

è¿™é‡Œæ˜¯ä¸€ä¸ª[è„šæœ¬](https://github.com/huggingface/transformers/tree/main/scripts/fsmt/fsmt-make-tiny-model.py)çš„ç¤ºä¾‹ï¼Œåˆ›å»ºäº†å¾®å‹æ¨¡å‹[stas/tiny-wmt19-en-de](https://huggingface.co/stas/tiny-wmt19-en-de)ã€‚æ‚¨å¯ä»¥è½»æ¾è°ƒæ•´å®ƒä»¥é€‚åº”æ‚¨ç‰¹å®šæ¨¡å‹çš„æ¶æ„ã€‚

å¦‚æœä¾‹å¦‚ä¸‹è½½ä¸€ä¸ªå·¨å¤§æ¨¡å‹çš„å¼€é”€å¾ˆå¤§ï¼Œé‚£ä¹ˆå¾ˆå®¹æ˜“é”™è¯¯åœ°æµ‹é‡è¿è¡Œæ—¶é—´ï¼Œä½†å¦‚æœæ‚¨åœ¨æœ¬åœ°æµ‹è¯•å®ƒï¼Œä¸‹è½½çš„æ–‡ä»¶å°†è¢«ç¼“å­˜ï¼Œå› æ­¤ä¸‹è½½æ—¶é—´ä¸ä¼šè¢«æµ‹é‡ã€‚å› æ­¤ï¼Œåº”è¯¥æŸ¥çœ‹CIæ—¥å¿—ä¸­çš„æ‰§è¡Œé€Ÿåº¦æŠ¥å‘Šï¼ˆ`pytest --durations=0 tests`çš„è¾“å‡ºï¼‰ã€‚

è¯¥æŠ¥å‘Šè¿˜æœ‰åŠ©äºæ‰¾åˆ°æœªæ ‡è®°ä¸ºæ…¢çš„æ…¢å¼‚å¸¸å€¼ï¼Œæˆ–è€…éœ€è¦é‡æ–°ç¼–å†™ä»¥æé«˜é€Ÿåº¦çš„æµ‹è¯•ã€‚å¦‚æœæ‚¨æ³¨æ„åˆ°CIä¸Šçš„æµ‹è¯•å¥—ä»¶å¼€å§‹å˜æ…¢ï¼Œæ­¤æŠ¥å‘Šçš„é¡¶éƒ¨åˆ—è¡¨å°†æ˜¾ç¤ºæœ€æ…¢çš„æµ‹è¯•ã€‚

### æµ‹è¯•stdout/stderrè¾“å‡º

ä¸ºäº†æµ‹è¯•å†™å…¥`stdout`å’Œ/æˆ–`stderr`çš„å‡½æ•°ï¼Œæµ‹è¯•å¯ä»¥ä½¿ç”¨`pytest`çš„[capsysç³»ç»Ÿ](https://docs.pytest.org/en/latest/capture.html)æ¥è®¿é—®è¿™äº›æµã€‚ä»¥ä¸‹æ˜¯å®ç°è¿™ä¸€ç›®æ ‡çš„æ–¹æ³•ï¼š

```py
import sys

def print_to_stdout(s):
    print(s)

def print_to_stderr(s):
    sys.stderr.write(s)

def test_result_and_stdout(capsys):
    msg = "Hello"
    print_to_stdout(msg)
    print_to_stderr(msg)
    out, err = capsys.readouterr()  # consume the captured output streams
    # optional: if you want to replay the consumed streams:
    sys.stdout.write(out)
    sys.stderr.write(err)
    # test:
    assert msg in out
    assert msg in err
```

å½“ç„¶ï¼Œå¤§å¤šæ•°æƒ…å†µä¸‹ï¼Œ`stderr`å°†ä½œä¸ºå¼‚å¸¸çš„ä¸€éƒ¨åˆ†å‡ºç°ï¼Œå› æ­¤åœ¨è¿™ç§æƒ…å†µä¸‹å¿…é¡»ä½¿ç”¨try/exceptï¼š

```py
def raise_exception(msg):
    raise ValueError(msg)

def test_something_exception():
    msg = "Not a good value"
    error = ""
    try:
        raise_exception(msg)
    except Exception as e:
        error = str(e)
        assert msg in error, f"{msg} is in the exception:\n{error}"
```

å¦ä¸€ç§æ•è·stdoutçš„æ–¹æ³•æ˜¯é€šè¿‡`contextlib.redirect_stdout`ï¼š

```py
from io import StringIO
from contextlib import redirect_stdout

def print_to_stdout(s):
    print(s)

def test_result_and_stdout():
    msg = "Hello"
    buffer = StringIO()
    with redirect_stdout(buffer):
        print_to_stdout(msg)
    out = buffer.getvalue()
    # optional: if you want to replay the consumed streams:
    sys.stdout.write(out)
    # test:
    assert msg in out
```

æ•è·stdoutçš„ä¸€ä¸ªé‡è¦æ½œåœ¨é—®é¢˜æ˜¯å®ƒå¯èƒ½åŒ…å«`\r`å­—ç¬¦ï¼Œè¿™äº›å­—ç¬¦åœ¨æ­£å¸¸çš„`print`ä¸­ä¼šé‡ç½®åˆ°ç›®å‰ä¸ºæ­¢å·²ç»æ‰“å°çš„æ‰€æœ‰å†…å®¹ã€‚å¯¹äº`pytest`æ²¡æœ‰é—®é¢˜ï¼Œä½†å¯¹äº`pytest -s`ï¼Œè¿™äº›å­—ç¬¦ä¼šåŒ…å«åœ¨ç¼“å†²åŒºä¸­ï¼Œå› æ­¤ä¸ºäº†èƒ½å¤Ÿåœ¨æœ‰å’Œæ²¡æœ‰`-s`çš„æƒ…å†µä¸‹è¿è¡Œæµ‹è¯•ï¼Œå¿…é¡»å¯¹æ•è·çš„è¾“å‡ºè¿›è¡Œé¢å¤–çš„æ¸…ç†ï¼Œä½¿ç”¨`re.sub(r'~.*\r', '', buf, 0, re.M)`ã€‚

ä½†æ˜¯ï¼Œæˆ‘ä»¬æœ‰ä¸€ä¸ªè¾…åŠ©ä¸Šä¸‹æ–‡ç®¡ç†å™¨åŒ…è£…å™¨ï¼Œå¯ä»¥è‡ªåŠ¨å¤„ç†æ‰€æœ‰è¿™äº›ï¼Œæ— è®ºå®ƒæ˜¯å¦åŒ…å«ä¸€äº›`\r`ï¼Œæ‰€ä»¥è¿™å¾ˆç®€å•ï¼š

```py
from transformers.testing_utils import CaptureStdout

with CaptureStdout() as cs:
    function_that_writes_to_stdout()
print(cs.out)
```

è¿™é‡Œæ˜¯ä¸€ä¸ªå®Œæ•´çš„æµ‹è¯•ç¤ºä¾‹ï¼š

```py
from transformers.testing_utils import CaptureStdout

msg = "Secret message\r"
final = "Hello World"
with CaptureStdout() as cs:
    print(msg + final)
assert cs.out == final + "\n", f"captured: {cs.out}, expecting {final}"
```

å¦‚æœæ‚¨æƒ³æ•è·`stderr`ï¼Œè¯·æ”¹ç”¨`CaptureStderr`ç±»ï¼š

```py
from transformers.testing_utils import CaptureStderr

with CaptureStderr() as cs:
    function_that_writes_to_stderr()
print(cs.err)
```

å¦‚æœéœ€è¦åŒæ—¶æ•è·ä¸¤ä¸ªæµï¼Œè¯·ä½¿ç”¨çˆ¶ç±»`CaptureStd`ï¼š

```py
from transformers.testing_utils import CaptureStd

with CaptureStd() as cs:
    function_that_writes_to_stdout_and_stderr()
print(cs.err, cs.out)
```

æ­¤å¤–ï¼Œä¸ºäº†å¸®åŠ©è°ƒè¯•æµ‹è¯•é—®é¢˜ï¼Œé»˜è®¤æƒ…å†µä¸‹è¿™äº›ä¸Šä¸‹æ–‡ç®¡ç†å™¨ä¼šåœ¨é€€å‡ºä¸Šä¸‹æ–‡æ—¶è‡ªåŠ¨é‡æ”¾æ•è·çš„æµã€‚

### æ•è·è®°å½•å™¨æµ

å¦‚æœæ‚¨éœ€è¦éªŒè¯è®°å½•å™¨çš„è¾“å‡ºï¼Œå¯ä»¥ä½¿ç”¨`CaptureLogger`ï¼š

```py
from transformers import logging
from transformers.testing_utils import CaptureLogger

msg = "Testing 1, 2, 3"
logging.set_verbosity_info()
logger = logging.get_logger("transformers.models.bart.tokenization_bart")
with CaptureLogger(logger) as cl:
    logger.info(msg)
assert cl.out, msg + "\n"
```

### ä½¿ç”¨ç¯å¢ƒå˜é‡è¿›è¡Œæµ‹è¯•

å¦‚æœæ‚¨æƒ³æµ‹è¯•ç‰¹å®šæµ‹è¯•çš„ç¯å¢ƒå˜é‡çš„å½±å“ï¼Œå¯ä»¥ä½¿ç”¨è¾…åŠ©è£…é¥°å™¨`transformers.testing_utils.mockenv`

```py
from transformers.testing_utils import mockenv

class HfArgumentParserTest(unittest.TestCase):
 @mockenv(TRANSFORMERS_VERBOSITY="error")
    def test_env_override(self):
        env_level_str = os.getenv("TRANSFORMERS_VERBOSITY", None)
```

æœ‰æ—¶éœ€è¦è°ƒç”¨å¤–éƒ¨ç¨‹åºï¼Œè¿™éœ€è¦åœ¨`os.environ`ä¸­è®¾ç½®`PYTHONPATH`ä»¥åŒ…æ‹¬å¤šä¸ªæœ¬åœ°è·¯å¾„ã€‚ä¸€ä¸ªè¾…åŠ©ç±»`transformers.test_utils.TestCasePlus`æ¥å¸®åŠ©ï¼š

```py
from transformers.testing_utils import TestCasePlus

class EnvExampleTest(TestCasePlus):
    def test_external_prog(self):
        env = self.get_env()
        # now call the external program, passing `env` to it
```

æ ¹æ®æµ‹è¯•æ–‡ä»¶æ˜¯åœ¨`tests`æµ‹è¯•å¥—ä»¶è¿˜æ˜¯`examples`ä¸‹ï¼Œå®ƒå°†æ­£ç¡®è®¾ç½®`env[PYTHONPATH]`ä»¥åŒ…æ‹¬è¿™ä¸¤ä¸ªç›®å½•ä¹‹ä¸€ï¼Œå¹¶ä¸”è¿˜å°†`src`ç›®å½•è®¾ç½®ä¸ºç¡®ä¿é’ˆå¯¹å½“å‰å­˜å‚¨åº“è¿›è¡Œæµ‹è¯•ï¼Œæœ€åè¿˜å°†è®¾ç½®`env[PYTHONPATH]`åœ¨è°ƒç”¨æµ‹è¯•ä¹‹å‰å·²ç»è®¾ç½®çš„ä»»ä½•å†…å®¹ã€‚

è¿™ä¸ªè¾…åŠ©æ–¹æ³•åˆ›å»ºäº†`os.environ`å¯¹è±¡çš„å‰¯æœ¬ï¼Œå› æ­¤åŸå§‹å¯¹è±¡ä¿æŒä¸å˜ã€‚

### è·å¾—å¯é‡ç°çš„ç»“æœ

åœ¨æŸäº›æƒ…å†µä¸‹ï¼Œæ‚¨å¯èƒ½å¸Œæœ›ä¸ºæµ‹è¯•å»é™¤éšæœºæ€§ã€‚è¦è·å¾—ç›¸åŒçš„å¯é‡ç°ç»“æœé›†ï¼Œæ‚¨éœ€è¦ä¿®å¤ç§å­ï¼š

```py
seed = 42

# python RNG
import random

random.seed(seed)

# pytorch RNGs
import torch

torch.manual_seed(seed)
torch.backends.cudnn.deterministic = True
if torch.cuda.is_available():
    torch.cuda.manual_seed_all(seed)

# numpy RNG
import numpy as np

np.random.seed(seed)

# tf RNG
tf.random.set_seed(seed)
```

### è°ƒè¯•æµ‹è¯•

è¦åœ¨è­¦å‘Šç‚¹å¯åŠ¨è°ƒè¯•å™¨ï¼Œè¯·æ‰§è¡Œä»¥ä¸‹æ“ä½œï¼š

```py
pytest tests/utils/test_logging.py -W error::UserWarning --pdb
```

## ä½¿ç”¨github actionså·¥ä½œæµ

è¦è§¦å‘è‡ªåŠ¨æ¨é€å·¥ä½œæµCIä½œä¸šï¼Œå¿…é¡»ï¼š

1.  åœ¨`transformers`æºä¸Šåˆ›å»ºä¸€ä¸ªæ–°åˆ†æ”¯ï¼ˆä¸æ˜¯åˆ†å‰ï¼ï¼‰ã€‚

1.  åˆ†æ”¯åç§°å¿…é¡»ä»¥`ci_`æˆ–`ci-`å¼€å¤´ï¼ˆ`main`ä¹Ÿä¼šè§¦å‘å®ƒï¼Œä½†æˆ‘ä»¬ä¸èƒ½åœ¨`main`ä¸Šåˆ›å»ºPRï¼‰ã€‚å®ƒè¿˜ä»…é’ˆå¯¹ç‰¹å®šè·¯å¾„è§¦å‘ - å¦‚æœè‡ªä»ç¼–å†™æœ¬æ–‡ä»¥æ¥å‘ç”Ÿäº†æ›´æ”¹ï¼Œæ‚¨å¯ä»¥åœ¨[æ­¤å¤„](https://github.com/huggingface/transformers/blob/main/.github/workflows/self-push.yml)æ‰¾åˆ°æœ€æ–°çš„å®šä¹‰ï¼Œä½äº*push:*ä¸‹ã€‚

1.  ä»æ­¤åˆ†æ”¯åˆ›å»ºä¸€ä¸ªPRã€‚

1.  ç„¶åæ‚¨å¯ä»¥åœ¨[è¿™é‡Œ](https://github.com/huggingface/transformers/actions/workflows/self-push.yml)çœ‹åˆ°è¯¥ä½œä¸šã€‚å¦‚æœæœ‰ç§¯å‹ï¼Œå®ƒå¯èƒ½ä¸ä¼šç«‹å³è¿è¡Œã€‚

## æµ‹è¯•å®éªŒæ€§CIåŠŸèƒ½

æµ‹è¯•CIåŠŸèƒ½å¯èƒ½ä¼šæœ‰æ½œåœ¨é—®é¢˜ï¼Œå› ä¸ºå®ƒå¯èƒ½ä¼šå¹²æ‰°æ­£å¸¸çš„CIåŠŸèƒ½ã€‚å› æ­¤ï¼Œå¦‚æœè¦æ·»åŠ æ–°çš„CIåŠŸèƒ½ï¼Œåº”æŒ‰ä»¥ä¸‹æ­¥éª¤è¿›è¡Œã€‚

1.  åˆ›å»ºä¸€ä¸ªæ–°çš„ä¸“ç”¨ä½œä¸šï¼Œæµ‹è¯•éœ€è¦æµ‹è¯•çš„å†…å®¹

1.  æ–°ä½œä¸šå¿…é¡»å§‹ç»ˆæˆåŠŸï¼Œä»¥ä¾¿ä¸ºæˆ‘ä»¬æä¾›ç»¿è‰²çš„ âœ“ï¼ˆä¸‹é¢æœ‰è¯¦ç»†ä¿¡æ¯ï¼‰ã€‚

1.  è®©å®ƒè¿è¡Œå‡ å¤©ï¼Œçœ‹çœ‹å„ç§ä¸åŒç±»å‹çš„PRæ˜¯å¦å¯ä»¥è¿è¡Œåœ¨ä¸Šé¢ï¼ˆç”¨æˆ·åˆ†æ”¯ï¼Œéåˆ†å‰åˆ†æ”¯ï¼Œæºè‡ªgithub.com UIç›´æ¥æ–‡ä»¶ç¼–è¾‘çš„åˆ†æ”¯ï¼Œå„ç§å¼ºåˆ¶æ¨é€ç­‰ç­‰ - æœ‰å¾ˆå¤šï¼‰ï¼ŒåŒæ—¶ç›‘è§†å®éªŒæ€§ä½œä¸šçš„æ—¥å¿—ï¼ˆè€Œä¸æ˜¯æ•´ä½“ä½œä¸šç»¿è‰²ï¼Œå› ä¸ºå®ƒæ•…æ„æ€»æ˜¯ç»¿è‰²ï¼‰

1.  å½“ä¸€åˆ‡éƒ½å¾ˆç¨³å®šæ—¶ï¼Œç„¶åå°†æ–°æ›´æ”¹åˆå¹¶åˆ°ç°æœ‰ä½œä¸šä¸­ã€‚

è¿™æ ·ï¼Œå¯¹CIåŠŸèƒ½æœ¬èº«çš„å®éªŒå°±ä¸ä¼šå¹²æ‰°æ­£å¸¸çš„å·¥ä½œæµç¨‹ã€‚

ç°åœ¨æˆ‘ä»¬å¦‚ä½•ç¡®ä¿å·¥ä½œå§‹ç»ˆæˆåŠŸï¼ŒåŒæ—¶æ–°çš„CIåŠŸèƒ½æ­£åœ¨å¼€å‘ä¸­ï¼Ÿ

ä¸€äº›CIï¼Œå¦‚TravisCIæ”¯æŒignore-step-failureï¼Œå¹¶å°†æ•´ä½“ä½œä¸šæŠ¥å‘Šä¸ºæˆåŠŸï¼Œä½†æˆªè‡³ç›®å‰ï¼ŒCircleCIå’ŒGithub Actionsä¸æ”¯æŒè¯¥åŠŸèƒ½ã€‚

å› æ­¤ï¼Œå¯ä»¥ä½¿ç”¨ä»¥ä¸‹è§£å†³æ–¹æ³•ï¼š

1.  åœ¨è¿è¡Œå‘½ä»¤çš„å¼€å¤´ä½¿ç”¨`set +euo pipefail`æ¥æŠ‘åˆ¶bashè„šæœ¬ä¸­çš„å¤§å¤šæ•°æ½œåœ¨æ•…éšœã€‚

1.  æœ€åä¸€ä¸ªå‘½ä»¤å¿…é¡»æˆåŠŸï¼š`echo "done"`æˆ–åªéœ€`true`å³å¯

è¿™æ˜¯ä¸€ä¸ªä¾‹å­ï¼š

```py
- run:
    name: run CI experiment
    command: |
        set +euo pipefail
        echo "setting run-all-despite-any-errors-mode"
        this_command_will_fail
        echo "but bash continues to run"
        # emulate another failure
        false
        # but the last command must be a success
        echo "during experiment do not remove: reporting success to CI, even if there were failures"
```

å¯¹äºç®€å•çš„å‘½ä»¤ï¼Œæ‚¨ä¹Ÿå¯ä»¥è¿™æ ·åšï¼š

```py
cmd_that_may_fail || true
```

å½“ç»“æœä»¤äººæ»¡æ„æ—¶ï¼Œå°†å®éªŒæ­¥éª¤æˆ–ä½œä¸šä¸å…¶ä½™æ­£å¸¸ä½œä¸šé›†æˆåœ¨ä¸€èµ·ï¼ŒåŒæ—¶åˆ é™¤`set +euo pipefail`æˆ–æ‚¨å¯èƒ½æ·»åŠ çš„ä»»ä½•å…¶ä»–å†…å®¹ï¼Œä»¥ç¡®ä¿å®éªŒæ€§ä½œä¸šä¸ä¼šå¹²æ‰°æ­£å¸¸çš„CIåŠŸèƒ½ã€‚

å¦‚æœåªèƒ½ä¸ºå®éªŒæ­¥éª¤è®¾ç½®ç±»ä¼¼äº`allow-failure`çš„å†…å®¹ï¼Œå¹¶ä¸”è®©å®ƒå¤±è´¥è€Œä¸å½±å“PRçš„æ•´ä½“çŠ¶æ€ï¼Œé‚£ä¹ˆæ•´ä¸ªè¿‡ç¨‹å°†å˜å¾—æ›´åŠ å®¹æ˜“ã€‚ä½†æ­£å¦‚å‰é¢æåˆ°çš„ï¼ŒCircleCIå’ŒGithub Actionsç›®å‰ä¸æ”¯æŒè¿™ä¸€ç‚¹ã€‚

æ‚¨å¯ä»¥ä¸ºæ­¤åŠŸèƒ½æŠ•ç¥¨ï¼Œå¹¶æŸ¥çœ‹CIç‰¹å®šçº¿ç¨‹çš„è¿›å±•ï¼š

+   [Github Actionsï¼š](https://github.com/actions/toolkit/issues/399)

+   [CircleCIï¼š](https://ideas.circleci.com/ideas/CCI-I-344)
