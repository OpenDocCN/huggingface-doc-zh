# UNetMotionModel

> åŸå§‹æ–‡æœ¬ï¼š[`huggingface.co/docs/diffusers/api/models/unet-motion`](https://huggingface.co/docs/diffusers/api/models/unet-motion)

[UNet](https://huggingface.co/papers/1505.04597)æ¨¡å‹æœ€åˆç”± Ronneberger ç­‰äººå¼•å…¥ï¼Œç”¨äºç”Ÿç‰©åŒ»å­¦å›¾åƒåˆ†å‰²ï¼Œä½†å®ƒä¹Ÿå¸¸ç”¨äºğŸ¤— Diffusersï¼Œå› ä¸ºå®ƒè¾“å‡ºä¸è¾“å…¥ç›¸åŒå¤§å°çš„å›¾åƒã€‚å®ƒæ˜¯æ‰©æ•£ç³»ç»Ÿä¸­æœ€é‡è¦çš„ç»„ä»¶ä¹‹ä¸€ï¼Œå› ä¸ºå®ƒä¿ƒè¿›äº†å®é™…çš„æ‰©æ•£è¿‡ç¨‹ã€‚ğŸ¤— Diffusers ä¸­æœ‰å‡ ç§ UNet æ¨¡å‹çš„å˜ä½“ï¼Œå–å†³äºå®ƒçš„ç»´åº¦æ•°é‡ä»¥åŠå®ƒæ˜¯å¦æ˜¯æ¡ä»¶æ¨¡å‹ã€‚è¿™æ˜¯ä¸€ä¸ª 2D UNet æ¨¡å‹ã€‚

è®ºæ–‡æ‘˜è¦å¦‚ä¸‹ï¼š

*å¤§å¤šæ•°äººä¸€è‡´è®¤ä¸ºæˆåŠŸè®­ç»ƒæ·±åº¦ç½‘ç»œéœ€è¦æˆåƒä¸Šä¸‡ä¸ªæ³¨é‡Šè®­ç»ƒæ ·æœ¬ã€‚åœ¨æœ¬æ–‡ä¸­ï¼Œæˆ‘ä»¬æå‡ºäº†ä¸€ç§ä¾èµ–äºæ•°æ®å¢å¼ºçš„ç½‘ç»œå’Œè®­ç»ƒç­–ç•¥ï¼Œä»¥æ›´æœ‰æ•ˆåœ°åˆ©ç”¨å¯ç”¨çš„æ³¨é‡Šæ ·æœ¬ã€‚è¯¥æ¶æ„ç”±ä¸€ä¸ªæ”¶ç¼©è·¯å¾„å’Œä¸€ä¸ªå¯¹ç§°æ‰©å±•è·¯å¾„ç»„æˆï¼Œç”¨äºæ•è·ä¸Šä¸‹æ–‡å’Œå®ç°ç²¾ç¡®å®šä½ã€‚æˆ‘ä»¬å±•ç¤ºäº†è¿™æ ·ä¸€ä¸ªç½‘ç»œå¯ä»¥ä»å¾ˆå°‘çš„å›¾åƒç«¯åˆ°ç«¯è®­ç»ƒï¼Œå¹¶ä¸”åœ¨ ISBI æŒ‘æˆ˜ä¸­è¡¨ç°ä¼˜äºå…ˆå‰æœ€ä½³æ–¹æ³•ï¼ˆæ»‘åŠ¨çª—å£å·ç§¯ç½‘ç»œï¼‰ç”¨äºç”µå­æ˜¾å¾®é•œå †æ ˆä¸­ç¥ç»ç»“æ„çš„åˆ†å‰²ã€‚ä½¿ç”¨ç›¸åŒçš„ç½‘ç»œåœ¨é€å°„å…‰å­¦æ˜¾å¾®é•œå›¾åƒï¼ˆç›¸å·®å’Œ DICï¼‰ä¸Šè®­ç»ƒï¼Œæˆ‘ä»¬åœ¨è¿™äº›ç±»åˆ«ä¸Šä»¥å¾ˆå¤§çš„ä¼˜åŠ¿èµ¢å¾—äº† 2015 å¹´ ISBI ç»†èƒè·Ÿè¸ªæŒ‘æˆ˜ã€‚æ­¤å¤–ï¼Œè¯¥ç½‘ç»œé€Ÿåº¦å¾ˆå¿«ã€‚åœ¨æœ€æ–°çš„ GPU ä¸Šï¼Œå¯¹ 512x512 å›¾åƒçš„åˆ†å‰²ä¸åˆ°ä¸€ç§’ã€‚å®Œæ•´çš„å®ç°ï¼ˆåŸºäº Caffeï¼‰å’Œè®­ç»ƒçš„ç½‘ç»œå¯åœ¨[`lmb.informatik.uni-freiburg.de/people/ronneber/u-net`](http://lmb.informatik.uni-freiburg.de/people/ronneber/u-net)ä¸Šè·å¾—ã€‚*

## UNetMotionModel

### `class diffusers.UNetMotionModel`

[< source >](https://github.com/huggingface/diffusers/blob/v0.26.3/src/diffusers/models/unets/unet_motion_model.py#L176)

```py
( sample_size: Optional = None in_channels: int = 4 out_channels: int = 4 down_block_types: Tuple = ('CrossAttnDownBlockMotion', 'CrossAttnDownBlockMotion', 'CrossAttnDownBlockMotion', 'DownBlockMotion') up_block_types: Tuple = ('UpBlockMotion', 'CrossAttnUpBlockMotion', 'CrossAttnUpBlockMotion', 'CrossAttnUpBlockMotion') block_out_channels: Tuple = (320, 640, 1280, 1280) layers_per_block: int = 2 downsample_padding: int = 1 mid_block_scale_factor: float = 1 act_fn: str = 'silu' norm_num_groups: int = 32 norm_eps: float = 1e-05 cross_attention_dim: int = 1280 use_linear_projection: bool = False num_attention_heads: Union = 8 motion_max_seq_length: int = 32 motion_num_attention_heads: int = 8 use_motion_mid_block: int = True encoder_hid_dim: Optional = None encoder_hid_dim_type: Optional = None )
```

ä¸€ä¸ªä¿®æ”¹åçš„æ¡ä»¶ 2D UNet æ¨¡å‹ï¼Œæ¥å—å˜ˆæ‚æ ·æœ¬ã€æ¡ä»¶çŠ¶æ€å’Œæ—¶é—´æ­¥ï¼Œå¹¶è¿”å›ä¸€ä¸ªå½¢çŠ¶è¾“å‡ºçš„æ ·æœ¬ã€‚

è¿™ä¸ªæ¨¡å‹ç»§æ‰¿è‡ª ModelMixinã€‚æ£€æŸ¥è¶…ç±»æ–‡æ¡£ä»¥äº†è§£ä¸ºæ‰€æœ‰æ¨¡å‹å®ç°çš„é€šç”¨æ–¹æ³•ï¼ˆå¦‚ä¸‹è½½æˆ–ä¿å­˜ï¼‰ã€‚

#### `disable_freeu`

[< source >](https://github.com/huggingface/diffusers/blob/v0.26.3/src/diffusers/models/unets/unet_motion_model.py#L695)

```py
( )
```

ç¦ç”¨ FreeU æœºåˆ¶ã€‚

#### `enable_forward_chunking`

[< source >](https://github.com/huggingface/diffusers/blob/v0.26.3/src/diffusers/models/unets/unet_motion_model.py#L608)

```py
( chunk_size: Optional = None dim: int = 0 )
```

å‚æ•°

+   `chunk_size`ï¼ˆ`int`ï¼Œ*å¯é€‰*ï¼‰â€” å‰é¦ˆå±‚çš„åˆ†å—å¤§å°ã€‚å¦‚æœæœªæŒ‡å®šï¼Œå°†åœ¨ dim=`dim`çš„æ¯ä¸ªå¼ é‡ä¸Šå•ç‹¬è¿è¡Œå‰é¦ˆå±‚ã€‚

+   `dim`ï¼ˆ`int`ï¼Œ*å¯é€‰*ï¼Œé»˜è®¤ä¸º`0`ï¼‰â€” å‰é¦ˆè®¡ç®—åº”è¯¥åœ¨å“ªä¸ªç»´åº¦ä¸Šåˆ†å—ã€‚é€‰æ‹© dim=0ï¼ˆæ‰¹å¤„ç†ï¼‰æˆ– dim=1ï¼ˆåºåˆ—é•¿åº¦ï¼‰ä¹‹é—´çš„å€¼ã€‚

è®¾ç½®æ³¨æ„åŠ›å¤„ç†å™¨ä½¿ç”¨[å‰é¦ˆåˆ†å—](https://huggingface.co/blog/reformer#2-chunked-feed-forward-layers)ã€‚

#### `enable_freeu`

[< source >](https://github.com/huggingface/diffusers/blob/v0.26.3/src/diffusers/models/unets/unet_motion_model.py#L670)

```py
( s1: float s2: float b1: float b2: float )
```

å‚æ•°

+   `s1`ï¼ˆ`float`ï¼‰â€” é˜¶æ®µ 1 çš„ç¼©æ”¾å› å­ï¼Œç”¨äºå‡å¼±è·³è·ƒç‰¹å¾çš„è´¡çŒ®ã€‚è¿™æ ·åšæ˜¯ä¸ºäº†å‡è½»å¢å¼ºå»å™ªè¿‡ç¨‹ä¸­çš„â€œè¿‡åº¦å¹³æ»‘æ•ˆåº”â€ã€‚

+   `s2`ï¼ˆ`float`ï¼‰â€” é˜¶æ®µ 2 çš„ç¼©æ”¾å› å­ï¼Œç”¨äºå‡å¼±è·³è·ƒç‰¹å¾çš„è´¡çŒ®ã€‚è¿™æ ·åšæ˜¯ä¸ºäº†å‡è½»å¢å¼ºå»å™ªè¿‡ç¨‹ä¸­çš„â€œè¿‡åº¦å¹³æ»‘æ•ˆåº”â€ã€‚

+   `b1`ï¼ˆ`float`ï¼‰â€” é˜¶æ®µ 1 çš„ç¼©æ”¾å› å­ï¼Œç”¨äºæ”¾å¤§éª¨å¹²ç‰¹å¾çš„è´¡çŒ®ã€‚

+   `b2`ï¼ˆ`float`ï¼‰â€” é˜¶æ®µ 2 çš„ç¼©æ”¾å› å­ï¼Œç”¨äºæ”¾å¤§éª¨å¹²ç‰¹å¾çš„è´¡çŒ®ã€‚

å¯ç”¨æ¥è‡ª [`arxiv.org/abs/2309.11497`](https://arxiv.org/abs/2309.11497) çš„ FreeU æœºåˆ¶ã€‚

ç¼©æ”¾å› å­åçš„åç¼€è¡¨ç¤ºå®ƒä»¬è¢«åº”ç”¨çš„é˜¶æ®µå—ã€‚

è¯·å‚è€ƒ[å®˜æ–¹å­˜å‚¨åº“](https://github.com/ChenyangSi/FreeU)ä»¥è·å–å·²çŸ¥é€‚ç”¨äºä¸åŒæµæ°´çº¿ï¼ˆå¦‚ Stable Diffusion v1ã€v2 å’Œ Stable Diffusion XLï¼‰çš„å€¼ç»„åˆã€‚

#### `forward`

[<æ¥æº>](https://github.com/huggingface/diffusers/blob/v0.26.3/src/diffusers/models/unets/unet_motion_model.py#L703)

```py
( sample: FloatTensor timestep: Union encoder_hidden_states: Tensor timestep_cond: Optional = None attention_mask: Optional = None cross_attention_kwargs: Optional = None added_cond_kwargs: Optional = None down_block_additional_residuals: Optional = None mid_block_additional_residual: Optional = None return_dict: bool = True ) â†’ export const metadata = 'undefined';~models.unet_3d_condition.UNet3DConditionOutput or tuple
```

å‚æ•°

+   `sample` (`torch.FloatTensor`) â€” å…·æœ‰ä»¥ä¸‹å½¢çŠ¶ `(batch, num_frames, channel, height, width)` çš„å˜ˆæ‚è¾“å…¥å¼ é‡ã€‚

+   `timestep` (`torch.FloatTensor` æˆ– `float` æˆ– `int`) â€” å¯¹è¾“å…¥è¿›è¡Œå»å™ªçš„æ—¶é—´æ­¥æ•°ã€‚

+   `encoder_hidden_states` (`torch.FloatTensor`) â€” å…·æœ‰å½¢çŠ¶ `(batch, sequence_length, feature_dim)` çš„ç¼–ç å™¨éšè—çŠ¶æ€ã€‚timestep_cond â€” (`torch.Tensor`, *å¯é€‰*, é»˜è®¤ä¸º `None`): æ—¶é—´æ­¥çš„æ¡ä»¶åµŒå…¥ã€‚å¦‚æœæä¾›äº†ï¼Œè¿™äº›åµŒå…¥å°†ä¸é€šè¿‡ `self.time_embedding` å±‚ä¼ é€’çš„æ ·æœ¬ç›¸åŠ ï¼Œä»¥è·å¾—æ—¶é—´æ­¥åµŒå…¥ã€‚

+   `attention_mask` (`torch.Tensor`, *å¯é€‰*, é»˜è®¤ä¸º `None`) â€” ä¸€ä¸ªå½¢çŠ¶ä¸º `(batch, key_tokens)` çš„æ³¨æ„åŠ›æ©ç è¢«åº”ç”¨äº `encoder_hidden_states`ã€‚å¦‚æœä¸º `1`ï¼Œåˆ™ä¿ç•™æ©ç ï¼Œå¦åˆ™å¦‚æœä¸º `0`ï¼Œåˆ™ä¸¢å¼ƒã€‚æ©ç å°†è¢«è½¬æ¢ä¸ºåç½®ï¼Œè¿™ä¼šåœ¨â€œä¸¢å¼ƒâ€æ ‡è®°å¯¹åº”çš„æ³¨æ„åŠ›åˆ†æ•°ä¸Šæ·»åŠ å¤§çš„è´Ÿå€¼ã€‚

+   `cross_attention_kwargs` (`dict`, *å¯é€‰*) â€” å¦‚æœæŒ‡å®šäº†ï¼Œå°†ä¼ é€’ç»™ `AttentionProcessor` çš„ kwargs å­—å…¸ï¼Œå¦‚ [diffusers.models.attention_processor](https://github.com/huggingface/diffusers/blob/main/src/diffusers/models/attention_processor.py) ä¸­çš„ `self.processor` ä¸­å®šä¹‰çš„é‚£æ ·ã€‚down_block_additional_residuals â€” (`torch.Tensor` çš„ `tuple`, *å¯é€‰*): å¦‚æœæŒ‡å®šäº†ï¼Œå°†æ·»åŠ åˆ° down unet å—çš„æ®‹å·®ä¸­ã€‚mid_block_additional_residual â€” (`torch.Tensor`, *å¯é€‰*): å¦‚æœæŒ‡å®šäº†ï¼Œå°†æ·»åŠ åˆ°ä¸­é—´ unet å—çš„æ®‹å·®ä¸­ã€‚

+   `return_dict` (`bool`, *å¯é€‰*, é»˜è®¤ä¸º `True`) â€” æ˜¯å¦è¿”å›ä¸€ä¸ª `~models.unet_3d_condition.UNet3DConditionOutput` è€Œä¸æ˜¯ä¸€ä¸ªæ™®é€šå…ƒç»„ã€‚

è¿”å›

`~models.unet_3d_condition.UNet3DConditionOutput` æˆ– `tuple`

å¦‚æœ `return_dict` ä¸º Trueï¼Œåˆ™è¿”å›ä¸€ä¸ª `~models.unet_3d_condition.UNet3DConditionOutput`ï¼Œå¦åˆ™è¿”å›ä¸€ä¸ªå…ƒç»„ï¼Œå…¶ä¸­ç¬¬ä¸€ä¸ªå…ƒç´ æ˜¯æ ·æœ¬å¼ é‡ã€‚

UNetMotionModel çš„å‰å‘æ–¹æ³•ã€‚

#### `freeze_unet2d_params`

[<æ¥æº>](https://github.com/huggingface/diffusers/blob/v0.26.3/src/diffusers/models/unets/unet_motion_model.py#L478)

```py
( )
```

å†»ç»“ä»… UNet2DConditionModel çš„æƒé‡ï¼Œå¹¶ä¿æŒè¿åŠ¨æ¨¡å—æœªå†»ç»“ä»¥è¿›è¡Œå¾®è°ƒã€‚

#### `set_attn_processor`

[<æ¥æº>](https://github.com/huggingface/diffusers/blob/v0.26.3/src/diffusers/models/unets/unet_motion_model.py#L573)

```py
( processor: Union )
```

å‚æ•°

+   `processor` (`AttentionProcessor` çš„ `dict` æˆ–ä»… `AttentionProcessor`) â€” å®ä¾‹åŒ–çš„å¤„ç†å™¨ç±»æˆ–å¤„ç†å™¨ç±»çš„å­—å…¸ï¼Œå°†è¢«è®¾ç½®ä¸º**æ‰€æœ‰** `Attention` å±‚çš„å¤„ç†å™¨ã€‚

    å¦‚æœ `processor` æ˜¯ä¸€ä¸ªå­—å…¸ï¼Œåˆ™é”®éœ€è¦å®šä¹‰ç›¸åº”çš„äº¤å‰æ³¨æ„åŠ›å¤„ç†å™¨çš„è·¯å¾„ã€‚åœ¨è®¾ç½®å¯è®­ç»ƒçš„æ³¨æ„åŠ›å¤„ç†å™¨æ—¶ï¼Œå¼ºçƒˆå»ºè®®è¿™æ ·åšã€‚

è®¾ç½®ç”¨äºè®¡ç®—æ³¨æ„åŠ›çš„æ³¨æ„åŠ›å¤„ç†å™¨ã€‚

#### `set_default_attn_processor`

[<æ¥æº>](https://github.com/huggingface/diffusers/blob/v0.26.3/src/diffusers/models/unets/unet_motion_model.py#L650)

```py
( )
```

ç¦ç”¨è‡ªå®šä¹‰æ³¨æ„åŠ›å¤„ç†å™¨å¹¶è®¾ç½®é»˜è®¤çš„æ³¨æ„åŠ›å®ç°ã€‚

## UNet3DConditionOutput

### `class diffusers.models.unets.unet_3d_condition.UNet3DConditionOutput`

[<æ¥æº>](https://github.com/huggingface/diffusers/blob/v0.26.3/src/diffusers/models/unets/unet_3d_condition.py#L51)

```py
( sample: FloatTensor )
```

å‚æ•°

+   `sample`ï¼ˆå½¢çŠ¶ä¸º`(batch_size, num_frames, num_channels, height, width)`çš„`torch.FloatTensor`ï¼‰- åœ¨`encoder_hidden_states`è¾“å…¥æ¡ä»¶ä¸‹çš„éšè—çŠ¶æ€è¾“å‡ºã€‚æ¨¡å‹çš„æœ€åä¸€å±‚çš„è¾“å‡ºã€‚

UNet3DConditionModel çš„è¾“å‡ºã€‚
