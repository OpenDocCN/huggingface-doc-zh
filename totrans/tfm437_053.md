# æ„å»ºè‡ªå®šä¹‰æ¨¡å‹

> åŸæ–‡é“¾æ¥ï¼š[`huggingface.co/docs/transformers/v4.37.2/en/custom_models`](https://huggingface.co/docs/transformers/v4.37.2/en/custom_models)

ğŸ¤— Transformers åº“è¢«è®¾è®¡ä¸ºæ˜“äºæ‰©å±•ã€‚æ¯ä¸ªæ¨¡å‹éƒ½å®Œå…¨åœ¨å­˜å‚¨åº“çš„ç»™å®šå­æ–‡ä»¶å¤¹ä¸­ç¼–ç ï¼Œæ²¡æœ‰æŠ½è±¡ï¼Œå› æ­¤æ‚¨å¯ä»¥è½»æ¾å¤åˆ¶ä¸€ä¸ªå»ºæ¨¡æ–‡ä»¶å¹¶æ ¹æ®éœ€è¦è¿›è¡Œè°ƒæ•´ã€‚

å¦‚æœæ‚¨æ­£åœ¨ç¼–å†™å…¨æ–°çš„æ¨¡å‹ï¼Œä»å¤´å¼€å§‹å¯èƒ½æ›´å®¹æ˜“ã€‚åœ¨æœ¬æ•™ç¨‹ä¸­ï¼Œæˆ‘ä»¬å°†å‘æ‚¨å±•ç¤ºå¦‚ä½•ç¼–å†™è‡ªå®šä¹‰æ¨¡å‹åŠå…¶é…ç½®ï¼Œä»¥ä¾¿å¯ä»¥åœ¨ Transformers ä¸­ä½¿ç”¨ï¼Œå¹¶ä¸”æ‚¨å¯ä»¥ä¸ç¤¾åŒºå…±äº«ï¼ˆä»¥åŠå®ƒæ‰€ä¾èµ–çš„ä»£ç ï¼‰ï¼Œä»¥ä¾¿ä»»ä½•äººéƒ½å¯ä»¥ä½¿ç”¨å®ƒï¼Œå³ä½¿å®ƒä¸åœ¨ğŸ¤— Transformers åº“ä¸­ã€‚æˆ‘ä»¬å°†çœ‹åˆ°å¦‚ä½•åœ¨ transformers ä¸Šæ„å»ºå¹¶æ‰©å±•æ¡†æ¶ï¼Œä½¿ç”¨æ‚¨çš„é’©å­å’Œè‡ªå®šä¹‰ä»£ç ã€‚

æˆ‘ä»¬å°†åœ¨ ResNet æ¨¡å‹ä¸Šè¯´æ˜æ‰€æœ‰è¿™äº›ï¼Œé€šè¿‡å°†[timm åº“](https://github.com/rwightman/pytorch-image-models)çš„ ResNet ç±»åŒ…è£…åˆ° PreTrainedModel ä¸­ã€‚

## ç¼–å†™è‡ªå®šä¹‰é…ç½®

åœ¨æ·±å…¥ç ”ç©¶æ¨¡å‹ä¹‹å‰ï¼Œè®©æˆ‘ä»¬å…ˆç¼–å†™å…¶é…ç½®ã€‚æ¨¡å‹çš„é…ç½®æ˜¯ä¸€ä¸ªå¯¹è±¡ï¼Œå…¶ä¸­åŒ…å«æ„å»ºæ¨¡å‹æ‰€éœ€çš„æ‰€æœ‰ä¿¡æ¯ã€‚æ­£å¦‚æˆ‘ä»¬å°†åœ¨ä¸‹ä¸€èŠ‚ä¸­çœ‹åˆ°çš„ï¼Œæ¨¡å‹åªèƒ½æ¥å—ä¸€ä¸ª`config`è¿›è¡Œåˆå§‹åŒ–ï¼Œå› æ­¤æˆ‘ä»¬ç¡®å®éœ€è¦è¯¥å¯¹è±¡å°½å¯èƒ½å®Œæ•´ã€‚

åœ¨æˆ‘ä»¬çš„ç¤ºä¾‹ä¸­ï¼Œæˆ‘ä»¬å°†è·å– ResNet ç±»çš„ä¸€äº›å‚æ•°ï¼Œå¯èƒ½éœ€è¦è¿›è¡Œè°ƒæ•´ã€‚ç„¶åï¼Œä¸åŒçš„é…ç½®å°†ç»™æˆ‘ä»¬ä¸åŒç±»å‹çš„å¯èƒ½çš„ ResNetsã€‚ç„¶åæˆ‘ä»¬åªéœ€å­˜å‚¨è¿™äº›å‚æ•°ï¼Œä¹‹å‰æ£€æŸ¥å…¶ä¸­ä¸€äº›å‚æ•°çš„æœ‰æ•ˆæ€§ã€‚

```py
from transformers import PretrainedConfig
from typing import List

class ResnetConfig(PretrainedConfig):
    model_type = "resnet"

    def __init__( self,
        block_type="bottleneck",
        layers: List[int] = [3, 4, 6, 3],
        num_classes: int = 1000,
        input_channels: int = 3,
        cardinality: int = 1,
        base_width: int = 64,
        stem_width: int = 64,
        stem_type: str = "",
        avg_down: bool = False,
        **kwargs, ):
        if block_type not in ["basic", "bottleneck"]:
            raise ValueError(f"`block_type` must be 'basic' or bottleneck', got {block_type}.")
        if stem_type not in ["", "deep", "deep-tiered"]:
            raise ValueError(f"`stem_type` must be '', 'deep' or 'deep-tiered', got {stem_type}.")

        self.block_type = block_type
        self.layers = layers
        self.num_classes = num_classes
        self.input_channels = input_channels
        self.cardinality = cardinality
        self.base_width = base_width
        self.stem_width = stem_width
        self.stem_type = stem_type
        self.avg_down = avg_down
        super().__init__(**kwargs)
```

ç¼–å†™è‡ªå®šä¹‰é…ç½®æ—¶éœ€è¦è®°ä½çš„ä¸‰ä¸ªé‡è¦äº‹é¡¹å¦‚ä¸‹ï¼š

+   æ‚¨å¿…é¡»ç»§æ‰¿è‡ª`PretrainedConfig`ï¼Œ

+   æ‚¨çš„`PretrainedConfig`çš„`__init__`å¿…é¡»æ¥å—ä»»ä½• kwargsï¼Œ

+   è¿™äº›`kwargs`éœ€è¦ä¼ é€’ç»™è¶…ç±»`__init__`ã€‚

ç»§æ‰¿æ˜¯ä¸ºäº†ç¡®ä¿æ‚¨ä»ğŸ¤— Transformers åº“ä¸­è·å¾—æ‰€æœ‰åŠŸèƒ½ï¼Œè€Œå¦å¤–ä¸¤ä¸ªçº¦æŸæ¥è‡ªäº`PretrainedConfig`æ‹¥æœ‰æ¯”æ‚¨è®¾ç½®çš„å­—æ®µæ›´å¤šã€‚å½“ä½¿ç”¨`from_pretrained`æ–¹æ³•é‡æ–°åŠ è½½é…ç½®æ—¶ï¼Œè¿™äº›å­—æ®µéœ€è¦è¢«æ‚¨çš„é…ç½®æ¥å—ï¼Œç„¶åå‘é€åˆ°è¶…ç±»ã€‚

ä¸ºæ‚¨çš„é…ç½®å®šä¹‰`model_type`ï¼ˆè¿™é‡Œ`model_type="resnet"`ï¼‰ä¸æ˜¯å¼ºåˆ¶æ€§çš„ï¼Œé™¤éæ‚¨å¸Œæœ›å°†æ‚¨çš„æ¨¡å‹æ³¨å†Œåˆ°è‡ªåŠ¨ç±»ï¼ˆè¯·å‚è§æœ€åä¸€èŠ‚ï¼‰ã€‚

å®Œæˆåï¼Œæ‚¨å¯ä»¥åƒå¤„ç†åº“ä¸­ä»»ä½•å…¶ä»–æ¨¡å‹é…ç½®ä¸€æ ·è½»æ¾åˆ›å»ºå’Œä¿å­˜æ‚¨çš„é…ç½®ã€‚ä»¥ä¸‹æ˜¯æˆ‘ä»¬å¦‚ä½•åˆ›å»ºä¸€ä¸ª resnet50d é…ç½®å¹¶ä¿å­˜å®ƒï¼š

```py
resnet50d_config = ResnetConfig(block_type="bottleneck", stem_width=32, stem_type="deep", avg_down=True)
resnet50d_config.save_pretrained("custom-resnet")
```

è¿™å°†åœ¨`custom-resnet`æ–‡ä»¶å¤¹å†…ä¿å­˜ä¸€ä¸ªåä¸º`config.json`çš„æ–‡ä»¶ã€‚ç„¶åï¼Œæ‚¨å¯ä»¥ä½¿ç”¨`from_pretrained`æ–¹æ³•é‡æ–°åŠ è½½æ‚¨çš„é…ç½®ï¼š

```py
resnet50d_config = ResnetConfig.from_pretrained("custom-resnet")
```

æ‚¨è¿˜å¯ä»¥ä½¿ç”¨ PretrainedConfig ç±»çš„ä»»ä½•å…¶ä»–æ–¹æ³•ï¼Œä¾‹å¦‚ push_to_hub()ç›´æ¥å°†æ‚¨çš„é…ç½®ä¸Šä¼ åˆ° Hubã€‚

## ç¼–å†™è‡ªå®šä¹‰æ¨¡å‹

ç°åœ¨æˆ‘ä»¬æœ‰äº† ResNet é…ç½®ï¼Œæˆ‘ä»¬å¯ä»¥ç»§ç»­ç¼–å†™æ¨¡å‹ã€‚å®é™…ä¸Šï¼Œæˆ‘ä»¬å°†ç¼–å†™ä¸¤ä¸ªæ¨¡å‹ï¼šä¸€ä¸ªä»ä¸€æ‰¹å›¾åƒä¸­æå–éšè—ç‰¹å¾çš„æ¨¡å‹ï¼ˆç±»ä¼¼äº BertModelï¼‰ï¼Œä¸€ä¸ªé€‚ç”¨äºå›¾åƒåˆ†ç±»çš„æ¨¡å‹ï¼ˆç±»ä¼¼äº BertForSequenceClassificationï¼‰ã€‚

å¦‚å‰æ‰€è¿°ï¼Œæˆ‘ä»¬å°†åªç¼–å†™æ¨¡å‹çš„æ¾æ•£åŒ…è£…ï¼Œä»¥ä½¿ç¤ºä¾‹ç®€å•åŒ–ã€‚åœ¨ç¼–å†™æ­¤ç±»ä¹‹å‰ï¼Œæˆ‘ä»¬éœ€è¦åšçš„å”¯ä¸€äº‹æƒ…æ˜¯å°†å—ç±»å‹ä¸å®é™…å—ç±»ä¹‹é—´å»ºç«‹æ˜ å°„ã€‚ç„¶åé€šè¿‡å°†æ‰€æœ‰å†…å®¹ä¼ é€’ç»™`ResNet`ç±»ï¼Œä»é…ç½®ä¸­å®šä¹‰æ¨¡å‹ï¼š

```py
from transformers import PreTrainedModel
from timm.models.resnet import BasicBlock, Bottleneck, ResNet
from .configuration_resnet import ResnetConfig

BLOCK_MAPPING = {"basic": BasicBlock, "bottleneck": Bottleneck}

class ResnetModel(PreTrainedModel):
    config_class = ResnetConfig

    def __init__(self, config):
        super().__init__(config)
        block_layer = BLOCK_MAPPING[config.block_type]
        self.model = ResNet(
            block_layer,
            config.layers,
            num_classes=config.num_classes,
            in_chans=config.input_channels,
            cardinality=config.cardinality,
            base_width=config.base_width,
            stem_width=config.stem_width,
            stem_type=config.stem_type,
            avg_down=config.avg_down,
        )

    def forward(self, tensor):
        return self.model.forward_features(tensor)
```

å¯¹äºå°†å¯¹å›¾åƒè¿›è¡Œåˆ†ç±»çš„æ¨¡å‹ï¼Œæˆ‘ä»¬åªéœ€æ›´æ”¹å‰å‘æ–¹æ³•ï¼š

```py
import torch

class ResnetModelForImageClassification(PreTrainedModel):
    config_class = ResnetConfig

    def __init__(self, config):
        super().__init__(config)
        block_layer = BLOCK_MAPPING[config.block_type]
        self.model = ResNet(
            block_layer,
            config.layers,
            num_classes=config.num_classes,
            in_chans=config.input_channels,
            cardinality=config.cardinality,
            base_width=config.base_width,
            stem_width=config.stem_width,
            stem_type=config.stem_type,
            avg_down=config.avg_down,
        )

    def forward(self, tensor, labels=None):
        logits = self.model(tensor)
        if labels is not None:
            loss = torch.nn.cross_entropy(logits, labels)
            return {"loss": loss, "logits": logits}
        return {"logits": logits}
```

åœ¨è¿™ä¸¤ç§æƒ…å†µä¸‹ï¼Œè¯·æ³¨æ„æˆ‘ä»¬å¦‚ä½•ä»`PreTrainedModel`ç»§æ‰¿å¹¶ä½¿ç”¨`config`è°ƒç”¨è¶…ç±»åˆå§‹åŒ–ï¼ˆæœ‰ç‚¹åƒå½“æ‚¨ç¼–å†™å¸¸è§„`torch.nn.Module`æ—¶ï¼‰ã€‚è®¾ç½®`config_class`çš„è¡Œä¸æ˜¯å¼ºåˆ¶æ€§çš„ï¼Œé™¤éæ‚¨æƒ³å°†æ‚¨çš„æ¨¡å‹æ³¨å†Œåˆ°è‡ªåŠ¨ç±»ï¼ˆè¯·å‚è§æœ€åä¸€èŠ‚ï¼‰ã€‚

å¦‚æœæ‚¨çš„æ¨¡å‹ä¸åº“ä¸­çš„æ¨¡å‹éå¸¸ç›¸ä¼¼ï¼Œæ‚¨å¯ä»¥é‡ç”¨ä¸è¯¥æ¨¡å‹ç›¸åŒçš„é…ç½®ã€‚

æ‚¨å¯ä»¥è®©æ‚¨çš„æ¨¡å‹è¿”å›ä»»ä½•æ‚¨æƒ³è¦çš„å†…å®¹ï¼Œä½†æ˜¯åƒæˆ‘ä»¬ä¸º`ResnetModelForImageClassification`æ‰€åšçš„é‚£æ ·è¿”å›ä¸€ä¸ªåŒ…å«æŸå¤±çš„å­—å…¸ï¼Œå½“ä¼ é€’æ ‡ç­¾æ—¶ï¼Œå°†ä½¿æ‚¨çš„æ¨¡å‹å¯ä»¥ç›´æ¥åœ¨ Trainer ç±»ä¸­ä½¿ç”¨ã€‚åªè¦æ‚¨æ‰“ç®—ä½¿ç”¨è‡ªå·±çš„è®­ç»ƒå¾ªç¯æˆ–å…¶ä»–åº“è¿›è¡Œè®­ç»ƒï¼Œä½¿ç”¨å¦ä¸€ç§è¾“å‡ºæ ¼å¼ä¹Ÿæ˜¯å¯ä»¥çš„ã€‚

ç°åœ¨æˆ‘ä»¬æœ‰äº†æˆ‘ä»¬çš„æ¨¡å‹ç±»ï¼Œè®©æˆ‘ä»¬åˆ›å»ºä¸€ä¸ªï¼š

```py
resnet50d = ResnetModelForImageClassification(resnet50d_config)
```

åŒæ ·ï¼Œæ‚¨å¯ä»¥ä½¿ç”¨ PreTrainedModel çš„ä»»ä½•æ–¹æ³•ï¼Œä¾‹å¦‚ save_pretrained()æˆ– push_to_hub()ã€‚æˆ‘ä»¬å°†åœ¨ä¸‹ä¸€èŠ‚ä¸­ä½¿ç”¨ç¬¬äºŒç§æ–¹æ³•ï¼Œå¹¶çœ‹çœ‹å¦‚ä½•å°†æ¨¡å‹æƒé‡ä¸æˆ‘ä»¬æ¨¡å‹çš„ä»£ç ä¸€èµ·æ¨é€ã€‚ä½†é¦–å…ˆï¼Œè®©æˆ‘ä»¬åœ¨æ¨¡å‹ä¸­åŠ è½½ä¸€äº›é¢„è®­ç»ƒæƒé‡ã€‚

åœ¨æ‚¨è‡ªå·±çš„ç”¨ä¾‹ä¸­ï¼Œæ‚¨å¯èƒ½ä¼šåœ¨è‡ªå·±çš„æ•°æ®ä¸Šè®­ç»ƒè‡ªå®šä¹‰æ¨¡å‹ã€‚ä¸ºäº†åœ¨æœ¬æ•™ç¨‹ä¸­å¿«é€Ÿè¿›è¡Œï¼Œæˆ‘ä»¬å°†ä½¿ç”¨ resnet50d çš„é¢„è®­ç»ƒç‰ˆæœ¬ã€‚ç”±äºæˆ‘ä»¬çš„æ¨¡å‹åªæ˜¯å®ƒçš„ä¸€ä¸ªåŒ…è£…å™¨ï¼Œæ‰€ä»¥è½¬ç§»è¿™äº›æƒé‡å°†ä¼šå¾ˆå®¹æ˜“ï¼š

```py
import timm

pretrained_model = timm.create_model("resnet50d", pretrained=True)
resnet50d.model.load_state_dict(pretrained_model.state_dict())
```

ç°åœ¨è®©æˆ‘ä»¬çœ‹çœ‹å¦‚ä½•ç¡®ä¿åœ¨æ‰§è¡Œ save_pretrained()æˆ– push_to_hub()æ—¶ï¼Œæ¨¡å‹çš„ä»£ç è¢«ä¿å­˜ã€‚

## å°†å¸¦æœ‰è‡ªå®šä¹‰ä»£ç çš„æ¨¡å‹æ³¨å†Œåˆ°è‡ªåŠ¨ç±»

å¦‚æœæ‚¨æ­£åœ¨ç¼–å†™ä¸€ä¸ªæ‰©å±•ğŸ¤— Transformers çš„åº“ï¼Œæ‚¨å¯èƒ½å¸Œæœ›æ‰©å±•è‡ªåŠ¨ç±»ä»¥åŒ…æ‹¬æ‚¨è‡ªå·±çš„æ¨¡å‹ã€‚è¿™ä¸å°†ä»£ç æ¨é€åˆ° Hub ä¸åŒï¼Œç”¨æˆ·éœ€è¦å¯¼å…¥æ‚¨çš„åº“æ‰èƒ½è·å–è‡ªå®šä¹‰æ¨¡å‹ï¼ˆä¸è‡ªåŠ¨ä» Hub ä¸‹è½½æ¨¡å‹ä»£ç ç›¸åï¼‰ã€‚

åªè¦æ‚¨çš„é…ç½®å…·æœ‰ä¸ç°æœ‰æ¨¡å‹ç±»å‹ä¸åŒçš„`model_type`å±æ€§ï¼Œå¹¶ä¸”æ‚¨çš„æ¨¡å‹ç±»å…·æœ‰æ­£ç¡®çš„`config_class`å±æ€§ï¼Œæ‚¨å°±å¯ä»¥åƒè¿™æ ·å°†å®ƒä»¬æ·»åŠ åˆ°è‡ªåŠ¨ç±»ä¸­ï¼š

```py
from transformers import AutoConfig, AutoModel, AutoModelForImageClassification

AutoConfig.register("resnet", ResnetConfig)
AutoModel.register(ResnetConfig, ResnetModel)
AutoModelForImageClassification.register(ResnetConfig, ResnetModelForImageClassification)
```

æ³¨æ„ï¼Œåœ¨å°†è‡ªå®šä¹‰é…ç½®æ³¨å†Œåˆ° AutoConfig æ—¶ä½¿ç”¨çš„ç¬¬ä¸€ä¸ªå‚æ•°éœ€è¦ä¸è‡ªå®šä¹‰é…ç½®çš„`model_type`åŒ¹é…ï¼Œå¹¶ä¸”åœ¨å°†è‡ªå®šä¹‰æ¨¡å‹æ³¨å†Œåˆ°ä»»ä½•è‡ªåŠ¨æ¨¡å‹ç±»æ—¶ä½¿ç”¨çš„ç¬¬ä¸€ä¸ªå‚æ•°éœ€è¦ä¸è¿™äº›æ¨¡å‹çš„`config_class`åŒ¹é…ã€‚

## å°†ä»£ç å‘é€åˆ° Hub

æ­¤ API æ˜¯å®éªŒæ€§çš„ï¼Œå¯èƒ½åœ¨ä¸‹ä¸€ä¸ªç‰ˆæœ¬ä¸­æœ‰ä¸€äº›è½»å¾®çš„ç ´åæ€§æ›´æ”¹ã€‚

é¦–å…ˆï¼Œè¯·ç¡®ä¿æ‚¨çš„æ¨¡å‹åœ¨ä¸€ä¸ª`.py`æ–‡ä»¶ä¸­å®Œå…¨å®šä¹‰ã€‚å®ƒå¯ä»¥ä¾èµ–äºä¸€äº›å…¶ä»–æ–‡ä»¶çš„ç›¸å¯¹å¯¼å…¥ï¼Œåªè¦æ‰€æœ‰æ–‡ä»¶éƒ½åœ¨åŒä¸€ä¸ªç›®å½•ä¸­ï¼ˆæˆ‘ä»¬ç›®å‰è¿˜ä¸æ”¯æŒæ­¤åŠŸèƒ½çš„å­æ¨¡å—ï¼‰ã€‚å¯¹äºæˆ‘ä»¬çš„ç¤ºä¾‹ï¼Œæˆ‘ä»¬å°†åœ¨å½“å‰å·¥ä½œç›®å½•ä¸­çš„ä¸€ä¸ªåä¸º`resnet_model`çš„æ–‡ä»¶å¤¹ä¸­å®šä¹‰ä¸€ä¸ª`modeling_resnet.py`æ–‡ä»¶å’Œä¸€ä¸ª`configuration_resnet.py`æ–‡ä»¶ã€‚é…ç½®æ–‡ä»¶åŒ…å«`ResnetConfig`çš„ä»£ç ï¼Œå»ºæ¨¡æ–‡ä»¶åŒ…å«`ResnetModel`å’Œ`ResnetModelForImageClassification`çš„ä»£ç ã€‚

```py
.
â””â”€â”€ resnet_model
    â”œâ”€â”€ __init__.py
    â”œâ”€â”€ configuration_resnet.py
    â””â”€â”€ modeling_resnet.py
```

`__init__.py`å¯ä»¥ä¸ºç©ºï¼Œåªæ˜¯ä¸ºäº†è®© Python æ£€æµ‹`resnet_model`å¯ä»¥ç”¨ä½œæ¨¡å—ã€‚

å¦‚æœä»åº“ä¸­å¤åˆ¶å»ºæ¨¡æ–‡ä»¶ï¼Œåˆ™éœ€è¦å°†æ–‡ä»¶é¡¶éƒ¨çš„æ‰€æœ‰ç›¸å¯¹å¯¼å…¥æ›¿æ¢ä¸ºä»`transformers`åŒ…å¯¼å…¥ã€‚

è¯·æ³¨æ„ï¼Œæ‚¨å¯ä»¥é‡å¤ä½¿ç”¨ï¼ˆæˆ–å­ç±»åŒ–ï¼‰ç°æœ‰çš„é…ç½®/æ¨¡å‹ã€‚

è¦ä¸ç¤¾åŒºå…±äº«æ‚¨çš„æ¨¡å‹ï¼Œè¯·æŒ‰ç…§ä»¥ä¸‹æ­¥éª¤æ“ä½œï¼šé¦–å…ˆä»æ–°åˆ›å»ºçš„æ–‡ä»¶ä¸­å¯¼å…¥ ResNet æ¨¡å‹å’Œé…ç½®ï¼š

```py
from resnet_model.configuration_resnet import ResnetConfig
from resnet_model.modeling_resnet import ResnetModel, ResnetModelForImageClassification
```

ç„¶åï¼Œå½“ä½¿ç”¨`save_pretrained`æ–¹æ³•æ—¶ï¼Œæ‚¨å¿…é¡»å‘Šè¯‰åº“æ‚¨è¦å¤åˆ¶è¿™äº›å¯¹è±¡çš„ä»£ç æ–‡ä»¶ï¼Œå¹¶ä½¿ç”¨ç»™å®šçš„ Auto ç±»æ­£ç¡®æ³¨å†Œå®ƒä»¬ï¼ˆç‰¹åˆ«æ˜¯å¯¹äºæ¨¡å‹ï¼‰ï¼Œåªéœ€è¿è¡Œï¼š

```py
ResnetConfig.register_for_auto_class()
ResnetModel.register_for_auto_class("AutoModel")
ResnetModelForImageClassification.register_for_auto_class("AutoModelForImageClassification")
```

è¯·æ³¨æ„ï¼Œæ— éœ€ä¸ºé…ç½®æŒ‡å®šè‡ªåŠ¨ç±»ï¼ˆå®ƒä»¬åªæœ‰ä¸€ä¸ªè‡ªåŠ¨ç±»ï¼ŒAutoConfigï¼‰ï¼Œä½†å¯¹äºæ¨¡å‹æ¥è¯´æƒ…å†µä¸åŒã€‚æ‚¨çš„è‡ªå®šä¹‰æ¨¡å‹å¯èƒ½é€‚ç”¨äºè®¸å¤šä¸åŒçš„ä»»åŠ¡ï¼Œå› æ­¤æ‚¨å¿…é¡»æŒ‡å®šå“ªä¸ªè‡ªåŠ¨ç±»æ˜¯æ‚¨æ¨¡å‹çš„æ­£ç¡®ç±»ã€‚

å¦‚æœè¦å°†ä»£ç æ–‡ä»¶å¤åˆ¶ï¼Œå¯ä»¥ä½¿ç”¨`register_for_auto_class()`ã€‚å¦‚æœæ‚¨æ›´å–œæ¬¢ä»å¦ä¸€ä¸ªå­˜å‚¨åº“ä¸­çš„ Hub ä½¿ç”¨ä»£ç ï¼Œåˆ™æ— éœ€è°ƒç”¨å®ƒã€‚åœ¨å­˜åœ¨å¤šä¸ªè‡ªåŠ¨ç±»çš„æƒ…å†µä¸‹ï¼Œå¯ä»¥ç›´æ¥ä¿®æ”¹`config.json`ï¼Œä½¿ç”¨ä»¥ä¸‹ç»“æ„ï¼š

```py
"auto_map": {     
	"AutoConfig": "<your-repo-name>--<config-name>",     
	"AutoModel": "<your-repo-name>--<config-name>",
	"AutoModelFor<Task>": "<your-repo-name>--<config-name>",    
},
```

æ¥ä¸‹æ¥ï¼Œè®©æˆ‘ä»¬åƒä»¥å‰ä¸€æ ·åˆ›å»ºé…ç½®å’Œæ¨¡å‹ï¼š

```py
resnet50d_config = ResnetConfig(block_type="bottleneck", stem_width=32, stem_type="deep", avg_down=True)
resnet50d = ResnetModelForImageClassification(resnet50d_config)

pretrained_model = timm.create_model("resnet50d", pretrained=True)
resnet50d.model.load_state_dict(pretrained_model.state_dict())
```

ç°åœ¨è¦å°†æ¨¡å‹å‘é€åˆ° Hubï¼Œè¯·ç¡®ä¿æ‚¨å·²ç™»å½•ã€‚åœ¨ç»ˆç«¯ä¸­è¿è¡Œï¼š

```py
huggingface-cli login
```

æˆ–è€…ä»ç¬”è®°æœ¬ä¸­ï¼š

```py
from huggingface_hub import notebook_login

notebook_login()
```

ç„¶åï¼Œæ‚¨å¯ä»¥åƒè¿™æ ·æ¨é€åˆ°æ‚¨è‡ªå·±çš„å‘½åç©ºé—´ï¼ˆæˆ–æ‚¨æ˜¯å…¶æˆå‘˜çš„ç»„ç»‡ï¼‰ï¼š

```py
resnet50d.push_to_hub("custom-resnet50d")
```

é™¤äº†ä»¥ json æ ¼å¼å¤åˆ¶å»ºæ¨¡æƒé‡å’Œé…ç½®å¤–ï¼Œè¿˜å°†å»ºæ¨¡å’Œé…ç½®çš„`.py`æ–‡ä»¶å¤åˆ¶åˆ°`custom-resnet50d`æ–‡ä»¶å¤¹ä¸­ï¼Œå¹¶å°†ç»“æœä¸Šä¼ åˆ° Hubã€‚æ‚¨å¯ä»¥åœ¨æ­¤[model repo](https://huggingface.co/sgugger/custom-resnet50d)ä¸­æŸ¥çœ‹ç»“æœã€‚

æœ‰å…³å°†æ¨¡å‹æ¨é€åˆ° Hub çš„æ–¹æ³•çš„æ›´å¤šä¿¡æ¯ï¼Œè¯·å‚é˜…å…±äº«æ•™ç¨‹ã€‚

## ä½¿ç”¨å…·æœ‰è‡ªå®šä¹‰ä»£ç çš„æ¨¡å‹

æ‚¨å¯ä»¥åœ¨å…¶å­˜å‚¨åº“ä¸­ä½¿ç”¨ä»»ä½•é…ç½®ã€æ¨¡å‹æˆ–åˆ†è¯å™¨ä¸è‡ªå®šä¹‰ä»£ç æ–‡ä»¶ï¼Œä½¿ç”¨è‡ªåŠ¨ç±»å’Œ`from_pretrained`æ–¹æ³•ã€‚æ‰€æœ‰ä¸Šä¼ åˆ° Hub çš„æ–‡ä»¶å’Œä»£ç éƒ½ä¼šè¢«æ‰«æä»¥æ£€æµ‹æ¶æ„è½¯ä»¶ï¼ˆæœ‰å…³æ›´å¤šä¿¡æ¯ï¼Œè¯·å‚é˜…[Hub å®‰å…¨](https://huggingface.co/docs/hub/security#malware-scanning)æ–‡æ¡£ï¼‰ï¼Œä½†æ‚¨ä»åº”æŸ¥çœ‹æ¨¡å‹ä»£ç å’Œä½œè€…ï¼Œä»¥é¿å…åœ¨æ‚¨çš„è®¡ç®—æœºä¸Šæ‰§è¡Œæ¶æ„ä»£ç ã€‚è®¾ç½®`trust_remote_code=True`ä»¥ä½¿ç”¨å…·æœ‰è‡ªå®šä¹‰ä»£ç çš„æ¨¡å‹ï¼š

```py
from transformers import AutoModelForImageClassification

model = AutoModelForImageClassification.from_pretrained("sgugger/custom-resnet50d", trust_remote_code=True)
```

å¼ºçƒˆå»ºè®®ä¼ é€’æäº¤å“ˆå¸Œä½œä¸º`revision`ï¼Œä»¥ç¡®ä¿æ¨¡å‹çš„ä½œè€…æ²¡æœ‰ä½¿ç”¨ä¸€äº›æ¶æ„çš„æ–°ä»£ç æ›´æ–°ä»£ç ï¼ˆé™¤éæ‚¨å®Œå…¨ä¿¡ä»»æ¨¡å‹çš„ä½œè€…ï¼‰ã€‚

```py
commit_hash = "ed94a7c6247d8aedce4647f00f20de6875b5b292"
model = AutoModelForImageClassification.from_pretrained(
    "sgugger/custom-resnet50d", trust_remote_code=True, revision=commit_hash
)
```

è¯·æ³¨æ„ï¼Œåœ¨ Hub ä¸Šæµè§ˆæ¨¡å‹å­˜å‚¨åº“çš„æäº¤å†å²æ—¶ï¼Œæœ‰ä¸€ä¸ªæŒ‰é’®å¯ä»¥è½»æ¾å¤åˆ¶ä»»ä½•æäº¤çš„æäº¤å“ˆå¸Œã€‚
