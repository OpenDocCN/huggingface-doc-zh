- en: T2I-Adapter
  id: totrans-0
  prefs:
  - PREF_H1
  type: TYPE_NORMAL
- en: 'Original text: [https://huggingface.co/docs/diffusers/training/t2i_adapters](https://huggingface.co/docs/diffusers/training/t2i_adapters)'
  id: totrans-1
  prefs:
  - PREF_BQ
  type: TYPE_NORMAL
- en: null
  id: totrans-2
  prefs: []
  type: TYPE_NORMAL
- en: '[T2I-Adapter](https://hf.co/papers/2302.08453) is a lightweight adapter model
    that provides an additional conditioning input image (line art, canny, sketch,
    depth, pose) to better control image generation. It is similar to a ControlNet,
    but it is a lot smaller (~77M parameters and ~300MB file size) because its only
    inserts weights into the UNet instead of copying and training it.'
  id: totrans-3
  prefs: []
  type: TYPE_NORMAL
- en: The T2I-Adapter is only available for training with the Stable Diffusion XL
    (SDXL) model.
  id: totrans-4
  prefs: []
  type: TYPE_NORMAL
- en: This guide will explore the [train_t2i_adapter_sdxl.py](https://github.com/huggingface/diffusers/blob/main/examples/t2i_adapter/train_t2i_adapter_sdxl.py)
    training script to help you become familiar with it, and how you can adapt it
    for your own use-case.
  id: totrans-5
  prefs: []
  type: TYPE_NORMAL
- en: 'Before running the script, make sure you install the library from source:'
  id: totrans-6
  prefs: []
  type: TYPE_NORMAL
- en: '[PRE0]'
  id: totrans-7
  prefs: []
  type: TYPE_PRE
  zh: '[PRE0]'
- en: 'Then navigate to the example folder containing the training script and install
    the required dependencies for the script youâ€™re using:'
  id: totrans-8
  prefs: []
  type: TYPE_NORMAL
- en: '[PRE1]'
  id: totrans-9
  prefs: []
  type: TYPE_PRE
  zh: '[PRE1]'
- en: ğŸ¤— Accelerate is a library for helping you train on multiple GPUs/TPUs or with
    mixed-precision. Itâ€™ll automatically configure your training setup based on your
    hardware and environment. Take a look at the ğŸ¤— Accelerate [Quick tour](https://huggingface.co/docs/accelerate/quicktour)
    to learn more.
  id: totrans-10
  prefs: []
  type: TYPE_NORMAL
- en: 'Initialize an ğŸ¤— Accelerate environment:'
  id: totrans-11
  prefs: []
  type: TYPE_NORMAL
- en: '[PRE2]'
  id: totrans-12
  prefs: []
  type: TYPE_PRE
  zh: '[PRE2]'
- en: 'To setup a default ğŸ¤— Accelerate environment without choosing any configurations:'
  id: totrans-13
  prefs: []
  type: TYPE_NORMAL
- en: '[PRE3]'
  id: totrans-14
  prefs: []
  type: TYPE_PRE
  zh: '[PRE3]'
- en: 'Or if your environment doesnâ€™t support an interactive shell, like a notebook,
    you can use:'
  id: totrans-15
  prefs: []
  type: TYPE_NORMAL
- en: '[PRE4]'
  id: totrans-16
  prefs: []
  type: TYPE_PRE
  zh: '[PRE4]'
- en: Lastly, if you want to train a model on your own dataset, take a look at the
    [Create a dataset for training](create_dataset) guide to learn how to create a
    dataset that works with the training script.
  id: totrans-17
  prefs: []
  type: TYPE_NORMAL
- en: The following sections highlight parts of the training script that are important
    for understanding how to modify it, but it doesnâ€™t cover every aspect of the script
    in detail. If youâ€™re interested in learning more, feel free to read through the
    [script](https://github.com/huggingface/diffusers/blob/main/examples/t2i_adapter/train_t2i_adapter_sdxl.py)
    and let us know if you have any questions or concerns.
  id: totrans-18
  prefs: []
  type: TYPE_NORMAL
- en: Script parameters
  id: totrans-19
  prefs:
  - PREF_H2
  type: TYPE_NORMAL
- en: The training script provides many parameters to help you customize your training
    run. All of the parameters and their descriptions are found in the [`parse_args()`](https://github.com/huggingface/diffusers/blob/aab6de22c33cc01fb7bc81c0807d6109e2c998c9/examples/t2i_adapter/train_t2i_adapter_sdxl.py#L233)
    function. It provides default values for each parameter, such as the training
    batch size and learning rate, but you can also set your own values in the training
    command if youâ€™d like.
  id: totrans-20
  prefs: []
  type: TYPE_NORMAL
- en: 'For example, to activate gradient accumulation, add the `--gradient_accumulation_steps`
    parameter to the training command:'
  id: totrans-21
  prefs: []
  type: TYPE_NORMAL
- en: '[PRE5]'
  id: totrans-22
  prefs: []
  type: TYPE_PRE
  zh: '[PRE5]'
- en: 'Many of the basic and important parameters are described in the [Text-to-image](text2image#script-parameters)
    training guide, so this guide just focuses on the relevant T2I-Adapter parameters:'
  id: totrans-23
  prefs: []
  type: TYPE_NORMAL
- en: '`--pretrained_vae_model_name_or_path`: path to a pretrained VAE; the SDXL VAE
    is known to suffer from numerical instability, so this parameter allows you to
    specify a better [VAE](https://huggingface.co/madebyollin/sdxl-vae-fp16-fix)'
  id: totrans-24
  prefs:
  - PREF_UL
  type: TYPE_NORMAL
- en: '`--crops_coords_top_left_h` and `--crops_coords_top_left_w`: height and width
    coordinates to include in SDXLâ€™s crop coordinate embeddings'
  id: totrans-25
  prefs:
  - PREF_UL
  type: TYPE_NORMAL
- en: '`--conditioning_image_column`: the column of the conditioning images in the
    dataset'
  id: totrans-26
  prefs:
  - PREF_UL
  type: TYPE_NORMAL
- en: '`--proportion_empty_prompts`: the proportion of image prompts to replace with
    empty strings'
  id: totrans-27
  prefs:
  - PREF_UL
  type: TYPE_NORMAL
- en: Training script
  id: totrans-28
  prefs:
  - PREF_H2
  type: TYPE_NORMAL
- en: As with the script parameters, a walkthrough of the training script is provided
    in the [Text-to-image](text2image#training-script) training guide. Instead, this
    guide takes a look at the T2I-Adapter relevant parts of the script.
  id: totrans-29
  prefs: []
  type: TYPE_NORMAL
- en: The training script begins by preparing the dataset. This incudes [tokenizing](https://github.com/huggingface/diffusers/blob/aab6de22c33cc01fb7bc81c0807d6109e2c998c9/examples/t2i_adapter/train_t2i_adapter_sdxl.py#L674)
    the prompt and [applying transforms](https://github.com/huggingface/diffusers/blob/aab6de22c33cc01fb7bc81c0807d6109e2c998c9/examples/t2i_adapter/train_t2i_adapter_sdxl.py#L714)
    to the images and conditioning images.
  id: totrans-30
  prefs: []
  type: TYPE_NORMAL
  zh: è®­ç»ƒè„šæœ¬ä»å‡†å¤‡æ•°æ®é›†å¼€å§‹ã€‚è¿™åŒ…æ‹¬[tokenizing](https://github.com/huggingface/diffusers/blob/aab6de22c33cc01fb7bc81c0807d6109e2c998c9/examples/t2i_adapter/train_t2i_adapter_sdxl.py#L674)æç¤ºå’Œ[åº”ç”¨å˜æ¢](https://github.com/huggingface/diffusers/blob/aab6de22c33cc01fb7bc81c0807d6109e2c998c9/examples/t2i_adapter/train_t2i_adapter_sdxl.py#L714)åˆ°å›¾åƒå’Œè°ƒèŠ‚å›¾åƒã€‚
- en: '[PRE6]'
  id: totrans-31
  prefs: []
  type: TYPE_PRE
  zh: '[PRE6]'
- en: 'Within the [`main()`](https://github.com/huggingface/diffusers/blob/aab6de22c33cc01fb7bc81c0807d6109e2c998c9/examples/t2i_adapter/train_t2i_adapter_sdxl.py#L770)
    function, the T2I-Adapter is either loaded from a pretrained adapter or it is
    randomly initialized:'
  id: totrans-32
  prefs: []
  type: TYPE_NORMAL
  zh: åœ¨[`main()`](https://github.com/huggingface/diffusers/blob/aab6de22c33cc01fb7bc81c0807d6109e2c998c9/examples/t2i_adapter/train_t2i_adapter_sdxl.py#L770)å‡½æ•°ä¸­ï¼ŒT2I-Adapterè¦ä¹ˆä»é¢„è®­ç»ƒçš„é€‚é…å™¨åŠ è½½ï¼Œè¦ä¹ˆéšæœºåˆå§‹åŒ–ï¼š
- en: '[PRE7]'
  id: totrans-33
  prefs: []
  type: TYPE_PRE
  zh: '[PRE7]'
- en: 'The [optimizer](https://github.com/huggingface/diffusers/blob/aab6de22c33cc01fb7bc81c0807d6109e2c998c9/examples/t2i_adapter/train_t2i_adapter_sdxl.py#L952)
    is initialized for the T2I-Adapter parameters:'
  id: totrans-34
  prefs: []
  type: TYPE_NORMAL
  zh: '[optimizer](https://github.com/huggingface/diffusers/blob/aab6de22c33cc01fb7bc81c0807d6109e2c998c9/examples/t2i_adapter/train_t2i_adapter_sdxl.py#L952)å·²åˆå§‹åŒ–ä¸ºT2I-Adapterå‚æ•°ï¼š'
- en: '[PRE8]'
  id: totrans-35
  prefs: []
  type: TYPE_PRE
  zh: '[PRE8]'
- en: 'Lastly, in the [training loop](https://github.com/huggingface/diffusers/blob/aab6de22c33cc01fb7bc81c0807d6109e2c998c9/examples/t2i_adapter/train_t2i_adapter_sdxl.py#L1086),
    the adapter conditioning image and the text embeddings are passed to the UNet
    to predict the noise residual:'
  id: totrans-36
  prefs: []
  type: TYPE_NORMAL
  zh: æœ€åï¼Œåœ¨[training loop](https://github.com/huggingface/diffusers/blob/aab6de22c33cc01fb7bc81c0807d6109e2c998c9/examples/t2i_adapter/train_t2i_adapter_sdxl.py#L1086)ä¸­ï¼Œé€‚é…å™¨è°ƒèŠ‚å›¾åƒå’Œæ–‡æœ¬åµŒå…¥è¢«ä¼ é€’ç»™UNetä»¥é¢„æµ‹å™ªå£°æ®‹å·®ï¼š
- en: '[PRE9]'
  id: totrans-37
  prefs: []
  type: TYPE_PRE
  zh: '[PRE9]'
- en: If you want to learn more about how the training loop works, check out the [Understanding
    pipelines, models and schedulers](../using-diffusers/write_own_pipeline) tutorial
    which breaks down the basic pattern of the denoising process.
  id: totrans-38
  prefs: []
  type: TYPE_NORMAL
  zh: å¦‚æœæ‚¨æƒ³äº†è§£è®­ç»ƒå¾ªç¯çš„å·¥ä½œåŸç†ï¼Œè¯·æŸ¥çœ‹[Understanding pipelines, models and schedulers](../using-diffusers/write_own_pipeline)æ•™ç¨‹ï¼Œè¯¥æ•™ç¨‹è§£æäº†å»å™ªè¿‡ç¨‹çš„åŸºæœ¬æ¨¡å¼ã€‚
- en: Launch the script
  id: totrans-39
  prefs:
  - PREF_H2
  type: TYPE_NORMAL
  zh: å¯åŠ¨è„šæœ¬
- en: Now youâ€™re ready to launch the training script! ğŸš€
  id: totrans-40
  prefs: []
  type: TYPE_NORMAL
  zh: ç°åœ¨æ‚¨å·²ç»å‡†å¤‡å¥½å¯åŠ¨è®­ç»ƒè„šæœ¬äº†ï¼ğŸš€
- en: For this example training, youâ€™ll use the [fusing/fill50k](https://huggingface.co/datasets/fusing/fill50k)
    dataset. You can also create and use your own dataset if you want (see the [Create
    a dataset for training](https://moon-ci-docs.huggingface.co/docs/diffusers/pr_5512/en/training/create_dataset)
    guide).
  id: totrans-41
  prefs: []
  type: TYPE_NORMAL
  zh: å¯¹äºè¿™ä¸ªç¤ºä¾‹è®­ç»ƒï¼Œæ‚¨å°†ä½¿ç”¨[fusing/fill50k](https://huggingface.co/datasets/fusing/fill50k)æ•°æ®é›†ã€‚å¦‚æœæ‚¨æ„¿æ„ï¼Œæ‚¨ä¹Ÿå¯ä»¥åˆ›å»ºå¹¶ä½¿ç”¨è‡ªå·±çš„æ•°æ®é›†ï¼ˆè¯·å‚é˜…[Create
    a dataset for training](https://moon-ci-docs.huggingface.co/docs/diffusers/pr_5512/en/training/create_dataset)æŒ‡å—ï¼‰ã€‚
- en: Set the environment variable `MODEL_DIR` to a model id on the Hub or a path
    to a local model and `OUTPUT_DIR` to where you want to save the model.
  id: totrans-42
  prefs: []
  type: TYPE_NORMAL
  zh: å°†ç¯å¢ƒå˜é‡`MODEL_DIR`è®¾ç½®ä¸ºHubä¸Šçš„æ¨¡å‹IDæˆ–æœ¬åœ°æ¨¡å‹çš„è·¯å¾„ï¼Œå°†`OUTPUT_DIR`è®¾ç½®ä¸ºæ‚¨æƒ³è¦ä¿å­˜æ¨¡å‹çš„ä½ç½®ã€‚
- en: 'Download the following images to condition your training with:'
  id: totrans-43
  prefs: []
  type: TYPE_NORMAL
  zh: ä¸‹è½½ä»¥ä¸‹å›¾åƒä»¥è°ƒèŠ‚æ‚¨çš„è®­ç»ƒï¼š
- en: '[PRE10]'
  id: totrans-44
  prefs: []
  type: TYPE_PRE
  zh: '[PRE10]'
- en: To monitor training progress with Weights & Biases, add the `--report_to=wandb`
    parameter to the training command. Youâ€™ll also need to add the `--validation_image`,
    `--validation_prompt`, and `--validation_steps` to the training command to keep
    track of results. This can be really useful for debugging the model and viewing
    intermediate results.
  id: totrans-45
  prefs: []
  type: TYPE_NORMAL
  zh: ä½¿ç”¨Weights & Biasesç›‘æ§è®­ç»ƒè¿›åº¦ï¼Œå°†`--report_to=wandb`å‚æ•°æ·»åŠ åˆ°è®­ç»ƒå‘½ä»¤ä¸­ã€‚æ‚¨è¿˜éœ€è¦å°†`--validation_image`ï¼Œ`--validation_prompt`å’Œ`--validation_steps`æ·»åŠ åˆ°è®­ç»ƒå‘½ä»¤ä¸­ä»¥è·Ÿè¸ªç»“æœã€‚è¿™å¯¹äºè°ƒè¯•æ¨¡å‹å’ŒæŸ¥çœ‹ä¸­é—´ç»“æœéå¸¸æœ‰ç”¨ã€‚
- en: '[PRE11]'
  id: totrans-46
  prefs: []
  type: TYPE_PRE
  zh: '[PRE11]'
- en: 'Once training is complete, you can use your T2I-Adapter for inference:'
  id: totrans-47
  prefs: []
  type: TYPE_NORMAL
  zh: è®­ç»ƒå®Œæˆåï¼Œæ‚¨å¯ä»¥ä½¿ç”¨æ‚¨çš„T2I-Adapterè¿›è¡Œæ¨æ–­ã€‚
- en: '[PRE12]'
  id: totrans-48
  prefs: []
  type: TYPE_PRE
  zh: '[PRE12]'
- en: Next steps
  id: totrans-49
  prefs:
  - PREF_H2
  type: TYPE_NORMAL
  zh: ä¸‹ä¸€æ­¥
- en: 'Congratulations on training a T2I-Adapter model! ğŸ‰ To learn more:'
  id: totrans-50
  prefs: []
  type: TYPE_NORMAL
  zh: æ­å–œæ‚¨è®­ç»ƒäº†ä¸€ä¸ªT2I-Adapteræ¨¡å‹ï¼ğŸ‰ è¦äº†è§£æ›´å¤šï¼š
- en: Read the [Efficient Controllable Generation for SDXL with T2I-Adapters](https://huggingface.co/blog/t2i-sdxl-adapters)
    blog post to learn more details about the experimental results from the T2I-Adapter
    team.
  id: totrans-51
  prefs:
  - PREF_UL
  type: TYPE_NORMAL
  zh: é˜…è¯»[Efficient Controllable Generation for SDXL with T2I-Adapters](https://huggingface.co/blog/t2i-sdxl-adapters)åšæ–‡ï¼Œäº†è§£T2I-Adapterå›¢é˜Ÿçš„å®éªŒç»“æœçš„æ›´å¤šç»†èŠ‚ã€‚
