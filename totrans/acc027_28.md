# IntelÂ® PyTorchæ‰©å±•

> åŸæ–‡ï¼š[https://huggingface.co/docs/accelerate/usage_guides/ipex](https://huggingface.co/docs/accelerate/usage_guides/ipex)

[IPEX](https://github.com/intel/intel-extension-for-pytorch)ç»è¿‡ä¼˜åŒ–ï¼Œé€‚ç”¨äºå…·æœ‰AVX-512æˆ–æ›´é«˜ç‰ˆæœ¬çš„CPUï¼Œå¹¶ä¸”åœ¨ä»…å…·æœ‰AVX2çš„CPUä¸Šä¹Ÿå¯ä»¥æ­£å¸¸è¿è¡Œã€‚å› æ­¤ï¼Œé¢„è®¡åœ¨å…·æœ‰AVX-512æˆ–æ›´é«˜ç‰ˆæœ¬çš„Intel CPUä»£æ•°ä¸Šä¼šå¸¦æ¥æ€§èƒ½ä¼˜åŠ¿ï¼Œè€Œä»…å…·æœ‰AVX2çš„CPUï¼ˆä¾‹å¦‚AMD CPUæˆ–è¾ƒæ—§çš„Intel CPUï¼‰åœ¨IPEXä¸‹å¯èƒ½ä¼šè·å¾—æ›´å¥½çš„æ€§èƒ½ï¼Œä½†ä¸èƒ½ä¿è¯ã€‚IPEXä¸ºä½¿ç”¨Float32å’ŒBFloat16è¿›è¡ŒCPUè®­ç»ƒæä¾›äº†æ€§èƒ½ä¼˜åŒ–ã€‚ä»¥ä¸‹éƒ¨åˆ†ä¸»è¦å…³æ³¨BFloat16çš„ä½¿ç”¨ã€‚

ä½ç²¾åº¦æ•°æ®ç±»å‹BFloat16å·²ç»åœ¨ç¬¬ä¸‰ä»£XeonÂ® Scalableå¤„ç†å™¨ï¼ˆä¹Ÿç§°ä¸ºCooper Lakeï¼‰ä¸Šæœ¬åœ°æ”¯æŒï¼Œå…·æœ‰AVX512æŒ‡ä»¤é›†ï¼Œå¹¶å°†åœ¨ä¸‹ä¸€ä»£IntelÂ® XeonÂ® Scalableå¤„ç†å™¨ä¸Šæ”¯æŒï¼Œå…·æœ‰IntelÂ® Advanced Matrix Extensionsï¼ˆIntelÂ® AMXï¼‰æŒ‡ä»¤é›†ï¼Œè¿›ä¸€æ­¥æé«˜æ€§èƒ½ã€‚è‡ªPyTorch-1.10ä»¥æ¥ï¼ŒCPUåç«¯çš„è‡ªåŠ¨æ··åˆç²¾åº¦å·²ç»å¯ç”¨ã€‚åŒæ—¶ï¼Œåœ¨IntelÂ® PyTorchæ‰©å±•ä¸­ï¼Œå·²ç»å¤§è§„æ¨¡å¯ç”¨äº†CPUå’ŒBFloat16ä¼˜åŒ–è¿ç®—ç¬¦çš„è‡ªåŠ¨æ··åˆç²¾åº¦ï¼Œå¹¶éƒ¨åˆ†ä¸Šæ¸¸åˆ°PyTorchä¸»åˆ†æ”¯ã€‚ç”¨æˆ·å¯ä»¥é€šè¿‡IPEXè‡ªåŠ¨æ··åˆç²¾åº¦è·å¾—æ›´å¥½çš„æ€§èƒ½å’Œç”¨æˆ·ä½“éªŒã€‚

## IPEXå®‰è£…ï¼š

IPEXå‘å¸ƒéµå¾ªPyTorchç‰ˆæœ¬ï¼Œå¯ä»¥é€šè¿‡pipè¿›è¡Œå®‰è£…ï¼š

| PyTorchç‰ˆæœ¬ | IPEXç‰ˆæœ¬ |
| :-: | :-: |
| 2.0 | 2.0.0 |
| 1.13 | 1.13.0 |
| 1.12 | 1.12.300 |
| 1.11 | 1.11.200 |
| 1.10 | 1.10.100 |

```py
pip install intel_extension_for_pytorch==<version_name> -f https://developer.intel.com/ipex-whl-stable-cpu
```

æŸ¥çœ‹æ›´å¤š[IPEXå®‰è£…æ–¹æ³•](https://intel.github.io/intel-extension-for-pytorch/cpu/latest/tutorials/installation.html)ã€‚

## CPUè®­ç»ƒä¼˜åŒ–çš„å·¥ä½œåŸç†

ğŸ¤— Accelerateå·²ç»é›†æˆäº†[IPEX](https://github.com/intel/intel-extension-for-pytorch)ï¼Œæ‚¨åªéœ€è¦é€šè¿‡é…ç½®å¯ç”¨å®ƒã€‚

**åœºæ™¯1**ï¼šæ— åˆ†å¸ƒå¼CPUè®­ç»ƒåŠ é€Ÿ

åœ¨æ‚¨çš„æœºå™¨ä¸Šè¿è¡Œaccelerate configï¼š

```py
$ accelerate config
-----------------------------------------------------------------------------------------------------------------------------------------------------------
In which compute environment are you running?
This machine
-----------------------------------------------------------------------------------------------------------------------------------------------------------
Which type of machine are you using?
No distributed training
Do you want to run your training on CPU only (even if a GPU / Apple Silicon device is available)? [yes/NO]:yes
Do you want to use Intel PyTorch Extension (IPEX) to speed up training on CPU? [yes/NO]:yes
Do you wish to optimize your script with torch dynamo?[yes/NO]:NO
Do you want to use DeepSpeed? [yes/NO]: NO
-----------------------------------------------------------------------------------------------------------------------------------------------------------
Do you wish to use FP16 or BF16 (mixed precision)?
bf16
```

è¿™å°†ç”Ÿæˆä¸€ä¸ªé…ç½®æ–‡ä»¶ï¼Œå°†è‡ªåŠ¨ç”¨äºåœ¨è¿›è¡Œæ—¶æ­£ç¡®è®¾ç½®é»˜è®¤é€‰é¡¹

```py
accelerate launch my_script.py --args_to_my_script
```

ä¾‹å¦‚ï¼Œè¿™æ˜¯å¦‚ä½•åœ¨å¯ç”¨IPEXçš„æƒ…å†µä¸‹è¿è¡ŒNLPç¤ºä¾‹`examples/nlp_example.py`ï¼ˆä»å­˜å‚¨åº“çš„æ ¹ç›®å½•ï¼‰çš„æ–¹æ³•ã€‚åœ¨`accelerate config`ä¹‹åç”Ÿæˆçš„default_config.yaml

```py
compute_environment: LOCAL_MACHINE
distributed_type: 'NO'
downcast_bf16: 'no'
ipex_config:
  ipex: true
machine_rank: 0
main_training_function: main
mixed_precision: bf16
num_machines: 1
num_processes: 1
rdzv_backend: static
same_network: true
tpu_env: []
tpu_use_cluster: false
tpu_use_sudo: false
use_cpu: true
```

```py
accelerate launch examples/nlp_example.py
```

**åœºæ™¯2**ï¼šåˆ†å¸ƒå¼CPUè®­ç»ƒåŠ é€Ÿï¼Œæˆ‘ä»¬ä½¿ç”¨Intel oneCCLè¿›è¡Œé€šä¿¡ï¼Œç»“åˆIntelÂ® MPIåº“åœ¨IntelÂ®æ¶æ„ä¸Šæä¾›çµæ´»ã€é«˜æ•ˆã€å¯æ‰©å±•çš„é›†ç¾¤æ¶ˆæ¯ä¼ é€’ã€‚æ‚¨å¯ä»¥å‚è€ƒ[è¿™é‡Œ](https://huggingface.co/docs/transformers/perf_train_cpu_many)è¿›è¡Œå®‰è£…æŒ‡å—

åœ¨æ‚¨çš„æœºå™¨ä¸Šè¿è¡Œaccelerate configï¼ˆnode0ï¼‰ï¼š

```py
$ accelerate config
-----------------------------------------------------------------------------------------------------------------------------------------------------------
In which compute environment are you running?
This machine
-----------------------------------------------------------------------------------------------------------------------------------------------------------
Which type of machine are you using?
multi-CPU
How many different machines will you use (use more than 1 for multi-node training)? [1]: 4
-----------------------------------------------------------------------------------------------------------------------------------------------------------
What is the rank of this machine?
0
What is the IP address of the machine that will host the main process? 36.112.23.24
What is the port you will use to communicate with the main process? 29500
Are all the machines on the same local network? Answer `no` if nodes are on the cloud and/or on different network hosts [YES/no]: yes
Do you want to use Intel PyTorch Extension (IPEX) to speed up training on CPU? [yes/NO]:yes
Do you wish to optimize your script with torch dynamo?[yes/NO]:NO
How many CPU(s) should be used for distributed training? [1]:16
-----------------------------------------------------------------------------------------------------------------------------------------------------------
Do you wish to use FP16 or BF16 (mixed precision)?
bf16
```

ä¾‹å¦‚ï¼Œè¿™æ˜¯å¦‚ä½•åœ¨å¯ç”¨IPEXçš„æƒ…å†µä¸‹è¿è¡ŒNLPç¤ºä¾‹`examples/nlp_example.py`ï¼ˆä»å­˜å‚¨åº“çš„æ ¹ç›®å½•ï¼‰è¿›è¡Œåˆ†å¸ƒå¼CPUè®­ç»ƒçš„æ–¹æ³•ã€‚

åœ¨`accelerate config`ä¹‹åç”Ÿæˆçš„default_config.yaml

```py
compute_environment: LOCAL_MACHINE
distributed_type: MULTI_CPU
downcast_bf16: 'no'
ipex_config:
  ipex: true
machine_rank: 0
main_process_ip: 36.112.23.24
main_process_port: 29500
main_training_function: main
mixed_precision: bf16
num_machines: 4
num_processes: 16
rdzv_backend: static
same_network: true
tpu_env: []
tpu_use_cluster: false
tpu_use_sudo: false
use_cpu: true
```

è®¾ç½®ä»¥ä¸‹ç¯å¢ƒå¹¶ä½¿ç”¨Intel MPIå¯åŠ¨è®­ç»ƒ

åœ¨node0ä¸­ï¼Œæ‚¨éœ€è¦åˆ›å»ºä¸€ä¸ªåŒ…å«æ¯ä¸ªèŠ‚ç‚¹IPåœ°å€çš„é…ç½®æ–‡ä»¶ï¼ˆä¾‹å¦‚hostfileï¼‰ï¼Œå¹¶å°†è¯¥é…ç½®æ–‡ä»¶è·¯å¾„ä½œä¸ºå‚æ•°ä¼ é€’ã€‚

```py
$ cat hostfile
xxx.xxx.xxx.xxx #node0 ip
xxx.xxx.xxx.xxx #node1 ip
xxx.xxx.xxx.xxx #node2 ip
xxx.xxx.xxx.xxx #node3 ip
```

ç°åœ¨ï¼Œåœ¨node0ä¸­è¿è¡Œä»¥ä¸‹å‘½ä»¤ï¼Œå°†åœ¨node0ã€node1ã€node2ã€node3ä¸­å¯ç”¨**16DDP**ï¼Œå¹¶ä½¿ç”¨BF16æ··åˆç²¾åº¦ï¼š

```py
oneccl_bindings_for_pytorch_path=$(python -c "from oneccl_bindings_for_pytorch import cwd; print(cwd)")
source $oneccl_bindings_for_pytorch_path/env/setvars.sh
export CCL_WORKER_COUNT=1
export MASTER_ADDR=xxx.xxx.xxx.xxx #node0 ip
export CCL_ATL_TRANSPORT=ofi
mpirun -f hostfile -n 16 -ppn 4 accelerate launch examples/nlp_example.py
```

## ç›¸å…³èµ„æº

+   [é¡¹ç›®çš„github](https://github.com/intel/intel-extension-for-pytorch)

+   [APIæ–‡æ¡£](https://intel.github.io/intel-extension-for-pytorch/cpu/latest/tutorials/api_doc.html)

+   [è°ƒä¼˜æŒ‡å—](https://intel.github.io/intel-extension-for-pytorch/cpu/latest/tutorials/performance_tuning/tuning_guide.html)

+   [åšå®¢å’Œå‡ºç‰ˆç‰©](https://intel.github.io/intel-extension-for-pytorch/cpu/latest/tutorials/blogs_publications.html)
