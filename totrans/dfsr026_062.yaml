- en: ControlNet
  id: totrans-0
  prefs:
  - PREF_H1
  type: TYPE_NORMAL
  zh: ControlNet
- en: 'Original text: [https://huggingface.co/docs/diffusers/training/controlnet](https://huggingface.co/docs/diffusers/training/controlnet)'
  id: totrans-1
  prefs:
  - PREF_BQ
  type: TYPE_NORMAL
  zh: åŸæ–‡é“¾æ¥ï¼š[https://huggingface.co/docs/diffusers/training/controlnet](https://huggingface.co/docs/diffusers/training/controlnet)
- en: null
  id: totrans-2
  prefs: []
  type: TYPE_NORMAL
- en: '[ControlNet](https://hf.co/papers/2302.05543) models are adapters trained on
    top of another pretrained model. It allows for a greater degree of control over
    image generation by conditioning the model with an additional input image. The
    input image can be a canny edge, depth map, human pose, and many more.'
  id: totrans-3
  prefs: []
  type: TYPE_NORMAL
  zh: '[ControlNet](https://hf.co/papers/2302.05543)æ¨¡å‹æ˜¯åœ¨å¦ä¸€ä¸ªé¢„è®­ç»ƒæ¨¡å‹ä¹‹ä¸Šè®­ç»ƒçš„é€‚é…å™¨ã€‚å®ƒé€šè¿‡ä½¿ç”¨é¢å¤–çš„è¾“å…¥å›¾åƒå¯¹æ¨¡å‹è¿›è¡Œæ¡ä»¶åŒ–ï¼Œä»è€Œå…è®¸æ›´å¤§ç¨‹åº¦ä¸Šæ§åˆ¶å›¾åƒç”Ÿæˆã€‚è¾“å…¥å›¾åƒå¯ä»¥æ˜¯cannyè¾¹ç¼˜ã€æ·±åº¦å›¾ã€äººä½“å§¿åŠ¿ç­‰ã€‚'
- en: If youâ€™re training on a GPU with limited vRAM, you should try enabling the `gradient_checkpointing`,
    `gradient_accumulation_steps`, and `mixed_precision` parameters in the training
    command. You can also reduce your memory footprint by using memory-efficient attention
    with [xFormers](../optimization/xformers). JAX/Flax training is also supported
    for efficient training on TPUs and GPUs, but it doesnâ€™t support gradient checkpointing
    or xFormers. You should have a GPU with >30GB of memory if you want to train faster
    with Flax.
  id: totrans-4
  prefs: []
  type: TYPE_NORMAL
  zh: å¦‚æœæ‚¨åœ¨å…·æœ‰æœ‰é™vRAMçš„GPUä¸Šè¿›è¡Œè®­ç»ƒï¼Œæ‚¨åº”è¯¥å°è¯•åœ¨è®­ç»ƒå‘½ä»¤ä¸­å¯ç”¨`gradient_checkpointing`ã€`gradient_accumulation_steps`å’Œ`mixed_precision`å‚æ•°ã€‚æ‚¨è¿˜å¯ä»¥é€šè¿‡ä½¿ç”¨[xFormers](../optimization/xformers)ä¸­çš„å†…å­˜é«˜æ•ˆæ³¨æ„åŠ›æ¥å‡å°‘å†…å­˜å ç”¨ã€‚JAX/Flaxè®­ç»ƒä¹Ÿæ”¯æŒåœ¨TPUå’ŒGPUä¸Šè¿›è¡Œé«˜æ•ˆè®­ç»ƒï¼Œä½†ä¸æ”¯æŒæ¢¯åº¦æ£€æŸ¥ç‚¹æˆ–xFormersã€‚å¦‚æœæ‚¨æƒ³è¦ä½¿ç”¨Flaxæ›´å¿«åœ°è¿›è¡Œè®­ç»ƒï¼Œæ‚¨åº”è¯¥æ‹¥æœ‰å¤§äº30GBå†…å­˜çš„GPUã€‚
- en: This guide will explore the [train_controlnet.py](https://github.com/huggingface/diffusers/blob/main/examples/controlnet/train_controlnet.py)
    training script to help you become familiar with it, and how you can adapt it
    for your own use-case.
  id: totrans-5
  prefs: []
  type: TYPE_NORMAL
  zh: æœ¬æŒ‡å—å°†æ¢è®¨[train_controlnet.py](https://github.com/huggingface/diffusers/blob/main/examples/controlnet/train_controlnet.py)è®­ç»ƒè„šæœ¬ï¼Œä»¥å¸®åŠ©æ‚¨ç†Ÿæ‚‰å®ƒï¼Œä»¥åŠå¦‚ä½•ä¸ºæ‚¨è‡ªå·±çš„ç”¨ä¾‹è¿›è¡Œè°ƒæ•´ã€‚
- en: 'Before running the script, make sure you install the library from source:'
  id: totrans-6
  prefs: []
  type: TYPE_NORMAL
  zh: åœ¨è¿è¡Œè„šæœ¬ä¹‹å‰ï¼Œè¯·ç¡®ä¿æ‚¨ä»æºä»£ç å®‰è£…åº“ï¼š
- en: '[PRE0]'
  id: totrans-7
  prefs: []
  type: TYPE_PRE
  zh: '[PRE0]'
- en: 'Then navigate to the example folder containing the training script and install
    the required dependencies for the script youâ€™re using:'
  id: totrans-8
  prefs: []
  type: TYPE_NORMAL
  zh: ç„¶åè½¬åˆ°åŒ…å«è®­ç»ƒè„šæœ¬çš„ç¤ºä¾‹æ–‡ä»¶å¤¹ï¼Œå¹¶å®‰è£…æ‚¨æ­£åœ¨ä½¿ç”¨çš„è„šæœ¬æ‰€éœ€çš„ä¾èµ–é¡¹ï¼š
- en: PyTorchFlax
  id: totrans-9
  prefs: []
  type: TYPE_NORMAL
  zh: PyTorchFlax
- en: '[PRE1]'
  id: totrans-10
  prefs: []
  type: TYPE_PRE
  zh: '[PRE1]'
- en: ğŸ¤— Accelerate is a library for helping you train on multiple GPUs/TPUs or with
    mixed-precision. Itâ€™ll automatically configure your training setup based on your
    hardware and environment. Take a look at the ğŸ¤— Accelerate [Quick tour](https://huggingface.co/docs/accelerate/quicktour)
    to learn more.
  id: totrans-11
  prefs: []
  type: TYPE_NORMAL
  zh: ğŸ¤— Accelerateæ˜¯ä¸€ä¸ªå¸®åŠ©æ‚¨åœ¨å¤šä¸ªGPU/TPUä¸Šè®­ç»ƒæˆ–ä½¿ç”¨æ··åˆç²¾åº¦çš„åº“ã€‚å®ƒå°†æ ¹æ®æ‚¨çš„ç¡¬ä»¶å’Œç¯å¢ƒè‡ªåŠ¨é…ç½®æ‚¨çš„è®­ç»ƒè®¾ç½®ã€‚æŸ¥çœ‹ğŸ¤— Accelerate
    [å¿«é€Ÿå…¥é—¨](https://huggingface.co/docs/accelerate/quicktour)ä»¥äº†è§£æ›´å¤šä¿¡æ¯ã€‚
- en: 'Initialize an ğŸ¤— Accelerate environment:'
  id: totrans-12
  prefs: []
  type: TYPE_NORMAL
  zh: åˆå§‹åŒ–ğŸ¤— Accelerateç¯å¢ƒï¼š
- en: '[PRE2]'
  id: totrans-13
  prefs: []
  type: TYPE_PRE
  zh: '[PRE2]'
- en: 'To setup a default ğŸ¤— Accelerate environment without choosing any configurations:'
  id: totrans-14
  prefs: []
  type: TYPE_NORMAL
  zh: åœ¨ä¸é€‰æ‹©ä»»ä½•é…ç½®çš„æƒ…å†µä¸‹è®¾ç½®é»˜è®¤çš„ğŸ¤— Accelerateç¯å¢ƒï¼š
- en: '[PRE3]'
  id: totrans-15
  prefs: []
  type: TYPE_PRE
  zh: '[PRE3]'
- en: 'Or if your environment doesnâ€™t support an interactive shell, like a notebook,
    you can use:'
  id: totrans-16
  prefs: []
  type: TYPE_NORMAL
  zh: æˆ–è€…ï¼Œå¦‚æœæ‚¨çš„ç¯å¢ƒä¸æ”¯æŒäº¤äº’å¼shellï¼Œæ¯”å¦‚ç¬”è®°æœ¬ï¼Œæ‚¨å¯ä»¥ä½¿ç”¨ï¼š
- en: '[PRE4]'
  id: totrans-17
  prefs: []
  type: TYPE_PRE
  zh: '[PRE4]'
- en: Lastly, if you want to train a model on your own dataset, take a look at the
    [Create a dataset for training](create_dataset) guide to learn how to create a
    dataset that works with the training script.
  id: totrans-18
  prefs: []
  type: TYPE_NORMAL
  zh: æœ€åï¼Œå¦‚æœæ‚¨æƒ³åœ¨è‡ªå·±çš„æ•°æ®é›†ä¸Šè®­ç»ƒæ¨¡å‹ï¼Œè¯·æŸ¥çœ‹[åˆ›å»ºç”¨äºè®­ç»ƒçš„æ•°æ®é›†](create_dataset)æŒ‡å—ï¼Œäº†è§£å¦‚ä½•åˆ›å»ºé€‚ç”¨äºè®­ç»ƒè„šæœ¬çš„æ•°æ®é›†ã€‚
- en: The following sections highlight parts of the training script that are important
    for understanding how to modify it, but it doesnâ€™t cover every aspect of the script
    in detail. If youâ€™re interested in learning more, feel free to read through the
    [script](https://github.com/huggingface/diffusers/blob/main/examples/controlnet/train_controlnet.py)
    and let us know if you have any questions or concerns.
  id: totrans-19
  prefs: []
  type: TYPE_NORMAL
  zh: ä»¥ä¸‹éƒ¨åˆ†çªå‡ºäº†è®­ç»ƒè„šæœ¬çš„é‡è¦éƒ¨åˆ†ï¼Œä»¥ä¾¿äº†è§£å¦‚ä½•ä¿®æ”¹å®ƒï¼Œä½†å¹¶æœªè¯¦ç»†æ¶µç›–è„šæœ¬çš„æ¯ä¸ªæ–¹é¢ã€‚å¦‚æœæ‚¨æœ‰å…´è¶£äº†è§£æ›´å¤šï¼Œè¯·éšæ—¶é˜…è¯»[è„šæœ¬](https://github.com/huggingface/diffusers/blob/main/examples/controlnet/train_controlnet.py)ï¼Œå¦‚æœæ‚¨æœ‰ä»»ä½•é—®é¢˜æˆ–ç–‘è™‘ï¼Œè¯·å‘Šè¯‰æˆ‘ä»¬ã€‚
- en: Script parameters
  id: totrans-20
  prefs:
  - PREF_H2
  type: TYPE_NORMAL
  zh: è„šæœ¬å‚æ•°
- en: The training script provides many parameters to help you customize your training
    run. All of the parameters and their descriptions are found in the [`parse_args()`](https://github.com/huggingface/diffusers/blob/64603389da01082055a901f2883c4810d1144edb/examples/controlnet/train_controlnet.py#L231)
    function. This function provides default values for each parameter, such as the
    training batch size and learning rate, but you can also set your own values in
    the training command if youâ€™d like.
  id: totrans-21
  prefs: []
  type: TYPE_NORMAL
  zh: è®­ç»ƒè„šæœ¬æä¾›äº†è®¸å¤šå‚æ•°ï¼Œå¸®åŠ©æ‚¨è‡ªå®šä¹‰è®­ç»ƒè¿è¡Œã€‚æ‰€æœ‰å‚æ•°åŠå…¶æè¿°éƒ½å¯ä»¥åœ¨[`parse_args()`](https://github.com/huggingface/diffusers/blob/64603389da01082055a901f2883c4810d1144edb/examples/controlnet/train_controlnet.py#L231)å‡½æ•°ä¸­æ‰¾åˆ°ã€‚è¯¥å‡½æ•°ä¸ºæ¯ä¸ªå‚æ•°æä¾›äº†é»˜è®¤å€¼ï¼Œå¦‚è®­ç»ƒæ‰¹é‡å¤§å°å’Œå­¦ä¹ ç‡ï¼Œä½†å¦‚æœæ‚¨æ„¿æ„ï¼Œä¹Ÿå¯ä»¥åœ¨è®­ç»ƒå‘½ä»¤ä¸­è®¾ç½®è‡ªå·±çš„å€¼ã€‚
- en: 'For example, to speedup training with mixed precision using the fp16 format,
    add the `--mixed_precision` parameter to the training command:'
  id: totrans-22
  prefs: []
  type: TYPE_NORMAL
  zh: ä¾‹å¦‚ï¼Œä¸ºäº†åŠ å¿«ä½¿ç”¨fp16æ ¼å¼çš„æ··åˆç²¾åº¦è¿›è¡Œè®­ç»ƒï¼Œè¯·åœ¨è®­ç»ƒå‘½ä»¤ä¸­æ·»åŠ `--mixed_precision`å‚æ•°ï¼š
- en: '[PRE5]'
  id: totrans-23
  prefs: []
  type: TYPE_PRE
  zh: '[PRE5]'
- en: 'Many of the basic and important parameters are described in the [Text-to-image](text2image#script-parameters)
    training guide, so this guide just focuses on the relevant parameters for ControlNet:'
  id: totrans-24
  prefs: []
  type: TYPE_NORMAL
  zh: è®¸å¤šåŸºæœ¬å’Œé‡è¦å‚æ•°åœ¨[æ–‡æœ¬åˆ°å›¾åƒ](text2image#script-parameters)è®­ç»ƒæŒ‡å—ä¸­æœ‰æè¿°ï¼Œå› æ­¤æœ¬æŒ‡å—åªå…³æ³¨ControlNetçš„ç›¸å…³å‚æ•°ï¼š
- en: '`--max_train_samples`: the number of training samples; this can be lowered
    for faster training, but if you want to stream really large datasets, youâ€™ll need
    to include this parameter and the `--streaming` parameter in your training command'
  id: totrans-25
  prefs:
  - PREF_UL
  type: TYPE_NORMAL
  zh: '`--max_train_samples`ï¼šè®­ç»ƒæ ·æœ¬çš„æ•°é‡ï¼›è¿™å¯ä»¥é™ä½ä»¥åŠ å¿«è®­ç»ƒé€Ÿåº¦ï¼Œä½†å¦‚æœæ‚¨æƒ³è¦æµå¼ä¼ è¾“éå¸¸å¤§çš„æ•°æ®é›†ï¼Œæ‚¨éœ€è¦åœ¨è®­ç»ƒå‘½ä»¤ä¸­åŒ…å«æ­¤å‚æ•°å’Œ`--streaming`å‚æ•°'
- en: '`--gradient_accumulation_steps`: number of update steps to accumulate before
    the backward pass; this allows you to train with a bigger batch size than your
    GPU memory can typically handle'
  id: totrans-26
  prefs:
  - PREF_UL
  type: TYPE_NORMAL
  zh: '`--gradient_accumulation_steps`ï¼šåœ¨å‘åä¼ é€’ä¹‹å‰ç´¯ç§¯çš„æ›´æ–°æ­¥éª¤æ•°ï¼›è¿™ä½¿æ‚¨å¯ä»¥ä½¿ç”¨æ¯”GPUå†…å­˜é€šå¸¸å¤„ç†çš„æ›´å¤§æ‰¹é‡å¤§å°è¿›è¡Œè®­ç»ƒ'
- en: Min-SNR weighting
  id: totrans-27
  prefs:
  - PREF_H3
  type: TYPE_NORMAL
  zh: Min-SNRåŠ æƒ
- en: The [Min-SNR](https://huggingface.co/papers/2303.09556) weighting strategy can
    help with training by rebalancing the loss to achieve faster convergence. The
    training script supports predicting `epsilon` (noise) or `v_prediction`, but Min-SNR
    is compatible with both prediction types. This weighting strategy is only supported
    by PyTorch and is unavailable in the Flax training script.
  id: totrans-28
  prefs: []
  type: TYPE_NORMAL
  zh: '[Min-SNR](https://huggingface.co/papers/2303.09556)åŠ æƒç­–ç•¥å¯ä»¥é€šè¿‡é‡æ–°å¹³è¡¡æŸå¤±æ¥å¸®åŠ©è®­ç»ƒï¼Œä»¥å®ç°æ›´å¿«çš„æ”¶æ•›ã€‚è®­ç»ƒè„šæœ¬æ”¯æŒé¢„æµ‹`epsilon`ï¼ˆå™ªéŸ³ï¼‰æˆ–`v_prediction`ï¼Œä½†Min-SNRä¸ä¸¤ç§é¢„æµ‹ç±»å‹å…¼å®¹ã€‚æ­¤åŠ æƒç­–ç•¥ä»…å—PyTorchæ”¯æŒï¼Œåœ¨Flaxè®­ç»ƒè„šæœ¬ä¸­ä¸å¯ç”¨ã€‚'
- en: 'Add the `--snr_gamma` parameter and set it to the recommended value of 5.0:'
  id: totrans-29
  prefs: []
  type: TYPE_NORMAL
  zh: æ·»åŠ `--snr_gamma`å‚æ•°ï¼Œå¹¶å°†å…¶è®¾ç½®ä¸ºæ¨èå€¼5.0ï¼š
- en: '[PRE6]'
  id: totrans-30
  prefs: []
  type: TYPE_PRE
  zh: '[PRE6]'
- en: Training script
  id: totrans-31
  prefs:
  - PREF_H2
  type: TYPE_NORMAL
  zh: è®­ç»ƒè„šæœ¬
- en: As with the script parameters, a general walkthrough of the training script
    is provided in the [Text-to-image](text2image#training-script) training guide.
    Instead, this guide takes a look at the relevant parts of the ControlNet script.
  id: totrans-32
  prefs: []
  type: TYPE_NORMAL
  zh: ä¸è„šæœ¬å‚æ•°ä¸€æ ·ï¼Œ[æ–‡æœ¬åˆ°å›¾åƒ](text2image#training-script)è®­ç»ƒæŒ‡å—ä¸­æä¾›äº†å¯¹è®­ç»ƒè„šæœ¬çš„æ•´ä½“ä»‹ç»ã€‚è€Œæœ¬æŒ‡å—åˆ™ç€çœ¼äºControlNetè„šæœ¬çš„ç›¸å…³éƒ¨åˆ†ã€‚
- en: The training script has a [`make_train_dataset`](https://github.com/huggingface/diffusers/blob/64603389da01082055a901f2883c4810d1144edb/examples/controlnet/train_controlnet.py#L582)
    function for preprocessing the dataset with image transforms and caption tokenization.
    Youâ€™ll see that in addition to the usual caption tokenization and image transforms,
    the script also includes transforms for the conditioning image.
  id: totrans-33
  prefs: []
  type: TYPE_NORMAL
  zh: è®­ç»ƒè„šæœ¬æœ‰ä¸€ä¸ª[`make_train_dataset`](https://github.com/huggingface/diffusers/blob/64603389da01082055a901f2883c4810d1144edb/examples/controlnet/train_controlnet.py#L582)å‡½æ•°ï¼Œç”¨äºå¯¹æ•°æ®é›†è¿›è¡Œé¢„å¤„ç†ï¼ŒåŒ…æ‹¬å›¾åƒè½¬æ¢å’Œæ ‡é¢˜æ ‡è®°åŒ–ã€‚æ‚¨å°†çœ‹åˆ°ï¼Œé™¤äº†é€šå¸¸çš„æ ‡é¢˜æ ‡è®°åŒ–å’Œå›¾åƒè½¬æ¢ä¹‹å¤–ï¼Œè„šæœ¬è¿˜åŒ…æ‹¬ç”¨äºæ¡ä»¶å›¾åƒçš„è½¬æ¢ã€‚
- en: If youâ€™re streaming a dataset on a TPU, performance may be bottlenecked by the
    ğŸ¤— Datasets library which is not optimized for images. To ensure maximum throughput,
    youâ€™re encouraged to explore other dataset formats like [WebDataset](https://webdataset.github.io/webdataset/),
    [TorchData](https://github.com/pytorch/data), and [TensorFlow Datasets](https://www.tensorflow.org/datasets/tfless_tfds).
  id: totrans-34
  prefs: []
  type: TYPE_NORMAL
  zh: å¦‚æœæ‚¨åœ¨TPUä¸Šæµå¼ä¼ è¾“æ•°æ®é›†ï¼Œæ€§èƒ½å¯èƒ½ä¼šå—åˆ°ğŸ¤—æ•°æ®é›†åº“çš„é™åˆ¶ï¼Œè¯¥åº“æœªé’ˆå¯¹å›¾åƒè¿›è¡Œä¼˜åŒ–ã€‚ä¸ºäº†ç¡®ä¿æœ€å¤§ååé‡ï¼Œå»ºè®®æ‚¨æ¢ç´¢å…¶ä»–æ•°æ®é›†æ ¼å¼ï¼Œå¦‚[WebDataset](https://webdataset.github.io/webdataset/)ã€[TorchData](https://github.com/pytorch/data)å’Œ[TensorFlowæ•°æ®é›†](https://www.tensorflow.org/datasets/tfless_tfds)ã€‚
- en: '[PRE7]'
  id: totrans-35
  prefs: []
  type: TYPE_PRE
  zh: '[PRE7]'
- en: 'Within the [`main()`](https://github.com/huggingface/diffusers/blob/64603389da01082055a901f2883c4810d1144edb/examples/controlnet/train_controlnet.py#L713)
    function, youâ€™ll find the code for loading the tokenizer, text encoder, scheduler
    and models. This is also where the ControlNet model is loaded either from existing
    weights or randomly initialized from a UNet:'
  id: totrans-36
  prefs: []
  type: TYPE_NORMAL
  zh: åœ¨[`main()`](https://github.com/huggingface/diffusers/blob/64603389da01082055a901f2883c4810d1144edb/examples/controlnet/train_controlnet.py#L713)å‡½æ•°ä¸­ï¼Œæ‚¨å°†æ‰¾åˆ°ç”¨äºåŠ è½½åˆ†è¯å™¨ã€æ–‡æœ¬ç¼–ç å™¨ã€è°ƒåº¦å™¨å’Œæ¨¡å‹çš„ä»£ç ã€‚è¿™ä¹Ÿæ˜¯ControlNetæ¨¡å‹åŠ è½½çš„åœ°æ–¹ï¼Œå¯ä»¥ä»ç°æœ‰æƒé‡åŠ è½½ï¼Œä¹Ÿå¯ä»¥ä»UNetéšæœºåˆå§‹åŒ–ï¼š
- en: '[PRE8]'
  id: totrans-37
  prefs: []
  type: TYPE_PRE
  zh: '[PRE8]'
- en: 'The [optimizer](https://github.com/huggingface/diffusers/blob/64603389da01082055a901f2883c4810d1144edb/examples/controlnet/train_controlnet.py#L871)
    is set up to update the ControlNet parameters:'
  id: totrans-38
  prefs: []
  type: TYPE_NORMAL
  zh: '[ä¼˜åŒ–å™¨](https://github.com/huggingface/diffusers/blob/64603389da01082055a901f2883c4810d1144edb/examples/controlnet/train_controlnet.py#L871)å·²è®¾ç½®ä¸ºæ›´æ–°ControlNetå‚æ•°ï¼š'
- en: '[PRE9]'
  id: totrans-39
  prefs: []
  type: TYPE_PRE
  zh: '[PRE9]'
- en: 'Finally, in the [training loop](https://github.com/huggingface/diffusers/blob/64603389da01082055a901f2883c4810d1144edb/examples/controlnet/train_controlnet.py#L943),
    the conditioning text embeddings and image are passed to the down and mid-blocks
    of the ControlNet model:'
  id: totrans-40
  prefs: []
  type: TYPE_NORMAL
  zh: æœ€åï¼Œåœ¨[è®­ç»ƒå¾ªç¯](https://github.com/huggingface/diffusers/blob/64603389da01082055a901f2883c4810d1144edb/examples/controlnet/train_controlnet.py#L943)ä¸­ï¼Œå°†æ¡ä»¶æ–‡æœ¬åµŒå…¥å’Œå›¾åƒä¼ é€’ç»™ControlNetæ¨¡å‹çš„ä¸‹æ¸¸å’Œä¸­é—´å—ï¼š
- en: '[PRE10]'
  id: totrans-41
  prefs: []
  type: TYPE_PRE
  zh: '[PRE10]'
- en: If you want to learn more about how the training loop works, check out the [Understanding
    pipelines, models and schedulers](../using-diffusers/write_own_pipeline) tutorial
    which breaks down the basic pattern of the denoising process.
  id: totrans-42
  prefs: []
  type: TYPE_NORMAL
  zh: å¦‚æœæ‚¨æƒ³äº†è§£è®­ç»ƒå¾ªç¯çš„å·¥ä½œåŸç†ï¼Œè¯·æŸ¥çœ‹[ç†è§£ç®¡é“ã€æ¨¡å‹å’Œè°ƒåº¦å™¨](../using-diffusers/write_own_pipeline)æ•™ç¨‹ï¼Œè¯¥æ•™ç¨‹è§£é‡Šäº†å»å™ªè¿‡ç¨‹çš„åŸºæœ¬æ¨¡å¼ã€‚
- en: Launch the script
  id: totrans-43
  prefs:
  - PREF_H2
  type: TYPE_NORMAL
  zh: å¯åŠ¨è„šæœ¬
- en: Now youâ€™re ready to launch the training script! ğŸš€
  id: totrans-44
  prefs: []
  type: TYPE_NORMAL
  zh: ç°åœ¨æ‚¨å·²ç»å‡†å¤‡å¥½å¯åŠ¨è®­ç»ƒè„šæœ¬äº†ï¼ğŸš€
- en: This guide uses the [fusing/fill50k](https://huggingface.co/datasets/fusing/fill50k)
    dataset, but remember, you can create and use your own dataset if you want (see
    the [Create a dataset for training](create_dataset) guide).
  id: totrans-45
  prefs: []
  type: TYPE_NORMAL
  zh: æœ¬æŒ‡å—ä½¿ç”¨[fusing/fill50k](https://huggingface.co/datasets/fusing/fill50k)æ•°æ®é›†ï¼Œä½†è¯·è®°ä½ï¼Œå¦‚æœéœ€è¦ï¼Œæ‚¨å¯ä»¥åˆ›å»ºå¹¶ä½¿ç”¨è‡ªå·±çš„æ•°æ®é›†ï¼ˆè¯·å‚é˜…[åˆ›å»ºç”¨äºè®­ç»ƒçš„æ•°æ®é›†](create_dataset)æŒ‡å—ï¼‰ã€‚
- en: Set the environment variable `MODEL_NAME` to a model id on the Hub or a path
    to a local model and `OUTPUT_DIR` to where you want to save the model.
  id: totrans-46
  prefs: []
  type: TYPE_NORMAL
  zh: å°†ç¯å¢ƒå˜é‡`MODEL_NAME`è®¾ç½®ä¸ºHubä¸Šçš„æ¨¡å‹IDæˆ–æœ¬åœ°æ¨¡å‹çš„è·¯å¾„ï¼Œå°†`OUTPUT_DIR`è®¾ç½®ä¸ºè¦ä¿å­˜æ¨¡å‹çš„ä½ç½®ã€‚
- en: 'Download the following images to condition your training with:'
  id: totrans-47
  prefs: []
  type: TYPE_NORMAL
  zh: ä¸‹è½½ä»¥ä¸‹å›¾åƒä»¥è¿›è¡Œè®­ç»ƒæ¡ä»¶ï¼š
- en: '[PRE11]'
  id: totrans-48
  prefs: []
  type: TYPE_PRE
  zh: '[PRE11]'
- en: One more thing before you launch the script! Depending on the GPU you have,
    you may need to enable certain optimizations to train a ControlNet. The default
    configuration in this script requires ~38GB of vRAM. If youâ€™re training on more
    than one GPU, add the `--multi_gpu` parameter to the `accelerate launch` command.
  id: totrans-49
  prefs: []
  type: TYPE_NORMAL
  zh: åœ¨å¯åŠ¨è„šæœ¬ä¹‹å‰è¿˜æœ‰ä¸€ä»¶äº‹ï¼æ ¹æ®æ‚¨æ‹¥æœ‰çš„GPUï¼Œæ‚¨å¯èƒ½éœ€è¦å¯ç”¨æŸäº›ä¼˜åŒ–æ¥è®­ç»ƒControlNetã€‚æ­¤è„šæœ¬ä¸­çš„é»˜è®¤é…ç½®éœ€è¦çº¦38GBçš„vRAMã€‚å¦‚æœæ‚¨è¦åœ¨å¤šä¸ªGPUä¸Šè¿›è¡Œè®­ç»ƒï¼Œè¯·åœ¨`accelerate
    launch`å‘½ä»¤ä¸­æ·»åŠ `--multi_gpu`å‚æ•°ã€‚
- en: 16GB12GB8GB
  id: totrans-50
  prefs: []
  type: TYPE_NORMAL
  zh: 16GB12GB8GB
- en: 'On a 16GB GPU, you can use bitsandbytes 8-bit optimizer and gradient checkpointing
    to optimize your training run. Install bitsandbytes:'
  id: totrans-51
  prefs: []
  type: TYPE_NORMAL
  zh: åœ¨16GB GPUä¸Šï¼Œæ‚¨å¯ä»¥ä½¿ç”¨bitsandbytes 8ä½ä¼˜åŒ–å™¨å’Œæ¢¯åº¦æ£€æŸ¥ç‚¹æ¥ä¼˜åŒ–æ‚¨çš„è®­ç»ƒè¿è¡Œã€‚å®‰è£…bitsandbytesï¼š
- en: '[PRE12]'
  id: totrans-52
  prefs: []
  type: TYPE_PRE
  zh: '[PRE12]'
- en: 'Then, add the following parameter to your training command:'
  id: totrans-53
  prefs: []
  type: TYPE_NORMAL
  zh: ç„¶åï¼Œåœ¨è®­ç»ƒå‘½ä»¤ä¸­æ·»åŠ ä»¥ä¸‹å‚æ•°ï¼š
- en: '[PRE13]'
  id: totrans-54
  prefs: []
  type: TYPE_PRE
  zh: '[PRE13]'
- en: PyTorchFlax
  id: totrans-55
  prefs: []
  type: TYPE_NORMAL
  zh: PyTorchFlax
- en: '[PRE14]'
  id: totrans-56
  prefs: []
  type: TYPE_PRE
  zh: '[PRE14]'
- en: Once training is complete, you can use your newly trained model for inference!
  id: totrans-57
  prefs: []
  type: TYPE_NORMAL
  zh: è®­ç»ƒå®Œæˆåï¼Œæ‚¨å¯ä»¥ä½¿ç”¨æ–°è®­ç»ƒçš„æ¨¡å‹è¿›è¡Œæ¨æ–­ï¼
- en: '[PRE15]'
  id: totrans-58
  prefs: []
  type: TYPE_PRE
  zh: '[PRE15]'
- en: Stable Diffusion XL
  id: totrans-59
  prefs:
  - PREF_H2
  type: TYPE_NORMAL
  zh: ç¨³å®šæ‰©æ•£XL
- en: Stable Diffusion XL (SDXL) is a powerful text-to-image model that generates
    high-resolution images, and it adds a second text-encoder to its architecture.
    Use the [`train_controlnet_sdxl.py`](https://github.com/huggingface/diffusers/blob/main/examples/controlnet/train_controlnet_sdxl.py)
    script to train a ControlNet adapter for the SDXL model.
  id: totrans-60
  prefs: []
  type: TYPE_NORMAL
  zh: ç¨³å®šæ‰©æ•£XLï¼ˆSDXLï¼‰æ˜¯ä¸€ä¸ªå¼ºå¤§çš„æ–‡æœ¬åˆ°å›¾åƒæ¨¡å‹ï¼Œå¯ä»¥ç”Ÿæˆé«˜åˆ†è¾¨ç‡å›¾åƒï¼Œå¹¶åœ¨å…¶æ¶æ„ä¸­æ·»åŠ äº†ç¬¬äºŒä¸ªæ–‡æœ¬ç¼–ç å™¨ã€‚ä½¿ç”¨[`train_controlnet_sdxl.py`](https://github.com/huggingface/diffusers/blob/main/examples/controlnet/train_controlnet_sdxl.py)è„šæœ¬æ¥è®­ç»ƒSDXLæ¨¡å‹çš„ControlNeté€‚é…å™¨ã€‚
- en: The SDXL training script is discussed in more detail in the [SDXL training](sdxl)
    guide.
  id: totrans-61
  prefs: []
  type: TYPE_NORMAL
  zh: æœ‰å…³SDXLè®­ç»ƒè„šæœ¬çš„è¯¦ç»†è®¨è®ºï¼Œè¯·å‚é˜…[SDXLè®­ç»ƒ](sdxl)æŒ‡å—ã€‚
- en: Next steps
  id: totrans-62
  prefs:
  - PREF_H2
  type: TYPE_NORMAL
  zh: ä¸‹ä¸€æ­¥
- en: 'Congratulations on training your own ControlNet! To learn more about how to
    use your new model, the following guides may be helpful:'
  id: totrans-63
  prefs: []
  type: TYPE_NORMAL
  zh: æ­å–œæ‚¨æˆåŠŸè®­ç»ƒäº†è‡ªå·±çš„ControlNetï¼è¦äº†è§£å¦‚ä½•ä½¿ç”¨æ‚¨çš„æ–°æ¨¡å‹ï¼Œä»¥ä¸‹æŒ‡å—å¯èƒ½ä¼šæœ‰æ‰€å¸®åŠ©ï¼š
- en: Learn how to [use a ControlNet](../using-diffusers/controlnet) for inference
    on a variety of tasks.
  id: totrans-64
  prefs:
  - PREF_UL
  type: TYPE_NORMAL
  zh: å­¦ä¹ å¦‚ä½•åœ¨å„ç§ä»»åŠ¡ä¸­ä½¿ç”¨ControlNetè¿›è¡Œæ¨æ–­ã€‚
