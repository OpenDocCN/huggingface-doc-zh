# PyTorch 2.0

> åŸå§‹æ–‡æœ¬ï¼š[https://huggingface.co/docs/diffusers/optimization/torch2.0](https://huggingface.co/docs/diffusers/optimization/torch2.0)

ğŸ¤— Diffusersæ”¯æŒæ¥è‡ª[PyTorch 2.0](https://pytorch.org/get-started/pytorch-2.0/)çš„æœ€æ–°ä¼˜åŒ–ï¼Œå…¶ä¸­åŒ…æ‹¬ï¼š

1.  ä¸€ç§å†…å­˜é«˜æ•ˆçš„æ³¨æ„åŠ›å®ç°ï¼Œæ— éœ€ä»»ä½•é¢å¤–çš„ä¾èµ–é¡¹ï¼Œå¦‚xFormersã€‚

1.  [`torch.compile`](https://pytorch.org/tutorials/intermediate/torch_compile_tutorial.html)ï¼Œä¸€ç§å³æ—¶ï¼ˆJITï¼‰ç¼–è¯‘å™¨ï¼Œç”¨äºåœ¨ç¼–è¯‘å•ä¸ªæ¨¡å‹æ—¶æä¾›é¢å¤–çš„æ€§èƒ½æå‡ã€‚

è¿™ä¸¤ç§ä¼˜åŒ–éƒ½éœ€è¦PyTorch 2.0æˆ–æ›´é«˜ç‰ˆæœ¬ä»¥åŠğŸ¤— Diffusers > 0.13.0ã€‚

```py
pip install --upgrade torch diffusers
```

## ç¼©æ”¾ç‚¹ç§¯æ³¨æ„åŠ›

[`torch.nn.functional.scaled_dot_product_attention`](https://pytorch.org/docs/master/generated/torch.nn.functional.scaled_dot_product_attention)ï¼ˆSDPAï¼‰æ˜¯ä¸€ç§ç»è¿‡ä¼˜åŒ–ä¸”å†…å­˜é«˜æ•ˆçš„æ³¨æ„åŠ›æœºåˆ¶ï¼ˆç±»ä¼¼äºxFormersï¼‰ï¼Œæ ¹æ®æ¨¡å‹è¾“å…¥å’ŒGPUç±»å‹è‡ªåŠ¨å¯ç”¨å‡ ç§å…¶ä»–ä¼˜åŒ–ã€‚å¦‚æœæ‚¨æ­£åœ¨ä½¿ç”¨PyTorch 2.0å’Œæœ€æ–°ç‰ˆæœ¬çš„ğŸ¤— Diffusersï¼Œåˆ™é»˜è®¤æƒ…å†µä¸‹å¯ç”¨SDPAï¼Œå› æ­¤æ‚¨æ— éœ€å‘ä»£ç ä¸­æ·»åŠ ä»»ä½•å†…å®¹ã€‚

ä½†æ˜¯ï¼Œå¦‚æœæ‚¨æƒ³è¦æ˜¾å¼å¯ç”¨å®ƒï¼Œå¯ä»¥è®¾ç½®[DiffusionPipeline](/docs/diffusers/v0.26.3/en/api/pipelines/overview#diffusers.DiffusionPipeline)ä»¥ä½¿ç”¨[AttnProcessor2_0](/docs/diffusers/v0.26.3/en/api/attnprocessor#diffusers.models.attention_processor.AttnProcessor2_0)ï¼š 

```py
  import torch
  from diffusers import DiffusionPipeline
+ from diffusers.models.attention_processor import AttnProcessor2_0

  pipe = DiffusionPipeline.from_pretrained("runwayml/stable-diffusion-v1-5", torch_dtype=torch.float16, use_safetensors=True).to("cuda")
+ pipe.unet.set_attn_processor(AttnProcessor2_0())

  prompt = "a photo of an astronaut riding a horse on mars"
  image = pipe(prompt).images[0]
```

SDPAåº”è¯¥ä¸`xFormers`ä¸€æ ·å¿«é€Ÿå’Œå†…å­˜é«˜æ•ˆï¼›æœ‰å…³æ›´å¤šè¯¦ç»†ä¿¡æ¯ï¼Œè¯·æŸ¥çœ‹[åŸºå‡†æµ‹è¯•](#benchmark)ã€‚

åœ¨æŸäº›æƒ…å†µä¸‹ - ä¾‹å¦‚ä½¿ç®¡é“æ›´å…·ç¡®å®šæ€§æˆ–å°†å…¶è½¬æ¢ä¸ºå…¶ä»–æ ¼å¼ - ä½¿ç”¨åŸå§‹æ³¨æ„åŠ›å¤„ç†å™¨[AttnProcessor](/docs/diffusers/v0.26.3/en/api/attnprocessor#diffusers.models.attention_processor.AttnProcessor)å¯èƒ½ä¼šæœ‰æ‰€å¸®åŠ©ã€‚è¦æ¢å¤åˆ°[AttnProcessor](/docs/diffusers/v0.26.3/en/api/attnprocessor#diffusers.models.attention_processor.AttnProcessor)ï¼Œè¯·åœ¨ç®¡é“ä¸Šè°ƒç”¨[set_default_attn_processor()](/docs/diffusers/v0.26.3/en/api/models/unet2d-cond#diffusers.UNet2DConditionModel.set_default_attn_processor)å‡½æ•°ï¼š

```py
  import torch
  from diffusers import DiffusionPipeline

  pipe = DiffusionPipeline.from_pretrained("runwayml/stable-diffusion-v1-5", torch_dtype=torch.float16, use_safetensors=True).to("cuda")
+ pipe.unet.set_default_attn_processor()

  prompt = "a photo of an astronaut riding a horse on mars"
  image = pipe(prompt).images[0]
```

## torch.compile

`torch.compile`å‡½æ•°é€šå¸¸å¯ä»¥ä¸ºæ‚¨çš„PyTorchä»£ç æä¾›é¢å¤–çš„åŠ é€Ÿã€‚åœ¨ğŸ¤— Diffusersä¸­ï¼Œé€šå¸¸æœ€å¥½ä½¿ç”¨`torch.compile`åŒ…è£…UNetï¼Œå› ä¸ºå®ƒåœ¨ç®¡é“ä¸­æ‰§è¡Œå¤§éƒ¨åˆ†ç¹é‡çš„å·¥ä½œã€‚

```py
from diffusers import DiffusionPipeline
import torch

pipe = DiffusionPipeline.from_pretrained("runwayml/stable-diffusion-v1-5", torch_dtype=torch.float16, use_safetensors=True).to("cuda")
pipe.unet = torch.compile(pipe.unet, mode="reduce-overhead", fullgraph=True)
images = pipe(prompt, num_inference_steps=steps, num_images_per_prompt=batch_size).images[0]
```

æ ¹æ®GPUç±»å‹ï¼Œ`torch.compile`å¯ä»¥åœ¨SDPAçš„åŸºç¡€ä¸Šæä¾›**5-300å€**çš„*é¢å¤–åŠ é€Ÿ*ï¼å¦‚æœæ‚¨ä½¿ç”¨çš„æ˜¯æ›´è¿‘æœŸçš„GPUæ¶æ„ï¼Œå¦‚Ampereï¼ˆA100ï¼Œ3090ï¼‰ï¼ŒAdaï¼ˆ4090ï¼‰å’ŒHopperï¼ˆH100ï¼‰ï¼Œ`torch.compile`èƒ½å¤Ÿä»è¿™äº›GPUä¸­æŒ¤å‡ºæ›´å¤šæ€§èƒ½ã€‚

ç¼–è¯‘éœ€è¦ä¸€äº›æ—¶é—´æ‰èƒ½å®Œæˆï¼Œå› æ­¤æœ€é€‚åˆæ‚¨å‡†å¤‡å¥½ç®¡é“åå¤šæ¬¡æ‰§è¡Œç›¸åŒç±»å‹çš„æ¨ç†æ“ä½œçš„æƒ…å†µã€‚ä¾‹å¦‚ï¼Œåœ¨ä¸åŒçš„å›¾åƒå°ºå¯¸ä¸Šè°ƒç”¨ç¼–è¯‘åçš„ç®¡é“ä¼šå†æ¬¡è§¦å‘ç¼–è¯‘ï¼Œè¿™å¯èƒ½å¾ˆæ˜‚è´µã€‚

æœ‰å…³`torch.compile`çš„æ›´å¤šä¿¡æ¯å’Œä¸åŒé€‰é¡¹ï¼Œè¯·å‚è€ƒ[`torch_compile`](https://pytorch.org/tutorials/intermediate/torch_compile_tutorial.html)æ•™ç¨‹ã€‚

## åŸºå‡†æµ‹è¯•

æˆ‘ä»¬å¯¹PyTorch 2.0çš„é«˜æ•ˆæ³¨æ„åŠ›å®ç°å’Œ`torch.compile`åœ¨ä¸åŒGPUå’Œæ‰¹é‡å¤§å°ä¸Šè¿›è¡Œäº†å…¨é¢çš„åŸºå‡†æµ‹è¯•ï¼Œé’ˆå¯¹æˆ‘ä»¬æœ€å¸¸ç”¨çš„äº”ä¸ªç®¡é“ã€‚è¯¥ä»£ç åœ¨ğŸ¤— Diffusers v0.17.0.dev0ä¸Šè¿›è¡Œäº†åŸºå‡†æµ‹è¯•ï¼Œä»¥ä¼˜åŒ–`torch.compile`çš„ä½¿ç”¨ï¼ˆæœ‰å…³æ›´å¤šè¯¦ç»†ä¿¡æ¯ï¼Œè¯·å‚è§[æ­¤å¤„](https://github.com/huggingface/diffusers/pull/3313)ï¼‰ã€‚

å±•å¼€ä¸‹é¢çš„ä¸‹æ‹‰èœå•ä»¥æ‰¾åˆ°ç”¨äºåŸºå‡†æµ‹è¯•æ¯ä¸ªç®¡é“çš„ä»£ç ï¼š

<details>### ç¨³å®šçš„æ‰©æ•£æ–‡æœ¬åˆ°å›¾åƒ

```py
from diffusers import DiffusionPipeline
import torch

path = "runwayml/stable-diffusion-v1-5"

run_compile = True  # Set True / False

pipe = DiffusionPipeline.from_pretrained(path, torch_dtype=torch.float16, use_safetensors=True)
pipe = pipe.to("cuda")
pipe.unet.to(memory_format=torch.channels_last)

if run_compile:
    print("Run torch compile")
    pipe.unet = torch.compile(pipe.unet, mode="reduce-overhead", fullgraph=True)

prompt = "ghibli style, a fantasy landscape with castles"

for _ in range(3):
    images = pipe(prompt=prompt).images
```

### ç¨³å®šçš„æ‰©æ•£å›¾åƒåˆ°å›¾åƒ

```py
from diffusers import StableDiffusionImg2ImgPipeline
from diffusers.utils import load_image
import torch

url = "https://raw.githubusercontent.com/CompVis/stable-diffusion/main/assets/stable-samples/img2img/sketch-mountains-input.jpg"

init_image = load_image(url)
init_image = init_image.resize((512, 512))

path = "runwayml/stable-diffusion-v1-5"

run_compile = True  # Set True / False

pipe = StableDiffusionImg2ImgPipeline.from_pretrained(path, torch_dtype=torch.float16, use_safetensors=True)
pipe = pipe.to("cuda")
pipe.unet.to(memory_format=torch.channels_last)

if run_compile:
    print("Run torch compile")
    pipe.unet = torch.compile(pipe.unet, mode="reduce-overhead", fullgraph=True)

prompt = "ghibli style, a fantasy landscape with castles"

for _ in range(3):
    image = pipe(prompt=prompt, image=init_image).images[0]
```

### ç¨³å®šçš„æ‰©æ•£ä¿®å¤

```py
from diffusers import StableDiffusionInpaintPipeline
from diffusers.utils import load_image
import torch

img_url = "https://raw.githubusercontent.com/CompVis/latent-diffusion/main/data/inpainting_examples/overture-creations-5sI6fQgYIuo.png"
mask_url = "https://raw.githubusercontent.com/CompVis/latent-diffusion/main/data/inpainting_examples/overture-creations-5sI6fQgYIuo_mask.png"

init_image = load_image(img_url).resize((512, 512))
mask_image = load_image(mask_url).resize((512, 512))

path = "runwayml/stable-diffusion-inpainting"

run_compile = True  # Set True / False

pipe = StableDiffusionInpaintPipeline.from_pretrained(path, torch_dtype=torch.float16, use_safetensors=True)
pipe = pipe.to("cuda")
pipe.unet.to(memory_format=torch.channels_last)

if run_compile:
    print("Run torch compile")
    pipe.unet = torch.compile(pipe.unet, mode="reduce-overhead", fullgraph=True)

prompt = "ghibli style, a fantasy landscape with castles"

for _ in range(3):
    image = pipe(prompt=prompt, image=init_image, mask_image=mask_image).images[0]
```

### ControlNet

```py
from diffusers import StableDiffusionControlNetPipeline, ControlNetModel
from diffusers.utils import load_image
import torch

url = "https://raw.githubusercontent.com/CompVis/stable-diffusion/main/assets/stable-samples/img2img/sketch-mountains-input.jpg"

init_image = load_image(url)
init_image = init_image.resize((512, 512))

path = "runwayml/stable-diffusion-v1-5"

run_compile = True  # Set True / False
controlnet = ControlNetModel.from_pretrained("lllyasviel/sd-controlnet-canny", torch_dtype=torch.float16, use_safetensors=True)
pipe = StableDiffusionControlNetPipeline.from_pretrained(
    path, controlnet=controlnet, torch_dtype=torch.float16, use_safetensors=True
)

pipe = pipe.to("cuda")
pipe.unet.to(memory_format=torch.channels_last)
pipe.controlnet.to(memory_format=torch.channels_last)

if run_compile:
    print("Run torch compile")
    pipe.unet = torch.compile(pipe.unet, mode="reduce-overhead", fullgraph=True)
    pipe.controlnet = torch.compile(pipe.controlnet, mode="reduce-overhead", fullgraph=True)

prompt = "ghibli style, a fantasy landscape with castles"

for _ in range(3):
    image = pipe(prompt=prompt, image=init_image).images[0]
```

### DeepFloyd IFæ–‡æœ¬åˆ°å›¾åƒ+æ”¾å¤§

```py
from diffusers import DiffusionPipeline
import torch

run_compile = True  # Set True / False

pipe_1 = DiffusionPipeline.from_pretrained("DeepFloyd/IF-I-M-v1.0", variant="fp16", text_encoder=None, torch_dtype=torch.float16, use_safetensors=True)
pipe_1.to("cuda")
pipe_2 = DiffusionPipeline.from_pretrained("DeepFloyd/IF-II-M-v1.0", variant="fp16", text_encoder=None, torch_dtype=torch.float16, use_safetensors=True)
pipe_2.to("cuda")
pipe_3 = DiffusionPipeline.from_pretrained("stabilityai/stable-diffusion-x4-upscaler", torch_dtype=torch.float16, use_safetensors=True)
pipe_3.to("cuda")

pipe_1.unet.to(memory_format=torch.channels_last)
pipe_2.unet.to(memory_format=torch.channels_last)
pipe_3.unet.to(memory_format=torch.channels_last)

if run_compile:
    pipe_1.unet = torch.compile(pipe_1.unet, mode="reduce-overhead", fullgraph=True)
    pipe_2.unet = torch.compile(pipe_2.unet, mode="reduce-overhead", fullgraph=True)
    pipe_3.unet = torch.compile(pipe_3.unet, mode="reduce-overhead", fullgraph=True)

prompt = "the blue hulk"

prompt_embeds = torch.randn((1, 2, 4096), dtype=torch.float16)
neg_prompt_embeds = torch.randn((1, 2, 4096), dtype=torch.float16)

for _ in range(3):
    image_1 = pipe_1(prompt_embeds=prompt_embeds, negative_prompt_embeds=neg_prompt_embeds, output_type="pt").images
    image_2 = pipe_2(image=image_1, prompt_embeds=prompt_embeds, negative_prompt_embeds=neg_prompt_embeds, output_type="pt").images
    image_3 = pipe_3(prompt=prompt, image=image_1, noise_level=100).images
```</details>

ä¸‹é¢çš„å›¾è¡¨çªå‡ºæ˜¾ç¤ºäº†åœ¨äº”ä¸ªGPUç³»åˆ—ä¸­ï¼Œä½¿ç”¨PyTorch 2.0å’Œå¯ç”¨`torch.compile`çš„[StableDiffusionPipeline](/docs/diffusers/v0.26.3/en/api/pipelines/stable_diffusion/text2img#diffusers.StableDiffusionPipeline)çš„ç›¸å¯¹åŠ é€Ÿæƒ…å†µã€‚ä»¥ä¸‹å›¾è¡¨çš„åŸºå‡†æ˜¯*æ¯ç§’è¿­ä»£æ¬¡æ•°*ã€‚

![t2i_speedup](../Images/b9e5a83589de9942d685c07d4cf11ecd.png)

ä¸ºäº†è®©æ‚¨æ›´å¥½åœ°äº†è§£è¿™ç§åŠ é€Ÿå¯¹å…¶ä»–æµæ°´çº¿çš„å½±å“ï¼Œè€ƒè™‘ä»¥ä¸‹å…³äºA100ä½¿ç”¨PyTorch 2.0å’Œ`torch.compile`çš„å›¾è¡¨ï¼š

![a100_numbers](../Images/f5f080ae9f99b4a72d2909f42bde4477.png)

åœ¨ä»¥ä¸‹è¡¨æ ¼ä¸­ï¼Œæˆ‘ä»¬æŠ¥å‘Šäº†æˆ‘ä»¬çš„å‘ç°ï¼Œä»¥*æ¯ç§’è¿­ä»£æ¬¡æ•°*è¡¨ç¤ºã€‚

### A100ï¼ˆæ‰¹é‡å¤§å°ï¼š1ï¼‰

| **æµæ°´çº¿** | **torch 2.0 - æ— ç¼–è¯‘** | **torch nightly - æ— ç¼–è¯‘** | **torch 2.0 - ç¼–è¯‘** | **torch nightly - ç¼–è¯‘** |
| :-: | :-: | :-: | :-: | :-: |
| SD - æ–‡æœ¬åˆ°å›¾åƒ | 21.66 | 23.13 | 44.03 | 49.74 |
| SD - å›¾åƒåˆ°å›¾åƒ | 21.81 | 22.40 | 43.92 | 46.32 |
| SD - è¡¥å…¨ | 22.24 | 23.23 | 43.76 | 49.25 |
| SD - æ§åˆ¶ç½‘ç»œ | 15.02 | 15.82 | 32.13 | 36.08 |

| IF | 20.21 / 13.84 /

24.00 | 20.12 / 13.70 /

24.03 | âŒ | 97.34 / 27.23 /

111.66 |

| SDXL - æ–‡æœ¬åˆ°å›¾åƒ | 8.64 | 9.9 | - | - |
| --- | --- | --- | --- | --- |

### A100ï¼ˆæ‰¹é‡å¤§å°ï¼š4ï¼‰

| **æµæ°´çº¿** | **torch 2.0 - æ— ç¼–è¯‘** | **torch nightly - æ— ç¼–è¯‘** | **torch 2.0 - ç¼–è¯‘** | **torch nightly - ç¼–è¯‘** |
| :-: | :-: | :-: | :-: | :-: |
| SD - æ–‡æœ¬åˆ°å›¾åƒ | 11.6 | 13.12 | 14.62 | 17.27 |
| SD - å›¾åƒåˆ°å›¾åƒ | 11.47 | 13.06 | 14.66 | 17.25 |
| SD - è¡¥å…¨ | 11.67 | 13.31 | 14.88 | 17.48 |
| SD - æ§åˆ¶ç½‘ç»œ | 8.28 | 9.38 | 10.51 | 12.41 |
| IF | 25.02 | 18.04 | âŒ | 48.47 |
| SDXL - æ–‡æœ¬åˆ°å›¾åƒ | 2.44 | 2.74 | - | - |

### A100ï¼ˆæ‰¹é‡å¤§å°ï¼š16ï¼‰

| **æµæ°´çº¿** | **torch 2.0 - æ— ç¼–è¯‘** | **torch nightly - æ— ç¼–è¯‘** | **torch 2.0 - ç¼–è¯‘** | **torch nightly - ç¼–è¯‘** |
| :-: | :-: | :-: | :-: | :-: |
| SD - æ–‡æœ¬åˆ°å›¾åƒ | 3.04 | 3.6 | 3.83 | 4.68 |
| SD - å›¾åƒåˆ°å›¾åƒ | 2.98 | 3.58 | 3.83 | 4.67 |
| SD - è¡¥å…¨ | 3.04 | 3.66 | 3.9 | 4.76 |
| SD - æ§åˆ¶ç½‘ç»œ | 2.15 | 2.58 | 2.74 | 3.35 |
| IF | 8.78 | 9.82 | âŒ | 16.77 |
| SDXL - æ–‡æœ¬åˆ°å›¾åƒ | 0.64 | 0.72 | - | - |

### V100ï¼ˆæ‰¹é‡å¤§å°ï¼š1ï¼‰

| **æµæ°´çº¿** | **torch 2.0 - æ— ç¼–è¯‘** | **torch nightly - æ— ç¼–è¯‘** | **torch 2.0 - ç¼–è¯‘** | **torch nightly - ç¼–è¯‘** |
| :-: | :-: | :-: | :-: | :-: |
| SD - æ–‡æœ¬åˆ°å›¾åƒ | 18.99 | 19.14 | 20.95 | 22.17 |
| SD - å›¾åƒåˆ°å›¾åƒ | 18.56 | 19.18 | 20.95 | 22.11 |
| SD - è¡¥å…¨ | 19.14 | 19.06 | 21.08 | 22.20 |
| SD - æ§åˆ¶ç½‘ç»œ | 13.48 | 13.93 | 15.18 | 15.88 |

| IF | 20.01 / 9.08 /

23.34 | 19.79 / 8.98 /

24.10 | âŒ | 55.75 / 11.57 /

57.67 |

### V100ï¼ˆæ‰¹é‡å¤§å°ï¼š4ï¼‰

| **æµæ°´çº¿** | **torch 2.0 - æ— ç¼–è¯‘** | **torch nightly - æ— ç¼–è¯‘** | **torch 2.0 - ç¼–è¯‘** | **torch nightly - ç¼–è¯‘** |
| :-: | :-: | :-: | :-: | :-: |
| SD - æ–‡æœ¬åˆ°å›¾åƒ | 5.96 | 5.89 | 6.83 | 6.86 |
| SD - å›¾åƒåˆ°å›¾åƒ | 5.90 | 5.91 | 6.81 | 6.82 |
| SD - è¡¥å…¨ | 5.99 | 6.03 | 6.93 | 6.95 |
| SD - æ§åˆ¶ç½‘ç»œ | 4.26 | 4.29 | 4.92 | 4.93 |
| IF | 15.41 | 14.76 | âŒ | 22.95 |

### V100ï¼ˆæ‰¹é‡å¤§å°ï¼š16ï¼‰

| **æµæ°´çº¿** | **torch 2.0 - æ— ç¼–è¯‘** | **torch nightly - æ— ç¼–è¯‘** | **torch 2.0 - ç¼–è¯‘** | **torch nightly - ç¼–è¯‘** |
| :-: | :-: | :-: | :-: | :-: |
| SD - æ–‡æœ¬åˆ°å›¾åƒ | 1.66 | 1.66 | 1.92 | 1.90 |
| SD - å›¾åƒåˆ°å›¾åƒ | 1.65 | 1.65 | 1.91 | 1.89 |
| SD - è¡¥å…¨ | 1.69 | 1.69 | 1.95 | 1.93 |
| SD - æ§åˆ¶ç½‘ç»œ | 1.19 | 1.19 | çƒ­èº«åOOM | 1.36 |
| IF | 5.43 | 5.29 | âŒ | 7.06 |

### T4ï¼ˆæ‰¹é‡å¤§å°ï¼š1ï¼‰

| **æµæ°´çº¿** | **torch 2.0 - æ— ç¼–è¯‘** | **torch nightly - æ— ç¼–è¯‘** | **torch 2.0 - ç¼–è¯‘** | **torch nightly - ç¼–è¯‘** |
| :-: | :-: | :-: | :-: | :-: |
| SD - æ–‡æœ¬åˆ°å›¾åƒ | 6.9 | 6.95 | 7.3 | 7.56 |
| SD - å›¾åƒåˆ°å›¾åƒ | 6.84 | 6.99 | 7.04 | 7.55 |
| SD - è¡¥å…¨ | 6.91 | 6.7 | 7.01 | 7.37 |
| SD - æ§åˆ¶ç½‘ç»œ | 4.89 | 4.86 | 5.35 | 5.48 |

| IF | 17.42 / 2.47 /

18.52 | 16.96 / 2.45 /

18.69 | âŒ | 24.63 / 2.47 /

23.39 |

| SDXL - æ–‡æœ¬åˆ°å›¾åƒ | 1.15 | 1.16 | - | - |
| --- | --- | --- | --- | --- |

### T4ï¼ˆæ‰¹é‡å¤§å°ï¼š4ï¼‰

| **Pipeline** | **torch 2.0 - no compile** | **torch nightly - no compile** | **torch 2.0 - compile** | **torch nightly - compile** |
| :-: | :-: | :-: | :-: | :-: |
| SD - txt2img | 1.79 | 1.79 | 2.03 | 1.99 |
| SD - img2img | 1.77 | 1.77 | 2.05 | 2.04 |
| SD - inpaint | 1.81 | 1.82 | 2.09 | 2.09 |
| SD - controlnet | 1.34 | 1.27 | 1.47 | 1.46 |
| IF | 5.79 | 5.61 | âŒ | 7.39 |
| SDXL - txt2img | 0.288 | 0.289 | - | - |

### T4 (batch size: 16)

| **Pipeline** | **torch 2.0 - no compile** | **torch nightly - no compile** | **torch 2.0 - compile** | **torch nightly - compile** |
| :-: | :-: | :-: | :-: | :-: |
| SD - txt2img | 2.34s | 2.30s | OOM after 2nd iteration | 1.99s |
| SD - img2img | 2.35s | 2.31s | OOM after warmup | 2.00s |
| SD - inpaint | 2.30s | 2.26s | OOM after 2nd iteration | 1.95s |
| SD - controlnet | OOM after 2nd iteration | OOM after 2nd iteration | OOM after warmup | OOM after warmup |
| IF * | 1.44 | 1.44 | âŒ | 1.94 |
| SDXL - txt2img | OOM | OOM | - | - |

### RTX 3090 (batch size: 1)

| **Pipeline** | **torch 2.0 - no compile** | **torch nightly - no compile** | **torch 2.0 - compile** | **torch nightly - compile** |
| :-: | :-: | :-: | :-: | :-: |
| SD - txt2img | 22.56 | 22.84 | 23.84 | 25.69 |
| SD - img2img | 22.25 | 22.61 | 24.1 | 25.83 |
| SD - inpaint | 22.22 | 22.54 | 24.26 | 26.02 |
| SD - controlnet | 16.03 | 16.33 | 17.38 | 18.56 |

| IF | 27.08 / 9.07 /

31.23 | 26.75 / 8.92 /

31.47 | âŒ | 68.08 / 11.16 /

65.29 |

### RTX 3090 (batch size: 4)

| **Pipeline** | **torch 2.0 - no compile** | **torch nightly - no compile** | **torch 2.0 - compile** | **torch nightly - compile** |
| :-: | :-: | :-: | :-: | :-: |
| SD - txt2img | 6.46 | 6.35 | 7.29 | 7.3 |
| SD - img2img | 6.33 | 6.27 | 7.31 | 7.26 |
| SD - inpaint | 6.47 | 6.4 | 7.44 | 7.39 |
| SD - controlnet | 4.59 | 4.54 | 5.27 | 5.26 |
| IF | 16.81 | 16.62 | âŒ | 21.57 |

### RTX 3090 (batch size: 16)

| **Pipeline** | **torch 2.0 - no compile** | **torch nightly - no compile** | **torch 2.0 - compile** | **torch nightly - compile** |
| :-: | :-: | :-: | :-: | :-: |
| SD - txt2img | 1.7 | 1.69 | 1.93 | 1.91 |
| SD - img2img | 1.68 | 1.67 | 1.93 | 1.9 |
| SD - inpaint | 1.72 | 1.71 | 1.97 | 1.94 |
| SD - controlnet | 1.23 | 1.22 | 1.4 | 1.38 |
| IF | 5.01 | 5.00 | âŒ | 6.33 |

### RTX 4090 (batch size: 1)

| **Pipeline** | **torch 2.0 - no compile** | **torch nightly - no compile** | **torch 2.0 - compile** | **torch nightly - compile** |
| :-: | :-: | :-: | :-: | :-: |
| SD - txt2img | 40.5 | 41.89 | 44.65 | 49.81 |
| SD - img2img | 40.39 | 41.95 | 44.46 | 49.8 |
| SD - inpaint | 40.51 | 41.88 | 44.58 | 49.72 |
| SD - controlnet | 29.27 | 30.29 | 32.26 | 36.03 |

| IF | 69.71 / 18.78 /

85.49 | 69.13 / 18.80 /

85.56 | âŒ | 124.60 / 26.37 /

138.79 |

| SDXL - txt2img | 6.8 | 8.18 | - | - |
| --- | --- | --- | --- | --- |

### RTX 4090 (batch size: 4)

| **Pipeline** | **torch 2.0 - no compile** | **torch nightly - no compile** | **torch 2.0 - compile** | **torch nightly - compile** |
| :-: | :-: | :-: | :-: | :-: |
| SD - txt2img | 12.62 | 12.84 | 15.32 | 15.59 |
| SD - img2img | 12.61 | 12,.79 | 15.35 | 15.66 |
| SD - inpaint | 12.65 | 12.81 | 15.3 | 15.58 |
| SD - controlnet | 9.1 | 9.25 | 11.03 | 11.22 |
| IF | 31.88 | 31.14 | âŒ | 43.92 |
| SDXL - txt2img | 2.19 | 2.35 | - | - |

### RTX 4090 (batch size: 16)

| **Pipeline** | **torch 2.0 - no compile** | **torch nightly - no compile** | **torch 2.0 - compile** | **torch nightly - compile** |
| :-: | :-: | :-: | :-: | :-: |
| SD - txt2img | 3.17 | 3.2 | 3.84 | 3.85 |
| SD - img2img | 3.16 | 3.2 | 3.84 | 3.85 |
| SD - inpaint | 3.17 | 3.2 | 3.85 | 3.85 |
| SD - controlnet | 2.23 | 2.3 | 2.7 | 2.75 |
| IF | 9.26 | 9.2 | âŒ | 13.31 |
| SDXL - txt2img | 0.52 | 0.53 | - | - |

## Notes

+   å…³æ³¨æ­¤[PR](https://github.com/huggingface/diffusers/pull/3313)ä»¥è·å–æœ‰å…³è¿›è¡ŒåŸºå‡†æµ‹è¯•æ‰€ä½¿ç”¨ç¯å¢ƒçš„æ›´å¤šè¯¦ç»†ä¿¡æ¯ã€‚

+   å¯¹äºDeepFloyd IFç®¡é“ï¼Œå…¶ä¸­æ‰¹é‡å¤§å°> 1ï¼Œæˆ‘ä»¬ä»…åœ¨ç¬¬ä¸€ä¸ªIFç®¡é“ä¸­ç”¨äºæ–‡æœ¬åˆ°å›¾åƒç”Ÿæˆçš„æ‰¹é‡å¤§å°> 1ï¼Œå¹¶ä¸”ä¸ç”¨äºæ”¾å¤§ã€‚è¿™æ„å‘³ç€ä¸¤ä¸ªæ”¾å¤§ç®¡é“æ¥æ”¶åˆ°æ‰¹é‡å¤§å°ä¸º1ã€‚

*æ„Ÿè°¢PyTorchå›¢é˜Ÿçš„[Horace He](https://github.com/Chillee)åœ¨æ”¹è¿›æˆ‘ä»¬å¯¹Diffusersä¸­`torch.compile()`æ”¯æŒæ–¹é¢çš„æ”¯æŒã€‚*
