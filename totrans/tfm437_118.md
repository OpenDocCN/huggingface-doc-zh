# å°†ğŸ¤— Transformersæ¨¡å‹å¯¼å‡ºåˆ°ONNX

> åŸå§‹æ–‡æœ¬ï¼š[https://huggingface.co/docs/transformers/v4.37.2/en/main_classes/onnx](https://huggingface.co/docs/transformers/v4.37.2/en/main_classes/onnx)

ğŸ¤— Transformersæä¾›äº†ä¸€ä¸ª`transformers.onnx`åŒ…ï¼Œé€šè¿‡åˆ©ç”¨é…ç½®å¯¹è±¡ï¼Œæ‚¨å¯ä»¥å°†æ¨¡å‹æ£€æŸ¥ç‚¹è½¬æ¢ä¸ºONNXå›¾ã€‚

æŸ¥çœ‹æœ‰å…³å¯¼å‡ºğŸ¤— Transformersæ¨¡å‹çš„æ›´å¤šè¯¦ç»†ä¿¡æ¯çš„[æŒ‡å—](../serialization)ã€‚

## ONNXé…ç½®

æˆ‘ä»¬æä¾›äº†ä¸‰ä¸ªæŠ½è±¡ç±»ï¼Œæ‚¨åº”è¯¥æ ¹æ®å¸Œæœ›å¯¼å‡ºçš„æ¨¡å‹æ¶æ„ç±»å‹ç»§æ‰¿å…¶ä¸­ä¸€ä¸ªï¼š

+   åŸºäºç¼–ç å™¨çš„æ¨¡å‹ç»§æ‰¿è‡ª[OnnxConfig](/docs/transformers/v4.37.2/en/main_classes/onnx#transformers.onnx.OnnxConfig)

+   åŸºäºè§£ç å™¨çš„æ¨¡å‹ç»§æ‰¿è‡ª[OnnxConfigWithPast](/docs/transformers/v4.37.2/en/main_classes/onnx#transformers.onnx.OnnxConfigWithPast)

+   ç¼–ç å™¨-è§£ç å™¨æ¨¡å‹ç»§æ‰¿è‡ª[OnnxSeq2SeqConfigWithPast](/docs/transformers/v4.37.2/en/main_classes/onnx#transformers.onnx.OnnxSeq2SeqConfigWithPast)

### OnnxConfig

### `class transformers.onnx.OnnxConfig`

[< source >](https://github.com/huggingface/transformers/blob/v4.37.2/src/transformers/onnx/config.py#L68)

```py
( config: PretrainedConfig task: str = 'default' patching_specs: List = None )
```

ç”¨äºæè¿°é€šè¿‡ONNXæ ¼å¼å¯¼å‡ºæ¨¡å‹çš„å…ƒæ•°æ®çš„å¯å¯¼å‡ºæ¨¡å‹çš„åŸºç±»ã€‚

#### `flatten_output_collection_property`

[< source >](https://github.com/huggingface/transformers/blob/v4.37.2/src/transformers/onnx/config.py#L424)

```py
( name: str field: Iterable ) â†’ export const metadata = 'undefined';(Dict[str, Any])
```

è¿”å›

ï¼ˆDict[str, Any])

å…·æœ‰æ‰å¹³ç»“æ„å’Œæ˜ å°„åˆ°æ­¤æ–°ç»“æ„çš„é”®çš„è¾“å‡ºã€‚

å±•å¹³ä»»ä½•æ½œåœ¨çš„åµŒå¥—ç»“æ„ï¼Œå°†å­—æ®µçš„åç§°ä¸ç»“æ„ä¸­å…ƒç´ çš„ç´¢å¼•æ‰©å±•ã€‚

#### `from_model_config`

[< source >](https://github.com/huggingface/transformers/blob/v4.37.2/src/transformers/onnx/config.py#L127)

```py
( config: PretrainedConfig task: str = 'default' )
```

ä¸ºç‰¹å®šæ¨¡å‹å®ä¾‹åŒ–ä¸€ä¸ªOnnxConfig

#### `generate_dummy_inputs`

[< source >](https://github.com/huggingface/transformers/blob/v4.37.2/src/transformers/onnx/config.py#L280)

```py
( preprocessor: Union batch_size: int = -1 seq_length: int = -1 num_choices: int = -1 is_pair: bool = False framework: Optional = None num_channels: int = 3 image_width: int = 40 image_height: int = 40 sampling_rate: int = 22050 time_duration: float = 5.0 frequency: int = 220 tokenizer: PreTrainedTokenizerBase = None )
```

å‚æ•°

+   `batch_size` (`int`, *å¯é€‰*ï¼Œé»˜è®¤ä¸º-1) â€” ç”¨äºå¯¼å‡ºæ¨¡å‹çš„æ‰¹é‡å¤§å°ï¼ˆ-1è¡¨ç¤ºåŠ¨æ€è½´ï¼‰ã€‚

+   `num_choices` (`int`, *å¯é€‰*ï¼Œé»˜è®¤ä¸º-1) â€” ä¸ºå¤šé€‰ä»»åŠ¡æä¾›çš„å€™é€‰ç­”æ¡ˆæ•°é‡ï¼ˆ-1è¡¨ç¤ºåŠ¨æ€è½´ï¼‰ã€‚

+   `seq_length` (`int`, *å¯é€‰*ï¼Œé»˜è®¤ä¸º-1) â€” ä¸ºå¯¼å‡ºæ¨¡å‹æŒ‡å®šçš„åºåˆ—é•¿åº¦ï¼ˆ-1è¡¨ç¤ºåŠ¨æ€è½´ï¼‰ã€‚

+   `is_pair` (`bool`, *å¯é€‰*ï¼Œé»˜è®¤ä¸º`False`) â€” æŒ‡ç¤ºè¾“å…¥æ˜¯å¦ä¸ºä¸€å¯¹ï¼ˆå¥å­1ï¼Œå¥å­2ï¼‰

+   `framework` (`TensorType`, *å¯é€‰*ï¼Œé»˜è®¤ä¸º`None`) â€” åˆ†è¯å™¨å°†ä¸ºå…¶ç”Ÿæˆå¼ é‡çš„æ¡†æ¶ï¼ˆPyTorchæˆ–TensorFlowï¼‰ã€‚

+   `num_channels` (`int`, *å¯é€‰*ï¼Œé»˜è®¤ä¸º3) â€” ç”Ÿæˆå›¾åƒçš„é€šé“æ•°ã€‚

+   `image_width` (`int`, *å¯é€‰*ï¼Œé»˜è®¤ä¸º40) â€” ç”Ÿæˆå›¾åƒçš„å®½åº¦ã€‚

+   `image_height` (`int`, *å¯é€‰*ï¼Œé»˜è®¤ä¸º40) â€” ç”Ÿæˆå›¾åƒçš„é«˜åº¦ã€‚

+   `sampling_rate` (`int`, *å¯é€‰* é»˜è®¤ä¸º22050) â€” ç”¨äºéŸ³é¢‘æ•°æ®ç”Ÿæˆçš„é‡‡æ ·ç‡ã€‚

+   `time_duration` (`float`, *å¯é€‰* é»˜è®¤ä¸º5.0) â€” ç”¨äºéŸ³é¢‘æ•°æ®ç”Ÿæˆçš„é‡‡æ ·æ€»ç§’æ•°ã€‚

+   `frequency` (`int`, *å¯é€‰* é»˜è®¤ä¸º220) â€” ç”ŸæˆéŸ³é¢‘çš„æœŸæœ›è‡ªç„¶é¢‘ç‡ã€‚

ç”Ÿæˆè¦æä¾›ç»™ç‰¹å®šæ¡†æ¶çš„ONNXå¯¼å‡ºå™¨çš„è¾“å…¥

#### `generate_dummy_inputs_onnxruntime`

[< source >](https://github.com/huggingface/transformers/blob/v4.37.2/src/transformers/onnx/config.py#L400)

```py
( reference_model_inputs: Mapping ) â†’ export const metadata = 'undefined';Mapping[str, Tensor]
```

å‚æ•°

+   `reference_model_inputs`ï¼ˆ[`Mapping[str, Tensor]`ï¼‰â€” æ¨¡å‹çš„å‚è€ƒè¾“å…¥ã€‚

è¿”å›

`Mapping[str, Tensor]`

ä¿å­˜è¦æä¾›ç»™æ¨¡å‹å‰å‘å‡½æ•°çš„kwargsçš„æ˜ å°„

ä½¿ç”¨å‚è€ƒæ¨¡å‹è¾“å…¥ä¸ºONNX Runtimeç”Ÿæˆè¾“å…¥ã€‚è¦†ç›–æ­¤é€‰é¡¹ä»¥ä½¿ç”¨å°†ç¼–ç å™¨å’Œè§£ç å™¨å¯¼å‡ºä¸ºå•ç‹¬çš„ONNXæ–‡ä»¶çš„seq2seqæ¨¡å‹è¿›è¡Œæ¨ç†ã€‚

#### `use_external_data_format`

[< source >](https://github.com/huggingface/transformers/blob/v4.37.2/src/transformers/onnx/config.py#L241)

```py
( num_parameters: int )
```

æ ‡å¿—ï¼ŒæŒ‡ç¤ºæ¨¡å‹æ˜¯å¦éœ€è¦ä½¿ç”¨å¤–éƒ¨æ•°æ®æ ¼å¼

### OnnxConfigWithPast

### `class transformers.onnx.OnnxConfigWithPast`

[<æ¥æº>](https://github.com/huggingface/transformers/blob/v4.37.2/src/transformers/onnx/config.py#L443)

```py
( config: PretrainedConfig task: str = 'default' patching_specs: List = None use_past: bool = False )
```

`fill_with_past_key_values_`

[<æ¥æº>](https://github.com/huggingface/transformers/blob/v4.37.2/src/transformers/onnx/config.py#L550)

```py
( inputs_or_outputs: Mapping direction: str inverted_values_shape: bool = False )
```

è€ƒè™‘å¡«å……å…·æœ‰è¿‡å»é”®å€¼åŠ¨æ€è½´çš„è¾“å…¥æˆ–è¾“å‡ºæ˜ å°„ã€‚

#### `with_past`

[<æ¥æº>](https://github.com/huggingface/transformers/blob/v4.37.2/src/transformers/onnx/config.py#L454)

```py
( config: PretrainedConfig task: str = 'default' )
```

å®ä¾‹åŒ–ä¸€ä¸ªå…·æœ‰ `use_past` å±æ€§è®¾ç½®ä¸º True çš„ OnnxConfig

### OnnxSeq2SeqConfigWithPast

### `class transformers.onnx.OnnxSeq2SeqConfigWithPast`

[<æ¥æº>](https://github.com/huggingface/transformers/blob/v4.37.2/src/transformers/onnx/config.py#L590)

```py
( config: PretrainedConfig task: str = 'default' patching_specs: List = None use_past: bool = False )
```

## ONNX ç‰¹æ€§

æ¯ä¸ª ONNX é…ç½®éƒ½ä¸ä¸€ç»„ *ç‰¹æ€§* å…³è”ï¼Œä½¿æ‚¨èƒ½å¤Ÿä¸ºä¸åŒç±»å‹çš„æ‹“æ‰‘æˆ–ä»»åŠ¡å¯¼å‡ºæ¨¡å‹ã€‚

### FeaturesManager

### `class transformers.onnx.FeaturesManager`

[<æ¥æº>](https://github.com/huggingface/transformers/blob/v4.37.2/src/transformers/onnx/features.py#L85)

```py
( )
```

`check_supported_model_or_raise`

[<æ¥æº>](https://github.com/huggingface/transformers/blob/v4.37.2/src/transformers/onnx/features.py#L711)

```py
( model: Union feature: str = 'default' )
```

æ£€æŸ¥æ¨¡å‹æ˜¯å¦å…·æœ‰è¯·æ±‚çš„ç‰¹å¾ã€‚

#### `determine_framework`

[<æ¥æº>](https://github.com/huggingface/transformers/blob/v4.37.2/src/transformers/onnx/features.py#L628)

```py
( model: str framework: str = None )
```

å‚æ•°

+   `model` (`str`) â€” è¦å¯¼å‡ºçš„æ¨¡å‹çš„åç§°ã€‚

+   `framework` (`str`, *å¯é€‰*, é»˜è®¤ä¸º `None`) â€” ç”¨äºå¯¼å‡ºçš„æ¡†æ¶ã€‚å¦‚æœæœªæä¾›ï¼Œåˆ™å‚è§ä¸Šæ–‡çš„ä¼˜å…ˆçº§ã€‚

ç¡®å®šç”¨äºå¯¼å‡ºçš„æ¡†æ¶ã€‚

ä¼˜å…ˆçº§æŒ‰ä»¥ä¸‹é¡ºåºæ’åˆ—ï¼š

1.  é€šè¿‡ `framework` çš„ç”¨æˆ·è¾“å…¥ã€‚

1.  å¦‚æœæä¾›äº†æœ¬åœ°æ£€æŸ¥ç‚¹ï¼Œåˆ™ä½¿ç”¨ä¸æ£€æŸ¥ç‚¹ç›¸åŒçš„æ¡†æ¶ã€‚

1.  ç¯å¢ƒä¸­å¯ç”¨çš„æ¡†æ¶ï¼Œä¼˜å…ˆè€ƒè™‘ PyTorchã€‚

#### `get_config`

[<æ¥æº>](https://github.com/huggingface/transformers/blob/v4.37.2/src/transformers/onnx/features.py#L736)

```py
( model_type: str feature: str ) â†’ export const metadata = 'undefined';OnnxConfig
```

å‚æ•°

+   `model_type` (`str`) â€” è¦æ£€ç´¢é…ç½®çš„æ¨¡å‹ç±»å‹ã€‚

+   `feature` (`str`) â€” è¦æ£€ç´¢é…ç½®çš„ç‰¹å¾ã€‚

è¿”å›

`OnnxConfig`

ç”¨äºç»„åˆçš„é…ç½®

è·å–æ¨¡å‹ç±»å‹å’Œç‰¹å¾ç»„åˆçš„ OnnxConfigã€‚

#### `get_model_class_for_feature`

[<æ¥æº>](https://github.com/huggingface/transformers/blob/v4.37.2/src/transformers/onnx/features.py#L601)

```py
( feature: str framework: str = 'pt' )
```

å‚æ•°

+   `feature` (`str`) â€” æ‰€éœ€çš„ç‰¹å¾ã€‚

+   `framework` (`str`, *å¯é€‰*, é»˜è®¤ä¸º `"pt"`) â€” ç”¨äºå¯¼å‡ºçš„æ¡†æ¶ã€‚

å°è¯•ä»ç‰¹å¾åç§°ä¸­æ£€ç´¢ AutoModel ç±»ã€‚

#### `get_model_from_feature`

[<æ¥æº>](https://github.com/huggingface/transformers/blob/v4.37.2/src/transformers/onnx/features.py#L678)

```py
( feature: str model: str framework: str = None cache_dir: str = None )
```

å‚æ•°

+   `feature` (`str`) â€” æ‰€éœ€çš„ç‰¹å¾ã€‚

+   `model` (`str`) â€” è¦å¯¼å‡ºçš„æ¨¡å‹çš„åç§°ã€‚

+   `framework` (`str`, *å¯é€‰*, é»˜è®¤ä¸º `None`) â€” ç”¨äºå¯¼å‡ºçš„æ¡†æ¶ã€‚å¦‚æœæœªæä¾›ï¼Œåˆ™å‚è§ `FeaturesManager.determine_framework` çš„ä¼˜å…ˆçº§ã€‚

å°è¯•ä»æ¨¡å‹çš„åç§°å’Œè¦å¯ç”¨çš„ç‰¹å¾ä¸­æ£€ç´¢æ¨¡å‹ã€‚

#### `get_supported_features_for_model_type`

[<æ¥æº>](https://github.com/huggingface/transformers/blob/v4.37.2/src/transformers/onnx/features.py#L556)

```py
( model_type: str model_name: Optional = None )
```

å‚æ•°

+   `model_type` (`str`) â€” è¦æ£€ç´¢æ”¯æŒç‰¹å¾çš„æ¨¡å‹ç±»å‹ã€‚

+   `model_name` (`str`, *å¯é€‰*) â€” æ¨¡å‹å¯¹è±¡çš„åç§°å±æ€§ï¼Œä»…ç”¨äºå¼‚å¸¸æ¶ˆæ¯ã€‚

å°è¯•ä»æ¨¡å‹ç±»å‹ä¸­æ£€ç´¢ç‰¹å¾ -> OnnxConfig æ„é€ å‡½æ•°æ˜ å°„ã€‚
