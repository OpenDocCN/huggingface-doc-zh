# åŠ è½½ç®¡é“ã€æ¨¡å‹å’Œè°ƒåº¦ç¨‹åº

> åŸå§‹æ–‡æœ¬ï¼š[`huggingface.co/docs/diffusers/using-diffusers/loading`](https://huggingface.co/docs/diffusers/using-diffusers/loading)

ä¸ºäº†ä½¿ç”¨æ‰©æ•£ç³»ç»Ÿè¿›è¡Œæ¨ç†çš„ç®€ä¾¿æ–¹å¼å¯¹äºğŸ§¨ Diffusers è‡³å…³é‡è¦ã€‚æ‰©æ•£ç³»ç»Ÿé€šå¸¸ç”±å¤šä¸ªç»„ä»¶ç»„æˆï¼Œå¦‚å‚æ•°åŒ–æ¨¡å‹ã€æ ‡è®°å™¨å’Œè°ƒåº¦ç¨‹åºï¼Œå®ƒä»¬ä»¥å¤æ‚çš„æ–¹å¼ç›¸äº’ä½œç”¨ã€‚è¿™å°±æ˜¯ä¸ºä»€ä¹ˆæˆ‘ä»¬è®¾è®¡äº† DiffusionPipelineï¼Œå°†æ•´ä¸ªæ‰©æ•£ç³»ç»Ÿçš„å¤æ‚æ€§åŒ…è£…æˆæ˜“äºä½¿ç”¨çš„ APIï¼ŒåŒæ—¶ä¿æŒè¶³å¤Ÿçš„çµæ´»æ€§ï¼Œä»¥é€‚åº”å…¶ä»–ç”¨ä¾‹ï¼Œä¾‹å¦‚å°†æ¯ä¸ªç»„ä»¶å•ç‹¬åŠ è½½ä¸ºæ„å»ºå—ï¼Œç»„è£…è‡ªå·±çš„æ‰©æ•£ç³»ç»Ÿã€‚

æ‚¨å¯ä»¥é€šè¿‡`from_pretrained()`æ–¹æ³•è®¿é—®æ¨ç†æˆ–è®­ç»ƒæ‰€éœ€çš„ä¸€åˆ‡ã€‚

æœ¬æŒ‡å—å°†å‘æ‚¨å±•ç¤ºå¦‚ä½•åŠ è½½ï¼š

+   æ¥è‡ª Hub å’Œæœ¬åœ°çš„ç®¡é“

+   å°†ä¸åŒçš„ç»„ä»¶åˆå¹¶åˆ°ä¸€ä¸ªç®¡é“ä¸­

+   æ£€æŸ¥ç‚¹å˜ä½“ï¼Œå¦‚ä¸åŒçš„æµ®ç‚¹ç±»å‹æˆ–éæŒ‡æ•°å‡å€¼å¹³å‡ï¼ˆEMAï¼‰æƒé‡

+   æ¨¡å‹å’Œè°ƒåº¦ç¨‹åº

## æ‰©æ•£ç®¡é“

ğŸ’¡ å¦‚æœæ‚¨æƒ³æ›´è¯¦ç»†åœ°äº†è§£ DiffusionPipeline ç±»çš„å·¥ä½œåŸç†ï¼Œè¯·è·³è½¬åˆ° DiffusionPipeline è§£é‡Šéƒ¨åˆ†ã€‚

DiffusionPipeline ç±»æ˜¯ä»[Hub](https://huggingface.co/models?library=diffusers&sort=trending)åŠ è½½æœ€æ–°æµè¡Œæ‰©æ•£æ¨¡å‹çš„æœ€ç®€å•å’Œæœ€é€šç”¨çš„æ–¹æ³•ã€‚DiffusionPipeline.from_pretrained()æ–¹æ³•ä¼šè‡ªåŠ¨æ£€æµ‹æ£€æŸ¥ç‚¹çš„æ­£ç¡®ç®¡é“ç±»ï¼Œä¸‹è½½å¹¶ç¼“å­˜æ‰€æœ‰å¿…éœ€çš„é…ç½®å’Œæƒé‡æ–‡ä»¶ï¼Œå¹¶è¿”å›ä¸€ä¸ªå‡†å¤‡å¥½è¿›è¡Œæ¨ç†çš„ç®¡é“å®ä¾‹ã€‚

```py
from diffusers import DiffusionPipeline

repo_id = "runwayml/stable-diffusion-v1-5"
pipe = DiffusionPipeline.from_pretrained(repo_id, use_safetensors=True)
```

æ‚¨è¿˜å¯ä»¥ä½¿ç”¨ç‰¹å®šçš„ç®¡é“ç±»åŠ è½½æ£€æŸ¥ç‚¹ã€‚ä¸Šé¢çš„ç¤ºä¾‹åŠ è½½äº†ä¸€ä¸ªç¨³å®šæ‰©æ•£æ¨¡å‹ï¼›è¦è·å¾—ç›¸åŒçš„ç»“æœï¼Œè¯·ä½¿ç”¨ StableDiffusionPipeline ç±»ï¼š

```py
from diffusers import StableDiffusionPipeline

repo_id = "runwayml/stable-diffusion-v1-5"
pipe = StableDiffusionPipeline.from_pretrained(repo_id, use_safetensors=True)
```

æ£€æŸ¥ç‚¹ï¼ˆå¦‚[`CompVis/stable-diffusion-v1-4`](https://huggingface.co/CompVis/stable-diffusion-v1-4)æˆ–[`runwayml/stable-diffusion-v1-5`](https://huggingface.co/runwayml/stable-diffusion-v1-5)ï¼‰ä¹Ÿå¯ä»¥ç”¨äºå¤šä¸ªä»»åŠ¡ï¼Œå¦‚æ–‡æœ¬åˆ°å›¾åƒæˆ–å›¾åƒåˆ°å›¾åƒã€‚è¦åŒºåˆ†è¦ä½¿ç”¨æ£€æŸ¥ç‚¹çš„ä»»åŠ¡ï¼Œæ‚¨å¿…é¡»ç›´æ¥åŠ è½½å®ƒä¸ç›¸åº”çš„ä»»åŠ¡ç‰¹å®šç®¡é“ç±»ï¼š

```py
from diffusers import StableDiffusionImg2ImgPipeline

repo_id = "runwayml/stable-diffusion-v1-5"
pipe = StableDiffusionImg2ImgPipeline.from_pretrained(repo_id)
```

### æœ¬åœ°ç®¡é“

è¦åœ¨æœ¬åœ°åŠ è½½æ‰©æ•£ç®¡é“ï¼Œè¯·ä½¿ç”¨[`git-lfs`](https://git-lfs.github.com/)æ‰‹åŠ¨ä¸‹è½½æ£€æŸ¥ç‚¹ï¼ˆåœ¨æœ¬ä¾‹ä¸­ï¼Œ[`runwayml/stable-diffusion-v1-5`](https://huggingface.co/runwayml/stable-diffusion-v1-5)ï¼‰åˆ°æ‚¨çš„æœ¬åœ°ç£ç›˜ã€‚è¿™å°†åœ¨æ‚¨çš„ç£ç›˜ä¸Šåˆ›å»ºä¸€ä¸ªæœ¬åœ°æ–‡ä»¶å¤¹`./stable-diffusion-v1-5`ï¼š

```py
git-lfs install
git clone https://huggingface.co/runwayml/stable-diffusion-v1-5
```

ç„¶åå°†æœ¬åœ°è·¯å¾„ä¼ é€’ç»™ from_pretrained()ï¼š

```py
from diffusers import DiffusionPipeline

repo_id = "./stable-diffusion-v1-5"
stable_diffusion = DiffusionPipeline.from_pretrained(repo_id, use_safetensors=True)
```

from_pretrained()æ–¹æ³•åœ¨æ£€æµ‹åˆ°æœ¬åœ°è·¯å¾„æ—¶ä¸ä¼šä» Hub ä¸‹è½½ä»»ä½•æ–‡ä»¶ï¼Œä½†è¿™ä¹Ÿæ„å‘³ç€å®ƒä¸ä¼šä¸‹è½½å’Œç¼“å­˜æ£€æŸ¥ç‚¹çš„æœ€æ–°æ›´æ”¹ã€‚

### åœ¨ç®¡é“ä¸­äº¤æ¢ç»„ä»¶

æ‚¨å¯ä»¥ä½¿ç”¨å¦ä¸€ä¸ªå…¼å®¹çš„ç»„ä»¶è‡ªå®šä¹‰ä»»ä½•ç®¡é“çš„é»˜è®¤ç»„ä»¶ã€‚è‡ªå®šä¹‰å¾ˆé‡è¦ï¼Œå› ä¸ºï¼š

+   æ›´æ”¹è°ƒåº¦ç¨‹åºå¯¹äºæ¢ç´¢ç”Ÿæˆé€Ÿåº¦å’Œè´¨é‡ä¹‹é—´çš„æƒè¡¡æ˜¯é‡è¦çš„ã€‚

+   æ¨¡å‹çš„ä¸åŒç»„ä»¶é€šå¸¸æ˜¯ç‹¬ç«‹è®­ç»ƒçš„ï¼Œæ‚¨å¯ä»¥ç”¨æ€§èƒ½æ›´å¥½çš„ç»„ä»¶æ›¿æ¢ä¸€ä¸ªç»„ä»¶ã€‚

+   åœ¨å¾®è°ƒæœŸé—´ï¼Œé€šå¸¸åªæœ‰ä¸€äº›ç»„ä»¶ - å¦‚ UNet æˆ–æ–‡æœ¬ç¼–ç å™¨ - è¢«è®­ç»ƒã€‚

æŸ¥æ‰¾å¯ä¾›å®šåˆ¶çš„è°ƒåº¦ç¨‹åºï¼Œæ‚¨å¯ä»¥ä½¿ç”¨`compatibles`æ–¹æ³•ï¼š

```py
from diffusers import DiffusionPipeline

repo_id = "runwayml/stable-diffusion-v1-5"
stable_diffusion = DiffusionPipeline.from_pretrained(repo_id, use_safetensors=True)
stable_diffusion.scheduler.compatibles
```

è®©æˆ‘ä»¬ä½¿ç”¨ SchedulerMixin.from_pretrained()æ–¹æ³•ï¼Œå°†é»˜è®¤çš„ PNDMScheduler æ›¿æ¢ä¸ºæ€§èƒ½æ›´é«˜çš„è°ƒåº¦ç¨‹åº EulerDiscreteSchedulerã€‚`subfolder="scheduler"`å‚æ•°æ˜¯å¿…éœ€çš„ï¼Œä»¥ä»æµæ°´çº¿å­˜å‚¨åº“çš„æ­£ç¡®[å­æ–‡ä»¶å¤¹](https://huggingface.co/runwayml/stable-diffusion-v1-5/tree/main/scheduler)åŠ è½½è°ƒåº¦ç¨‹åºé…ç½®ã€‚

ç„¶åï¼Œæ‚¨å¯ä»¥å°†æ–°çš„ EulerDiscreteScheduler å®ä¾‹ä¼ é€’ç»™ DiffusionPipeline ä¸­çš„`scheduler`å‚æ•°ï¼š

```py
from diffusers import DiffusionPipeline, EulerDiscreteScheduler

repo_id = "runwayml/stable-diffusion-v1-5"
scheduler = EulerDiscreteScheduler.from_pretrained(repo_id, subfolder="scheduler")
stable_diffusion = DiffusionPipeline.from_pretrained(repo_id, scheduler=scheduler, use_safetensors=True)
```

### å®‰å…¨æ£€æŸ¥å™¨

åƒ Stable Diffusion è¿™æ ·çš„æ‰©æ•£æ¨¡å‹å¯èƒ½ä¼šç”Ÿæˆæœ‰å®³å†…å®¹ï¼Œè¿™å°±æ˜¯ä¸ºä»€ä¹ˆğŸ§¨ Diffusers æœ‰ä¸€ä¸ª[å®‰å…¨æ£€æŸ¥å™¨](https://github.com/huggingface/diffusers/blob/main/src/diffusers/pipelines/stable_diffusion/safety_checker.py)ï¼Œç”¨äºæ£€æŸ¥ç”Ÿæˆçš„è¾“å‡ºæ˜¯å¦åŒ…å«å·²çŸ¥çš„ç¡¬ç¼–ç  NSFW å†…å®¹ã€‚å¦‚æœå‡ºäºä»»ä½•åŸå› è¦ç¦ç”¨å®‰å…¨æ£€æŸ¥å™¨ï¼Œè¯·å°†`None`ä¼ é€’ç»™`safety_checker`å‚æ•°ï¼š

```py
from diffusers import DiffusionPipeline

repo_id = "runwayml/stable-diffusion-v1-5"
stable_diffusion = DiffusionPipeline.from_pretrained(repo_id, safety_checker=None, use_safetensors=True)
"""
You have disabled the safety checker for <class 'diffusers.pipelines.stable_diffusion.pipeline_stable_diffusion.StableDiffusionPipeline'> by passing `safety_checker=None`. Ensure that you abide by the conditions of the Stable Diffusion license and do not expose unfiltered results in services or applications open to the public. Both the diffusers team and Hugging Face strongly recommend keeping the safety filter enabled in all public-facing circumstances, disabling it only for use cases that involve analyzing network behavior or auditing its results. For more information, please have a look at https://github.com/huggingface/diffusers/pull/254 .
"""
```

### åœ¨æµæ°´çº¿ä¹‹é—´é‡å¤ä½¿ç”¨ç»„ä»¶

æ‚¨è¿˜å¯ä»¥åœ¨å¤šä¸ªæµæ°´çº¿ä¸­é‡å¤ä½¿ç”¨ç›¸åŒçš„ç»„ä»¶ï¼Œä»¥é¿å…å°†æƒé‡åŠ è½½åˆ° RAM ä¸¤æ¬¡ã€‚ä½¿ç”¨ components æ–¹æ³•ä¿å­˜ç»„ä»¶ï¼š

```py
from diffusers import StableDiffusionPipeline, StableDiffusionImg2ImgPipeline

model_id = "runwayml/stable-diffusion-v1-5"
stable_diffusion_txt2img = StableDiffusionPipeline.from_pretrained(model_id, use_safetensors=True)

components = stable_diffusion_txt2img.components
```

ç„¶åï¼Œæ‚¨å¯ä»¥å°†`components`ä¼ é€’ç»™å¦ä¸€ä¸ªæµæ°´çº¿ï¼Œè€Œæ— éœ€é‡æ–°åŠ è½½æƒé‡åˆ° RAMï¼š

```py
stable_diffusion_img2img = StableDiffusionImg2ImgPipeline(**components)
```

å¦‚æœè¦æ›´çµæ´»åœ°é€‰æ‹©è¦é‡ç”¨æˆ–ç¦ç”¨çš„ç»„ä»¶ï¼Œä¹Ÿå¯ä»¥å°†ç»„ä»¶å•ç‹¬ä¼ é€’ç»™æµæ°´çº¿ã€‚ä¾‹å¦‚ï¼Œåœ¨æ–‡æœ¬åˆ°å›¾åƒæµæ°´çº¿ä¸­é‡ç”¨ç›¸åŒçš„ç»„ä»¶ï¼Œé™¤äº†å®‰å…¨æ£€æŸ¥å™¨å’Œç‰¹å¾æå–å™¨ï¼Œåœ¨å›¾åƒåˆ°å›¾åƒæµæ°´çº¿ä¸­ï¼š

```py
from diffusers import StableDiffusionPipeline, StableDiffusionImg2ImgPipeline

model_id = "runwayml/stable-diffusion-v1-5"
stable_diffusion_txt2img = StableDiffusionPipeline.from_pretrained(model_id, use_safetensors=True)
stable_diffusion_img2img = StableDiffusionImg2ImgPipeline(
    vae=stable_diffusion_txt2img.vae,
    text_encoder=stable_diffusion_txt2img.text_encoder,
    tokenizer=stable_diffusion_txt2img.tokenizer,
    unet=stable_diffusion_txt2img.unet,
    scheduler=stable_diffusion_txt2img.scheduler,
    safety_checker=None,
    feature_extractor=None,
    requires_safety_checker=False,
)
```

## æ£€æŸ¥ç‚¹å˜ä½“

æ£€æŸ¥ç‚¹å˜ä½“é€šå¸¸æ˜¯å…¶æƒé‡ä¸ºï¼š

+   å­˜å‚¨åœ¨ä¸åŒçš„æµ®ç‚¹ç±»å‹ä¸­ï¼Œä»¥é™ä½ç²¾åº¦å’Œå­˜å‚¨ï¼Œä¾‹å¦‚[`torch.float16`](https://pytorch.org/docs/stable/tensors.html#data-types)ï¼Œå› ä¸ºå®ƒåªéœ€è¦ä¸€åŠçš„å¸¦å®½å’Œå­˜å‚¨ç©ºé—´æ¥ä¸‹è½½ã€‚å¦‚æœæ‚¨ç»§ç»­è®­ç»ƒæˆ–ä½¿ç”¨ CPUï¼Œåˆ™ä¸èƒ½ä½¿ç”¨æ­¤å˜ä½“ã€‚

+   éæŒ‡æ•°å‡å€¼å¹³å‡ï¼ˆEMAï¼‰æƒé‡ï¼Œä¸åº”ç”¨äºæ¨æ–­ã€‚æ‚¨åº”è¯¥ä½¿ç”¨è¿™äº›æƒé‡æ¥ç»§ç»­å¾®è°ƒæ¨¡å‹ã€‚

ğŸ’¡ å½“æ£€æŸ¥ç‚¹å…·æœ‰ç›¸åŒçš„æ¨¡å‹ç»“æ„ï¼Œä½†å®ƒä»¬æ˜¯åœ¨ä¸åŒæ•°æ®é›†ä¸Šè®­ç»ƒå¹¶ä½¿ç”¨ä¸åŒçš„è®­ç»ƒè®¾ç½®æ—¶ï¼Œåº”å°†å®ƒä»¬å­˜å‚¨åœ¨å•ç‹¬çš„å­˜å‚¨åº“ä¸­ï¼Œè€Œä¸æ˜¯å˜ä½“ï¼ˆä¾‹å¦‚ï¼Œ`stable-diffusion-v1-4`å’Œ`stable-diffusion-v1-5`ï¼‰ã€‚

å¦åˆ™ï¼Œå˜ä½“ä¸åŸå§‹æ£€æŸ¥ç‚¹**å®Œå…¨ç›¸åŒ**ã€‚å®ƒä»¬å…·æœ‰å®Œå…¨ç›¸åŒçš„åºåˆ—åŒ–æ ¼å¼ï¼ˆä¾‹å¦‚ Safetensorsï¼‰ã€æ¨¡å‹ç»“æ„å’Œå…·æœ‰ç›¸åŒå¼ é‡å½¢çŠ¶çš„æƒé‡ã€‚

| **æ£€æŸ¥ç‚¹ç±»å‹** | **æƒé‡åç§°** | **åŠ è½½æƒé‡çš„å‚æ•°** |
| --- | --- | --- |
| åŸå§‹ | diffusion_pytorch_model.bin |  |
| æµ®ç‚¹æ•° | diffusion_pytorch_model.fp16.bin | `variant`ï¼Œ`torch_dtype` |
| é EMA | diffusion_pytorch_model.non_ema.bin | `variant` |

åŠ è½½å˜ä½“æ—¶éœ€è¦äº†è§£çš„ä¸¤ä¸ªé‡è¦å‚æ•°ï¼š

+   `torch_dtype`å®šä¹‰äº†åŠ è½½æ£€æŸ¥ç‚¹çš„æµ®ç‚¹ç²¾åº¦ã€‚ä¾‹å¦‚ï¼Œå¦‚æœæ‚¨æƒ³é€šè¿‡åŠ è½½`fp16`å˜ä½“æ¥èŠ‚çœå¸¦å®½ï¼Œæ‚¨åº”è¯¥æŒ‡å®š`torch_dtype=torch.float16`æ¥*å°†æƒé‡*è½¬æ¢ä¸º`fp16`ã€‚å¦åˆ™ï¼Œ`fp16`æƒé‡å°†è½¬æ¢ä¸ºé»˜è®¤çš„`fp32`ç²¾åº¦ã€‚æ‚¨ä¹Ÿå¯ä»¥åœ¨ä¸å®šä¹‰`variant`å‚æ•°çš„æƒ…å†µä¸‹åŠ è½½åŸå§‹æ£€æŸ¥ç‚¹ï¼Œå¹¶ä½¿ç”¨`torch_dtype=torch.float16`å°†å…¶è½¬æ¢ä¸º`fp16`ã€‚åœ¨è¿™ç§æƒ…å†µä¸‹ï¼Œé¦–å…ˆä¸‹è½½é»˜è®¤çš„`fp32`æƒé‡ï¼Œç„¶ååœ¨åŠ è½½åå°†å…¶è½¬æ¢ä¸º`fp16`ã€‚

+   `variant`å®šä¹‰äº†åº”ä»å­˜å‚¨åº“åŠ è½½å“ªäº›æ–‡ä»¶ã€‚ä¾‹å¦‚ï¼Œå¦‚æœæ‚¨æƒ³ä»[`diffusers/stable-diffusion-variants`](https://huggingface.co/diffusers/stable-diffusion-variants/tree/main/unet)å­˜å‚¨åº“åŠ è½½`non_ema`å˜ä½“ï¼Œæ‚¨åº”è¯¥æŒ‡å®š`variant="non_ema"`ä»¥ä¸‹è½½`non_ema`æ–‡ä»¶ã€‚

```py
from diffusers import DiffusionPipeline
import torch

# load fp16 variant
stable_diffusion = DiffusionPipeline.from_pretrained(
    "runwayml/stable-diffusion-v1-5", variant="fp16", torch_dtype=torch.float16, use_safetensors=True
)
# load non_ema variant
stable_diffusion = DiffusionPipeline.from_pretrained(
    "runwayml/stable-diffusion-v1-5", variant="non_ema", use_safetensors=True
)
```

è¦ä¿å­˜å­˜å‚¨åœ¨ä¸åŒæµ®ç‚¹ç±»å‹æˆ–é EMA å˜ä½“ä¸­çš„æ£€æŸ¥ç‚¹ï¼Œè¯·ä½¿ç”¨ DiffusionPipeline.save_pretrained()æ–¹æ³•å¹¶æŒ‡å®š`variant`å‚æ•°ã€‚æ‚¨åº”è¯¥å°è¯•å°†å˜ä½“ä¿å­˜åˆ°ä¸åŸå§‹æ£€æŸ¥ç‚¹ç›¸åŒçš„æ–‡ä»¶å¤¹ä¸­ï¼Œä»¥ä¾¿æ‚¨å¯ä»¥ä»åŒä¸€æ–‡ä»¶å¤¹ä¸­åŠ è½½ä¸¤è€…ï¼š

```py
from diffusers import DiffusionPipeline

# save as fp16 variant
stable_diffusion.save_pretrained("runwayml/stable-diffusion-v1-5", variant="fp16")
# save as non-ema variant
stable_diffusion.save_pretrained("runwayml/stable-diffusion-v1-5", variant="non_ema")
```

å¦‚æœæ‚¨ä¸å°†å˜ä½“ä¿å­˜åˆ°ç°æœ‰æ–‡ä»¶å¤¹ä¸­ï¼Œåˆ™å¿…é¡»æŒ‡å®š`variant`å‚æ•°ï¼Œå¦åˆ™å®ƒä¼šæŠ›å‡ºä¸€ä¸ª`Exception`ï¼Œå› ä¸ºå®ƒæ‰¾ä¸åˆ°åŸå§‹çš„æ£€æŸ¥ç‚¹ï¼š

```py
# ğŸ‘ this won't work
stable_diffusion = DiffusionPipeline.from_pretrained(
    "./stable-diffusion-v1-5", torch_dtype=torch.float16, use_safetensors=True
)
# ğŸ‘ this works
stable_diffusion = DiffusionPipeline.from_pretrained(
    "./stable-diffusion-v1-5", variant="fp16", torch_dtype=torch.float16, use_safetensors=True
)
```

## æ¨¡å‹

æ¨¡å‹æ˜¯ä» ModelMixin.from_pretrained()æ–¹æ³•åŠ è½½çš„ï¼Œè¯¥æ–¹æ³•ä¸‹è½½å¹¶ç¼“å­˜æ¨¡å‹æƒé‡å’Œé…ç½®çš„æœ€æ–°ç‰ˆæœ¬ã€‚å¦‚æœæœ€æ–°æ–‡ä»¶åœ¨æœ¬åœ°ç¼“å­˜ä¸­å¯ç”¨ï¼Œfrom_pretrained()å°†é‡ç”¨ç¼“å­˜ä¸­çš„æ–‡ä»¶è€Œä¸æ˜¯é‡æ–°ä¸‹è½½å®ƒä»¬ã€‚

æ¨¡å‹å¯ä»¥é€šè¿‡`subfolder`å‚æ•°ä»å­æ–‡ä»¶å¤¹åŠ è½½ã€‚ä¾‹å¦‚ï¼Œ`runwayml/stable-diffusion-v1-5`çš„æ¨¡å‹æƒé‡å­˜å‚¨åœ¨[`unet`](https://huggingface.co/runwayml/stable-diffusion-v1-5/tree/main/unet)å­æ–‡ä»¶å¤¹ä¸­ï¼š

```py
from diffusers import UNet2DConditionModel

repo_id = "runwayml/stable-diffusion-v1-5"
model = UNet2DConditionModel.from_pretrained(repo_id, subfolder="unet", use_safetensors=True)
```

æˆ–ç›´æ¥ä»å­˜å‚¨åº“çš„[ç›®å½•](https://huggingface.co/google/ddpm-cifar10-32/tree/main)åŠ è½½ï¼š

```py
from diffusers import UNet2DModel

repo_id = "google/ddpm-cifar10-32"
model = UNet2DModel.from_pretrained(repo_id, use_safetensors=True)
```

æ‚¨è¿˜å¯ä»¥é€šè¿‡åœ¨ ModelMixin.from_pretrained()å’Œ ModelMixin.save_pretrained()ä¸­æŒ‡å®š`variant`å‚æ•°æ¥åŠ è½½å’Œä¿å­˜æ¨¡å‹å˜ä½“ï¼š

```py
from diffusers import UNet2DConditionModel

model = UNet2DConditionModel.from_pretrained(
    "runwayml/stable-diffusion-v1-5", subfolder="unet", variant="non_ema", use_safetensors=True
)
model.save_pretrained("./local-unet", variant="non_ema")
```

## è°ƒåº¦å™¨

è°ƒåº¦å™¨æ˜¯ä» SchedulerMixin.from_pretrained()æ–¹æ³•åŠ è½½çš„ï¼Œä¸æ¨¡å‹ä¸åŒï¼Œè°ƒåº¦å™¨**ä¸æ˜¯å‚æ•°åŒ–**æˆ–**è®­ç»ƒ**ï¼›å®ƒä»¬ç”±é…ç½®æ–‡ä»¶å®šä¹‰ã€‚

åŠ è½½è°ƒåº¦å™¨ä¸ä¼šæ¶ˆè€—å¤§é‡å†…å­˜ï¼Œå¹¶ä¸”ç›¸åŒçš„é…ç½®æ–‡ä»¶å¯ä»¥ç”¨äºå„ç§ä¸åŒçš„è°ƒåº¦å™¨ã€‚ä¾‹å¦‚ï¼Œä»¥ä¸‹è°ƒåº¦å™¨ä¸ StableDiffusionPipeline å…¼å®¹ï¼Œè¿™æ„å‘³ç€æ‚¨å¯ä»¥åœ¨è¿™äº›ç±»ä¸­çš„ä»»ä½•ä¸€ä¸ªä¸­åŠ è½½ç›¸åŒçš„è°ƒåº¦å™¨é…ç½®æ–‡ä»¶ï¼š

```py
from diffusers import StableDiffusionPipeline
from diffusers import (
    DDPMScheduler,
    DDIMScheduler,
    PNDMScheduler,
    LMSDiscreteScheduler,
    EulerAncestralDiscreteScheduler,
    EulerDiscreteScheduler,
    DPMSolverMultistepScheduler,
)

repo_id = "runwayml/stable-diffusion-v1-5"

ddpm = DDPMScheduler.from_pretrained(repo_id, subfolder="scheduler")
ddim = DDIMScheduler.from_pretrained(repo_id, subfolder="scheduler")
pndm = PNDMScheduler.from_pretrained(repo_id, subfolder="scheduler")
lms = LMSDiscreteScheduler.from_pretrained(repo_id, subfolder="scheduler")
euler_anc = EulerAncestralDiscreteScheduler.from_pretrained(repo_id, subfolder="scheduler")
euler = EulerDiscreteScheduler.from_pretrained(repo_id, subfolder="scheduler")
dpm = DPMSolverMultistepScheduler.from_pretrained(repo_id, subfolder="scheduler")

# replace `dpm` with any of `ddpm`, `ddim`, `pndm`, `lms`, `euler_anc`, `euler`
pipeline = StableDiffusionPipeline.from_pretrained(repo_id, scheduler=dpm, use_safetensors=True)
```

## DiffusionPipeline è§£é‡Š

ä½œä¸ºä¸€ä¸ªç±»æ–¹æ³•ï¼ŒDiffusionPipeline.from_pretrained()è´Ÿè´£ä¸¤ä»¶äº‹ï¼š

+   ä¸‹è½½æ¨ç†æ‰€éœ€çš„æœ€æ–°æ–‡ä»¶å¤¹ç»“æ„å¹¶ç¼“å­˜ã€‚å¦‚æœæœ€æ–°çš„æ–‡ä»¶å¤¹ç»“æ„åœ¨æœ¬åœ°ç¼“å­˜ä¸­å¯ç”¨ï¼ŒDiffusionPipeline.from_pretrained()å°†é‡ç”¨ç¼“å­˜ï¼Œä¸ä¼šé‡æ–°ä¸‹è½½æ–‡ä»¶ã€‚

+   å°†ç¼“å­˜çš„æƒé‡åŠ è½½åˆ°æ­£ç¡®çš„æµæ°´çº¿ class ä¸­-ä»`model_index.json`æ–‡ä»¶ä¸­æ£€ç´¢-å¹¶è¿”å›å…¶å®ä¾‹ã€‚

æµæ°´çº¿çš„åŸºç¡€æ–‡ä»¶å¤¹ç»“æ„ç›´æ¥å¯¹åº”äºå®ƒä»¬çš„ç±»å®ä¾‹ã€‚ä¾‹å¦‚ï¼ŒStableDiffusionPipeline å¯¹åº”äº[`runwayml/stable-diffusion-v1-5`](https://huggingface.co/runwayml/stable-diffusion-v1-5)ä¸­çš„æ–‡ä»¶å¤¹ç»“æ„ã€‚

```py
from diffusers import DiffusionPipeline

repo_id = "runwayml/stable-diffusion-v1-5"
pipeline = DiffusionPipeline.from_pretrained(repo_id, use_safetensors=True)
print(pipeline)
```

æ‚¨å°†çœ‹åˆ°æµæ°´çº¿æ˜¯ StableDiffusionPipeline çš„ä¸€ä¸ªå®ä¾‹ï¼Œç”±ä¸ƒä¸ªç»„ä»¶ç»„æˆï¼š

+   `"feature_extractor"`ï¼šæ¥è‡ªğŸ¤— Transformers çš„[CLIPImageProcessor](https://huggingface.co/docs/transformers/v4.37.2/en/model_doc/clip#transformers.CLIPImageProcessor)ã€‚

+   `"safety_checker"`ï¼šç”¨äºç­›é€‰æœ‰å®³å†…å®¹çš„[ç»„ä»¶](https://github.com/huggingface/diffusers/blob/e55687e1e15407f60f32242027b7bb8170e58266/src/diffusers/pipelines/stable_diffusion/safety_checker.py#L32)ã€‚

+   â€œè°ƒåº¦ç¨‹åºâ€ï¼šPNDMScheduler çš„ä¸€ä¸ªå®ä¾‹ã€‚

+   `"text_encoder"`ï¼šæ¥è‡ªğŸ¤— Transformers çš„[CLIPTextModel](https://huggingface.co/docs/transformers/v4.37.2/en/model_doc/clip#transformers.CLIPTextModel)ã€‚

+   `"tokenizer"`ï¼šæ¥è‡ªğŸ¤— Transformers çš„[CLIPTokenizer](https://huggingface.co/docs/transformers/v4.37.2/en/model_doc/clip#transformers.CLIPTokenizer)ã€‚

+   `"unet"`ï¼šUNet2DConditionModel çš„ä¸€ä¸ªå®ä¾‹ã€‚

+   `"vae"`ï¼šAutoencoderKL çš„ä¸€ä¸ªå®ä¾‹ã€‚

```py
StableDiffusionPipeline {
  "feature_extractor": [
    "transformers",
    "CLIPImageProcessor"
  ],
  "safety_checker": [
    "stable_diffusion",
    "StableDiffusionSafetyChecker"
  ],
  "scheduler": [
    "diffusers",
    "PNDMScheduler"
  ],
  "text_encoder": [
    "transformers",
    "CLIPTextModel"
  ],
  "tokenizer": [
    "transformers",
    "CLIPTokenizer"
  ],
  "unet": [
    "diffusers",
    "UNet2DConditionModel"
  ],
  "vae": [
    "diffusers",
    "AutoencoderKL"
  ]
}
```

å°†æµæ°´çº¿å®ä¾‹çš„ç»„ä»¶ä¸[`runwayml/stable-diffusion-v1-5`](https://huggingface.co/runwayml/stable-diffusion-v1-5/tree/main)æ–‡ä»¶å¤¹ç»“æ„è¿›è¡Œæ¯”è¾ƒï¼Œæ‚¨å°†çœ‹åˆ°å­˜å‚¨åº“ä¸­æ¯ä¸ªç»„ä»¶éƒ½æœ‰ä¸€ä¸ªå•ç‹¬çš„æ–‡ä»¶å¤¹ï¼š

```py
.
â”œâ”€â”€ feature_extractor
â”‚Â Â  â””â”€â”€ preprocessor_config.json
â”œâ”€â”€ model_index.json
â”œâ”€â”€ safety_checker
â”‚Â Â  â”œâ”€â”€ config.json
| â”œâ”€â”€ model.fp16.safetensors
â”‚   â”œâ”€â”€ model.safetensors
â”‚   â”œâ”€â”€ pytorch_model.bin | â””â”€â”€ pytorch_model.fp16.bin
â”œâ”€â”€ scheduler
â”‚Â Â  â””â”€â”€ scheduler_config.json
â”œâ”€â”€ text_encoder
â”‚Â Â  â”œâ”€â”€ config.json | â”œâ”€â”€ model.fp16.safetensors
â”‚   â”œâ”€â”€ model.safetensors
â”‚ |â”€â”€ pytorch_model.bin | â””â”€â”€ pytorch_model.fp16.bin
â”œâ”€â”€ tokenizer
â”‚Â Â  â”œâ”€â”€ merges.txt
â”‚Â Â  â”œâ”€â”€ special_tokens_map.json
â”‚Â Â  â”œâ”€â”€ tokenizer_config.json
â”‚Â Â  â””â”€â”€ vocab.json
â”œâ”€â”€ unet
â”‚Â Â  â”œâ”€â”€ config.json
â”‚Â Â  â”œâ”€â”€ diffusion_pytorch_model.bin |  |â”€â”€ diffusion_pytorch_model.fp16.bin
â”‚ |â”€â”€ diffusion_pytorch_model.f16.safetensors
â”‚ |â”€â”€ diffusion_pytorch_model.non_ema.bin
â”‚ |â”€â”€ diffusion_pytorch_model.non_ema.safetensors
â”‚   â””â”€â”€ diffusion_pytorch_model.safetensors |â”€â”€ vae
.   â”œâ”€â”€ config.json
.   â”œâ”€â”€ diffusion_pytorch_model.bin
    â”œâ”€â”€ diffusion_pytorch_model.fp16.bin
    â”œâ”€â”€ diffusion_pytorch_model.fp16.safetensors
    â””â”€â”€ diffusion_pytorch_model.safetensors
```

æ‚¨å¯ä»¥å°†æµæ°´çº¿çš„æ¯ä¸ªç»„ä»¶ä½œä¸ºå±æ€§è®¿é—®ä»¥æŸ¥çœ‹å…¶é…ç½®ï¼š

```py
pipeline.tokenizer
CLIPTokenizer(
    name_or_path="/root/.cache/huggingface/hub/models--runwayml--stable-diffusion-v1-5/snapshots/39593d5650112b4cc580433f6b0435385882d819/tokenizer",
    vocab_size=49408,
    model_max_length=77,
    is_fast=False,
    padding_side="right",
    truncation_side="right",
    special_tokens={
        "bos_token": AddedToken("<|startoftext|>", rstrip=False, lstrip=False, single_word=False, normalized=True),
        "eos_token": AddedToken("<|endoftext|>", rstrip=False, lstrip=False, single_word=False, normalized=True),
        "unk_token": AddedToken("<|endoftext|>", rstrip=False, lstrip=False, single_word=False, normalized=True),
        "pad_token": "<|endoftext|>",
    },
    clean_up_tokenization_spaces=True
)
```

æ¯ä¸ªæµæ°´çº¿éƒ½éœ€è¦ä¸€ä¸ª[`model_index.json`](https://huggingface.co/runwayml/stable-diffusion-v1-5/blob/main/model_index.json)æ–‡ä»¶ï¼Œå‘Šè¯‰ DiffusionPipelineï¼š

+   ä»`_class_name`åŠ è½½å“ªä¸ªæµæ°´çº¿ç±»

+   åœ¨`_diffusers_version`ä¸­ä½¿ç”¨å“ªä¸ªç‰ˆæœ¬çš„ğŸ§¨ Diffusers åˆ›å»ºæ¨¡å‹ã€‚

+   ä»å“ªä¸ªåº“çš„å“ªäº›ç»„ä»¶å­˜å‚¨åœ¨å­æ–‡ä»¶å¤¹ä¸­ï¼ˆ`name`å¯¹åº”ç»„ä»¶å’Œå­æ–‡ä»¶å¤¹åç§°ï¼Œ`library`å¯¹åº”è¦ä»ä¸­åŠ è½½ç±»çš„åº“åç§°ï¼Œ`class`å¯¹åº”ç±»åï¼‰

```py
{
  "_class_name": "StableDiffusionPipeline",
  "_diffusers_version": "0.6.0",
  "feature_extractor": [
    "transformers",
    "CLIPImageProcessor"
  ],
  "safety_checker": [
    "stable_diffusion",
    "StableDiffusionSafetyChecker"
  ],
  "scheduler": [
    "diffusers",
    "PNDMScheduler"
  ],
  "text_encoder": [
    "transformers",
    "CLIPTextModel"
  ],
  "tokenizer": [
    "transformers",
    "CLIPTokenizer"
  ],
  "unet": [
    "diffusers",
    "UNet2DConditionModel"
  ],
  "vae": [
    "diffusers",
    "AutoencoderKL"
  ]
}
```
