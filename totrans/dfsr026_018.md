# åŠ è½½ç¤¾åŒºç®¡é“å’Œç»„ä»¶

> åŸæ–‡é“¾æ¥ï¼š[https://huggingface.co/docs/diffusers/using-diffusers/custom_pipeline_overview](https://huggingface.co/docs/diffusers/using-diffusers/custom_pipeline_overview)

## ç¤¾åŒºç®¡é“

ç¤¾åŒºç®¡é“æ˜¯ä»»ä½•ä¸åŸå§‹å®ç°ä¸åŒçš„[DiffusionPipeline](/docs/diffusers/v0.26.3/en/api/pipelines/overview#diffusers.DiffusionPipeline)ç±»ï¼Œå¦‚å…¶è®ºæ–‡ä¸­æ‰€è¿°ï¼ˆä¾‹å¦‚ï¼Œ[StableDiffusionControlNetPipeline](/docs/diffusers/v0.26.3/en/api/pipelines/controlnet#diffusers.StableDiffusionControlNetPipeline)å¯¹åº”äº[ä½¿ç”¨ControlNetæ¡ä»¶ç”Ÿæˆæ–‡æœ¬åˆ°å›¾åƒ](https://arxiv.org/abs/2302.05543)çš„è®ºæ–‡ï¼‰ã€‚å®ƒä»¬æä¾›é¢å¤–çš„åŠŸèƒ½æˆ–æ‰©å±•äº†ç®¡é“çš„åŸå§‹å®ç°ã€‚

æœ‰è®¸å¤šå¾ˆé…·çš„ç¤¾åŒºç®¡é“ï¼Œæ¯”å¦‚[è¯­éŸ³åˆ°å›¾åƒ](https://github.com/huggingface/diffusers/tree/main/examples/community#speech-to-image)æˆ–[å¯ç»„åˆç¨³å®šæ‰©æ•£](https://github.com/huggingface/diffusers/tree/main/examples/community#composable-stable-diffusion)ï¼Œæ‚¨å¯ä»¥åœ¨[è¿™é‡Œ](https://github.com/huggingface/diffusers/tree/main/examples/community)æ‰¾åˆ°æ‰€æœ‰å®˜æ–¹ç¤¾åŒºç®¡é“ã€‚

è¦åœ¨Hubä¸ŠåŠ è½½ä»»ä½•ç¤¾åŒºç®¡é“ï¼Œè¯·å°†ç¤¾åŒºç®¡é“çš„å­˜å‚¨åº“IDä¼ é€’ç»™`custom_pipeline`å‚æ•°ï¼Œå¹¶æŒ‡å®šæ‚¨å¸Œæœ›ä»ä¸­åŠ è½½ç®¡é“æƒé‡å’Œç»„ä»¶çš„æ¨¡å‹å­˜å‚¨åº“ã€‚ä¾‹å¦‚ï¼Œä¸‹é¢çš„ç¤ºä¾‹ä»[`hf-internal-testing/diffusers-dummy-pipeline`](https://huggingface.co/hf-internal-testing/diffusers-dummy-pipeline/blob/main/pipeline.py)åŠ è½½ä¸€ä¸ªè™šæ‹Ÿç®¡é“ï¼Œä»[`google/ddpm-cifar10-32`](https://huggingface.co/google/ddpm-cifar10-32)åŠ è½½ç®¡é“æƒé‡å’Œç»„ä»¶ï¼š

ğŸ”’ é€šè¿‡ä»Hugging Face HubåŠ è½½ç¤¾åŒºç®¡é“ï¼Œæ‚¨æ­£åœ¨ä¿¡ä»»æ‚¨åŠ è½½çš„ä»£ç æ˜¯å®‰å…¨çš„ã€‚åœ¨è‡ªåŠ¨åŠ è½½å’Œè¿è¡Œä¹‹å‰ï¼Œè¯·ç¡®ä¿åœ¨çº¿æ£€æŸ¥ä»£ç ï¼

```py
from diffusers import DiffusionPipeline

pipeline = DiffusionPipeline.from_pretrained(
    "google/ddpm-cifar10-32", custom_pipeline="hf-internal-testing/diffusers-dummy-pipeline", use_safetensors=True
)
```

åŠ è½½å®˜æ–¹ç¤¾åŒºç®¡é“ç±»ä¼¼ï¼Œä½†æ‚¨å¯ä»¥æ··åˆä»å®˜æ–¹å­˜å‚¨åº“IDåŠ è½½æƒé‡å¹¶ç›´æ¥ä¼ é€’ç®¡é“ç»„ä»¶ã€‚ä¸‹é¢çš„ç¤ºä¾‹åŠ è½½äº†ç¤¾åŒº[CLIPå¼•å¯¼ç¨³å®šæ‰©æ•£](https://github.com/huggingface/diffusers/tree/main/examples/community#clip-guided-stable-diffusion)ç®¡é“ï¼Œæ‚¨å¯ä»¥ç›´æ¥ä¼ é€’CLIPæ¨¡å‹ç»„ä»¶ç»™å®ƒï¼š

```py
from diffusers import DiffusionPipeline
from transformers import CLIPImageProcessor, CLIPModel

clip_model_id = "laion/CLIP-ViT-B-32-laion2B-s34B-b79K"

feature_extractor = CLIPImageProcessor.from_pretrained(clip_model_id)
clip_model = CLIPModel.from_pretrained(clip_model_id)

pipeline = DiffusionPipeline.from_pretrained(
    "runwayml/stable-diffusion-v1-5",
    custom_pipeline="clip_guided_stable_diffusion",
    clip_model=clip_model,
    feature_extractor=feature_extractor,
    use_safetensors=True,
)
```

æœ‰å…³ç¤¾åŒºç®¡é“çš„æ›´å¤šä¿¡æ¯ï¼Œè¯·æŸ¥çœ‹[ç¤¾åŒºç®¡é“](custom_pipeline_examples)æŒ‡å—ï¼Œäº†è§£å¦‚ä½•ä½¿ç”¨å®ƒä»¬ï¼Œå¦‚æœæ‚¨æœ‰å…´è¶£æ·»åŠ ç¤¾åŒºç®¡é“ï¼Œè¯·æŸ¥çœ‹[å¦‚ä½•è´¡çŒ®ç¤¾åŒºç®¡é“](contribute_pipeline)æŒ‡å—ï¼

## ç¤¾åŒºç»„ä»¶

ç¤¾åŒºç»„ä»¶å…è®¸ç”¨æˆ·æ„å»ºå¯èƒ½å…·æœ‰è‡ªå®šä¹‰ç»„ä»¶çš„ç®¡é“ï¼Œè¿™äº›ç»„ä»¶ä¸æ˜¯Diffusersçš„ä¸€éƒ¨åˆ†ã€‚å¦‚æœæ‚¨çš„ç®¡é“å…·æœ‰Diffuserså°šæœªæ”¯æŒçš„è‡ªå®šä¹‰ç»„ä»¶ï¼Œæ‚¨éœ€è¦æä¾›å®ƒä»¬çš„å®ç°ä½œä¸ºPythonæ¨¡å—ã€‚è¿™äº›å®šåˆ¶ç»„ä»¶å¯ä»¥æ˜¯VAEã€UNetå’Œè°ƒåº¦å™¨ã€‚åœ¨å¤§å¤šæ•°æƒ…å†µä¸‹ï¼Œæ–‡æœ¬ç¼–ç å™¨æ˜¯ä»Transformersåº“å¯¼å…¥çš„ã€‚ç®¡é“ä»£ç æœ¬èº«ä¹Ÿå¯ä»¥å®šåˆ¶ã€‚

æœ¬èŠ‚å±•ç¤ºäº†ç”¨æˆ·åº”å¦‚ä½•ä½¿ç”¨ç¤¾åŒºç»„ä»¶æ¥æ„å»ºç¤¾åŒºç®¡é“ã€‚

æ‚¨å°†ä½¿ç”¨[showlab/show-1-base](https://huggingface.co/showlab/show-1-base)ç®¡é“æ£€æŸ¥ç‚¹ä½œä¸ºç¤ºä¾‹ã€‚å› æ­¤ï¼Œè®©æˆ‘ä»¬å¼€å§‹åŠ è½½ç»„ä»¶ï¼š

1.  ä»Transformerså¯¼å…¥å¹¶åŠ è½½æ–‡æœ¬ç¼–ç å™¨ï¼š

```py
from transformers import T5Tokenizer, T5EncoderModel

pipe_id = "showlab/show-1-base"
tokenizer = T5Tokenizer.from_pretrained(pipe_id, subfolder="tokenizer")
text_encoder = T5EncoderModel.from_pretrained(pipe_id, subfolder="text_encoder")
```

1.  åŠ è½½è°ƒåº¦å™¨ï¼š

```py
from diffusers import DPMSolverMultistepScheduler

scheduler = DPMSolverMultistepScheduler.from_pretrained(pipe_id, subfolder="scheduler")
```

1.  åŠ è½½å›¾åƒå¤„ç†å™¨ï¼š

```py
from transformers import CLIPFeatureExtractor

feature_extractor = CLIPFeatureExtractor.from_pretrained(pipe_id, subfolder="feature_extractor")
```

åœ¨æ­¥éª¤4å’Œ5ä¸­ï¼Œè‡ªå®šä¹‰[UNet](https://github.com/showlab/Show-1/blob/main/showone/models/unet_3d_condition.py)å’Œ[pipeline](https://huggingface.co/sayakpaul/show-1-base-with-code/blob/main/unet/showone_unet_3d_condition.py)çš„å®ç°å¿…é¡»ä¸å…¶æ–‡ä»¶ä¸­æ˜¾ç¤ºçš„æ ¼å¼åŒ¹é…ï¼Œä»¥ä½¿æ­¤ç¤ºä¾‹æ­£å¸¸å·¥ä½œã€‚

1.  ç°åœ¨ï¼Œæ‚¨å°†åŠ è½½ä¸€ä¸ª[è‡ªå®šä¹‰UNet](https://github.com/showlab/Show-1/blob/main/showone/models/unet_3d_condition.py)ï¼Œåœ¨æœ¬ç¤ºä¾‹ä¸­ï¼Œå·²ç»åœ¨`showone_unet_3d_condition.py`[è„šæœ¬](https://huggingface.co/sayakpaul/show-1-base-with-code/blob/main/unet/showone_unet_3d_condition.py)ä¸­å®ç°äº†è¿™ä¸ªUNetï¼Œä»¥æ–¹ä¾¿æ‚¨ä½¿ç”¨ã€‚æ‚¨ä¼šæ³¨æ„åˆ°`UNet3DConditionModel`ç±»åå·²æ›´æ”¹ä¸º`ShowOneUNet3DConditionModel`ï¼Œå› ä¸º[UNet3DConditionModel](/docs/diffusers/v0.26.3/en/api/models/unet3d-cond#diffusers.UNet3DConditionModel)å·²ç»å­˜åœ¨äºDiffusersä¸­ã€‚`ShowOneUNet3DConditionModel`ç±»æ‰€éœ€çš„ä»»ä½•ç»„ä»¶éƒ½åº”æ”¾åœ¨`showone_unet_3d_condition.py`è„šæœ¬ä¸­ã€‚

å®Œæˆåï¼Œæ‚¨å¯ä»¥åˆå§‹åŒ–UNetï¼š

```py
from showone_unet_3d_condition import ShowOneUNet3DConditionModel

unet = ShowOneUNet3DConditionModel.from_pretrained(pipe_id, subfolder="unet")
```

1.  æœ€åï¼Œæ‚¨å°†åŠ è½½è‡ªå®šä¹‰ç®¡é“ä»£ç ã€‚åœ¨æœ¬ç¤ºä¾‹ä¸­ï¼Œå·²ç»ä¸ºæ‚¨åœ¨`pipeline_t2v_base_pixel.py`[è„šæœ¬](https://huggingface.co/sayakpaul/show-1-base-with-code/blob/main/pipeline_t2v_base_pixel.py)ä¸­åˆ›å»ºäº†è¿™ä¸ªè„šæœ¬ï¼Œå…¶ä¸­åŒ…å«ç”¨äºä»æ–‡æœ¬ç”Ÿæˆè§†é¢‘çš„è‡ªå®šä¹‰`TextToVideoIFPipeline`ç±»ã€‚ä¸è‡ªå®šä¹‰UNetä¸€æ ·ï¼Œä»»ä½•ç”¨äºä½¿è‡ªå®šä¹‰ç®¡é“æ­£å¸¸å·¥ä½œçš„ä»£ç éƒ½åº”æ”¾åœ¨`pipeline_t2v_base_pixel.py`è„šæœ¬ä¸­ã€‚

ä¸€åˆ‡å°±ç»ªåï¼Œæ‚¨å¯ä»¥ä½¿ç”¨`ShowOneUNet3DConditionModel`åˆå§‹åŒ–`TextToVideoIFPipeline`ï¼š

```py
from pipeline_t2v_base_pixel import TextToVideoIFPipeline
import torch

pipeline = TextToVideoIFPipeline(
    unet=unet,
    text_encoder=text_encoder,
    tokenizer=tokenizer,
    scheduler=scheduler,
    feature_extractor=feature_extractor
)
pipeline = pipeline.to(device="cuda")
pipeline.torch_dtype = torch.float16
```

å°†ç®¡é“æ¨é€åˆ°Hubä»¥ä¸ç¤¾åŒºå…±äº«ï¼

```py
pipeline.push_to_hub("custom-t2v-pipeline")
```

æˆåŠŸæ¨é€ç®¡é“åï¼Œæ‚¨éœ€è¦è¿›è¡Œä¸€äº›æ›´æ”¹ï¼š

1.  åœ¨[`model_index.json`](https://huggingface.co/sayakpaul/show-1-base-with-code/blob/main/model_index.json#L2)ä¸­æ›´æ”¹`_class_name`å±æ€§ä¸º`"pipeline_t2v_base_pixel"`å’Œ`"TextToVideoIFPipeline"`ã€‚

1.  å°†`showone_unet_3d_condition.py`ä¸Šä¼ åˆ°`unet`[ç›®å½•](https://huggingface.co/sayakpaul/show-1-base-with-code/blob/main/unet/showone_unet_3d_condition.py)ã€‚

1.  å°†`pipeline_t2v_base_pixel.py`ä¸Šä¼ åˆ°ç®¡é“åŸºç¡€[ç›®å½•](https://huggingface.co/sayakpaul/show-1-base-with-code/blob/main/unet/showone_unet_3d_condition.py)ã€‚

è¦è¿è¡Œæ¨ç†ï¼Œåªéœ€åœ¨åˆå§‹åŒ–ç®¡é“æ—¶æ·»åŠ `trust_remote_code`å‚æ•°ï¼Œä»¥å¤„ç†æ‰€æœ‰å¹•åçš„â€œé­”æœ¯â€ã€‚

```py
from diffusers import DiffusionPipeline
import torch

pipeline = DiffusionPipeline.from_pretrained(
    "<change-username>/<change-id>", trust_remote_code=True, torch_dtype=torch.float16
).to("cuda")

prompt = "hello"

# Text embeds
prompt_embeds, negative_embeds = pipeline.encode_prompt(prompt)

# Keyframes generation (8x64x40, 2fps)
video_frames = pipeline(
    prompt_embeds=prompt_embeds,
    negative_prompt_embeds=negative_embeds,
    num_frames=8,
    height=40,
    width=64,
    num_inference_steps=2,
    guidance_scale=9.0,
    output_type="pt"
).frames
```

ä½œä¸ºé¢å¤–çš„å‚è€ƒç¤ºä¾‹ï¼Œæ‚¨å¯ä»¥å‚è€ƒ[stabilityai/japanese-stable-diffusion-xl](https://huggingface.co/stabilityai/japanese-stable-diffusion-xl/)çš„å­˜å‚¨åº“ç»“æ„ï¼Œè¯¥å­˜å‚¨åº“åˆ©ç”¨äº†`trust_remote_code`åŠŸèƒ½ï¼š

```py

from diffusers import DiffusionPipeline
import torch

pipeline = DiffusionPipeline.from_pretrained(
    "stabilityai/japanese-stable-diffusion-xl", trust_remote_code=True
)
pipeline.to("cuda")

# if using torch < 2.0
# pipeline.enable_xformers_memory_efficient_attention()

prompt = "æŸ´çŠ¬ã€ã‚«ãƒ©ãƒ•ãƒ«ã‚¢ãƒ¼ãƒˆ"

image = pipeline(prompt=prompt).images[0]

```
