# åŠ è½½ä¸åŒçš„ Stable Diffusion æ ¼å¼

> åŸå§‹æ–‡æœ¬ï¼š[https://huggingface.co/docs/diffusers/using-diffusers/other-formats](https://huggingface.co/docs/diffusers/using-diffusers/other-formats)

ç¨³å®šçš„æ‰©æ•£æ¨¡å‹ä»¥ä¸åŒçš„æ ¼å¼æä¾›ï¼Œå…·ä½“å–å†³äºå®ƒä»¬æ‰€è®­ç»ƒå’Œä¿å­˜çš„æ¡†æ¶ï¼Œä»¥åŠæ‚¨ä»å“ªé‡Œä¸‹è½½å®ƒä»¬ã€‚å°†è¿™äº›æ ¼å¼è½¬æ¢ä¸º ğŸ¤— Diffusers ä»¥ä¾¿åœ¨åº“ä¸­ä½¿ç”¨æ‰€æœ‰æ”¯æŒçš„åŠŸèƒ½ï¼Œä¾‹å¦‚[ä½¿ç”¨ä¸åŒçš„è°ƒåº¦å™¨](schedulers)è¿›è¡Œæ¨æ–­ï¼Œ[æ„å»ºè‡ªå®šä¹‰æµæ°´çº¿](write_own_pipeline)ï¼Œä»¥åŠå„ç§ç”¨äº[ä¼˜åŒ–æ¨æ–­é€Ÿåº¦](../optimization/opt_overview)çš„æŠ€æœ¯å’Œæ–¹æ³•ã€‚

æˆ‘ä»¬å¼ºçƒˆå»ºè®®ä½¿ç”¨ `.safetensors` æ ¼å¼ï¼Œå› ä¸ºå®ƒæ¯”ä¼ ç»Ÿçš„å¯è¢«åˆ©ç”¨æ¥åœ¨æ‚¨çš„æœºå™¨ä¸Šæ‰§è¡Œä»»ä½•ä»£ç çš„ pickled æ–‡ä»¶æ›´å®‰å…¨ï¼ˆåœ¨[åŠ è½½ safetensors](using_safetensors)æŒ‡å—ä¸­äº†è§£æ›´å¤šï¼‰ã€‚

æœ¬æŒ‡å—å°†å‘æ‚¨å±•ç¤ºå¦‚ä½•å°†å…¶ä»– Stable Diffusion æ ¼å¼è½¬æ¢ä¸ºä¸ ğŸ¤— Diffusers å…¼å®¹ã€‚

## PyTorch .ckpt

æ£€æŸ¥ç‚¹ - æˆ– `.ckpt` - æ ¼å¼é€šå¸¸ç”¨äºå­˜å‚¨å’Œä¿å­˜æ¨¡å‹ã€‚`.ckpt` æ–‡ä»¶åŒ…å«æ•´ä¸ªæ¨¡å‹ï¼Œé€šå¸¸å¤§å°ä¸ºå‡ ä¸ªGBã€‚è™½ç„¶æ‚¨å¯ä»¥ç›´æ¥ä½¿ç”¨ [from_single_file()](/docs/diffusers/v0.26.3/en/api/loaders/single_file#diffusers.loaders.FromSingleFileMixin.from_single_file) æ–¹æ³•åŠ è½½å’Œä½¿ç”¨ `.ckpt` æ–‡ä»¶ï¼Œä½†é€šå¸¸æœ€å¥½å°† `.ckpt` æ–‡ä»¶è½¬æ¢ä¸º ğŸ¤— Diffusersï¼Œä»¥ä¾¿ä¸¤ç§æ ¼å¼éƒ½å¯ç”¨ã€‚

æœ‰ä¸¤ç§é€‰é¡¹å¯ä»¥è½¬æ¢ `.ckpt` æ–‡ä»¶ï¼šä½¿ç”¨ Space è½¬æ¢æ£€æŸ¥ç‚¹æˆ–ä½¿ç”¨è„šæœ¬è½¬æ¢ `.ckpt` æ–‡ä»¶ã€‚

### ä½¿ç”¨ Space è¿›è¡Œè½¬æ¢

è½¬æ¢ `.ckpt` æ–‡ä»¶çš„æœ€ç®€å•å’Œæœ€ä¾¿æ·çš„æ–¹æ³•æ˜¯ä½¿ç”¨ [SD to Diffusers](https://huggingface.co/spaces/diffusers/sd-to-diffusers) Spaceã€‚æ‚¨å¯ä»¥æŒ‰ç…§ Space ä¸Šçš„è¯´æ˜è½¬æ¢ `.ckpt` æ–‡ä»¶ã€‚

è¿™ç§æ–¹æ³•é€‚ç”¨äºåŸºæœ¬æ¨¡å‹ï¼Œä½†å¯èƒ½åœ¨æ›´å®šåˆ¶çš„æ¨¡å‹ä¸Šé‡åˆ°å›°éš¾ã€‚å¦‚æœè¿”å›ç©ºçš„æ‹‰å–è¯·æ±‚æˆ–é”™è¯¯ï¼Œåˆ™ä¼šçŸ¥é“ç©ºé—´å¤±è´¥ã€‚åœ¨è¿™ç§æƒ…å†µä¸‹ï¼Œæ‚¨å¯ä»¥å°è¯•ä½¿ç”¨è„šæœ¬è½¬æ¢ `.ckpt` æ–‡ä»¶ã€‚

### ä½¿ç”¨è„šæœ¬è¿›è¡Œè½¬æ¢

ğŸ¤— Diffusers æä¾›äº†ä¸€ä¸ª[è½¬æ¢è„šæœ¬](https://github.com/huggingface/diffusers/blob/main/scripts/convert_original_stable_diffusion_to_diffusers.py)ç”¨äºè½¬æ¢ `.ckpt` æ–‡ä»¶ã€‚è¿™ç§æ–¹æ³•æ¯”ä¸Šé¢çš„ Space æ›´å¯é ã€‚

åœ¨å¼€å§‹ä¹‹å‰ï¼Œè¯·ç¡®ä¿æ‚¨æœ‰ä¸€ä¸ªæœ¬åœ°å…‹éš†çš„ ğŸ¤— Diffusers ä»¥è¿è¡Œè„šæœ¬ï¼Œå¹¶ç™»å½•åˆ°æ‚¨çš„ Hugging Face å¸æˆ·ï¼Œä»¥ä¾¿æ‚¨å¯ä»¥æ‰“å¼€æ‹‰å–è¯·æ±‚å¹¶å°†è½¬æ¢çš„æ¨¡å‹æ¨é€åˆ° Hubã€‚

```py
huggingface-cli login
```

ä½¿ç”¨è„šæœ¬ï¼š

1.  å…‹éš†åŒ…å«æ‚¨è¦è½¬æ¢çš„ `.ckpt` æ–‡ä»¶çš„å­˜å‚¨åº“ã€‚ä¾‹å¦‚ï¼Œè®©æˆ‘ä»¬è½¬æ¢è¿™ä¸ª [TemporalNet](https://huggingface.co/CiaraRowles/TemporalNet) `.ckpt` æ–‡ä»¶ï¼š

```py
git lfs install
git clone https://huggingface.co/CiaraRowles/TemporalNet
```

1.  åœ¨æ‚¨ä»ä¸­è½¬æ¢æ£€æŸ¥ç‚¹çš„å­˜å‚¨åº“ä¸Šæ‰“å¼€ä¸€ä¸ªæ‹‰å–è¯·æ±‚ï¼š

```py
cd TemporalNet && git fetch origin refs/pr/13:pr/13
git checkout pr/13
```

1.  è½¬æ¢è„šæœ¬ä¸­æœ‰å‡ ä¸ªè¾“å…¥å‚æ•°éœ€è¦é…ç½®ï¼Œä½†æœ€é‡è¦çš„æ˜¯ï¼š

    +   `checkpoint_path`ï¼šè¦è½¬æ¢çš„ `.ckpt` æ–‡ä»¶çš„è·¯å¾„ã€‚

    +   `original_config_file`ï¼šå®šä¹‰åŸå§‹æ¶æ„é…ç½®çš„ YAML æ–‡ä»¶ã€‚å¦‚æœæ‰¾ä¸åˆ°æ­¤æ–‡ä»¶ï¼Œè¯·å°è¯•åœ¨æ‰¾åˆ° `.ckpt` æ–‡ä»¶çš„ GitHub å­˜å‚¨åº“ä¸­æœç´¢ YAML æ–‡ä»¶ã€‚

    +   `dump_path`ï¼šè½¬æ¢æ¨¡å‹çš„è·¯å¾„ã€‚

        ä¾‹å¦‚ï¼Œæ‚¨å¯ä»¥ä» [ControlNet](https://github.com/lllyasviel/ControlNet/tree/main/models) å­˜å‚¨åº“ä¸­è·å– `cldm_v15.yaml` æ–‡ä»¶ï¼Œå› ä¸º TemporalNet æ¨¡å‹æ˜¯ Stable Diffusion v1.5 å’Œ ControlNet æ¨¡å‹ã€‚

1.  ç°åœ¨æ‚¨å¯ä»¥è¿è¡Œè„šæœ¬æ¥è½¬æ¢ `.ckpt` æ–‡ä»¶ï¼š

```py
python ../diffusers/scripts/convert_original_stable_diffusion_to_diffusers.py --checkpoint_path temporalnetv3.ckpt --original_config_file cldm_v15.yaml --dump_path ./ --controlnet
```

1.  è½¬æ¢å®Œæˆåï¼Œä¸Šä¼ æ‚¨è½¬æ¢çš„æ¨¡å‹å¹¶æµ‹è¯•ç”Ÿæˆçš„[æ‹‰å–è¯·æ±‚](https://huggingface.co/CiaraRowles/TemporalNet/discussions/13)!

```py
git push origin pr/13:refs/pr/13
```

## Keras .pb æˆ– .h5

ğŸ§ª è¿™æ˜¯ä¸€ä¸ªå®éªŒæ€§åŠŸèƒ½ã€‚ç›®å‰ Convert KerasCV Space ä»…æ”¯æŒ Stable Diffusion v1 æ£€æŸ¥ç‚¹ã€‚

[KerasCV](https://keras.io/keras_cv/)æ”¯æŒ[ç¨³å®šæ‰©æ•£](https://github.com/keras-team/keras-cv/blob/master/keras_cv/models/stable_diffusion) v1å’Œv2çš„è®­ç»ƒã€‚ç„¶è€Œï¼Œå®ƒå¯¹äºå®éªŒç¨³å®šæ‰©æ•£æ¨¡å‹è¿›è¡Œæ¨ç†å’Œéƒ¨ç½²çš„æ”¯æŒæœ‰é™ï¼Œè€ŒğŸ¤— Diffuserså…·æœ‰æ›´å®Œæ•´çš„åŠŸèƒ½é›†ï¼Œä¾‹å¦‚ä¸åŒçš„[å™ªå£°è°ƒåº¦å™¨](https://huggingface.co/docs/diffusers/using-diffusers/schedulers)ã€[é—ªå…‰æ³¨æ„åŠ›](https://huggingface.co/docs/diffusers/optimization/xformers)å’Œ[å…¶ä»–ä¼˜åŒ–æŠ€æœ¯](https://huggingface.co/docs/diffusers/optimization/fp16)ã€‚

[Convert KerasCV](https://huggingface.co/spaces/sayakpaul/convert-kerascv-sd-diffusers)ç©ºé—´å°†`.pb`æˆ–`.h5`æ–‡ä»¶è½¬æ¢ä¸ºPyTorchï¼Œç„¶åå°†å®ƒä»¬åŒ…è£…åœ¨[StableDiffusionPipeline](/docs/diffusers/v0.26.3/en/api/pipelines/stable_diffusion/text2img#diffusers.StableDiffusionPipeline)ä¸­ï¼Œä»¥ä¾¿è¿›è¡Œæ¨ç†ã€‚è½¬æ¢åçš„æ£€æŸ¥ç‚¹å­˜å‚¨åœ¨Hugging Face Hubä¸Šçš„å­˜å‚¨åº“ä¸­ã€‚

åœ¨æ­¤ç¤ºä¾‹ä¸­ï¼Œè®©æˆ‘ä»¬è½¬æ¢[`sayakpaul/textual-inversion-kerasio`](https://huggingface.co/sayakpaul/textual-inversion-kerasio/tree/main)æ£€æŸ¥ç‚¹ï¼Œè¯¥æ£€æŸ¥ç‚¹æ˜¯ä½¿ç”¨æ–‡æœ¬åè½¬è®­ç»ƒçš„ã€‚å®ƒä½¿ç”¨ç‰¹æ®Šä»¤ç‰Œ`<my-funny-cat>`æ¥ä¸ªæ€§åŒ–å¸¦æœ‰çŒ«çš„å›¾åƒã€‚

è½¬æ¢KerasCVç©ºé—´å…è®¸æ‚¨è¾“å…¥ä»¥ä¸‹å†…å®¹ï¼š

+   æ‚¨çš„Hugging Faceä»¤ç‰Œã€‚

+   ä»ä¸­ä¸‹è½½UNetå’Œæ–‡æœ¬ç¼–ç å™¨æƒé‡çš„è·¯å¾„ã€‚æ ¹æ®æ¨¡å‹çš„è®­ç»ƒæ–¹å¼ï¼Œæ‚¨ä¸ä¸€å®šéœ€è¦æä¾›UNetå’Œæ–‡æœ¬ç¼–ç å™¨çš„è·¯å¾„ã€‚ä¾‹å¦‚ï¼Œæ–‡æœ¬åè½¬åªéœ€è¦æ–‡æœ¬ç¼–ç å™¨çš„åµŒå…¥ï¼Œè€Œæ–‡æœ¬åˆ°å›¾åƒæ¨¡å‹åªéœ€è¦UNetæƒé‡ã€‚

+   å ä½ç¬¦ä»¤ç‰Œä»…é€‚ç”¨äºæ–‡æœ¬åè½¬æ¨¡å‹ã€‚

+   `output_repo_prefix`æ˜¯å­˜å‚¨è½¬æ¢æ¨¡å‹çš„å­˜å‚¨åº“çš„åç§°ã€‚

å•å‡»**æäº¤**æŒ‰é’®è‡ªåŠ¨è½¬æ¢KerasCVæ£€æŸ¥ç‚¹ï¼ä¸€æ—¦æ£€æŸ¥ç‚¹æˆåŠŸè½¬æ¢ï¼Œæ‚¨å°†çœ‹åˆ°ä¸€ä¸ªé“¾æ¥ï¼ŒæŒ‡å‘åŒ…å«è½¬æ¢åæ£€æŸ¥ç‚¹çš„æ–°å­˜å‚¨åº“ã€‚è·Ÿéšé“¾æ¥åˆ°æ–°å­˜å‚¨åº“ï¼Œæ‚¨å°†çœ‹åˆ°Convert KerasCVç©ºé—´ç”Ÿæˆäº†ä¸€ä¸ªæ¨¡å‹å¡ï¼Œå¸¦æœ‰ä¸€ä¸ªæ¨ç†å°éƒ¨ä»¶ï¼Œä»¥å°è¯•è½¬æ¢åçš„æ¨¡å‹ã€‚

å¦‚æœæ‚¨æ›´å–œæ¬¢ä½¿ç”¨ä»£ç è¿›è¡Œæ¨ç†ï¼Œè¯·å•å‡»æ¨¡å‹å¡çš„å³ä¸Šè§’çš„**åœ¨Diffusersä¸­ä½¿ç”¨**æŒ‰é’®ä»¥å¤åˆ¶å¹¶ç²˜è´´ä»£ç ç‰‡æ®µï¼š

```py
from diffusers import DiffusionPipeline

pipeline = DiffusionPipeline.from_pretrained(
    "sayakpaul/textual-inversion-cat-kerascv_sd_diffusers_pipeline", use_safetensors=True
)
```

ç„¶åï¼Œæ‚¨å¯ä»¥ç”Ÿæˆä¸€å¼ å›¾ç‰‡ï¼š

```py
from diffusers import DiffusionPipeline

pipeline = DiffusionPipeline.from_pretrained(
    "sayakpaul/textual-inversion-cat-kerascv_sd_diffusers_pipeline", use_safetensors=True
)
pipeline.to("cuda")

placeholder_token = "<my-funny-cat-token>"
prompt = f"two {placeholder_token} getting married, photorealistic, high quality"
image = pipeline(prompt, num_inference_steps=50).images[0]
```

## A1111 LoRAæ–‡ä»¶

[Automatic1111](https://github.com/AUTOMATIC1111/stable-diffusion-webui)ï¼ˆA1111ï¼‰æ˜¯ä¸€ä¸ªæµè¡Œçš„ç¨³å®šæ‰©æ•£ç½‘ç»œç•Œé¢ï¼Œæ”¯æŒåƒ[Civitai](https://civitai.com/)è¿™æ ·çš„æ¨¡å‹å…±äº«å¹³å°ã€‚ä½¿ç”¨ä½ç§©é€‚åº”ï¼ˆLoRAï¼‰æŠ€æœ¯è®­ç»ƒçš„æ¨¡å‹ç‰¹åˆ«å—æ¬¢è¿ï¼Œå› ä¸ºå®ƒä»¬è®­ç»ƒé€Ÿåº¦å¿«ï¼Œæ–‡ä»¶å¤§å°æ¯”å®Œå…¨å¾®è°ƒçš„æ¨¡å‹å°å¾—å¤šã€‚ğŸ¤— Diffusersæ”¯æŒä½¿ç”¨[load_lora_weights()](/docs/diffusers/v0.26.3/en/api/loaders/lora#diffusers.loaders.LoraLoaderMixin.load_lora_weights)åŠ è½½A1111 LoRAæ£€æŸ¥ç‚¹ï¼š

```py
from diffusers import StableDiffusionXLPipeline
import torch

pipeline = StableDiffusionXLPipeline.from_pretrained(
    "Lykon/dreamshaper-xl-1-0", torch_dtype=torch.float16, variant="fp16"
).to("cuda")
```

ä»Civitaiä¸‹è½½ä¸€ä¸ªLoRAæ£€æŸ¥ç‚¹ï¼›æ­¤ç¤ºä¾‹ä½¿ç”¨[Blueprintify SD XL 1.0](https://civitai.com/models/150986/blueprintify-sd-xl-10)æ£€æŸ¥ç‚¹ï¼Œä½†éšæ—¶å¯ä»¥å°è¯•ä»»ä½•LoRAæ£€æŸ¥ç‚¹ï¼

```py
# uncomment to download the safetensor weights
#!wget https://civitai.com/api/download/models/168776 -O blueprintify.safetensors
```

ä½¿ç”¨[load_lora_weights()](/docs/diffusers/v0.26.3/en/api/loaders/lora#diffusers.loaders.LoraLoaderMixin.load_lora_weights)æ–¹æ³•å°†LoRAæ£€æŸ¥ç‚¹åŠ è½½åˆ°ç®¡é“ä¸­ï¼š

```py
pipeline.load_lora_weights(".", weight_name="blueprintify.safetensors")
```

ç°åœ¨æ‚¨å¯ä»¥ä½¿ç”¨ç®¡é“ç”Ÿæˆå›¾åƒï¼š

```py
prompt = "bl3uprint, a highly detailed blueprint of the empire state building, explaining how to build all parts, many txt, blueprint grid backdrop"
negative_prompt = "lowres, cropped, worst quality, low quality, normal quality, artifacts, signature, watermark, username, blurry, more than one bridge, bad architecture"

image = pipeline(
    prompt=prompt,
    negative_prompt=negative_prompt,
    generator=torch.manual_seed(0),
).images[0]
image
```

![](../Images/cee84d318d0e1d6c11ae7b5a6f49a8ca.png)
