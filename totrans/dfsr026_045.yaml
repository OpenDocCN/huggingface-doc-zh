- en: Pipeline callbacks
  id: totrans-0
  prefs:
  - PREF_H1
  type: TYPE_NORMAL
  zh: ç®¡é“å›è°ƒ
- en: 'Original text: [https://huggingface.co/docs/diffusers/using-diffusers/callback](https://huggingface.co/docs/diffusers/using-diffusers/callback)'
  id: totrans-1
  prefs:
  - PREF_BQ
  type: TYPE_NORMAL
  zh: '[åŸæ–‡é“¾æ¥](https://huggingface.co/docs/diffusers/using-diffusers/callback)'
- en: null
  id: totrans-2
  prefs: []
  type: TYPE_NORMAL
- en: The denoising loop of a pipeline can be modified with custom defined functions
    using the `callback_on_step_end` parameter. This can be really useful for *dynamically*
    adjusting certain pipeline attributes, or modifying tensor variables. The flexibility
    of callbacks opens up some interesting use-cases such as changing the prompt embeddings
    at each timestep, assigning different weights to the prompt embeddings, and editing
    the guidance scale.
  id: totrans-3
  prefs: []
  type: TYPE_NORMAL
  zh: ä½¿ç”¨`callback_on_step_end`å‚æ•°å¯ä»¥é€šè¿‡è‡ªå®šä¹‰å®šä¹‰çš„å‡½æ•°ä¿®æ”¹ç®¡é“çš„å»å™ªå¾ªç¯ã€‚è¿™å¯¹äº*åŠ¨æ€*è°ƒæ•´æŸäº›ç®¡é“å±æ€§æˆ–ä¿®æ”¹å¼ é‡å˜é‡éå¸¸æœ‰ç”¨ã€‚å›è°ƒçš„çµæ´»æ€§å¼€å¯äº†ä¸€äº›æœ‰è¶£çš„ç”¨ä¾‹ï¼Œä¾‹å¦‚åœ¨æ¯ä¸ªæ—¶é—´æ­¥æ›´æ”¹æç¤ºåµŒå…¥ã€ä¸ºæç¤ºåµŒå…¥åˆ†é…ä¸åŒçš„æƒé‡ä»¥åŠç¼–è¾‘æŒ‡å¯¼æ¯”ä¾‹ã€‚
- en: This guide will show you how to use the `callback_on_step_end` parameter to
    disable classifier-free guidance (CFG) after 40% of the inference steps to save
    compute with minimal cost to performance.
  id: totrans-4
  prefs: []
  type: TYPE_NORMAL
  zh: æœ¬æŒ‡å—å°†å‘æ‚¨å±•ç¤ºå¦‚ä½•ä½¿ç”¨`callback_on_step_end`å‚æ•°åœ¨æ¨ç†æ­¥éª¤çš„40%åç¦ç”¨æ— åˆ†ç±»å™¨å¼•å¯¼ï¼ˆCFGï¼‰ï¼Œä»¥èŠ‚çœè®¡ç®—èµ„æºè€Œå¯¹æ€§èƒ½çš„å½±å“æœ€å°ã€‚
- en: 'The callback function should have the following arguments:'
  id: totrans-5
  prefs: []
  type: TYPE_NORMAL
  zh: å›è°ƒå‡½æ•°åº”å…·æœ‰ä»¥ä¸‹å‚æ•°ï¼š
- en: '`pipe` (or the pipeline instance) provides access to useful properties such
    as `num_timestep` and `guidance_scale`. You can modify these properties by updating
    the underlying attributes. For this example, youâ€™ll disable CFG by setting `pipe._guidance_scale=0.0`.'
  id: totrans-6
  prefs:
  - PREF_UL
  type: TYPE_NORMAL
  zh: '`pipe`ï¼ˆæˆ–ç®¡é“å®ä¾‹ï¼‰æä¾›å¯¹è¯¸å¦‚`num_timestep`å’Œ`guidance_scale`ç­‰æœ‰ç”¨å±æ€§çš„è®¿é—®ã€‚æ‚¨å¯ä»¥é€šè¿‡æ›´æ–°åº•å±‚å±æ€§æ¥ä¿®æ”¹è¿™äº›å±æ€§ã€‚åœ¨æœ¬ä¾‹ä¸­ï¼Œæ‚¨å°†é€šè¿‡è®¾ç½®`pipe._guidance_scale=0.0`æ¥ç¦ç”¨CFGã€‚'
- en: '`step_index` and `timestep` tell you where you are in the denoising loop. Use
    `step_index` to turn off CFG after reaching 40% of `num_timestep`.'
  id: totrans-7
  prefs:
  - PREF_UL
  type: TYPE_NORMAL
  zh: '`step_index`å’Œ`timestep`å‘Šè¯‰æ‚¨åœ¨å»å™ªå¾ªç¯ä¸­çš„ä½ç½®ã€‚ä½¿ç”¨`step_index`åœ¨è¾¾åˆ°`num_timestep`çš„40%åå…³é—­CFGã€‚'
- en: '`callback_kwargs` is a dict that contains tensor variables you can modify during
    the denoising loop. It only includes variables specified in the `callback_on_step_end_tensor_inputs`
    argument, which is passed to the pipelineâ€™s `__call__` method. Different pipelines
    may use different sets of variables, so please check a pipelineâ€™s `_callback_tensor_inputs`
    attribute for the list of variables you can modify. Some common variables include
    `latents` and `prompt_embeds`. For this function, change the batch size of `prompt_embeds`
    after setting `guidance_scale=0.0` in order for it to work properly.'
  id: totrans-8
  prefs:
  - PREF_UL
  type: TYPE_NORMAL
  zh: '`callback_kwargs`æ˜¯ä¸€ä¸ªåŒ…å«æ‚¨å¯ä»¥åœ¨å»å™ªå¾ªç¯ä¸­ä¿®æ”¹çš„å¼ é‡å˜é‡çš„å­—å…¸ã€‚å®ƒä»…åŒ…æ‹¬åœ¨ä¼ é€’ç»™ç®¡é“çš„`__call__`æ–¹æ³•çš„`callback_on_step_end_tensor_inputs`å‚æ•°ä¸­æŒ‡å®šçš„å˜é‡ã€‚ä¸åŒçš„ç®¡é“å¯èƒ½ä½¿ç”¨ä¸åŒçš„å˜é‡é›†ï¼Œå› æ­¤è¯·æ£€æŸ¥ç®¡é“çš„`_callback_tensor_inputs`å±æ€§ï¼Œä»¥è·å–æ‚¨å¯ä»¥ä¿®æ”¹çš„å˜é‡åˆ—è¡¨ã€‚ä¸€äº›å¸¸è§çš„å˜é‡åŒ…æ‹¬`latents`å’Œ`prompt_embeds`ã€‚å¯¹äºæ­¤å‡½æ•°ï¼Œåœ¨è®¾ç½®`guidance_scale=0.0`åï¼Œæ›´æ”¹`prompt_embeds`çš„æ‰¹å¤„ç†å¤§å°ï¼Œä»¥ä½¿å…¶æ­£å¸¸å·¥ä½œã€‚'
- en: 'Your callback function should look something like this:'
  id: totrans-9
  prefs: []
  type: TYPE_NORMAL
  zh: æ‚¨çš„å›è°ƒå‡½æ•°åº”è¯¥ç±»ä¼¼äºè¿™æ ·ï¼š
- en: '[PRE0]'
  id: totrans-10
  prefs: []
  type: TYPE_PRE
  zh: '[PRE0]'
- en: Now, you can pass the callback function to the `callback_on_step_end` parameter
    and the `prompt_embeds` to `callback_on_step_end_tensor_inputs`.
  id: totrans-11
  prefs: []
  type: TYPE_NORMAL
  zh: ç°åœ¨ï¼Œæ‚¨å¯ä»¥å°†å›è°ƒå‡½æ•°ä¼ é€’ç»™`callback_on_step_end`å‚æ•°ï¼Œå¹¶å°†`prompt_embeds`ä¼ é€’ç»™`callback_on_step_end_tensor_inputs`ã€‚
- en: '[PRE1]'
  id: totrans-12
  prefs: []
  type: TYPE_PRE
  zh: '[PRE1]'
- en: The callback function is executed at the end of each denoising step, and modifies
    the pipeline attributes and tensor variables for the next denoising step.
  id: totrans-13
  prefs: []
  type: TYPE_NORMAL
  zh: å›è°ƒå‡½æ•°åœ¨æ¯ä¸ªå»å™ªæ­¥éª¤ç»“æŸæ—¶æ‰§è¡Œï¼Œå¹¶ä¿®æ”¹ä¸‹ä¸€ä¸ªå»å™ªæ­¥éª¤çš„ç®¡é“å±æ€§å’Œå¼ é‡å˜é‡ã€‚
- en: With callbacks, you can implement features such as dynamic CFG without having
    to modify the underlying code at all!
  id: totrans-14
  prefs: []
  type: TYPE_NORMAL
  zh: ä½¿ç”¨å›è°ƒï¼Œæ‚¨å¯ä»¥å®ç°åŠ¨æ€CFGç­‰åŠŸèƒ½ï¼Œè€Œæ— éœ€ä¿®æ”¹åº•å±‚ä»£ç ï¼
- en: ğŸ¤— Diffusers currently only supports `callback_on_step_end`, but feel free to
    open a [feature request](https://github.com/huggingface/diffusers/issues/new/choose)
    if you have a cool use-case and require a callback function with a different execution
    point!
  id: totrans-15
  prefs: []
  type: TYPE_NORMAL
  zh: ğŸ¤— Diffusersç›®å‰ä»…æ”¯æŒ`callback_on_step_end`ï¼Œä½†å¦‚æœæ‚¨æœ‰ä¸€ä¸ªå¾ˆé…·çš„ç”¨ä¾‹å¹¶éœ€è¦åœ¨ä¸åŒçš„æ‰§è¡Œç‚¹ä¸Šå…·æœ‰å›è°ƒå‡½æ•°ï¼Œè¯·éšæ—¶æå‡º[åŠŸèƒ½è¯·æ±‚](https://github.com/huggingface/diffusers/issues/new/choose)ï¼
- en: Interrupt the diffusion process
  id: totrans-16
  prefs:
  - PREF_H2
  type: TYPE_NORMAL
  zh: ä¸­æ–­æ‰©æ•£è¿‡ç¨‹
- en: Interrupting the diffusion process is particularly useful when building UIs
    that work with Diffusers because it allows users to stop the generation process
    if theyâ€™re unhappy with the intermediate results. You can incorporate this into
    your pipeline with a callback.
  id: totrans-17
  prefs: []
  type: TYPE_NORMAL
  zh: åœ¨æ„å»ºä¸æ‰©æ•£å™¨ä¸€èµ·å·¥ä½œçš„UIæ—¶ï¼Œä¸­æ–­æ‰©æ•£è¿‡ç¨‹ç‰¹åˆ«æœ‰ç”¨ï¼Œå› ä¸ºå®ƒå…è®¸ç”¨æˆ·åœ¨å¯¹ä¸­é—´ç»“æœä¸æ»¡æ„æ—¶åœæ­¢ç”Ÿæˆè¿‡ç¨‹ã€‚æ‚¨å¯ä»¥é€šè¿‡å›è°ƒå°†æ­¤åŠŸèƒ½æ•´åˆåˆ°æ‚¨çš„ç®¡é“ä¸­ã€‚
- en: The interruption callback is supported for text-to-image, image-to-image, and
    inpainting for the [StableDiffusionPipeline](../api/pipelines/stable_diffusion/overview)
    and [StableDiffusionXLPipeline](../api/pipelines/stable_diffusion/stable_diffusion_xl).
  id: totrans-18
  prefs: []
  type: TYPE_NORMAL
  zh: ä¸­æ–­å›è°ƒæ”¯æŒæ–‡æœ¬åˆ°å›¾åƒã€å›¾åƒåˆ°å›¾åƒå’Œä¿®å¤å›¾åƒçš„[StableDiffusionPipeline](../api/pipelines/stable_diffusion/overview)å’Œ[StableDiffusionXLPipeline](../api/pipelines/stable_diffusion/stable_diffusion_xl)ã€‚
- en: 'This callback function should take the following arguments: `pipe`, `i`, `t`,
    and `callback_kwargs` (this must be returned). Set the pipelineâ€™s `_interrupt`
    attribute to `True` to stop the diffusion process after a certain number of steps.
    You are also free to implement your own custom stopping logic inside the callback.'
  id: totrans-19
  prefs: []
  type: TYPE_NORMAL
  zh: è¿™ä¸ªå›è°ƒå‡½æ•°åº”è¯¥æ¥å—ä»¥ä¸‹å‚æ•°ï¼š`pipe`ã€`i`ã€`t`å’Œ`callback_kwargs`ï¼ˆå¿…é¡»è¿”å›ï¼‰ã€‚å°†ç®¡é“çš„`_interrupt`å±æ€§è®¾ç½®ä¸º`True`ï¼Œä»¥åœ¨ä¸€å®šæ­¥æ•°ååœæ­¢æ‰©æ•£è¿‡ç¨‹ã€‚æ‚¨ä¹Ÿå¯ä»¥è‡ªç”±åœ°åœ¨å›è°ƒå‡½æ•°å†…éƒ¨å®ç°è‡ªå®šä¹‰çš„åœæ­¢é€»è¾‘ã€‚
- en: In this example, the diffusion process is stopped after 10 steps even though
    `num_inference_steps` is set to 50.
  id: totrans-20
  prefs: []
  type: TYPE_NORMAL
  zh: åœ¨æœ¬ä¾‹ä¸­ï¼Œå°½ç®¡`num_inference_steps`è®¾ç½®ä¸º50ï¼Œä½†æ‰©æ•£è¿‡ç¨‹åœ¨10æ­¥ååœæ­¢ã€‚
- en: '[PRE2]'
  id: totrans-21
  prefs: []
  type: TYPE_PRE
  zh: '[PRE2]'
