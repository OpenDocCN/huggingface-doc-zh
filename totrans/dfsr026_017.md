# è°ƒåº¦å™¨

> åŸæ–‡ï¼š[https://huggingface.co/docs/diffusers/using-diffusers/schedulers](https://huggingface.co/docs/diffusers/using-diffusers/schedulers)

æ‰©æ•£ç®¡é“æœ¬è´¨ä¸Šæ˜¯æ‰©æ•£æ¨¡å‹å’Œè°ƒåº¦å™¨çš„é›†åˆï¼Œå®ƒä»¬åœ¨æŸç§ç¨‹åº¦ä¸Šæ˜¯ç›¸äº’ç‹¬ç«‹çš„ã€‚è¿™æ„å‘³ç€å¯ä»¥æ›´æ¢ç®¡é“çš„éƒ¨åˆ†ä»¥æ›´å¥½åœ°å®šåˆ¶ç®¡é“ä»¥é€‚åº”è‡ªå·±çš„ç”¨ä¾‹ã€‚è¿™ç§æœ€å¥½çš„ä¾‹å­æ˜¯[è°ƒåº¦å™¨](../api/schedulers/overview)ã€‚

è€Œæ‰©æ•£æ¨¡å‹é€šå¸¸åªæ˜¯å®šä¹‰ä»å™ªå£°åˆ°è¾ƒå°‘å™ªå£°æ ·æœ¬çš„å‰å‘ä¼ é€’ï¼Œè°ƒåº¦å™¨å®šä¹‰äº†æ•´ä¸ªå»å™ªè¿‡ç¨‹ï¼Œå³ï¼š

+   æœ‰å¤šå°‘å»å™ªæ­¥éª¤ï¼Ÿ

+   éšæœºè¿˜æ˜¯ç¡®å®šæ€§ï¼Ÿ

+   ä½¿ç”¨ä»€ä¹ˆç®—æ³•æ¥æ‰¾åˆ°å»å™ªæ ·æœ¬ï¼Ÿ

å®ƒä»¬å¯èƒ½éå¸¸å¤æ‚ï¼Œé€šå¸¸å®šä¹‰äº†**å»å™ªé€Ÿåº¦**å’Œ**å»å™ªè´¨é‡**ä¹‹é—´çš„æƒè¡¡ã€‚é‡åŒ–åœ°è¡¡é‡å“ªç§è°ƒåº¦å™¨å¯¹äºç»™å®šçš„æ‰©æ•£ç®¡é“æ•ˆæœæœ€å¥½æ˜¯éå¸¸å›°éš¾çš„ï¼Œå› æ­¤é€šå¸¸å»ºè®®ç®€å•å°è¯•å“ªç§æ•ˆæœæœ€å¥½ã€‚

ä»¥ä¸‹æ®µè½å±•ç¤ºäº†å¦‚ä½•ä½¿ç”¨ğŸ§¨ Diffusersåº“æ¥å®ç°ã€‚

## åŠ è½½ç®¡é“

è®©æˆ‘ä»¬ä»åœ¨[DiffusionPipeline](/docs/diffusers/v0.26.3/en/api/pipelines/overview#diffusers.DiffusionPipeline)ä¸­åŠ è½½[`runwayml/stable-diffusion-v1-5`](https://huggingface.co/runwayml/stable-diffusion-v1-5)æ¨¡å‹å¼€å§‹ï¼š

```py
from huggingface_hub import login
from diffusers import DiffusionPipeline
import torch

login()

pipeline = DiffusionPipeline.from_pretrained(
    "runwayml/stable-diffusion-v1-5", torch_dtype=torch.float16, use_safetensors=True
)
```

æ¥ä¸‹æ¥ï¼Œæˆ‘ä»¬å°†å…¶ç§»è‡³GPUï¼š

```py
pipeline.to("cuda")
```

## è®¿é—®è°ƒåº¦å™¨

è°ƒåº¦å™¨å§‹ç»ˆæ˜¯ç®¡é“çš„ç»„ä»¶ä¹‹ä¸€ï¼Œé€šå¸¸ç§°ä¸º`"scheduler"`ã€‚å› æ­¤ï¼Œå¯ä»¥é€šè¿‡`"scheduler"`å±æ€§è®¿é—®å®ƒã€‚

```py
pipeline.scheduler
```

**è¾“å‡º**ï¼š

```py
PNDMScheduler {
  "_class_name": "PNDMScheduler",
  "_diffusers_version": "0.21.4",
  "beta_end": 0.012,
  "beta_schedule": "scaled_linear",
  "beta_start": 0.00085,
  "clip_sample": false,
  "num_train_timesteps": 1000,
  "set_alpha_to_one": false,
  "skip_prk_steps": true,
  "steps_offset": 1,
  "timestep_spacing": "leading",
  "trained_betas": null
}
```

æˆ‘ä»¬å¯ä»¥çœ‹åˆ°è°ƒåº¦å™¨çš„ç±»å‹æ˜¯[PNDMScheduler](/docs/diffusers/v0.26.3/en/api/schedulers/pndm#diffusers.PNDMScheduler)ã€‚å¾ˆé…·ï¼Œç°åœ¨è®©æˆ‘ä»¬å°†è°ƒåº¦å™¨çš„æ€§èƒ½ä¸å…¶ä»–è°ƒåº¦å™¨è¿›è¡Œæ¯”è¾ƒã€‚é¦–å…ˆæˆ‘ä»¬å®šä¹‰ä¸€ä¸ªæç¤ºï¼Œæˆ‘ä»¬å°†æµ‹è¯•æ‰€æœ‰ä¸åŒçš„è°ƒåº¦å™¨ï¼š

```py
prompt = "A photograph of an astronaut riding a horse on Mars, high resolution, high definition."
```

æ¥ä¸‹æ¥ï¼Œæˆ‘ä»¬åˆ›å»ºä¸€ä¸ªä»éšæœºç§å­ç”Ÿæˆå™¨ï¼Œä»¥ç¡®ä¿æˆ‘ä»¬å¯ä»¥ç”Ÿæˆç±»ä¼¼çš„å›¾åƒå¹¶è¿è¡Œç®¡é“ï¼š

```py
generator = torch.Generator(device="cuda").manual_seed(8)
image = pipeline(prompt, generator=generator).images[0]
image
```

![](../Images/85fa20e9e45dfa325b08a579c2503c04.png)

## æ›´æ”¹è°ƒåº¦å™¨

ç°åœ¨æˆ‘ä»¬å±•ç¤ºäº†å¦‚ä½•è½»æ¾æ›´æ”¹ç®¡é“çš„è°ƒåº¦å™¨ã€‚æ¯ä¸ªè°ƒåº¦å™¨éƒ½æœ‰ä¸€ä¸ª`compatibles`å±æ€§ï¼Œå®šä¹‰äº†æ‰€æœ‰å…¼å®¹çš„è°ƒåº¦å™¨ã€‚æ‚¨å¯ä»¥æŸ¥çœ‹æ‰€æœ‰å¯ç”¨çš„ã€å…¼å®¹çš„ç¨³å®šæ‰©æ•£ç®¡é“è°ƒåº¦å™¨å¦‚ä¸‹ã€‚

```py
pipeline.scheduler.compatibles
```

**è¾“å‡º**ï¼š

```py
[diffusers.utils.dummy_torch_and_torchsde_objects.DPMSolverSDEScheduler,
 diffusers.schedulers.scheduling_euler_discrete.EulerDiscreteScheduler,
 diffusers.schedulers.scheduling_lms_discrete.LMSDiscreteScheduler,
 diffusers.schedulers.scheduling_ddim.DDIMScheduler,
 diffusers.schedulers.scheduling_ddpm.DDPMScheduler,
 diffusers.schedulers.scheduling_heun_discrete.HeunDiscreteScheduler,
 diffusers.schedulers.scheduling_dpmsolver_multistep.DPMSolverMultistepScheduler,
 diffusers.schedulers.scheduling_deis_multistep.DEISMultistepScheduler,
 diffusers.schedulers.scheduling_pndm.PNDMScheduler,
 diffusers.schedulers.scheduling_euler_ancestral_discrete.EulerAncestralDiscreteScheduler,
 diffusers.schedulers.scheduling_unipc_multistep.UniPCMultistepScheduler,
 diffusers.schedulers.scheduling_k_dpm_2_discrete.KDPM2DiscreteScheduler,
 diffusers.schedulers.scheduling_dpmsolver_singlestep.DPMSolverSinglestepScheduler,
 diffusers.schedulers.scheduling_k_dpm_2_ancestral_discrete.KDPM2AncestralDiscreteScheduler]
```

å¾ˆé…·ï¼Œæœ‰å¾ˆå¤šè°ƒåº¦å™¨å¯ä»¥çœ‹ã€‚éšæ—¶æŸ¥çœ‹å®ƒä»¬å„è‡ªçš„ç±»å®šä¹‰ï¼š

+   [EulerDiscreteScheduler](/docs/diffusers/v0.26.3/en/api/schedulers/euler#diffusers.EulerDiscreteScheduler),

+   [LMSDiscreteScheduler](/docs/diffusers/v0.26.3/en/api/schedulers/lms_discrete#diffusers.LMSDiscreteScheduler),

+   [DDIMScheduler](/docs/diffusers/v0.26.3/en/api/schedulers/ddim#diffusers.DDIMScheduler),

+   [DDPMScheduler](/docs/diffusers/v0.26.3/en/api/schedulers/ddpm#diffusers.DDPMScheduler),

+   [HeunDiscreteScheduler](/docs/diffusers/v0.26.3/en/api/schedulers/heun#diffusers.HeunDiscreteScheduler),

+   [DPMSolverMultistepScheduler](/docs/diffusers/v0.26.3/en/api/schedulers/multistep_dpm_solver#diffusers.DPMSolverMultistepScheduler),

+   [DEISMultistepScheduler](/docs/diffusers/v0.26.3/en/api/schedulers/deis#diffusers.DEISMultistepScheduler),

+   [PNDMScheduler](/docs/diffusers/v0.26.3/en/api/schedulers/pndm#diffusers.PNDMScheduler),

+   [EulerAncestralDiscreteScheduler](/docs/diffusers/v0.26.3/en/api/schedulers/euler_ancestral#diffusers.EulerAncestralDiscreteScheduler),

+   [UniPCMultistepScheduler](/docs/diffusers/v0.26.3/en/api/schedulers/unipc#diffusers.UniPCMultistepScheduler),

+   [KDPM2DiscreteScheduler](/docs/diffusers/v0.26.3/en/api/schedulers/dpm_discrete#diffusers.KDPM2DiscreteScheduler),

+   [DPMSolverSinglestepScheduler](/docs/diffusers/v0.26.3/en/api/schedulers/singlestep_dpm_solver#diffusers.DPMSolverSinglestepScheduler),

+   [KDPM2AncestralDiscreteScheduler](/docs/diffusers/v0.26.3/en/api/schedulers/dpm_discrete_ancestral#diffusers.KDPM2AncestralDiscreteScheduler)ã€‚

æˆ‘ä»¬ç°åœ¨å°†è¾“å…¥æç¤ºä¸æ‰€æœ‰å…¶ä»–è°ƒåº¦ç¨‹åºè¿›è¡Œæ¯”è¾ƒã€‚è¦æ›´æ”¹ç®¡é“çš„è°ƒåº¦ç¨‹åºï¼Œæ‚¨å¯ä»¥åˆ©ç”¨æ–¹ä¾¿çš„`config`å±æ€§ä¸[from_config()](/docs/diffusers/v0.26.3/en/api/configuration#diffusers.ConfigMixin.from_config)å‡½æ•°ç›¸ç»“åˆã€‚

```py
pipeline.scheduler.config
```

è¿”å›è°ƒåº¦ç¨‹åºçš„é…ç½®å­—å…¸ï¼š

**è¾“å‡º**ï¼š

```py
FrozenDict([('num_train_timesteps', 1000),
            ('beta_start', 0.00085),
            ('beta_end', 0.012),
            ('beta_schedule', 'scaled_linear'),
            ('trained_betas', None),
            ('skip_prk_steps', True),
            ('set_alpha_to_one', False),
            ('prediction_type', 'epsilon'),
            ('timestep_spacing', 'leading'),
            ('steps_offset', 1),
            ('_use_default_values', ['timestep_spacing', 'prediction_type']),
            ('_class_name', 'PNDMScheduler'),
            ('_diffusers_version', '0.21.4'),
            ('clip_sample', False)])
```

ç„¶åå¯ä»¥ä½¿ç”¨æ­¤é…ç½®æ¥å®ä¾‹åŒ–ä¸ç®¡é“å…¼å®¹çš„ä¸åŒç±»çš„è°ƒåº¦ç¨‹åºã€‚åœ¨è¿™é‡Œï¼Œæˆ‘ä»¬å°†è°ƒåº¦ç¨‹åºæ›´æ”¹ä¸º[DDIMScheduler](/docs/diffusers/v0.26.3/en/api/schedulers/ddim#diffusers.DDIMScheduler)ã€‚

```py
from diffusers import DDIMScheduler

pipeline.scheduler = DDIMScheduler.from_config(pipeline.scheduler.config)
```

å¾ˆæ£’ï¼Œç°åœ¨æˆ‘ä»¬å¯ä»¥å†æ¬¡è¿è¡Œç®¡é“ä»¥æ¯”è¾ƒç”Ÿæˆè´¨é‡ã€‚

```py
generator = torch.Generator(device="cuda").manual_seed(8)
image = pipeline(prompt, generator=generator).images[0]
image
```

![](../Images/aeaae55430badb2de910e1a713b0bbe8.png)

å¦‚æœæ‚¨æ˜¯JAX/Flaxç”¨æˆ·ï¼Œè¯·æŸ¥çœ‹[æ­¤éƒ¨åˆ†](#changing-the-scheduler-in-flax)ã€‚

## æ¯”è¾ƒè°ƒåº¦ç¨‹åº

åˆ°ç›®å‰ä¸ºæ­¢ï¼Œæˆ‘ä»¬å·²å°è¯•ä½¿ç”¨ä¸¤ä¸ªè°ƒåº¦ç¨‹åºè¿è¡Œç¨³å®šæ‰©æ•£ç®¡é“ï¼š[PNDMScheduler](/docs/diffusers/v0.26.3/en/api/schedulers/pndm#diffusers.PNDMScheduler)å’Œ[DDIMScheduler](/docs/diffusers/v0.26.3/en/api/schedulers/ddim#diffusers.DDIMScheduler)ã€‚å·²å‘å¸ƒäº†è®¸å¤šæ›´å¥½çš„è°ƒåº¦ç¨‹åºï¼Œå¯ä»¥åœ¨æ›´å°‘çš„æ­¥éª¤ä¸‹è¿è¡Œï¼›è®©æˆ‘ä»¬åœ¨è¿™é‡Œè¿›è¡Œæ¯”è¾ƒï¼š

[LMSDiscreteScheduler](/docs/diffusers/v0.26.3/en/api/schedulers/lms_discrete#diffusers.LMSDiscreteScheduler)é€šå¸¸ä¼šäº§ç”Ÿæ›´å¥½çš„ç»“æœï¼š

```py
from diffusers import LMSDiscreteScheduler

pipeline.scheduler = LMSDiscreteScheduler.from_config(pipeline.scheduler.config)

generator = torch.Generator(device="cuda").manual_seed(8)
image = pipeline(prompt, generator=generator).images[0]
image
```

![](../Images/4c9dc4ee0fe60f14a122ed8f9267e44b.png)

[EulerDiscreteScheduler](/docs/diffusers/v0.26.3/en/api/schedulers/euler#diffusers.EulerDiscreteScheduler)å’Œ[EulerAncestralDiscreteScheduler](/docs/diffusers/v0.26.3/en/api/schedulers/euler_ancestral#diffusers.EulerAncestralDiscreteScheduler)å¯ä»¥åœ¨è‡³å°‘30ä¸ªæ­¥éª¤ä¸‹ç”Ÿæˆé«˜è´¨é‡çš„ç»“æœã€‚

```py
from diffusers import EulerDiscreteScheduler

pipeline.scheduler = EulerDiscreteScheduler.from_config(pipeline.scheduler.config)

generator = torch.Generator(device="cuda").manual_seed(8)
image = pipeline(prompt, generator=generator, num_inference_steps=30).images[0]
image
```

![](../Images/30a99b3625066922ca35535bb1da7557.png)

å’Œ:

```py
from diffusers import EulerAncestralDiscreteScheduler

pipeline.scheduler = EulerAncestralDiscreteScheduler.from_config(pipeline.scheduler.config)

generator = torch.Generator(device="cuda").manual_seed(8)
image = pipeline(prompt, generator=generator, num_inference_steps=30).images[0]
image
```

![](../Images/dac9b5338f1d73249d4d46fa8e35505e.png)

[DPMSolverMultistepScheduler](/docs/diffusers/v0.26.3/en/api/schedulers/multistep_dpm_solver#diffusers.DPMSolverMultistepScheduler)æä¾›äº†ä¸€ä¸ªåˆç†çš„é€Ÿåº¦/è´¨é‡æƒè¡¡ï¼Œå¹¶ä¸”å¯ä»¥åœ¨è‡³å°‘20ä¸ªæ­¥éª¤ä¸‹è¿è¡Œã€‚

```py
from diffusers import DPMSolverMultistepScheduler

pipeline.scheduler = DPMSolverMultistepScheduler.from_config(pipeline.scheduler.config)

generator = torch.Generator(device="cuda").manual_seed(8)
image = pipeline(prompt, generator=generator, num_inference_steps=20).images[0]
image
```

![](../Images/b97d4c7db809a65413b4dc12bcfc20fe.png)

æ­£å¦‚æ‚¨æ‰€çœ‹åˆ°çš„ï¼Œå¤§å¤šæ•°å›¾åƒçœ‹èµ·æ¥éå¸¸ç›¸ä¼¼ï¼Œè´¨é‡ä¹Ÿå¾ˆç›¸ä¼¼ã€‚é€‰æ‹©å“ªä¸ªè°ƒåº¦ç¨‹åºé€šå¸¸å–å†³äºå…·ä½“çš„ç”¨ä¾‹ã€‚ä¸€ä¸ªå¥½çš„æ–¹æ³•æ˜¯å§‹ç»ˆè¿è¡Œå¤šä¸ªä¸åŒçš„è°ƒåº¦ç¨‹åºä»¥æ¯”è¾ƒç»“æœã€‚

## åœ¨Flaxä¸­æ›´æ”¹è°ƒåº¦ç¨‹åº

å¦‚æœæ‚¨æ˜¯JAX/Flaxç”¨æˆ·ï¼Œè¿˜å¯ä»¥æ›´æ”¹é»˜è®¤çš„ç®¡é“è°ƒåº¦ç¨‹åºã€‚è¿™æ˜¯ä½¿ç”¨Flax Stable Diffusionç®¡é“å’Œè¶…å¿«é€Ÿ[DPM-Solver++è°ƒåº¦ç¨‹åº](../api/schedulers/multistep_dpm_solver)è¿è¡Œæ¨ç†çš„å®Œæ•´ç¤ºä¾‹ï¼š

```py
import jax
import numpy as np
from flax.jax_utils import replicate
from flax.training.common_utils import shard

from diffusers import FlaxStableDiffusionPipeline, FlaxDPMSolverMultistepScheduler

model_id = "runwayml/stable-diffusion-v1-5"
scheduler, scheduler_state = FlaxDPMSolverMultistepScheduler.from_pretrained(
    model_id,
    subfolder="scheduler"
)
pipeline, params = FlaxStableDiffusionPipeline.from_pretrained(
    model_id,
    scheduler=scheduler,
    revision="bf16",
    dtype=jax.numpy.bfloat16,
)
params["scheduler"] = scheduler_state

# Generate 1 image per parallel device (8 on TPUv2-8 or TPUv3-8)
prompt = "a photo of an astronaut riding a horse on mars"
num_samples = jax.device_count()
prompt_ids = pipeline.prepare_inputs([prompt] * num_samples)

prng_seed = jax.random.PRNGKey(0)
num_inference_steps = 25

# shard inputs and rng
params = replicate(params)
prng_seed = jax.random.split(prng_seed, jax.device_count())
prompt_ids = shard(prompt_ids)

images = pipeline(prompt_ids, params, prng_seed, num_inference_steps, jit=True).images
images = pipeline.numpy_to_pil(np.asarray(images.reshape((num_samples,) + images.shape[-3:])))
```

ä»¥ä¸‹Flaxè°ƒåº¦ç¨‹åºä¸Flax Stable Diffusion Pipeline *å°šä¸å…¼å®¹*ï¼š

+   `FlaxLMSDiscreteScheduler`

+   `FlaxDDPMScheduler`
