# DreamBooth

> åŸæ–‡é“¾æ¥ï¼š[https://huggingface.co/docs/diffusers/training/dreambooth](https://huggingface.co/docs/diffusers/training/dreambooth)

[DreamBooth](https://huggingface.co/papers/2208.12242)æ˜¯ä¸€ç§è®­ç»ƒæŠ€æœ¯ï¼Œé€šè¿‡ä»…å¯¹ä¸»é¢˜æˆ–é£æ ¼çš„å°‘é‡å›¾åƒè¿›è¡Œè®­ç»ƒæ¥æ›´æ–°æ•´ä¸ªæ‰©æ•£æ¨¡å‹ã€‚å®ƒé€šè¿‡å°†æç¤ºä¸­çš„ç‰¹æ®Šå•è¯ä¸ç¤ºä¾‹å›¾åƒå…³è”èµ·æ¥å·¥ä½œã€‚

å¦‚æœæ‚¨åœ¨å…·æœ‰æœ‰é™vRAMçš„GPUä¸Šè¿›è¡Œè®­ç»ƒï¼Œåº”å°è¯•åœ¨è®­ç»ƒå‘½ä»¤ä¸­å¯ç”¨`gradient_checkpointing`å’Œ`mixed_precision`å‚æ•°ã€‚æ‚¨è¿˜å¯ä»¥é€šè¿‡ä½¿ç”¨[xFormers](../optimization/xformers)çš„å†…å­˜é«˜æ•ˆæ³¨æ„åŠ›æ¥å‡å°‘å†…å­˜å ç”¨ã€‚JAX/Flaxè®­ç»ƒä¹Ÿæ”¯æŒåœ¨TPUå’ŒGPUä¸Šè¿›è¡Œé«˜æ•ˆè®­ç»ƒï¼Œä½†ä¸æ”¯æŒæ¢¯åº¦æ£€æŸ¥ç‚¹æˆ–xFormersã€‚å¦‚æœæ‚¨æƒ³è¦ä½¿ç”¨Flaxæ›´å¿«åœ°è¿›è¡Œè®­ç»ƒï¼Œåˆ™åº”è¯¥å…·æœ‰>30GBå†…å­˜çš„GPUã€‚

æœ¬æŒ‡å—å°†æ¢è®¨[train_dreambooth.py](https://github.com/huggingface/diffusers/blob/main/examples/dreambooth/train_dreambooth.py)è„šæœ¬ï¼Œä»¥å¸®åŠ©æ‚¨æ›´ç†Ÿæ‚‰å®ƒï¼Œå¹¶äº†è§£å¦‚ä½•ä¸ºè‡ªå·±çš„ç”¨ä¾‹è¿›è¡Œè°ƒæ•´ã€‚

åœ¨è¿è¡Œè„šæœ¬ä¹‹å‰ï¼Œè¯·ç¡®ä¿æ‚¨ä»æºä»£ç å®‰è£…åº“ï¼š

```py
git clone https://github.com/huggingface/diffusers
cd diffusers
pip install .
```

å¯¼èˆªåˆ°åŒ…å«è®­ç»ƒè„šæœ¬çš„ç¤ºä¾‹æ–‡ä»¶å¤¹ï¼Œå¹¶å®‰è£…æ‰€éœ€çš„ä¾èµ–é¡¹ä»¥ä¾›æ‚¨ä½¿ç”¨çš„è„šæœ¬ï¼š

PyTorchFlax

```py
cd examples/dreambooth
pip install -r requirements.txt
```

ğŸ¤— Accelerateæ˜¯ä¸€ä¸ªå¸®åŠ©æ‚¨åœ¨å¤šä¸ªGPU/TPUä¸Šè®­ç»ƒæˆ–ä½¿ç”¨æ··åˆç²¾åº¦çš„åº“ã€‚å®ƒå°†æ ¹æ®æ‚¨çš„ç¡¬ä»¶å’Œç¯å¢ƒè‡ªåŠ¨é…ç½®æ‚¨çš„è®­ç»ƒè®¾ç½®ã€‚æŸ¥çœ‹ğŸ¤— Accelerate [å¿«é€Ÿå…¥é—¨](https://huggingface.co/docs/accelerate/quicktour)ä»¥äº†è§£æ›´å¤šã€‚

åˆå§‹åŒ–ğŸ¤— Accelerateç¯å¢ƒï¼š

```py
accelerate config
```

è¦è®¾ç½®é»˜è®¤çš„ğŸ¤— Accelerateç¯å¢ƒè€Œä¸é€‰æ‹©ä»»ä½•é…ç½®ï¼š

```py
accelerate config default
```

æˆ–è€…ï¼Œå¦‚æœæ‚¨çš„ç¯å¢ƒä¸æ”¯æŒäº¤äº’å¼shellï¼Œæ¯”å¦‚ç¬”è®°æœ¬ï¼Œæ‚¨å¯ä»¥ä½¿ç”¨ï¼š

```py
from accelerate.utils import write_basic_config

write_basic_config()
```

æœ€åï¼Œå¦‚æœæ‚¨æƒ³åœ¨è‡ªå·±çš„æ•°æ®é›†ä¸Šè®­ç»ƒæ¨¡å‹ï¼Œè¯·æŸ¥çœ‹[åˆ›å»ºç”¨äºè®­ç»ƒçš„æ•°æ®é›†](create_dataset)æŒ‡å—ï¼Œäº†è§£å¦‚ä½•åˆ›å»ºé€‚ç”¨äºè®­ç»ƒè„šæœ¬çš„æ•°æ®é›†ã€‚

ä»¥ä¸‹éƒ¨åˆ†çªå‡ºäº†è®­ç»ƒè„šæœ¬ä¸­é‡è¦çš„éƒ¨åˆ†ï¼Œä»¥å¸®åŠ©æ‚¨äº†è§£å¦‚ä½•ä¿®æ”¹å®ƒï¼Œä½†å¹¶æœªè¯¦ç»†æ¶µç›–è„šæœ¬çš„æ¯ä¸ªæ–¹é¢ã€‚å¦‚æœæ‚¨æœ‰å…´è¶£äº†è§£æ›´å¤šï¼Œè¯·éšæ—¶é˜…è¯»[è„šæœ¬](https://github.com/huggingface/diffusers/blob/main/examples/dreambooth/train_dreambooth.py)ï¼Œå¹¶å‘Šè¯‰æˆ‘ä»¬å¦‚æœæ‚¨æœ‰ä»»ä½•é—®é¢˜æˆ–ç–‘è™‘ã€‚

## è„šæœ¬å‚æ•°

DreamBoothå¯¹è®­ç»ƒè¶…å‚æ•°éå¸¸æ•æ„Ÿï¼Œå¾ˆå®¹æ˜“è¿‡æ‹Ÿåˆã€‚é˜…è¯»[ä½¿ç”¨ğŸ§¨ Diffusersè®­ç»ƒç¨³å®šæ‰©æ•£çš„DreamBooth](https://huggingface.co/blog/dreambooth)åšå®¢æ–‡ç« ï¼Œäº†è§£ä¸åŒä¸»é¢˜çš„æ¨èè®¾ç½®ï¼Œä»¥å¸®åŠ©æ‚¨é€‰æ‹©é€‚å½“çš„è¶…å‚æ•°ã€‚

è®­ç»ƒè„šæœ¬æä¾›äº†è®¸å¤šå‚æ•°ï¼Œç”¨äºè‡ªå®šä¹‰æ‚¨çš„è®­ç»ƒè¿è¡Œã€‚æ‰€æœ‰å‚æ•°åŠå…¶æè¿°å‡åœ¨[`parse_args()`](https://github.com/huggingface/diffusers/blob/072e00897a7cf4302c347a63ec917b4b8add16d4/examples/dreambooth/train_dreambooth.py#L228)å‡½æ•°ä¸­æ‰¾åˆ°ã€‚è¿™äº›å‚æ•°è®¾ç½®äº†é»˜è®¤å€¼ï¼Œåº”è¯¥å¯ä»¥å¾ˆå¥½åœ°å¼€ç®±å³ç”¨ï¼Œä½†å¦‚æœæ‚¨æ„¿æ„ï¼Œä¹Ÿå¯ä»¥åœ¨è®­ç»ƒå‘½ä»¤ä¸­è®¾ç½®è‡ªå·±çš„å€¼ã€‚

ä¾‹å¦‚ï¼Œä»¥bf16æ ¼å¼è¿›è¡Œè®­ç»ƒï¼š

```py
accelerate launch train_dreambooth.py \
    --mixed_precision="bf16"
```

ä¸€äº›åŸºæœ¬å’Œé‡è¦çš„å‚æ•°éœ€è¦äº†è§£å’ŒæŒ‡å®šï¼š

+   --pretrained_model_name_or_pathï¼šHubä¸Šæ¨¡å‹çš„åç§°æˆ–é¢„è®­ç»ƒæ¨¡å‹çš„æœ¬åœ°è·¯å¾„

+   --instance_data_dirï¼šåŒ…å«è®­ç»ƒæ•°æ®é›†ï¼ˆç¤ºä¾‹å›¾åƒï¼‰çš„æ–‡ä»¶å¤¹è·¯å¾„

+   --instance_promptï¼šåŒ…å«ç¤ºä¾‹å›¾åƒçš„ç‰¹æ®Šå•è¯çš„æ–‡æœ¬æç¤º

+   --train_text_encoderï¼šæ˜¯å¦è¿˜è¦è®­ç»ƒæ–‡æœ¬ç¼–ç å™¨

+   --output_dirï¼šä¿å­˜è®­ç»ƒå¥½çš„æ¨¡å‹çš„ä½ç½®

+   --push_to_hubï¼šæ˜¯å¦å°†è®­ç»ƒå¥½çš„æ¨¡å‹æ¨é€åˆ°Hub

+   `--checkpointing_steps`ï¼šä¿å­˜æ£€æŸ¥ç‚¹çš„é¢‘ç‡ï¼Œè¿™åœ¨è®­ç»ƒä¸­æ–­æ—¶å¾ˆæœ‰ç”¨ï¼Œæ‚¨å¯ä»¥é€šè¿‡åœ¨è®­ç»ƒå‘½ä»¤ä¸­æ·»åŠ  `--resume_from_checkpoint` ä»è¯¥æ£€æŸ¥ç‚¹ç»§ç»­è®­ç»ƒ

### Min-SNR æƒé‡ç­–ç•¥

[Min-SNR](https://huggingface.co/papers/2303.09556) æƒé‡ç­–ç•¥å¯ä»¥é€šè¿‡é‡æ–°å¹³è¡¡æŸå¤±æ¥å¸®åŠ©è®­ç»ƒï¼Œä»¥å®ç°æ›´å¿«çš„æ”¶æ•›ã€‚è®­ç»ƒè„šæœ¬æ”¯æŒé¢„æµ‹ `epsilon`ï¼ˆå™ªéŸ³ï¼‰æˆ– `v_prediction`ï¼Œä½† Min-SNR ä¸ä¸¤ç§é¢„æµ‹ç±»å‹å…¼å®¹ã€‚è¿™ç§æƒé‡ç­–ç•¥ä»…ç”± PyTorch æ”¯æŒï¼Œåœ¨ Flax è®­ç»ƒè„šæœ¬ä¸­ä¸å¯ç”¨ã€‚

æ·»åŠ  `--snr_gamma` å‚æ•°ï¼Œå¹¶å°†å…¶è®¾ç½®ä¸ºæ¨èå€¼ 5.0ï¼š

```py
accelerate launch train_dreambooth.py \
  --snr_gamma=5.0
```

### å…ˆå‰ä¿ç•™æŸå¤±

å…ˆå‰çš„ä¿ç•™æŸå¤±æ˜¯ä¸€ç§æ–¹æ³•ï¼Œå®ƒåˆ©ç”¨æ¨¡å‹è‡ªå·±ç”Ÿæˆçš„æ ·æœ¬æ¥å¸®åŠ©å­¦ä¹ å¦‚ä½•ç”Ÿæˆæ›´å¤šæ ·åŒ–çš„å›¾åƒã€‚å› ä¸ºè¿™äº›ç”Ÿæˆçš„æ ·æœ¬å›¾åƒå±äºæ‚¨æä¾›çš„å›¾åƒç›¸åŒçš„ç±»åˆ«ï¼Œå®ƒä»¬å¸®åŠ©æ¨¡å‹ä¿ç•™å¯¹è¯¥ç±»åˆ«å·²å­¦ä¹ çš„çŸ¥è¯†ï¼Œä»¥åŠå¦‚ä½•åˆ©ç”¨å·²çŸ¥çš„å…³äºè¯¥ç±»åˆ«çš„çŸ¥è¯†æ¥ç”Ÿæˆæ–°çš„ç»„åˆã€‚

+   `--with_prior_preservation`ï¼šæ˜¯å¦ä½¿ç”¨å…ˆå‰ä¿ç•™æŸå¤±

+   `--prior_loss_weight`ï¼šæ§åˆ¶æ¨¡å‹å¯¹å…ˆå‰ä¿ç•™æŸå¤±çš„å½±å“

+   `--class_data_dir`ï¼šåŒ…å«ç”Ÿæˆçš„ç±»åˆ«æ ·æœ¬å›¾åƒçš„æ–‡ä»¶å¤¹è·¯å¾„

+   `--class_prompt`ï¼šæè¿°ç”Ÿæˆæ ·æœ¬å›¾åƒç±»åˆ«çš„æ–‡æœ¬æç¤º

```py
accelerate launch train_dreambooth.py \
  --with_prior_preservation \
  --prior_loss_weight=1.0 \
  --class_data_dir="path/to/class/images" \
  --class_prompt="text prompt describing class"
```

### è®­ç»ƒæ–‡æœ¬ç¼–ç å™¨

ä¸ºäº†æé«˜ç”Ÿæˆè¾“å‡ºçš„è´¨é‡ï¼Œæ‚¨è¿˜å¯ä»¥è®­ç»ƒæ–‡æœ¬ç¼–ç å™¨ä»¥åŠ UNetã€‚è¿™éœ€è¦é¢å¤–çš„å†…å­˜ï¼Œæ‚¨éœ€è¦è‡³å°‘å…·æœ‰ 24GB çš„ vRAM çš„ GPUã€‚å¦‚æœæ‚¨æœ‰å¿…è¦çš„ç¡¬ä»¶ï¼Œé‚£ä¹ˆè®­ç»ƒæ–‡æœ¬ç¼–ç å™¨ä¼šäº§ç”Ÿæ›´å¥½çš„ç»“æœï¼Œç‰¹åˆ«æ˜¯åœ¨ç”Ÿæˆé¢éƒ¨å›¾åƒæ—¶ã€‚é€šè¿‡ä»¥ä¸‹é€‰é¡¹å¯ç”¨æ­¤é€‰é¡¹ï¼š

```py
accelerate launch train_dreambooth.py \
  --train_text_encoder
```

## è®­ç»ƒè„šæœ¬

DreamBooth è‡ªå¸¦å…¶è‡ªå·±çš„æ•°æ®é›†ç±»ï¼š

+   [`DreamBoothDataset`](https://github.com/huggingface/diffusers/blob/072e00897a7cf4302c347a63ec917b4b8add16d4/examples/dreambooth/train_dreambooth.py#L604)ï¼šé¢„å¤„ç†å›¾åƒå’Œç±»åˆ«å›¾åƒï¼Œå¹¶ä¸ºè®­ç»ƒä»¤ç‰ŒåŒ–æç¤º

+   [`PromptDataset`](https://github.com/huggingface/diffusers/blob/072e00897a7cf4302c347a63ec917b4b8add16d4/examples/dreambooth/train_dreambooth.py#L738)ï¼šç”Ÿæˆæç¤ºåµŒå…¥ä»¥ç”Ÿæˆç±»åˆ«å›¾åƒ

å¦‚æœæ‚¨å¯ç”¨äº†[å…ˆå‰ä¿ç•™æŸå¤±](https://github.com/huggingface/diffusers/blob/072e00897a7cf4302c347a63ec917b4b8add16d4/examples/dreambooth/train_dreambooth.py#L842)ï¼Œåˆ™åœ¨æ­¤å¤„ç”Ÿæˆç±»åˆ«å›¾åƒï¼š

```py
sample_dataset = PromptDataset(args.class_prompt, num_new_images)
sample_dataloader = torch.utils.data.DataLoader(sample_dataset, batch_size=args.sample_batch_size)

sample_dataloader = accelerator.prepare(sample_dataloader)
pipeline.to(accelerator.device)

for example in tqdm(
    sample_dataloader, desc="Generating class images", disable=not accelerator.is_local_main_process
):
    images = pipeline(example["prompt"]).images
```

æ¥ä¸‹æ¥æ˜¯ [`main()`](https://github.com/huggingface/diffusers/blob/072e00897a7cf4302c347a63ec917b4b8add16d4/examples/dreambooth/train_dreambooth.py#L799) å‡½æ•°ï¼Œè´Ÿè´£è®¾ç½®ç”¨äºè®­ç»ƒçš„æ•°æ®é›†å’Œè®­ç»ƒå¾ªç¯æœ¬èº«ã€‚è„šæœ¬åŠ è½½ [tokenizer](https://github.com/huggingface/diffusers/blob/072e00897a7cf4302c347a63ec917b4b8add16d4/examples/dreambooth/train_dreambooth.py#L898)ã€[è°ƒåº¦å™¨å’Œæ¨¡å‹](https://github.com/huggingface/diffusers/blob/072e00897a7cf4302c347a63ec917b4b8add16d4/examples/dreambooth/train_dreambooth.py#L912C1-L912C1)ï¼š

```py
# Load the tokenizer
if args.tokenizer_name:
    tokenizer = AutoTokenizer.from_pretrained(args.tokenizer_name, revision=args.revision, use_fast=False)
elif args.pretrained_model_name_or_path:
    tokenizer = AutoTokenizer.from_pretrained(
        args.pretrained_model_name_or_path,
        subfolder="tokenizer",
        revision=args.revision,
        use_fast=False,
    )

# Load scheduler and models
noise_scheduler = DDPMScheduler.from_pretrained(args.pretrained_model_name_or_path, subfolder="scheduler")
text_encoder = text_encoder_cls.from_pretrained(
    args.pretrained_model_name_or_path, subfolder="text_encoder", revision=args.revision
)

if model_has_vae(args):
    vae = AutoencoderKL.from_pretrained(
        args.pretrained_model_name_or_path, subfolder="vae", revision=args.revision
    )
else:
    vae = None

unet = UNet2DConditionModel.from_pretrained(
    args.pretrained_model_name_or_path, subfolder="unet", revision=args.revision
)
```

ç„¶åï¼Œæ˜¯æ—¶å€™[åˆ›å»ºè®­ç»ƒæ•°æ®é›†](https://github.com/huggingface/diffusers/blob/072e00897a7cf4302c347a63ec917b4b8add16d4/examples/dreambooth/train_dreambooth.py#L1073)å’Œä» `DreamBoothDataset` åˆ›å»º DataLoader äº†ï¼š

```py
train_dataset = DreamBoothDataset(
    instance_data_root=args.instance_data_dir,
    instance_prompt=args.instance_prompt,
    class_data_root=args.class_data_dir if args.with_prior_preservation else None,
    class_prompt=args.class_prompt,
    class_num=args.num_class_images,
    tokenizer=tokenizer,
    size=args.resolution,
    center_crop=args.center_crop,
    encoder_hidden_states=pre_computed_encoder_hidden_states,
    class_prompt_encoder_hidden_states=pre_computed_class_prompt_encoder_hidden_states,
    tokenizer_max_length=args.tokenizer_max_length,
)

train_dataloader = torch.utils.data.DataLoader(
    train_dataset,
    batch_size=args.train_batch_size,
    shuffle=True,
    collate_fn=lambda examples: collate_fn(examples, args.with_prior_preservation),
    num_workers=args.dataloader_num_workers,
)
```

æœ€åï¼Œ[è®­ç»ƒå¾ªç¯](https://github.com/huggingface/diffusers/blob/072e00897a7cf4302c347a63ec917b4b8add16d4/examples/dreambooth/train_dreambooth.py#L1151) å¤„ç†å‰©ä½™æ­¥éª¤ï¼Œå¦‚å°†å›¾åƒè½¬æ¢ä¸ºæ½œåœ¨ç©ºé—´ï¼Œå‘è¾“å…¥æ·»åŠ å™ªéŸ³ï¼Œé¢„æµ‹å™ªéŸ³æ®‹å·®ï¼Œå¹¶è®¡ç®—æŸå¤±ã€‚

å¦‚æœæ‚¨æƒ³äº†è§£è®­ç»ƒå¾ªç¯çš„å·¥ä½œåŸç†ï¼Œè¯·æŸ¥çœ‹ [ç†è§£ç®¡é“ã€æ¨¡å‹å’Œè°ƒåº¦å™¨](../using-diffusers/write_own_pipeline) æ•™ç¨‹ï¼Œè¯¥æ•™ç¨‹è§£æäº†å»å™ªè¿‡ç¨‹çš„åŸºæœ¬æ¨¡å¼ã€‚

## å¯åŠ¨è„šæœ¬

æ‚¨ç°åœ¨å¯ä»¥å¯åŠ¨è®­ç»ƒè„šæœ¬äº†ï¼ğŸš€

å¯¹äºè¿™ä¸ªæŒ‡å—ï¼Œæ‚¨å°†ä¸‹è½½ä¸€äº›[ç‹—](https://huggingface.co/datasets/diffusers/dog-example)çš„å›¾åƒå¹¶å°†å®ƒä»¬å­˜å‚¨åœ¨ä¸€ä¸ªç›®å½•ä¸­ã€‚ä½†è¯·è®°ä½ï¼Œå¦‚æœæ‚¨æ„¿æ„ï¼Œæ‚¨å¯ä»¥åˆ›å»ºå’Œä½¿ç”¨è‡ªå·±çš„æ•°æ®é›†ï¼ˆè¯·å‚é˜…[åˆ›å»ºç”¨äºè®­ç»ƒçš„æ•°æ®é›†](create_dataset)æŒ‡å—ï¼‰ã€‚

```py
from huggingface_hub import snapshot_download

local_dir = "./dog"
snapshot_download(
    "diffusers/dog-example",
    local_dir=local_dir,
    repo_type="dataset",
    ignore_patterns=".gitattributes",
)
```

å°†ç¯å¢ƒå˜é‡`MODEL_NAME`è®¾ç½®ä¸ºHubä¸Šçš„æ¨¡å‹IDæˆ–æœ¬åœ°æ¨¡å‹çš„è·¯å¾„ï¼Œ`INSTANCE_DIR`è®¾ç½®ä¸ºæ‚¨åˆšä¸‹è½½ç‹—å›¾ç‰‡çš„è·¯å¾„ï¼Œ`OUTPUT_DIR`è®¾ç½®ä¸ºæ‚¨æƒ³è¦ä¿å­˜æ¨¡å‹çš„è·¯å¾„ã€‚æ‚¨å°†ä½¿ç”¨`sks`ä½œä¸ºå°†è®­ç»ƒç»‘å®šåˆ°çš„ç‰¹æ®Šè¯ã€‚

å¦‚æœæ‚¨æœ‰å…´è¶£è·Ÿéšè®­ç»ƒè¿‡ç¨‹ï¼Œå¯ä»¥åœ¨è®­ç»ƒè¿›è¡Œæ—¶å®šæœŸä¿å­˜ç”Ÿæˆçš„å›¾åƒã€‚å°†ä»¥ä¸‹å‚æ•°æ·»åŠ åˆ°è®­ç»ƒå‘½ä»¤ä¸­ï¼š

```py
--validation_prompt="a photo of a sks dog"
--num_validation_images=4
--validation_steps=100
```

åœ¨å¯åŠ¨è„šæœ¬ä¹‹å‰è¿˜æœ‰ä¸€ä»¶äº‹ï¼æ ¹æ®æ‚¨æ‹¥æœ‰çš„GPUï¼Œæ‚¨å¯èƒ½éœ€è¦å¯ç”¨æŸäº›ä¼˜åŒ–æ¥è®­ç»ƒDreamBoothã€‚

16GB12GB8GB

åœ¨16GB GPUä¸Šï¼Œæ‚¨å¯ä»¥ä½¿ç”¨bitsandbytes 8ä½ä¼˜åŒ–å™¨å’Œæ¢¯åº¦æ£€æŸ¥ç‚¹æ¥å¸®åŠ©æ‚¨è®­ç»ƒDreamBoothæ¨¡å‹ã€‚å®‰è£…bitsandbytesï¼š

```py
pip install bitsandbytes
```

ç„¶åï¼Œå°†ä»¥ä¸‹å‚æ•°æ·»åŠ åˆ°æ‚¨çš„è®­ç»ƒå‘½ä»¤ä¸­ï¼š

```py
accelerate launch train_dreambooth.py \
  --gradient_checkpointing \
  --use_8bit_adam \
```

PyTorchFlax

```py
export MODEL_NAME="runwayml/stable-diffusion-v1-5"
export INSTANCE_DIR="./dog"
export OUTPUT_DIR="path_to_saved_model"

accelerate launch train_dreambooth.py \
  --pretrained_model_name_or_path=$MODEL_NAME  \
  --instance_data_dir=$INSTANCE_DIR \
  --output_dir=$OUTPUT_DIR \
  --instance_prompt="a photo of sks dog" \
  --resolution=512 \
  --train_batch_size=1 \
  --gradient_accumulation_steps=1 \
  --learning_rate=5e-6 \
  --lr_scheduler="constant" \
  --lr_warmup_steps=0 \
  --max_train_steps=400 \
  --push_to_hub
```

è®­ç»ƒå®Œæˆåï¼Œæ‚¨å¯ä»¥ä½¿ç”¨æ–°è®­ç»ƒçš„æ¨¡å‹è¿›è¡Œæ¨ç†ï¼

åœ¨è®­ç»ƒå®Œæˆä¹‹å‰å°±è¿«ä¸åŠå¾…åœ°å°è¯•æ‚¨çš„æ¨¡å‹è¿›è¡Œæ¨ç†ï¼ŸğŸ¤­ ç¡®ä¿æ‚¨å·²å®‰è£…æœ€æ–°ç‰ˆæœ¬çš„ğŸ¤— Accelerateã€‚

```py
from diffusers import DiffusionPipeline, UNet2DConditionModel
from transformers import CLIPTextModel
import torch

unet = UNet2DConditionModel.from_pretrained("path/to/model/checkpoint-100/unet")

# if you have trained with `--args.train_text_encoder` make sure to also load the text encoder
text_encoder = CLIPTextModel.from_pretrained("path/to/model/checkpoint-100/checkpoint-100/text_encoder")

pipeline = DiffusionPipeline.from_pretrained(
    "runwayml/stable-diffusion-v1-5", unet=unet, text_encoder=text_encoder, dtype=torch.float16,
).to("cuda")

image = pipeline("A photo of sks dog in a bucket", num_inference_steps=50, guidance_scale=7.5).images[0]
image.save("dog-bucket.png")
```

PyTorchFlax

```py
from diffusers import DiffusionPipeline
import torch

pipeline = DiffusionPipeline.from_pretrained("path_to_saved_model", torch_dtype=torch.float16, use_safetensors=True).to("cuda")
image = pipeline("A photo of sks dog in a bucket", num_inference_steps=50, guidance_scale=7.5).images[0]
image.save("dog-bucket.png")
```

## LoRA

LoRAæ˜¯ä¸€ç§ç”¨äºæ˜¾è‘—å‡å°‘å¯è®­ç»ƒå‚æ•°æ•°é‡çš„è®­ç»ƒæŠ€æœ¯ã€‚å› æ­¤ï¼Œè®­ç»ƒé€Ÿåº¦æ›´å¿«ï¼Œå­˜å‚¨ç»“æœæƒé‡æ›´å®¹æ˜“ï¼Œå› ä¸ºå®ƒä»¬è¦å°å¾—å¤šï¼ˆ~100MBï¼‰ã€‚ä½¿ç”¨[train_dreambooth_lora.py](https://github.com/huggingface/diffusers/blob/main/examples/dreambooth/train_dreambooth_lora.py)è„šæœ¬æ¥ä½¿ç”¨LoRAè¿›è¡Œè®­ç»ƒã€‚

æœ‰å…³LoRAè®­ç»ƒè„šæœ¬çš„æ›´å¤šè¯¦ç»†ä¿¡æ¯ï¼Œè¯·å‚é˜…[LoRAè®­ç»ƒ](lora)æŒ‡å—ã€‚

## Stable Diffusion XL

Stable Diffusion XLï¼ˆSDXLï¼‰æ˜¯ä¸€ä¸ªå¼ºå¤§çš„æ–‡æœ¬åˆ°å›¾åƒæ¨¡å‹ï¼Œå¯ä»¥ç”Ÿæˆé«˜åˆ†è¾¨ç‡å›¾åƒï¼Œå¹¶åœ¨å…¶æ¶æ„ä¸­æ·»åŠ äº†ç¬¬äºŒä¸ªæ–‡æœ¬ç¼–ç å™¨ã€‚ä½¿ç”¨[train_dreambooth_lora_sdxl.py](https://github.com/huggingface/diffusers/blob/main/examples/dreambooth/train_dreambooth_lora_sdxl.py)è„šæœ¬æ¥è®­ç»ƒä¸€ä¸ªå¸¦æœ‰LoRAçš„SDXLæ¨¡å‹ã€‚

æœ‰å…³SDXLè®­ç»ƒè„šæœ¬çš„æ›´å¤šè¯¦ç»†ä¿¡æ¯ï¼Œè¯·å‚é˜…[SDXLè®­ç»ƒ](sdxl)æŒ‡å—ã€‚

## ä¸‹ä¸€æ­¥

æ­å–œæ‚¨è®­ç»ƒæˆåŠŸDreamBoothæ¨¡å‹ï¼è¦äº†è§£å¦‚ä½•ä½¿ç”¨æ‚¨çš„æ–°æ¨¡å‹ï¼Œä»¥ä¸‹æŒ‡å—å¯èƒ½ä¼šæœ‰æ‰€å¸®åŠ©ï¼š

+   å¦‚æœæ‚¨ä½¿ç”¨LoRAè®­ç»ƒäº†æ‚¨çš„æ¨¡å‹ï¼Œå­¦ä¹ å¦‚ä½•[åŠ è½½DreamBooth](../using-diffusers/loading_adapters)æ¨¡å‹è¿›è¡Œæ¨ç†ã€‚
