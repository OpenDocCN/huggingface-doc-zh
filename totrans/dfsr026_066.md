# æ–‡æœ¬åè½¬

> åŸå§‹æ–‡æœ¬ï¼š[https://huggingface.co/docs/diffusers/training/text_inversion](https://huggingface.co/docs/diffusers/training/text_inversion)

[Textual Inversion](https://hf.co/papers/2208.01618)æ˜¯ä¸€ç§è®­ç»ƒæŠ€æœ¯ï¼Œç”¨äºä¸ªæ€§åŒ–å›¾åƒç”Ÿæˆæ¨¡å‹ï¼Œåªéœ€æä¾›å‡ ä¸ªç¤ºä¾‹å›¾åƒï¼Œè®©æ¨¡å‹å­¦ä¹ ã€‚è¯¥æŠ€æœ¯é€šè¿‡å­¦ä¹ å’Œæ›´æ–°æ–‡æœ¬åµŒå…¥ï¼ˆæ–°åµŒå…¥ä¸æ‚¨åœ¨æç¤ºä¸­å¿…é¡»ä½¿ç”¨çš„ç‰¹æ®Šå•è¯ç›¸å…³è”ï¼‰æ¥åŒ¹é…æ‚¨æä¾›çš„ç¤ºä¾‹å›¾åƒã€‚

å¦‚æœæ‚¨åœ¨å…·æœ‰æœ‰é™vRAMçš„GPUä¸Šè¿›è¡Œè®­ç»ƒï¼Œæ‚¨åº”è¯¥å°è¯•åœ¨è®­ç»ƒå‘½ä»¤ä¸­å¯ç”¨`gradient_checkpointing`å’Œ`mixed_precision`å‚æ•°ã€‚æ‚¨è¿˜å¯ä»¥é€šè¿‡ä½¿ç”¨[xFormers](../optimization/xformers)çš„å†…å­˜é«˜æ•ˆæ³¨æ„åŠ›æ¥å‡å°‘å†…å­˜å ç”¨ã€‚JAX/Flaxè®­ç»ƒä¹Ÿæ”¯æŒåœ¨TPUå’ŒGPUä¸Šè¿›è¡Œé«˜æ•ˆè®­ç»ƒï¼Œä½†ä¸æ”¯æŒæ¢¯åº¦æ£€æŸ¥ç‚¹æˆ–xFormersã€‚ä¸PyTorchç›¸åŒçš„é…ç½®å’Œè®¾ç½®ï¼ŒFlaxè®­ç»ƒè„šæœ¬åº”è‡³å°‘å¿«çº¦70%ï¼

æœ¬æŒ‡å—å°†æ¢è®¨[textual_inversion.py](https://github.com/huggingface/diffusers/blob/main/examples/textual_inversion/textual_inversion.py)è„šæœ¬ï¼Œå¸®åŠ©æ‚¨æ›´ç†Ÿæ‚‰å®ƒï¼Œå¹¶äº†è§£å¦‚ä½•ä¸ºè‡ªå·±çš„ç”¨ä¾‹è¿›è¡Œè°ƒæ•´ã€‚

åœ¨è¿è¡Œè„šæœ¬ä¹‹å‰ï¼Œè¯·ç¡®ä¿æ‚¨ä»æºä»£ç å®‰è£…åº“ï¼š

```py
git clone https://github.com/huggingface/diffusers
cd diffusers
pip install .
```

å¯¼èˆªåˆ°åŒ…å«è®­ç»ƒè„šæœ¬çš„ç¤ºä¾‹æ–‡ä»¶å¤¹ï¼Œå¹¶å®‰è£…æ‚¨æ­£åœ¨ä½¿ç”¨çš„è„šæœ¬æ‰€éœ€çš„ä¾èµ–é¡¹ï¼š

PyTorchFlax

```py
cd examples/textual_inversion
pip install -r requirements.txt
```

ğŸ¤— Accelerateæ˜¯ä¸€ä¸ªåº“ï¼Œå¯ä»¥å¸®åŠ©æ‚¨åœ¨å¤šä¸ªGPU/TPUä¸Šè¿›è¡Œè®­ç»ƒï¼Œæˆ–è€…ä½¿ç”¨æ··åˆç²¾åº¦ã€‚å®ƒå°†æ ¹æ®æ‚¨çš„ç¡¬ä»¶å’Œç¯å¢ƒè‡ªåŠ¨é…ç½®æ‚¨çš„è®­ç»ƒè®¾ç½®ã€‚æŸ¥çœ‹ğŸ¤— Accelerate [å¿«é€Ÿå…¥é—¨](https://huggingface.co/docs/accelerate/quicktour)ä»¥äº†è§£æ›´å¤šä¿¡æ¯ã€‚

åˆå§‹åŒ–ğŸ¤— Accelerateç¯å¢ƒï¼š

```py
accelerate config
```

è¦è®¾ç½®é»˜è®¤çš„ğŸ¤— Accelerateç¯å¢ƒè€Œä¸é€‰æ‹©ä»»ä½•é…ç½®ï¼š

```py
accelerate config default
```

æˆ–è€…ï¼Œå¦‚æœæ‚¨çš„ç¯å¢ƒä¸æ”¯æŒäº¤äº’å¼shellï¼Œæ¯”å¦‚ç¬”è®°æœ¬ï¼Œæ‚¨å¯ä»¥ä½¿ç”¨ï¼š

```py
from accelerate.utils import write_basic_config

write_basic_config()
```

æœ€åï¼Œå¦‚æœæ‚¨æƒ³åœ¨è‡ªå·±çš„æ•°æ®é›†ä¸Šè®­ç»ƒæ¨¡å‹ï¼Œè¯·æŸ¥çœ‹[åˆ›å»ºç”¨äºè®­ç»ƒçš„æ•°æ®é›†](create_dataset)æŒ‡å—ï¼Œäº†è§£å¦‚ä½•åˆ›å»ºé€‚ç”¨äºè®­ç»ƒè„šæœ¬çš„æ•°æ®é›†ã€‚

ä»¥ä¸‹éƒ¨åˆ†çªå‡ºæ˜¾ç¤ºäº†è®­ç»ƒè„šæœ¬çš„é‡è¦éƒ¨åˆ†ï¼Œæœ‰åŠ©äºäº†è§£å¦‚ä½•ä¿®æ”¹å®ƒï¼Œä½†å¹¶æœªè¯¦ç»†æ¶µç›–è„šæœ¬çš„æ¯ä¸ªæ–¹é¢ã€‚å¦‚æœæ‚¨æœ‰å…´è¶£äº†è§£æ›´å¤šï¼Œè¯·éšæ—¶é˜…è¯»[è„šæœ¬](https://github.com/huggingface/diffusers/blob/main/examples/textual_inversion/textual_inversion.py)ï¼Œå¦‚æœæ‚¨æœ‰ä»»ä½•é—®é¢˜æˆ–ç–‘è™‘ï¼Œè¯·å‘Šè¯‰æˆ‘ä»¬ã€‚

## è„šæœ¬å‚æ•°

è®­ç»ƒè„šæœ¬æœ‰è®¸å¤šå‚æ•°ï¼Œå¯å¸®åŠ©æ‚¨æ ¹æ®éœ€è¦å®šåˆ¶è®­ç»ƒè¿è¡Œã€‚æ‰€æœ‰å‚æ•°åŠå…¶æè¿°éƒ½åˆ—åœ¨[`parse_args()`](https://github.com/huggingface/diffusers/blob/839c2a5ece0af4e75530cb520d77bc7ed8acf474/examples/textual_inversion/textual_inversion.py#L176)å‡½æ•°ä¸­ã€‚åœ¨é€‚ç”¨çš„æƒ…å†µä¸‹ï¼ŒDiffusersä¸ºæ¯ä¸ªå‚æ•°æä¾›é»˜è®¤å€¼ï¼Œå¦‚è®­ç»ƒæ‰¹é‡å¤§å°å’Œå­¦ä¹ ç‡ï¼Œä½†å¦‚æœæ‚¨æ„¿æ„ï¼Œå¯ä»¥åœ¨è®­ç»ƒå‘½ä»¤ä¸­æ›´æ”¹è¿™äº›å€¼ã€‚

ä¾‹å¦‚ï¼Œè¦å¢åŠ æ¢¯åº¦ç´¯ç§¯æ­¥æ•°ï¼Œè¶…è¿‡é»˜è®¤å€¼1ï¼š

```py
accelerate launch textual_inversion.py \
  --gradient_accumulation_steps=4
```

è¿˜æœ‰ä¸€äº›å…¶ä»–åŸºæœ¬å’Œé‡è¦çš„å‚æ•°éœ€è¦æŒ‡å®šï¼š

+   `--pretrained_model_name_or_path`: Hubä¸Šæ¨¡å‹çš„åç§°æˆ–é¢„è®­ç»ƒæ¨¡å‹çš„æœ¬åœ°è·¯å¾„

+   `--train_data_dir`: æŒ‡å‘åŒ…å«è®­ç»ƒæ•°æ®é›†ï¼ˆä¾‹å¦‚å›¾åƒï¼‰çš„æ–‡ä»¶å¤¹è·¯å¾„

+   `--output_dir`: ä¿å­˜è®­ç»ƒæ¨¡å‹çš„ä½ç½®

+   `--push_to_hub`: æ˜¯å¦å°†è®­ç»ƒå¥½çš„æ¨¡å‹æ¨é€åˆ°Hub

+   `--checkpointing_steps`: ä¿å­˜æ£€æŸ¥ç‚¹çš„é¢‘ç‡ï¼Œå½“æ¨¡å‹è®­ç»ƒæ—¶ï¼›å¦‚æœç”±äºæŸç§åŸå› è®­ç»ƒä¸­æ–­ï¼Œæ‚¨å¯ä»¥é€šè¿‡åœ¨è®­ç»ƒå‘½ä»¤ä¸­æ·»åŠ `--resume_from_checkpoint`æ¥ä»è¯¥æ£€æŸ¥ç‚¹ç»§ç»­è®­ç»ƒ

+   `--num_vectors`ï¼šè¦å­¦ä¹ åµŒå…¥çš„å‘é‡æ•°é‡ï¼›å¢åŠ æ­¤å‚æ•°æœ‰åŠ©äºæ¨¡å‹å­¦ä¹ æ›´å¥½ï¼Œä½†ä¼šå¢åŠ è®­ç»ƒæˆæœ¬

+   `--placeholder_token`ï¼šå°†å­¦ä¹ çš„åµŒå…¥ä¸ä¹‹å…³è”çš„ç‰¹æ®Šå•è¯ï¼ˆæ‚¨å¿…é¡»åœ¨æ¨ç†ä¸­ä½¿ç”¨è¯¥å•è¯ï¼‰

+   `--initializer_token`ï¼šå¤§è‡´æè¿°æ‚¨è¦è®­ç»ƒçš„å¯¹è±¡æˆ–é£æ ¼çš„å•è¯

+   `--learnable_property`ï¼šæ‚¨æ˜¯å¦æ­£åœ¨è®­ç»ƒæ¨¡å‹å­¦ä¹ æ–°çš„â€œé£æ ¼â€ï¼ˆä¾‹å¦‚ï¼Œæ¢µé«˜çš„ç»˜ç”»é£æ ¼ï¼‰æˆ–â€œå¯¹è±¡â€ï¼ˆä¾‹å¦‚ï¼Œæ‚¨çš„ç‹—ï¼‰

## è®­ç»ƒè„šæœ¬

ä¸å…¶ä»–ä¸€äº›è®­ç»ƒè„šæœ¬ä¸åŒï¼Œtextual_inversion.pyå…·æœ‰ä¸€ä¸ªè‡ªå®šä¹‰æ•°æ®é›†ç±»ï¼Œ[`TextualInversionDataset`](https://github.com/huggingface/diffusers/blob/b81c69e489aad3a0ba73798c459a33990dc4379c/examples/textual_inversion/textual_inversion.py#L487)ç”¨äºåˆ›å»ºæ•°æ®é›†ã€‚æ‚¨å¯ä»¥è‡ªå®šä¹‰å›¾åƒå¤§å°ã€å ä½ç¬¦æ ‡è®°ã€æ’å€¼æ–¹æ³•ã€æ˜¯å¦è£å‰ªå›¾åƒç­‰ã€‚å¦‚æœæ‚¨éœ€è¦æ›´æ”¹æ•°æ®é›†çš„åˆ›å»ºæ–¹å¼ï¼Œå¯ä»¥ä¿®æ”¹`TextualInversionDataset`ã€‚

æ¥ä¸‹æ¥ï¼Œæ‚¨å°†åœ¨[`main()`](https://github.com/huggingface/diffusers/blob/839c2a5ece0af4e75530cb520d77bc7ed8acf474/examples/textual_inversion/textual_inversion.py#L573)å‡½æ•°ä¸­æ‰¾åˆ°æ•°æ®é›†é¢„å¤„ç†ä»£ç å’Œè®­ç»ƒå¾ªç¯ã€‚

è„šæœ¬é¦–å…ˆåŠ è½½[tokenizer](https://github.com/huggingface/diffusers/blob/b81c69e489aad3a0ba73798c459a33990dc4379c/examples/textual_inversion/textual_inversion.py#L616)ã€[schedulerå’Œmodel](https://github.com/huggingface/diffusers/blob/b81c69e489aad3a0ba73798c459a33990dc4379c/examples/textual_inversion/textual_inversion.py#L622)ï¼š

```py
# Load tokenizer
if args.tokenizer_name:
    tokenizer = CLIPTokenizer.from_pretrained(args.tokenizer_name)
elif args.pretrained_model_name_or_path:
    tokenizer = CLIPTokenizer.from_pretrained(args.pretrained_model_name_or_path, subfolder="tokenizer")

# Load scheduler and models
noise_scheduler = DDPMScheduler.from_pretrained(args.pretrained_model_name_or_path, subfolder="scheduler")
text_encoder = CLIPTextModel.from_pretrained(
    args.pretrained_model_name_or_path, subfolder="text_encoder", revision=args.revision
)
vae = AutoencoderKL.from_pretrained(args.pretrained_model_name_or_path, subfolder="vae", revision=args.revision)
unet = UNet2DConditionModel.from_pretrained(
    args.pretrained_model_name_or_path, subfolder="unet", revision=args.revision
)
```

æ¥ä¸‹æ¥åœ¨tokenizeræ—è¾¹æ·»åŠ ç‰¹æ®Šçš„[å ä½ç¬¦æ ‡è®°](https://github.com/huggingface/diffusers/blob/b81c69e489aad3a0ba73798c459a33990dc4379c/examples/textual_inversion/textual_inversion.py#L632)ï¼Œå¹¶è°ƒæ•´åµŒå…¥ä»¥è€ƒè™‘æ–°æ ‡è®°ã€‚

ç„¶åï¼Œè„šæœ¬ä»`TextualInversionDataset`ä¸­[åˆ›å»ºæ•°æ®é›†](https://github.com/huggingface/diffusers/blob/b81c69e489aad3a0ba73798c459a33990dc4379c/examples/textual_inversion/textual_inversion.py#L716)ï¼š

```py
train_dataset = TextualInversionDataset(
    data_root=args.train_data_dir,
    tokenizer=tokenizer,
    size=args.resolution,
    placeholder_token=(" ".join(tokenizer.convert_ids_to_tokens(placeholder_token_ids))),
    repeats=args.repeats,
    learnable_property=args.learnable_property,
    center_crop=args.center_crop,
    set="train",
)
train_dataloader = torch.utils.data.DataLoader(
    train_dataset, batch_size=args.train_batch_size, shuffle=True, num_workers=args.dataloader_num_workers
)
```

æœ€åï¼Œ[è®­ç»ƒå¾ªç¯](https://github.com/huggingface/diffusers/blob/b81c69e489aad3a0ba73798c459a33990dc4379c/examples/textual_inversion/textual_inversion.py#L784)å¤„ç†ä»é¢„æµ‹å˜ˆæ‚æ®‹å·®åˆ°æ›´æ–°ç‰¹æ®Šå ä½ç¬¦æ ‡è®°çš„åµŒå…¥æƒé‡çš„æ‰€æœ‰å…¶ä»–å†…å®¹ã€‚

å¦‚æœæ‚¨æƒ³äº†è§£è®­ç»ƒå¾ªç¯çš„å·¥ä½œåŸç†ï¼Œè¯·æŸ¥çœ‹[ç†è§£ç®¡é“ã€æ¨¡å‹å’Œè°ƒåº¦å™¨](../using-diffusers/write_own_pipeline)æ•™ç¨‹ï¼Œè¯¥æ•™ç¨‹è§£é‡Šäº†å»å™ªè¿‡ç¨‹çš„åŸºæœ¬æ¨¡å¼ã€‚

## å¯åŠ¨è„šæœ¬

ä¸€æ—¦æ‚¨å®Œæˆäº†æ‰€æœ‰æ›´æ”¹æˆ–å¯¹é»˜è®¤é…ç½®æ»¡æ„ï¼Œæ‚¨å°±å¯ä»¥å¯åŠ¨è®­ç»ƒè„šæœ¬äº†ï¼ğŸš€

å¯¹äºæœ¬æŒ‡å—ï¼Œæ‚¨å°†ä¸‹è½½ä¸€äº›[çŒ«ç©å…·çš„å›¾åƒ](https://huggingface.co/datasets/diffusers/cat_toy_example)å¹¶å°†å®ƒä»¬å­˜å‚¨åœ¨ä¸€ä¸ªç›®å½•ä¸­ã€‚ä½†è¯·è®°ä½ï¼Œå¦‚æœæ‚¨æ„¿æ„ï¼Œæ‚¨å¯ä»¥åˆ›å»ºå¹¶ä½¿ç”¨è‡ªå·±çš„æ•°æ®é›†ï¼ˆè¯·å‚é˜…[åˆ›å»ºç”¨äºè®­ç»ƒçš„æ•°æ®é›†](create_dataset)æŒ‡å—ï¼‰ã€‚

```py
from huggingface_hub import snapshot_download

local_dir = "./cat"
snapshot_download(
    "diffusers/cat_toy_example", local_dir=local_dir, repo_type="dataset", ignore_patterns=".gitattributes"
)
```

å°†ç¯å¢ƒå˜é‡`MODEL_NAME`è®¾ç½®ä¸ºHubä¸Šçš„æ¨¡å‹IDæˆ–æœ¬åœ°æ¨¡å‹çš„è·¯å¾„ï¼Œå¹¶å°†`DATA_DIR`è®¾ç½®ä¸ºæ‚¨åˆšä¸‹è½½çŒ«å›¾åƒçš„è·¯å¾„ã€‚è„šæœ¬å°†ä»¥ä¸‹æ–‡ä»¶åˆ›å»ºå¹¶ä¿å­˜åˆ°æ‚¨çš„å­˜å‚¨åº“ä¸­ï¼š

+   `learned_embeds.bin`ï¼šä¸æ‚¨çš„ç¤ºä¾‹å›¾åƒå¯¹åº”çš„å­¦ä¹ åµŒå…¥å‘é‡

+   `token_identifier.txt`ï¼šç‰¹æ®Šçš„å ä½ç¬¦æ ‡è®°

+   `type_of_concept.txt`ï¼šæ‚¨æ­£åœ¨è®­ç»ƒçš„æ¦‚å¿µç±»å‹ï¼ˆâ€œå¯¹è±¡â€æˆ–â€œé£æ ¼â€ï¼‰

åœ¨å•ä¸ªV100 GPUä¸Šè¿›è¡Œå®Œæ•´çš„è®­ç»ƒéœ€è¦çº¦1å°æ—¶ã€‚

åœ¨å¯åŠ¨è„šæœ¬ä¹‹å‰è¿˜æœ‰ä¸€ä»¶äº‹ã€‚å¦‚æœæ‚¨æœ‰å…´è¶£è·Ÿè¸ªè®­ç»ƒè¿‡ç¨‹ï¼Œæ‚¨å¯ä»¥åœ¨è®­ç»ƒè¿‡ç¨‹ä¸­å®šæœŸä¿å­˜ç”Ÿæˆçš„å›¾åƒã€‚å°†ä»¥ä¸‹å‚æ•°æ·»åŠ åˆ°è®­ç»ƒå‘½ä»¤ä¸­ï¼š

```py
--validation_prompt="A <cat-toy> train"
--num_validation_images=4
--validation_steps=100
```

PyTorchFlax

```py
export MODEL_NAME="runwayml/stable-diffusion-v1-5"
export DATA_DIR="./cat"

accelerate launch textual_inversion.py \
  --pretrained_model_name_or_path=$MODEL_NAME \
  --train_data_dir=$DATA_DIR \
  --learnable_property="object" \
  --placeholder_token="<cat-toy>" \
  --initializer_token="toy" \
  --resolution=512 \
  --train_batch_size=1 \
  --gradient_accumulation_steps=4 \
  --max_train_steps=3000 \
  --learning_rate=5.0e-04 \
  --scale_lr \
  --lr_scheduler="constant" \
  --lr_warmup_steps=0 \
  --output_dir="textual_inversion_cat" \
  --push_to_hub
```

è®­ç»ƒå®Œæˆåï¼Œæ‚¨å¯ä»¥åƒè¿™æ ·ä½¿ç”¨æ‚¨æ–°è®­ç»ƒçš„æ¨¡å‹è¿›è¡Œæ¨ç†ï¼š

PyTorchFlax

```py
from diffusers import StableDiffusionPipeline
import torch

pipeline = StableDiffusionPipeline.from_pretrained("runwayml/stable-diffusion-v1-5", torch_dtype=torch.float16).to("cuda")
pipeline.load_textual_inversion("sd-concepts-library/cat-toy")
image = pipeline("A <cat-toy> train", num_inference_steps=50).images[0]
image.save("cat-train.png")
```

## ä¸‹ä¸€æ­¥

æ­å–œæ‚¨è®­ç»ƒå‡ºè‡ªå·±çš„æ–‡æœ¬åè½¬æ¨¡å‹ï¼ğŸ‰ è¦äº†è§£å¦‚ä½•ä½¿ç”¨æ‚¨çš„æ–°æ¨¡å‹ï¼Œä»¥ä¸‹æŒ‡å—å¯èƒ½ä¼šæœ‰æ‰€å¸®åŠ©ï¼š

+   å­¦ä¹ å¦‚ä½•[åŠ è½½æ–‡æœ¬åè½¬åµŒå…¥](../using-diffusers/loading_adapters)ï¼Œå¹¶å°†å…¶ç”¨ä½œè´ŸåµŒå…¥ã€‚

+   å­¦ä¹ å¦‚ä½•ä½¿ç”¨[æ–‡æœ¬åè½¬](textual_inversion_inference)è¿›è¡Œæ¨ç†ï¼ŒåŒ…æ‹¬ Stable Diffusion 1/2 å’Œ Stable Diffusion XLã€‚
