# å°†æ‚¨çš„ä»£ç è¿ç§»åˆ° ğŸ¤— Accelerate

> åŸæ–‡é“¾æ¥ï¼š[https://huggingface.co/docs/accelerate/basic_tutorials/migration](https://huggingface.co/docs/accelerate/basic_tutorials/migration)

æœ¬æ•™ç¨‹å°†è¯¦ç»†ä»‹ç»å¦‚ä½•è½»æ¾å°†ç°æœ‰çš„ PyTorch ä»£ç è½¬æ¢ä¸ºä½¿ç”¨ ğŸ¤— Accelerateï¼æ‚¨å°†çœ‹åˆ°ï¼Œé€šè¿‡ä»…æ›´æ”¹å‡ è¡Œä»£ç ï¼ŒğŸ¤— Accelerate å°±å¯ä»¥å‘æŒ¥å…¶é­”åŠ›ï¼Œè®©æ‚¨è½»æ¾åœ°å°†ä»£ç è¿è¡Œåœ¨åˆ†å¸ƒå¼ç³»ç»Ÿä¸Šï¼

## åŸºæœ¬è®­ç»ƒå¾ªç¯

é¦–å…ˆï¼Œç¼–å†™ä¸€ä¸ªéå¸¸åŸºæœ¬çš„ PyTorch è®­ç»ƒå¾ªç¯ã€‚

æˆ‘ä»¬å‡è®¾ `training_dataloader`ã€`model`ã€`optimizer`ã€`scheduler` å’Œ `loss_function` å·²ç»äº‹å…ˆå®šä¹‰å¥½ã€‚

```py
device = "cuda"
model.to(device)

for batch in training_dataloader:
    optimizer.zero_grad()
    inputs, targets = batch
    inputs = inputs.to(device)
    targets = targets.to(device)
    outputs = model(inputs)
    loss = loss_function(outputs, targets)
    loss.backward()
    optimizer.step()
    scheduler.step()
```

## æ·»åŠ  ğŸ¤— Accelerate

è¦å¼€å§‹ä½¿ç”¨ ğŸ¤— Accelerateï¼Œè¯·é¦–å…ˆå¯¼å…¥å¹¶åˆ›å»ºä¸€ä¸ª [Accelerator](/docs/accelerate/v0.27.2/en/package_reference/accelerator#accelerate.Accelerator) å®ä¾‹ï¼š

```py
from accelerate import Accelerator

accelerator = Accelerator()
```

[Accelerator](/docs/accelerate/v0.27.2/en/package_reference/accelerator#accelerate.Accelerator) æ˜¯åˆ©ç”¨åˆ†å¸ƒå¼è®­ç»ƒçš„æ‰€æœ‰å¯èƒ½é€‰é¡¹çš„ä¸»è¦åŠ›é‡ï¼

### è®¾ç½®æ­£ç¡®çš„è®¾å¤‡

[Accelerator](/docs/accelerate/v0.27.2/en/package_reference/accelerator#accelerate.Accelerator) ç±»çŸ¥é“ä»»ä½•æ—¶å€™å°†ä»»ä½• PyTorch å¯¹è±¡ç§»åŠ¨åˆ°æ­£ç¡®è®¾å¤‡ï¼Œå› æ­¤æ‚¨åº”è¯¥å°† `device` çš„å®šä¹‰æ›´æ”¹ä¸ºæ¥è‡ª [Accelerator](/docs/accelerate/v0.27.2/en/package_reference/accelerator#accelerate.Accelerator)ï¼š

```py
- device = 'cuda'
+ device = accelerator.device
  model.to(device)
```

### å‡†å¤‡æ‚¨çš„å¯¹è±¡

æ¥ä¸‹æ¥ï¼Œæ‚¨éœ€è¦å°†æ‰€æœ‰ä¸è®­ç»ƒç›¸å…³çš„é‡è¦å¯¹è±¡ä¼ é€’ç»™ [prepare()](/docs/accelerate/v0.27.2/en/package_reference/accelerator#accelerate.Accelerator.prepare)ã€‚ğŸ¤— Accelerate å°†ç¡®ä¿ä¸€åˆ‡éƒ½åœ¨å½“å‰ç¯å¢ƒä¸­è®¾ç½®å¥½ï¼Œä»¥ä¾¿æ‚¨å¼€å§‹è®­ç»ƒï¼š

```py
model, optimizer, training_dataloader, scheduler = accelerator.prepare(
 model, optimizer, training_dataloader, scheduler
)
```

è¿™äº›å¯¹è±¡ä»¥å‘é€é¡ºåºè¿”å›ã€‚é»˜è®¤æƒ…å†µä¸‹ï¼Œå½“ä½¿ç”¨ `device_placement=True` æ—¶ï¼Œæ‰€æœ‰å¯ä»¥å‘é€åˆ°æ­£ç¡®è®¾å¤‡çš„å¯¹è±¡éƒ½ä¼šè¢«å‘é€ã€‚å¦‚æœæ‚¨éœ€è¦å¤„ç†æœªä¼ é€’ç»™ [~Accelerator.prepare] ä½†åº”è¯¥åœ¨æ´»åŠ¨è®¾å¤‡ä¸Šçš„æ•°æ®ï¼Œæ‚¨åº”è¯¥ä¼ å…¥ä¹‹å‰åˆ›å»ºçš„ `device`ã€‚

Accelerate ä»…ä¼šå‡†å¤‡ä»å„è‡ªçš„ PyTorch ç±»ç»§æ‰¿çš„å¯¹è±¡ï¼ˆå¦‚ `torch.optim.Optimizer`ï¼‰ã€‚

### ä¿®æ”¹è®­ç»ƒå¾ªç¯

æœ€åï¼Œåœ¨è®­ç»ƒå¾ªç¯ä¸­éœ€è¦æ›´æ”¹ä¸‰è¡Œä»£ç ã€‚ğŸ¤— Accelerate çš„ DataLoader ç±»å°†é»˜è®¤è‡ªåŠ¨å¤„ç†è®¾å¤‡æ”¾ç½®ï¼Œå¹¶ä¸”åº”ä½¿ç”¨ [backward()](/docs/accelerate/v0.27.2/en/package_reference/accelerator#accelerate.Accelerator.backward) æ¥æ‰§è¡Œåå‘ä¼ æ’­ï¼š

```py
-   inputs = inputs.to(device)
-   targets = targets.to(device)
    outputs = model(inputs)
    loss = loss_function(outputs, targets)
-   loss.backward()
+   accelerator.backward(loss)
```

æœ‰äº†è¿™äº›ï¼Œæ‚¨çš„è®­ç»ƒå¾ªç¯ç°åœ¨å·²å‡†å¤‡å¥½ä½¿ç”¨ ğŸ¤— Accelerateï¼

## å®Œæˆçš„ä»£ç 

ä»¥ä¸‹æ˜¯è½¬æ¢åä»£ç çš„æœ€ç»ˆç‰ˆæœ¬ï¼š

```py
from accelerate import Accelerator

accelerator = Accelerator()

model, optimizer, training_dataloader, scheduler = accelerator.prepare(
    model, optimizer, training_dataloader, scheduler
)

for batch in training_dataloader:
    optimizer.zero_grad()
    inputs, targets = batch
    outputs = model(inputs)
    loss = loss_function(outputs, targets)
    accelerator.backward(loss)
    optimizer.step()
    scheduler.step()
```

## æ›´å¤šèµ„æº

è¦äº†è§£æ›´å¤šå…³äºå¦‚ä½•è¿ç§»åˆ° ğŸ¤— Accelerate çš„æ–¹æ³•ï¼Œè¯·æŸ¥çœ‹æˆ‘ä»¬çš„ [äº¤äº’å¼è¿ç§»æ•™ç¨‹](https://huggingface.co/docs/accelerate/usage_guides/explore)ï¼Œå±•ç¤ºäº†åœ¨ä½¿ç”¨ Accelerate æ—¶éœ€è¦æ³¨æ„çš„å…¶ä»–é¡¹ç›®ä»¥åŠå¦‚ä½•å¿«é€Ÿå®ç°ã€‚
