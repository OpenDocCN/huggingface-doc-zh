# æ— æ¡ä»¶å›¾åƒç”Ÿæˆ

> åŸå§‹æ–‡æœ¬ï¼š[https://huggingface.co/docs/diffusers/training/unconditional_training](https://huggingface.co/docs/diffusers/training/unconditional_training)

æ— æ¡ä»¶å›¾åƒç”Ÿæˆæ¨¡å‹åœ¨è®­ç»ƒè¿‡ç¨‹ä¸­ä¸å—æ–‡æœ¬æˆ–å›¾åƒçš„é™åˆ¶ã€‚å®ƒåªç”Ÿæˆç±»ä¼¼äºå…¶è®­ç»ƒæ•°æ®åˆ†å¸ƒçš„å›¾åƒã€‚

æœ¬æŒ‡å—å°†æ¢ç´¢[train_unconditional.py](https://github.com/huggingface/diffusers/blob/main/examples/unconditional_image_generation/train_unconditional.py)è®­ç»ƒè„šæœ¬ï¼Œå¸®åŠ©æ‚¨ç†Ÿæ‚‰å®ƒï¼Œä»¥åŠå¦‚ä½•ä¸ºæ‚¨è‡ªå·±çš„ç”¨ä¾‹è¿›è¡Œè°ƒæ•´ã€‚

åœ¨è¿è¡Œè„šæœ¬ä¹‹å‰ï¼Œè¯·ç¡®ä¿æ‚¨ä»æºä»£ç å®‰è£…äº†åº“ï¼š

```py
git clone https://github.com/huggingface/diffusers
cd diffusers
pip install .
```

ç„¶åå¯¼èˆªåˆ°åŒ…å«è®­ç»ƒè„šæœ¬çš„ç¤ºä¾‹æ–‡ä»¶å¤¹ï¼Œå¹¶å®‰è£…æ‰€éœ€çš„ä¾èµ–é¡¹ï¼š

```py
cd examples/unconditional_image_generation
pip install -r requirements.txt
```

ğŸ¤— Accelerateæ˜¯ä¸€ä¸ªå¸®åŠ©æ‚¨åœ¨å¤šä¸ªGPU/TPUä¸Šè®­ç»ƒæˆ–ä½¿ç”¨æ··åˆç²¾åº¦çš„åº“ã€‚å®ƒå°†æ ¹æ®æ‚¨çš„ç¡¬ä»¶å’Œç¯å¢ƒè‡ªåŠ¨é…ç½®æ‚¨çš„è®­ç»ƒè®¾ç½®ã€‚æŸ¥çœ‹ğŸ¤— Accelerate [å¿«é€Ÿå…¥é—¨](https://huggingface.co/docs/accelerate/quicktour)ä»¥äº†è§£æ›´å¤šä¿¡æ¯ã€‚

åˆå§‹åŒ–ä¸€ä¸ªğŸ¤— Accelerateç¯å¢ƒï¼š

```py
accelerate config
```

è¦è®¾ç½®ä¸€ä¸ªé»˜è®¤çš„ğŸ¤— Accelerateç¯å¢ƒè€Œä¸é€‰æ‹©ä»»ä½•é…ç½®ï¼š

```py
accelerate config default
```

æˆ–è€…å¦‚æœæ‚¨çš„ç¯å¢ƒä¸æ”¯æŒåƒç¬”è®°æœ¬è¿™æ ·çš„äº¤äº’å¼shellï¼Œæ‚¨å¯ä»¥ä½¿ç”¨ï¼š

```py
from accelerate.utils import write_basic_config

write_basic_config()
```

æœ€åï¼Œå¦‚æœæ‚¨æƒ³åœ¨è‡ªå·±çš„æ•°æ®é›†ä¸Šè®­ç»ƒæ¨¡å‹ï¼Œè¯·æŸ¥çœ‹[åˆ›å»ºç”¨äºè®­ç»ƒçš„æ•°æ®é›†](create_dataset)æŒ‡å—ï¼Œäº†è§£å¦‚ä½•åˆ›å»ºä¸€ä¸ªé€‚ç”¨äºè®­ç»ƒè„šæœ¬çš„æ•°æ®é›†ã€‚

## è„šæœ¬å‚æ•°

ä»¥ä¸‹éƒ¨åˆ†çªå‡ºæ˜¾ç¤ºäº†è®­ç»ƒè„šæœ¬ä¸­é‡è¦çš„éƒ¨åˆ†ï¼Œä»¥ä¾¿äº†è§£å¦‚ä½•ä¿®æ”¹å®ƒï¼Œä½†å¹¶æœªè¯¦ç»†æ¶µç›–è„šæœ¬çš„æ¯ä¸ªæ–¹é¢ã€‚å¦‚æœæ‚¨æœ‰å…´è¶£äº†è§£æ›´å¤šï¼Œè¯·éšæ—¶é˜…è¯»[è„šæœ¬](https://github.com/huggingface/diffusers/blob/main/examples/unconditional_image_generation/train_unconditional.py)ï¼Œå¹¶å‘Šè¯‰æˆ‘ä»¬å¦‚æœæ‚¨æœ‰ä»»ä½•é—®é¢˜æˆ–ç–‘è™‘ã€‚

è®­ç»ƒè„šæœ¬æä¾›äº†è®¸å¤šå‚æ•°ï¼Œå¸®åŠ©æ‚¨å®šåˆ¶æ‚¨çš„è®­ç»ƒè¿è¡Œã€‚æ‰€æœ‰å‚æ•°åŠå…¶æè¿°éƒ½åœ¨[`parse_args()`](https://github.com/huggingface/diffusers/blob/096f84b05f9514fae9f185cbec0a4d38fbad9919/examples/unconditional_image_generation/train_unconditional.py#L55)å‡½æ•°ä¸­æ‰¾åˆ°ã€‚å®ƒä¸ºæ¯ä¸ªå‚æ•°æä¾›äº†é»˜è®¤å€¼ï¼Œå¦‚è®­ç»ƒæ‰¹é‡å¤§å°å’Œå­¦ä¹ ç‡ï¼Œä½†å¦‚æœæ‚¨æ„¿æ„ï¼Œä¹Ÿå¯ä»¥åœ¨è®­ç»ƒå‘½ä»¤ä¸­è®¾ç½®è‡ªå·±çš„å€¼ã€‚

ä¾‹å¦‚ï¼Œè¦ä½¿ç”¨bf16æ ¼å¼åŠ é€Ÿæ··åˆç²¾åº¦è®­ç»ƒï¼Œè¯·åœ¨è®­ç»ƒå‘½ä»¤ä¸­æ·»åŠ `--mixed_precision`å‚æ•°ï¼š

```py
accelerate launch train_unconditional.py \
  --mixed_precision="bf16"
```

ä¸€äº›åŸºæœ¬å’Œé‡è¦çš„è¦æŒ‡å®šçš„å‚æ•°åŒ…æ‹¬ï¼š

+   `--dataset_name`ï¼šHubä¸Šçš„æ•°æ®é›†åç§°æˆ–è¦è®­ç»ƒçš„æœ¬åœ°è·¯å¾„æ•°æ®é›†

+   `--output_dir`ï¼šä¿å­˜è®­ç»ƒæ¨¡å‹çš„ä½ç½®

+   `--push_to_hub`ï¼šæ˜¯å¦å°†è®­ç»ƒå¥½çš„æ¨¡å‹æ¨é€åˆ°Hub

+   `--checkpointing_steps`ï¼šåœ¨æ¨¡å‹è®­ç»ƒè¿‡ç¨‹ä¸­ä¿å­˜æ£€æŸ¥ç‚¹çš„é¢‘ç‡ï¼›å¦‚æœè®­ç»ƒè¢«ä¸­æ–­ï¼Œæ‚¨å¯ä»¥é€šè¿‡åœ¨è®­ç»ƒå‘½ä»¤ä¸­æ·»åŠ `--resume_from_checkpoint`æ¥ä»è¯¥æ£€æŸ¥ç‚¹ç»§ç»­è®­ç»ƒ

å¸¦ä¸Šæ‚¨çš„æ•°æ®é›†ï¼Œè®©è®­ç»ƒè„šæœ¬å¤„ç†å…¶ä»–ä¸€åˆ‡ï¼

## è®­ç»ƒè„šæœ¬

ç”¨äºé¢„å¤„ç†æ•°æ®é›†å’Œè®­ç»ƒå¾ªç¯çš„ä»£ç ä½äº[`main()`](https://github.com/huggingface/diffusers/blob/096f84b05f9514fae9f185cbec0a4d38fbad9919/examples/unconditional_image_generation/train_unconditional.py#L275)å‡½æ•°ä¸­ã€‚å¦‚æœæ‚¨éœ€è¦è°ƒæ•´è®­ç»ƒè„šæœ¬ï¼Œè¿™å°±æ˜¯æ‚¨éœ€è¦è¿›è¡Œæ›´æ”¹çš„åœ°æ–¹ã€‚

å¦‚æœæ‚¨æ²¡æœ‰æä¾›æ¨¡å‹é…ç½®ï¼Œ`train_unconditional`è„šæœ¬å°†[åˆå§‹åŒ–ä¸€ä¸ª`UNet2DModel`](https://github.com/huggingface/diffusers/blob/096f84b05f9514fae9f185cbec0a4d38fbad9919/examples/unconditional_image_generation/train_unconditional.py#L356)ã€‚å¦‚æœæ‚¨æ„¿æ„ï¼Œæ‚¨å¯ä»¥åœ¨è¿™é‡Œé…ç½®UNetï¼š

```py
model = UNet2DModel(
    sample_size=args.resolution,
    in_channels=3,
    out_channels=3,
    layers_per_block=2,
    block_out_channels=(128, 128, 256, 256, 512, 512),
    down_block_types=(
        "DownBlock2D",
        "DownBlock2D",
        "DownBlock2D",
        "DownBlock2D",
        "AttnDownBlock2D",
        "DownBlock2D",
    ),
    up_block_types=(
        "UpBlock2D",
        "AttnUpBlock2D",
        "UpBlock2D",
        "UpBlock2D",
        "UpBlock2D",
        "UpBlock2D",
    ),
)
```

æ¥ä¸‹æ¥ï¼Œè„šæœ¬åˆå§‹åŒ–ä¸€ä¸ª[è°ƒåº¦å™¨](https://github.com/huggingface/diffusers/blob/096f84b05f9514fae9f185cbec0a4d38fbad9919/examples/unconditional_image_generation/train_unconditional.py#L418) å’Œ[ä¼˜åŒ–å™¨](https://github.com/huggingface/diffusers/blob/096f84b05f9514fae9f185cbec0a4d38fbad9919/examples/unconditional_image_generation/train_unconditional.py#L429)ï¼š

```py
# Initialize the scheduler
accepts_prediction_type = "prediction_type" in set(inspect.signature(DDPMScheduler.__init__).parameters.keys())
if accepts_prediction_type:
    noise_scheduler = DDPMScheduler(
        num_train_timesteps=args.ddpm_num_steps,
        beta_schedule=args.ddpm_beta_schedule,
        prediction_type=args.prediction_type,
    )
else:
    noise_scheduler = DDPMScheduler(num_train_timesteps=args.ddpm_num_steps, beta_schedule=args.ddpm_beta_schedule)

# Initialize the optimizer
optimizer = torch.optim.AdamW(
    model.parameters(),
    lr=args.learning_rate,
    betas=(args.adam_beta1, args.adam_beta2),
    weight_decay=args.adam_weight_decay,
    eps=args.adam_epsilon,
)
```

ç„¶åï¼Œå®ƒ[åŠ è½½æ•°æ®é›†](https://github.com/huggingface/diffusers/blob/096f84b05f9514fae9f185cbec0a4d38fbad9919/examples/unconditional_image_generation/train_unconditional.py#L451) ï¼Œæ‚¨å¯ä»¥æŒ‡å®šå¦‚ä½•[é¢„å¤„ç†](https://github.com/huggingface/diffusers/blob/096f84b05f9514fae9f185cbec0a4d38fbad9919/examples/unconditional_image_generation/train_unconditional.py#L455) å®ƒï¼š

```py
dataset = load_dataset("imagefolder", data_dir=args.train_data_dir, cache_dir=args.cache_dir, split="train")

augmentations = transforms.Compose(
    [
        transforms.Resize(args.resolution, interpolation=transforms.InterpolationMode.BILINEAR),
        transforms.CenterCrop(args.resolution) if args.center_crop else transforms.RandomCrop(args.resolution),
        transforms.RandomHorizontalFlip() if args.random_flip else transforms.Lambda(lambda x: x),
        transforms.ToTensor(),
        transforms.Normalize([0.5], [0.5]),
    ]
)
```

æœ€åï¼Œ[è®­ç»ƒå¾ªç¯](https://github.com/huggingface/diffusers/blob/096f84b05f9514fae9f185cbec0a4d38fbad9919/examples/unconditional_image_generation/train_unconditional.py#L540) å¤„ç†å…¶ä»–æ‰€æœ‰äº‹é¡¹ï¼Œå¦‚å‘å›¾åƒæ·»åŠ å™ªå£°ï¼Œé¢„æµ‹å™ªå£°æ®‹å·®ï¼Œè®¡ç®—æŸå¤±ï¼Œä¿å­˜æŒ‡å®šæ­¥éª¤çš„æ£€æŸ¥ç‚¹ï¼Œå¹¶ä¿å­˜å¹¶æ¨é€æ¨¡å‹åˆ° Hubã€‚å¦‚æœæ‚¨æƒ³äº†è§£è®­ç»ƒå¾ªç¯çš„å·¥ä½œåŸç†ï¼Œè¯·æŸ¥çœ‹[ç†è§£ç®¡é“ã€æ¨¡å‹å’Œè°ƒåº¦å™¨](../using-diffusers/write_own_pipeline) æ•™ç¨‹ï¼Œè¯¥æ•™ç¨‹è¯¦ç»†è§£é‡Šäº†å»å™ªè¿‡ç¨‹çš„åŸºæœ¬æ¨¡å¼ã€‚

## å¯åŠ¨è„šæœ¬

ä¸€æ—¦æ‚¨å®Œæˆæ‰€æœ‰æ›´æ”¹æˆ–å¯¹é»˜è®¤é…ç½®æ»¡æ„ï¼Œæ‚¨å°±å¯ä»¥å¯åŠ¨è®­ç»ƒè„šæœ¬ï¼ğŸš€

å®Œæ•´çš„è®­ç»ƒè¿è¡Œåœ¨4xV100 GPUä¸Šéœ€è¦2å°æ—¶ã€‚

å•GPUå¤šGPU

```py
accelerate launch train_unconditional.py \
  --dataset_name="huggan/flowers-102-categories" \
  --output_dir="ddpm-ema-flowers-64" \
  --mixed_precision="fp16" \
  --push_to_hub
```

è®­ç»ƒè„šæœ¬ä¼šåœ¨æ‚¨çš„å­˜å‚¨åº“ä¸­åˆ›å»ºå¹¶ä¿å­˜ä¸€ä¸ªæ£€æŸ¥ç‚¹æ–‡ä»¶ã€‚ç°åœ¨æ‚¨å¯ä»¥åŠ è½½å’Œä½¿ç”¨è®­ç»ƒå¥½çš„æ¨¡å‹è¿›è¡Œæ¨æ–­ï¼š

```py
from diffusers import DiffusionPipeline
import torch

pipeline = DiffusionPipeline.from_pretrained("anton-l/ddpm-butterflies-128").to("cuda")
image = pipeline().images[0]
```
