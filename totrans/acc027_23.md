# ä½ç²¾åº¦è®­ç»ƒæ–¹æ³•

> åŸå§‹æ–‡æœ¬ï¼š[https://huggingface.co/docs/accelerate/usage_guides/low_precision_training](https://huggingface.co/docs/accelerate/usage_guides/low_precision_training)

ğŸ¤— Accelerateæä¾›äº†é›†æˆï¼Œå¯ä»¥ä½¿ç”¨æŒ‡å®šæ”¯æŒçš„ç¡¬ä»¶é€šè¿‡`TransformersEngine`å’Œ`MS-AMP`è½¯ä»¶åŒ…è¿›è¡Œä½ç²¾åº¦æ–¹æ³•çš„è®­ç»ƒã€‚æœ¬æ–‡æ¡£å°†å¸®åŠ©æ‚¨äº†è§£æ”¯æŒçš„ç¡¬ä»¶æ˜¯ä»€ä¹ˆï¼Œå¦‚ä½•é…ç½®æ‚¨çš„[åŠ é€Ÿå™¨](/docs/accelerate/v0.27.2/en/package_reference/accelerator#accelerate.Accelerator)ä»¥åˆ©ç”¨ä½ç²¾åº¦æ–¹æ³•ï¼Œä»¥åŠåœ¨è®­ç»ƒæ—¶å¯ä»¥æœŸæœ›ä»€ä¹ˆã€‚

## åœ¨FP8ä¸Šè¿›è¡Œè®­ç»ƒæ„å‘³ç€ä»€ä¹ˆ

è¦æ·±å…¥äº†è§£ä½¿ç”¨PyTorchå’ŒğŸ¤— Accelerateåœ¨FP8ä¸­è¿›è¡Œè®­ç»ƒçš„ç»†èŠ‚ï¼Œè¯·æŸ¥çœ‹[æ¦‚å¿µæŒ‡å—](../concept_guides/low_precision_training.md)ï¼Œäº†è§£ä¸ºä»€ä¹ˆè¿™å¯èƒ½ä¼šå¾ˆå›°éš¾ã€‚ä½†åŸºæœ¬ä¸Šï¼Œä¸åœ¨BF16ä¸­è®­ç»ƒä¸åŒï¼Œè®­ç»ƒæ¨¡å‹çš„æŸäº›ï¼ˆæˆ–å…¨éƒ¨ï¼‰æ–¹é¢å¯ä»¥ä½¿ç”¨8ä½è€Œä¸æ˜¯16ä½æ¥æ‰§è¡Œã€‚æŒ‘æˆ˜åœ¨äºåœ¨ä¸é™ä½æœ€ç»ˆæ€§èƒ½çš„æƒ…å†µä¸‹è¿™æ ·åšã€‚

è¿™ä»…åœ¨ç‰¹å®šçš„NVIDIAç¡¬ä»¶ä¸Šå¯ç”¨ï¼Œå³ï¼š

+   3000ç³»åˆ—æ¶ˆè´¹çº§æ˜¾å¡ä¹‹åçš„ä»»ä½•ç¡¬ä»¶ï¼ˆä¾‹å¦‚4090ï¼‰

+   åŸºäºHopperçš„GPUæ¶æ„ï¼ˆä¾‹å¦‚`H100`å’Œ`H200`ï¼‰

è¿™å°†å¯¼è‡´ä¸€äº›å†…å­˜ä½¿ç”¨ä¸Šçš„å¢ç›Šï¼ˆå› ä¸ºæˆ‘ä»¬å·²ç»å°†æŸäº›è®­ç»ƒéƒ¨åˆ†æ‰€éœ€çš„å†…å­˜å‡å°‘äº†ä¸€åŠï¼‰ï¼Œå¹¶ä¸”å¯¹äºå¯ä»¥ç”¨FP8å¯ç”¨çš„æŸäº›å±‚æ›¿æ¢çš„è¾ƒå¤§æ¨¡å‹ï¼Œä¹Ÿåº”è¯¥ä¼šçœ‹åˆ°ååé‡çš„å¢åŠ ã€‚

## é…ç½®åŠ é€Ÿå™¨

ç›®å‰æ”¯æŒä¸¤ç§ä¸åŒçš„FP8åç«¯ï¼ˆ`TransformersEngine`å’Œ`MS-AMP`ï¼‰ï¼Œæ¯ä¸ªéƒ½å…·æœ‰ä¸åŒçš„åŠŸèƒ½å’Œé…ç½®ã€‚

è¦ä½¿ç”¨ä»»ä½•ä¸€ä¸ªï¼Œéƒ½ä½¿ç”¨ç›¸åŒçš„æ ¸å¿ƒAPIã€‚åªéœ€å°†`mixed_precision="fp8"`ä¼ é€’ç»™[Accelerator](/docs/accelerate/v0.27.2/en/package_reference/accelerator#accelerate.Accelerator)ä¹‹ä¸€ï¼Œåœ¨`accelerate config`æœŸé—´ï¼Œå½“è¯¢é—®æ··åˆç²¾åº¦æ—¶ï¼Œæˆ–ä½œä¸º`config.yaml`æ–‡ä»¶ä¸­çš„`mixed_precision`é”®çš„ä¸€éƒ¨åˆ†ï¼š

```py
from accelerate import Accelerator
accelerator = Accelerator(mixed_precision="fp8")
```

é»˜è®¤æƒ…å†µä¸‹ï¼Œå¦‚æœæ‚¨çš„ç¯å¢ƒä¸­æœ‰`MS-AMP`ï¼ŒğŸ¤— Accelerateå°†è‡ªåŠ¨å°†å…¶ç”¨ä½œåç«¯ã€‚è¦è‡ªè¡ŒæŒ‡å®šå®ƒï¼ˆå¹¶è‡ªå®šä¹‰FP8æ··åˆç²¾åº¦è®¾ç½®çš„å…¶ä»–éƒ¨åˆ†ï¼‰ï¼Œæ‚¨å¯ä»¥ä½¿ç”¨[utils.FP8RecipeKwargs](/docs/accelerate/v0.27.2/en/package_reference/utilities#accelerate.utils.FP8RecipeKwargs)ï¼š

```py
from accelerate import Accelerator
from accelerate.utils import FP8RecipeKwargs
kwargs = [FP8RecipeKwargs(backend="msamp")]
# Or to specify the backend as `TransformersEngine` even if MS-AMP is installed
# kwargs = [FP8RecipeKwargs(backend="te")]
accelerator = Accelerator(mixed_precision="fp8", kwarg_handlers=kwargs)
```

## é…ç½®MS-AMP

åœ¨è¿™ä¸¤è€…ä¸­ï¼Œ`MS-AMP`ä¼ ç»Ÿä¸Šæ›´å®¹æ˜“é…ç½®ï¼Œå› ä¸ºåªæœ‰ä¸€ä¸ªå‚æ•°ï¼šä¼˜åŒ–çº§åˆ«ã€‚

ç›®å‰ğŸ¤— Accelerateé›†æˆæ”¯æŒä¸¤ä¸ªä¼˜åŒ–çº§åˆ«ï¼Œ`"O1"`å’Œ`"O2"`ï¼ˆä½¿ç”¨å­—æ¯â€˜oâ€™ï¼Œè€Œä¸æ˜¯é›¶ï¼‰ã€‚

+   `"O1"`å°†å°†æƒé‡æ¢¯åº¦å’Œ`all_reduce`é€šä¿¡è½¬æ¢ä¸º8ä½ï¼Œè€Œå…¶ä½™éƒ¨åˆ†å°†ä»¥16ä½å®Œæˆã€‚è¿™å‡å°‘äº†ä¸€èˆ¬GPUå†…å­˜ä½¿ç”¨é‡å¹¶åŠ å¿«äº†é€šä¿¡å¸¦å®½ã€‚

+   `"O2"`è¿˜å°†ä¸€é˜¶ä¼˜åŒ–å™¨çŠ¶æ€è½¬æ¢ä¸º8ä½ï¼Œè€ŒäºŒé˜¶çŠ¶æ€ä¸ºFP16ï¼ˆç›®å‰ä»…æ”¯æŒ`Adam`ä¼˜åŒ–å™¨ï¼‰ã€‚è¿™å°½æœ€å¤§åŠªåŠ›æœ€å°åŒ–æœ€ç»ˆå‡†ç¡®æ€§çš„é™çº§ï¼Œå¹¶å°†èŠ‚çœæœ€é«˜æ½œåœ¨å†…å­˜ã€‚

è¦æŒ‡å®šä¼˜åŒ–çº§åˆ«ï¼Œè¯·å°†å…¶ä¼ é€’ç»™`FP8KwargsHandler`ï¼Œè®¾ç½®`optimization_level`å‚æ•°ï¼š

```py
from accelerate import Accelerator
from accelerate.utils import FP8RecipeKwargs
kwargs = [FP8RecipeKwargs(backend="msamp", optimization_level="O2")]
accelerator = Accelerator(mixed_precision="fp8", kwarg_handlers=kwargs)
```

## é…ç½®TransformersEngine

TransformersEngineæœ‰æ›´å¤šå¯ç”¨äºè‡ªå®šä¹‰å¦‚ä½•ä»¥åŠä½•æ—¶æ‰§è¡ŒFP8è®¡ç®—çš„å†…å®¹ã€‚æ”¯æŒçš„å‚æ•°åˆ—è¡¨å’Œå®ƒä»¬çš„å«ä¹‰åœ¨[NVIDIAæ–‡æ¡£](https://docs.nvidia.com/deeplearning/transformer-engine/user-guide/api/common.html)ä¸­éƒ½æœ‰ï¼Œä½†æ˜¯å®ƒä»¬ä¹Ÿä½œä¸º`FP8KwargsHandler`çš„docstringçš„ä¸€éƒ¨åˆ†é‡ç”³ï¼Œä»¥æ–¹ä¾¿æ‚¨æŸ¥çœ‹ã€‚

ğŸ¤— Accelerateå°è¯•è®¾ç½®åˆç†çš„é»˜è®¤å€¼ï¼Œä½†æ˜¯è‡ªå·±æ¢ç´¢å’Œè°ƒæ•´å„ç§å‚æ•°å¯èƒ½ä¼šå¯¼è‡´æ›´å¥½çš„æ€§èƒ½ã€‚

è¦ä½¿ç”¨å®ƒï¼Œè¯·æŒ‡å®š`backend="te"`å¹¶ä¿®æ”¹æ‚¨æƒ³è¦ä½œä¸ºkwargå¤„ç†ç¨‹åºçš„ä»»ä½•å‚æ•°ï¼š

```py
from accelerate import Accelerator
from accelerate.utils import FP8RecipeKwargs
kwargs = [FP8RecipeKwargs(backend="te", ...)]
accelerator = Accelerator(mixed_precision="fp8", kwarg_handlers=kwargs)
```

## è¿›ä¸€æ­¥é˜…è¯»

è¦äº†è§£æ›´å¤šå…³äºåœ¨FP8ä¸­è®­ç»ƒçš„ä¿¡æ¯ï¼Œè¯·æŸ¥çœ‹ä»¥ä¸‹èµ„æºï¼š

+   [æˆ‘ä»¬çš„æ¦‚å¿µæŒ‡å—](../concept_guides/low_precision_training.md)è¯¦ç»†ä»‹ç»äº†TransformersEngineå’ŒMS-AMPã€‚

+   [transformers-engineæ–‡æ¡£](https://docs.nvidia.com/deeplearning/transformer-engine/user-guide/api/common.html)

+   [MS-AMPæ–‡æ¡£](https://azure.github.io/MS-AMP/docs/)
